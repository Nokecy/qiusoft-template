# 技术图纸更改单（PDCO）“图纸文件升级” Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** 调整“技术图纸更改单（PartDocumentChangeOrder）”的表单/列表/审批后处理逻辑，满足“图纸文件升级”新需求（含按物料编码联动文档、附件自动识别、文件校验与审批通过后文件迁移）。

**Architecture:** 前端（`D:\Project\caimen\caimen-react`）负责交互联动与提示；后端（`D:\Project\zrxt\Burn.Abp.Pdm`）负责数据约束、查询接口与审批通过后的文件处理，保证即使绕过前端也能满足规则。

**Tech Stack:** React（Ant Design + Formily）、ABP/.NET（Application/AppService + Domain Event Handler）、BlobStoring/DocumentStorageService、xUnit + Shouldly。

---

## 需求确认结果（以此为准）

1. 更改单号：**保存后由后端生成并在响应中返回**；前端新建时只做只读占位展示（如“保存后自动生成”）。
2. 物料编码数据源：对 `PartDocumentLink.PartNumber` **去重**（你说的“驱虫=去重”），与前端文档列表一致。
3. 失效路径：**取文档列表中的存储库（DocumentLibrary.Path）**，由“文档编码（DocNo）”带出。
4. 文档版本：手工输入，**不做格式校验**。
5. 附件名称匹配：
   - 以**不含扩展名**进行匹配，**忽略大小写**；
   - 仅支持**最后一个下划线**后的版本号：如 `XXX_VC_VA.xlsx` → 版本号为 `VA`。
6. 审批通过后文件处理：
   - 文档管理本身有“历史版本”，审批通过后**无需人工搬运文件路径**。
   - 处理方式：发布新版本后，原“当前生效版本”自然成为“历史版本”，失效文件放入历史版本即可（即保留旧版本记录与其文件）。
   - `ExpirationPath` 字段仍按“文档列表的存储库（DocumentLibrary.Path）”带出用于展示/追溯，但不再作为“搬运目标路径”参与归档逻辑。

---

## 前端改动（`D:\Project\caimen\caimen-react`）

### Task 1: 列表页字段调整

**Modify:**
- `src/pages/appPdm/DocumentManagement/PartDocumentChangeOrder/index.tsx`

**TODO:**
- 移除列：`effectiveDate`、`assignDate`、`engineer`（同时移除对应搜索/显示配置）。
- 列文案调整：`partNo` 从“物料编号”改为“物料编码”；`auditEngineeringUserName`（若在列表里显示）文案改为“处理人”（见后端字段确认）。
- `orderType` 固定展示“图纸文件升级”（若后端已固定，可仅展示该值）。

**Verify:**
- 打开列表页，确认三列不再出现；导出/排序不受影响。

### Task 2: 详情页字段调整

**Modify:**
- `src/pages/appPdm/DocumentManagement/PartDocumentChangeOrder/detail.tsx`

**TODO:**
- 基本信息中移除：生效日期、分发日期、工程师。
- 字段文案：`partNo` → “物料编码”；“工程更改人” → “处理人”。
- 增加展示：外包属性（`outsideAttribute`）、失效路径（`expirationPath`）、编码不一致（`allowDifferent`）。

**Verify:**
- 详情页显示字段与需求一致；无空字段报错。

### Task 3: 表单 Schema 重构（字段/联动）

**Modify:**
- `src/pages/appPdm/DocumentManagement/PartDocumentChangeOrder/components/schema.ts`
- `src/pages/appPdm/DocumentManagement/PartDocumentChangeOrder/components/formModal.tsx`

**TODO:**
- `number`：只读展示（创建模式也不允许编辑），placeholder 显示“保存后自动生成”。
- 移除字段：`effectiveDate`、`assignDate`、`{value:engineerId,label:engineer}`。
- `orderType`：改为固定值“图纸文件升级”，UI 不给选择（可用 `Input` + `readPretty` 或隐藏字段并在 submit 时强制赋值）。
- `docVersion`：由 `Select(A-M)` 改为 `Input`（手工输入，不校验）。
- 新增字段：
  - `outsideAttribute`：下拉 `TK/CS`（是否必填待确认）。
  - `productLine`：下拉枚举：`无限能源/数据中心/服务器/传输/固网/部件/公共/鼎桥/其他`。
  - `expirationPath`：输入框只读（随 `docNo` 自动带出）。
  - `allowDifferent`：复选框，文案“编码不一致”（默认不勾选）。
- “物料编码/文档编码”联动：
  - `partNo` 改为新的选择组件（见 Task 4），数据源来自“文档列表中的物料编码（去重）”。
  - 选中 `partNo` 后：
    - 若仅 1 个文档：自动填充 `docNo`、`documentTypeId`、`expirationPath`。
    - 若多个文档：`docNo` 显示为下拉（数据源为该物料编码对应文档列表），选中后带出 `documentTypeId`、`expirationPath`。

**Verify:**
- 新建/编辑表单所有字段能正常渲染；联动无死循环；提交 payload 符合后端契约。

### Task 4: 新增“物料编码/文档编码”数据源服务（前端）

**Create/Modify:**
- `src/services/pdm/PartDocumentChangeOrder.ts`（补充新接口）
- `src/pages/appPdm/_formWidgets/`（新增组件，如 `MaterialCodeSelect.tsx`、`MaterialDocumentSelect.tsx`）

**TODO:**
- 新增接口封装：
  - `GET /api/pdm/part-document-change-order/material-codes`（去重后的物料编码列表，来自 `PartDocumentLink.PartNumber`）
  - `GET /api/pdm/part-document-change-order/documents-by-material-code?code=...`（按物料编码返回文档列表项：`docNo/docName/documentTypeId/documentTypeName/expirationPath`，其中 `expirationPath=DocumentLibrary.Path`）
  - `GET /api/pdm/part-document-change-order/match-document-by-attachment-name?fileName=...`（按附件名匹配文档：以不含扩展名、忽略大小写匹配）
- 组件支持远程搜索、分页（至少限制 50/100 条，避免一次性拉全量）。

**Verify:**
- 输入关键字能检索物料编码；选择后能拉到文档列表并完成联动。

### Task 5: 附件上传联动与冲突确认

**Modify:**
- `src/pages/appPdm/DocumentManagement/PartDocumentChangeOrder/components/formModal.tsx`
- `src/components/AttachmentUpload`（如需暴露文件名/回调）

**TODO:**
- 上传成功拿到 `fileName` 后：
  - 调用后端匹配接口（见后端 Task 8），匹配规则：**不含扩展名 + 忽略大小写**；匹配到文档则自动带出：`docNo`、`documentTypeId`、`expirationPath`、`docName` 等。
  - 若当前 `partNo` 已带出 `docNo`，且附件匹配到的 `docNo` 不一致：弹窗提示“是否确认替换”，确认后覆盖联动字段。
  - 若文件名末尾存在 `_版本号`：提取最后一个下划线后的片段写入 `docVersion`（例如 `XXX_VC_VA.xlsx` → `docVersion=VA`）。

**Verify:**
- 上传不同文件名组合：匹配/不匹配/冲突替换/版本提取都符合预期。

---

## 后端改动（`D:\Project\zrxt\Burn.Abp.Pdm`）

### Task 6: 固定“变更类型=图纸文件升级”（后端兜底）

**Modify:**
- `src/Burn.Abp.Pdm.Application/DocumentManagement/PartDocumentChangeOrders/PartDocumentChangeOrderAppService.cs`
- `src/Burn.Abp.Pdm.Domain/DocumentManagement/PartDocumentChangeOrders/PartDocumentChangeOrder.cs`（如需约束）

**TODO:**
- 在 Create/Update/GDPCreate 入口：忽略前端传入 `OrderType`，强制写入“图纸文件升级”。
- 若历史流程仍依赖旧值（新增/修改/作废/替代），需要评估：是否本需求仅针对“新入口/新菜单”，旧入口仍保留？

**Verify:**
- 手工构造请求传入其他 `OrderType`，落库仍为“图纸文件升级”。

### Task 7: 新增/调整字段约束（外包属性、产品线、处理人、编码不一致）

**Modify:**
- `src/Burn.Abp.Pdm.Application.Contracts/DocumentManagement/PartDocumentChangeOrders/CreatePartDocumentChangeOrderDto.cs`
- `src/Burn.Abp.Pdm.Application.Contracts/DocumentManagement/PartDocumentChangeOrders/UpdatePartDocumentChangeOrderDto.cs`
- `src/Burn.Abp.Pdm.Domain.Shared/Localization/Pdm/zh-Hans.json`（如需新增文案）

**TODO:**
- `OutsideAttribute`：后端校验只能为 `TK/CS`（避免脏数据）。
- `ProductLine`：后端校验必须在枚举集合内。
- “工程更改人”改“处理人”：确认对应字段是 `AuditEngineeringUser*` 还是 `Engineer/EngineId`，完成字段命名/文案统一（优先不改数据库字段名，仅改显示/DTO 名称时需评估兼容性）。
- `AllowDifferent`：默认 false；写明业务含义“编码不一致”。

**Verify:**
- 传入非法值返回可读的 `BusinessException` 错误码。

### Task 8: 增加查询接口：物料编码去重、按物料编码取文档列表、按附件名匹配文档

**Modify/Create:**
- `src/Burn.Abp.Pdm.Application.Contracts/DocumentManagement/PartDocumentChangeOrders/IPartDocumentChangeOrderAppService.cs`
- `src/Burn.Abp.Pdm.Application.Contracts/DocumentManagement/PartDocumentChangeOrders/*.cs`（新增 Lookup DTO）
- `src/Burn.Abp.Pdm.Application/DocumentManagement/PartDocumentChangeOrders/PartDocumentChangeOrderAppService.cs`

**TODO:**
- 新增 DTO：
  - `PartDocumentChangeOrderMaterialCodeLookupDto`（`MaterialCode`、可选 `Count`）
  - `PartDocumentChangeOrderDocumentLookupDto`（`DocNo`、`DocName`、`DocumentTypeId`、`DocumentTypeName`、`ExpirationPath` 等）
- 新增 AppService 方法：
  - `GetMaterialCodesAsync(string keyword, int maxResultCount)`
  - `GetDocumentsByMaterialCodeAsync(string materialCode)`
  - `MatchDocumentByAttachmentNameAsync(string fileName)`（按“不含扩展名 + 忽略大小写”匹配，返回 0/1/N 个候选，前端决定如何处理）
- 查询实现建议：基于“文档列表”表/视图（或 `PartDocumentLink`/`Document` 关系）做 server-side 过滤与去重，避免前端全量拉取。

**Verify:**
- 单元测试覆盖：关键字过滤、去重、同物料多文档返回、按文件名匹配（大小写/扩展名处理按确认项）。

### Task 9: “编码不一致”校验接入 `Document.ValidatePrimaryFileName`

**Modify:**
- `src/Burn.Abp.Pdm.Application/DocumentManagement/PartDocumentChangeOrders/PartDocumentChangeOrderAppService.cs`
- `src/Burn.Abp.Pdm.Domain/DocumentManagement/Documents/Document.cs`（如需适配）

**TODO:**
- 在创建/更新时（至少在保存主附件时）：
  - 若 `AllowDifferent == false`：拿到“上传文件名”（优先从 `BlobName` 解析原始文件名）与 `PartNo`、`DocumentTypeName`，调用 `Document.ValidatePrimaryFileName(fileName, partNo, documentTypeName)`。
  - 若 `AllowDifferent == true`：跳过校验。
- 解决调用点的对象问题（`ValidatePrimaryFileName` 依赖 `AllowCodeInconsistency`）：
  - 方案 A：将校验逻辑抽到独立 DomainService（推荐），由 PDCO 传入 `allowDifferent`。
  - 方案 B：为 `ValidatePrimaryFileName` 增加可选参数 `forceValidate`（谨慎，涉及领域模型变更）。

**Verify:**
- `AllowDifferent=false` 且文件名不包含物料编码/文档类型时返回明确错误码；勾选后可通过。

### Task 10: 审批通过后文件迁移（失效路径/源文件路径）

**Modify:**
- `src/Burn.Abp.Pdm.Domain/DocumentManagement/PartDocumentChangeOrders/Events/PartDocumentChangeOrderApprovedEventHandler.cs`
- 可能涉及：`src/Burn.Abp.Pdm.Domain/DocumentManagement/StorageSolutions/*`（若需要支持“移动文件”能力）

**TODO:**
- 在审批通过事件里，按“版本升级”语义处理（不做文件路径搬运）：
  - 找到目标文档（由单据 `DocNo` 定位）。
  - 基于单据上传的新文件创建一个新的 `DocumentRevision` 并发布（`Release`），版本号取单据 `DocVersion`（已明确“手工输入不校验”）。
  - **不删除**原“当前生效版本”的任何文件与记录；发布后它自动成为“历史版本”，从而满足“将失效文件放到历史版本中”的需求。
  - 若系统存在“清理草稿/工作区文件”的逻辑，仅清理“当前修订草稿工作区文件”，不得触碰已发布版本文件。

**Verify:**
- 集成测试：模拟一个已有已发布文档 + PDCO 通过审批后：
  - 文档出现新的已发布版本（版本号=单据 `DocVersion`）；
  - 原版本仍能在“历史版本”中查看/下载；
  - 当前版本指向新版本。

---

## 建议的验证命令（后端）

- 还原与构建：`dotnet restore`、`dotnet build`
- 相关测试优先跑：
  - `dotnet test test/Burn.Abp.Pdm.Domain.Tests`
  - `dotnet test test/Burn.Abp.Pdm.Application.Tests`
