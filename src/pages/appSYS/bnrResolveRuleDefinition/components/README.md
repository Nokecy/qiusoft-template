# BNR解析规则定义 - 增强版正则表达式编辑器

## 功能概述

本模块为 BNRResolveRuleDefinition 表单集成了功能完善的正则表达式编辑器,提供以下高级功能:

## 核心功能

### 1. 编辑器标签页

#### 实时语法验证
- ✅ 基于 regexp-tree AST 的语法验证
- ✅ 实时错误检测和标注
- ✅ 波浪线错误提示
- ✅ 错误位置高亮显示

#### 复杂度分析
- **性能评分** (0-100分)
  - 绿色(80+): 性能优秀
  - 黄色(60-79): 性能一般
  - 红色(<60): 性能较差

- **回溯风险评估**
  - 低: 安全的正则表达式
  - 中: 需要注意性能
  - 高: 存在灾难性回溯风险

- **详细指标**
  - 节点数量
  - 嵌套深度
  - 分支数量
  - 量词数量
  - 捕获组数量

- **优化建议**
  - 自动分析表达式问题
  - 提供具体优化方案
  - 性能改进建议

### 2. 测试器标签页

#### 匹配测试
- 实时匹配结果显示
- 匹配位置高亮
- 捕获组详细信息
- 匹配数量统计
- 最大匹配数限制保护(默认1000)

#### 标志选择器
- global (g) - 全局匹配
- ignoreCase (i) - 忽略大小写
- multiline (m) - 多行模式
- dotAll (s) - 点匹配所有字符
- unicode (u) - Unicode模式
- sticky (y) - 粘性模式

#### 替换预览
- 支持 $1, $2 等捕获组引用
- 实时替换结果预览
- 替换语法验证

### 3. 可视化标签页

#### Railroad Diagram
- 图形化展示正则表达式结构
- SVG 格式高清渲染
- 帮助理解复杂表达式
- 自适应容器大小

## 文件结构

```
components/
├── EnhancedRegexEditor.tsx      # 增强版编辑器主组件
├── FormilyRegexEditor.tsx       # Formily 表单包装器
├── formDialog.tsx               # 表单对话框(已注册组件)
├── schema.ts                    # 表单Schema配置
└── README.md                    # 本说明文档
```

## 技术实现

### 依赖包
- `@nokecy/qc-ui` v1.0.67
  - RegexEditor - 核心编辑器组件
  - RegexTester - 正则测试器
  - RegexRailroadDiagram - 可视化组件
  - useRegexValidation - 验证Hook

### 架构设计

```
┌─────────────────────────────────────┐
│      EnhancedRegexEditor            │
│  (增强版编辑器 - 多标签页)           │
├─────────────────────────────────────┤
│  ┌─────────────────────────────┐   │
│  │  编辑器标签页                │   │
│  │  - RegexEditor              │   │
│  │  - 验证错误显示              │   │
│  │  - 复杂度分析                │   │
│  └─────────────────────────────┘   │
│                                     │
│  ┌─────────────────────────────┐   │
│  │  测试器标签页                │   │
│  │  - RegexTester              │   │
│  │  - 匹配结果                  │   │
│  │  - 替换预览                  │   │
│  └─────────────────────────────┘   │
│                                     │
│  ┌─────────────────────────────┐   │
│  │  可视化标签页                │   │
│  │  - RegexRailroadDiagram     │   │
│  └─────────────────────────────┘   │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│     FormilyRegexEditor              │
│  (Formily 表单适配器)                │
│  - connect() 包装                   │
│  - mapProps() 属性映射               │
│  - 自动处理 value/onChange           │
└─────────────────────────────────────┘
```

## 使用示例

### Schema 配置
```typescript
{
  expression: {
    type: 'string',
    title: '表达式',
    'x-component': 'FormilyRegexEditor',
    'x-component-props': {
      placeholder: '请输入正则表达式',
      height: '120px',
      showComplexity: true,        // 显示复杂度分析
      showTester: true,            // 显示测试器
      showVisualization: true,     // 显示可视化
      defaultActiveTab: 'editor'   // 默认激活的标签页
    },
    required: true
  }
}
```

### 标签页选项
- `'editor'` - 编辑器(默认)
- `'tester'` - 测试器
- `'visualization'` - 可视化

## 性能优化

### 防抖机制
- 验证操作自动防抖 300ms
- 减少不必要的计算开销
- 提升用户体验

### 错误处理
- 解析错误捕获
- 超时保护(默认5秒)
- 优雅降级显示

## 测试验证

### 访问地址
- 本地开发: http://localhost:8001
- 页面路径: `/appSYS/bnrResolveRuleDefinition`

### 测试步骤
1. 打开表单对话框
2. 在表达式字段输入正则表达式
3. 切换不同标签页查看功能
4. 在测试器中验证匹配结果
5. 查看可视化图表理解结构

### 测试用例示例

#### 简单数字匹配
```
表达式: ^\d{3}-\d{4}$
测试文本: 123-4567
预期: 匹配成功
```

#### 邮箱验证
```
表达式: ^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$
测试文本: user@example.com
预期: 匹配成功
```

#### 捕获组测试
```
表达式: ^(\d{3})-(\d{4})$
测试文本: 123-4567
替换为: $1 / $2
预期结果: 123 / 4567
```

## 常见问题

### Q: 如何查看正则表达式的性能评分?
A: 在"编辑器"标签页输入表达式后,复杂度分析面板会自动显示性能评分和回溯风险。

### Q: 如何测试正则表达式是否正确?
A: 切换到"测试器"标签页,输入测试文本即可看到实时匹配结果。

### Q: Railroad Diagram 有什么用?
A: 在"可视化"标签页可以看到正则表达式的图形化结构,帮助理解复杂的表达式。

### Q: 支持哪些正则表达式标志?
A: 支持 g(全局), i(忽略大小写), m(多行), s(dotAll), u(Unicode), y(sticky)。

### Q: 如何获得优化建议?
A: 当表达式存在性能问题时,复杂度分析面板会自动显示具体的优化建议。

## 更新日志

### v1.0.0 (2025-10-27)
- ✅ 初始版本发布
- ✅ 集成 @nokecy/qc-ui RegexEditor
- ✅ 实现三大核心功能标签页
- ✅ 完整的 Formily 表单集成
- ✅ 支持所有高级功能

## 后续计划

- [ ] 添加正则表达式模板库
- [ ] 支持历史记录保存
- [ ] 添加常用表达式收藏功能
- [ ] 支持表达式分享
- [ ] 添加更多验证规则

## 技术支持

如有问题或建议,请联系开发团队。
