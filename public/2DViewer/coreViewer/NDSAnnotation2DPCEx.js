((t,e)=>{"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.NDSAnnotation2DPCEx=e():t.NDSAnnotation2DPCEx=e()})(window,function(){return n=[function(t,e,n){n.r(e),n.d(e,"NDSAnnotation2DPCExtension",function(){return I});var d=NDSWebViewer.SETTING,h=NDSWebViewer.COMMON,i=NDSWebViewer.NDS,o=NDSWebViewer.SnappingTool,u=NDSWebViewer.SNAP_VERTEX,s=NDSWebViewer.LineMaterial,l=NDSWebViewer.LineMaterialOrigin;let M=NDSWebViewer.LineSegments2,P=NDSWebViewer.LineSegmentsGeometry;i.ANNOTATIONTYPE={NONE:0,ANNOTATIONPT:1,ANNOTATIONSAVE:2,ANNOTATIONLINE:3,ANNOTATIONCIRCLE:4,ANNOCIRCLE:5,ANNORECTANGLE:6,ANNOSTLINE:7,ANNOARROWS:8,ANNOTATIONTAGLINE:9,ANNOTATIONNOTICEBEGIN:45,INFOTYPE:46};class a{constructor(t){this.viewer=t.viewer,this.OpAnnotation=t,this.annotationType="",this.annotationClass="Base",this.snappingTool=new o(this.viewer),this.snappedPoint=null,this.preSelObj=null,this.preSelInfo=null,this.preSelColor=65535,this.preSelCircle=[],this.preSelCircleObj=[],this.selectObjectList=[],this.maxSelectCount=0,this.selDivRef=null,this.POINTSIZE=3,this.LINEWIDTH=2,this.POINTLINEWIDTH=12,this.ARROWWIDTH=36,this.areaMaterial=new THREE.MeshBasicMaterial({color:(new THREE.Color).setHex(62194,THREE.SRGBColorSpace),depthTest:!1,depthWrite:!1,transparent:!0,opacity:.4,side:THREE.DoubleSide})}resetLineData(){return!1}OperatorStart(t){this.annotationType=t,this.snappedPoint=null,this.OpAnnotation.PostInfo()}OperatorEnd(){this.annotationType="",this.snappedPoint=null,this.delPreSelectObj(),this.delAllSelectObjectList(),this.OpAnnotation.unsteadyUUid&&this.OpAnnotation.annotationDataSelected&&this.OpAnnotation.deSelAnnotationResult(this.OpAnnotation.unsteadyUUid),this.OpAnnotation.unsteadyUUid&&this.OpAnnotation.annotationNeedAddList&&this.OpAnnotation.delAnnotationData(this.OpAnnotation.unsteadyUUid),this.OpAnnotation.PostInfo()}OperatorRelease(){this.OperatorEnd()}delPreSelectObj(){this.preSelCircle=[],this.snappedPoint=null,this.preSelObj=null,this.preSelInfo=null}addPreCircleSelectObj(){for(let t=0;t<this.preSelCircleObj.length;t++)this.preSelCircleObj[t]&&this.OpAnnotation.rootObject.add(this.preSelCircleObj[t]);this.OpAnnotation.render()}addSelectObjectList(t){var e=this.createObjectFromSelInfo(t,!1);e&&(this.selectObjectList.push({selInfo:t,selObj:e}),e)&&"point"!=t.type&&(this.OpAnnotation.rootObject.add(e),this.OpAnnotation.render())}delSelectObjectList(t){var e,n;this.selectObjectList[t]&&(e=this.selectObjectList[t].selObj,n=this.selectObjectList[t].selInfo,e&&"point"!=n.type&&(this.OpAnnotation.rootObject.remove(e),this.OpAnnotation.render()),this.selectObjectList.splice(t,1))}delAllSelectObjectList(){for(let t=0;t<this.selectObjectList.length;t++){var e,n;this.selectObjectList[t]&&(e=this.selectObjectList[t].selObj,n=this.selectObjectList[t].selInfo,e)&&"point"!=n.type&&this.OpAnnotation.rootObject.remove(e)}this.selectObjectList=[],this.OpAnnotation.render()}getPointMaterial(t){let e=t;t=16777215,0==parseInt(this.viewer.clearColor)?0!=e&&e!=t&&0!=e&&16777215!=e||(e=t):0!=e&&e!=t&&0!=e&&16777215!=e||(e=0),t=new THREE.PointsMaterial({color:(new THREE.Color).setHex(e,THREE.SRGBColorSpace),side:THREE.DoubleSide});return t}getColorFromMap(t,e,n,i){let o=t;t=16777215;0==parseInt(this.viewer.clearColor)?0!=o&&o!=t&&0!=o&&16777215!=o||(o=t):0!=o&&o!=t&&0!=o&&16777215!=o||(o=0);let a="_",r=(e&&(a+=e),n&&(o=16711680,2==n)&&(a+=i),a=o+a,null);return this.OpAnnotation.materialMap.has(a)?r=this.OpAnnotation.materialMap.get(a):((r=n&&2==n?new l({linewidth:e||1,color:(new THREE.Color).setHex(o,THREE.SRGBColorSpace),dashed:!0,dashSize:i?i/2:6,gapSize:i?i/2:6,worldUnits:!1}):e?new s({linewidth:e,color:(new THREE.Color).setHex(o,THREE.SRGBColorSpace)}):new THREE.MeshBasicMaterial({color:(new THREE.Color).setHex(o,THREE.SRGBColorSpace)})).depthTest=!1,r.depthWrite=!1,r.side=THREE.DoubleSide,this.OpAnnotation.materialMap.set(a,r)),r}getPostInfo(){return i.ANNOTATIONTYPE.NONE}getCurAllowType(){return["point"]}addSelectObjectToList(t){return!1}createAnnotationResult(t){return t?(this.OpAnnotation.unsteadyUUid=t.uuid,this.OpAnnotation.annotationDataList.push(t),this.viewer.dispatchEvent({type:"AddAnnotation",data:{uuid:t.uuid}}),"newLine"!=t.type&&"newCircle"!=t.type&&"newRectangle"!=t.type&&"cloudLine"!=t.type&&"newLine2Pt"!=t.type&&"newArrow2Pt"!=t.type&&"tagLine"!=t.type&&this.delAllSelectObjectList()):console.log("CreateAnnotationResult failed"),this.OpAnnotation.render(),!0}isClockwise(t,e){return e.clone().negate().cross(new THREE.Vector3(0,0,1)).angleTo(t.clone())>Math.PI/2}isOverPI(t,e){return e.clone().negate().cross(new THREE.Vector3(0,0,1)).angleTo(t.clone())>Math.PI/2}getTranslation(t,e){var n=(new THREE.Vector3).subVectors(t.clone(),e.clone()),t=t.clone().distanceTo(e.clone());return(new THREE.Matrix4).makeTranslation((new THREE.Vector3).addScaledVector(n.normalize(),t))}getRotation(t,e,n,i){n=(new THREE.Quaternion).setFromUnitVectors((new THREE.Vector3).subVectors(n.clone(),t.clone()).normalize(),(new THREE.Vector3).subVectors(e.clone(),t.clone()).normalize()),e=(new THREE.Matrix4).makeRotationFromQuaternion(n),t=(new THREE.Matrix4).makeTranslation(i.clone());return t.clone().invert().multiply(e.clone().multiply(t.clone()))}getScale(t,e,n,i){e=(new THREE.Vector3).subVectors(e.clone(),t.clone()),n=(new THREE.Vector3).subVectors(n.clone(),t.clone()),t=e.projectOnVector(n.clone().normalize()).length(),e=n.length(),n=(t+e)/(2*e),t=(new THREE.Matrix4).makeScale(n,n,1),e=(new THREE.Matrix4).makeTranslation(i.clone());return e.clone().invert().multiply(t.clone().multiply(e.clone()))}getRotationDashLine(t,e,n,i,o,a=!1){let r=100*Math.ceil((2*Math.PI-n)/(2*Math.PI)),s=(2*Math.PI-n)/r;a&&(r=100*Math.ceil(n/(2*Math.PI)),s=n/r);var l=t.distanceTo(e),t=new THREE.BufferGeometry,c=[];for(let t=0;t<r;++t){var p=a?s*t+2*Math.PI-n:s*t,h=l*Math.cos(p+o),p=l*Math.sin(p+o);c.push(h),c.push(p),c.push(0)}e=new Float32Array(c),t.setAttribute("position",new THREE.BufferAttribute(e,3)),e=this.getLinePrecision(6),e=new THREE.LineDashedMaterial({color:(new THREE.Color).setHex(10066329,THREE.SRGBColorSpace),linewidth:4,scale:1,dashSize:e,gapSize:e}),t=new THREE.Line(t,e);return t.computeLineDistances(),t.objectType="rotation_dashline",t}updateHelper(t,e,n){if(e.rotation.update){var i=t.leaderGroup.children[0];if(!i.midPoint)return!1;i=this.getRotationDashLine(i.midPoint.clone(),i.rotatePt.clone(),e.rotation.angle,t.style,n,e.rotation.clockwise);i.applyMatrix4((new THREE.Matrix4).makeTranslation(t.initTranslationORLU.clone().addScaledVector(t.initTranslationLU.clone(),-1))),i.applyMatrix4(t.instanceMatrix.clone()),i.applyMatrix4(t.worldMatrix.clone()),i.updateMatrixWorld(),t.leaderGroup.add(i)}}cleanRotationHelper(){var t;this.OpAnnotation.unsteadyUUid&&(t=this.OpAnnotation.getAnnotationResult(this.OpAnnotation.unsteadyUUid),this.updateAnnotationResultImpl(t,!0),this.OpAnnotation.render(!0))}updateAnnotationResult(i,r,t,e){if(this.OpAnnotation.unsteadyUUid){var s=this.OpAnnotation.getAnnotationResult(this.OpAnnotation.unsteadyUUid);let a=new THREE.Vector3;if(this.snappedPoint?a.copy(this.snappedPoint):(i=this.viewer.clientCoordToModelCoord([i,r]),a.set(i[0],i[1],0)),s){a.applyMatrix4(s.worldMatrixInvert);r=this.OpAnnotation.unsteadyRef;let o;"newArrow2Pt"==s.type||"newLine2Pt"==s.type?1==r||2==r?o=s.pointList[r-1].point.clone().applyMatrix4(s.instanceMatrix.clone()):5==r&&(o=s.pointList[2].point.clone().applyMatrix4(s.instanceMatrix.clone())):0<r&&(o=(99==r?s.pointList[6]:s.pointList[r-1]).point.clone().applyMatrix4(s.instanceMatrix.clone()));let n=0;i={rotation:{update:!1,clockwise:!0,angle:0}};if(1<=r&&r<=4&&"newArrow2Pt"!=s.type&&"newLine2Pt"!=s.type){var l=s.pointList[4].point.clone().applyMatrix4(s.instanceMatrix.clone()),c=new THREE.Vector3;c.add(s.initTranslationORLU.negate());let t=new THREE.Vector3,e=!0,n,i;switch(r){case 1:if(t=s.pointList[2].point.clone().applyMatrix4(s.instanceMatrix.clone()),i=(new THREE.Vector3).subVectors(l.clone(),t.clone()),n=(new THREE.Vector3).subVectors(a.clone(),t.clone()).projectOnVector(i.clone()),!(e=0<n.dot(i)))return;c.addScaledVector(s.initTranslationLU.clone(),2);break;case 2:if(t=s.pointList[3].point.clone().applyMatrix4(s.instanceMatrix.clone()),i=(new THREE.Vector3).subVectors(l.clone(),t.clone()),n=(new THREE.Vector3).subVectors(a.clone(),t.clone()).projectOnVector(i.clone()),!(e=0<n.dot(i)))return;c.add((new THREE.Vector3).subVectors(s.initTranslationLU.clone(),s.initTranslationLD.clone()));break;case 3:if(t=s.pointList[0].point.clone().applyMatrix4(s.instanceMatrix.clone()),i=(new THREE.Vector3).subVectors(l.clone(),t.clone()),n=(new THREE.Vector3).subVectors(a.clone(),t.clone()).projectOnVector(i.clone()),e=0<n.dot(i))break;return;case 4:if(t=s.pointList[1].point.clone().applyMatrix4(s.instanceMatrix.clone()),i=(new THREE.Vector3).subVectors(l.clone(),t.clone()),n=(new THREE.Vector3).subVectors(a.clone(),t.clone()).projectOnVector(i.clone()),!(e=0<n.dot(i)))return;c.add((new THREE.Vector3).subVectors(s.initTranslationLU.clone(),(new THREE.Vector3).addScaledVector(s.initTranslationLD.clone(),-1)))}var p=this.getScale(l,a,o,c.clone());s.updateInstanceMatrix(p,3)}if(1<=r&&r<=4&&("newArrow2Pt"==s.type||"newLine2Pt"==s.type)&&(p=(new THREE.Vector3).subVectors(a.clone(),o.clone()),h=a.clone().distanceTo(o.clone()),s.lineList[0].data[r-1].addScaledVector(p.clone().normalize(),h)),5==r&&((p=this.CircleCenterCapture(s,a.clone())).isHasCapPt&&(a=new THREE.Vector3(p.HasCapPoint.x,p.HasCapPoint.y,0).clone()),h=this.getTranslation(a.clone(),o.clone()),s.updateInstanceMatrix(h,1)),6==r){var p=s.pointList[4].point.clone().applyMatrix4(s.instanceMatrix.clone()),h=this.viewer.clientCoordToModelCoord(this.OpAnnotation.eventFirstPoint);if(!h)return void console.log("start point is null");var h=new THREE.Vector3(h[0],h[1],0),d=(h.applyMatrix4(s.worldMatrixInvert),this.OpAnnotation.updateCurXYDir(),this.vAndHCapture(s,a.clone(),p.clone())),d=(d.isInCap&&(a=new THREE.Vector3(d.curPoint.x,d.curPoint.y,0).clone()),(new THREE.Vector3).subVectors(a.clone(),p.clone())),h=(new THREE.Vector3).subVectors(h.clone(),p.clone()),u=(new THREE.Vector3).subVectors(o.clone(),p.clone());this.OpAnnotation.clockwise.inited||(this.OpAnnotation.clockwise.inited=!0,this.OpAnnotation.clockwise.clockwise=this.isClockwise(d,u));let t=s.x_dir.clone();u=(t="newCircle"!=s.type&&"newRectangle"!=s.type?t:new THREE.Vector3(1,0,0)).clone().cross(s.x_dir.clone());n=t.angleTo(s.x_dir.clone()),u.z<0&&(n=2*Math.PI-n);let e=d.clone().normalize().angleTo(h.clone().normalize());this.isOverPI(d,h)&&(e=2*Math.PI-e);u=(new THREE.Vector3).addVectors(s.initTranslationLU.clone(),s.initTranslationORLU.clone().negate()),d=this.getRotation(p,a,o,u.clone());s.updateInstanceMatrix(d,2),i.rotation.update=!0,i.rotation.clockwise=this.OpAnnotation.clockwise.clockwise,i.rotation.angle=e}8!=r&&9!=r&&10!=r&&11!=r||this.updateEdgeMidpoint(s,r,a.clone()),99==r&&this.updateTagLinePoint(s,r,a.clone()),this.updateAnnotationResultImpl(s,r<s.pointList.length||99==r,8==r||9==r||10==r||11==r),this.updateHelper(s,i,n),this.OpAnnotation.render(!0)}}}CircleCenterCapture(a,r){a.clearCaptureGroup();let e=[],s=("newCircle"==a.type&&a.isCaptureFlag&&this.OpAnnotation.annotationDataList.forEach(t=>{t.uuid!=a.uuid&&"newCircle"==t.type&&t.isCaptureFlag&&e.push(t)}),!1),t,n,l=(n=(h.isMobileDevice(),t=216),this.getLinePrecision(12)),c=new THREE.Vector3;var i=document.createElement("canvas"),o=(i.width=n,i.height=n,i.getContext("2d")),o=(o.strokeStyle="rgb(122, 223, 248, 0.6)",o.lineWidth=n/8,o.beginPath(),o.arc(n/2+n/t,n/2+n/t,n/4,0,2*Math.PI),o.closePath(),o.stroke(),o.beginPath(),o.arc(n/2+n/t,n/2+n/t,n/12,0,2*Math.PI),o.fillStyle="rgb(122, 223, 248, 0.6)",o.fill(),new THREE.CanvasTexture(i));let p=new THREE.PointsMaterial({map:o,color:(new THREE.Color).setHex(10066329,THREE.SRGBColorSpace),size:n/8,transparent:!0,alphaTest:.5});if(0<e.length){let o=[];e.forEach(t=>{var e=t.lineList[0].data[0].clone().applyMatrix4(t.instanceMatrix.clone()),n=t.lineList[0].data[1].clone().applyMatrix4(t.instanceMatrix.clone()),i=e.clone().distanceTo(n.clone())/2/Math.sqrt(2),e=new THREE.Vector3((e.x+n.x)/2,(e.y+n.y)/2,(e.z+n.z)/2),n=e.clone().distanceTo(r.clone()),t=t.worldMatrix.clone();n<i&&(i=this.createSelectPointGeom(e.clone(),t,p),a.captureGroup.add(i),o.push(e.clone().applyMatrix4(t.clone())),l>n)&&(l=n,s=!0,c=e.clone())})}return{isHasCapPt:s,HasCapPoint:c}}createSelectPointGeom(t,e,n){var i=[],t=(i.push(t.x,t.y,t.z),new Float32Array(i)),i=new THREE.BufferGeometry,t=(i.setAttribute("position",new THREE.BufferAttribute(t,3)),new THREE.Points(i,n));return t.applyMatrix4(e.clone()),t.updateMatrixWorld(),t}updateTagLinePoint(t,e,n){t.pointList[6].point=n.clone(),t.lineList[0].data[0]=n.clone()}updateEdgeMidpoint(t,e,n){n=n.clone().applyMatrix4(t.instanceMatrix.clone().invert());var i=this.getLinePrecision(5),o=t.pointList[e-1].point.clone();let a=new THREE.Vector3,r=new THREE.Vector3,s=new THREE.Vector3,l=new THREE.Vector3,c=0;if(8==e?(a=t.pointList[2].point.clone(),s=t.pointList[3].point.clone(),l=t.pointList[1].point.clone(),this.arePointsOnSameSide(t.pointList[2].point.clone(),t.pointList[3].point.clone(),n.clone(),o.clone())||(a=t.pointList[1].point.clone(),this.OpAnnotation.unsteadyRef=10,s=t.pointList[1].point.clone(),l=t.pointList[3].point.clone(),t.hideOtherDiv(this.OpAnnotation.unsteadyRef)),p=new THREE.Line3(t.pointList[2].point.clone(),t.pointList[3].point.clone()),h=new THREE.Vector3,p.closestPointToPoint(n,!1,h),c=n.distanceTo(h),new THREE.Line3(t.pointList[0].point.clone(),t.pointList[3].point.clone()).closestPointToPoint(n,!1,r)):9==e?(a=t.pointList[0].point.clone(),s=t.pointList[3].point.clone(),l=t.pointList[1].point.clone(),this.arePointsOnSameSide(t.pointList[0].point.clone(),t.pointList[3].point.clone(),n.clone(),o.clone())||(a=t.pointList[1].point.clone(),this.OpAnnotation.unsteadyRef=11,s=t.pointList[1].point.clone(),l=t.pointList[3].point.clone(),t.hideOtherDiv(this.OpAnnotation.unsteadyRef)),p=new THREE.Line3(t.pointList[0].point.clone(),t.pointList[3].point.clone()),h=new THREE.Vector3,p.closestPointToPoint(n,!1,h),c=n.distanceTo(h),new THREE.Line3(t.pointList[2].point.clone(),t.pointList[3].point.clone()).closestPointToPoint(n,!1,r)):10==e?(a=t.pointList[0].point.clone(),s=t.pointList[1].point.clone(),l=t.pointList[3].point.clone(),this.arePointsOnSameSide(t.pointList[0].point.clone(),t.pointList[1].point.clone(),n.clone(),o.clone())||(a=t.pointList[3].point.clone(),this.OpAnnotation.unsteadyRef=8,s=t.pointList[3].point.clone(),l=t.pointList[1].point.clone(),t.hideOtherDiv(this.OpAnnotation.unsteadyRef)),p=new THREE.Line3(t.pointList[0].point.clone(),t.pointList[1].point.clone()),h=new THREE.Vector3,p.closestPointToPoint(n,!1,h),c=n.distanceTo(h),new THREE.Line3(t.pointList[1].point.clone(),t.pointList[2].point.clone()).closestPointToPoint(n,!1,r)):11==e&&(a=t.pointList[2].point.clone(),s=t.pointList[1].point.clone(),l=t.pointList[3].point.clone(),this.arePointsOnSameSide(t.pointList[1].point.clone(),t.pointList[2].point.clone(),n.clone(),o.clone())||(a=t.pointList[3].point.clone(),this.OpAnnotation.unsteadyRef=9,s=t.pointList[3].point.clone(),l=t.pointList[1].point.clone(),t.hideOtherDiv(this.OpAnnotation.unsteadyRef)),p=new THREE.Line3(t.pointList[1].point.clone(),t.pointList[2].point.clone()),h=new THREE.Vector3,p.closestPointToPoint(n,!1,h),c=n.distanceTo(h),new THREE.Line3(t.pointList[0].point.clone(),t.pointList[1].point.clone()).closestPointToPoint(n,!1,r)),c<i)return!1;this.OpAnnotation.circleCaptureFlag=!1;var e=(new THREE.Matrix4).multiplyMatrices(t.worldMatrix.clone(),t.instanceMatrix.clone()),o=(a.applyMatrix4(e),r.applyMatrix4(e),s.applyMatrix4(e),l.applyMatrix4(e),new THREE.Vector3),p=new THREE.Quaternion,h=new THREE.Vector3,n=(t.instanceMatrix.decompose(o,p,h),h.set(1,1,1),t.instanceMatrix.compose(o,p,h),t.instanceMatrix.setPosition(a.clone().applyMatrix4(t.worldMatrixInvert.clone())),t.lineList=[],[]),i=this.getDiagonalPoint(a,s,l,r.clone());i.isCaptureFlag&&(this.OpAnnotation.circleCaptureFlag=!0,r=i.p4.clone()),n.push(a.clone().applyMatrix4(t.worldMatrixInvert).applyMatrix4(t.instanceMatrix.clone().invert())),n.push(r.clone().applyMatrix4(t.worldMatrixInvert).applyMatrix4(t.instanceMatrix.clone().invert())),t.lineList.push({data:n})}getDiagonalPoint(t,e,n,i){var o=(new THREE.Vector3).subVectors(e.clone(),t.clone()).normalize(),n=(new THREE.Vector3).subVectors(n.clone(),t.clone()).normalize(),e=t.clone().distanceTo(e.clone()),t=t.clone().add(o.clone().multiplyScalar(e)).add(n.clone().multiplyScalar(e)),o=this.getLinePrecision(5);return t.clone().distanceTo(i.clone())<o?{isCaptureFlag:!0,p4:t.clone()}:{isCaptureFlag:!1,p4:t.clone()}}arePointsOnSameSide(t,e,n,i){e=(new THREE.Vector3).subVectors(e,t),n=(new THREE.Vector3).subVectors(n,t),i=(new THREE.Vector3).subVectors(i,t),t=(new THREE.Vector3).crossVectors(e,n),n=(new THREE.Vector3).crossVectors(e,i);return 0<t.dot(n)}updateAnnotationResultImpl(t,e,n,i,o){switch(t.type){case"newText":this.updateAnnotationResultText(t,e,n,i,o);break;case"newLine":this.updateAnnotationResultLine(t,e,n,i);break;case"cloudLine":this.updateAnnotationResultCloudLine(t,e,n,i);break;case"newLine2Pt":case"newArrow2Pt":this.updateAnnotationResult2Pt(t,e,n,i);break;case"newCircle":this.updateAnnotationResultCircle(t,e,n,i);break;case"newRectangle":this.updateAnnotationResultRectangle(t,e,n,i);break;case"tagLine":this.updateAnnotationResultLeadLine(t,e,n,i)}}updateAnnotationLineData(t,e){console.log(t,"lineDatalineDatalineData");var n=e.x_dir.clone(),n=(new THREE.Quaternion).setFromUnitVectors(new THREE.Vector3(1,0,0),n);let i=(new THREE.Matrix4).makeRotationFromQuaternion(n);t.forEach(t=>{t.data.forEach(t=>{var e;t=t,e=i.clone().invert(),t.applyMatrix4(e)})}),e.instanceMatrix=(new THREE.Matrix4).multiplyMatrices(e.instanceMatrix.clone(),i.clone())}calculatingRotationPt(t,e){var n=this.getLinePrecision(6),t=(new THREE.Vector3).subVectors(e.clone(),t.clone());return e.clone().addScaledVector(t.normalize(),15*n)}updateAnnotationResultLeadLine(t,e,n,i,o){var a=t.worldMatrix,r=(t.clearLeaderGroup(),t.textDashLine&&t.textDashLine.visible),a=this.createLeadLineTextMesh(t.textString,t.style,a,t.X_DIRECTION,t.instanceMatrix,t.initTranslationLU,t.initTranslationLD,t.x_matrix4,t.textDistance,t.x_dir,t.y_dir,o),o=(t.pointList[0].point.copy(a.leftUpPt),t.pointList[1].point.copy(a.rightUpPt),t.pointList[2].point.copy(a.rightDwPt),t.pointList[3].point.copy(a.leftDwPt),t.pointList[4].point.copy(a.midPoint),t.pointList[5].point.copy(a.rightUpPt),this.OpAnnotation.get2dPoint(t.pointList[0].point.clone().applyMatrix4(t.instanceMatrix.clone()).applyMatrix4(t.worldMatrix.clone()))),s=this.OpAnnotation.get2dPoint(t.pointList[1].point.clone().applyMatrix4(t.instanceMatrix.clone()).applyMatrix4(t.worldMatrix.clone())),o=(o.x<s.x&&o.y<=s.y&&t.pointList[5].point.copy(a.rightUpPt),o.x<=s.x&&o.y>s.y&&t.pointList[5].point.copy(a.rightDwPt),o.x>=s.x&&o.y<s.y&&t.pointList[5].point.copy(t.pointList[0].point.clone()),o.x>s.x&&o.y>=s.y&&t.pointList[5].point.copy(a.leftDwPt),t.textDashLine=a.children[1],t.textDashLine.visible=r,t.leaderGroup.add(a),n&&(t.textDashLine.visible=!0),t.textDashLine.visible),s=(t.textFrameLine=a.children[2],t.textFrameLine.visible=!o,this.createLeadLineMesh(t,n));t.leaderGroup.add(s)}createLeadLineMesh(t,e){t.cloudLineWidth||(t.cloudLineWidth=this.getLinePrecision(40));var n=t.worldMatrix,i=t.lineType,o=t.connectType;let a=new THREE.Vector3,r=new THREE.Vector3;var s,l,c,p=t.lineList[0].data[0].clone(),h=new THREE.Vector3((t.pointList[0].point.clone().x+t.pointList[2].point.clone().x)/2,(t.pointList[0].point.clone().y+t.pointList[2].point.clone().y)/2,0).applyMatrix4(t.instanceMatrix.clone());return 1==o?(o=new THREE.Vector3((t.pointList[0].point.clone().x+t.pointList[3].point.clone().x)/2,(t.pointList[0].point.clone().y+t.pointList[3].point.clone().y)/2,0).applyMatrix4(t.instanceMatrix.clone()),c=new THREE.Vector3((t.pointList[1].point.clone().x+t.pointList[2].point.clone().x)/2,(t.pointList[1].point.clone().y+t.pointList[2].point.clone().y)/2,0).applyMatrix4(t.instanceMatrix.clone()),l=p.distanceTo(o),s=p.distanceTo(c),a=l<s?(l=(new THREE.Vector3).subVectors(o.clone(),h.clone()).normalize(),r=o.clone(),o.clone().addScaledVector(l.clone(),t.cloudLineWidth)):(s=(new THREE.Vector3).subVectors(c.clone(),h.clone()).normalize(),r=c.clone(),c.clone().addScaledVector(s.clone(),t.cloudLineWidth)),this.createLeadLine(p,a,r,i,this.getColorFromMap(t.style.color,t.style.lineWidth),n,1,t.cloudLineWidth,t.style,e)):(o=p.distanceTo(t.pointList[0].point.clone().applyMatrix4(t.instanceMatrix.clone())),l=p.distanceTo(t.pointList[1].point.clone().applyMatrix4(t.instanceMatrix.clone())),h=p.distanceTo(t.pointList[3].point.clone().applyMatrix4(t.instanceMatrix.clone())),c=p.distanceTo(t.pointList[2].point.clone().applyMatrix4(t.instanceMatrix.clone())),o<=l&&o<=h&&o<=c&&(a=t.pointList[0].point.clone().applyMatrix4(t.instanceMatrix.clone())),l<=o&&l<=h&&l<=c&&(a=t.pointList[1].point.clone().applyMatrix4(t.instanceMatrix.clone())),h<=l&&h<=o&&h<=c&&(a=t.pointList[3].point.clone().applyMatrix4(t.instanceMatrix.clone())),c<=l&&c<=o&&c<=h&&(a=t.pointList[2].point.clone().applyMatrix4(t.instanceMatrix.clone())),this.createLeadLine(p,a,r,i,this.getColorFromMap(t.style.color,t.style.lineWidth),n,2,t.cloudLineWidth,t.style,e))}createLeadLine(e,n,t,i,o,a,r,s,l,c){var p=new THREE.Group,h=[];let d=null;if(3==i){var u=this.getColorFromMap(l.color),E=e.distanceTo(n),T=(new THREE.Vector3).subVectors(n.clone(),e.clone()).normalize(),T=(d=this.createArrowMesh(e,E>l.arrowSize[0]?T:T.negate(),!1,u,l,null,c),(new THREE.Vector3).subVectors(n.clone(),e.clone()).normalize());let t=e.clone();E>l.arrowSize[0]&&(t=e.clone().addScaledVector(T.clone(),l.arrowSize[0]/2)),h.push(t.x),h.push(t.y)}else h.push(e.x),h.push(e.y);h.push(0),h.push(n.x),h.push(n.y),h.push(0),1==r&&(h.push(n.x),h.push(n.y),h.push(0),h.push(t.x),h.push(t.y),h.push(0));u=new Float32Array(h),c=new P,c.setPositions(u),E=new M(c,o);E.objectType="annoLine";let y=null;return 2==i&&(T=new THREE.CircleGeometry(s/10,32),r=this.getPointMaterial(l.color),(y=new THREE.Mesh(T,r)).position.set(e.x,e.y,0),y.objectType="anno_point"),p.add(E),y&&p.add(y),d&&p.add(d),p.objectType="Group",p.applyMatrix4(a.clone()),p.updateMatrixWorld(),p}createLeadLineTextMesh(t,e,n,i,o,a,r,s,l,c,p,h){n=(new THREE.Matrix4).multiplyMatrices(n.clone(),o.clone());let d=e.color;var o=16777215,o=(0==parseInt(this.viewer.clearColor)?0!=d&&d!=o&&0!=d&&16777215!=d||(d=o):0!=d&&d!=o&&0!=d&&16777215!=d||(d=0),e.color=d,2==e.fontSacleType),o=parseFloat(o?e.fontSize:this.getLinePrecision(this.OpAnnotation.defaultFontSize)),[u,E,T,y]=(e.curFontSize=o,this.OpAnnotation.MeaCharImpl.createGeomFormNewText(t,e.fontSize=o,e)),w=new THREE.Vector3(0,-o*y*1.1,0),x=new THREE.Vector3(0,o,0),y=new THREE.Vector3(u,-o*y*1.1,0),u=new THREE.Vector3(u,o,0);function A(t,e,n){t.translate(n);for(let t=0;t<e.length;t++)e[t].add(n)}var g=[w,x,y,u],R=c.clone().add(p.clone()),m=c.clone().sub(p.clone()),O=p.clone().sub(c.clone()),p=new THREE.Vector3(-p.x,-p.y,-p.z).sub(c);let L;L=l&&!h?l:this.getLinePrecision(6),A(E,g,new THREE.Vector3(0,-o,0)),A(E,g,new THREE.Vector3(0,0,0)),A(E,g,new THREE.Vector3(0,0,0).addScaledVector(m.normalize(),L));var f=g,v=s;E.applyMatrix4(v);for(let t=0;t<f.length;t++)f[t].applyMatrix4(v);c=new THREE.Mesh(E,T),c.objectType="text",c.name=t||"text",h=w.clone(),l=x.clone(),g=u.clone(),s=y.clone(),h.addScaledVector(p.normalize(),L),l.addScaledVector(O.normalize(),L),g.addScaledVector(R.normalize(),L),s.addScaledVector(m.normalize(),L),E=new THREE.BufferGeometry,T=new THREE.LineDashedMaterial({color:(new THREE.Color).setHex(e.color,THREE.SRGBColorSpace),linewidth:4,scale:1,dashSize:o/5,gapSize:o/5}),t=new Float32Array([h.x,h.y,h.z,l.x,l.y,l.z,g.x,g.y,g.z,s.x,s.y,s.z,h.x,h.y,h.z]),E.setAttribute("position",new THREE.BufferAttribute(t,3)),w=new THREE.Line(E,T),w.computeLineDistances(),w.objectType="text_dashline",x=[h.x,h.y,h.z,l.x,l.y,l.z,l.x,l.y,l.z,g.x,g.y,g.z,g.x,g.y,g.z,s.x,s.y,s.z,s.x,s.y,s.z,h.x,h.y,h.z],u=new P,u.setPositions(x),y=this.getColorFromMap(e.color,e.lineWidth),p=new M(u,y),p.objectType="annoLine",O=new THREE.Group,O.add(c),O.add(w),O.add(p),O.objectType="Group",O.midPoint=new THREE.Vector3((l.x+s.x)/2,(l.y+s.y)/2,(l.z+s.z)/2),R=new THREE.Vector3((g.x+s.x)/2,(g.y+s.y)/2,(g.z+s.z)/2),m=(new THREE.Vector3).subVectors(R.clone(),O.midPoint.clone()),o=R.clone().addScaledVector(m.normalize(),5*L);return O.rotatePt=o,O.leftUpPt=l,O.rightUpPt=g,O.leftDwPt=h,O.rightDwPt=s,O.textDistance=L,a.subVectors(O.leftUpPt.clone(),O.midPoint.clone()),r.subVectors(O.leftDwPt.clone(),O.midPoint.clone()),O.applyMatrix4(n),O.updateMatrixWorld(),O}updateAnnotationResultText(t,e,n,i,o){var a=t.worldMatrix,r=t.textDashLine&&t.textDashLine.visible,s=(t.clearLeaderGroup(),t.textString),s=this.createTextMesh2(s,t.style,a,t.X_DIRECTION,t.instanceMatrix,t.initTranslationLU,t.initTranslationLD,t.x_matrix4,t.textDistance,t.x_dir,t.y_dir,o);t.textDistance=s.textDistance,t.pointList[0].point.copy(s.leftUpPt),t.pointList[1].point.copy(s.rightUpPt),t.pointList[2].point.copy(s.rightDwPt),t.pointList[3].point.copy(s.leftDwPt),t.pointList[4].point.copy(s.midPoint),t.pointList[5].point.copy(s.rotatePt),t.pointList[6].point.copy(s.rightUpPt),this.operationalChange(t,s),t.textDashLine=s.children[1],t.textDashLine.visible=r,t.leaderGroup.add(s),e&&(a=this.OpAnnotation.getAnnotationResult(t.uuid))&&a.updatePointDiv()}updateAnnotationResultRectangle(t,e,n){var i=t.worldMatrix,o=(t.clearLeaderGroup(),[]);0<t.lineList.length&&(o.push(t.lineList[0].data),o=this.createRectangleBoxMesh(o,t.style,i,t.X_DIRECTION,t.instanceMatrix,t.initTranslationLU,t.initTranslationLD,t.initTranslationORLU,t.x_matrix4,t.x_dir,t.y_dir,!n,this.getColorFromMap(t.style.color,t.style.lineWidth)),t.pointList[0].point.copy(o.leftUpPt),t.pointList[1].point.copy(o.rightUpPt),t.pointList[2].point.copy(o.rightDwPt),t.pointList[3].point.copy(o.leftDwPt),t.pointList[4].point.copy(o.midPoint),t.pointList[5].point.copy(o.rotatePt),t.pointList[6].point.copy(o.rightUpPt),t.pointList[7].point.copy(new THREE.Vector3((o.leftUpPt.x+o.rightUpPt.x)/2,(o.leftUpPt.y+o.rightUpPt.y)/2,(o.leftUpPt.z+o.rightUpPt.z)/2)),t.pointList[8].point.copy(new THREE.Vector3((o.rightDwPt.x+o.rightUpPt.x)/2,(o.rightDwPt.y+o.rightUpPt.y)/2,(o.rightDwPt.z+o.rightUpPt.z)/2)),t.pointList[9].point.copy(new THREE.Vector3((o.rightDwPt.x+o.leftDwPt.x)/2,(o.rightDwPt.y+o.leftDwPt.y)/2,(o.rightDwPt.z+o.leftDwPt.z)/2)),t.pointList[10].point.copy(new THREE.Vector3((o.leftUpPt.x+o.leftDwPt.x)/2,(o.leftUpPt.y+o.leftDwPt.y)/2,(o.leftUpPt.z+o.leftDwPt.z)/2)),t.leaderGroup.add(o),this.operationalChange(t,o))}updateAnnotationResultCircle(t,e,i,n){var o=t.worldMatrix,a=t.textDashLine&&t.textDashLine.visible,r=(t.clearLeaderGroup(),[]);if(0<t.lineList.length){let n=[];t.lineList.forEach(t=>{let e=[];t.data.forEach(t=>{e.push(new THREE.Vector3(t.x,t.y,t.z))}),n.push(e)});var s=[],r=(s.push(n[0][0]),r.push(t.lineList[0].data),this.createCircleBoxMesh(r,t.style,o,t.X_DIRECTION,t.instanceMatrix,t.initTranslationLU,t.initTranslationLD,t.initTranslationORLU,t.x_matrix4,t.x_dir,t.y_dir,!i)),a=(t.pointList[0].point.copy(r.leftUpPt),t.pointList[1].point.copy(r.rightUpPt),t.pointList[2].point.copy(r.rightDwPt),t.pointList[3].point.copy(r.leftDwPt),t.pointList[4].point.copy(r.midPoint),t.pointList[5].point.copy(r.rotatePt),t.pointList[6].point.copy(r.rightUpPt),t.pointList[7].point.copy(new THREE.Vector3((r.leftUpPt.x+r.rightUpPt.x)/2,(r.leftUpPt.y+r.rightUpPt.y)/2,(r.leftUpPt.z+r.rightUpPt.z)/2)),t.pointList[8].point.copy(new THREE.Vector3((r.rightDwPt.x+r.rightUpPt.x)/2,(r.rightDwPt.y+r.rightUpPt.y)/2,(r.rightDwPt.z+r.rightUpPt.z)/2)),t.pointList[9].point.copy(new THREE.Vector3((r.rightDwPt.x+r.leftDwPt.x)/2,(r.rightDwPt.y+r.leftDwPt.y)/2,(r.rightDwPt.z+r.leftDwPt.z)/2)),t.pointList[10].point.copy(new THREE.Vector3((r.leftUpPt.x+r.leftDwPt.x)/2,(r.leftUpPt.y+r.leftDwPt.y)/2,(r.leftUpPt.z+r.leftDwPt.z)/2)),t.textDashLine=r,t.textDashLine.visible=!1,t.textDashLine.visible=a,t.leaderGroup.add(r),this.operationalChange(t,r),this.createNewCircle(t.lineList,this.getColorFromMap(t.style.color,t.style.lineWidth),o,t.instanceMatrix,s,t.x_matrix4,t.x_dir,t.y_dir));t.leaderGroup.add(a),i&&(t.isCaptureFlag=this.OpAnnotation.circleCaptureFlag),this.OpAnnotation.circleCaptureFlag=!1}}updateAnnotationResultLine(t,e,i,o){var a=t.worldMatrix;let r=t.textDashLine&&t.textDashLine.visible;if(t.clearLeaderGroup(),0<t.lineList.length){o&&this.updateAnnotationLineData(t.lineList,t);let n=[];t.lineList.forEach(t=>{let e=[];t.data.forEach(t=>{e.push(new THREE.Vector3(t.x,t.y,t.z))}),n.push(e)});o=this.createLineMesh(n,t.style,a,t.X_DIRECTION,t.instanceMatrix,t.initTranslationLU,t.initTranslationLD,t.initTranslationORLU,t.x_matrix4,t.x_dir,t.y_dir),i=(t.pointList[0].point.copy(o.leftUpPt),t.pointList[1].point.copy(o.rightUpPt),t.pointList[2].point.copy(o.rightDwPt),t.pointList[3].point.copy(o.leftDwPt),t.pointList[4].point.copy(o.midPoint),t.pointList[5].point.copy(o.rotatePt),t.pointList[6].point.copy(o.rightUpPt),t.textDashLine=o,i&&(r=!1),t.textDashLine.visible=r,t.leaderGroup.add(o),this.operationalChange(t,o),this.createNewLine(t.lineList,this.getColorFromMap(t.style.color,t.style.lineWidth),a,t.instanceMatrix));t.leaderGroup.add(i)}}updateAnnotationResultCloudLine(t,e,n,i){var o=t.worldMatrix,a=t.textDashLine&&t.textDashLine.visible;if(t.clearLeaderGroup(),0<t.lineList.length){i&&this.updateAnnotationLineData(t.lineList,t);let n=[];t.lineList.forEach(t=>{let e=[];t.data.forEach(t=>{e.push(new THREE.Vector3(t.x,t.y,t.z))}),n.push(e)});var i=[],r=this.createCloudLine(t.lineList,this.getColorFromMap(t.style.color,t.style.lineWidth),o,t.instanceMatrix,i,t),s=[],i=(s.push(i),this.createCloudBoxMesh(s,t.style,o,t.X_DIRECTION,t.instanceMatrix,t.initTranslationLU,t.initTranslationLD,t.initTranslationORLU,t.x_matrix4,t.x_dir,t.y_dir));t.pointList[0].point.copy(i.leftUpPt),t.pointList[1].point.copy(i.rightUpPt),t.pointList[2].point.copy(i.rightDwPt),t.pointList[3].point.copy(i.leftDwPt),t.pointList[4].point.copy(i.midPoint),t.pointList[5].point.copy(i.rotatePt),t.pointList[6].point.copy(i.rightUpPt),t.textDashLine=i,t.textDashLine.visible=a,t.leaderGroup.add(i),this.operationalChange(t,i),t.leaderGroup.add(r)}}updateAnnotationResult2Pt(t,e,n){var i,o,a,r=t.worldMatrix;t.clearLeaderGroup();let s=[];0<t.lineList.length&&(t.lineList.forEach(t=>{let e=[];t.data.forEach(t=>{e.push(new THREE.Vector3(t.x,t.y,t.z))}),s.push(e)}),a=t.lineList[0].data[0].clone(),i=t.lineList[0].data[1].clone(),o=new THREE.Vector3((a.x+i.x)/2,(i.y+a.y)/2,0),t.pointList[0].point.copy(a),t.pointList[1].point.copy(i),t.pointList[2].point.copy(o),this.getAbovePoint(t),a=this.create2PtAnnotation(t.lineList,this.getColorFromMap(t.style.color,t.style.lineWidth),r,t.instanceMatrix,t.type,t.style),t.leaderGroup.add(a))}getAbovePoint(t){var e=this.OpAnnotation.get2dPoint(t.pointList[0].point.clone().applyMatrix4(t.instanceMatrix.clone()).applyMatrix4(t.worldMatrix.clone())),n=this.OpAnnotation.get2dPoint(t.pointList[1].point.clone().applyMatrix4(t.instanceMatrix.clone()).applyMatrix4(t.worldMatrix.clone()));!(e.y>n.y)&&(e.y!=n.y||e.x>n.x)?t.pointList[3].point.copy(t.pointList[0].point):t.pointList[3].point.copy(t.pointList[1].point)}operationalChange(t,e){var n=this.OpAnnotation.get2dPoint(t.pointList[0].point.clone().applyMatrix4(t.instanceMatrix.clone()).applyMatrix4(t.worldMatrix.clone())),i=this.OpAnnotation.get2dPoint(t.pointList[1].point.clone().applyMatrix4(t.instanceMatrix.clone()).applyMatrix4(t.worldMatrix.clone())),n=(n.x<i.x&&n.y<=i.y&&t.pointList[6].point.copy(e.rightUpPt),n.x<=i.x&&n.y>i.y&&t.pointList[6].point.copy(e.rightDwPt),n.x>=i.x&&n.y<i.y&&t.pointList[6].point.copy(t.pointList[0].point.clone()),n.x>i.x&&n.y>=i.y&&t.pointList[6].point.copy(e.leftDwPt),t.pointList[1].point.clone().applyMatrix4(t.instanceMatrix.clone()).applyMatrix4(t.worldMatrix.clone())),i=t.pointList[2].point.clone().applyMatrix4(t.instanceMatrix.clone()).applyMatrix4(t.worldMatrix.clone()),o=t.pointList[4].point.clone().applyMatrix4(t.instanceMatrix.clone()).applyMatrix4(t.worldMatrix.clone()),o=this.calculatingRotationPt(o,new THREE.Vector3((n.x+i.x)/2,(n.y+i.y)/2,0)),n=t.instanceMatrix.clone().invert(),i=t.worldMatrix.clone().invert(),o=o.applyMatrix4(i.clone()).applyMatrix4(n.clone());t.pointList[5].point.copy(o),e.rotatePt=o.clone()}createNewLine(t,r,e,n){let s=new THREE.Group;return t.forEach((n,t)=>{let i=[],o=(n.data.forEach((t,e)=>{0==e||e==n.data.length-1||i.push(t.clone()),i.push(t.clone())}),[]);i.forEach((t,e)=>{o.push(t.x),o.push(t.y),o.push(0),0!=e&&e!=i.length-1&&(o.push(i[e].x),o.push(i[e].y),o.push(0))});var e=new Float32Array(o),a=new P,e=(a.setPositions(e),new M(a,r));e.objectType="annoLine",s.add(e)}),s.applyMatrix4(n.clone()),s.applyMatrix4(e.clone()),s.updateMatrixWorld(),s.objectType="Group",s}getCloudArc(o,a,t){var r=[];if(o.length<2)return[];var s=t?o[o.length-2].clone().sub(o[o.length-1].clone()).normalize().dot(new THREE.Vector3(1,0,0))<=0:0<=o[o.length-2].clone().sub(o[o.length-1].clone()).normalize().dot(new THREE.Vector3(1,0,0)),l=(0<s?new THREE.Vector3(0,0,1):new THREE.Vector3(0,0,-1)).normalize();for(let i=0;i<o.length-1;++i){var c=o[i],p=o[i+1],h=c.clone().distanceTo(p.clone())/2,d=a,u=(h**2+d**2)/(2*d),E=c.clone().addScaledVector(p.clone().sub(c.clone()),.5),T=p.clone().sub(c.clone()).normalize().cross(l).normalize(),E=E.clone().addScaledVector(T,u-d),T=new THREE.Vector3(1,0,0).normalize(),y=(s?(new THREE.Vector3).subVectors(p.clone(),E.clone()):(new THREE.Vector3).subVectors(c.clone(),E.clone())).normalize(),w=T;let t=s?T.normalize().angleTo(p.clone().sub(E.clone()).normalize()):T.normalize().angleTo(c.clone().sub(E.clone()).normalize());this.isOverPI(y,w)&&(t=2*Math.PI-t);T=d<h?c.clone().sub(E.clone()).normalize().angleTo(p.clone().sub(E.clone()).normalize()):2*Math.PI-c.clone().sub(E.clone()).normalize().angleTo(p.clone().sub(E.clone()).normalize());let e=t,n=t+T;s||([e,n]=[n,e]);y=new THREE.EllipseCurve(E.x,E.y,u,u,n,e,s,0);r.push(...y.getPoints(10))}return r}getCloudDir(e,t){var n=e[0].clone(),i=n.clone(),o=n.clone(),a=n.clone(),r=n.clone();for(let t=0;t<e.length;t++){var s=new THREE.Vector3(e[t].x,e[t].y,e[t].z);s.x<i.x&&(i.x=s.x),s.x>o.x&&(o.x=s.x),s.y<r.y&&(r.y=s.y),s.y>a.y&&(a.y=s.y)}var n=new THREE.Vector3((i.x+o.x)/2,(a.y+r.y)/2),l=e[e.length-2].clone(),c=e[e.length-1].clone(),p=l.clone().addScaledVector(c.clone().sub(l.clone()),.5),h=(0<(l.clone().sub(c.clone()).normalize().dot(new THREE.Vector3(1,0,0))<0)?new THREE.Vector3(0,0,1):new THREE.Vector3(0,0,-1)).normalize(),h=c.clone().sub(l.clone()).normalize().cross(h).normalize(),h=p.clone().addScaledVector(h,10);return t<l.clone().distanceTo(c.clone())/2?0<h.clone().sub(p.clone()).normalize().dot(n.clone().sub(p.clone()).normalize()):h.clone().sub(p.clone()).normalize().dot(n.clone().sub(p.clone()).normalize())<0}getAnnotationLine2Pt(t,e){var t=new Float32Array(t),n=new P,t=(n.setPositions(t),new M(n,e));return t.objectType="annoLine",t}getAnnotationArrow2Pt(t,e,n){var i=new THREE.Vector3(t[0],t[1],t[2]),o=new THREE.Vector3(t[t.length-3],t[t.length-2],t[t.length-1]),a=this.createArrowMesh(o,(new THREE.Vector3).subVectors(i,o).normalize(),!1,this.getColorFromMap(n.color),n,null),n=n.arrowSize[0],i=(new THREE.Vector3).subVectors(i,o).normalize(),o=o.clone().addScaledVector(i,n/2.818),i=[],n=((i=JSON.parse(JSON.stringify(t)))[3]=o.x,i[4]=o.y,new Float32Array(i)),t=new P,o=(t.setPositions(n),new M(t,e));return o.objectType="annoLine",{annotation2PtMesh:o,arrow1:a}}create2PtAnnotation(t,r,e,n,s,l){let c=new THREE.Group;return t.forEach((t,e)=>{let n=[];t.data.forEach(t=>{n.push(t.clone())});var i=[];for(let t=0;t<n.length;++t)i.push(n[t].x),i.push(n[t].y),i.push(0);let o=null,a=null;switch(s){case"newLine2Pt":o=this.getAnnotationLine2Pt(i,r);break;case"newArrow2Pt":({annotation2PtMesh:o,arrow1:a}=this.getAnnotationArrow2Pt(i,r,l))}o&&(c.add(o),a)&&c.add(a)}),c.objectType="Group",c.applyMatrix4(n.clone()),c.applyMatrix4(e.clone()),c.updateMatrixWorld(),c}createCloudLine(t,l,e,n,c,i){i.cloudLineWidth||(i.cloudLineWidth=this.getLinePrecision(12));let p=2*(i=i.cloudLineWidth),h=8*i,d=.5*i,u=i,E=new THREE.Group;return t.forEach((n,t)=>{let i=[],o=(n.data.forEach((t,e)=>{if(0<e)if(3<=i.length&&e==n.data.length-1&&n.data[0].clone().distanceTo(t.clone())<=2*u)i.push(n.data[0].clone());else if(i[i.length-1].clone().distanceTo(t.clone())>=p&&i[i.length-1].clone().distanceTo(t.clone())<h)i.push(t.clone());else{for(;i[i.length-1].clone().distanceTo(t.clone())>h;)i.push(i[i.length-1].clone().addScaledVector(t.clone().sub(i[i.length-1].clone()).normalize(),h));i[i.length-1].clone().distanceTo(t.clone())>=p&&i[i.length-1].clone().distanceTo(t.clone())<h&&i.push(t.clone())}else i.push(t.clone())}),i.length<2&&i.push(i[0].clone().addScaledVector(i[i.length-1].clone().sub(i[0].clone()).normalize(),p)),[]);var e=[];for(let t=0;t<i.length;++t)e.push(i[t].x),e.push(i[t].y),e.push(0);let a=this.getCloudArc(i,d,this.getCloudDir(i,d));c.push(...a),a.forEach((t,e)=>{o.push(t.x),o.push(t.y),o.push(0),0!=e&&e!=a.length-1&&(o.push(t.x),o.push(t.y),o.push(0))});var r=new Float32Array(o),s=new P,r=(s.setPositions(r),new M(s,l));r.objectType="annoLine",E.add(r)}),E.objectType="Group",E.applyMatrix4(n.clone()),E.applyMatrix4(e.clone()),E.updateMatrixWorld(),E}createNewCircle(t,s,e,n,l,i,c,p){let h=new THREE.Group,d;t.forEach((n,t)=>{let i=[];if(n.data.forEach((t,e)=>{0==e||e==n.data.length-1||i.push(t.clone()),i.push(t.clone())}),!(i.length<2)){var e=[],o=(e.push(i[0]),e.push(i[i.length-1]),d=e[0].clone().addScaledVector(e[1].clone().sub(e[0].clone()),.5),e[1].clone().sub(d.clone()).projectOnVector(c.clone()).distanceTo(new THREE.Vector3(0,0,0))),e=e[1].clone().sub(d.clone()).projectOnVector(p.clone()).distanceTo(new THREE.Vector3(0,0,0)),a=new THREE.EllipseCurve(d.x,d.y,o,e,0,2*Math.PI,!1).getPoints(50),r=(l.push(...a),[]);for(let t=0;t<a.length-1;++t)r.push(a[t].x),r.push(a[t].y),r.push(0),0!=t&&(r.push(a[t].x),r.push(a[t].y),r.push(0));r.push(a[0].x),r.push(a[0].y),r.push(0);o=new Float32Array(r),e=new P,o=(e.setPositions(o),new M(e,s));o.objectType="annoLine",h.add(o)}});var t=i.clone(),i=n.clone(),o=new THREE.Vector3,a=new THREE.Quaternion,r=new THREE.Vector3,i=(i.clone().decompose(o,a,r),(new THREE.Matrix4D).makeTranslation(d.clone()));return h.objectType="Group",h.applyMatrix4(i.clone().invert()),h.applyMatrix4(t.clone()),h.applyMatrix4(i.clone()),h.applyMatrix4(n.clone()),h.applyMatrix4(e.clone()),h.updateMatrixWorld(),h}updateCameraPosition(t,e){var n=this.getModelCenter(),n=(new THREE.Matrix4D).makeTranslation(n).clone().invert(),i=this.OpAnnotation.viewer.renderer.getPixelRatio(),o=this.OpAnnotation.viewer.renderer.domElement.width/i,i=this.OpAnnotation.viewer.renderer.domElement.height/i,o=this.viewer.clientCoordToModelCoord([o*e[0],i*e[1]]),i=new THREE.Vector3(o[0],o[1],0).clone().applyMatrix4(n),e=this.viewer.clientCoordToModelCoord(t),o=new THREE.Vector3(e[0],e[1],0).clone().applyMatrix4(n),t=(new THREE.Vector3).subVectors(i,o),e=this.OpAnnotation.viewer.camera.position.clone().add(t.clone().negate()),n=this.OpAnnotation.viewer.camera.target.clone().add(t.clone().negate());this.viewer.camera.position.set(e.x,e.y,e.z),this.viewer.camera.setCameraTarget(n),this.viewer.camera.updateProjectionMatrix(),this.viewer.camera.updateMatrixWorld(!0),this.OpAnnotation.render(!0)}onNeedAddNMouseMove(t,e,n,i){i?this.onLMouseClick(t,e):this.updateAnnotationResult(t,e,!0,n)}onLinePointMove(t){this.selectObjectList.push(t.clone()),1<this.selectObjectList.length&&(this.createAnnotationResult(),this.viewer.render(!0))}onResetLineData(){return this.selectObjectList=[],this.resetLineData&&this.resetLineData(),this.viewer.render(!0),!1}onCloudLinePointMove(t){this.selectObjectList.push(t.clone()),1<this.selectObjectList.length&&(this.createAnnotationResult(),this.viewer.render(!0))}onResetCloudLineData(){return this.selectObjectList=[],this.viewer.render(!0),!1}on2PtPointMove(t){1<this.selectObjectList.length&&this.selectObjectList.pop(),this.selectObjectList.push(t.clone()),1<this.selectObjectList.length&&(this.createAnnotationResult(),this.viewer.render(!0))}onTagLinePointMove(t){1<this.selectObjectList.length&&this.selectObjectList.pop(),this.selectObjectList.push(t.clone()),1<this.selectObjectList.length&&(this.createAnnotationResult(),this.viewer.render(!0))}is45Deg(t,e){var n=this.OpAnnotation.get2dPoint(t.clone()),i=this.OpAnnotation.get2dPoint(e.clone()),o=this.OpAnnotation.X_DIRECTION.clone().add(this.OpAnnotation.Y_DIRECTION.clone()),a=this.OpAnnotation.X_DIRECTION.clone().sub(this.OpAnnotation.Y_DIRECTION.clone()),r=this.OpAnnotation.Y_DIRECTION.clone().sub(this.OpAnnotation.X_DIRECTION.clone()),s=new THREE.Vector3(-this.OpAnnotation.Y_DIRECTION.x,-this.OpAnnotation.Y_DIRECTION.y,-this.OpAnnotation.Y_DIRECTION.z).sub(this.OpAnnotation.X_DIRECTION);let l=1;n.x<i.x&&n.y<=i.y&&(l=2),n.x<=i.x&&n.y>i.y&&(l=1),n.x>=i.x&&n.y<i.y&&(l=3),n.x>i.x&&n.y>=i.y&&(l=4);var c=this.getLinePrecision(1e3);let p=new THREE.Vector3,h=new THREE.Vector3;switch(l){case 1:case 3:p=t.clone().addScaledVector(o.clone(),c),h=t.clone().addScaledVector(s.clone(),c);break;case 2:case 4:p=t.clone().addScaledVector(a.clone(),c),h=t.clone().addScaledVector(r.clone(),c)}n=new THREE.Line3(p.clone(),h.clone()),i=new THREE.Vector3,n.closestPointToPoint(e.clone(),!1,i),n=e.clone().distanceTo(i.clone());return{captured:n<this.getLinePrecision(6),capturePoint:i.clone()}}onCirclePointMove(t){1<this.selectObjectList.length&&this.selectObjectList.pop(),this.selectObjectList.push(t.clone()),1<this.selectObjectList.length&&(t=this.is45Deg(this.selectObjectList[0],this.selectObjectList[1]),this.OpAnnotation.circleCaptureFlag=!1,t.captured&&(this.selectObjectList.pop(),this.selectObjectList.push(t.capturePoint.clone()),this.OpAnnotation.circleCaptureFlag=!0),this.createAnnotationResult(),this.viewer.render(!0))}onNMouseMove(t,e){this.OpAnnotation.unsteady&&this.updateAnnotationResult(t,e)}onLMouseClick(e,n,t){if(this.OpAnnotation.annotationInChange)return!1;if("tagLine"==this.annotationType&&this.OpAnnotation.annotationNeedAddList)return this.OpAnnotation.taglineSave||(setTimeout(()=>{h.isMobileDevice()?this.updateCameraPosition([e,n],[.25,.5]):this.updateCameraPosition([e,n],[.4,.5])},500),this.OpAnnotation.commitTagLineResult(this.OpAnnotation.unsteadyUUid)),!1;if("newLine"==this.annotationType||"cloudLine"==this.annotationType||"newCircle"==this.annotationType||"newRectangle"==this.annotationType||"newArrow2Pt"==this.annotationType||"newLine2Pt"==this.annotationType)return this.OpAnnotation.annotationDataSelected&&this.OpAnnotation.addAnnotationResult(this.OpAnnotation.unsteadyUUid),!1;if(this.OpAnnotation.unsteady||!this.OpAnnotation.annotationNeedAddList&&!this.OpAnnotation.annotationDataSelected){if("tagLine"==this.annotationType&&(0==this.selectObjectList.length||1==this.selectObjectList.length))return r=this.viewer.clientCoordToModelCoord([e,n]),r=new THREE.Vector3(r[0],r[1],0),this.selectObjectList.push(r.clone()),!1;if(""!=this.annotationType){let t=null;var i=this.getCurAllowType();do{if(-1!=i.indexOf("point")&&this.snappedPoint){t={type:"point",point:this.snappedPoint.clone()};break}var o=this.doRaycasterPick(e,n,!0);if(o&&0<o.length)if(-1!=i.indexOf("point")){var a=this.getSnappedPointFromIntersect(o[0],!1);if(a){t={type:"point",point:a.clone()};break}}else{a=this.getSelectInfoFromIntersect(o[0]);if(a&&-1!=i.indexOf(a.type)){"line"==a.type&&!this.isline(a)||(t=a);break}}if(-1!=i.indexOf("point")){o=this.doRaycasterPickPoint(e,n);t={type:"point",point:o.clone()};break}}while(0);t&&(-1<(r=this.isSelInfoTheSameWithList(t))?(this.delSelectObjectList(r),this.OpAnnotation.PostInfo(this.getPostInfo())):this.addSelectObjectToList(t)?(this.addSelectObjectList(t),this.OpAnnotation.PostInfo(this.getPostInfo()),this.createAnnotationResult()&&this.OpAnnotation.PostInfo(this.getPostInfo()),"newText"==this.annotationType&&setTimeout(()=>{h.isMobileDevice()?this.updateCameraPosition([e,n],[.25,.5]):this.updateCameraPosition([e,n],[.4,.5])},500)):this.addSelectObjectToList(t)),this.delPreSelectObj()}else{var r=this.doRaycasterGeomPick(e,n);if(r&&0<r.length){let t=r[0].object;for(;t&&"annotationData"!=t.name;)t=t.parent;t&&t.annotationUUid&&(h.isMobileDevice()&&(this.OpAnnotation.isInSelected=!0,setTimeout(()=>{this.OpAnnotation.isInSelected=!1},200)),this.OpAnnotation.annotationDataSelected&&this.OpAnnotation.deSelAnnotationResult(this.OpAnnotation.unsteadyUUid),this.OpAnnotation.selAnnotationResult(t.annotationUUid))}}}else this.OpAnnotation.addAnnotationResult(this.OpAnnotation.unsteadyUUid),this.OpAnnotation.PostInfo(this.getPostInfo())}renderAnnotationScene(){}doRaycasterPick(t,e,n,i){var o=this.viewer,a=o.renderer.domElement,r=o.renderer.getPixelRatio(),t=t*r/a.width*2-1,e=2*-(e*r/a.height)+1,r=new THREE.Raycaster,a=(o.camera.setCastRay(r,t,e),n&&(r.linePrecision=this.getLinePrecision()),null);return a=o.ndsModel?n?o.ndsModel.intersect(r.ray,r.linePrecision,i):o.ndsModel.intersect(r.ray):a}doRaycasterPickPoint(t,e){var n=this.viewer.renderer.domElement,i=this.viewer.renderer.getPixelRatio(),o=new THREE.Raycaster,t=(this.viewer.camera.setCastRay(o,t*i/n.width*2-1,2*-(e*i/n.height)+1),new THREE.Plane(new THREE.Vector3(0,0,-1),0)),e=new THREE.Vector3;return o.ray.intersectPlane(t,e),e}doRaycasterGeomPick(t,e){if(h.isMobileDevice()){var n=this.viewer.getExtension("Measure2DAPPExtension");if(n&&n.hasSelected())return!1}else{n=this.viewer.getExtension("Measure2DPCExtension");if(n&&n.hasSelected())return!1}var n=this.viewer,i=n.renderer.domElement,o=n.renderer.getPixelRatio(),t=t*o/i.width*2-1,e=2*-(e*o/i.height)+1,o=new THREE.Raycaster,i=(o.linePrecision=1,n.clientCoordToModelCoord([0,0])),i=new THREE.Vector3(i[0],i[1],i[2]),a=n.clientCoordToModelCoord([4,0]),a=new THREE.Vector3(a[0],a[1],a[2]);return o.linePrecision=.65*i.distanceTo(a),n.camera.setCastRay(o,t,e),o.camera=n.camera,o.intersectObjects(this.OpAnnotation.rootObject.children,!0)}getSnappedPointFromIntersect(t,e){let n=null,i,o,a;return t&&((i=this.getSnappingPntEx(t))?n=i:t.isPointsGeom&&(n=t.point)),!n&&t&&(o=this.getSelectInfoFromIntersect(t))&&"circle"==o.type&&e&&((a=new THREE.Vector3(o.center[0],o.center[1],o.center[2])).applyMatrix4(o.matrixWorld),n=a),n}getSnappingPntExV2(t,e){if(t){var n;if(this.viewer.hasBrepInfo()){var i=t.object;if(!i)return;var i=i.uuid,o=(this.viewer.brepManager||this.viewer.ndsModel.activeModel.brepManager).GetEdgesPointsInfoByBodyUUID(i);if(!o||o.length<=0)return;for(var a,r=e*e,s=t.point.clone(),i=this.viewer.modelCoordToClientCoord([s.x,s.y,s.z]),l=new THREE.Vector3(i[0],i[1],0),c=new THREE.Vector3,p=64,h=0;h<o.length;h++)s.distanceToSquared(o[h])<r&&(a=this.viewer.modelCoordToClientCoord([o[h].x,o[h].y,o[h].z]),c.set(a[0],a[1],0),(a=l.distanceToSquared(c))<p)&&(n=o[h],p=a)}else d.inBIMContext||(this.snappingTool.doSnapping(t),this.snappingTool.isSnapped()&&this.snappingTool.getSnappedType()==u&&(n=this.snappingTool.getSnappedVertex()));return n}}getSelectInfoFromIntersect(t){if(t&&this.viewer.hasBrepInfo()){var e,n,i,o,a,r=t.object;if(r)return r=r.uuid,n=t.object.uuid,this.viewer.ndsModel&&(0<=t.meshId?(t.mesh=this.viewer.ndsModel.meshManager.getSingleMesh(t.meshId),t.mesh&&(i=t.faceIndex-t.mesh.geometry.drawRange.start/3,o="face")):0<=t.lineSegId&&(t.mesh=this.viewer.ndsModel.meshManager.getLineSegments(t.lineSegId),t.mesh)&&(i=.5*(t.index-t.mesh.geometry.drawRange.start),o="edge"),n=t.geomUuid),0<=i&&(a=(e=this.viewer.brepManager||this.viewer.ndsModel.activeModel.brepManager).GetBrepInfoByUUidAndTopolIndex(r,n,i,o))&&(a.parentObj=t.mesh,a.geometry=t.mesh.geometry,a.matrixWorld=t.mesh.matrixWorld.clone(),a.intersect=t.point.clone(),a.bodyId=t.bodyId,a.bodyUuid=t.bodyUuid,a.meshId=t.meshId,a.topolIndex=i,a.topolType=o,a.lineSegId=t.lineSegId,2===this.viewer.modelContentVersion&&(a.matrixWorld.elements[14]=0,a.intersect.z=0),"face"==o&&(a.edgeInfos=e.GetEdgeInfoFromFace(r,a.edgeIDS)),a.normal&&null==a.worldNormal&&(n=new THREE.Vector3,i=new THREE.Quaternion,t=new THREE.Vector3,a.parentObj.matrixWorld.decompose(n,i,t),a.worldNormal=new THREE.Vector3(a.normal[0],a.normal[1],a.normal[2]),a.worldNormal.applyQuaternion(i)),a.origin&&null==a.worldOrigin&&(a.worldOrigin=new THREE.Vector3(a.origin[0],a.origin[1],a.origin[2]),a.worldOrigin.applyMatrix4(a.matrixWorld)),a.radius&&(a.realRadius=a.radius),a.viewportId=a.geometry.viewportId,-1<a.geometry.viewportId)&&this.viewer.viewprots&&(o=this.viewer.viewprots[a.geometry.viewportId])&&null!=a.radius&&(a.radius=a.radius*o.scale),a}}getFilterDistByBody(t){var e,n;return t?(t.boxDiagonalLength||(e=new THREE.Vector3,n=new THREE.Vector3,this.viewer.computeBoundingBox(t,e,n,{flag:!0}),t.boxDiagonalLength=n.distanceTo(e)),.015*t.boxDiagonalLength):.5}getSnappingPntEx(t){if(t){var e;if(this.viewer.hasBrepInfo()){var n=t.object;if(!n)return;var i=n.uuid,o=(this.viewer.brepManager||this.viewer.ndsModel.activeModel.brepManager).GetEdgesExtremePointsByBodyUUID(i);if(!o||o.length<=0)return;for(var a,i=this.getFilterDistByBody(n),r=i*i,s=t.point.clone(),n=this.viewer.modelCoordToClientCoord([s.x,s.y,s.z]),l=new THREE.Vector3(n[0],n[1],0),c=new THREE.Vector3,p=64,h=0;h<o.length;h++)s.distanceToSquared(o[h])<r&&(a=this.viewer.modelCoordToClientCoord([o[h].x,o[h].y,o[h].z]),c.set(a[0],a[1],0),(a=l.distanceToSquared(c))<p)&&(e=o[h],p=a)}else d.inBIMContext||(this.snappingTool.doSnapping(t),this.snappingTool.isSnapped()&&this.snappingTool.getSnappedType()==u&&(e=this.snappingTool.getSnappedVertex()));return e}}getLinePrecision(t){var t=t||4,e=this.viewer.clientCoordToModelCoord([0,0]),e=new THREE.Vector3(e[0],e[1],e[2]),t=this.viewer.clientCoordToModelCoord([t,0]),t=new THREE.Vector3(t[0],t[1],t[2]);return e.distanceTo(t)}getLineStartEndPoints(t){if(("cylinder"==t.type||"cone"==t.type)&&t.origin&&t.axis){var e=t.geometry,n=t.indexRange.concat();if(this.viewer.ndsModel&&(n[0]+=e.drawRange.start/3,n[1]+=e.drawRange.start/3),e.isBufferGeometry){var i=e.index,o=e.attributes.position,a=new THREE.Vector3,r=new THREE.Vector3,s=(a.fromArray(t.origin),r.fromArray(t.axis),new THREE.Quaternion),l=new THREE.Vector3,c=new THREE.Vector3,p=(t.matrixWorld.decompose(l,s,c),r.applyQuaternion(s),r.normalize(),-1/0),h=1/0;a.applyMatrix4(t.matrixWorld);for(var d=n[0],u=n[1];d<=u;d++){var E=3*d,T=i.getX(E),y=i.getX(1+E),E=i.getX(2+E),w=new THREE.Vector3,x=new THREE.Vector3,A=new THREE.Vector3,T=(w.fromBufferAttribute(o,T),x.fromBufferAttribute(o,y),A.fromBufferAttribute(o,E),w.applyMatrix4(t.matrixWorld),x.applyMatrix4(t.matrixWorld),A.applyMatrix4(t.matrixWorld),w.clone().sub(a).dot(r));p<T&&(p=T),T<h&&(h=T),(T=x.clone().sub(a).dot(r))<h&&(h=T),(p=p<T?T:p)<(T=A.clone().sub(a).dot(r))&&(p=T),T<h&&(h=T),A=x=w=null}return 0==Math.abs(p-h)?null:(O=a.clone().add(r.clone().multiplyScalar(p)),{start:a.clone().add(r.clone().multiplyScalar(h)),end:O})}}if("circle"==t.type&&t.center){e=t.geometry,n=t.indexRange.concat();if(this.viewer.ndsModel&&(n[0]+=e.drawRange.start/2,n[1]+=e.drawRange.start/2),e.isBufferGeometry){var i=e.index,g=(R=e.attributes).position.array,l=R.position.data?R.position.data.stride:3;if(null!=i)return m=i.array,a=new THREE.Vector3,O=new THREE.Vector3,a.fromArray(g,m[2*n[0]]*l),O.fromArray(g,m[2*n[0]+1]*l),this.viewer.is2DModel&&a.z==O.z&&(t.center[2]=a.z),w=(c=new THREE.Vector3(t.center[0],t.center[1],t.center[2])).clone().sub(a).normalize(),x=O.clone().sub(a).normalize(),a.applyMatrix4(t.matrixWorld),O.applyMatrix4(t.matrixWorld),c.applyMatrix4(t.matrixWorld),a.sub(c),O.sub(c),(r=a.clone().cross(O)).normalize(),a.set(t.center[0],t.center[1],t.center[2]),a.applyMatrix4(t.matrixWorld),O=a.clone().add(r),{start:a,end:O}}}e=t.geometry,n=t.indexRange.concat();if(this.viewer.ndsModel&&(n[0]+=e.drawRange.start/2,n[1]+=e.drawRange.start/2),e.isBufferGeometry){var R,m,O,i=e.index,g=(R=e.attributes).position.array,s=R.position.data?R.position.data.stride:3;if(null!=i)return m=i.array,a=new THREE.Vector3,O=new THREE.Vector3,a.fromArray(g,m[2*n[0]]*s),O.fromArray(g,m[2*n[1]+1]*s),a.applyMatrix4(t.matrixWorld),O.applyMatrix4(t.matrixWorld),{start:a,end:O}}return null}getLineStartEndPointsV2(t){if("circle"==t.type&&t.center){var e=t.geometry,n=t.indexRange.concat();if(this.viewer.ndsModel&&(n[0]+=e.drawRange.start/2,n[1]+=e.drawRange.start/2),e.isBufferGeometry){var i=e.index,o=(r=e.attributes).position.array,a=r.position.data?r.position.data.stride:3;if(null!=i)return s=i.array,l=new THREE.Vector3,c=new THREE.Vector3,l.fromArray(o,s[2*n[0]]*a),c.fromArray(o,s[2*n[1]+1]*a),a=new THREE.Vector3(t.center[0],t.center[1],t.center[2]),l.applyMatrix4(t.matrixWorld),c.applyMatrix4(t.matrixWorld),a.applyMatrix4(t.matrixWorld),{start:l,end:c,center:a,radius:t.radius}}}e=t.geometry,n=t.indexRange.concat();if(this.viewer.ndsModel&&(n[0]+=e.drawRange.start/2,n[1]+=e.drawRange.start/2),e.isBufferGeometry){var r,s,l,c,i=e.index,o=(r=e.attributes).position.array,a=r.position.data?r.position.data.stride:3;if(null!=i)return s=i.array,l=new THREE.Vector3,c=new THREE.Vector3,l.fromArray(o,s[2*n[0]]*a),c.fromArray(o,s[2*n[1]+1]*a),l.applyMatrix4(t.matrixWorld),c.applyMatrix4(t.matrixWorld),{start:l,end:c}}return null}isSelInfoTheSameWithList(e){let n=-1;for(let t=0;t<this.selectObjectList.length;t++)if(this.isTwoTopolInfoTheSame(e,this.selectObjectList[t].selInfo)){n=t;break}return n}isTwoTopolInfoTheSame(t,e){return!(t&&!e||!t&&e||!t&&!e||t.type!=e.type)&&("point"==t.type?this.isTwoPointTheSame(t.point,e.point):(!this.viewer.ndsModel||t.bodyId==e.bodyId&&t.meshId==e.meshId&&t.lineSegId==e.lineSegId)&&t.parentObj==e.parentObj&&t.id==e.id&&t.indexRange[0]===e.indexRange[0]&&t.indexRange[1]===e.indexRange[1])}isTwoPointTheSame(t,e){return Math.abs(t.x-e.x)<1e-6&&Math.abs(t.y-e.y)<1e-6&&Math.abs(t.z-e.z)<1e-6}isline(t){var e=t.geometry,t=t.indexRange.concat();if(t[1]==t[0])return!0;if(this.viewer.ndsModel&&(t[0]+=e.drawRange.start/2,t[1]+=e.drawRange.start/2),e.isBufferGeometry){var n=e.index,e=e.attributes,i=e.position.array,e=e.position.data?e.position.data.stride:3;if(null!=n){var n=n.array,o=new THREE.Vector3,a=new THREE.Vector3,r=new THREE.Vector3,s=t[0],t=t[1],l=Math.round(.5*(s+t));if(o.fromArray(i,n[2*s]*e),a.fromArray(i,n[2*t+1]*e),a.distanceTo(o)<1e-7)return!1;r.fromArray(i,n[2*l]*e);s=o.clone().sub(r).normalize();return r.clone().sub(a).normalize().distanceTo(s)<2*Math.sin(2*Math.PI/180)}}}isPointBetweenIn(t,e,n){var i;return!!(t&&e&&n)&&(i=e.distanceTo(n),e=t.distanceTo(e),t=t.distanceTo(n),this.isZero(i-e-t))}isZero(t){return Math.abs(t)<1e-6}getViewClientCoords(t){var e=t.offsetX||t.clientX-this.viewer.container.getBoundingClientRect().left,n=t.offsetY||t.clientY-this.viewer.container.getBoundingClientRect().top;return t.srcElement&&t.srcElement!==this.viewer.renderer.domElement&&(e=t.clientX-this.viewer.container.getBoundingClientRect().left,n=t.clientY-this.viewer.container.getBoundingClientRect().top),null==t.srcElement&&t.target&&t.target!==this.viewer.renderer.domElement&&(e=t.clientX-this.viewer.container.getBoundingClientRect().left,n=t.clientY-this.viewer.container.getBoundingClientRect().top),new THREE.Vector2(e,n)}createObjectFromSelInfo(t,e){let n=null;return"point"==t.type?n=t:"line"!=t.type&&"circle"!=t.type||(n=this.createLine(t,e,this.getColorFromMap(e?this.preSelColor:this.OpAnnotation.style.color,this.OpAnnotation.style.lineWidth))),n}createLine(t,e,n){if(t&&t.parentObj instanceof THREE.Line){var i,o={startPos:new THREE.Vector3,endPos:new THREE.Vector3,midPos:new THREE.Vector3},a=t.geometry,r=t.indexRange.concat();if(this.viewer.ndsModel&&(r[0]+=a.drawRange.start/2,r[1]+=a.drawRange.start/2),a.isBufferGeometry){var s=r[1]-r[0]+1,l=a.index,a=a.attributes,c=a.position.array,p=a.position.data?a.position.data.stride:3,h=new Float32Array(6*s);if(null!=l){for(var d=l.array,u=0,a=(o.startPos=new THREE.Vector3,o.endPos=new THREE.Vector3,o.midPos=new THREE.Vector3,r[0]),E=r[1],T=(Math.round(.5*(a+E)),o.thirdPos=null,o.startPos.fromArray(c,d[2*a]*p),o.endPos.fromArray(c,d[2*E+1]*p),o.endPos.distanceTo(o.startPos)<1e-7&&(o.thirdPos=new THREE.Vector3,o.thirdPos.fromArray(c,d[2*(E-1)]*p)),0),y=a,w=E;y<=w;y++,u+=1){var x=d[2*y],A=d[2*y+1],g=new THREE.Vector3,R=new THREE.Vector3;g.fromArray(c,x*p),R.fromArray(c,A*p),h[6*u]=g.x,h[6*u+1]=g.y,h[6*u+2]=g.z,h[6*u+3]=R.x,h[6*u+4]=R.y,h[6*u+5]=R.z,T+=g.clone().distanceTo(R),R=g=null}for(var m=0,y=a;y<=E;y++){var x=d[2*y],A=d[2*y+1],g=new THREE.Vector3,R=new THREE.Vector3,O=(g.fromArray(c,x*p),R.fromArray(c,A*p),m);if(.5*T<(m+=g.clone().distanceTo(R))){var O=.5*T-O,L=R.clone().sub(g);L.normalize(),o.midPos=g.clone().addScaledVector(L,O);break}}s=new P,l=(s.setPositions(h),n),r=this.viewer.renderer.getPixelRatio(),a=this.viewer.renderer.domElement.width/r,n=this.viewer.renderer.domElement.height/r,r=(l.resolution.set(a,n),(i=new M(s,l)).objectType="annoLine",i.LineInfo=[],i.LineInfo.push(this.viewer.ndsModel.bodyUuid2NodeMap[t.bodyUuid].id),this.viewer.ndsModel.geomManager.uuidToIdMap[t.geometry.uuid][0]),a=(i.LineInfo.push(r),i.LineInfo.push(t.topolIndex),i.LineInfo.push(t.lineSegId),e?1:0);i.LineInfo.push(a),i.applyMatrix(t.matrixWorld),i.matrixWorldNeedsUpdate=!0,t.edgeInfo=o,t.edgeInfo.startPos.applyMatrix4(t.matrixWorld),t.edgeInfo.endPos.applyMatrix4(t.matrixWorld),t.edgeInfo.midPos.applyMatrix4(t.matrixWorld),t.edgeInfo.thirdPos&&t.edgeInfo.thirdPos.applyMatrix4(t.matrixWorld)}}return i}}createPreCircle(t,e,n,i,o){t=this.viewer.ndsModel.geomManager.getGeomFromUuid(t,e);if(t){e=[n,i];this.viewer.ndsModel&&(e[0]+=t.drawRange.start/2,e[1]+=t.drawRange.start/2);var n=t.index,i=t.attributes,a=i.position.array,r=i.position.data?i.position.data.stride:3,s=new Float32Array(6*(e[1]-e[0]+1));if(null!=n){for(var l=n.array,c=0,t=e[0],i=e[1],p=new THREE.Vector3,h=new THREE.Vector3,d=t,u=i;d<=u;d++,c+=1){var E=l[2*d],T=l[2*d+1];p.fromArray(a,E*r),h.fromArray(a,T*r),s[6*c]=p.x,s[6*c+1]=p.y,s[6*c+2]=p.z,s[6*c+3]=h.x,s[6*c+4]=h.y,s[6*c+5]=h.z}n=new P,e=(n.setPositions(s),this.getColorFromMap(this.preSelColor,1)),t=new M(n,e);return t.objectType="annoLine",t.applyMatrix(o),t.matrixWorldNeedsUpdate=!0,t}}return null}createCircle(t){if(t&&t.parentObj instanceof THREE.Line){var e={startPos:new THREE.Vector3,endPos:new THREE.Vector3,midPos:new THREE.Vector3},n=t.geometry,i=t.indexRange.concat();if(this.viewer.ndsModel&&(i[0]+=n.drawRange.start/2,i[1]+=n.drawRange.start/2),n.isBufferGeometry){var o=i[1]-i[0]+1,a=n.index,n=n.attributes,r=n.position.array,s=n.position.data?n.position.data.stride:3,l=new Float32Array(6*o),o={};if(null!=a){for(var c=a.array,p=0,n=(e.startPos=new THREE.Vector3,e.endPos=new THREE.Vector3,e.midPos=new THREE.Vector3,i[0]),a=i[1],h=(Math.round(.5*(n+a)),e.thirdPos=null,e.startPos.fromArray(r,c[2*n]*s),e.endPos.fromArray(r,c[2*a+1]*s),e.endPos.distanceTo(e.startPos)<1e-7&&(e.thirdPos=new THREE.Vector3,e.thirdPos.fromArray(r,c[2*(a-1)]*s)),n),d=a;h<=d;h++,p+=1){var u=c[2*h],E=c[2*h+1],T=new THREE.Vector3,y=new THREE.Vector3;T.fromArray(r,u*s),y.fromArray(r,E*s),l[6*p]=T.x,l[6*p+1]=T.y,l[6*p+2]=T.z,l[6*p+3]=y.x,l[6*p+4]=y.y,l[6*p+5]=y.z,T.clone().distanceTo(y),y=T=null}o.newVertices=l,o.matrixWorld=t.matrixWorld}}return o}}createPointMesh(t,e,n){n=new THREE.Mesh(new THREE.SphereGeometry(1),n);return n.position.set(t.x,t.y,t.z),n.objectType="Point",n.Point=t.clone(),n.applyMatrix4(e),n}createPointMeshT(t,e,n){n=new THREE.Mesh(new THREE.SphereGeometry(6e3),n);return n.position.set(t.x,t.y,t.z),n.objectType="Point",n.Point=t.clone(),n.applyMatrix4(e),n.updateMatrixWorld(),n}createPointMesh2(t,e){var n=this.getModelCenter(),n=(new THREE.Matrix4D).makeTranslation(n),i=n.clone().invert(),t=(new THREE.Vector3).copy(t).applyMatrix4(i),i=this.getLinePrecision(this.POINTLINEWIDTH),o=(new THREE.Vector3).copy(t).addScaledVector(this.OpAnnotation.X_DIRECTION,-i),a=(new THREE.Vector3).copy(t).addScaledVector(this.OpAnnotation.X_DIRECTION,i),r=(new THREE.Vector3).copy(t).addScaledVector(this.OpAnnotation.Y_DIRECTION,-i),t=(new THREE.Vector3).copy(t).addScaledVector(this.OpAnnotation.Y_DIRECTION,i),i=new Float32Array([o.x,o.y,o.z,a.x,a.y,a.z,r.x,r.y,r.z,t.x,t.y,t.z]),o=new P,a=(o.setPositions(i),this.viewer.renderer.getPixelRatio()),r=this.viewer.renderer.domElement.width/a,t=this.viewer.renderer.domElement.height/a,i=(e.resolution.set(r,t),new M(o,e));return i.objectType="Line2",i.applyMatrix4(n),i}createLineArrMesh(t,e,n,i){let o=[];t.forEach(t=>{o.push(t.x),o.push(t.y),o.push(t.z)});var t=new Float32Array(o),a=new P,t=(a.setPositions(t),this.viewer.renderer.getPixelRatio()),r=this.viewer.renderer.domElement.width/t,t=this.viewer.renderer.domElement.height/t,r=(e.resolution.set(r,t),new M(a,e));return r.objectType="Line2",r.applyMatrix4(i),n&&r.computeLineDistances(),r}createArrowMesh(t,e,n,i,o,a,r){let s=14,l=1;this.OpAnnotation.annotationNeedAddList||r?(s=this.getLinePrecision(this.ARROWWIDTH+o.lineWidth/2),l=this.getLinePrecision(o.lineWidth/2),o.arrowSize[0]=s,o.arrowSize[1]=l):(s=o.arrowSize[0],l=o.arrowSize[1]);r=new THREE.BufferGeometry;let c=null;c=2==o.arrow?(h=(p=s/2.818)/4,new Float32Array([-h,-p,0,-h,p,0,h,-p,0,h,-p,0,-h,p,0,h,p,0])):3==o.arrow?(p=(h=s/2)/8,new Float32Array([-p,-h,0,-p,h,0,p,-h,0,p,-h,0,-p,h,0,p,h,0])):new Float32Array([0,0,0,n?-s:s,s/6+l,0,n?-s:s,-s/6-l,0]),r.setAttribute("position",new THREE.BufferAttribute(c,3));var p=(new THREE.Quaternion).setFromUnitVectors(new THREE.Vector3(1,0,0),e),h=(r.applyMatrix4((new THREE.Matrix4).makeRotationFromQuaternion(p)),2!=o.arrow&&3!=o.arrow||r.applyMatrix4((new THREE.Matrix4).makeRotationZ(-Math.PI/4)),r.translate(t),new THREE.Mesh(r,i));return h.objectType="annoArrow",h}createTextMesh2(t,e,n,i,o,a,r,s,l,c,p,h){n=(new THREE.Matrix4).multiplyMatrices(n.clone(),o.clone());let d=e.color;var o=16777215,o=(0==parseInt(this.viewer.clearColor)?0!=d&&d!=o&&0!=d&&16777215!=d||(d=o):0!=d&&d!=o&&0!=d&&16777215!=d||(d=0),e.color=d,2==e.fontSacleType),o=parseFloat(o?e.fontSize:this.getLinePrecision(this.OpAnnotation.defaultFontSize)),[u,E,T,y]=(e.curFontSize=o,this.OpAnnotation.MeaCharImpl.createGeomFormNewText(t,e.fontSize=o,e)),w=new THREE.Vector3(0,-o*y*1.1,0),x=new THREE.Vector3(0,o,0),y=new THREE.Vector3(u,-o*y*1.1,0),u=new THREE.Vector3(u,o,0);function A(t,e,n){t.translate(n);for(let t=0;t<e.length;t++)e[t].add(n)}var g=[w,x,y,u],R=c.clone().add(p.clone()),m=c.clone().sub(p.clone()),O=p.clone().sub(c.clone()),p=new THREE.Vector3(-p.x,-p.y,-p.z).sub(c);let L;L=l&&!h?l:this.getLinePrecision(6),A(E,g,new THREE.Vector3(0,-o,0)),A(E,g,new THREE.Vector3(0,0,0)),A(E,g,new THREE.Vector3(0,0,0).addScaledVector(m.normalize(),L));var f=g,v=s;E.applyMatrix4(v);for(let t=0;t<f.length;t++)f[t].applyMatrix4(v);c=new THREE.Mesh(E,T),c.objectType="text",c.name=t||"text",h=w.clone(),l=x.clone(),g=u.clone(),s=y.clone(),h.addScaledVector(p.normalize(),L),l.addScaledVector(O.normalize(),L),g.addScaledVector(R.normalize(),L),s.addScaledVector(m.normalize(),L),E=new THREE.BufferGeometry,T=new THREE.LineDashedMaterial({color:(new THREE.Color).setHex(e.color,THREE.SRGBColorSpace),linewidth:4,scale:1,dashSize:o/5,gapSize:o/5}),t=new Float32Array([h.x,h.y,h.z,l.x,l.y,l.z,g.x,g.y,g.z,s.x,s.y,s.z,h.x,h.y,h.z]),E.setAttribute("position",new THREE.BufferAttribute(t,3)),w=new THREE.Line(E,T),w.computeLineDistances(),w.objectType="text_dashline",x=new THREE.Group,x.add(c),x.add(w),x.objectType="Group",x.midPoint=new THREE.Vector3((l.x+s.x)/2,(l.y+s.y)/2,(l.z+s.z)/2),u=new THREE.Vector3((g.x+s.x)/2,(g.y+s.y)/2,(g.z+s.z)/2),y=(new THREE.Vector3).subVectors(u.clone(),x.midPoint.clone()),p=u.clone().addScaledVector(y.normalize(),5*L);return x.rotatePt=p,x.leftUpPt=l,x.rightUpPt=g,x.leftDwPt=h,x.rightDwPt=s,x.textDistance=L,a.subVectors(x.leftUpPt.clone(),x.midPoint.clone()),r.subVectors(x.leftDwPt.clone(),x.midPoint.clone()),x.applyMatrix4(n),x.updateMatrixWorld(),x}createRectangleBoxMesh(t,e,n,i,o,a,r,s,l,c,p,h,d){n=(new THREE.Matrix4).multiplyMatrices(n.clone(),o.clone());let u=e.color;var o=16777215,o=(0==parseInt(this.viewer.clearColor)?0!=u&&u!=o&&0!=u&&16777215!=u||(u=o):0!=u&&u!=o&&0!=u&&16777215!=u||(u=0),e.color=u,new THREE.Vector3(t[0][0].x,t[0][0].y,t[0][0].z)),e=new THREE.Vector3(t[0][1].x,t[0][1].y,t[0][1].z),t=o.clone().add(c.clone().multiplyScalar(e.clone().sub(o).dot(c.clone()))),E=o.clone().add(p.clone().multiplyScalar(e.clone().sub(o).dot(p))),T=(new THREE.Vector3).subVectors(t,o).normalize(),y=(new THREE.Vector3).subVectors(E,o).normalize(),T=T.clone().dot(c.clone()),c=y.clone().dot(p.clone());let w=1;y=(1==(w=Math.abs(T-1)<.1?Math.abs(c-1)<.1?1:2:Math.abs(c-1)<.1?3:4)?o:2==w?E:3==w?t:e).clone(),p=(1==w?E:2==w?o:3==w?e:t).clone(),T=(1==w?t:2==w?e:3==w?o:E).clone(),c=(1==w?e:2==w?t:3==w?E:o).clone(),e=y.clone(),t=p.clone(),E=c.clone(),y=T.clone(),p=new Float32Array([e.x,e.y,e.z,t.x,t.y,t.z,t.x,t.y,t.z,E.x,E.y,E.z,E.x,E.y,E.z,y.x,y.y,y.z,y.x,y.y,y.z,e.x,e.y,e.z]),c=new P,c.setPositions(p),T=new M(c,d),T.objectType="annoLine",T.applyMatrix4(n),T.updateMatrixWorld(),p=new THREE.Group;p.add(T),p.objectType="Group",p.midPoint=new THREE.Vector3((t.x+y.x)/2,(t.y+y.y)/2,(t.z+y.z)/2);c=new THREE.Vector3((E.x+y.x)/2,(E.y+y.y)/2,(E.z+y.z)/2).clone();return p.rotatePt=c,p.leftUpPt=t,p.rightUpPt=E,p.leftDwPt=e,p.rightDwPt=y,a.subVectors(p.leftUpPt.clone(),p.midPoint.clone()),r.subVectors(p.leftDwPt.clone(),p.midPoint.clone()),s.subVectors(p.leftUpPt.clone(),o.clone()),p}createCircleBoxMesh(t,e,n,i,o,a,r,s,l,c,p,h){n=(new THREE.Matrix4).multiplyMatrices(n.clone(),o.clone());let d=e.color;var o=16777215,o=(0==parseInt(this.viewer.clearColor)?0!=d&&d!=o&&0!=d&&16777215!=d||(d=o):0!=d&&d!=o&&0!=d&&16777215!=d||(d=0),e.color=d,new THREE.Vector3(t[0][0].x,t[0][0].y,t[0][0].z)),u=new THREE.Vector3(t[0][1].x,t[0][1].y,t[0][1].z),E=o.clone().add(c.clone().multiplyScalar(u.clone().sub(o).dot(c.clone()))),T=o.clone().add(p.clone().multiplyScalar(u.clone().sub(o).dot(p))),y=(new THREE.Vector3).subVectors(E,o).normalize(),w=(new THREE.Vector3).subVectors(T,o).normalize(),y=y.clone().dot(c.clone()),c=w.clone().dot(p.clone());let x=1;var w=(1==(x=Math.abs(y-1)<.1?Math.abs(c-1)<.1?1:2:Math.abs(c-1)<.1?3:4)?o:2==x?T:3==x?E:u).clone(),p=(1==x?T:2==x?o:3==x?u:E).clone(),y=(1==x?E:2==x?u:3==x?o:T).clone(),c=(1==x?u:2==x?E:3==x?T:o).clone(),u=w.clone(),E=p.clone(),T=c.clone(),w=y.clone(),p=this.getLinePrecision(10),c=new THREE.BufferGeometry,y=new THREE.LineDashedMaterial({color:(new THREE.Color).setHex(e.color,THREE.SRGBColorSpace),linewidth:4,scale:1,dashSize:p,gapSize:p}),e=new Float32Array([u.x,u.y,u.z,E.x,E.y,E.z,T.x,T.y,T.z,w.x,w.y,w.z,u.x,u.y,u.z]),p=(c.setAttribute("position",new THREE.BufferAttribute(e,3)),new THREE.Line(c,y));p.computeLineDistances(),p.objectType="handLine_dashline";let A=null;this.OpAnnotation.circleCaptureFlag&&!h&&(e=this.getLinePrecision(50),c=new THREE.BufferGeometry,h=t[0][0].clone(),t=t[0][1].clone(),g=(new THREE.Vector3).subVectors(t.clone(),h.clone()).normalize(),t=t.clone().add(g.clone().multiplyScalar(e)),h=h.clone().add(g.clone().negate().multiplyScalar(e)),g=new Float32Array([h.x,h.y,h.z,t.x,t.y,t.z]),c.setAttribute("position",new THREE.BufferAttribute(g,3)),(A=new THREE.Line(c,y)).computeLineDistances(),A.objectType="handLine_dashline_cap");var e=new THREE.Group,h=(e.add(p),A&&e.add(A),e.objectType="Group",e.midPoint=new THREE.Vector3((E.x+w.x)/2,(E.y+w.y)/2,(E.z+w.z)/2),new THREE.Vector3((T.x+w.x)/2,(T.y+w.y)/2,(T.z+w.z)/2)),t=(new THREE.Vector3).subVectors(h.clone(),e.midPoint.clone()),g=h.clone().addScaledVector(t.normalize(),0);return e.rotatePt=g,e.leftUpPt=E,e.rightUpPt=T,e.leftDwPt=u,e.rightDwPt=w,a.subVectors(e.leftUpPt.clone(),e.midPoint.clone()),r.subVectors(e.leftDwPt.clone(),e.midPoint.clone()),s.subVectors(e.leftUpPt.clone(),o.clone()),e.applyMatrix4(n),e.updateMatrixWorld(),e}createLineMesh(n,t,e,i,o,a,r,s,l,c,p){e=(new THREE.Matrix4).multiplyMatrices(e.clone(),o.clone());let h=t.color;o=16777215,0==parseInt(this.viewer.clearColor)?0!=h&&h!=o&&0!=h&&16777215!=h||(h=o):0!=h&&h!=o&&0!=h&&16777215!=h||(h=0),t.color=h,o=new THREE.Vector3(n[0][0].x,n[0][0].y,n[0][0].z);c.clone(),p.clone();let d=1/0,u=-1/0,E=1/0,T=-1/0;for(let e=0;e<n.length;e++)for(let t=0;t<n[e].length;t++){var y=n[e][t].clone(),y=new THREE.Vector3(y.x,y.y,y.z),w=y.x,y=y.y;w<d&&(d=w),w>u&&(u=w),y<E&&(E=y),y>T&&(T=y)}var x=new THREE.Vector3(d,E,0),A=new THREE.Vector3(d,T,0),g=new THREE.Vector3(u,E,0),R=new THREE.Vector3(u,T,0);c.clone().add(p.clone()),c.clone().sub(p.clone()),p.clone().sub(c.clone()),new THREE.Vector3(-p.x,-p.y,-p.z).sub(c);var p=this.getLinePrecision(this.OpAnnotation.defaultFontSize)/2,c=x.clone(),x=A.clone(),A=R.clone(),R=g.clone(),g=this.getLinePrecision(10),m=new THREE.BufferGeometry,t=new THREE.LineDashedMaterial({color:(new THREE.Color).setHex(t.color,THREE.SRGBColorSpace),linewidth:4,scale:1,dashSize:g,gapSize:g}),g=new Float32Array([c.x,c.y,c.z,x.x,x.y,x.z,A.x,A.y,A.z,R.x,R.y,R.z,c.x,c.y,c.z]),g=(m.setAttribute("position",new THREE.BufferAttribute(g,3)),new THREE.Line(m,t)),m=(g.computeLineDistances(),g.objectType="handLine_dashline",new THREE.Group),t=(m.add(g),m.objectType="Group",m.midPoint=new THREE.Vector3((x.x+R.x)/2,(x.y+R.y)/2,(x.z+R.z)/2),new THREE.Vector3((A.x+R.x)/2,(A.y+R.y)/2,(A.z+R.z)/2)),g=(new THREE.Vector3).subVectors(t.clone(),m.midPoint.clone()),t=t.clone().addScaledVector(g.normalize(),5*p);return m.rotatePt=t,m.leftUpPt=x,m.rightUpPt=A,m.leftDwPt=c,m.rightDwPt=R,a.subVectors(m.leftUpPt.clone(),m.midPoint.clone()),r.subVectors(m.leftDwPt.clone(),m.midPoint.clone()),s.subVectors(m.leftUpPt.clone(),o.clone()),m.applyMatrix4(e),m.updateMatrixWorld(),m}createCloudBoxMesh(n,t,e,i,o,a,r,s,l,c,p){e=(new THREE.Matrix4).multiplyMatrices(e.clone(),o.clone());let h=t.color;o=16777215,0==parseInt(this.viewer.clearColor)?0!=h&&h!=o&&0!=h&&16777215!=h||(h=o):0!=h&&h!=o&&0!=h&&16777215!=h||(h=0),t.color=h,o=new THREE.Vector3(n[0][0].x,n[0][0].y,n[0][0].z);let d=1/0,u=-1/0,E=1/0,T=-1/0;for(let e=0;e<n.length;e++)for(let t=0;t<n[e].length;t++){var y=new THREE.Vector3(n[e][t].x,n[e][t].y,n[e][t].z),w=y.x,y=y.y;w<d&&(d=w),w>u&&(u=w),y<E&&(E=y),y>T&&(T=y)}var x=new THREE.Vector3(d,E,0),A=new THREE.Vector3(d,T,0),g=new THREE.Vector3(u,E,0),R=new THREE.Vector3(u,T,0);c.clone().add(p.clone()),c.clone().sub(p.clone()),p.clone().sub(c.clone()),new THREE.Vector3(-p.x,-p.y,-p.z).sub(c);var p=this.getLinePrecision(this.OpAnnotation.defaultFontSize)/2,c=x.clone(),x=A.clone(),A=R.clone(),R=g.clone(),g=this.getLinePrecision(10),m=new THREE.BufferGeometry,t=new THREE.LineDashedMaterial({color:(new THREE.Color).setHex(t.color,THREE.SRGBColorSpace),linewidth:4,scale:1,dashSize:g,gapSize:g}),g=new Float32Array([c.x,c.y,c.z,x.x,x.y,x.z,A.x,A.y,A.z,R.x,R.y,R.z,c.x,c.y,c.z]),g=(m.setAttribute("position",new THREE.BufferAttribute(g,3)),new THREE.Line(m,t)),m=(g.computeLineDistances(),g.objectType="cloudLine_dashline",new THREE.Group),t=(m.add(g),m.objectType="Group",m.midPoint=new THREE.Vector3((x.x+R.x)/2,(x.y+R.y)/2,(x.z+R.z)/2),new THREE.Vector3((A.x+R.x)/2,(A.y+R.y)/2,(A.z+R.z)/2)),g=(new THREE.Vector3).subVectors(t.clone(),m.midPoint.clone()),t=t.clone().addScaledVector(g.normalize(),5*p);return m.rotatePt=t,m.leftUpPt=x,m.rightUpPt=A,m.leftDwPt=c,m.rightDwPt=R,a.subVectors(m.leftUpPt.clone(),m.midPoint.clone()),r.subVectors(m.leftDwPt.clone(),m.midPoint.clone()),s.subVectors(m.leftUpPt.clone(),o.clone()),m.applyMatrix4(e),m.updateMatrixWorld(),m}create2PtBoxMesh(n,t,e,i,o,a,r,s,l,c,p){e=(new THREE.Matrix4).multiplyMatrices(e.clone(),o.clone());let h=t.color;var o=16777215,o=(0==parseInt(this.viewer.clearColor)?0!=h&&h!=o&&0!=h&&16777215!=h||(h=o):0!=h&&h!=o&&0!=h&&16777215!=h||(h=0),t.color=h,new THREE.Vector3(n[0][0].x,n[0][0].y,n[0][0].z)),d=o.clone(),u=o.clone(),E=o.clone(),T=o.clone();for(let e=0;e<n.length;e++)for(let t=0;t<n[e].length;t++){var y=new THREE.Vector3(n[e][t].x,n[e][t].y,n[e][t].z);y.x<d.x&&(d.x=y.x),y.x>u.x&&(u.x=y.x),y.y<T.y&&(T.y=y.y),y.y>E.y&&(E.y=y.y)}u.x,d.x,E.y,T.y;var w=new THREE.Vector3(d.x,T.y,0),x=new THREE.Vector3(d.x,E.y,0),A=new THREE.Vector3(u.x,T.y,0),g=new THREE.Vector3(u.x,E.y,0);var R=[w,x,A,g],m=c.clone().add(p.clone()),O=c.clone().sub(p.clone()),L=p.clone().sub(c.clone()),p=new THREE.Vector3(-p.x,-p.y,-p.z).sub(c),c=this.getLinePrecision(this.OpAnnotation.defaultFontSize)/2,f=new THREE.Vector3(d.x-x.x,E.y-x.y,0),v=R,M=f;for(let t=0;t<v.length;t++)v[t].add(M);var P=R,N=l;for(let t=0;t<P.length;t++)P[t].applyMatrix4(N);f=w.clone(),R=x.clone(),l=g.clone(),w=A.clone(),f.addScaledVector(p.normalize(),c),R.addScaledVector(L.normalize(),c),l.addScaledVector(m.normalize(),c),w.addScaledVector(O.normalize(),c),x=this.getLinePrecision(10),g=new THREE.BufferGeometry,A=new THREE.LineDashedMaterial({color:(new THREE.Color).setHex(t.color,THREE.SRGBColorSpace),linewidth:4,scale:1,dashSize:x,gapSize:x}),p=new Float32Array([f.x,f.y,f.z,R.x,R.y,R.z,l.x,l.y,l.z,w.x,w.y,w.z,f.x,f.y,f.z]),g.setAttribute("position",new THREE.BufferAttribute(p,3)),L=new THREE.Line(g,A),L.computeLineDistances(),L.objectType="annotation2Pt_dashline",m=new THREE.Group,m.add(L),m.objectType="Group",m.midPoint=new THREE.Vector3((R.x+w.x)/2,(R.y+w.y)/2,(R.z+w.z)/2),O=new THREE.Vector3((l.x+w.x)/2,(l.y+w.y)/2,(l.z+w.z)/2),t=(new THREE.Vector3).subVectors(O.clone(),m.midPoint.clone()),x=O.clone().addScaledVector(t.normalize(),5*c);return m.rotatePt=x,m.leftUpPt=R,m.rightUpPt=l,m.leftDwPt=f,m.rightDwPt=w,a.subVectors(m.leftUpPt.clone(),m.midPoint.clone()),r.subVectors(m.leftDwPt.clone(),m.midPoint.clone()),s.subVectors(m.leftUpPt.clone(),o.clone()),m.applyMatrix4(e),m.updateMatrixWorld(),m}getStringColor(e){e=e.toString(16);let n="";for(let t=6-e.length;0<t;t--)n+="0";return n+e}getUnitString(){var t="mm";if(this.viewer.modelUnit)switch(this.viewer.modelUnit.toLowerCase()){case"meter":t="m";break;case"centimeter":t="cm";break;case"millimeter":t="mm";break;case"inch":t="in";break;case"feet":t="ft"}return t}vAndHCapture(e,n,i){e.clearCaptureGroup();var o=this.getLinePrecision(6e3),a=this.OpAnnotation.get2dPoint(n.clone().applyMatrix4(e.worldMatrix.clone())),r=this.OpAnnotation.get2dPoint(i.clone().applyMatrix4(e.worldMatrix.clone()));let t=!1,s=!1,l=!1;if(Math.abs(a.x-r.x)<12?a.y!==r.y&&(t=!0,a.y<r.y)&&(s=!0):Math.abs(a.y-r.y)<12&&a.x!==r.x&&(t=!0,l=!0,a.x>r.x)&&(s=!0),t){let t=new THREE.Vector3;t=(l?this.OpAnnotation.X_DIRECTION:this.OpAnnotation.Y_DIRECTION).clone().normalize(),s||(t=t.negate());a=i.clone().addScaledVector(t.clone(),o),r=[],o=(r.push(i.x),r.push(i.y),r.push(0),r.push(a.x),r.push(a.y),r.push(0),new THREE.Line3(i.clone(),a.clone())),i=new THREE.Vector3,a=(o.closestPointToPoint(n.clone(),!1,i),new Float32Array(r)),o=new THREE.BufferGeometry,n=(o.setAttribute("position",new THREE.BufferAttribute(a,3)),this.getLinePrecision(6)),r=new THREE.LineDashedMaterial({color:(new THREE.Color).setHex(10066329,THREE.SRGBColorSpace),linewidth:4,scale:1,dashSize:n,gapSize:n}),a=new THREE.Line(o,r);return a.computeLineDistances(),a.objectType="cap_dashline",a.applyMatrix4(e.worldMatrix.clone()),a.updateMatrixWorld(),e.captureGroup.add(a),{isInCap:!0,curPoint:i.clone()}}return{isInCap:!1}}getModelCenter(){var t=new THREE.Vector3;return this.viewer.controls.getBoundingBox().getCenter(t),t.z=0,t.x=Math.floor(t.x),t.y=Math.floor(t.y),t}getArcCentralPoint(e,n,i){let o;var a=e[0].clone(),r=e[1].clone(),e=e[e.length-1].clone(),r=(new THREE.Vector3).subVectors(r,a).normalize(),a=(new THREE.Vector3).subVectors(a,n).normalize(),e=(new THREE.Vector3).subVectors(e,n).normalize(),s=a.clone(),l=e.clone(),r=r.clone(),c=new THREE.Vector3(0,0,-1),p=new THREE.Quaternion,h=s.clone(),r=r.clone();if(h.cross(r),h.z<=0){let t;r=s.clone(),h=l.clone();r.cross(h),t=r.z<=0?s.angleTo(l):2*Math.PI-s.angleTo(l),p.setFromAxisAngle(c,t/2),o=a.applyQuaternion(p).multiplyScalar(i).add(n)}else{let t;h=s.clone(),r=l.clone();r.cross(h),t=r.z<=0?l.angleTo(s):2*Math.PI-l.angleTo(s),p.setFromAxisAngle(c,t/2),o=e.applyQuaternion(p).multiplyScalar(i).add(n)}return o.clone()}intersectionPoint(t,e,n,i){var o=t.x,t=t.y,a=e.x,e=e.y,r=n.x,n=n.y,s=i.x,i=i.y,l=(i-n)*(a-o)-(s-r)*(e-t),c={};return 0==l?c.intersect=!1:(r=o+(s=(r*(i-n)+t*(s-r)-n*(s-r)-o*(i-n))/l)*(a-o),i=t+s*(e-t),s<=1&&0<=s?(c.intersect=!0,c.intersectPoint=new THREE.Vector3(r,i,0)):c.intersect=!1),c}isSegment(t,e,n,i,o){var a=this.intersectionPoint(t,o,n,i),r=this.intersectionPoint(e,o,n,i);let s=!1;return a.intersect&&(a=new THREE.Vector3(a.intersectPoint.x,a.intersectPoint.y,0),t=this.isPointBetweenIn(a,t,o),a=this.isPointBetweenIn(a,n,i),t)&&a&&(s=!0),s=r.intersect&&(t=new THREE.Vector3(r.intersectPoint.x,r.intersectPoint.y,0),a=this.isPointBetweenIn(t,e,o),r=this.isPointBetweenIn(t,n,i),a)&&r?!0:s}renderingArc(t,e,n,i,o,a,r,s){var n=(new THREE.Vector3).subVectors(n,o).normalize(),l=(new THREE.Vector3).subVectors(i,o).normalize();return n.angleTo(l)<=e||1e3<r.length?(r.push(i.clone()),r):((l=new THREE.Quaternion).setFromAxisAngle(t,e),n=n.applyQuaternion(l).multiplyScalar(a).add(o),r.push(n),s&&r.push(n),this.renderingArc(t,e,n,i,o,a,r,s))}points2TriMesh(e){let n=null;if(this.OpAnnotation.ndsWebClipper){var i=new this.OpAnnotation.ndsWebClipper.DoubleVector;for(let t=0;t<e.length;t++)i.push_back(e[t]);var o=this.OpAnnotation.ndsWebClipper.Web3DClipperRun(i);if(8<=o.size()){n={area:o.get(0),len:o.get(1),points:[]};for(let t=2;t<o.size();t++)n.points.push(o.get(t))}}else console.log("points2TriMesh failed");return n}realPointCood(e){if(this.viewer.viewprots)for(let t=0;t<this.viewer.viewprots.length;t++){var n=this.viewer.viewprots[t];if(n.box.containsPoint(e))return(new THREE.Vector3).copy(e).applyMatrix4(n.matrix)}return e}continuousAccomplish(){if(this.OpAnnotation.unsteadyUUid){let t=this.OpAnnotation.unsteadyUUid;this.OpAnnotation.addAnnotationResult(t,!0),this.delAllSelectObjectList(),this.viewer.dispatchEvent({type:"MeasureDataLength",data:{length:0,type:"newLine",mainType:"annotation",isShowButton:!1}}),setTimeout(()=>{this.OpAnnotation.selAnnotationResult(t),this.OpAnnotation.PostInfo(i.ANNOTATIONTYPE.ANNOTATIONSAVE)},100)}}lastStepContinuous(){var t;this.OpAnnotation.unsteadyUUid&&(0<(t=this.OpAnnotation.getAnnotationResult(this.OpAnnotation.unsteadyUUid)).lineList.length&&t.lineList.splice(t.lineList.length-1,1),this.updateAnnotationResultLine(t,!1,!0),this.OpAnnotation.rootObject.add(t.group),this.viewer.dispatchEvent({type:"MeasureDataLength",data:{length:t.lineList.length||0,type:t.type,mainType:"annotation",isShowButton:!0}}))}}class r{constructor(t,e,n,i){this.OpAnnotation=t,this.X_DIRECTION=t.X_DIRECTION.clone(),this.createTime=(new Date).getTime(),this.viewer=t.viewer,this.uuid=THREE.Math.generateUUID(),this.group=new THREE.Group,this.group.name="annotationData",this.group.objectType="Group",this.group.annotationUUid=this.uuid,this.leaderGroup=new THREE.Group,this.leaderGroup.objectType="Group",this.group.add(this.leaderGroup),this.captureGroup=new THREE.Group,this.captureGroup.objectType="Group",this.captureGroup.name="captureGroup",this.group.add(this.captureGroup),this.hideOperateButtonList=t.hideOperateButtonList||[],this.isHide=!1,this.type=e,this.typeNum=1,this.unit=i,this.owner=!0,this.pointList=[],this.lineList=[],this.worldMatrix=new THREE.Matrix4,this.worldMatrixInvert=new THREE.Matrix4,this.textString="",this.textDashLine=null,this.textFrameLine=null,this.textObject=null,this.style={fontFamily:n.fontFamily,fontSacleType:n.fontSacleType,fontSize:n.fontSize,isItalic:n.isItalic,color:n.color,isBold:n.isBold,lineWidth:n.lineWidth,curFontSize:18,arrowSize:[36,1]},this.configNum=this.viewer.ConfigNum,this.configName=this.viewer.ConfigName,this.isSelected=!1,this.isUnsteady=!1,this.rotateAngle=0,this.instanceMatrix=new THREE.Matrix4,this.initTranslationLU=new THREE.Vector3,this.initTranslationLD=new THREE.Vector3,this.initTranslationORLU=new THREE.Vector3,this.x_dir=this.OpAnnotation.X_DIRECTION.clone(),this.y_dir=this.OpAnnotation.Y_DIRECTION.clone();e=(new THREE.Quaternion).setFromUnitVectors(new THREE.Vector3(1,0,0),this.x_dir);this.x_matrix4=(new THREE.Matrix4).makeRotationFromQuaternion(e),this.textDistance=0,this.cloudLineWidth=0,this.isCaptureFlag=!1,this.lineType=t.lineType,this.connectType=t.connectType}setFinal(){this.style.fontSize=this.style.curFontSize,this.style.fontSacleType=2}setUnsteady(t){this.isUnsteady=t}setSelected(t){this.isSelected=t}updateTagLineStyle(t){this.lineType=t&&t.lineType||1,this.connectType=t&&t.connectType||1}updateTranslation(t){this.instanceMatrix=(new THREE.Matrix4).multiplyMatrices(t,this.instanceMatrix.clone())}updateRotation(t){this.instanceMatrix=(new THREE.Matrix4).multiplyMatrices(this.instanceMatrix.clone(),t)}updateScale(t){this.instanceMatrix=(new THREE.Matrix4).multiplyMatrices(this.instanceMatrix.clone(),t)}updateInstanceMatrix(t,e){1==e?this.updateTranslation(t):2==e?this.updateRotation(t):3==e&&this.updateScale(t)}getStyle(t){var e=new THREE.Vector3,n=new THREE.Quaternion,i=new THREE.Vector3;return t.instanceMatrix.clone().decompose(e,n,i),{fontFamily:this.style.fontFamily,fontSacleType:this.style.fontSacleType,fontSize:this.style.fontSize*i.x,isItalic:this.style.isItalic,color:this.style.color,isBold:this.style.isBold,lineWidth:this.style.lineWidth,isBlack:0==parseInt(this.OpAnnotation.viewer.clearColor)}}updateStyle(t,e,n){var i=new THREE.Vector3,o=new THREE.Quaternion,a=new THREE.Vector3;e.instanceMatrix.clone().decompose(i,o,a);let r=1;t.fontSize&&2==t.fontSacleType?r=t.fontSize/(e.style.fontSize*a.x):2!=t.fontSacleType&&(r=1/a.x),this.style.fontFamily=t.fontFamily,n?(i=(new THREE.Matrix4).makeScale(r,r,1),this.instanceMatrix=(new THREE.Matrix4).multiplyMatrices(this.instanceMatrix.clone(),i),this.style.fontSacleType=t.fontSacleType,this.style.fontSize=2==t.fontSacleType?e.style.fontSize:this.OpAnnotation.defaultFontSize):this.style.fontSacleType=2,this.style.isItalic=t.isItalic,this.style.color=t.color,this.style.isBold=t.isBold,this.style.lineWidth=t.lineWidth}updateRadiusType(t){this.style.isRadius=t}updatePointDiv(){for(let n=0;n<this.pointList.length;n++){let t,e=0;var i;5===n?(i=this.pointList[4].point.clone().applyMatrix4(this.instanceMatrix.clone()).applyMatrix4(this.worldMatrix.clone()),t=this.pointList[n].point.clone().applyMatrix4(this.instanceMatrix.clone()).applyMatrix4(this.worldMatrix.clone()),e=this.calculatingAngle(this.OpAnnotation.get2dPoint(t.clone()),this.OpAnnotation.get2dPoint(i.clone()))):t=(6==n&&"tagLine"==this.type?this.pointList[n].point.clone():this.pointList[n].point.clone().applyMatrix4(this.instanceMatrix.clone())).applyMatrix4(this.worldMatrix.clone()),this.updateDivPosition(t,this.pointList[n].pointDiv,e)}}hideOtherDiv(e){for(let t=0;t<this.pointList.length;t++)t!=e-1?this.pointList[t].pointDiv.style.display="none":this.pointList[t].pointDiv.style.display="block"}showOtherDiv(){this.pointList.forEach(t=>{t.pointDiv.style.display="block"})}updateTextDashLine(t){this.textDashLine&&(this.textDashLine.visible=t),this.textFrameLine&&(this.textFrameLine.visible=!t)}updateDivPosition(t,e,n){var i,o,a;e&&(t=this.OpAnnotation.get2dPoint(t),null!=e.screenX&&Math.abs(e.screenX-t.x)<=2&&null!=e.screenY&&Math.abs(e.screenY-t.y)<=2||(i=this.viewer.renderer.getPixelRatio(),o=e.width,a=e.height,e.screenX=t.x,e.screenY=t.y,"rightUp"==e.getAttribute("mobile")?(e.style.left=Math.round(t.x/i+8)+"px",e.style.top=Math.round(t.y/i-a-8)+"px"):(e.style.left=Math.round(t.x/i-o/2+1)+"px",e.style.top=Math.round(t.y/i-a/2+1)+"px",0!=n&&(e.style.transform="rotate("+n+"deg)"))))}calculatingAngle(t,e){let n=0;return t.x==e.x?(n=90,e.y>t.y&&(n=360-n)):(n=180*Math.atan((e.y-t.y)/(e.x-t.x))/Math.PI,t.x<e.x&&(n=180+n)),n}calculatingRotationPt(t,e){var n=this.getLinePrecision(6),t=(new THREE.Vector3).subVectors(e.clone(),t.clone());return e.clone().addScaledVector(t.normalize(),15*n)}getLinePrecision(t){var t=t||4,e=this.viewer.clientCoordToModelCoord([0,0]),e=new THREE.Vector3(e[0],e[1],e[2]),t=this.viewer.clientCoordToModelCoord([t,0]),t=new THREE.Vector3(t[0],t[1],t[2]);return e.distanceTo(t)}createPointImgDiv(){if(this.OpAnnotation.annotationNeedAddList)return!1;for(let s=0;s<this.pointList.length;s++)if(!this.pointList[s].isNoDrag){let t=16,e=1,n=null,i="annotation_zoom";4==s||("newLine2Pt"==this.type||"newArrow2Pt"==this.type)&&2==s?(t=32,i="annotation_drag"):5==s&&"tagLine"!=this.type?(t=28,i="annotation_rotate"):6==s&&"tagLine"==this.type||(6==s||5==s&&"tagLine"==this.type||("newLine2Pt"==this.type||"newArrow2Pt"==this.type)&&3==s)&&(n="rightUp",i="annotation_operate",e=0);let o;o="newLine2Pt"==this.type||"newArrow2Pt"==this.type?this.createImageDiv(n,i,t,3==s?-1:2==s?5:s+1,this.uuid,e):"tagLine"==this.type?this.createImageDiv(n,i,t,5==s?-1:6==s?99:s+1,this.uuid,e):this.createImageDiv(n,i,t,6==s?-1:s+1,this.uuid,e);let a,r=0;var l;5===s&&"tagLine"!=this.type?(l=this.pointList[4].point.clone().applyMatrix4(this.instanceMatrix.clone()).applyMatrix4(this.worldMatrix.clone()),a=this.pointList[s].point.clone().applyMatrix4(this.instanceMatrix.clone()).applyMatrix4(this.worldMatrix.clone()),r=this.calculatingAngle(this.OpAnnotation.get2dPoint(a.clone()),this.OpAnnotation.get2dPoint(l.clone()))):a=(6==s&&"tagLine"==this.type?this.pointList[s].point.clone():this.pointList[s].point.clone().applyMatrix4(this.instanceMatrix.clone())).applyMatrix4(this.worldMatrix.clone()),this.updateDivPosition(a,o,r),this.pointList[s].pointDiv=o,this.viewer.container.appendChild(o)}}createImageDiv(t,e,n,i,o,a){var r=document.createElement("div");return r.className=e,-1==i?(r.width=72,r.height=28,"cloudLine"!=this.type&&"newCircle"!=this.type&&"newRectangle"!=this.type&&"newLine2Pt"!=this.type&&"newArrow2Pt"!=this.type&&(e=document.createElement("div"),this.hideOperateButtonList.includes("#tag-can-edit")||(e.className="annotation_edit_img"),e.setAttribute("annotationUUid",o),e.setAttribute("annotationRef",-2),e.setAttribute("annotationPoint",a),this.OpAnnotation.addTouchEvent(e),r.append(e)),e=document.createElement("div"),this.hideOperateButtonList.includes("#tag-can-del")||(e.className="annotation_del_img"),e.setAttribute("annotationUUid",o),e.setAttribute("annotationRef",-1),e.setAttribute("annotationPoint",a),this.OpAnnotation.addTouchEvent(e),r.append(e),t&&r.setAttribute("mobile",t)):(r.width=n,r.height=n,r.setAttribute("annotationUUid",o),r.setAttribute("annotationRef",i),r.setAttribute("annotationPoint",a),t&&r.setAttribute("mobile",t),this.OpAnnotation.addTouchEvent(r)),r}deletePointImgDiv(){for(let t=0;t<this.pointList.length;t++)this.pointList[t].pointDiv&&(this.OpAnnotation.delTouchEvent(this.pointList[t].pointDiv),this.viewer.container.removeChild(this.pointList[t].pointDiv),this.pointList[t].pointDiv=null)}clearLeaderGroup(){let e=this;this.leaderGroup.children.slice().forEach(t=>{e.leaderGroup.remove(t),t.geometry&&(t.geometry.dispose(),t.geometry=null),t.material&&t.material.isLineDashedMaterial&&(t.material.dispose(),t.material=null)})}clearCaptureGroup(){let e=this;this.captureGroup.children.slice().forEach(t=>{e.captureGroup.remove(t),t.geometry&&(t.geometry.dispose(),t.geometry=null),t.material&&t.material.isLineDashedMaterial&&(t.material.dispose(),t.material=null)})}toContent(){let n={state:{}};return n.tagId=this.uuid,n.state.uuid=this.uuid,n.state.rotateAngle=this.rotateAngle,n.state.textDistance=this.textDistance,n.state.cloudLineWidth=this.cloudLineWidth,n.state.isCaptureFlag=this.isCaptureFlag,n.state.connectType=this.connectType,n.state.lineType=this.lineType,n.state.instanceMatrix=this.instanceMatrix.elements,n.state.initTranslationLU={x:this.initTranslationLU.x||0,y:this.initTranslationLU.y||0,z:this.initTranslationLU.z||0},n.state.initTranslationLD={x:this.initTranslationLD.x||0,y:this.initTranslationLD.y||0,z:this.initTranslationLD.z||0},n.state.initTranslationORLU={x:this.initTranslationORLU.x||0,y:this.initTranslationORLU.y||0,z:this.initTranslationORLU.z||0},n.xydirs=[this.x_dir.x,this.x_dir.y,this.x_dir.z,this.y_dir.x,this.y_dir.y,this.y_dir.z],n.state.origiType=this.type,n.state.X_DIRECTION={x:this.X_DIRECTION.x,y:this.X_DIRECTION.y,z:this.X_DIRECTION.z},n.state.typeNum=this.typeNum,n.state.unit=this.unit,n.state.configNum=this.configNum,n.state.configName=this.configName,n.state.textString=this.textString,n.state.isHide=this.isHide,n.state.style={fontFamily:this.style.fontFamily,fontSacleType:this.style.fontSacleType,fontSize:this.style.fontSize,isItalic:this.style.isItalic,color:this.style.color,isBold:this.style.isBold,lineWidth:this.style.lineWidth,arrowSize:this.style.arrowSize},n.state.matrix=this.worldMatrix.elements,n.state.pointList=[],n.state.lineList=[],this.pointList.forEach(function(t){n.state.pointList.push([t.point.x,t.point.y,t.point.z,t.isNoDrag,t.viewportId])}),this.lineList.forEach(function(t){let e=[];t.data.forEach(t=>{e.push([t.x,t.y,t.z])}),n.state.lineList.push({line:e})}),n}fromContent(t){let n=this;this.uuid=t.tagId,this.configNum=t.state.configNum,this.configName=t.state.configName,this.textDistance=t.state.textDistance,this.cloudLineWidth=t.state.cloudLineWidth,this.isCaptureFlag=t.state.isCaptureFlag,this.lineType=t.state.lineType,this.connectType=t.state.connectType,this.type=t.state.origiType,this.typeNum=t.state.typeNum,this.rotateAngle=t.state.rotateAngle,this.instanceMatrix.fromArray(t.state.instanceMatrix),this.initTranslationLU=new THREE.Vector3(t.state.initTranslationLU.x,t.state.initTranslationLU.y,t.state.initTranslationLU.z),this.initTranslationLD=new THREE.Vector3(t.state.initTranslationLD.x,t.state.initTranslationLD.y,t.state.initTranslationLD.z),this.initTranslationORLU=new THREE.Vector3(t.state.initTranslationORLU.x,t.state.initTranslationORLU.y,t.state.initTranslationORLU.z),this.textString=t.state.textString,this.isHide=t.state.isHide,this.X_DIRECTION=new THREE.Vector3(t.state.X_DIRECTION.x,t.state.X_DIRECTION.y,t.state.X_DIRECTION.z),t.xydirs?(this.x_dir.set(t.xydirs[0],t.xydirs[1],t.xydirs[2]),this.y_dir.set(t.xydirs[3],t.xydirs[4],t.xydirs[5])):(this.x_dir.copy(this.OpAnnotation.X_ORG_DIR),this.y_dir.copy(this.OpAnnotation.Y_ORG_DIR));var e=(new THREE.Quaternion).setFromUnitVectors(new THREE.Vector3(1,0,0),this.x_dir);this.x_matrix4=(new THREE.Matrix4).makeRotationFromQuaternion(e),this.worldMatrix.fromArray(t.state.matrix),this.worldMatrixInvert=this.worldMatrix.clone().invert(),this.group.annotationUUid=t.state.uuid,this.style.editString=t.state.style.editString,this.style.arrowSize=t.state.style.arrowSize,this.style.isRadius=t.state.style.isRadius,this.linearDirection=t.state.linearDirection,t.state.pointList&&t.state.pointList.forEach(function(t){n.pointList.push({point:new THREE.Vector3(t[0],t[1],t[2]),pointDiv:null,isNoDrag:t[3]||null,viewportId:null!=t[4]?t[4]:-1})}),t.state.lineList&&t.state.lineList.forEach(function(t){let e=[];t.line.forEach(t=>{e.push(new THREE.Vector3(t[0],t[1],t[2]))}),n.lineList.push({data:e})})}}var c=NDSWebViewer.NDS;class p extends a{constructor(t){super(t),this.annotationClass="newText",this.maxSelectCount=1}OperatorStart(t){this.annotationType=t,this.OpAnnotation.PostInfo(c.ANNOTATIONTYPE.ANNOTATIONPT)}getPostInfo(){let t=c.ANNOTATIONTYPE.NONE;return t=this.OpAnnotation.annotationNeedAddList||1==this.selectObjectList.length?"":c.ANNOTATIONTYPE.ANNOTATIONPT}getCurAllowType(){return["point"]}addSelectObjectToList(t){return!0}createAnnotationResult(){var t,e,n;this.selectObjectList.length==this.maxSelectCount&&(t=new r(this.OpAnnotation,this.annotationType,this.OpAnnotation.style,this.getUnitString()),e=this.getModelCenter(),n=this.selectObjectList[0].selInfo.point,t.worldMatrix=(new THREE.Matrix4D).makeTranslation(e),t.worldMatrixInvert=t.worldMatrix.clone().invert(),t.instanceMatrix=(new THREE.Matrix4D).makeTranslation(n.clone().applyMatrix4(t.worldMatrixInvert)),t.pointList.push({point:new THREE.Vector3,pointDiv:null},{point:new THREE.Vector3,pointDiv:null},{point:new THREE.Vector3,pointDiv:null},{point:new THREE.Vector3,pointDiv:null},{point:new THREE.Vector3,pointDiv:null},{point:new THREE.Vector3,pointDiv:null},{point:new THREE.Vector3,pointDiv:null}),this.OpAnnotation.annotationNeedAddList=!0,this.OpAnnotation.annotationInChange=!0,this.OpAnnotation.viewer.dispatchEvent({type:"annotationAddText",data:{uuid:t.uuid}}),this.updateAnnotationResultText(t,!1,!0),this.OpAnnotation.rootObject.add(t.group),super.createAnnotationResult(t))}}var E=NDSWebViewer.NDS;class T extends a{constructor(t){super(t),this.annotationClass="newLine",this.maxSelectCount=1,this.isNewData=!0}OperatorStart(t){this.annotationType=t,this.OpAnnotation.PostInfo(E.ANNOTATIONTYPE.ANNOTATIONLINE)}getPostInfo(){let t=E.ANNOTATIONTYPE.NONE;return t=(this.OpAnnotation.annotationNeedAddList||this.selectObjectList.length,E.ANNOTATIONTYPE.ANNOTATIONLINE)}getCurAllowType(){return["point"]}addSelectObjectToList(t){return!0}resetLineData(){this.isNewData=!0}createAnnotationResult(){let n;if(this.OpAnnotation.unsteadyUUid){0==(n=this.OpAnnotation.getAnnotationResult(this.OpAnnotation.unsteadyUUid)).lineList.length&&0<this.selectObjectList.length&&(t=new THREE.Vector3(this.selectObjectList[0].x,this.selectObjectList[0].y,0),n.instanceMatrix=(new THREE.Matrix4D).makeTranslation(t.clone().applyMatrix4(n.worldMatrixInvert.clone())));let e=[];this.selectObjectList.forEach(t=>{t=new THREE.Vector3(t.x,t.y,t.z);e.push(t.clone().applyMatrix4(n.worldMatrixInvert).applyMatrix4(n.instanceMatrix.clone().invert()))}),this.isNewData?(n.lineList.push({data:e}),this.isNewData=!1):n.lineList[n.lineList.length-1].data=e}else{n=new r(this.OpAnnotation,this.annotationType,this.OpAnnotation.style,this.getUnitString());var t=this.getModelCenter(),t=(n.worldMatrix=(new THREE.Matrix4D).makeTranslation(t),n.worldMatrixInvert=n.worldMatrix.clone().invert(),n.pointList.push({point:new THREE.Vector3,pointDiv:null},{point:new THREE.Vector3,pointDiv:null},{point:new THREE.Vector3,pointDiv:null},{point:new THREE.Vector3,pointDiv:null},{point:new THREE.Vector3,pointDiv:null},{point:new THREE.Vector3,pointDiv:null},{point:new THREE.Vector3,pointDiv:null}),new THREE.Vector3(this.selectObjectList[0].x,this.selectObjectList[0].y,0));n.instanceMatrix=(new THREE.Matrix4D).makeTranslation(t.clone().applyMatrix4(n.worldMatrixInvert.clone())),n.lineList=[];let e=[];this.selectObjectList.forEach(t=>{t=new THREE.Vector3(t.x,t.y,0);e.push(t.clone().applyMatrix4(n.worldMatrixInvert).applyMatrix4(n.instanceMatrix.clone().invert()))}),n.lineList.push({data:e}),super.createAnnotationResult(n),this.isNewData=!1}this.viewer.dispatchEvent({type:"MeasureDataLength",data:{length:n.lineList.length||0,type:n.type,mainType:"annotation",isShowButton:!0}}),this.OpAnnotation.annotationNeedAddList=!0,this.updateAnnotationResultLine(n,!1,!0),this.OpAnnotation.rootObject.add(n.group)}}var y=NDSWebViewer.NDS;class w extends a{constructor(t){super(t),this.annotationClass="cloudLine",this.maxSelectCount=1,this.isNewData=!0}OperatorStart(t){this.annotationType=t,this.OpAnnotation.PostInfo(y.ANNOTATIONTYPE.ANNOTATIONLINE)}getPostInfo(){let t=y.ANNOTATIONTYPE.NONE;return t=(this.OpAnnotation.annotationNeedAddList||this.selectObjectList.length,y.ANNOTATIONTYPE.ANNOTATIONLINE)}getCurAllowType(){return["point"]}addSelectObjectToList(t){return!0}createAnnotationResult(){if(!(this.selectObjectList.length<2)){let n;if(this.OpAnnotation.unsteadyUUid){n=this.OpAnnotation.getAnnotationResult(this.OpAnnotation.unsteadyUUid);let e=[];this.selectObjectList.forEach(t=>{t=new THREE.Vector3(t.x,t.y,t.z);e.push(t.clone().applyMatrix4(n.worldMatrixInvert).applyMatrix4(n.instanceMatrix.clone().invert()))}),n.lineList[n.lineList.length-1].data=e,n.updateTextDashLine(!1),this.updateAnnotationResultCloudLine(n,!1,!0)}else{n=new r(this.OpAnnotation,this.annotationType,this.OpAnnotation.style,this.getUnitString());var t=this.getModelCenter(),t=(n.worldMatrix=(new THREE.Matrix4D).makeTranslation(t),n.worldMatrixInvert=n.worldMatrix.clone().invert(),n.pointList.push({point:new THREE.Vector3,pointDiv:null},{point:new THREE.Vector3,pointDiv:null},{point:new THREE.Vector3,pointDiv:null},{point:new THREE.Vector3,pointDiv:null},{point:new THREE.Vector3,pointDiv:null},{point:new THREE.Vector3,pointDiv:null},{point:new THREE.Vector3,pointDiv:null}),new THREE.Vector3(this.selectObjectList[0].x,this.selectObjectList[0].y,0));n.instanceMatrix=(new THREE.Matrix4D).makeTranslation(t.clone().applyMatrix4(n.worldMatrixInvert.clone())),n.lineList=[];let e=[];this.selectObjectList.forEach(t=>{t=new THREE.Vector3(t.x,t.y,0);e.push(t.clone().applyMatrix4(n.worldMatrixInvert).applyMatrix4(n.instanceMatrix.clone().invert()))}),n.lineList.push({data:e}),super.createAnnotationResult(n),this.isNewData=!1,this.OpAnnotation.annotationNeedAddList=!0,this.updateAnnotationResultCloudLine(n,!1,!0),this.OpAnnotation.rootObject.add(n.group)}}}finishAnnotationCloudLine(){if(this.OpAnnotation.unsteadyUUid){let t=this.OpAnnotation.unsteadyUUid;this.OpAnnotation.addAnnotationResult(t,!0),super.delAllSelectObjectList(),setTimeout(()=>{this.OpAnnotation.selAnnotationResult(t),this.OpAnnotation.PostInfo(y.ANNOTATIONTYPE.ANNOTATIONSAVE)},100)}}}var x=NDSWebViewer.NDS;class A extends a{constructor(t){super(t),this.annotationClass="annotation2Pt",this.maxSelectCount=1,this.isNewData=!0}OperatorStart(t){"newLine2Pt"==(this.annotationType=t)?this.OpAnnotation.PostInfo(x.ANNOTATIONTYPE.ANNOSTLINE):this.OpAnnotation.PostInfo(x.ANNOTATIONTYPE.ANNOARROWS)}getPostInfo(){let t=x.ANNOTATIONTYPE.NONE;return t="newLine2Pt"==this.annotationType?x.ANNOTATIONTYPE.ANNOSTLINE:x.ANNOTATIONTYPE.ANNOARROWS}getCurAllowType(){return["point"]}addSelectObjectToList(t){return!0}createAnnotationResult(){let n;if(this.OpAnnotation.unsteadyUUid){n=this.OpAnnotation.getAnnotationResult(this.OpAnnotation.unsteadyUUid);let e=[];this.selectObjectList.forEach(t=>{t=new THREE.Vector3(t.x,t.y,t.z);e.push(t.clone().applyMatrix4(n.worldMatrixInvert).applyMatrix4(n.instanceMatrix.clone().invert()))}),n.lineList[n.lineList.length-1].data=e,n.updateTextDashLine(!1),this.updateAnnotationResult2Pt(n,!1,!0)}else{n=new r(this.OpAnnotation,this.annotationType,this.OpAnnotation.style,this.getUnitString());var t=this.getModelCenter(),t=(n.worldMatrix=(new THREE.Matrix4D).makeTranslation(t),n.worldMatrixInvert=n.worldMatrix.clone().invert(),n.pointList.push({point:new THREE.Vector3,pointDiv:null},{point:new THREE.Vector3,pointDiv:null},{point:new THREE.Vector3,pointDiv:null},{point:new THREE.Vector3,pointDiv:null}),new THREE.Vector3(this.selectObjectList[0].x,this.selectObjectList[0].y,0));n.instanceMatrix=(new THREE.Matrix4D).makeTranslation(t.clone().applyMatrix4(n.worldMatrixInvert.clone())),n.lineList=[];let e=[];this.selectObjectList.forEach(t=>{t=new THREE.Vector3(t.x,t.y,t.z);e.push(t.clone().applyMatrix4(n.worldMatrixInvert).applyMatrix4(n.instanceMatrix.clone().invert()))}),n.lineList.push({data:e}),super.createAnnotationResult(n),this.OpAnnotation.annotationNeedAddList=!0,this.updateAnnotationResult2Pt(n,!1,!0),this.OpAnnotation.rootObject.add(n.group)}}finishAnnotation2Pt(){if(this.OpAnnotation.unsteadyUUid){let t=this.OpAnnotation.unsteadyUUid;this.OpAnnotation.addAnnotationResult(t,!0),super.delAllSelectObjectList(),setTimeout(()=>{this.OpAnnotation.selAnnotationResult(t),this.OpAnnotation.PostInfo(x.ANNOTATIONTYPE.ANNOTATIONSAVE)},100)}}}var g=NDSWebViewer.NDS;class R extends a{constructor(t){super(t),this.annotationClass="newCircle",this.maxSelectCount=1,this.isNewData=!0}OperatorStart(t){this.annotationType=t;let e="";e="newCircle"==this.annotationType?g.ANNOTATIONTYPE.ANNOCIRCLE:g.ANNOTATIONTYPE.ANNORECTANGLE,this.OpAnnotation.PostInfo(e)}getPostInfo(){let t=g.ANNOTATIONTYPE.NONE;return t="newCircle"==this.annotationType?g.ANNOTATIONTYPE.ANNOCIRCLE:g.ANNOTATIONTYPE.ANNORECTANGLE}getCurAllowType(){}addSelectObjectToList(t){return!0}createAnnotationResult(){let n;if(this.OpAnnotation.unsteadyUUid){n=this.OpAnnotation.getAnnotationResult(this.OpAnnotation.unsteadyUUid);let e=[];this.selectObjectList.forEach(t=>{t=new THREE.Vector3(t.x,t.y,t.z);e.push(t.clone().applyMatrix4(n.worldMatrixInvert).applyMatrix4(n.instanceMatrix.clone().invert()))}),n.lineList[n.lineList.length-1].data=e}else{n=new r(this.OpAnnotation,this.annotationType,this.OpAnnotation.style,this.getUnitString());var t=this.getModelCenter(),t=(n.worldMatrix=(new THREE.Matrix4D).makeTranslation(t),n.worldMatrixInvert=n.worldMatrix.clone().invert(),n.pointList.push({point:new THREE.Vector3,pointDiv:null},{point:new THREE.Vector3,pointDiv:null},{point:new THREE.Vector3,pointDiv:null},{point:new THREE.Vector3,pointDiv:null},{point:new THREE.Vector3,pointDiv:null},{point:new THREE.Vector3,pointDiv:null},{point:new THREE.Vector3,pointDiv:null},{point:new THREE.Vector3,pointDiv:null},{point:new THREE.Vector3,pointDiv:null},{point:new THREE.Vector3,pointDiv:null},{point:new THREE.Vector3,pointDiv:null}),new THREE.Vector3(this.selectObjectList[0].x,this.selectObjectList[0].y,0));n.instanceMatrix=(new THREE.Matrix4D).makeTranslation(t.clone().applyMatrix4(n.worldMatrixInvert.clone())),n.lineList=[];let e=[];this.selectObjectList.forEach(t=>{t=new THREE.Vector3(t.x,t.y,0);e.push(t.clone().applyMatrix4(n.worldMatrixInvert).applyMatrix4(n.instanceMatrix.clone().invert()))}),n.lineList.push({data:e}),this.isNewData=!1,super.createAnnotationResult(n)}this.OpAnnotation.annotationNeedAddList=!0,"newCircle"==n.type?this.updateAnnotationResultCircle(n,!1,!0):this.updateAnnotationResultRectangle(n,!1,!0),this.OpAnnotation.rootObject.add(n.group)}finishResetCircleData(){if(this.OpAnnotation.unsteadyUUid){let t=this.OpAnnotation.unsteadyUUid;var e=this.OpAnnotation.getAnnotationResult(t);"newCircle"==e.type?this.updateAnnotationResultCircle(e,!1,!1):this.updateAnnotationResultRectangle(e,!1,!1),this.OpAnnotation.addAnnotationResult(t,!0),super.delAllSelectObjectList(),setTimeout(()=>{this.OpAnnotation.selAnnotationResult(t),this.OpAnnotation.PostInfo(g.ANNOTATIONTYPE.ANNOTATIONSAVE)},100)}}}var m=NDSWebViewer.NDS;class O extends a{constructor(t){super(t),this.annotationClass="leadLine",this.maxSelectCount=2,this.isNewData=!0}OperatorStart(t){this.annotationType=t,this.OpAnnotation.PostInfo(m.ANNOTATIONTYPE.ANNOTATIONTAGLINE)}getPostInfo(){let t=m.ANNOTATIONTYPE.NONE;return t=this.OpAnnotation.annotationNeedAddList||this.selectObjectList.length<2?m.ANNOTATIONTYPE.ANNOTATIONTAGLINE:t}getCurAllowType(){return["point"]}addSelectObjectToList(t){return!0}createAnnotationResult(){if(!(this.selectObjectList.length<2)){let i;if(this.OpAnnotation.unsteadyUUid){i=this.OpAnnotation.getAnnotationResult(this.OpAnnotation.unsteadyUUid);var t=new THREE.Vector3(this.selectObjectList[1].x,this.selectObjectList[1].y,0);i.instanceMatrix=(new THREE.Matrix4D).makeTranslation(t.clone().applyMatrix4(i.worldMatrixInvert.clone())),i.lineList=[];let n=[];this.selectObjectList.forEach((t,e)=>{t=new THREE.Vector3(t.x,t.y,0);0==e?n.push(t.clone().applyMatrix4(i.worldMatrixInvert)):n.push(t.clone().applyMatrix4(i.worldMatrixInvert).applyMatrix4(i.instanceMatrix.clone().invert()))}),i.pointList[6].point=n[0].clone(),i.lineList.push({data:n}),i.updateTextDashLine(!1),this.updateAnnotationResultLeadLine(i,!1,!0)}else{i=new r(this.OpAnnotation,this.annotationType,this.OpAnnotation.style,this.getUnitString());t=this.getModelCenter(),t=(i.worldMatrix=(new THREE.Matrix4D).makeTranslation(t),i.worldMatrixInvert=i.worldMatrix.clone().invert(),i.pointList.push({point:new THREE.Vector3,pointDiv:null},{point:new THREE.Vector3,pointDiv:null},{point:new THREE.Vector3,pointDiv:null},{point:new THREE.Vector3,pointDiv:null},{point:new THREE.Vector3,pointDiv:null},{point:new THREE.Vector3,pointDiv:null},{point:new THREE.Vector3,pointDiv:null}),new THREE.Vector3(this.selectObjectList[1].x,this.selectObjectList[1].y,0));i.instanceMatrix=(new THREE.Matrix4D).makeTranslation(t.clone().applyMatrix4(i.worldMatrixInvert.clone())),i.lineList=[];let n=[];this.selectObjectList.forEach((t,e)=>{t=new THREE.Vector3(t.x,t.y,0);0==e?n.push(t.clone().applyMatrix4(i.worldMatrixInvert)):n.push(t.clone().applyMatrix4(i.worldMatrixInvert).applyMatrix4(i.instanceMatrix.clone().invert()))}),i.pointList[6].point=n[0].clone(),i.lineList.push({data:n}),super.createAnnotationResult(i),this.isNewData=!1,this.OpAnnotation.taglineSave=!1,this.OpAnnotation.annotationNeedAddList=!0,this.updateAnnotationResultLeadLine(i,!1,!0),this.OpAnnotation.rootObject.add(i.group)}}}}class L{constructor(){this.charMap=new Map,this.materialMap=new Map,this.texture=null,this.curHeight=0,this.curWidth=0,this.fontSize=130,this.mapSize=4096,this.textCanvas=document.createElement("canvas"),this.textCanvas.width=this.mapSize,this.textCanvas.height=this.mapSize,this.context=this.textCanvas.getContext("2d"),this.context.font="normal normal normal 128px ",this.context.textAlign="center",this.context.textBaseline="middle",this.context.fillStyle="#000000";var e="0123456789XYSCR:=cminchfet";for(let t=0;t<e.length;t++){var n=e[t];this.getUVFromCharmap(n,!1,!1,1)}}getUVFromCharmap(n,i,o,a){o=n+`_${i?"1":"0"}_${o?"1":"0"}_`+(a||"0");if(this.charMap.has(o))return this.charMap.get(o);{var r=this.context.measureText(n);let t=0;r.actualBoundingBoxAscent>this.fontSize/2&&(t=r.actualBoundingBoxAscent-this.fontSize/2);var r=r.width+this.fontSize*Math.sin(30/180),s=i?0:-this.fontSize*Math.sin(28/180);let e=0;r+this.curWidth>this.mapSize&&(this.curHeight+=this.fontSize*(1+Math.sin(30/180)),this.curWidth=0),this.context.fillText(n,this.curWidth+r/2,this.curHeight+this.fontSize/2+t,r);n=i?this.fontSize*Math.sin(40/180):this.fontSize*Math.sin(10/180),i=(2==a&&(e=this.fontSize*Math.sin(20/180)),[parseFloat((this.curWidth-n)/this.mapSize),parseFloat(1-(this.curHeight+e+this.fontSize)/this.mapSize),parseFloat((this.curWidth+s+r+n)/this.mapSize),parseFloat(1-this.curHeight/this.mapSize)]);return this.charMap.set(o,i),this.curWidth+=r+2*n,this.texture&&(this.texture.needsUpdate=!0),i}}createGeomFormText(t,o,e,n){let a=0,i=0,r=0,s=0;var l=t.length+(n?n.length:0);let c=[6*l],p=20,h=new Float32Array(l*p),d=this;function u(e){for(let t=0;t<e.length;t++){var n=e[t],n=d.getUVFromCharmap(n),i=(n[2]-n[0])/(n[3]-n[1])*o;h[s*p]=a,h[s*p+1]=r,h[s*p+2]=0,h[s*p+3]=n[0],h[s*p+4]=n[1],h[s*p+5]=a+i,h[s*p+6]=r,h[s*p+7]=0,h[s*p+8]=n[2],h[s*p+9]=n[1],h[s*p+10]=a,h[s*p+11]=r+o,h[s*p+12]=0,h[s*p+13]=n[0],h[s*p+14]=n[3],h[s*p+15]=a+i,h[s*p+16]=r+o,h[s*p+17]=0,h[s*p+18]=n[2],h[s*p+19]=n[3],c[6*s]=4*s,c[6*s+1]=4*s+1,c[6*s+2]=4*s+2,c[6*s+3]=4*s+1,c[6*s+4]=4*s+3,c[6*s+5]=4*s+2,a+=i,s++}}t&&u(t),n&&(i=a,a=0,r=-o,u(n));l=this.createMaterial(e),t=new THREE.BufferGeometry,n=new THREE.InterleavedBuffer(h,5);return t.setAttribute("position",new THREE.InterleavedBufferAttribute(n,3,0,!1)),t.setAttribute("uv",new THREE.InterleavedBufferAttribute(n,2,3,!1)),t.setIndex(c),[i>a?i:a,t,l]}createGeomFormNewText(t,o,a){o=parseFloat(o),this.context.font=`${a.isItalic?"italic":"normal"} normal ${a.isBold?"600":"normal"} 128px `+(1==a.fontFamily?"":2==a.fontFamily?"":"");let n=[],r=0,i,s=0,l=0,e,c,p=(t?(e=t.split("\n"),c=0,e.forEach(t=>{c=(t?t.length:0)+c})):(e=[" "],c=1),[6*c]),h=20,d=new Float32Array(c*h),u=this;function E(e){for(let t=0;t<e.length;t++){var n=e[t],n=u.getUVFromCharmap(n,a.isItalic,a.isBold,a.fontFamily),i=(n[2]-n[0])/(n[3]-n[1])*o;d[l*h]=r,d[l*h+1]=s,d[l*h+2]=0,d[l*h+3]=n[0],d[l*h+4]=n[1],d[l*h+5]=r+i,d[l*h+6]=s,d[l*h+7]=0,d[l*h+8]=n[2],d[l*h+9]=n[1],d[l*h+10]=r,d[l*h+11]=s+o,d[l*h+12]=0,d[l*h+13]=n[0],d[l*h+14]=n[3],d[l*h+15]=r+i,d[l*h+16]=s+o,d[l*h+17]=0,d[l*h+18]=n[2],d[l*h+19]=n[3],p[6*l]=4*l,p[6*l+1]=4*l+1,p[6*l+2]=4*l+2,p[6*l+3]=4*l+1,p[6*l+4]=4*l+3,p[6*l+5]=4*l+2,r+=i,l++}}e.forEach((t,e)=>{t&&(0!=e&&(i=r,r=0,s-=1.1*o),E(t),n.push(r))});var t=this.createMaterial(a.color),T=new THREE.BufferGeometry,y=new THREE.InterleavedBuffer(d,5),y=(T.setAttribute("position",new THREE.InterleavedBufferAttribute(y,3,0,!1)),T.setAttribute("uv",new THREE.InterleavedBufferAttribute(y,2,3,!1)),T.setIndex(p),Math.max(...n));return[y,T,t,n.length-1]}createMaterial(t){var e;return null==this.texture&&(this.texture=new THREE.Texture(this.textCanvas),this.texture.magFilter=THREE.LinearFilter,this.texture.minFilter=THREE.NearestFilter,this.texture.generateMipmaps=!1,this.texture.needsUpdate=!0),this.materialMap.has(t)?this.materialMap.get(t):(e=new THREE.ShaderMaterial({uniforms:{diffuse:{value:(new THREE.Color).setHex(t,THREE.SRGBColorSpace)},map:{value:this.texture}},fragmentShader:`
                uniform vec3 diffuse;
                uniform sampler2D map;
                varying vec2 vUv;
                void main() {
                    vec4 texel = texture2D(map, vUv);
                    vec4 diffuseColor = vec4( diffuse, texel.a );
                    if(texel.a < 0.5f){
                        discard;
                    }
                    //#include <logdepthbuf_fragment>
                    #include <color_fragment>
        
                    gl_FragColor = vec4( diffuseColor.rgb, 1.0 );
        
                    #include <tonemapping_fragment>
                    #include <encodings_fragment>
                    #include <fog_fragment>
                    #include <premultiplied_alpha_fragment>
                }
                `,vertexShader:`
                varying vec2 vUv;
                void main() {
                    vUv = uv;
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                }
                `,transparent:!0,depthTest:!1,depthWrite:!1,side:THREE.DoubleSide,premultipliedAlpha:!0,alphaTest:.5}),this.materialMap.set(t,e),e)}}function f(t){v.call(this,t);var s=this;this.type="OpAnnotation2DPC",this.AnnotationOper=new a(this),this.annotationType="",this.MeaCharImpl=new L,!this.viewer.hasBrepInfo()&&this.viewer.hasBrepFile()?this.viewer.loadBrepInfo(!1):this.viewer.dispatchEvent({type:"BrepInfoEvent"}),this.annotationDataList=[],this.annotationNeedAddList=!1,this.annotationDataSelected=!1,this.isInSelected=!1,this.annotationInChange=!1,this.hideOperateButtonList=[],this.unsteady=!1,this.unsteadyUUid=null,this.unsteadyRef=0,this.unsteadyMPoint=-1,this.unsteadyTextBox=null,this.unsteadyMoving=!1,this.taglineSave=!1,this.eventFirstPoint=null,this.clockwise={inited:!1,clockwise:!0},this.longClick=0,this.lineType=1,this.connectType=1,this.debounceStop=!1,this.handLinePointList=[],this.lineNum=0,this.prompt=document.getElementById("anno_prompt"),this.prompt||(this.prompt=document.createElement("div"),this.prompt.id="anno_prompt",this.prompt.className="pc-alert",this.prompt.style.display="none",this.viewer.container.appendChild(this.prompt)),this.circlePointList=[],this.circleNum=0,this.startRet=[0,0],this.endRet=[0,0],this.circleCaptureFlag=!1,this.debounceTouchSinglemove2=((e,n,i)=>{let o=!0,a=!0,r=s;return function(){var t=arguments;if(n.apply(r,t),o&&(o=!1,setTimeout(function(){o=!0},i),a)){a=!1;try{e.apply(r,t)}catch(t){a=!0,console.error(t)}a=!0}}})(function(){var t,e;this.debounceStop||(t=this.pointer.x,e=this.pointer.y,1==this.longClick&&(e-=this.mouseZoomStepArrow),this.AnnotationOper.onNMouseMove(t,e))},function(){this.render(!0),this.AnnotationOper.isTwoTopolInfoTheSame(this.AnnotationOper.preSelInfoOld,this.AnnotationOper.preSelInfo)||(this.imageData=null,this.AnnotationOper.preSelInfoOld=(t=>{var e,n={};for(e in t)n[e]=t[e];return n})(this.AnnotationOper.preSelInfo))},80),this.rootObject=new THREE.Object3D,this.scene=new THREE.Scene,this.scene.add(this.rootObject),this.mouseZoomBufCanvas=document.createElement("canvas"),this.mouseZoomArea=!1,this.mouseZoomBgImg=null,this.mouseZoomWidth=140,this.mouseZoomHeight=184,this.mouseZoomStep=40,this.mouseZoomStepArrow=50,this.dpr=window.devicePixelRatio,this.enbaleSelPtType=!0,this.modelCenters=null,this.annoMinScale=1,this.annoMaxScale=1,this.annoScale=1,this.maxPrecision=8,this.precision=2,this.precisionType=1,this.modelUnit=this.getUnitStringmap(this.viewer.modelUnit),this.curUnit=this.modelUnit,this.materialMap=new Map,this.style={fontFamily:1,fontSacleType:1,fontSize:18,isItalic:!1,color:1540323,isBold:!1,lineWidth:1},this.defaultFontSize=18,this.CONST_PNTDIV_WIDTH=33,this.CONST_DELDIV_WIDTH=20,this.CONST_TXTDIV_WIDTH=20,this.Z_DIRECTION=new THREE.Vector3(0,0,1),this.Y_DIRECTION=(new THREE.Vector3).copy(this.viewer.camera.up),this.X_DIRECTION=(new THREE.Vector3).crossVectors(this.Y_DIRECTION,this.Z_DIRECTION),this.Y_ORG_DIR=(new THREE.Vector3).fromArray(this.viewer.cameraInfoFile.up),this.X_ORG_DIR=(new THREE.Vector3).crossVectors(this.Y_ORG_DIR,this.Z_DIRECTION),this.ndsWebClipper=null,this.ndsWebClipperLoad=!1;let o=this;this.imgDivTouchStart=function(t){var e;this.parentElement&&(o.longClick=1,o.unsteady=!0,o.unsteadyUUid=this.getAttribute("annotationUUid"),o.unsteadyRef=parseInt(this.getAttribute("annotationRef")),o.unsteadyMPoint=parseInt(this.getAttribute("annotationPoint")),o.unsteadyTextBox=this,o.unsteadyMoving=!1,o.startPoint=t.touches?[t.touches[0].clientX,t.touches[0].clientY]:[t.clientX,t.clientY],o.eventFirstPoint=[o.startPoint[0],o.startPoint[1]],o.AnnotationOper.selDivRef=o.unsteadyRef,0<o.unsteadyRef&&("newArrow2Pt"!=(e=o.getAnnotationResult(o.unsteadyUUid)).type&&"newLine2Pt"!=e.type||5!=o.unsteadyRef?99==o.unsteadyRef?e.hideOtherDiv(7):e.hideOtherDiv(o.unsteadyRef):e.hideOtherDiv(3)),t.preventDefault(),o.touchStartTime=Date.now(),document.addEventListener("mouseup",o.imgDivTouchEnd,!1))},this.imgDivTouchEnd=function(t){if(o.unsteadyRef||0===o.unsteadyRef){if((o.longClick=0)<o.unsteadyRef&&((n=o.getAnnotationResult(o.unsteadyUUid)).showOtherDiv(),n.clearCaptureGroup()),-1==o.unsteadyRef&&o.unsteadyUUid&&o.viewer.dispatchEvent({type:"AnnotationDelUUid",data:{uuid:o.unsteadyUUid}}),-2==o.unsteadyRef&&o.unsteadyUUid){var n=o.getAnnotationResult(o.unsteadyUUid);if(n.deletePointImgDiv(),"newText"==n.type||"tagLine"==n.type){var i=n.pointList[0].point.clone().applyMatrix4(n.instanceMatrix.clone()).applyMatrix4(n.worldMatrix.clone());let t=o.get2dPoint(i.clone()),e=o.viewer.renderer.getPixelRatio();setTimeout(()=>{o.AnnotationOper.updateCameraPosition([t.x/e,t.y/e],[.4,.5])},500)}o.PostInfo(""),"newText"==n.type||"tagLine"==n.type?o.viewer.dispatchEvent({type:"AnnotationEditUUid",data:{uuid:o.unsteadyUUid}}):"newLine"==n.type&&((o.annotationType="newLine")!=o.AnnotationOper.annotationClass&&(o.AnnotationOper=new T(o)),n.textDashLine.visible=!1,o.viewer.dispatchEvent({type:"MeasureDataLength",data:{length:n.lineList.length||0,type:n.type,mainType:"annotation",isShowButton:!0}})),o.annotationInChange=!0,o.annotationDataSelected=!1}0<o.unsteadyMPoint&&(o.render(),clearTimeout(o.timeOutEvent),o.timeOutEvent=0,o.longClick=0,o.debounceStop=!0,o.AnnotationOper.delPreSelectObj()),o.unsteady=!1,o.unsteadyRef=null,o.unsteadyMPoint=-1,o.unsteadyMoving=!1,o.startPoint=null,o.eventFirstPoint=null,o.clockwise.inited=!1,o.AnnotationOper.cleanRotationHelper(),o.AnnotationOper.selDivRef=null,t.preventDefault(),document.removeEventListener("mouseup",o.imgDivTouchEnd,!1)}},this.imgDivTouchMove=function(t){var e,n,i;o.unsteadyRef<0||(e=t.touches?[t.touches[0].clientX,t.touches[0].clientY]:[t.clientX,t.clientY],i=o.startPoint,n=1.1*window.devicePixelRatio,e&&i&&(Math.abs(e[0]-i[0])>n||Math.abs(e[1]-i[1])>n)&&(o.startPoint=e,o.unsteadyTextBox=this,o.unsteadyMoving=!0,i=document.createEvent("HTMLEvents"),S.isMobileDevice()?(i.initEvent("touchmove",!0,!0),i.touches=t.touches,i.force=!0,1==t.touches.length&&(o.state=D.TOUCH.TOUCH_SINGLE)):(i.initEvent("mousemove",!0,!0),0===t.button&&(o.state=D.MOUSE.NONE),i.offsetX=t.offsetX,i.clientX=t.clientX,i.offsetY=t.offsetY,i.clientY=t.clientY),(o.viewer.canvas2D||o.viewer.canvas3D).dispatchEvent(i),t.preventDefault()))},this.addTouchEvent=function(t){S.isMobileDevice()?(t.addEventListener("touchstart",this.imgDivTouchStart,!1),t.addEventListener("touchend",this.imgDivTouchEnd,!1),t.addEventListener("touchmove",this.imgDivTouchMove,!1)):(t.addEventListener("mousedown",this.imgDivTouchStart,!1),t.addEventListener("mouseup",this.imgDivTouchEnd,!1),t.addEventListener("mousemove",this.imgDivTouchMove,!1))},this.delTouchEvent=function(t){S.isMobileDevice()?(t.removeEventListener("touchstart",this.imgDivTouchStart,!1),t.removeEventListener("touchend",this.imgDivTouchEnd,!1),t.removeEventListener("touchmove",this.imgDivTouchMoves,!1)):(t.removeEventListener("mousedown",this.imgDivTouchStart,!1),t.removeEventListener("mouseup",this.imgDivTouchEnd,!1),t.removeEventListener("mousemove",this.imgDivTouchMoves,!1))},this.superOnMouseWheel=this.onMouseWheel,this.onMouseWheel=function(t){"OpAnnotation2DPC"===o.viewer.getCurrentOperatorID()&&o.superOnMouseWheel(t),clearTimeout(o.timeOutEvent),o.timeOutEvent=0,o.longClick=0,o.updateSelectAnnotationResult(!0)},this.render()}var v=NDSWebViewer.OpBase,N=NDSWebViewer.SETTING,S=NDSWebViewer.COMMON,D=NDSWebViewer.NDS;(f.prototype=Object.create(v.prototype)).release=function(t){var e=this.viewer.renderer.getPixelRatio();this.viewer.canvas2D.getContext("2d").clearRect(0,0,window.innerWidth*e,window.innerHeight*e),this.viewer.selectionManager.clearSelection(),this.update(),this.render(!0),t&&v.prototype.release.call(this)},f.prototype.updateCurXYDir=function(){this.Y_DIRECTION=(new THREE.Vector3).copy(this.viewer.camera.up),this.X_DIRECTION=(new THREE.Vector3).crossVectors(this.Y_DIRECTION,this.Z_DIRECTION)},f.prototype.showOther=function(){0<this.unsteadyRef&&this.unsteadyUUid&&this.getAnnotationResult(this.unsteadyUUid).hideOtherDiv(this.unsteadyRef)},f.prototype.clearFlag=function(){},f.prototype.loadBrepEnd=function(){this.loadCircleCenter(100)},f.prototype.getAnnotationVisible=function(){return!!this.rootObject&&this.rootObject.visible},f.prototype.setAnnotationVisible=function(t){this.rootObject&&(this.rootObject.visible=t)},f.prototype.setAnnotationVisibleByUUid=function(t,e){t=this.getAnnotationResult(t);t&&(t.group.visible=e,t.isHide=!e)},f.prototype.setAnnotationTextStr=function(t,e){t=this.getAnnotationResult(t);t&&(t.textString=e,this.AnnotationOper.updateAnnotationResultImpl(t,!1,!0)),this.render(!0)},f.prototype.commitAnnotationText=function(e,t){this.addAnnotationResult(e,!0),this.AnnotationOper.delAllSelectObjectList(),setTimeout(()=>{this.selAnnotationResult(e);var t=D.ANNOTATIONTYPE.ANNOTATIONSAVE;this.PostInfo(t)},100)},f.prototype.commitTagLineResult=function(t){this.viewer.dispatchEvent({type:"annotationAddText",data:{uuid:t}}),this.taglineSave=!0,this.PostInfo(""),this.AnnotationOper.selectObjectList=[]},f.prototype.getAnnotationData=function(t){t=this.getAnnotationResult(t);if(t)return t.toContent()},f.prototype.getAnnotationDataArray=function(e){var n=[];for(let t=0;t<e.length;t++){var i=this.getAnnotationResult(e[t]);i&&n.push(i.toContent())}return n},f.prototype.getAllAnnotationData=function(){let e=[];return this.annotationDataList.forEach(function(t){t.isUnsteady||e.push(t.toContent())}),e},f.prototype.setAnnotationData=function(i,t){let o=this;setTimeout(async()=>{for(let t=0;t<i.length;t++){var e=i[t],n=new r(o,e.state.origiType,e.state.style,e.state.unit);n.fromContent(e),o.viewer.ConfigNum!==n.configNum||(o.AnnotationOper.updateAnnotationResultImpl(n,!1,!1),n.updateTextDashLine(!1),o.rootObject.add(n.group)),o.annotationDataList.push(n)}o.render(!0)},10)},f.prototype.selectAndZoom=function(t,e,n){var i=this.viewer.getExtension("Measure2DAPPExtension"),i=i&&i.hasStaticType();this.AnnotationOper.annotationType||i||v.prototype.selectAndZoom.call(this,t,e,n)},f.prototype.getAnnotationResult=function(e){for(let t=0;t<this.annotationDataList.length;t++)if(this.annotationDataList[t].uuid==e)return this.annotationDataList[t]},f.prototype.getTagLineStyle=function(t){return(t||this.unsteadyUUid)&&(t=this.getAnnotationResult(t||this.unsteadyUUid))?{lineType:t.lineType,connectType:t.connectType}:{lineType:this.lineType,connectType:this.connectType}},f.prototype.setTagLineStyle=function(t,e){t||this.unsteadyUUid?(t=this.getAnnotationResult(t||this.unsteadyUUid))&&(t.updateTagLineStyle(e),this.AnnotationOper.updateAnnotationResultImpl(t,!0,!0),this.render(!0)):(this.lineType=e&&e.lineType||1,this.connectType=e&&e.connectType||1)},f.prototype.setAnnotationStyle=function(t,e,n){t||this.unsteadyUUid?(t=this.getAnnotationResult(t||this.unsteadyUUid))&&(t.updateStyle(e,t,n),this.AnnotationOper.updateAnnotationResultImpl(t,!0,!0),this.render(!0)):(this.style.fontFamily=e.fontFamily,this.style.fontSacleType=e.fontSacleType,this.style.fontSize=2==e.fontSacleType?e.fontSize:this.defaultFontSize,this.style.isItalic=e.isItalic,this.style.color=e.color,this.style.isBold=e.isBold,this.style.lineWidth=e.lineWidth)},f.prototype.addAnnotationResult=function(t){t=this.getAnnotationResult(t);this.annotationNeedAddList=!1,this.annotationDataSelected=!1,this.annotationInChange=!1,this.unsteadyUUid=null,t&&(t.setUnsteady(!1),this.AnnotationOper.updateAnnotationResultImpl(t,!1,!1,!0),t.setFinal(),t.deletePointImgDiv(),t.updateTextDashLine(!1),this.PostInfo(this.AnnotationOper.getPostInfo())),this.render(!0),this.viewer.dispatchEvent({type:"AddAnnotationFinish",data:{uuid:t.uuid}})},f.prototype.delAnnotationData=function(n,t){var i=this.getAnnotationResult(n);if(i){i.deletePointImgDiv(),i.clearLeaderGroup(),i.group&&this.rootObject.remove(i.group);let e=-1;for(let t=0;t<this.annotationDataList.length;t++)if(this.annotationDataList[t].uuid==n){e=t;break}-1<e&&this.annotationDataList.splice(e,1)}this.annotationDataSelected=!1,this.annotationNeedAddList=!1,this.unsteadyUUid=null,this.AnnotationOper.selectObjectList=[],this.PostInfo(this.AnnotationOper.getPostInfo()),this.render(!0)},f.prototype.selAnnotationResult=function(t){var e;return!(this.rootObject&&!this.rootObject.visible)&&"OpZoomWindow"!=this.viewer.getCurrentOperatorID()&&void((e=this.getAnnotationResult(t))&&e.group.visible&&(e.updateTextDashLine(!0),"newLine"==e.type&&(e.textDashLine.visible=!0),this.viewer.setOperatorByID("OpAnnotation2DPC"),this.annotationDataSelected=!0,this.annotationInChange=!1,this.unsteadyUUid=t,this.AnnotationOper.updateAnnotationResultImpl(e),e.createPointImgDiv(),this.render(!0),this.viewer.dispatchEvent({type:"selAnnotation",data:{uuid:e.uuid}})))},f.prototype.deSelAnnotationResult=function(t){t=this.getAnnotationResult(t);t&&this.annotationDataSelected&&(this.annotationDataSelected=!1,this.AnnotationOper.updateAnnotationResultImpl(t),t.deletePointImgDiv(),t.updateTextDashLine(!1),this.render(!0))},f.prototype.getAnnotationPrecision=function(){return this.precision},f.prototype.setAnnotationPrecision=function(t,e){if(this.precision=t,!e){let e=[];for(let t=0;t<this.annotationDataList.length;t++){var n=this.annotationDataList[t];this.viewer.ConfigNum==n.configNum&&(this.AnnotationOper.updateAnnotationResultImpl(n),e.push(n.uuid))}this.render(!0),setTimeout(()=>{this.viewer.dispatchEvent({type:"revampScale",data:{uuids:e}})},200)}},f.prototype.getAnnotationPrecisionType=function(){return this.precisionType},f.prototype.setAnnotationPrecisionType=function(t,e){if(this.precisionType=t,!e){let e=[];for(let t=0;t<this.annotationDataList.length;t++){var n=this.annotationDataList[t];this.viewer.ConfigNum==n.configNum&&(this.AnnotationOper.updateAnnotationResultImpl(n),e.push(n.uuid))}this.render(!0),setTimeout(()=>{this.viewer.dispatchEvent({type:"revampScale",data:{uuids:e}})},200)}},f.prototype.getAnnotationUnit=function(){return this.curUnit},f.prototype.setAnnotationUnit=function(t,e){if(this.curUnit=t||this.modelUnit,!e){let e=[];for(let t=0;t<this.annotationDataList.length;t++){var n=this.annotationDataList[t];this.viewer.ConfigNum==n.configNum&&(this.AnnotationOper.updateAnnotationResultImpl(n),e.push(n.uuid))}this.render(!0),setTimeout(()=>{this.viewer.dispatchEvent({type:"revampScale",data:{uuids:e}})},200)}},f.prototype.getAnnotationAnnoScale=function(){return this.annoScale},f.prototype.setAnnotationAnnoScale=function(t,e,n){if(this.annoMinScale=t||1,this.annoMaxScale=e||1,this.annoScale=this.annoMaxScale/this.annoMinScale,n)return!1;let i=[];for(let t=0;t<this.annotationDataList.length;t++){var o=this.annotationDataList[t];this.viewer.ConfigNum==o.configNum&&(this.AnnotationOper.updateAnnotationResultImpl(o),i.push(o.uuid))}this.render(!0),setTimeout(()=>{this.viewer.dispatchEvent({type:"revampScale",data:{uuids:i}})},200)},f.prototype.getAnnotationStyle=function(t){return t?(t=this.getAnnotationResult(t))?t.getStyle(t):void 0:{fontFamily:this.style.fontFamily,fontSize:this.style.fontSize,fontSacleType:this.style.fontSacleType,isItalic:this.style.isItalic,color:this.style.color,isBold:this.style.isBold,lineWidth:this.style.lineWidth,isBlack:0==parseInt(this.viewer.clearColor)}},f.prototype.PostInfo=function(t){let e="";if((this.InfoType=t)||(this.prompt.innerHTML="",this.prompt.style.display="none"),S.isMobileDevice())switch(t){case D.ANNOTATIONTYPE.ANNOTATIONPT:e=S.translateString("NDS_ANNOTATIONTYPE_ANNOTATIONPT");break;case D.ANNOTATIONTYPE.ANNOTATIONSAVE:e=S.translateString("NDS_ANNOTATIONTYPE_ANNOTATIONSAVE");break;case D.ANNOTATIONTYPE.ANNOTATIONLINE:e="cloudLine"==this.annotationType?S.translateString("NDS_ANNOTATIONTYPE_ANNOCLOUDLINE"):S.translateString("NDS_ANNOTATIONTYPE_ANNOFREEHANDLINE");break;case D.ANNOTATIONTYPE.ANNOTATIONCIRCLE:e=S.translateString("NDS_ANNOTATIONTYPE_ANNOTATIONCIRCLE");break;case D.ANNOTATIONTYPE.ANNOCIRCLE:e=S.translateString("NDS_ANNOTATIONTYPE_ANNOCIRCLE");break;case D.ANNOTATIONTYPE.ANNORECTANGLE:e=S.translateString("NDS_ANNOTATIONTYPE_ANNORECTANGLE");break;case D.ANNOTATIONTYPE.ANNOSTLINE:e=S.translateString("NDS_ANNOTATIONTYPE_ANNOSTLINE");break;case D.ANNOTATIONTYPE.ANNOARROWS:e=S.translateString("NDS_ANNOTATIONTYPE_ANNOARROWS");break;case D.ANNOTATIONTYPE.ANNOTATIONTAGLINE:e=S.translateString("NDS_ANNOTATIONTYPE_ANNOTATIONTAGLINE")}else{if(!this.prompt)return;switch(this.prompt.removeAttribute("height"),this.prompt.style.height="",t){case D.ANNOTATIONTYPE.ANNOTATIONPT:e=S.translateString("NDS_ANNOTATIONTYPE_ANNOTATIONPT");break;case D.ANNOTATIONTYPE.ANNOTATIONSAVE:e=S.translateString("NDS_ANNOTATIONTYPE_ANNOTATIONSAVE");break;case D.ANNOTATIONTYPE.ANNOTATIONLINE:e="cloudLine"==this.annotationType?S.translateString("NDS_ANNOTATIONTYPE_ANNOCLOUDLINE"):S.translateString("NDS_ANNOTATIONTYPE_ANNOFREEHANDLINE");break;case D.ANNOTATIONTYPE.ANNOTATIONCIRCLE:e=S.translateString("NDS_ANNOTATIONTYPE_ANNOTATIONCIRCLE");break;case D.ANNOTATIONTYPE.ANNOCIRCLE:e=S.translateString("NDS_ANNOTATIONTYPE_ANNOCIRCLE");break;case D.ANNOTATIONTYPE.ANNORECTANGLE:e=S.translateString("NDS_ANNOTATIONTYPE_ANNORECTANGLE");break;case D.ANNOTATIONTYPE.ANNOSTLINE:e=S.translateString("NDS_ANNOTATIONTYPE_ANNOSTLINE");break;case D.ANNOTATIONTYPE.ANNOARROWS:e=S.translateString("NDS_ANNOTATIONTYPE_ANNOARROWS");break;case D.ANNOTATIONTYPE.ANNOTATIONTAGLINE:e=S.translateString("NDS_ANNOTATIONTYPE_ANNOTATIONTAGLINE")}e&&(this.prompt.innerHTML=e,this.prompt.style.display="block",t>D.ANNOTATIONTYPE.ANNOTATIONNOTICEBEGIN?this.prompt.style.color="#ff7d2c":this.prompt.style.color="rgba(51,51,51,1)",this.prompt.style.fontSize="12px")}this.viewer.dispatchEvent({type:"MeasureTips",msg:e,color:t<D.ANNOTATIONTYPE.ANNOTATIONNOTICEBEGIN?"#3BA0FF":"#FF8D1A"})},f.prototype.setBackGroundColor=function(t){let i=this;function e(t,e,n){"text"==t.objectType&&t.material?t.material=i.MeaCharImpl.createMaterial(n):null!=t.objectType&&"text_dashline"!=t.objectType&&t.material?t.material.color&&t.material.color.getHex(THREE.SRGBColorSpace)==e&&(e=t.material.uniforms?t.material.uniforms.linewidth.value:"",t.material=i.AnnotationOper.getColorFromMap(n,e)):("text_dashline"==t.objectType&&t.material||"anno_point"==t.objectType&&t.material)&&t.material.color.setHex(n,THREE.SRGBColorSpace)}let n=16777215;"#000000"==t?(this.annotationDataList.forEach(function(t){0==t.style.color&&t.group.traverse(function(t){e(t,0,n)}),t.style.color==n&&t.group.traverse(function(t){e(t,0,n)})}),0==this.style.color&&(this.style.color=n)):(this.annotationDataList.forEach(function(t){t.style.color==n&&t.group.traverse(function(t){e(t,n,0)}),0==t.style.color&&t.group.traverse(function(t){e(t,n,0)})}),this.style.color==n&&(this.style.color=0))},f.prototype.render=function(t=!1){this.viewer&&this.viewer.controls&&this.viewer.controls.dispatchEvent({type:"render",forceRenderAll:t})},f.prototype.onNMouseMove=function(t){v.prototype.onNMouseMove.call(this,t);var t=this.AnnotationOper.getViewClientCoords(t),e=t.x,t=t.y;this.prompt&&!S.isMobileDevice()&&(this.InfoType?this.prompt.style.display="block":this.prompt.style.display="none",this.prompt.style.left=e+5+"px",this.prompt.style.top=t+7+"px"),this.unsteady?(e=this.pointer.x,t=this.pointer.y,this.AnnotationOper.onNMouseMove(e,t),this.render(!0)):this.AnnotationOper.onNMouseMove(e,t)},f.prototype.onLMouseClick=function(t){v.prototype.onLMouseClick.call(this,t),t.preventDefault();var e=this.AnnotationOper.getViewClientCoords(t);this.click=!0,this.AnnotationOper.onLMouseClick(e.x,e.y,t.ctrlKey),this.render(!0)},f.prototype.onLMouseDbClick=function(t){v.prototype.onLMouseDbClick.call(this,t)},f.prototype.onLMouseDown=function(t){v.prototype.onLMouseDown.call(this,t);var e=this;this.longClick=0,N.inBIMContext||""==this.annotationType||(this.timeOutEvent=setTimeout(function(){e.longClick=1},0)),this.touchStartTime=Date.now(),this.startRet=this.viewer.clientCoordToModelCoord([this.pointer.x,this.pointer.y]),"newCircle"!=this.annotationType&&"newRectangle"!=this.annotationType||this.annotationDataSelected||(this.AnnotationOper.selectObjectList=[],this.AnnotationOper.onCirclePointMove(new THREE.Vector3(this.startRet[0],this.startRet[1],0)))},f.prototype.onLMouseMove=function(t){var e=Date.now()-this.touchStartTime,n=this.viewer.clientCoordToModelCoord([this.pointer.x,this.pointer.y]),i=(this.endRet=this.viewer.clientCoordToModelCoord([this.pointer.x,this.pointer.y]),this.handLinePointList[this.lineNum]||(this.handLinePointList[this.lineNum]=[]),this.AnnotationOper.getViewClientCoords(t)),o=i.x,i=i.y;this.prompt&&!S.isMobileDevice()&&(this.InfoType?this.prompt.style.display="block":this.prompt.style.display="none",this.prompt.style.left=o+5+"px",this.prompt.style.top=i+7+"px"),e<100&&(3<Math.abs(this.pointer.x-this.singleTouchStartPos.x)||3<Math.abs(this.pointer.y-this.singleTouchStartPos.y))&&(clearTimeout(this.timeOutEvent),this.timeOutEvent=0),Math.abs(this.pointer.x-this.singleTouchStartPos.x)<3||Math.abs(this.pointer.y-this.singleTouchStartPos.y)<3||(0==this.longClick&&!this.unsteady&&(3<Math.abs(this.pointer.x-this.singleTouchStartPos.x)||3<Math.abs(this.pointer.y-this.singleTouchStartPos.y))&&"tagLine"==this.annotationType&&0<this.AnnotationOper.selectObjectList.length&&this.AnnotationOper.onTagLinePointMove(new THREE.Vector3(n[0],n[1],0).clone()),1==this.longClick&&!this.unsteady&&(3<Math.abs(this.pointer.x-this.singleTouchStartPos.x)||3<Math.abs(this.pointer.y-this.singleTouchStartPos.y))?"newLine"!=this.annotationType||this.annotationDataSelected?"cloudLine"!=this.annotationType||this.annotationDataSelected?"newCircle"!=this.annotationType&&"newRectangle"!=this.annotationType||this.annotationDataSelected?"newLine2Pt"!=this.annotationType&&"newArrow2Pt"!=this.annotationType||this.annotationDataSelected||(e=new THREE.Vector3(n[0],n[1],0),this.AnnotationOper.on2PtPointMove(e.clone())):this.AnnotationOper.onCirclePointMove(new THREE.Vector3(n[0],n[1],0)):(e=new THREE.Vector3(n[0],n[1],0),this.AnnotationOper.onCloudLinePointMove(e.clone())):(e=new THREE.Vector3(n[0],n[1],0),this.AnnotationOper.onLinePointMove(e.clone())):1==this.longClick?this.unsteady?(o=this.pointer.x,i=this.pointer.y,this.AnnotationOper.onNMouseMove(o,i)):v.prototype.onLMouseMove.call(this,t):this.debounceStop=!1)},f.prototype.onLMouseUp=function(t){t.preventDefault(),this.unsteadyRef&&this.imgDivTouchEnd(t),1==this.longClick&&("newLine"!=this.annotationType||this.annotationDataSelected?"newCircle"!=this.annotationType&&"newRectangle"!=this.annotationType||this.annotationDataSelected?"cloudLine"!=this.annotationType||this.annotationDataSelected?"newLine2Pt"!=this.annotationType&&"newArrow2Pt"!=this.annotationType||this.annotationDataSelected||this.AnnotationOper.finishAnnotation2Pt():this.AnnotationOper.finishAnnotationCloudLine():this.AnnotationOper.finishResetCircleData():this.AnnotationOper.onResetLineData()),this.AnnotationOper.delPreSelectObj(),clearTimeout(this.timeOutEvent),this.timeOutEvent=0,this.longClick=0,this.debounceStop=!0,this.lineNum++},f.prototype.onTouchSingleStart=function(t){v.prototype.onTouchSingleStart.call(this,t);var e=this;this.longClick=0,N.inBIMContext||""==this.annotationType||(this.timeOutEvent=setTimeout(function(){e.longClick=1},100)),this.touchStartTime=Date.now(),this.startRet=this.viewer.clientCoordToModelCoord([this.pointer.x,this.pointer.y]),"newCircle"!=this.annotationType&&"newRectangle"!=this.annotationType||this.annotationDataSelected||(this.AnnotationOper.selectObjectList=[],this.AnnotationOper.onCirclePointMove(new THREE.Vector3(this.startRet[0],this.startRet[1],0)))},f.prototype.onTouchSingleMove=function(t){var e=Date.now()-this.touchStartTime,n=this.viewer.clientCoordToModelCoord([this.pointer.x,this.pointer.y]);this.endRet=this.viewer.clientCoordToModelCoord([this.pointer.x,this.pointer.y]),this.handLinePointList[this.lineNum]||(this.handLinePointList[this.lineNum]=[]),e<100&&(3<Math.abs(this.pointer.x-this.singleTouchStartPos.x)||3<Math.abs(this.pointer.y-this.singleTouchStartPos.y))&&(clearTimeout(this.timeOutEvent),this.timeOutEvent=0),Math.abs(this.pointer.x-this.singleTouchStartPos.x)<3||Math.abs(this.pointer.y-this.singleTouchStartPos.y)<3||(!this.unsteady&&(3<Math.abs(this.pointer.x-this.singleTouchStartPos.x)||3<Math.abs(this.pointer.y-this.singleTouchStartPos.y))&&("newLine"!=this.annotationType||this.annotationDataSelected?"cloudLine"!=this.annotationType||this.annotationDataSelected?"newCircle"!=this.annotationType&&"newRectangle"!=this.annotationType||this.annotationDataSelected?"newLine2Pt"!=this.annotationType&&"newArrow2Pt"!=this.annotationType||this.annotationDataSelected||(e=new THREE.Vector3(n[0],n[1],0),this.AnnotationOper.on2PtPointMove(e.clone())):this.AnnotationOper.onCirclePointMove(new THREE.Vector3(n[0],n[1],0)):(e=new THREE.Vector3(n[0],n[1],0),this.AnnotationOper.onCloudLinePointMove(e.clone())):(e=new THREE.Vector3(n[0],n[1],0),this.AnnotationOper.onLinePointMove(e.clone()))),1==this.longClick?this.unsteady?(n=this.pointer.x,e=this.pointer.y,this.AnnotationOper.onNMouseMove(n,e)):v.prototype.onTouchSingleMove.call(this,t):this.debounceStop=!1)},f.prototype.onTouchSingleEnd=function(t){t.preventDefault();var t=this.singleTouchEndPos.x,e=this.singleTouchEndPos.y,n=Date.now()-this.touchStartTime;"newLine"!=this.annotationType||this.annotationDataSelected?"newCircle"!=this.annotationType&&"newRectangle"!=this.annotationType||this.annotationDataSelected?"cloudLine"!=this.annotationType||this.annotationDataSelected?"newLine2Pt"!=this.annotationType&&"newArrow2Pt"!=this.annotationType||this.annotationDataSelected?(0==this.longClick||n<100||""==this.annotationType||Math.abs(this.singleTouchStartPos.x-this.singleTouchEndPos.x)<3&&Math.abs(this.singleTouchStartPos.y-this.singleTouchEndPos.y)<3)&&(this.AnnotationOper.onLMouseClick(t,e,!1),this.render()):this.AnnotationOper.finishAnnotation2Pt():this.AnnotationOper.finishAnnotationCloudLine():this.AnnotationOper.finishResetCircleData():this.AnnotationOper.onResetLineData(),this.AnnotationOper.delPreSelectObj(),clearTimeout(this.timeOutEvent),this.timeOutEvent=0,this.longClick=0,this.debounceStop=!0,this.lineNum++},f.prototype.onTouchDoubleStart=function(t){t.preventDefault(),v.prototype.onTouchDoubleStart.call(this,t),clearTimeout(this.timeOutEvent),this.timeOutEvent=0,this.longClick=0},f.prototype.onTouchDoubleMove=function(t){v.prototype.onTouchDoubleMove.call(this,t),clearTimeout(this.timeOutEvent),this.timeOutEvent=0,this.longClick=0,this.updateSelectAnnotationResult()},f.prototype.onTouchDoubleEnd=function(t){t.preventDefault(),v.prototype.onTouchDoubleEnd.call(this,t),clearTimeout(this.timeOutEvent),this.timeOutEvent=0,this.longClick=0},f.prototype.onRMouseMove=function(t){var e,n;"OpAnnotation2DPC"===this.viewer.getCurrentOperatorID()&&(e=(n=this.AnnotationOper.getViewClientCoords(t)).x,n=n.y,this.prompt&&!S.isMobileDevice()&&(this.InfoType?this.prompt.style.display="block":this.prompt.style.display="none",this.prompt.style.left=e+5+"px",this.prompt.style.top=n+7+"px"),v.prototype.onRMouseMove.call(this,t))},f.prototype.updateSelectAnnotationResult=function(t){var e;this.unsteadyUUid&&(this.annotationNeedAddList||this.annotationDataSelected)&&(e=this.getAnnotationResult(this.unsteadyUUid))&&this.AnnotationOper.updateAnnotationResultImpl(e,!1,!1,!1,t)},f.prototype.setAnnotationType=function(t){switch(this.annotationInChange=!1,this.annotationType=t,N.enableBroadcast&&!N.broadcastMajor&&this.viewer.dispatchEvent({type:"FaceSelectionChangeEvent"}),this.viewer.selectionManager.clearSelection(),this.viewer.onOpChanged({id:"annotationType"}),this.AnnotationOper.OperatorEnd(),this.unsteadyUUid&&(this.unsteadyUUid=null),this.annotationType){case"newText":"newText"!=this.AnnotationOper.annotationClass&&(this.AnnotationOper=new p(this));break;case"newLine":"newLine"!=this.AnnotationOper.annotationClass&&(this.AnnotationOper=new T(this));break;case"cloudLine":"cloudLine"!=this.AnnotationOper.annotationClass&&(this.AnnotationOper=new w(this));break;case"newCircle":case"newRectangle":"newCircle"!=this.AnnotationOper.annotationClass&&(this.AnnotationOper=new R(this));break;case"newLine2Pt":case"newArrow2Pt":"annotation2Pt"!=this.AnnotationOper.annotationClass&&(this.AnnotationOper=new A(this));break;case"tagLine":"leadLine"!=this.AnnotationOper.annotationClass&&(this.AnnotationOper=new O(this));break;default:"Base"!=this.AnnotationOper.annotationClass&&(this.AnnotationOper=new a(this))}this.updateCurXYDir(),"Base"!=this.AnnotationOper.annotationClass&&!this.viewer.hasBrepInfo()&&this.viewer.hasBrepFile()?this.PostInfo(D.ANNOTATIONTYPE.LOADDATE):this.AnnotationOper.OperatorStart(this.annotationType),this.unsteadyUUid="",this.prompt&&!S.isMobileDevice()&&(this.prompt.style.display="none"),"newLine"==this.annotationType?this.viewer.dispatchEvent({type:"MeasureDataLength",data:{length:0,type:this.annotationType,mainType:"annotation",isShowButton:!0}}):this.viewer.dispatchEvent({type:"MeasureDataLength",data:{length:0,type:this.annotationType,mainType:"annotation",isShowButton:!1}}),this.render()},f.prototype.renderExtensionScene=function(){if(this.scene){null!=this.rootObject&&this.renderScale(this.rootObject),this.rootObject.visible&&this.viewer.renderer.render(this.scene,this.viewer.camera),this.AnnotationOper.renderAnnotationScene();for(let t=0;t<this.annotationDataList.length;t++)this.annotationDataList[t].updatePointDiv()}},f.prototype.setPointScale=function(t,e){e=this.getScale(t,e);t.scale.x=e,t.scale.y=e,t.scale.z=e,t.updateMatrixWorld()},f.prototype.setCylinderScale=function(t,e){S.isMobileDevice()&&(e*=1.5);e=this.getScale(t,e);t.scale.x=e,t.scale.y=e,t.scale.z=e,t.oldPosition&&t.offsetPos&&t.position.addVectors(t.oldPosition,t.offsetPos.clone().multiplyScalar(e)),t.updateMatrixWorld()},f.prototype.setResolution=function(t){var e=this.viewer.renderer.getPixelRatio(),n=this.viewer.renderer.domElement.width/e,e=this.viewer.renderer.domElement.height/e;t.material.resolution.set(n,e)},f.prototype.getScale=function(t,e){var n=5,e=(null!=e&&(n=e),this.viewer.camera.getCameraTarget()),i=this.viewer.camera.position,o=new THREE.Vector3,e=(o.subVectors(e,i),t.position.clone()),t=this.viewer.camera.isPerspective?e.sub(i).dot(o.normalize()):o.length(),e=this.viewer.camera.fov,i=2*t*Math.tan(THREE.Math.degToRad(.5*e)),o=this.viewer.renderer.domElement.height;return n*i*this.viewer.renderer.getPixelRatio()/o},f.prototype.renderScale=function(t){for(var e=0;e<t.children.length;e++){var n=t.children[e];if(null!=n.objectType)switch(n.objectType){case"Point":this.setPointScale(n,this.AnnotationOper.POINTSIZE);break;case"Cylinder":this.setCylinderScale(n,this.AnnotationOper.CYLINDERWIDTH);break;case"Group":this.renderScale(n);break;case"Line2":case"SelLine":case"annoLine":this.setResolution(n)}}},f.prototype.getUnitStringmap=function(t){var e="mm";if(t)switch(t.toLowerCase()){case"meter":e="m";break;case"centimeter":e="cm";break;case"millimeter":e="mm";break;case"inch":e="in";break;case"feet":e="ft"}return e},f.prototype.get2dPoint=function(t){t.project(this.viewer.camera);var e=this.viewer.renderer.domElement.width/2,n=this.viewer.renderer.domElement.height/2;return{x:Math.round(t.x*e+e),y:Math.round(-t.y*n+n)}},f.prototype.lastStepContinuous=function(t){this.AnnotationOper.lastStepContinuous(),this.render(!0)},f.prototype.continuousAccomplish=function(){this.AnnotationOper.continuousAccomplish(),this.render(!0)},f.prototype.setLinearannotation=function(t){var e=this.getAnnotationResult(this.unsteadyUUid);"Lineargauge"==e.type&&(e.linearDirection="standard"==t?"x":"y",this.AnnotationOper.updateAnnotationResultImpl(e),this.AnnotationOper.OpAnnotation.render(!0))},f.prototype.loadNDSClipper=function(n){if(null==this.ndsWebClipper&&0==this.ndsWebClipperLoad){let e=this;e.ndsWebClipperLoad=!0,NDSWebClipper().then(t=>{e.ndsWebClipper=t,console.log("NDSWebCilpper load success"),n&&n()}).catch(function(t){console.log("NDSWebCilpper load failed!"),e.ndsWebClipper=null,e.ndsWebClipperLoad=!1,n&&n()})}},f.prototype.loadCircleCenter=function(t){},f.prototype.moveCameraTo=function(t){t=this.getAnnotationResult(t);if(t){let n=new THREE.Box3;t.group.traverse(function(t){var e;t.hasOwnProperty("geometry")&&t.hasOwnProperty("material")&&(t.geometry.boundingBox||t.geometry.computeBoundingBox(),(e=t.geometry.boundingBox.clone()).applyMatrix4(t.matrixWorld),n.union(e))});var t=new THREE.Vector3,e=(n.getCenter(t),1.5*(Math.max(n.max.x-n.min.x,n.max.y-n.min.y)+4)),i=this.viewer.renderer.domElement,i=e*i.height/i.width/2,o=new THREE.Vector3,i=(o.set(t.x,t.y-i/2,t.z),this.viewer.camera.target.clone().sub(this.viewer.camera.position).normalize()),t=(i.multiplyScalar(e),o.clone().sub(i));this.viewer.camera.position.set(t.x,t.y,t.z),this.viewer.camera.setCameraTarget(o),this.viewer.camera.updateProjectionMatrix(),this.viewer.camera.updateMatrixWorld(!0),this.viewer.render()}},console.log("NDS ExtensionFramework V0.1"),NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM,NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM,NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM,NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM,NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM;class b extends NDSWebViewer.Extension{constructor(){super()}onLoad(t){}onInitLights(){}update(t){}setFlags(t){super.setFlags(t)}onNdsModelPrepareForRendering(t){}onBeforeNdsModelUpdate(t,e){}onAfterNdsModelUpdate(t,e){}onBeforeNdsModelSetRender(t,e){}onAfterNdsModelSetRender(t,e){}onBeforeNdsMeshRender(t,e){}onBeforeScreenCapture(t){}onAfterScreenCapture(){}onBeforeChangeBackGroundColor(t){}onAfterChangeBackGroundColor(t){}onAfterWindowResize(t,e,n){}onSetCaptureView(t,e){}getExtensionWithFlags(t){return NDSWebViewer.ExtensionManager.getExtensionWithFlags(t)}resetToDefault(){}needDisableInputEvent(){}getStoreInfo(t){throw this.name+" Extesion did not implement method 'getStoreInfo' "}setStoreInfo(t){throw this.name+" Extesion did not implement method 'setStoreInfo' "}getBodyTransform(t){return new THREE.Matrix4}getBodyNodeTranslate(t){return new THREE.Vector3(0,0,0)}}class H extends b{constructor(){super(),this.name="Annotation2DPCExtension",console.log("NDSAnnotation2DPCEx v1.1.2"),this.staticAnnotation2D=null,this.hideOperateButtonList=[],this.setOperatorByID=t=>{if("OpAnnotation2DPC"===t){if(null===this.staticAnnotation2D){this.staticAnnotation2D=new f(this.viewer),this.staticAnnotation2D.hideOperateButtonList=this.hideOperateButtonList;let e=this;this.viewer.registOperator(t,function(t){return e.staticAnnotation2D})}this.viewer.setOperatorByID(t)}},this.setAnnotationOpVisible=t=>{this.staticAnnotation2D&&this.staticAnnotation2D.setAnnotationVisible(t),this.viewer.render(!0)},this.setAnnotationOpType=t=>{this.staticAnnotation2D&&this.staticAnnotation2D.setAnnotationType(t)},this.setAnnotationOpTextStr=(t,e)=>{this.staticAnnotation2D&&this.staticAnnotation2D.setAnnotationTextStr(t,e)},this.getAnnotationOpData=t=>{if(this.staticAnnotation2D)return this.staticAnnotation2D.getAnnotationData(t)},this.deSelAnnotationOpResult=t=>{this.staticAnnotation2D&&this.staticAnnotation2D.deSelAnnotationResult(t)},this.commitAnnotationOpText=(t,e)=>{this.staticAnnotation2D&&this.staticAnnotation2D.commitAnnotationText(t,e)},this.delAnnotationOpData=(t,e)=>{this.staticAnnotation2D&&this.staticAnnotation2D.delAnnotationData(t,e)},this.lastStepContinuous=()=>{this.staticAnnotation2D&&this.staticAnnotation2D.lastStepContinuous()},this.continuousAccomplish=()=>{this.staticAnnotation2D&&this.staticAnnotation2D.continuousAccomplish()},this.getAnnotationStyle=t=>{if(this.staticAnnotation2D)return this.staticAnnotation2D.getAnnotationStyle(t)},this.setAnnotationStyle=(t,e,n)=>{this.staticAnnotation2D&&this.staticAnnotation2D.setAnnotationStyle(t,e,n)},this.setAnnotationOpData=t=>{this.staticAnnotation2D&&this.staticAnnotation2D.setAnnotationData(t)},this.releaseOpAnnotation=()=>{this.staticAnnotation2D&&(this.staticAnnotation2D.release(!0),this.staticAnnotation2D=null,this.viewer.render())},this.onAfterChangeBackGroundColor=t=>{this.staticAnnotation2D&&this.staticAnnotation2D.setBackGroundColor(t)},this.hasSelected=()=>!!this.staticAnnotation2D&&(this.staticAnnotation2D.isInSelected||this.staticAnnotation2D.annotationDataSelected),this.hasStaticType=()=>{if(this.staticAnnotation2D)return this.staticAnnotation2D.annotationType},this.getTagLineStyle=t=>{if(this.staticAnnotation2D)return this.staticAnnotation2D.getTagLineStyle(t)},this.setTagLineStyle=(t,e)=>{this.staticAnnotation2D&&this.staticAnnotation2D.setTagLineStyle(t,e)},this.setHideOperateButtonList=t=>{this.hideOperateButtonList=t}}onLoad(t){this.viewer=t}onAfterCopyPassRender(){this.staticAnnotation2D&&this.staticAnnotation2D.renderExtensionScene()}}let I=new H;NDSWebViewer.ExtensionManager.addExtension(I)}],i={},o.m=n,o.c=i,o.d=function(t,e,n){o.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},o.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)o.d(n,i,function(t){return e[t]}.bind(null,i));return n},o.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return o.d(e,"a",e),e},o.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},o.p="",o(o.s=0);function o(t){var e;return(i[t]||(e=i[t]={i:t,l:!1,exports:{}},n[t].call(e.exports,e,e.exports,o),e.l=!0,e)).exports}var n,i});