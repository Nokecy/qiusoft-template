# 表格单元格编辑功能使用说明

## 功能概述

表格单元格编辑功能允许用户通过双击表格单元格来编辑其内容、样式和合并设置。已集成到打印模板设计器中。

## 核心功能

### 1. 单元格双击编辑

- **触发方式**: 在设计器中选中表格元素后，双击任意单元格
- **限制**: 只有未被合并的单元格才可双击编辑（被合并的单元格会被跳过）

### 2. 内容绑定

支持三种绑定模式：

#### 静态值模式 (BindingMode.Static = 0)
- 直接输入固定文本内容
- 适用于不需要动态数据的场景

#### 数据路径模式 (BindingMode.DataPath = 1)
- 绑定到数据源的特定字段
- 示例: `item.name`, `order.customer.name`
- 支持多级路径访问

#### 表达式模式 (BindingMode.Expression = 2)
- 使用 Scriban 表达式进行动态计算
- 示例: `upper(item.name)`, `item.quantity * item.price`
- 支持函数调用和复杂计算

### 3. 单元格合并

- **行合并 (rowSpan)**: 设置合并的行数（1-最大可用行数）
- **列合并 (colSpan)**: 设置合并的列数（1-最大可用列数）
- 合并后，被覆盖的单元格会自动标记为 `merged: true`
- 取消合并时，被覆盖的单元格会自动恢复为 `merged: false`

### 4. 单元格样式

#### 文本样式
- **字体大小**: 6-72 pt
- **字体**: Arial, 宋体, 黑体, 微软雅黑, Courier New
- **粗体**: 是/否
- **斜体**: 是/否

#### 颜色设置
- **文本颜色**: 支持颜色选择器
- **背景颜色**: 支持颜色选择器

#### 对齐方式
- **水平对齐**: 左对齐(0), 居中(1), 右对齐(2), 两端对齐(3)
- **垂直对齐**: 顶部(0), 居中(1), 底部(2)

#### 格式化
- **format**: 可选，用于格式化输出（如日期格式：yyyy-MM-dd）

## 技术实现

### 组件结构

```
Canvas (主画布组件)
  ├── useCellEdit Hook (单元格编辑状态管理)
  ├── ElementRenderer (元素渲染器)
  │   └── TableElement (表格元素)
  │       └── Cell (可点击的单元格)
  └── CellEditModal (单元格编辑对话框)
```

### 核心文件

1. **CellEditModal.tsx** - 单元格编辑对话框组件
   - 位置: `Canvas/components/CellEditModal.tsx`
   - 功能: 提供单元格编辑 UI

2. **useCellEdit.ts** - 单元格编辑 Hook
   - 位置: `Canvas/hooks/useCellEdit.ts`
   - 功能: 管理编辑状态和数据更新

3. **TableElement.tsx** - 表格元素渲染器（已增强）
   - 位置: `Canvas/components/ElementRenderer/TableElement.tsx`
   - 功能: 渲染表格并支持单元格双击编辑、悬停效果

### 数据结构扩展

单元格数据结构 (TableCell) 已扩展支持以下属性：

```typescript
interface TableCell {
  // 原有属性
  content?: string;
  contentBinding?: PropertyBinding;
  rowSpan: number;
  colSpan: number;
  merged: boolean;

  // 扩展属性（样式）
  backgroundColor?: string;      // 背景颜色
  textColor?: string;            // 文本颜色
  fontSize?: number;             // 字体大小
  fontFamily?: string;           // 字体
  bold?: boolean;                // 粗体
  italic?: boolean;              // 斜体
  textAlign?: TextAlignment;     // 水平对齐
  verticalAlign?: VerticalAlignment; // 垂直对齐
}
```

## 用户交互流程

1. **选中表格**: 在画布中点击表格元素，表格被选中（蓝色边框）
2. **双击单元格**: 双击表格中的任意单元格
3. **编辑对话框**: 自动弹出编辑对话框，显示当前单元格的信息
4. **修改设置**:
   - 修改内容绑定方式和值
   - 调整行列合并
   - 设置文本样式和颜色
   - 设置对齐方式
5. **保存**: 点击"确定"保存修改
6. **取消**: 点击"取消"放弃修改

## 视觉反馈

### 未选中表格
- 单元格正常显示
- 鼠标指针为默认样式

### 选中表格
- 单元格鼠标悬停时显示浅蓝色背景高亮
- 鼠标指针变为 pointer（手型）
- 提示用户可以双击编辑

### 编辑对话框
- 模态对话框，宽度 600px
- 标题显示单元格位置（行号, 列号）
- 表单布局，分组清晰

## 性能优化

1. **深拷贝优化**: 使用 `JSON.parse(JSON.stringify())` 确保数据不可变性
2. **条件渲染**: 只在表格选中时显示悬停效果和双击响应
3. **事件委托**: 使用 `stopPropagation()` 防止事件冒泡
4. **按需渲染**: 对话框使用 `destroyOnClose` 优化性能

## 未来扩展

可能的功能增强方向：

1. **批量编辑**: 支持选中多个单元格批量设置样式
2. **样式复制**: 支持复制单元格样式到其他单元格
3. **边框设置**: 单独设置单元格边框样式
4. **内边距设置**: 单独设置单元格内边距
5. **单元格公式**: 支持类似 Excel 的单元格公式
6. **撤销/重做**: 集成到设计器的撤销/重做系统

## 注意事项

1. **合并冲突**: 当设置合并时，确保不会与其他已合并的单元格冲突
2. **数据绑定**: 使用数据路径或表达式时，确保数据源中存在对应字段
3. **格式化字符串**: format 字段仅在运行时渲染时生效，设计时不显示格式化结果
4. **样式优先级**: 单元格级别的样式优先于表格级别的字体配置
5. **被合并单元格**: 被合并的单元格（merged: true）不会显示内容，也不能被双击编辑

## 故障排查

### 单元格无法双击编辑
- 检查表格是否被选中（蓝色边框）
- 检查单元格是否被合并（merged: true）
- 检查是否在交互模式下（interactive: true）

### 合并设置无效
- 检查 maxRowSpan 和 maxColSpan 计算是否正确
- 检查是否超出表格边界
- 检查是否与其他合并单元格冲突

### 样式不生效
- 检查样式属性拼写是否正确
- 检查颜色格式是否正确（应为十六进制）
- 检查是否被表格级别样式覆盖

## 测试建议

1. **基础功能测试**:
   - 双击单元格弹出编辑框
   - 修改内容并保存
   - 取消编辑不改变数据

2. **合并功能测试**:
   - 单行合并
   - 单列合并
   - 多行多列合并
   - 取消合并恢复

3. **样式测试**:
   - 各种字体大小和字体
   - 各种颜色
   - 各种对齐方式组合

4. **边界测试**:
   - 最大行列合并
   - 表格边缘单元格
   - 空内容保存

5. **数据绑定测试**:
   - 静态值模式
   - 数据路径模式
   - 表达式模式
   - 格式化输出
