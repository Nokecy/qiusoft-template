!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.AnnotationExtension=t():e.AnnotationExtension=t()}(window,function(){return i=[function(e,t,i){i.r(t);console.log("NDS ExtensionFramework V0.1");let r={FLAG_ENABLE_NODE_TRANSFORM:NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM,FLAG_ENABLE_NODE_STOREVIEW:NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM<<1,FLAG_ENABLE_NODE_CAMERA2D:NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM<<2,FLAG_ENABLE_NODE_BLOCK:NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM<<3,FLAG_ENABLE_NODE_TEXT:NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM<<4,FLAG_ENABLE_NODE_BROADCAST:NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM<<5};class o extends NDSWebViewer.Extension{constructor(){super()}onLoad(e){}onInitLights(){}update(e){}setFlags(e){super.setFlags(e)}onNdsModelPrepareForRendering(e){}onBeforeNdsModelUpdate(e,t){}onAfterNdsModelUpdate(e,t){}onBeforeNdsModelSetRender(e,t){}onAfterNdsModelSetRender(e,t){}onBeforeNdsMeshRender(e,t){}onAfterWindowsResize(e,t,i){}getExtensionWithFlags(e){return NDSWebViewer.ExtensionManager.getExtensionWithFlags(e)}resetToDefault(){}getStoreInfo(e){throw this.name+" Extesion did not implement method 'getStoreInfo' "}setStoreInfo(e){throw this.name+" Extesion did not implement method 'setStoreInfo' "}getBodyTransform(e){return new THREE.Matrix4}getBodyNodeTranslate(e){return new THREE.Vector3(0,0,0)}}class R{static getModel(e){return e.ndsModel}static getUUID(e){return e.uuid}static getObjectId(e){return e.objectid}static getId(e){return e.id}static getBodyNodeMaterial(e){var t=e.getMaterialBodyNodeUUid();return t&&e.useBodyNodeMaterial?e.ndsModel.bodyNodeUUidToMaterial[t]:null}static setBodyNodeMaterial(e,t){e.ndsModel.bodyNodeUUidToMaterial[e.uuid]=t,e.useBodyNodeMaterial=!!t}static getUserMaterial(e){return e.getUserMaterial()}static setUserMaterial(e,t){e.setUserMaterial(t)}static getBoundingBox(e){var t=new THREE.Box3;return e.getBoundingBox(t,!0)}static isLeafBodyNode(e){return!!e.leafBodyAttri}static isPartBodyNode(e){return"Part"===e.type}static getLeafBodyNodes(e){return e.ndsModel.getLeafBodies(e)}static getMeshesInLeafBodyNode(e){return e.leafBodyAttri?e.leafBodyAttri.bodyMeshIds:[]}static getMatrixLocal(e){return e.matrix}static getMatrixWorld(e){return e.worldMatrix}static setMatrixWorld(e,t){e.setMatrixWorld(t)}static applyTransform(e,t=null){e.applyTransform(t)}static updateMatrixWorld(e,t=!1){e.updateMatrixWorld(t,!0)}static hide(e){e.hide(e)}static show(e){e.show()}static isPreSelected(e){return e.isPreSelected()}static isSelected(e){return e.isSelected()}static isTransparent(e){return e.isTransparent()}static isHidden(e){return e.isHidden()}static isIsolated(e){return e.isIsolated()}static getRenderMode(e){switch(e.renderMode){case 3:return"wireframe";case 4:return"hiddenLineRemove";case 5:return"hiddenLineVisible"}return""}static getBodyNodeTranslate(e,i){var o=new THREE.Vector3(0,0,0),n=e.getExtensionWithFlags(r.FLAG_ENABLE_NODE_TRANSFORM);for(let e=0,t=n.length;e<t;++e)o.add(n[e].getBodyNodeTranslate(i));return o}static updateNodeMatrix(e,t){e.ndsModel.updateNodeMatrix(e.uuid,t,e.getModel().id)}static hideBody(e){e.ndsModel.hideBody(e)}static showBody(e){e.ndsModel.showBody(e)}}class n{constructor(e){this.__coreView__=e}addEventListener(e,t){this.__coreView__.addEventListener(e,t)}hasEventListener(e,t){return this.__coreView__.hasEventListener(e,t)}removeEventListener(e,t){this.__coreView__.removeEventListener(e,t)}dispatchEvent(e){this.__coreView__.dispatchEvent(e)}getPixelRatio(){return this.__coreView__.renderer.getPixelRatio()}switchRotateCenterBySelection(){this.__coreView__.switchRotateCenterBySelection()}setDefaultEnvMap(e){e&&(this.__coreView__.hasPbrMaterial=!0,this.__coreView__.setDefaultEnvMap=()=>{this.__coreView__.setEnvMapEnabled(!0),this.__coreView__.defaultEnvMapTexture=e,this.__coreView__.updateEnvMap(this.__coreView__.defaultEnvMapTexture)},this.__coreView__.setDefaultEnvMap())}getBackgroundState(){return this.__coreView__.exchangeBackImage?{type:this.__coreView__.exchangeBackImage.type,value:this.__coreView__.exchangeBackImage.value}:void 0}setBackgroundState(e,t){"Image"===e?(this.__coreView__.setEnvMapTextures(null),this.__coreView__.setBackGroundImage(t)):"EnvMap"===e?this.__coreView__.setEnvMapTextures(t):"Color"===e&&(this.__coreView__.setEnvMapTextures(null),this.__coreView__.setBackGroundImage(null),this.__coreView__.setBackGroundColor(t))}removeAllLights(){this.__coreView__.lights.length=0}getLight(e){return this.__coreView__.lights[e]}setLight(e,t){this.__coreView__.lights[e]=t}getViewBox(){return this.__coreView__.viewBox}toggleAutoRotation(e){this.__coreView__.toggleAutoRotation(e)}randColor(){return this.__coreView__.materialsSetting.randColor()}getBoundingBox(){var e=this.__coreView__.ndsModel.getTotalBodyBoundingBox();return e.isEmpty()?this.__coreView__.modelRootObject.boundingBox:e}getModelTree(){return this.__coreView__.getModelTree()}getModelCount(){return this.__coreView__.ndsModel.models.length}setActiveModel(e){this.__coreView__.ndsModel.setActiveModel(e)}setActiveModelByModelId(t){let i=-1;for(let e=0;e<this.__coreView__.ndsModel.models.length;++e)if(this.__coreView__.ndsModel.models[e].id===t){i=e;break}this.setActiveModel(i)}getActiveModel(){return this.__coreView__.ndsModel.getActiveModel()}getModelById(e){return this.__coreView__.ndsModel.getModelById(e)}getModelByIndex(e){return this.__coreView__.ndsModel.models[e]}registOperator(e,t){this.__coreView__.registOperator(e,t)}setOperatorByID(e){this.__coreView__.setOperatorByID(e)}getCurrentOperator(){return this.__coreView__.controls.getOperator()}getCurrentOperatorID(){return this.__coreView__.getCurrentOperatorID()}setOperator(e){this.__coreView__.setOperator(e)}registCursor(e,t,i){this.__coreView__.registCursor(e,t,i)}hideSelectedObjects(){this.__coreView__.hideSelectedObjects()}getViewControlBoundingBox(){return this.__coreView__.controls.getBoundingBox()}setViewControlBoundingBox(e,t){this.__coreView__.controls.setBoundingBox(e,t)}getCamera(){return this.__coreView__.camera}setCameraControlBoundingBoxCenter(e){this.__coreView__.cameraControl.setBoundingBoxCenter(e)}setCameraControlBounding(e,t){this.__coreView__.cameraControl.setBoundingBox(e,t)}getCameraInfo(){return this.__coreView__.cameraControl.getCameraInfo()}adjustNearAndFar(){this.__coreView__.cameraControl.adjustNearAndFar()}updateViewBoxCamDir(){this.__coreView__.cameraControl.updateViewBoxCamDir()}startSmoothTranslation(e){this.__coreView__.cameraControl.startSmoothTranslation(e)}zoomExtents(e,t,i){this.__coreView__.cameraControl.zoomExtents(e,t,i)}setCameraInfo(e,t){this.__coreView__.cameraControl.setCameraInfo(e,t)}getOrginalCameraInfo(){return(this.__coreView__.viewManager||this.__coreView__.camera).getOrginalCameraInfo()}setOrginalCameraInfo(e,t,i){this.__coreView__.camera.setOrginalCameraInfo({center:e,up:t,position:i})}toPerspectiveCamera(){this.__coreView__.toPerspectiveCamera()}toOrthographicCamera(){this.__coreView__.toOrthographicCamera()}updateGroundTransform(e,t,i){return this.__coreView__.groundShadow.updateGroundTransform(e,t,i)}getCanvas2D(){return this.__coreView__.canvas2D}getCanvas3D(){return this.__coreView__.canvas3D}getContainer(){return this.__coreView__.container}getRenderDomElement(){return this.__coreView__.renderer.domElement}getAdditionalObjectsScene(){return this.__coreView__.additionalObjectsScene}getDispalyModelUnit(e,t){return this.__coreView__.getDispalyModelUnit(e,t)}modelCoordToClientCoord(e){return this.__coreView__.modelCoordToClientCoord(e)}clientCoordToModelCoord(e){return this.__coreView__.clientCoordToModelCoord(e)}showObject(e,t,i,o=!0){this.__coreView__.showObject(e,t,i,o)}showObjectReversed(e){this.__coreView__.showObjectReversed(e)}renderAllViews(){this.__coreView__.renderAllViews()}render(e){this.__coreView__.render(e)}setRenderMode(e,t){this.__coreView__.setRenderMode(e,t)}getRenderMode(){let e=void 0;switch(this.__coreView__.getRenderMode()){case 0:e="lighting";break;case 1:e="primarycolor";break;case 2:e="wireframe";break;case 3:e="whitemold";break;case 4:e="shadedWithEdges";break;case 5:e="shaded";break;case 6:e="hiddenLineRemove";break;case 7:e="hiddenLineVisible";break;case 8:e="transparent"}return e}getAssemblyPMIState(){return this.__coreView__.AssemblyPMIState}setAssemblyPMIState(e){this.__coreView__.AssemblyPMIState=e}getPartPMIState(){return this.__coreView__.PartPMIState}setPartPMIState(e){this.__coreView__.PartPMIState=e}getPmiVisible(){return this.__coreView__.pmiVisible}setPmiVisible(e){this.__coreView__.pmiVisible=e}setPMIObjectVisible(e,t){this.__coreView__.setPMIObjectVisible(e,t)}isPMIOccludeByModel(){return!NDSWebViewer.SETTING.StopPMIOcclusion}enablePMIOccludeByModel(e){this.__coreView__.stopPMIOcclusion(!e)}getPmiList(){return this.__coreView__.PMINDSBodys}getPMIObjectByUUID(e){return this.__coreView__.PMIUUIDtoPMIObject[e]}isPMIObjectOrSomeChildHidden(e){return this.__coreView__.isPMIObjectOrSomeChildHidden(e)}getPmiObjectTree(){return this.__coreView__.pmiObject}getSelectedPmiList(){return this.__coreView__.getPMINDSBodySelectList()}selectPMIObject(e){this.__coreView__.selectPMIObject(e)}deselectPMIObject(e){this.__coreView__.deselectPMIObject(e)}unmergeBodyNode(){this.__coreView__.ndsModel.unmergeNode()}mergeBodyNode(){this.__coreView__.ndsModel.mergeNode()}getAllTransparentBodies(e){return this.__coreView__.ndsModel.getAllTransparentBodies(e)}isolateBodiesOnly(e){this.__coreView__.ndsModel.isolateBodiesOnly(e)}unloadModelById(e){this.__coreView__.ndsModel.unloadModelById(e)}getBodyNodeFromUuid(t,e=-1){var i=null;return 0<=e?(e=this.getModelById(e))&&(e=e.getBodyNodeFromUuid(t))&&(i=e):this.__coreView__.ndsModel.models.forEach(e=>{e=e.getBodyNodeFromUuid(t);e&&(i=e)}),i}}function s(e,t){this.viewer=e,this.extension=t;var A=this,i=null,E={},I={},g={},o={lineWidth:1,strokeStyle:"#000000"},y="",T="",h=null,n=[],w="lineSeg",r=!1,v=null,m=null,x=null,N=null,b=null,M=null,f=null,S=null,D=null,_=null,V=!1,s=null,a=null,C=(this.tempVector3=new THREE.Vector3,this.viewer.renderer.domElement),P=new THREE.WebGLRenderTarget(C.width,C.height,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat,stencilBuffer:!1}),O=(P.texture.generateMipmaps=!1,P.texture.name="annotations",new THREE.Scene),l=((e=new THREE.MeshBasicMaterial).side=THREE.DoubleSide,this.viewer.ndsModel&&(new e.constructor).copy(e),10),p=null;function u(e,t){var i=t?"annotationLogoSelected":"annotationLogo";return null!=e&&("ImageAnno"==e?i=t?"imgAnnotationLogoSelected":"imgAnnotationLogo":"ViewportAnno"==e?i=t?"viewportAnnotationLogoSelected":"viewportAnnotationLogo":"VideoAnno"==e?i=t?"videoAnnotationLogoSelected":"videoAnnotationLogo":"AudioAnno"==e&&(i=t?"AudioAnnotationLogoSelected":"AudioAnnotationLogo")),i}function B(e){var t,i,o,n,r=null,s=new THREE.Box2,a=A.viewer.renderer.domElement.width/2,l=A.viewer.renderer.domElement.height/2,d=A.viewer.renderer.getPixelRatio(),c=new THREE.Vector3;for(u in E)(g=E[u])&&(null!=g.type&&null!=g.type&&"lineSeg"==g.type?c.set(g.coords[g.coords.length-3],g.coords[g.coords.length-2],g.coords[g.coords.length-1]):c.copy((t=g,n=o=i=void 0,(n=new THREE.Vector3).set(t.coords[0],t.coords[1],t.coords[2]),t.locationObjectUUID&&""!=t.locationObjectUUID&&(t.locationObject||(t.locationObject=A.viewer.ndsModel.getBodyNodeFromUuid(t.locationObjectUUID,t.ndsModelId)),!t.locationObject&&A.viewer.ndsModel&&t.fileguid&&(i=null,(o=A.viewer.ndsModel.fileguidTouuid[t.fileguid])&&0<o.length&&(i=A.viewer.ndsModel.getRightBodyuuid(t.rootfileguid,o)),o=A.viewer.ndsModel.bodyUuid2NodeMap[i])&&o.children&&!o.children[t.BodyfileID]&&(o=o.children[t.BodyfileID],t.locationObject=o,t.ndsModelId=o.getModel().id),t.locationObject)&&("4"==t.version||"5"==t.version?A.viewer.ndsModel?0<=t.locationObject.id&&(i=R.getBodyNodeTranslate(A.extension,t.locationObject),n.x+=i.x,n.y+=i.y,n.z+=i.z):n.applyMatrix4(t.locationObject.worldMatrix):t.locationObject.matrixWorldTransOrginal&&((o=new THREE.Vector3).setFromMatrixPosition(t.locationObject.worldMatrix),o.sub(t.locationObject.matrixWorldTransOrginal),n.add(o)),I[t.uuid])&&I[t.uuid].position.copy(n),n)),g.worldPosition=c.clone(),c.project(A.viewer.camera),c.x=Math.round(c.x*a+a),c.y=Math.round(-c.y*l+l),g.screenPosition=c.clone(),0<=c.x)&&c.x<=P.width&&0<=c.y&&c.y<=P.height&&s.expandByPoint(c),T==u&&(i=(i=document.getElementById("calcAudioShow"))&&"none"!=i.style.display?i:document.getElementById("calcPicTextShow"))&&"none"!=i.style.display&&(i.style.left=c.x/d+4+"px",i.style.top=c.y/d+8+"px");if(A.viewer.isRotationEnable()){var h,p,u,g;c.y=c.x=4,s.expandByVector(c),s.min.x<0&&(s.min.x=0),s.min.y<0&&(s.min.y=0),s.max.x>P.width&&(s.max.x=P.width),s.max.y>P.height&&(s.max.y=P.height),!s.isEmpty()&&e&&(e=A.viewer.scene.overrideMaterial,h=A.viewer.renderer.getClearColor(A.viewer.oldClearColor).clone(),p=A.viewer.renderer.getClearAlpha(),A.viewer.renderer.setClearColor(3),A.viewer.ndsModel&&(A.viewer.ndsModel.backupDirty(),A.viewer.ndsModel.setDirty(),A.viewer.ndsModel.setDrawMode(A.viewer.ndsModel.SHADED),A.viewer.scene.children.push(A.viewer.ndsModel)),A.viewer.renderer.render(A.viewer.scene,A.viewer.camera,P,!0),A.viewer.scene.overrideMaterial=e,A.viewer.ndsModel&&A.viewer.ndsModel.resetDirty(),A.viewer.renderer.render(O,A.viewer.camera,P,!1),m=s.max.x-s.min.x,x=s.max.y-s.min.y,r=new Uint8Array(4*m*x),A.viewer.renderer.readRenderTargetPixels(P,s.min.x,P.height-s.max.y,m,x,r),A.viewer.renderer.setRenderTarget(null),A.viewer.renderer.setClearColor(h,p));for(u in E)if(g=E[u]){var y=!0;if("1"!=g.version){var w=I[g.uuid];if(w&&r)for(var v=w.material.color.getHex(""),m=s.max.x-s.min.x,x=s.max.y-s.min.y,y=!1,N=g.screenPosition.x-1;N<=g.screenPosition.x+1&&N<=s.max.x&&N>=s.min.x;++N){for(var b=g.screenPosition.y-1;b<=g.screenPosition.y+1&&b<=s.max.y&&b>=s.min.y;++b){var M=4*((x-(b-s.min.y))*m+(N-s.min.x)),M=r[M]<<16|r[1+M]<<8|r[2+M];if(Math.abs(M-v)<10){y=!0;break}}if(1==y)break}}else{var w=g.worldPosition.clone(),f=(w.clone(),A.viewer.camera.position.distanceTo(w)),f=new THREE.Raycaster(A.viewer.camera.position,w.sub(A.viewer.camera.position).normalize(),0,.9999*f).intersectObjects(A.viewer.selectionManager.getTargetList());0<f.length&&f[0].point&&(y=!1)}g.bShowAnnoOpacity=y}}}this.getAnnotationJsonArray=function(){return i},this.getAnnotationsArray=function(){return E},this.getSelectAnnotation=function(){return T},this.getRenderTarget=function(){return P},this.setSize=function(e,t){e==P.width&&t==P.height||(P.dispose(),(P=new THREE.WebGLRenderTarget(e,t,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat,stencilBuffer:!1})).texture.generateMipmaps=!1)},this.listenAnnotation=function(e){(p=e)&&g[p]&&A.viewer.dispatchEvent({type:"annotationMoved",annotationDiv:g[p]})},this.setAnnotationMode=function(e){null!=e&&"face"==(w=e)&&A.viewer.hasBrepFile()&&!A.viewer.hasBrepInfo()&&this.viewer.loadBrepInfo(!1)},this.getAnnotationMode=function(){return w},this.setLineSegAnnotationStyle=function(e){e&&(null!=e.lineWidth&&(o.lineWidth=e.lineWidth),null!=e.strokeStyle)&&(o.strokeStyle=e.strokeStyle)},this.getLineSegAnnotationStyle=function(){return o},this.getposFromFileGuid=function(e,t,i){var o,n=e.fileguid,r=e.rootfileguid,s=e.matrix,a=e.BodyfileID,l=e.explodeFactor,n=A.viewer.ndsModel.fileguidTouuid[n],d=null;return null!=(d=n&&0<n.length?A.viewer.ndsModel.getRightBodyuuid(r,n):d)&&!!((r=A.viewer.ndsModel.bodyUuid2NodeMap[d])&&r.children&&r.children[a]&&r.children[a].uuid)&&(n=r.children[a],(d=A.viewer.ndsModel.getExplodeTranslate(4*l,n))[0]+=e.translate[0],d[1]+=e.translate[1],d[2]+=e.translate[2],(r=new THREE.Matrix4).fromArray(s),a=n.worldMatrix,null!=t.cx&&(o=new THREE.Vector3(t.cx,t.cy,t.cz),null!=i&&0!=i&&(o.x-=e.annoTranslate[0],o.y-=e.annoTranslate[1],o.z-=e.annoTranslate[2]),o.applyMatrix4(r),o.applyMatrix4(a),null!=i&&0!=i&&(o.x+=d[0],o.y+=d[1],o.z+=d[2]),t.cx=o.x,t.cy=o.y,t.cz=o.z),null!=t.x&&(o=new THREE.Vector3(t.x,t.y,t.z),null!=i&&0!=i&&(o.x-=e.annoTranslate[0],o.y-=e.annoTranslate[1],o.z-=e.annoTranslate[2]),o.applyMatrix4(r),o.applyMatrix4(a),null!=i&&0!=i&&(o.x+=d[0],o.y+=d[1],o.z+=d[2]),t.x=o.x,t.y=o.y,t.z=o.z),null!=t.cx2&&(o=new THREE.Vector3(t.cx2,t.cy2,t.cz2),null!=i&&0!=i&&(o.x-=e.annoTranslate[0],o.y-=e.annoTranslate[1],o.z-=e.annoTranslate[2]),o.applyMatrix4(r),o.applyMatrix4(a),null!=i&&0!=i&&(o.x+=d[0],o.y+=d[1],o.z+=d[2]),t.cx2=o.x,t.cy2=o.y,t.cz2=o.z),!0)},this.getCamupFromFileGuid=function(e,t){var i,o=e.fileguid,n=e.rootfileguid,r=e.matrix,e=e.BodyfileID,o=A.viewer.ndsModel.fileguidTouuid[o],s=null;return null!=(s=o&&0<o.length?A.viewer.ndsModel.getRightBodyuuid(n,o):s)&&!!((n=A.viewer.ndsModel.bodyUuid2NodeMap[s])&&n.children&&n.children[e]&&n.children[e].uuid)&&(o=n.children[e],(s=new THREE.Matrix4).fromArray(r),n=o.worldMatrix,e=new THREE.Vector3(t.x,t.y,t.z),r=new THREE.Quaternion,o=new THREE.Vector3,i=new THREE.Vector3,s.decompose(o,r,i),e.applyQuaternion(r),n.decompose(o,r,i),e.applyQuaternion(r),t.x=e.x,t.y=e.y,t.z=e.z,!0)},this.selectAnnotation=function(e){if(T&&""!=T&&this.resetSelectAnnotation(!0),null==e)y="";else{T=y=e;var t=NDSWebViewer.ExtensionManager.getExtension("ExplodeModelExtension"),i=(v=t?t.getExplodeFactor():null,N=t?t.getExplodeMode():null,m=t?t.getExplodeLevel():null,x=t?t.getExplodeObjects().concat():null,A.getAnnotation(e));if(i&&i.cameraInfo){null==b&&(b=A.viewer.camera.position.clone(),M=A.viewer.camera.target.clone(),f=A.viewer.camera.up.clone(),S=A.viewer.camera.far,D=A.viewer.camera.near,_=A.viewer.camera.IsPerspective());var o,n,r,s,a,l,d,t=i.cameraInfo.far,c=(i.other&&!i.haschange&&i.rootfileguid&&i.fileguid&&i.translate&&(this.getposFromFileGuid(i,i.cameraInfo.position,!0),this.getposFromFileGuid(i,i.cameraInfo.target,!0),this.getCamupFromFileGuid(i,i.cameraInfo.up),i.haschange=!0,i.cameraInfo.modelScreenBBox=A.viewer.computeModelScreenBBox()),!i.locationObject&&i.locationObjectUUID&&(A.viewer.ndsModel?i.locationObject=A.viewer.ndsModel.getBodyNodeFromUuid(i.locationObjectUUID,i.ndsModelId):i.locationObject=A.viewer.modelRootObject.getObjectByProperty("uuid",i.locationObjectUUID)),A.viewer.camera.IsPerspective()!=i.cameraInfo.isPerspective&&(i.cameraInfo.isPerspective?A.viewer.camera.toPerspective():A.viewer.camera.toOrthographic()),{center:new THREE.Vector3(i.cameraInfo.target.x,i.cameraInfo.target.y,i.cameraInfo.target.z),up:new THREE.Vector3(i.cameraInfo.up.x,i.cameraInfo.up.y,i.cameraInfo.up.z),position:new THREE.Vector3(i.cameraInfo.position.x,i.cameraInfo.position.y,i.cameraInfo.position.z)});if("ViewportAnno"==i.type||A.viewer.is2DModel||1<(r=function(e,t){if(null==t.width||null==t.height||null==t.modelScreenBBox)return 1;var i=A.viewer.renderer.getPixelRatio(),o=A.viewer.renderer.domElement.width/i,i=A.viewer.renderer.domElement.height/i;if(Math.abs(t.width-o)/o<.1&&Math.abs(t.height-i)/i<.1)return 1;var n=A.viewer.camera.position.clone(),r=A.viewer.camera.target.clone(),s=A.viewer.camera.up.clone(),e=(A.viewer.camera.position.copy(e.position),A.viewer.camera.target.copy(e.center),A.viewer.camera.up.copy(e.up),A.viewer.camera.lookAt(e.center),A.viewer.camera.updateMatrixWorld(!0),A.viewer.camera.updateProjectionMatrix(),A.viewer.computeModelScreenBBox()),n=(A.viewer.camera.position.copy(n),A.viewer.camera.target.copy(r),A.viewer.camera.up.copy(s),A.viewer.camera.lookAt(r),A.viewer.camera.updateMatrixWorld(!0),A.viewer.camera.updateProjectionMatrix(),e.max.x-e.min.x),s=e.max.y-e.min.y,r=e.min.x,a=o-e.max.x,l=e.min.y,e=i-e.max.y,d=t.width,c=t.height,h=t.modelScreenBBox.max.x-t.modelScreenBBox.min.x,p=t.modelScreenBBox.max.y-t.modelScreenBBox.min.y,u=t.modelScreenBBox.min.x,d=d-t.modelScreenBBox.max.x,g=t.modelScreenBBox.min.y,c=c-t.modelScreenBBox.max.y,t=0;r<0&&(u<0?(y=-u/h)<-r/n&&(t=-n*y-r):t=-r);u=0;a<0&&(d<0?(y=-d/h)<-a/n&&(u=-n*y-a):u=-a);r=Math.max(t,u),d=1;0<r&&(d=(o+2*r)/o);h=0;l<0&&(g<0?(y=-g/p)<-l/s&&(h=-s*y-l):h=-l);n=0;{var y;e<0&&(c<0?(y=-c/p)<-e/s&&(n=-s*y-e):n=-e)}a=Math.max(h,n),t=1;0<a&&(t=(i+2*a)/i);u=Math.max(d,t);1<u&&(u*=1.1);return u}(c,i.cameraInfo))&&!i.other&&(2<r?(n=(a=(a=A.viewer.is2DModel?null:A.viewer.controls.getExplosionBoundingBox())||A.viewer.controls.getBoundingBox()).getCenter(),l=(d=.5*(new THREE.Vector3).subVectors(a.max,a.min).length())/Math.sin(Math.PI/180*A.viewer.camera.fov*.5),A.viewer.camera.IsPerspective()&&A.viewer.camera.aspect<1&&(l/=A.viewer.camera.aspect),(s=c.position.clone()).sub(c.center),s.normalize(),s.multiplyScalar(l),c.center=n.clone(),c.position.addVectors(c.center,s)):((s=c.position.clone()).sub(c.center),s.multiplyScalar(r),c.position.addVectors(c.center,s),t<2*(o=s.length())&&(t=2*o))),i.other?(l=(a=null==(a=A.viewer.is2DModel?null:A.viewer.controls.getExplosionBoundingBox())?A.viewer.controls.getBoundingBox():a).getCenter(),d=.5*(new THREE.Vector3).subVectors(a.max,a.min).length(),o=c.position.distanceTo(l),(o+=d)<t&&(o=t),A.viewer.camera.setFarNear(o,i.cameraInfo.near)):A.viewer.camera.setFarNear(t,i.cameraInfo.near),"4"==i.version&&(c.center.applyMatrix4(A.viewer.modelRootObject.worldMatrix),c.position.applyMatrix4(A.viewer.modelRootObject.worldMatrix),c.up.transformDirection(A.viewer.modelRootObject.worldMatrix)),null!=i.explodeFactor&&null!=i.explodeFactor&&(n=NDSWebViewer.ExtensionManager.getExtension("ExplodeModelExtension"))&&(i.explodeMode&n.EXPLODEMODE.SELECTED?(n.setExplodeObjects(i.explodeObjects.concat()),n.setExplodeMode(i.explodeMode,i.exploseLevel,!0)):n.setExplodeMode(i.explodeMode,i.exploseLevel),n.onExplode(i.explodeFactor)),A.viewer.toggleAutoRotation(!1),A.viewer.startSmoothTranslation(c,function(){g[e]||A.renderAnnotations(),A.viewer.dispatchEvent({type:"annotationSelectedEvent",userData:{uuid:e,index:i.index||-1,annotationDiv:g[e]}}),A.viewer.dispatchEvent({type:"annotationMoved",annotationDiv:g[e]})}),NDSWebViewer.SETTING.enableBroadcast&&!NDSWebViewer.SETTING.broadcastMajor&&(g[e]||A.renderAnnotations(),A.viewer.dispatchEvent({type:"annotationSelectedEvent",userData:{uuid:e,index:i.index||-1,annotationDiv:g[e]}}),A.viewer.dispatchEvent({type:"annotationMoved",annotationDiv:g[e]})),"body"==i.mode&&i.objectId&&0<i.objectId.length){this.viewer.ndsModel.clearSelection();for(var h,p,u=this.viewer.selectionManager.getSelectedObjects().length=0;u<i.objectId.length;++u)(p=!this.viewer.ndsModel.objectidTouuid||this.viewer.is2DModel?this.viewer.ndsModel.getBodyNode(i.objectId[u]):(h=this.viewer.ndsModel.objectidTouuid[i.objectId[u]],this.viewer.ndsModel.getBodyNodeFromUuid(h)))&&this.viewer.selectionManager.selectObject(p,!1,!1);V=!0}"face"==i.mode&&i.faceInfo&&(h=i.faceInfo.bodyuuid,r=i.faceInfo.geomuuid,s=i.faceInfo.topolIndex,a=this.viewer.ndsModel.getActiveModel().brepManager.GetBrepInfoByUUidAndTopolIndex(h,r,s,"face"),l=i.faceInfo.meshId,d=this.viewer.ndsModel.meshManager.getSingleMesh(l))&&a&&(a.parentObj=d,a.geometry=d.geometry,a.bodyUuid=h,a.topolIndex=s,a.meshId=l,a.matrixWorld=d.matrixWorld.clone(),this.viewer.selectionManager.HandleSelectedFace(a,!1,null),V=!0)}}this.viewer.pmiObject&&this.viewer.deselectPMIObject(this.viewer.pmiObject)},this.setAnnotationType=function(e,t){t=E[t];t&&(t.type=e)},this.setAnnotationsVisibilityByUuid=function(e,t){t=g[t];t&&(e?(t.style.visibility="visible",r=!1):t.style.visibility="hidden")},this.resetSelectAnnotation=function(e){if(T&&""!=T){var t,i=A.getAnnotation(T);if(!i)return null!=v&&(t=NDSWebViewer.ExtensionManager.getExtension("ExplodeModelExtension"))&&(N&t.EXPLODEMODE.SELECTED?(t.setExplodeObjects(x.concat()),t.setExplodeMode(N,m,!0)):t.setExplodeMode(N,m),t.onExplode(v)),T="",N=x=m=v=null,V=!1,void(n=[]);i.bOnModel&&(t=i.locationObject)&&0<n.length&&i.translate&&(i=new THREE.Vector3(n[0]-i.translate[0],n[1]-i.translate[1],n[2]-i.translate[2]),A.viewer.ndsModel.dragBody(t,i)),null!=v&&(t=NDSWebViewer.ExtensionManager.getExtension("ExplodeModelExtension"))&&(N&t.EXPLODEMODE.SELECTED?(t.setExplodeObjects(x),t.setExplodeMode(N,m,!0)):t.setExplodeMode(N,m),t.onExplode(v)),T="",N=x=m=v=null,n=[]}(e=null==e?!1:e)||null==b||null==M||null==f||(i={center:M,up:f,position:b},A.viewer.camera.IsPerspective()!=_&&(_?A.viewer.camera.toPerspective():A.viewer.camera.toOrthographic()),A.viewer.camera.setFarNear(S,D),A.viewer.startSmoothTranslation(i,function(){D=S=f=M=b=null})),V&&(this.viewer.ndsModel.clearSelection(),V=!1);for(let e=this.viewer.scene.children.length-1;-1<e;e--){var o=this.viewer.scene.children[e];"annotationFace"==o.name&&A.viewer.scene.remove(o)}},this.addAnnotationRenderObject=function(e){var t,i,o,n;I[e.uuid]||(n=A.viewer.controls.getBoundingBox().getSize(),t=Math.min(n.x,n.y),(t=Math.min(t,n.z))<.1&&(i=Math.max(n.x,n.y),o=Math.max(n.z,n.y),t=Math.min(i,o)),30<Math.max(n.x,n.y,n.z)/t&&(t*=10),i=new THREE.SphereBufferGeometry(.03*t,8,8),(o=new THREE.MeshBasicMaterial).color.setHex(l),n=new THREE.Mesh(i,o),I[e.uuid]=n,O.add(I[e.uuid]),l+=10),null!=e.type&&null!=e.type&&"lineSeg"==e.type?I[e.uuid].position.set(e.coords[e.coords.length-3],e.coords[e.coords.length-2],e.coords[e.coords.length-1]):I[e.uuid].position.set(e.coords[0],e.coords[1],e.coords[2]),I[e.uuid].updateMatrixWorld(!0)},this.addAnnotation=function(e,t,i){if(e.locationObjectUUID&&!A.viewer.ndsModel.getBodyNodeFromUuid(e.locationObjectUUID,e.ndsModelId))return;if(e&&e.uuid){if(e.locationObject=null,i&&!e.other){var i=new THREE.Vector3(e.coords[0],e.coords[1],e.coords[2]),i=(this.getposFromFileGuid(e,i),e.coords[0]=i.x,e.coords[1]=i.y,e.coords[2]=i.z,e.other=!0,A.viewer.ndsModel.fileguidTouuid[e.fileguid]),o=null,n=(i&&0<i.length&&(o=A.viewer.ndsModel.getRightBodyuuid(e.rootfileguid,i)),A.viewer.ndsModel.bodyUuid2NodeMap[o]);if(!n||!n.children||!n.children[e.BodyfileID])return!1;for(var r=0,s=0;s<n.children.length;++s){var a=n.children[s];if(!a.isReferenceEntity()&&!a.isCoordinate()){if(r==e.BodyfileID){r=s;break}r++}}n=n.children[r],e.locationObject=n}"face"==e.mode&&A.viewer.hasBrepFile()&&!A.viewer.hasBrepInfo()&&A.viewer.loadBrepInfo(!1),E[e.uuid]=e,y=e.uuid,null!=t&&0==t||A.addAnnotationRenderObject(e)}},this.addAnnotations=function(e){y="";for(var t=0;t<e.length;++t)e[t]&&e[t].uuid&&(E[e[t].uuid]=e[t],A.addAnnotationRenderObject(e[t]));i=e},this.getAnnotation=function(e){return e?E[e]:null},this.removeAnnotation=function(e){var t;e&&(e==y&&(y=""),E[e]=null,(t=g[e])&&(this.viewer.container.removeChild(t),g[e]=null,Number(t.innerText)),I[e])&&(I[e].geometry&&I[e].geometry.dispose(),I[e].material&&I[e].material.dispose(),O.remove(I[e]),I[e]=null)},this.removeAllAnnotations=function(){for(var e in E={},g){var t=g[e];t&&this.viewer.container.removeChild(t)}for(e in g={},h&&(this.viewer.canvas2D.getContext("2d").clearRect(h.min.x,h.min.y,h.max.x-h.min.x,h.max.y-h.min.y),h=null),y="",I)I[e]&&(I[e].geometry&&I[e].geometry.dispose(),I[e].material)&&I[e].material.dispose();I={};for(var i=0;i<O.children.length;i++)O.remove(O.children[i]),i--;A.viewer.render()},this.addAnnotationTip=function(e,t,i,o,n){var r=document.createElement("div");return r.className=u(i,!1),NDSWebViewer.COMMON.isMobileDevice()?(r.style.top=n-30+"px",r.style.left=o-12+"px"):(r.style.top=n-35+"px",r.style.left=o-13+"px"),r.style.opacity=1,(null==i||"ImageAnno"!=i&&"VideoAnno"!=i&&"AudioAnno"!=i)&&(r.innerHTML=t.toString(),r.innerText=t.toString()),r.setAttribute("uuid",e),r.onclick=function(e){e&&(e.preventDefault(),e.stopPropagation()),null!=r.style.opacity&&1==r.style.opacity&&(e=r.getAttribute("uuid"),A.selectAnnotation(e))},r.onselectstart=function(){return!1},r},this.restoreAllAnnotations=function(){if(this.viewer.canvas2D){for(var e in g){e=g[e];e&&(e.style.visibility="visible")}r=!1}},this.hasAnnotationsForAnimation=function(e){if(this.viewer.canvas2D)for(var t in E)if(E[t]&&e==E[t].ownerUuid&&"animation"==E[t].ownerType)return!0;return!1},this.updateAnnotationsVisiblilityForAnimation=function(e,t){if(this.viewer.canvas2D)for(var i in g){var o=g[i];o&&"animation"==E[i].ownerType&&(e==E[i].ownerUuid&&E[i].timeStart<=t&&E[i].timeEnd>=t?o.style.visibility="visible":(o.style.visibility="hidden",y==i&&(y="")))}},this.setAnnotationsVisiblilityForAnimation=function(e){if(this.viewer.canvas2D)for(var t in g){var i=g[t];i&&"animation"==E[t].ownerType&&(i.style.visibility=e?"visible":"hidden")}},this.hideAllAnnotations=function(e){if(this.viewer.canvas2D)for(var t in h&&(this.viewer.canvas2D.getContext("2d").clearRect(h.min.x,h.min.y,h.max.x-h.min.x,h.max.y-h.min.y),h=null),y="",g){var i,o=g[t];o&&(i=!0,i=("animation"!=E[t].ownerType||e!=E[t].ownerUuid)&&i)&&(o.style.visibility="hidden")}},this.setAnnotationsVisibility=function(e){if(this.viewer.canvas2D){for(var t in r=!e,h&&(this.viewer.canvas2D.getContext("2d").clearRect(h.min.x,h.min.y,h.max.x-h.min.x,h.max.y-h.min.y),h=null),y="",g){t=g[t];t&&(t.style.visibility=e?"visible":"hidden")}A.viewer.render()}},this.isAnnotationsVisible=function(){r=!0;var e,t=0;for(e in g)if(g.hasOwnProperty(e)){t++;var i=g[e];if(i&&("visible"==i.style.visibility||i.style.hidemodel)){r=!1;break}}return!(r=0==t?!1:r)},this.setAnnotationPos=function(e,t){1==this.viewer.ndsModel.getSelectedBodies().length&&(s=e,a=t)},this.getAnnotationPos=function(){return 1==this.viewer.ndsModel.getSelectedBodies().length?{ClientX:s,ClientY:a}:null},this.confirmAnnotation=function(){var e=this.getAnnotationPos();return e?{clickPosX:e.ClientX,clickPosY:e.ClientY}:{clickPosX:null,clickPosY:null}},this.getHotPoint=function(e,t){var i,o,n,r,s=this.viewer.renderer.getPixelRatio(),a=new THREE.Matrix4,l=(a.multiplyMatrices(this.viewer.camera.matrixWorld,a.getInverse(this.viewer.camera.projectionMatrix)),function(e){return e.parent?e.parent.fileguid||l(e.parent):null}),d=!1,c=new Object,h=this.viewer.selectionManager.getPickIntersects(e,t),p=(h&&0<h.length&&(o=h[0].point.clone(),this.viewer.ndsModel?(p=h[0].bodyNode,i=R.getBodyNodeTranslate(this.extension,p),o.x-=i.x,o.y-=i.y,o.z-=i.z,r=p.worldMatrix,(n=new THREE.Matrix4).getInverse(r),c.matrix=Array.prototype.slice.call(new Float32Array(n.elements)),l(p)&&(c.fileguid=l(p)),this.viewer.ndsModel.rootBodyNode.fileguid&&(c.rootfileguid=this.viewer.ndsModel.rootBodyNode.fileguid),null!=p.BodyfileID&&null!=p.BodyfileID&&(c.BodyfileID=p.BodyfileID),c.annoTranslate=i):(null==(p=this.viewer.selectionManager.findParentElement(h[0].object))&&(p=h[0].object),(n=new THREE.Matrix4).getInverse(p.worldMatrix),o.applyMatrix4(n)),c.coords=[o.x,o.y,o.z],c.bOnModel=!0,c.locationObjectUUID=p.uuid,c.locationObjectId=p.ndsModel.id,c.ndsModelId=p.ndsModel.id,c.objectId=[p.objectid],d=!0),this.viewer.ndsModel.rootBodyNode.fileguid&&(c.rootfileguid=this.viewer.ndsModel.rootBodyNode.fileguid),d||(r=new THREE.Vector3,this.viewer.controls.getBoundingBox().getCenter(r),r.project(this.viewer.camera),(i=r.z)<-1&&(i=-.99),(o=new THREE.Vector3).set(e*s/C.width*2-1,2*-(t*s/C.height)+1,i),o.applyMatrix4(a),(n=[])[0]=o.x,n[1]=o.y,n[2]=o.z,c.coords=n,c.bOnModel=!1,c.locationObjectUUID=null),c.cameraInfo=this.viewer.getCameraInfo(),NDSWebViewer.ExtensionManager.getExtension("ExplodeModelExtension"));if(c.explodeFactor=p?p.getExplodeFactor():null,c.explodeMode=p?p.getExplodeMode():null,c.exploseLevel=p?p.getExplodeLevel():null,c.explodeObjects=p?p.getExplodeObjects().concat():null,c.mode=w,"body"==c.mode){var u=this.viewer.ndsModel.getSelectedBodies();if(0<u.length){c.objectId=[];for(var g=0;g<u.length;++g)this.viewer.ndsModel.objectidTouuid&&!this.viewer.is2DModel?c.objectId.push(u[g].objectid):c.objectId.push(u[g].id);(1<u.length||1==u.length&&c.locationObjectUUID!=u[0].uuid)&&(c.bOnModel=!1,c.locationObjectUUID=null),this.viewer.ndsModel.clearSelection()}}else"face"==c.mode&&h&&0<h.length&&-1<h[0].meshId&&(d=null,(r=h[0]).mesh=A.viewer.ndsModel.meshManager.getSingleMesh(r.meshId),r.mesh&&(d=r.faceIndex-r.mesh.geometry.drawRange.start/3),c.faceInfo={bodyuuid:r.bodyUuid,geomuuid:r.geomUuid,topolIndex:d,meshId:r.meshId},this.viewer.ndsModel.clearSelection());return c},this.renderAnnotations=function(e=!1){if(this.viewer.canvas2D){h&&(this.viewer.canvas2D.getContext("2d").clearRect(h.min.x,h.min.y,h.max.x-h.min.x,h.max.y-h.min.y),h=null);var t,i=this.viewer.renderer.getPixelRatio();for(t in B(e),E){var o,n,r=E[t];r&&(d=!0,r.locationObject&&(d=A.viewer.ndsModel?NDSWebViewer.SETTING.HideLeafBody&&r.locationObject.isHidden()?(n=r.locationObject.parent,"N"!==this.viewer.ndsModel.getModelById(r.locationObject.ndsModel.id).bodyUuid2ClonedNodeMap[n.uuid].isChecked):!r.locationObject.isHidden():r.locationObject.visible),(n=g[r.uuid])&&(o=!0,!(o="hidden"==n.style.visibility?!1:o)&&n.style.hidemodel&&d?n.style.hidemodel=!1:!o||d||n.style.hidemodel?d&=o:n.style.hidemodel=!0),void 0!==r.index)&&((o=r.screenPosition.clone()).x/=i,o.y/=i,g[t]||(n=this.addAnnotationTip(r.uuid,r.index,r.type,o.x,o.y))&&(this.viewer.container.appendChild(n),g[t]=n),this.viewer.isRotationEnable()||(r.bShowAnnoOpacity=!0),s=o,a=!1,l=(r=r).bShowAnnoOpacity,d=d,c=void 0,c=g[r.uuid])&&(a=u(r.type,a),c.className!=a&&(c.className=a),NDSWebViewer.COMMON.isMobileDevice()?(c.style.top=s.y-30+"px",c.style.left=s.x-12+"px"):(c.style.top=s.y-35+"px",c.style.left=s.x-13+"px"),l?(c.style.opacity=1,c.style.cursor="pointer"):(c.style.opacity=.2,null!=(a=A.viewer.renderer.domElement)&&(c.style.cursor=a.style.cursor)),c.style.visibility=d?"visible":"hidden",null==r.type||"ImageAnno"!=r.type&&"VideoAnno"!=r.type&&"AudioAnno"!=r.type?(c.innerHTML=r.index.toString(),c.innerText=r.index.toString()):(c.innerHTML="",c.innerText=""))}p&&g[p]&&A.viewer.dispatchEvent({type:"annotationMoved",annotationDiv:g[p]})}var s,a,l,d,c},this.updateAnnotaion=function(e,t){var i,o=e.uuid;for(i in E){var n,r=E[i];r&&r.locationObject&&r.locationObject.uuid==o&&r.locationObject.getModel().id==e.getModel().id&&((n=new THREE.Vector3).set(r.coords[0],r.coords[1],r.coords[2]),n.applyMatrix4(t),n.toArray(r.coords))}},this.unloadAnnotation=function(e,t=0){for(var i in E){var o=E[i];o&&o.locationObject&&o.locationObject.getModel().rootBodyNode.uuid==e&&o.locationObject.getModel().id==t&&(this.removeAnnotation(i),this.viewer.dispatchEvent({type:"annotationRemove",uuid:i}))}}}function a(e){NDSWebViewer.OpBase.call(this,e),this.type="OpAnnotationNew",this.mode="normal",this.oldmode="normal";var i=this;this.POINTSIZE=3,this.materialPoint=new THREE.MeshBasicMaterial({color:"#FF6302",opacity:1,transparent:!1,depthTest:!1,depthWrite:!1}),this.rootObject=new THREE.Object3D,this.AnnotationScene=new THREE.Scene,this.AnnotationScene.add(this.rootObject);let o=document.createElement("input");o.id="picLoad",o.type="file",o.accept="image/jpeg, image/png, image/gif,image/jpg,image/bmp",o.style.width="0px",o.style.height="0px",o.style.display="none",o.style.width="0px",o.style.height="0px",o.style.display="none",document.body.appendChild(o),o.addEventListener("change",function(e){let t=e.target.files[0];var e=t.name.substring(t.name.lastIndexOf(".")).toLowerCase();[".jpeg",".png",".gif",".jpg",".bmp"].includes(e)?t&&((e=new FileReader).onload=function(e){e=e.target.result;i.createElement(e,t.name),o.value=""},e.readAsDataURL(t)):(i.viewer.dispatchEvent({type:"errorMsgTips",msg:"格式不支持"}),o.value=null)}),this._isDragging=!1,this._isResizing=!1,this._currentTarget=null,this._zindex=NDSWebViewer.COMMON.isMobileDevice()?2:7,this._tabIndex=90,this.startX,this.startY,this.startWidth,this.startHeight,this.Textbox=null,this.intersectPnt=null,this.picSelectID=0,this.picSelectIDs=[],this.selectIDs=[],this.unvisibleIDs=[],this.enableMove=!0,this.allowIds=[],this.spliteMode=!1,this.dpr=this.viewer.renderer.getPixelRatio(),this.materialLine=new THREE.MeshBasicMaterial({color:8190976,opacity:.8,transparent:!0,depthTest:!1,depthWrite:!1,side:THREE.DoubleSide}),this.TextContents=[],this.PicContents=[],this.MoveTarget=null,this.AnnotationShow=!0,this.prompt=document.getElementById("op-prompt"),this.prompt||(this.prompt=document.createElement("div"),this.prompt.id="op-prompt"),NDSWebViewer.COMMON.isMobileDevice()?this.prompt.className="app-alert":this.prompt.className="pc-alert",e.container.appendChild(this.prompt),this.Popup=null,e.is2DModel&&(a.prototype.selectAndZoom=function(){}),this.superOnMouseWheel=this.onMouseWheel,this.onMouseWheel=function(e,t){"OpAnnotationNew"!==i.viewer.getCurrentOperatorID()&&!t||i.superOnMouseWheel(e)}}(a.prototype=Object.create(NDSWebViewer.OpBase.prototype)).getUUid=function(){var e=new Date;return"cms"+e.getDay()+e.getHours()+e.getMinutes()+e.getSeconds()+e.getMilliseconds()+Math.round(1e4*Math.random())},a.prototype.PostInfo=function(e){var t;e&&((t=this).Popup&&(clearTimeout(this.Popup),this.Popup=null),this.prompt.innerHTML=e,this.prompt.style.display="block",NDSWebViewer.COMMON.isMobileDevice())&&(e=this.viewer.renderer.getSize().height/2-21+"px",this.prompt.style.top=e,this.prompt.style.color="rgba(27,27,27,1)",this.Popup=setTimeout(function(){t.prompt.style.display="none"},2e3))},a.prototype.clearMsgInfo=function(){this._clearMsgInfo=!0},a.prototype.SetEnableMove=function(e){(this.enableMove=e)||("NoteMove"==this.mode&&(this.mode="normal"),this._isDragging=!1,this._isResizing=!1)},a.prototype.createElement=function(e,t){t=t.slice(0,t.lastIndexOf("."));let d=document.createElement("div"),c=this;function h(e){var t,i;c._isDragging=!1,c._isResizing=!1,c._currentTarget=null,c.state==NDSWebViewer.NDS.MOUSE.MIDDLE?(t=e.clientX-c.viewer.container.getBoundingClientRect().left,i=e.clientY-c.viewer.container.getBoundingClientRect().top,c.MouseUp.set(t,i),c.onMMouseUp(e)):c.state==NDSWebViewer.NDS.MOUSE.LEFT&&c.onLMouseUp(),c.setMode("normal"),document.removeEventListener("mouseup",h)}d.animationID=this.viewer.AnimationEdit&&this.viewer.AnimationEdit._activeAnimationID;let i=new Image;i.style.display="none",d.appendChild(i),d.style.position="absolute",d.style.zIndex=20,d.style.border="2px solid rgba(255, 195, 0, 0.0)",d.style.padding="3px";for(let e=0;e<4;e++){var o=document.createElement("div"),n=(o.className="divBoxSub",o.style.width="16px",o.style.height="16px",o.style.position="absolute",o.style.backgroundColor="rgba(255, 0, 0, 0)",document.createElement("div"));n.className="divBoxSub2",n.style.backgroundColor="#fff",n.style.border="2px solid rgba(255, 195, 0)",n.style.width="6px",n.style.height="6px",n.style.marginTop="3px",n.style.marginLeft="3px",0==e&&(o.style.top="-8px",o.style.left="-8px",o.style.cursor="nwse-resize"),1==e&&(o.style.top="-8px",o.style.right="-8px",o.style.cursor="nesw-resize"),2==e&&(o.style.bottom="-8px",o.style.left="-8px",o.style.cursor="nesw-resize"),3==e&&(o.style.bottom="-8px",o.style.right="-8px",o.style.cursor="nwse-resize"),o.style.display="none",o.appendChild(n),d.appendChild(o)}let r=this.getUUid();d.id=r,d.filename=t,i.addEventListener("mousemove",function(e){var t,i,o,n,r=NDSWebViewer.ExtensionManager.getExtension("NDSAnimationExtension");r&&r._enableAnimation||(c.mouseMoveByEvent(e),c._isResizing&&c.state==NDSWebViewer.NDS.MOUSE.LEFT?c.reSize(e):c._isDragging&&c.state==NDSWebViewer.NDS.MOUSE.LEFT?(r=Math.round(e.clientX-c.startX),n=Math.round(e.clientY-c.startY),c._currentTarget.parentNode.style.left=r+"px",c._currentTarget.parentNode.style.top=n+"px"):c.state==NDSWebViewer.NDS.MOUSE.LEFT?(r=e.clientX-c.viewer.container.getBoundingClientRect().left,n=e.clientY-c.viewer.container.getBoundingClientRect().top,c.pointer.set(r,n),c.onLMouseMove(e),c.pointerOld.set(r,n)):c.state==NDSWebViewer.NDS.MOUSE.MIDDLE?c.onMMouseMove(e):(r=d.getBoundingClientRect(),n=e.clientX-r.left,e=e.clientY-r.top,t=n<=15&&e<=15,i=n>=r.width-15&&e<=15,o=n<=15&&e>=r.height-15,n=n>=r.width-15&&e>=r.height-15,d.style.cursor=t||n?"nwse-resize":i||o?"nesw-resize":"default"),c.viewer.render())}),i.addEventListener("click",function(e){if(c.checkIsAllow(e.target.parentNode.id))for(let e=0;e<c.TextContents.length;e++){var t=c.TextContents[e];t.childNodes[0].blur(),"NoteEdit"!=c.mode&&(t.childNodes[0].style.cursor="default",t.childNodes[0].style.userSelect="none",t.childNodes[0].readOnly=!0)}}),i.addEventListener("dragstart",function(e){e.preventDefault()}),d.addEventListener("mousemove",function(e){c._isDragging}),d.addEventListener("mousedown",function(t){var i=NDSWebViewer.ExtensionManager.getExtension("NDSAnimationExtension");if(!(i&&i._enableAnimation&&i.isrunning())&&2!=t.button&&c.checkIsAllow(t.target.parentNode.id)){if(t.ctrlKey)if(0!=c.picSelectID||0!=c.selectID){let e=[];i=0!=c.picSelectID?c.picSelectID:c.selectID;c.picSelectID!=t.target.parentNode.id&&(e=[i,t.target.parentNode.id]),c.setSelectIdArray(e)}else{i=c.selectIDs.indexOf(t.target.parentNode.id);-1!==i?c.selectIDs.splice(i,1):c.selectIDs.push(t.target.parentNode.id),c.setSelectIdArray(c.selectIDs)}else{c.setSelectIdArray([]);var i=d.getBoundingClientRect(),o=t.clientX-i.left,n=t.clientY-i.top;let e=null;e=t.target.aspect?t.target.querySelector("img"):"divBoxSub2"==t.target.className?t.target.parentNode.parentNode.querySelector("img"):"divBoxSub"==t.target.className?t.target.parentNode.querySelector("img"):t.target;var r=o<=15&&n<=15,s=o>=i.width-15&&n<=15,a=o<=15&&n>=i.height-15,o=o>=i.width-15&&n>=i.height-15;if((r||s||a||o)&&c.enableMove)c._isResizing=!0,c.onLMouseDown(t),c.startWidth=e.offsetWidth,c.startHeight=e.offsetHeight,c.stratLeft=parseInt(e.parentNode.style.left),c.startTop=parseInt(e.parentNode.style.top),c.startX=t.clientX,c.startY=t.clientY,t.target.aspect?c._currentTarget=t.target.querySelector("img"):"divBoxSub2"==t.target.className?c._currentTarget=t.target.parentNode.parentNode.querySelector("img"):"divBoxSub"==t.target.className?c._currentTarget=t.target.parentNode.querySelector("img"):c._currentTarget=t.target,r&&(c.cornerStyle=0),s&&(c.cornerStyle=1),a&&(c.cornerStyle=2),o&&(c.cornerStyle=3);else{c.enableMove&&(c._isDragging=!0);for(let e=0;e<c.PicContents.length;e++)c.PicContents[e].style.zIndex=7;t.target.parentNode.style.zIndex=9,c.onLMouseDown(t),c._currentTarget=t.target,c.startX=t.clientX-t.target.parentNode.offsetLeft,c.startY=t.clientY-t.target.parentNode.offsetTop,d.style.cursor="default"}for(let e=0;e<c.PicContents.length;e++){var l=c.PicContents[e];l.style.border="2px solid rgba(255, 195, 0, 0.0)",Array.from(l.querySelectorAll(".divBoxSub")).forEach(e=>{e.style.display="none"})}n={id:e.parentNode.id,filename:e.parentNode.filename,configNum:c.viewer.ConfigNum,configName:c.viewer.ConfigName,type:"Pic",name:e.parentNode.animationName,animationID:e.parentNode.animationID};c.viewer.dispatchEvent({type:"PicSelect",data:[n]}),e.parentNode.style.border="2px solid rgba(255, 195, 0, 1.0)",Array.from(e.parentNode.querySelectorAll(".divBoxSub")).forEach(e=>{e.style.display="block"}),c.picSelectID=t.target.parentNode.id,t.ctrlKey||(c.picSelectIDs=[]),c.picSelectIDs.includes(t.target.parentNode.id)||c.picSelectIDs.push(t.target.parentNode.id)}d.readOnly=!1,d.focus(),d.blur(),c.viewer.dispatchEvent({type:"exitNote"}),c.clearFlag(),c.setMode("Picture"),document.addEventListener("mouseup",h)}});var s={id:r,configNum:c.viewer.ConfigNum,configName:c.viewer.ConfigName,name:t,type:"Pic",animationID:d.animationID};this.viewer.container.appendChild(d),this.PicContents.push(d),i.src=e,i.onload=function(){"OpAnnotationNew"==c.viewer.getCurrentOperatorID()?(i.height>i.width?(i.style.height="160px",i.style.width=160*i.width/i.height+"px"):(i.style.height=160*i.height/i.width+"px",i.style.width="160px"),d.aspect=i.width/i.height,i.style.display="block",d.style.top="19px",d.style.left="56px",c.viewer.dispatchEvent({type:"PicAdd",data:s}),c.viewer.dispatchEvent({type:"PicSelect",data:[]}),c.picSelectIDs=[],c.setMode("normal"),c.viewer.setOperatorByID("OpOrbit")):d.aspect=i.width/i.height},i.onerror=function(){c.deleteNoteAnnotation(r)};for(let e=0;e<c.PicContents.length;e++){var a=c.PicContents[e];a.style.border="2px solid rgba(255, 195, 0, 0.0)",a.style.zIndex=7,Array.from(a.querySelectorAll(".divBoxSub")).forEach(e=>{e.style.display="none"})}c.setSelectId(0),c.picSelectID=0},a.prototype.getTextLineImgPosition=function(t){for(let e=0;e<this.PicContents.length;e++){var i=this.PicContents[e];if(i.id==t)return{x:parseInt(i.style.left),y:parseInt(i.style.top),z:0,type:"pic"}}for(let e=0;e<this.TextContents.length;e++){var o=this.TextContents[e];if(o.id==t)return{x:o.pos.x,y:o.pos.y,z:o.pos.z,type:"LineText",oriPos:o.oriPos}}return null},a.prototype.setTextLineImgPosition=function(t,i){for(let e=0;e<this.PicContents.length;e++){var o=this.PicContents[e];if(o.id==t){o.style.left=i.x+"px",o.style.top=i.y+"px";break}}for(let e=0;e<this.TextContents.length;e++){var n=this.TextContents[e];if(n.id==t){var r=new THREE.Vector3(i.x,i.y,i.z);n.pos=r;break}}},a.prototype.createDiv=function(){var t=document.createElement("div"),e=(t.animationID=this.viewer.AnimationEdit&&this.viewer.AnimationEdit._activeAnimationID,t.AnimationEdit=NDSWebViewer.SETTING.AnimationEdit,document.createElement("textarea"));let l=this;function a(e){var i=e.value.split("\n");let o=0;for(let e=0;e<i.length;e++){var n=i[e];let t=0;for(let e=0;e<n.length;e++){var r=8200<=n[e].charAt(0).charCodeAt(0);t+=r?2:1}o<t&&(o=t)}var t="en"==NDSWebViewer.COMMON.getLanguage()||NDSWebViewer.COMMON.isMobileDevice()||NDSWebViewer.COMMON.isIOSDevice()?10:8;e.style.width=Math.round(o*t)+"px",Math.round(o*t)<44&&(e.style.width="44px"),NDSWebViewer.COMMON.isMobileDevice()&&160<Math.round(o*t)&&(e.style.width="160px")}if(NDSWebViewer.COMMON.isMobileDevice()&&(e.rows="1"),e.style.height="20px",e.style.width="auto",e.style.overflow="hidden",e.style.fontSize="14px",e.style.lineHeight="20px",e.style.cursor="default",e.style.userSelect="none",e.style.border="1px solid #FF0000",e.style.backgroundColor="hsla(0,0%,100%,.5)",e.setAttribute("autocomplete","off"),NDSWebViewer.COMMON.isMobileDevice())e.addEventListener("touchmove",function(e){var t={x:e.touches[0].clientX,y:e.touches[0].clientY};if(!(Math.abs(l.startX-e.clientX)<3&&Math.abs(l.startY-e.clientY)<3)){if("NoteEdit"!=l.mode&&(e.preventDefault(),e.stopImmediatePropagation(),e.stopPropagation(),e.target.selectionStart=e.target.selectionEnd=0,e.target.readOnly=!0),"NoteMove"==l.mode){e.target.readOnly=!0;var e=new THREE.Plane,i=l.viewer.camera.getCameraTarget(),o=l.viewer.camera.position,n=new THREE.Vector3,i=(n.subVectors(i,o),t),o=(e.setFromNormalAndCoplanarPoint(n.normalize(),l.MoveTarget.interPnt),l.clientCoordToModelCoordOnPlane(i.x,i.y,e)),r=(l.MoveTarget.pos=o,l.viewer.ndsModel.getBodyNodeFromUuid(l.MoveTarget.bodyUuid,l.MoveTarget.ndsModelId));if(r){var s=new THREE.Vector3(0,0,0),a=NDSWebViewer.ExtensionManager.getExtensionWithFlags(NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM);for(let e=0,t=a.length;e<t;++e)s.add(a[e].getBodyNodeTranslate(r));t=[s.x,s.y,s.z];l.MoveTarget.pos.set(l.MoveTarget.pos.x-t[0],l.MoveTarget.pos.y-t[1],l.MoveTarget.pos.z-t[2])}l.changeAnnotation(l.MoveTarget.interPnt,l.MoveTarget.pos,l.MoveTarget)}l.update2DScene(),l.viewer.render()}}),e.addEventListener("touchstart",function(e){l.startX=e.clientX,l.startY=e.clientY,"NotePlace"==l.mode?l.onTouchSingle(e):(l.onLMouseDown(e),l.selectID!=e.target.parentNode.id&&-1==l.selectIDs.indexOf(e.target.parentNode.id)||"NoteEdit"==l.mode||!l.enableMove||(l.oldmode=l.mode,l.mode="NoteMove",l.MoveTarget=e.target.parentNode),e.target.readOnly=!0,e.target.blur())}),e.addEventListener("touchend",function(e){if("NoteMove"==l.mode){l.MoveTarget=null,l.mode=l.oldmode,"NoteMove"==l.mode&&(l.mode="normal"),e.target.readOnly=!1;let t=e.target.parentNode;var i=l.viewer.ndsModel.getBodyNodeFromUuid(t.bodyUuid,t.ndsModelId),o=[],i=(i&&o.push(i.objectid),{id:t.id,uuid:t.id,configNum:l.viewer.ConfigNum,configName:l.viewer.ConfigName,interPnt:t.interPnt,projPt:t.pos,text:t.childNodes[0].value,bodyUuid:t.bodyUuid,origiType:"lineNote",name:t.animationName,animationID:t.animationID,ndsModelId:t.ndsModelId,objectId:o}),o={tagId:i.id,text:i.text,state:i,modelName:i.configName};!t.PointMeasure&&t.hasAdd&&l.viewer.dispatchEvent({type:"NoteChange",data:NDSWebViewer.SETTING.AnimationEdit?o.state:o,editNote:function(e){e?t.oldText=t.childNodes[0].value:(t.childNodes[0].value=t.oldText,a(t.childNodes[0]),NDSWebViewer.COMMON.isMobileDevice()&&(t.childNodes[0].style.height="auto",t.childNodes[0].style.height=t.childNodes[0].scrollHeight+"px"))}})}l.onLMouseUp(e)});else{e.addEventListener("mousemove",function(e){var t={clientX:e.clientX,clientY:e.clientY};Math.abs(l.startX-e.clientX)<3&&Math.abs(l.startY-e.clientY)<3||("NoteEdit"!=l.mode&&(e.preventDefault(),e.stopImmediatePropagation(),e.stopPropagation(),e.target.selectionStart=e.target.selectionEnd=0,e.target.readOnly=!0),"NotePlace"==l.mode?l.onNMouseMove(t):"NoteMove"==l.mode&&l.onLMouseMove(t),l.update2DScene())}),e.addEventListener("mouseover",function(e){!l.Textbox||"单击确定位置"!=l.Textbox.childNodes[0].value&&"Click to choose the location for the comment."!=l.Textbox.childNodes[0].value||(l.Textbox.style.visibility="hidden")}),e.addEventListener("mousedown",function(e){var t={clientX:e.clientX,clientY:e.clientY};l.startX=e.clientX,l.startY=e.clientY,"NotePlace"==l.mode?l.onLMouseClick(t):(l.onLMouseDown(e),l.selectID!=e.target.parentNode.id&&-1==l.selectIDs.indexOf(e.target.parentNode.id)||"NoteEdit"==l.mode||!l.enableMove||(l.oldmode=l.mode,l.mode="NoteMove",l.MoveTarget=e.target.parentNode),e.target.readOnly=!0,e.target.blur())});let s=null;e.addEventListener("mouseup",function(e){if("NoteMove"==l.mode){l.MoveTarget=null,l.mode=l.oldmode,"NoteMove"==l.mode&&(l.mode="normal"),e.target.readOnly=!1;let t=e.target.parentNode;var i=l.viewer.ndsModel.getBodyNodeFromUuid(t.bodyUuid,t.ndsModelId),o=[],i=(i&&o.push(i.objectid),{id:t.id,uuid:t.id,configNum:l.viewer.ConfigNum,configName:l.viewer.ConfigName,interPnt:t.interPnt,projPt:t.pos,text:t.childNodes[0].value,bodyUuid:t.bodyUuid,origiType:"lineNote",name:t.animationName,animationID:t.animationID,ndsModelId:t.ndsModelId,objectId:o}),n={tagId:i.id,text:i.text,state:i,modelName:i.configName};function r(e){e?t.oldText=t.childNodes[0].value:(t.childNodes[0].value=t.oldText,a(t.childNodes[0]),NDSWebViewer.COMMON.isMobileDevice()&&(t.childNodes[0].style.height="auto",t.childNodes[0].style.height=t.childNodes[0].scrollHeight+"px"))}!t.PointMeasure&&t.hasAdd&&(s?(clearTimeout(s),s=null,l.viewer.dispatchEvent({type:"NoteChange",data:NDSWebViewer.SETTING.AnimationEdit?n.state:n,editNote:r})):s=setTimeout(()=>{s=null,l.viewer.dispatchEvent({type:"NoteChange",data:NDSWebViewer.SETTING.AnimationEdit?n.state:n,editNote:r})},300))}l.onLMouseUp(e)}),e.addEventListener("mouseleave",function(e){document.addEventListener("mouseup",l.onMouseUp,!1)}),e.addEventListener("mouseenter",function(e){document.removeEventListener("mouseup",l.onMouseUp,!1)})}e.addEventListener("input",function(e){a(e.target);var t=e.target.value.split("\n").length;NDSWebViewer.COMMON.isMobileDevice()?(e.target.style.height="auto",e.target.style.height=e.target.scrollHeight+"px"):e.target.style.height=22*t+"px",l.update2DScene(),l.viewer.render()}),e.addEventListener("keydown",function(e){e.stopPropagation(),e.stopImmediatePropagation();var t;e.altKey&&"Enter"===e.key?(e.target.selectionStart==e.target.selectionEnd?(t=e.target.selectionStart,NDSWebViewer.COMMON.isIOSDevice()||(e.target.value=e.target.value.slice(0,t)+"\n"+e.target.value.slice(t)),e.target.selectionStart=e.target.selectionEnd=t+1):NDSWebViewer.COMMON.isIOSDevice()||(e.target.value+="\n"),a(e.target),NDSWebViewer.COMMON.isMobileDevice()?(e.target.style.height="auto",e.target.style.height=e.target.scrollHeight+"px"):(t=e.target.value.split("\n").length,e.target.style.height=22*t+"px"),l.update2DScene()):"Enter"===e.key?e.target.blur():"Delete"===e.key&&"NoteEdit"!=l.mode&&l.enableMove&&l.onKeyDown(e)}),e.addEventListener("click",function(t){var i=NDSWebViewer.ExtensionManager.getExtension("NDSAnimationExtension");if(!(i&&i._enableAnimation&&i.isrunning())){i={clientX:t.clientX,clientY:t.clientY};if(t.preventDefault(),t.stopImmediatePropagation(),t.stopPropagation(),!(3<Math.abs(l.startX-t.clientX)||3<Math.abs(l.startY-t.clientY))&&l.checkIsAllow(t.target.parentNode.id)){for(let e=0;e<l.PicContents.length;e++){var o=l.PicContents[e];o.style.border="2px solid rgba(255, 195, 0, 0.0)",o.style.zIndex=7,Array.from(o.querySelectorAll(".divBoxSub")).forEach(e=>{e.style.display="none"})}if(0==l.picSelectID||t.ctrlKey||(l.picSelectID=0),l.viewer.dispatchEvent({type:"PicSelect",data:[]}),l.picSelectIDs=[],"NotePlace"==l.mode)l.onLMouseClick(i),t.target.blur();else if("NoteEdit"!=l.mode)if(t.target.parentNode.hasAdd)if(t.ctrlKey)if(0!=l.selectID||0!=l.picSelectID){let e=[];i=0!=l.picSelectID?l.picSelectID:l.selectID;l.picSelectID!=t.target.parentNode.id&&(e=[i,t.target.parentNode.id]),l.setSelectIdArray(e)}else{i=l.selectIDs.indexOf(t.target.parentNode.id);-1!==i?l.selectIDs.splice(i,1):l.selectIDs.push(t.target.parentNode.id),l.setSelectIdArray(l.selectIDs)}else t.target.parentNode.id&&l.setSelectId(t.target.parentNode.id),t.target.style.border="1px solid #FFC300",t.target.readOnly=!0,t.target.blur(),t.target.style.userSelect="none",t.target.style.cursor="move";else t.target.readOnly=!1,t.target.focus();l.update2DScene()}}}),e.addEventListener("dblclick",function(e){var t=NDSWebViewer.ExtensionManager.getExtension("NDSAnimationExtension");t&&t._enableAnimation||l.checkIsAllow(e.target.parentNode.id)&&(e.target.readOnly=!1,e.target.focus(),l.selectID!=e.target.parentNode.id&&(e.target.parentNode.id,l.setSelectId(e.target.parentNode.id),e.target.style.border="1px solid #FFC300"),e.target.selectionStart=e.target.selectionEnd=e.target.value.length,e.target.style.userSelect="auto",e.target.style.cursor="default",e.preventDefault(),e.stopImmediatePropagation(),e.stopPropagation(),l.setMode("NoteEdit"),l.viewer.CADViewer)&&l._addEditDel()}),e.addEventListener("blur",function(e){let t=e.target.parentNode;var i;""!=t.id&&t.id&&(t.hasAdd||(e=[],(i=l.viewer.ndsModel.getBodyNodeFromUuid(t.bodyUuid,t.ndsModelId))&&e.push(i.objectid),e={tagId:(i={id:t.id,uuid:t.id,configNum:l.viewer.ConfigNum,configName:l.viewer.ConfigName,interPnt:t.interPnt,projPt:t.pos,text:t.childNodes[0].value,bodyUuid:t.bodyUuid,origiType:"lineNote",name:t.animationName,animationID:t.animationID,ndsModelId:t.ndsModelId,objectId:e}).id,text:i.text,state:i,modelName:i.configName},t.hasAdd=!0,l.setSelectId(0),"OpAnnotationNew"==l.viewer.getCurrentOperatorID()&&l.viewer.dispatchEvent({type:"NoteAdd",data:NDSWebViewer.SETTING.AnimationEdit?e.state:e,addNote:function(e){e?t.oldText=t.childNodes[0].value:l.deleteNoteAnnotation(t.id,!1)}})),"OpAnnotationNew"==l.viewer.getCurrentOperatorID()&&"NotePlace"!=l.mode&&"Picture"!=l.mode?l.createText():"NoteEdit"==l.mode&&l.setMode("normal"),l.viewer)&&l.viewer.AnimationEdit&&l.viewer.AnimationEdit.resetContainerStyle()}),e.addEventListener("change",function(e){let t=e.target.parentNode;var e=l.viewer.ndsModel.getBodyNodeFromUuid(t.bodyUuid,t.ndsModelId),i=[],e=(e&&i.push(e.objectid),{id:t.id,uuid:t.id,configNum:l.viewer.ConfigNum,configName:l.viewer.ConfigName,interPnt:t.interPnt,projPt:t.pos,text:t.childNodes[0].value,bodyUuid:t.bodyUuid,origiType:"lineNote",name:t.animationName,animationID:t.animationID,ndsModelId:t.ndsModelId,objectId:i}),i={tagId:e.id,text:e.text,state:e,modelName:e.configName};!t.PointMeasure&&t.hasAdd&&l.viewer.dispatchEvent({type:"NoteChange",data:NDSWebViewer.SETTING.AnimationEdit?i.state:i,editNote:function(e){e?t.oldText=t.childNodes[0].value:(t.childNodes[0].value=t.oldText,a(t.childNodes[0]),NDSWebViewer.COMMON.isMobileDevice()&&(t.childNodes[0].style.height="auto",t.childNodes[0].style.height=t.childNodes[0].scrollHeight+"px"))}})});var i="en"==NDSWebViewer.COMMON.getLanguage();if(NDSWebViewer.COMMON.isMobileDevice()){t.style.visibility="hidden";let e=NDSWebViewer.COMMON.translateString("ANNOTATION_location");setTimeout(()=>{l._clearMsgInfo||l.PostInfo(e)},50)}else e.value=NDSWebViewer.COMMON.translateString("ANNOTATION_location"),e.style.width=i?45*8.2+"px":"132px";return e.style.textAlign="left",t.style.position="absolute",t.style.zIndex=NDSWebViewer.COMMON.isMobileDevice()?2:7,t.Inflection=!0,t.appendChild(e),t},a.prototype.mouseMoveByEvent=function(e){var t;e.preventDefault(),e.stopImmediatePropagation(),e.stopPropagation(),"NotePlace"==this.mode?this.onNMouseMove(e):"NoteMove"==this.mode?this.onLMouseMove(e):"Picture"==this.mode&&this._isDragging&&this.state==NDSWebViewer.NDS.MOUSE.LEFT&&(t=Math.round(e.clientX-this.startX),e=Math.round(e.clientY-this.startY),this._currentTarget.parentNode.style.left=t+"px",this._currentTarget.parentNode.style.top=e+"px")},a.prototype.createDivPic=function(e,t,i){let a=document.createElement("div"),d=document.createElement("img"),c=this;return d.setAttribute("src",e),d.onload=function(){d.height>d.width?(d.style.height=t+"px",d.style.width=t*d.width/d.height+"px"):(d.style.height=t*d.height/d.width+"px",d.style.width=t+"px"),a.aspect=d.width/d.height,c.setPicTextVisible(i,!0)},d.addEventListener("mousemove",function(t){var i={clientX:t.clientX,clientY:t.clientY};if(c._isResizing&&c.state==NDSWebViewer.NDS.MOUSE.LEFT)c.reSize(t),c.viewer.render();else{if(c._isDragging&&c.state==NDSWebViewer.NDS.MOUSE.LEFT)c.onLMouseMove(i);else if(c.state==NDSWebViewer.NDS.MOUSE.LEFT){var i=t.clientX-c.viewer.container.getBoundingClientRect().left,o=t.clientY-c.viewer.container.getBoundingClientRect().top;c.pointer.set(i,o),NDSWebViewer.OpBase.prototype.onLMouseMove.call(c,t),c.pointerOld.set(i,o)}else if(c.state==NDSWebViewer.NDS.MOUSE.MIDDLE)c.onMMouseMove(t);else{var i=a.getBoundingClientRect(),o=t.clientX-i.left,n=t.clientY-i.top,r=o>=i.width-20&&n<=20,s=o<=20&&n>=i.height-20,i=o>=i.width-20&&n>=i.height-20;let e;e=o<=20&&n<=20||i?"nwse-resize":r||s?"nesw-resize":"default",a.style.cursor!=e&&(a.style.cursor=e,d.style.cursor=a.style.cursor)}Math.abs(c.startX-t.clientX)<3&&Math.abs(c.startY-t.clientY)<3||(c.update2DScene(),c.viewer.render())}}),d.addEventListener("mousewheel",function(e){c.onMouseWheel(e,!0),c.viewer.render()}),d.addEventListener("mousedown",function(t){if(t.preventDefault(),t.stopImmediatePropagation(),t.stopPropagation(),c.checkIsAllow(t.target.parentNode.id)){c.startX=t.clientX,c.startY=t.clientY,c.onLMouseDown(t),c.selectID!=t.target.parentNode.id&&-1==c.selectIDs.indexOf(t.target.parentNode.id)||"NoteEdit"==c.mode||!c.enableMove||(c.oldmode=c.mode,c.mode="NoteMove",c.MoveTarget=t.target.parentNode);var i=t.target.parentNode,o=t.target.parentNode.getBoundingClientRect(),n=Math.abs(t.clientX-o.left),r=Math.abs(t.clientY-o.top);let e;var s=n<=20&&r<=20,a=n>=o.width-20&&r<=20,l=n<=20&&r>=o.height-20,n=n>=o.width-20&&r>=o.height-20;(s||a||l||n)&&c.enableMove?(c._isResizing=!0,c.onLMouseDown(t),c.startWidth=t.target.parentNode.children[0].offsetWidth,c.startHeight=t.target.parentNode.children[0].offsetHeight,c.stratLeft=parseInt(t.target.parentNode.style.left),c.startTop=parseInt(t.target.parentNode.style.top),c.startX=t.clientX,c.startY=t.clientY,c._currentTarget=t.target,s&&(c.cornerStyle=0),a&&(c.cornerStyle=1),l&&(c.cornerStyle=2),n&&(c.cornerStyle=3),s||n?e="nwse-resize":(a||l)&&(e="nesw-resize"),c.setMode("picNote")):(c._isDragging=!0,t.target.parentNode.style.zIndex=21,c._currentTarget=t.target,c.startX=t.clientX-t.target.parentNode.offsetLeft,c.startY=t.clientY-t.target.parentNode.offsetTop,e="default"),i.style.cursor!=e&&(i.style.cursor=e,d.style.cursor=i.style.cursor),i.readOnly=!1,i.focus(),i.blur()}}),d.addEventListener("mouseup",function(e){e.preventDefault(),e.stopImmediatePropagation(),e.stopPropagation(),c.checkIsAllow(e.target.parentNode.id)&&("NoteMove"==c.mode&&(c.mode=c.oldmode,"NoteMove"==c.mode&&(c.mode="normal"),e.target.readOnly=!1),c.onLMouseUp(e))}),d.addEventListener("click",function(t){if(t.preventDefault(),t.stopImmediatePropagation(),t.stopPropagation(),c.checkIsAllow(t.target.parentNode.id)){for(let e=0;e<c.PicContents.length;e++)c.PicContents[e].style.border="2px solid rgba(255, 195, 0, 0.0)";if(0==c.picSelectID||t.ctrlKey||(c.picSelectID=0,c.viewer.dispatchEvent({type:"PicSelect",data:[]}),c.picSelectIDs=[]),t.ctrlKey)if(0!=c.selectID||0!=c.picSelectID){let e=[];var i=0!=c.picSelectID?c.picSelectID:c.selectID;c.picSelectID!=t.target.parentNode.id&&(e=[i,t.target.parentNode.id]),c.setSelectIdArray(e)}else{i=c.selectIDs.indexOf(t.target.parentNode.id);-1!==i?c.selectIDs.splice(i,1):c.selectIDs.push(t.target.parentNode.id),c.setSelectIdArray(c.selectIDs)}else t.target.parentNode.id&&c.setSelectId(t.target.parentNode.id),t.target.style.border="1px solid #FFC300";c.update2DScene()}}),d.addEventListener("mouseleave",function(e){document.addEventListener("mouseup",c.onMouseUp,!1)}),d.addEventListener("mouseenter",function(e){document.removeEventListener("mouseup",c.onMouseUp,!1)}),d.addEventListener("keydown",function(e){e.stopPropagation(),e.stopImmediatePropagation(),"Delete"===e.key&&c.enableMove&&c.onKeyDown(e)}),a.tabIndex=this._tabIndex++,a.style.position="fixed",a.style.zIndex=NDSWebViewer.COMMON.isMobileDevice()?2:7,a.appendChild(d),a},a.prototype.dispatchNoteChange=function(e){var t={id:e.id,interPnt:e.interPnt,projPt:e.pos,text:e.childNodes[0].value,bodyUuid:e.bodyUuid,configNum:this.viewer.ConfigNum,configName:this.viewer.ConfigName,type:"Note"};e.hasAdd&&!e.PointMeasure&&this.viewer.dispatchEvent({type:"NoteChange",data:t}),this.Textbox?"单击确定位置"==this.Textbox.childNodes[0].value||"Click to choose the location for the comment."==this.Textbox.childNodes[0].value?this.setMode("Note"):this.setMode("NotePlace"):this.setMode("normal"),NDSWebViewer.SETTING.enableBroadcast&&NDSWebViewer.SETTING.broadcastMajor&&NDSWebViewer.ExtensionManager.updateBroadcastInfo("AnnotationExtension")},a.prototype.createText=function(){var e;this.setMode("Note"),this.Textbox||(this._clearMsgInfo=!1,e=this.createDiv(),this.viewer.container.appendChild(e),this.Textbox=e,this.Textbox.isPic=!1,this.Textbox.style.left="-500px",this.Textbox.style.top="0px")},a.prototype.createPicNote=function(e,t=null,i=null,o="",n=!1,r=160){let s=null;var a=this.getUUid();if(i)this.setMode("picNote"),(s=this.createDivPic(i,r,a)).isPic=!0;else{this.setMode("normal"),(s=this.createDiv()).isPic=!1,s.childNodes[0].value=o;var l=s.childNodes[0].value.split("\n");let i=0;for(let e=0;e<l.length;e++){var d=l[e];let t=0;for(let e=0;e<d.length;e++){var c=8200<=d[e].charAt(0).charCodeAt(0);t+=c?2:1}i<t&&(i=t)}r="en"==NDSWebViewer.COMMON.getLanguage()?9:8,r=(s.childNodes[0].style.width=Math.round(i*r)+"px",Math.round(i*r)<44&&(s.childNodes[0].style.width="44px"),l.length);s.childNodes[0].style.height=22*r+"px",s.hasAdd=!0,s.NoEdit=!0,s.childNodes[0].style.backgroundColor="#FFFFFF",s.childNodes[0].style.fontSize="16px",s.childNodes[0].style.lineHeight="22px",s.childNodes[0].style.textAlign="left",s.childNodes[0].style.border="1px solid #FF6302",NDSWebViewer.COMMON.getLanguage();""==o&&(s.childNodes[0].placeholder=NDSWebViewer.COMMON.translateString("PMI_Text"))}this.viewer.container.appendChild(s),s.Inflection=n,s.id=a;var r=this.viewer.modelRootObject.boundingBox.getCenter(),o=(new THREE.Vector3).subVectors(r,e.clone()).normalize(),n=new THREE.Ray(e.clone(),o),r=this.viewer.ndsModel.intersect(n,null,!0),o=((r&&r.length%2!=0||r&&r[0]&&e.distanceTo(r[0].point)<1e-4)&&(s.bodyUuid=r[0].bodyUuid,s.newPoint=new THREE.Vector3,s.newPos=new THREE.Vector3),s.interPnt=new THREE.Vector3(e.x,e.y,e.z),new THREE.Mesh(new THREE.SphereGeometry(1),this.materialPoint.clone())),n=(o.position.set(s.interPnt.x,s.interPnt.y,s.interPnt.z),this.setPointScale(o,this.POINTSIZE),o.objectType="Point",o.textID=a,o.AnimationEdit=s.AnimationEdit,o.Point=o.position.clone(),this.AnnotationShow||(s.style.visibility="hidden",o.visible=!1),new THREE.Plane),r=this.viewer.camera.getCameraTarget(),e=this.viewer.camera.position,h=new THREE.Vector3;h.subVectors(r,e),n.setFromNormalAndCoplanarPoint(h.normalize(),s.interPnt);let p;t?(p=new THREE.Vector3(t.x,t.y,t.z),0<this.viewer.ndsModel.ModelUpMatrix4.length&&((r=new THREE.Matrix4).fromArray(this.viewer.ndsModel.ModelUpMatrix4),p.applyMatrix4(r))):(e=[s.interPnt.x,s.interPnt.y,s.interPnt.z],h=this.viewer.modelCoordToClientCoord(e),p=245<h[0]&&185<h[1]?this.clientCoordToModelCoordOnPlane(h[0]-45,h[1]-45,n):this.clientCoordToModelCoordOnPlane(200,139,n)),s.pos=p,s.oriPos={x:p.x,y:p.y,z:p.z},s.PointMeasure=!0,this.rootObject.add(o),this.TextContents.push(s),i&&(s.readOnly=!1,s.focus(),s.blur(),s.aspect||this.setPicTextVisible(a,!1)),this.viewer.render()},a.prototype.setSelectId=function(t,e=!0){e&&0==t&&(0!=this.selectID&&null!=this.selectID||0<this.selectIDs.length)&&(this.selectID=t,this.selectIDs=[],this.viewer.dispatchEvent({type:"NoteSelect",num:0,data:[]})),this.selectID=t,this.selectIDs=[];for(let e=0;e<this.TextContents.length;e++){var i,o,n=this.TextContents[e];n.hasAdd&&(n.id==t?(n.childNodes[0].style.cursor="move",n.style.zIndex=NDSWebViewer.COMMON.isMobileDevice()?3:9,o=[],(i=this.viewer.ndsModel.getBodyNodeFromUuid(n.bodyUuid,n.ndsModelId))&&o.push(i.objectid),o={tagId:(i={id:n.id,uuid:n.id,interPnt:n.interPnt,projPt:n.pos,text:n.childNodes[0].value,configNum:this.viewer.ConfigNum,configName:this.viewer.ConfigName,bodyUuid:n.bodyUuid,origiType:"lineNote",name:n.animationName,animationID:n.animationID,ndsModelId:n.ndsModelId,objectId:o}).id,text:i.text,state:i,modelName:i.configName},n.PointMeasure||this.viewer.dispatchEvent({type:"NoteSelect",data:NDSWebViewer.SETTING.AnimationEdit?[o.state]:[o],num:1})):(n.childNodes[0].style.cursor="default",n.childNodes[0].readOnly=!0,n.style.zIndex=NDSWebViewer.COMMON.isMobileDevice()?2:7))}this.viewer.CADViewer&&this._addEditDel(),this.viewer.render(),this.update2DScene()},a.prototype.setSelectTextName=function(t,e){var i;Array.isArray(this.TextContents)&&(i=this.TextContents.find(e=>e.id==t))&&(i.animationName=e)},a.prototype.setSelectImgName=function(t,e){var i;Array.isArray(this.PicContents)&&(i=this.PicContents.find(e=>e.id==t))&&(i.animationName=e)},a.prototype.setSelectIdArray=function(e,t=!0){e=e.filter(e=>this.checkIsAllow(e)),this.selectIDs=e,this.selectID=0;var i=[],o=[];for(let e=this.picSelectID=0;e<this.TextContents.length;e++){var n,r,s=this.TextContents[e];s.hasAdd&&(s.childNodes[0].style.cursor="default",s.childNodes[0].readOnly=!0,s.style.zIndex=NDSWebViewer.COMMON.isMobileDevice()?2:7,-1!=this.selectIDs.indexOf(s.id))&&(s.childNodes[0].style.cursor="move",s.style.zIndex=NDSWebViewer.COMMON.isMobileDevice()?3:9,"hidden"!=s.style.visibility)&&(n=[],(r=this.viewer.ndsModel.getBodyNodeFromUuid(s.bodyUuid,s.ndsModelId))&&n.push(r.objectid),r={tagId:(a={id:s.id,uuid:s.id,interPnt:s.interPnt,projPt:s.pos,text:s.childNodes[0].value,configNum:this.viewer.ConfigNum,configName:this.viewer.ConfigName,bodyUuid:s.bodyUuid,origiType:"lineNote",name:s.animationName,animationID:s.animationID,ndsModelId:s.ndsModelId,objectId:n}).id,text:a.text,state:a,modelName:a.configName},i.push(NDSWebViewer.SETTING.AnimationEdit?r.state:r))}for(let e=0;e<this.PicContents.length;e++){var a,l=this.PicContents[e];l.style.border="2px solid rgba(255, 195, 0, 0.0)",Array.from(l.querySelectorAll(".divBoxSub")).forEach(e=>{e.style.display="none"}),-1!=this.selectIDs.indexOf(l.id)&&(a={id:l.id,filename:l.filename,configNum:this.viewer.ConfigNum,configName:this.viewer.ConfigName,type:"Pic",name:l.animationName,animationID:l.animationID},l.style.border="2px solid rgba(255, 195, 0, 1.0)",l.style.zIndex=9,Array.from(l.querySelectorAll(".divBoxSub")).forEach(e=>{e.style.display="block"}),"hidden"!=l.style.visibility)&&(o.push(a),this.picSelectIDs.includes(a.id)||this.picSelectIDs.push(a.id))}t&&(this.viewer.dispatchEvent({type:"NoteSelect",data:i,num:i.length}),this.viewer.dispatchEvent({type:"PicSelect",data:o,num:o.length})),this.viewer.CADViewer&&this._addEditDel(),this.viewer.render(),this.update2DScene()},a.prototype.checkIsAllow=function(e){return!this.spliteMode||this.allowIds.includes(e)},a.prototype.setSplitMode=function(e,t){this.spliteMode=e,this.spliteMode?this.allowIds=t:this.allowIds=[]},a.prototype.reSize=function(e){let t,i,o,n,r,s;switch(n=this.stratLeft,o=this.startTop,r=this.stratLeft+this.startWidth,s=this.startTop+this.startHeight,this.cornerStyle){case 0:t=this.startWidth-(e.clientX-this.startX),i=this.startHeight-(e.clientY-this.startY),n=r-t,o=s-i;break;case 1:t=this.startWidth+(e.clientX-this.startX),i=this.startHeight-(e.clientY-this.startY),o=s-i;break;case 2:t=this.startWidth-(e.clientX-this.startX),i=this.startHeight+(e.clientY-this.startY),n=r-t;break;case 3:t=this.startWidth+(e.clientX-this.startX),i=this.startHeight+(e.clientY-this.startY)}let a=t,l=i;var d=this._currentTarget.parentNode.aspect;if(parseFloat(t)/parseFloat(i)>d?l=t/d:a=i*d,!(a<40||l<40||430<l||800<a)||this._currentTarget.parentNode.PointMeasure){switch(this.cornerStyle){case 0:n=r-a,o=s-l;break;case 1:o=s-l;break;case 2:n=r-a}this._currentTarget.parentNode.children[0].style.width=a+"px",this._currentTarget.parentNode.children[0].style.height=l+"px",this._currentTarget.parentNode.style.display="flex",this._currentTarget.parentNode.style["justify-content"]="center",this._currentTarget.parentNode.style["align-items"]="center",this._currentTarget.parentNode.style.width=a+"px",this._currentTarget.parentNode.style.height=l+"px",this._currentTarget.parentNode.style.left=n+"px",this._currentTarget.parentNode.style.top=o+"px"}},a.prototype.setMode=function(e){this.mode=e},a.prototype.get2dPoint=function(e){e.project(this.viewer.camera);var t=this.viewer.renderer.domElement.width/2,i=this.viewer.renderer.domElement.height/2,t=e.x*t+t,e=-e.y*i+i,i=this.viewer.renderer.getPixelRatio(),t=this.remapCoordnidateToViewPort(t/i,e/i);return{x:Math.round(t[0]*i),y:Math.round(t[1]*i)}},a.prototype.changeAnnotation=function(e,t,i){t=this.get2dPoint(t.clone()),e=this.get2dPoint(e.clone()),e=new THREE.Vector2(t.x-e.x,t.y-e.y),e.normalize(),e.y>=2*e.x&&e.y>=2*-e.x?(i.setAttribute("mobile","down"),i.style.left=parseInt((t.x-parseInt(i.childNodes[0].style.width)*this.dpr/2)/this.dpr)+"px",i.style.top=parseInt(t.y/this.dpr)+"px"):e.y>2*e.x&&e.y<2*-e.x?(i.setAttribute("mobile","right"),i.style.left=parseInt((t.x-parseInt(i.childNodes[0].style.width)*this.dpr)/this.dpr)+"px",i.style.top=parseInt((t.y-parseInt(i.childNodes[0].style.height)*this.dpr/2)/this.dpr)+"px"):e.y<2*e.x&&e.y<2*-e.x?(i.setAttribute("mobile","up"),i.style.left=parseInt((t.x-parseInt(i.childNodes[0].style.width)/2)/this.dpr)+"px",i.style.top=parseInt((t.y-parseInt(i.childNodes[0].style.height))/this.dpr)+"px"):e.y<2*e.x&&e.y>2*-e.x&&(i.setAttribute("mobile","left"),i.style.left=parseInt(t.x/this.dpr)+"px",i.style.top=parseInt((t.y-parseInt(i.childNodes[0].style.height)/2)/this.dpr)+"px"),e=NDSWebViewer.ExtensionManager.getExtension("NDSAnimationExtension");(NDSWebViewer.SETTING.AnimationEdit||e&&e._enableAnimation)&&(i.style.left=parseInt(t.x/this.dpr)+"px",i.style.top=parseInt((t.y-parseInt(i.childNodes[0].style.height)/2)/this.dpr)+"px")},a.prototype.clientCoordToModelCoordOnPlane=function(e,t,i){e=[e,t,.99],t=this.viewer.clientCoordToModelCoord(e),t=new THREE.Vector3(t[0],t[1],t[2]),e[2]=-.99,e=this.viewer.clientCoordToModelCoord(e),e=new THREE.Vector3(e[0],e[1],e[2]);return this.intersectLine(t,e,i)},a.prototype.intersectLine=function(e,t,i){var o,n;return!(e&&t&&i)||(o=e.clone(),(e=(new THREE.Vector3).subVectors(t,e)).normalize(),n=e.dot(i.normal),Math.abs(n)<=1e-8)?null:(t=i.coplanarPoint(t.clone()),t=(new THREE.Vector3).subVectors(t,o).dot(i.normal)/n,o.add(e.multiplyScalar(t)))},a.prototype.update2DScene=function(){var e,t,i=this.viewer.renderer.getPixelRatio(),o=this.viewer.canvas2D.getContext("2d");if(this.rootObject.visible){this.Textbox&&this.intersectPnt&&(this.viewer.is2DModel?o.strokeStyle="#00FF00":o.strokeStyle="#FF6302",o.lineWidth=i,o.beginPath(),"up"==(e=this.Textbox.getAttribute("mobile"))||"down"==e?(r=this.get2dPoint(this.intersectPnt.clone()),s=this.get2dPoint(this.Textbox.pos.clone()),o.moveTo(r.x,r.y),o.lineTo(s.x,s.y)):"left"!=e&&"right"!=e||(e=this.get2dPoint(this.intersectPnt.clone()),t=this.get2dPoint(this.Textbox.pos.clone()),o.moveTo(e.x,e.y),o.lineTo(Math.round((e.x+t.x)/2),t.y),o.lineTo(t.x,t.y)),o.stroke());for(let e=0;e<this.TextContents.length;++e){var n,r,s,a,l,d=this.TextContents[e];"hidden"!=d.style.visibility&&(l=parseFloat(d.style.opacity),o.globalAlpha=""==d.style.opacity?1:l,l=d.newPoint||d.interPnt,n=d.newPos||d.pos,o.strokeStyle="#FF6302",d.Color&&(o.strokeStyle=d.Color),d.id==this.selectID||-1!=this.selectIDs.indexOf(d.id)?(o.strokeStyle="#FFC300",d.childNodes[0].style.border="1px solid #FFC300"):d.childNodes[0].style.border="1px solid #FF6302",o.lineWidth=i,o.beginPath(),"up"==(a=d.getAttribute("mobile"))||"down"==a?(r=this.get2dPoint(l.clone()),s=this.get2dPoint(n.clone()),o.moveTo(r.x,r.y),o.lineTo(s.x,s.y)):"left"!=a&&"right"!=a||(a=this.get2dPoint(l.clone()),l=this.get2dPoint(n.clone()),d.Inflection?(o.moveTo(a.x,a.y),o.lineTo(Math.round((a.x+l.x)/2),l.y)):o.moveTo(a.x,a.y),o.lineTo(l.x,l.y)),o.stroke())}o.globalAlpha=1}},a.prototype.onTouchDoubleMove=function(e){"OpAnnotationNew"===this.viewer.getCurrentOperatorID()&&NDSWebViewer.OpBase.prototype.onTouchDoubleMove.call(this,e)},a.prototype.onRMouseMove=function(e){"OpAnnotationNew"===this.viewer.getCurrentOperatorID()&&NDSWebViewer.OpBase.prototype.onRMouseMove.call(this,e)},a.prototype.onNMouseMove=function(e){var t,i,o,n;"Note"==this.mode?this.Textbox&&(this.Textbox.style.left=e.offsetX+8+"px",this.Textbox.style.top=e.offsetY+20+"px"):"NotePlace"==this.mode&&(t=new THREE.Plane,o=this.viewer.camera.getCameraTarget(),n=this.viewer.camera.position,(i=new THREE.Vector3).subVectors(o,n),o=this.getViewClientCoords(e),t.setFromNormalAndCoplanarPoint(i.normalize(),this.intersectPnt),n=this.clientCoordToModelCoordOnPlane(o.x,o.y,t),this.Textbox.pos=n,this.changeAnnotation(this.intersectPnt,this.Textbox.pos,this.Textbox)),this.Textbox&&(this.Textbox.style.visibility="visible"),this.render()},a.prototype.onLMouseMoveEnable=function(){return!!("NoteMove"==this.mode||"Picture"==this.mode||"picNote"==this.mode&&this._isResizing)},a.prototype.onLMouseMove=function(e){var t=NDSWebViewer.ExtensionManager.getExtension("NDSAnimationExtension");if(!t||!t._enableAnimation){if("Picture"==this.mode){if(this._isResizing)return void this.reSize(e);if(this._isDragging)return t=Math.round(e.clientX-this.startX),i=Math.round(e.clientY-this.startY),this._currentTarget.parentNode.style.left=t+"px",void(this._currentTarget.parentNode.style.top=i+"px");NDSWebViewer.OpBase.prototype.onLMouseMove.call(this,e)}else if("NoteMove"==this.mode&&this.MoveTarget){var t=new THREE.Plane,i=this.viewer.camera.getCameraTarget(),o=this.viewer.camera.position,n=new THREE.Vector3,i=(n.subVectors(i,o),this.getViewClientCoords(e)),o=(t.setFromNormalAndCoplanarPoint(n.normalize(),this.MoveTarget.interPnt),this.clientCoordToModelCoordOnPlane(i.x,i.y,t)),r=(this.MoveTarget.pos=o,this.viewer.ndsModel.getBodyNodeFromUuid(this.MoveTarget.bodyUuid,this.MoveTarget.ndsModelId));if(r){var s=new THREE.Vector3(0,0,0),a=NDSWebViewer.ExtensionManager.getExtensionWithFlags(NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM);for(let e=0,t=a.length;e<t;++e)s.add(a[e].getBodyNodeTranslate(r));n=[s.x,s.y,s.z];this.MoveTarget.pos.set(this.MoveTarget.pos.x-n[0],this.MoveTarget.pos.y-n[1],this.MoveTarget.pos.z-n[2])}this.changeAnnotation(this.MoveTarget.interPnt,this.MoveTarget.pos,this.MoveTarget),this.update2DScene()}else if("picNote"==this.mode){if(this._isResizing)return void this.reSize(e)}else NDSWebViewer.OpBase.prototype.onLMouseMove.call(this,e);!this.Textbox||"单击确定位置"!=this.Textbox.childNodes[0].value&&"Click to choose the location for the comment."!=this.Textbox.childNodes[0].value||(this.Textbox.style.visibility="hidden"),this.viewer.render()}},a.prototype.clearFlag=function(e=!1){this.Textbox&&(this.viewer.container.removeChild(this.Textbox),this.Textbox=null);for(let e=0;e<this.rootObject.children.length;e++){var t=this.rootObject.children[e];t.textID||this.rootObject.remove(t)}"NotePlace"!=this.mode&&"Note"!=this.mode||!e?"Picture"!=this.mode&&this.setMode("normal"):this.createText()},a.prototype.setPointScale=function(e,t){t=this.getScale(e,t);e.scale.x=t,e.scale.y=t,e.scale.z=t,e.updateMatrixWorld()},a.prototype.getScale=function(e,t){var i=5,t=(null!=t&&(i=t),this.viewer.camera.getCameraTarget()),o=this.viewer.camera.position,n=new THREE.Vector3,t=(n.subVectors(t,o),e.position.clone()),e=this.viewer.camera.isPerspective?t.sub(o).dot(n.normalize()):n.length(),t=this.viewer.camera.fov,o=2*e*Math.tan(THREE.Math.degToRad(.5*t)),n=this.viewer.renderer.domElement.height;return i*o*this.viewer.renderer.getPixelRatio()/n},a.prototype.renderScale=function(e){for(var t=0;t<e.children.length;t++){var r=e.children[t];null!=r.objectType&&"Point"===r.objectType&&(r.textID!=this.selectID&&-1==this.selectIDs.indexOf(r.textID)||"#ffc300"==r._color||(r._color="#ffc300",this.setNotePointColor(r.textID,"#ffc300")),r.textID!=this.selectID&&-1==this.selectIDs.indexOf(r.textID)&&"#FF6302"!=r._color&&(r._color="#FF6302",this.setNotePointColor(r.textID,"#FF6302")),this.TextContents.forEach(e=>{if(e.id==r.textID&&e.bodyUuid){var i=this.viewer.ndsModel.getBodyNodeFromUuid(e.bodyUuid,e.ndsModelId);if(i){var o=new THREE.Vector3(0,0,0),n=NDSWebViewer.ExtensionManager.getExtensionWithFlags(NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM);for(let e=0,t=n.length;e<t;++e)o.add(n[e].getBodyNodeTranslate(i));var t=[o.x,o.y,o.z];r.position.set(e.interPnt.x+t[0],e.interPnt.y+t[1],e.interPnt.z+t[2]),e.newPos.copy(e.pos),e.newPos.x+=t[0],e.newPos.y+=t[1],e.newPos.z+=t[2],e.newPoint.copy(r.position)}else e.newPos.copy(e.pos),e.newPoint.copy(e.interPnt)}}),this.setPointScale(r,this.POINTSIZE))}},a.prototype.renderAnnotation=function(e){if(!this.viewer.viewManager&&(this.viewer.annotationsManager&&this.viewer.annotationsManager.renderAnnotations(e),this.AnnotationScene)){for(let e=0;e<this.TextContents.length;++e){var i=this.TextContents[e];if(null!=i.ndsModelId&&i.bodyUuid&&!i.AnimationEdit){var o,n=this.viewer.getBodyNodeFromUuid(i.bodyUuid,i.ndsModelId);if(n){let e=!0;e=NDSWebViewer.SETTING.HideLeafBody&&n.isHidden()?(o=n.parent,"N"!==this.viewer.ndsModel.getModelById(i.ndsModelId).bodyUuid2ClonedNodeMap[o.uuid].isChecked):!n.isHidden();let t=!0;!(t="hidden"==i.style.visibility?!1:t)&&i.style.hidemodel&&e?i.style.hidemodel=!1:!t||e||i.style.hidemodel?e&=t:i.style.hidemodel=!0,e||"hidden"==i.style.visibility?e&&"hidden"==i.style.visibility&&this.setPicTextVisible(i.id,!0):this.setPicTextVisible(i.id,!1)}}}null!=this.rootObject&&this.renderScale(this.rootObject),this.rootObject.visible&&this.viewer.renderer.render(this.AnnotationScene,this.viewer.camera),"NotePlace"==this.mode&&this.Textbox&&this.changeAnnotation(this.intersectPnt,this.Textbox.pos,this.Textbox);for(let e=0;e<this.TextContents.length;++e){var t=this.TextContents[e],r=t.newPoint||t.interPnt,s=t.newPos||t.pos;this.changeAnnotation(r,s,t)}this.update2DScene()}},a.prototype.showNoteAnnotation=function(t){t=!!t;for(let e=0;e<this.TextContents.length;++e){var i=this.TextContents[e];i.AnimationEdit&&!NDSWebViewer.SETTING.AnimationEdit||(i.style.visibility=t?"visible":"hidden")}for(let e=0;e<this.rootObject.children.length;e++){var o=this.rootObject.children[e];o.AnimationEdit&&!NDSWebViewer.SETTING.AnimationEdit||(o.visible=t)}for(let e=0;e<this.PicContents.length;++e){var n=this.PicContents[e];n.AnimationEdit&&!NDSWebViewer.SETTING.AnimationEdit||(n.style.visibility=t?"visible":"hidden")}this.viewer.CADViewer&&this._addEditDel(),this.AnnotationShow=t},a.prototype.showAnimationNoteAnnotation=function(t){for(let e=0;e<this.TextContents.length;++e){var i=this.TextContents[e];i.AnimationEdit&&(i.style.visibility=t?"visible":"hidden")}for(let e=0;e<this.rootObject.children.length;e++){var o=this.rootObject.children[e];o.AnimationEdit&&(o.visible=t)}for(let e=0;e<this.PicContents.length;++e){var n=this.PicContents[e];n.AnimationEdit&&(n.style.visibility=t?"visible":"hidden")}},a.prototype.getViewClientCoords=function(e){var t=e.offsetX||e.clientX-this.viewer.container.getBoundingClientRect().left,i=e.offsetY||e.clientY-this.viewer.container.getBoundingClientRect().top,e=(e.srcElement&&e.srcElement!==this.viewer.renderer.domElement&&(t=e.clientX-this.viewer.container.getBoundingClientRect().left,i=e.clientY-this.viewer.container.getBoundingClientRect().top),null==e.srcElement&&e.target&&e.target!==this.viewer.renderer.domElement&&(t=e.clientX-this.viewer.container.getBoundingClientRect().left,i=e.clientY-this.viewer.container.getBoundingClientRect().top),this.remapCoordnidateToFullView(t,i));return new THREE.Vector2(e[0],e[1])},a.prototype.updateTextPos=function(t,i){var o=t.uuid;for(let e=0;e<this.TextContents.length;e++){var n=this.TextContents[e];null!=n.ndsModelId&&null!=n.ndsModelId?n.bodyUuid==o&&t.ndsModel.id==n.ndsModelId&&n.AnimationEdit&&n.interPnt.applyMatrix4(i):n.bodyUuid==o&&n.interPnt.applyMatrix4(i)}},a.prototype.onTouchSingle=function(e){if("Note"==this.mode){var t=this.singleTouchEndPos,i=t.x,t=t.y,o=this.viewer.renderer.domElement,n=this.viewer.renderer.getPixelRatio(),i=i*n/o.width*2-1,t=2*-(t*n/o.height)+1,n=new THREE.Raycaster,o=(this.viewer.camera.setCastRay(n,i,t),this.viewer.ndsModel.intersect(n.ray));let e;o&&0<o.length?(e=o[0].point,this.Textbox.bodyUuid=o[0].bodyUuid,this.Textbox.ndsModelId=o[0].object.ndsModel.id,this.Textbox.newPoint=new THREE.Vector3,this.Textbox.newPos=new THREE.Vector3):(i=new THREE.Plane,t=this.viewer.camera.getCameraTarget(),n=this.viewer.camera.position,(o=new THREE.Vector3).subVectors(t,n),t=this.singleTouchEndPos,i.setFromNormalAndCoplanarPoint(o.normalize(),this.viewer.controls.getBoundingBox().getCenter()),e=this.clientCoordToModelCoordOnPlane(t.x,t.y,i)),this.setMode("NotePlace");n=new THREE.Mesh(new THREE.SphereGeometry(1),this.materialPoint.clone()),o=(n.position.set(e.x,e.y,e.z),this.setPointScale(n,this.POINTSIZE),n.objectType="Point",n.Point=n.position.clone(),this.intersectPnt=n.Point,this.Textbox.pos=n.Point.clone(),this.rootObject.add(n),NDSWebViewer.COMMON.getLanguage(),this.Textbox.childNodes[0].placeholder=NDSWebViewer.COMMON.translateString("PMI_Text"),this.Textbox.childNodes[0].value="",this.Textbox.childNodes[0].style.backgroundColor="#FFFFFF",this.Textbox.childNodes[0].style.fontSize="16px",this.Textbox.childNodes[0].style.lineHeight="22px",this.Textbox.childNodes[0].style.height="22px",this.Textbox.childNodes[0].style.width="44px",this.Textbox.childNodes[0].style.textAlign="left",this.Textbox.childNodes[0].style.border="1px solid #FF6302",new THREE.Plane),t=this.viewer.camera.getCameraTarget(),i=this.viewer.camera.position,n=new THREE.Vector3,t=(n.subVectors(t,i),this.singleTouchEndPos),i=(o.setFromNormalAndCoplanarPoint(n.normalize(),this.intersectPnt),this.clientCoordToModelCoordOnPlane(t.x,t.y,o)),n=(this.Textbox.pos=i,this.changeAnnotation(this.intersectPnt,this.Textbox.pos,this.Textbox),this.Textbox.style.visibility="hidden",this.viewer.dispatchEvent({type:"infoMsgTips",msg:""}),NDSWebViewer.COMMON.translateString("ANNOTATION_Textlocation"));this._clearMsgInfo=!1,this.PostInfo(n)}else{if("NotePlace"==this.mode){this.Textbox.style.visibility="visible",this.Textbox.childNodes[0].readOnly=!1,this.Textbox.childNodes[0].focus();var t=new THREE.Plane,o=this.viewer.camera.getCameraTarget(),i=this.viewer.camera.position,n=new THREE.Vector3,o=(n.subVectors(o,i),{x:e.changedTouches[0].clientX,y:e.changedTouches[0].clientY}),i=(t.setFromNormalAndCoplanarPoint(n.normalize(),this.intersectPnt),this.clientCoordToModelCoordOnPlane(o.x,o.y,t)),r=(this.Textbox.pos=i,this.Textbox.oriPos={x:i.x,y:i.y,z:i.z},this.Textbox.childNodes[0].style.border="1px solid #FFC300",this.Textbox.interPnt=this.intersectPnt,this.viewer.ndsModel.getBodyNodeFromUuid(this.Textbox.bodyUuid,this.Textbox.ndsModelId));if(r){var s=new THREE.Vector3(0,0,0),a=NDSWebViewer.ExtensionManager.getExtensionWithFlags(NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM);for(let e=0,t=a.length;e<t;++e)s.add(a[e].getBodyNodeTranslate(r));n=[s.x,s.y,s.z];this.Textbox.interPnt.set(this.Textbox.interPnt.x-n[0],this.Textbox.interPnt.y-n[1],this.Textbox.interPnt.z-n[2]),this.Textbox.pos.set(this.Textbox.pos.x-n[0],this.Textbox.pos.y-n[1],this.Textbox.pos.z-n[2])}o=this.getUUid();return this.rootObject.children[this.rootObject.children.length-1].textID=o,this.Textbox.id=o,this.Textbox.childNodes[0].readOnly=!1,this.TextContents.push(this.Textbox),this.Textbox=null,this.intersectPnt=null,this.setSelectId(o),this.setMode("NoteEdit"),e.preventDefault(),e.stopImmediatePropagation(),void e.stopPropagation()}"NoteEdit"==this.mode?this.setMode("normal"):"normal"!=this.mode&&"Picture"!=this.mode||"OpAnnotationNew"!=this.viewer.controls.getOperator().type||NDSWebViewer.OpBase.prototype.onLMouseClick.call(this,e)}if(this.Textbox&&this.Textbox.childNodes[0].blur(),!e.ctrlKey){for(let e=0;e<this.TextContents.length;e++){var l=this.TextContents[e];l.childNodes[0].blur(),"NoteEdit"!=this.mode&&(l.childNodes[0].style.cursor="default",l.childNodes[0].style.userSelect="none",l.childNodes[0].readOnly=!0)}for(let e=0;e<this.PicContents.length;e++){var d=this.PicContents[e];d.style.border="2px solid rgba(255, 195, 0, 0.0)",d.style.zIndex=7,Array.from(d.querySelectorAll(".divBoxSub")).forEach(e=>{e.style.display="none"})}this._isDragging=!1,this._isResizing=!1,this._currentTarget&&(this._currentTarget.parentNode.style.zIndex=NDSWebViewer.COMMON.isMobileDevice()?2:7,this._currentTarget.parentNode.style.border="2px solid rgba(255, 195, 0, 0.0)"),this._currentTarget=null,(0!=this.picSelectID||0<this.selectIDs.length)&&(this.picSelectID=0,this.viewer.dispatchEvent({type:"PicSelect",data:[]}),this.picSelectIDs=[]),this.setSelectId(0)}this.Textbox&&(this.Textbox.style.left=e.offsetX+8+"px",this.Textbox.style.top=e.offsetY+20+"px"),this.viewer.render()},a.prototype.onLMouseClick=function(t){if("Note"==this.mode){var i=this.getViewClientCoords(t),o=i.x,i=i.y,n=this.viewer.renderer.domElement,r=this.viewer.renderer.getPixelRatio(),o=o*r/n.width*2-1,i=2*-(i*r/n.height)+1,r=new THREE.Raycaster,n=(this.viewer.camera.setCastRay(r,o,i),this.viewer.ndsModel.intersect(r.ray));let e;n&&0<n.length?(e=n[0].point,this.Textbox.bodyUuid=n[0].bodyUuid,this.Textbox.ndsModelId=n[0].object.ndsModel.id,this.Textbox.newPoint=new THREE.Vector3,this.Textbox.newPos=new THREE.Vector3):(o=new THREE.Plane,i=this.viewer.camera.getCameraTarget(),r=this.viewer.camera.position,(n=new THREE.Vector3).subVectors(i,r),i=this.getViewClientCoords(t),o.setFromNormalAndCoplanarPoint(n.normalize(),this.viewer.controls.getBoundingBox().getCenter()),e=this.clientCoordToModelCoordOnPlane(i.x,i.y,o)),this.setMode("NotePlace");r=new THREE.Mesh(new THREE.SphereGeometry(1),this.materialPoint.clone());r.position.set(e.x,e.y,e.z),this.setPointScale(r,this.POINTSIZE),r.objectType="Point",r.Point=r.position.clone(),this.intersectPnt=r.Point,this.Textbox.pos=r.Point.clone(),this.rootObject.add(r),NDSWebViewer.COMMON.getLanguage();this.Textbox.childNodes[0].placeholder=NDSWebViewer.COMMON.translateString("PMI_Text"),this.Textbox.childNodes[0].value="",this.Textbox.childNodes[0].style.backgroundColor="#FFFFFF",this.Textbox.childNodes[0].style.fontSize="16px",this.Textbox.childNodes[0].style.lineHeight="22px",this.Textbox.childNodes[0].style.height="22px",this.Textbox.childNodes[0].style.width="44px",this.Textbox.childNodes[0].style.textAlign="left",this.Textbox.childNodes[0].style.border="1px solid #FF6302"}else{if("NotePlace"==this.mode){var n=new THREE.Plane,i=this.viewer.camera.getCameraTarget(),o=this.viewer.camera.position,r=new THREE.Vector3,i=(r.subVectors(i,o),this.getViewClientCoords(t)),o=(n.setFromNormalAndCoplanarPoint(r.normalize(),this.intersectPnt),this.clientCoordToModelCoordOnPlane(i.x,i.y,n)),s=(this.Textbox.pos=o,this.Textbox.oriPos={x:o.x,y:o.y,z:o.z},this.Textbox.childNodes[0].style.border="1px solid #FFC300",this.Textbox.interPnt=this.intersectPnt,this.viewer.ndsModel.getBodyNodeFromUuid(this.Textbox.bodyUuid,this.Textbox.ndsModelId));if(s){var a=new THREE.Vector3(0,0,0),l=NDSWebViewer.ExtensionManager.getExtensionWithFlags(NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM);for(let e=0,t=l.length;e<t;++e)a.add(l[e].getBodyNodeTranslate(s));r=[a.x,a.y,a.z];this.Textbox.interPnt.set(this.Textbox.interPnt.x-r[0],this.Textbox.interPnt.y-r[1],this.Textbox.interPnt.z-r[2]),this.Textbox.pos.set(this.Textbox.pos.x-r[0],this.Textbox.pos.y-r[1],this.Textbox.pos.z-r[2])}i=this.getUUid();return this.rootObject.children[this.rootObject.children.length-1].textID=i,this.Textbox.id=i,this.Textbox.childNodes[0].readOnly=!1,this.TextContents.push(this.Textbox),this.Textbox=null,this.intersectPnt=null,this.setSelectId(i),void this.setMode("NoteEdit")}"NoteEdit"==this.mode?this.setMode("normal"):"normal"!=this.mode&&"Picture"!=this.mode||"OpAnnotationNew"!=this.viewer.controls.getOperator().type||NDSWebViewer.OpBase.prototype.onLMouseClick.call(this,t)}if(this.Textbox&&this.Textbox.childNodes[0].blur(),!t.ctrlKey){for(let e=0;e<this.TextContents.length;e++){var d=this.TextContents[e];d.childNodes[0].blur(),"NoteEdit"!=this.mode&&(d.childNodes[0].style.cursor="default",d.childNodes[0].style.userSelect="none",d.childNodes[0].readOnly=!0)}for(let e=0;e<this.PicContents.length;e++){var c=this.PicContents[e];c.style.border="2px solid rgba(255, 195, 0, 0.0)",c.style.zIndex=7,Array.from(c.querySelectorAll(".divBoxSub")).forEach(e=>{e.style.display="none"})}this._isDragging=!1,this._isResizing=!1,this._currentTarget&&(this._currentTarget.parentNode.style.zIndex=NDSWebViewer.COMMON.isMobileDevice()?2:7,this._currentTarget.parentNode.style.border="2px solid rgba(255, 195, 0, 0.0)"),this._currentTarget=null,(0!=this.picSelectID||0<this.selectIDs.length)&&(this.picSelectID=0,this.viewer.dispatchEvent({type:"PicSelect",data:[]}),this.picSelectIDs=[]),this.setSelectId(0)}this.Textbox&&(this.Textbox.style.left=t.offsetX+8+"px",this.Textbox.style.top=t.offsetY+20+"px")},a.prototype.onCancelHighlight=function(e){if(!e.ctrlKey){for(let e=0;e<this.TextContents.length;e++){var t=this.TextContents[e];t.childNodes[0].blur(),"NoteEdit"!=this.mode&&(t.childNodes[0].style.cursor="default",t.childNodes[0].style.userSelect="none",t.childNodes[0].readOnly=!0)}for(let e=0;e<this.PicContents.length;e++){var i=this.PicContents[e];i.style.border="2px solid rgba(255, 195, 0, 0.0)",i.style.zIndex=7,Array.from(i.querySelectorAll(".divBoxSub")).forEach(e=>{e.style.display="none"})}this._isDragging=!1,this._isResizing=!1,this._currentTarget&&(this._currentTarget.parentNode.style.zIndex=NDSWebViewer.COMMON.isMobileDevice()?2:7,this._currentTarget.parentNode.style.border="2px solid rgba(255, 195, 0, 0.0)"),this._currentTarget=null,(0!=this.picSelectID||0<this.selectIDs.length)&&(this.picSelectID=0,this.viewer.dispatchEvent({type:"PicSelect",data:[]}),this.picSelectIDs=[]),this.setSelectId(0)}},a.prototype.onTouchSingleEnd=function(e){NDSWebViewer.OpBase.prototype.onTouchSingleEnd.call(this,e)},a.prototype.setPicTextVisible=function(t,i){for(let e=0;e<this.rootObject.children.length;e++){var o=this.rootObject.children[e];o.textID==t&&(o.visible=i)}var e;i?-1!=(e=this.unvisibleIDs.indexOf(t))&&this.unvisibleIDs.splice(e,1):(-1==(e=this.unvisibleIDs.indexOf(t))&&this.unvisibleIDs.push(e),(this.picSelectID==t||this.picSelectIDs.includes(t))&&(this.picSelectID=0,-1<(e=this.picSelectIDs.indexOf(t)))&&this.picSelectIDs.splice(e,1));for(let e=0;e<this.TextContents.length;e++){var n=this.TextContents[e];n.id==t&&(n.style.visibility=i?"visible":"hidden")}for(let e=0;e<this.PicContents.length;e++){var r=this.PicContents[e];r.id==t&&(i?(r.style.visibility="visible",r.children[0].style.display="block"):(r.style.visibility="hidden",r.style.border="2px solid rgba(255, 195, 0, 0.0)"))}this.viewer.CADViewer&&this._addEditDel(),this.update2DScene(),this.viewer.render()},a.prototype.setNoteAnnotation=function(t){if(!(-1<this.TextContents.findIndex(e=>e.id==t.id))){if(t.bodyUuid&&!t.AnimationEdit)if(!this.viewer.ndsModel.getBodyNodeFromUuid(t.bodyUuid,t.ndsModelId))return;this._clearMsgInfo=!0;var e=this.createDiv();NDSWebViewer.COMMON.getLanguage();e.childNodes[0].value=t.text,""==t.text&&(e.childNodes[0].placeholder=NDSWebViewer.COMMON.translateString("PMI_Text")),e.childNodes[0].style.backgroundColor="#FFFFFF",e.childNodes[0].style.fontSize="16px",e.childNodes[0].style.lineHeight="22px",e.childNodes[0].style.height="22px",e.childNodes[0].style.width="44px",e.childNodes[0].style.textAlign="left",e.childNodes[0].style.border="1px solid #FF6302",e.style.visibility="visible";{var o=e.childNodes[0];var n=o.value.split("\n");let i=0;for(let e=0;e<n.length;e++){var r=n[e];let t=0;for(let e=0;e<r.length;e++){var s=8200<=r[e].charAt(0).charCodeAt(0);t+=s?2:1}i<t&&(i=t)}var a="en"==NDSWebViewer.COMMON.getLanguage()||NDSWebViewer.COMMON.isIOSDevice()?10:8;o.style.width=Math.round(i*a)+"px",Math.round(i*a)<44&&(o.style.width="44px"),NDSWebViewer.COMMON.isMobileDevice()&&160<Math.round(i*a)&&(o.style.width="160px")}a=e.childNodes[0].value.split("\n").length,o=(e.childNodes[0].style.height=22*a+"px",e.pos=new THREE.Vector3(t.projPt.x,t.projPt.y,t.projPt.z),e.oriPos={x:t.projPt.x,y:t.projPt.y,z:t.projPt.z},e.id=t.id,e.bodyUuid=t.bodyUuid,e.ndsModelId=t.ndsModelId,e.bodyUuid&&(e.newPoint=new THREE.Vector3,e.newPos=new THREE.Vector3),e.hasAdd=!0,e.interPnt=new THREE.Vector3(t.interPnt.x,t.interPnt.y,t.interPnt.z),e.AnimationEdit=t.AnimationEdit||!1,e.animationID=t.animationID,this.TextContents.push(e),new THREE.Mesh(new THREE.SphereGeometry(1),this.materialPoint.clone()));o.position.set(e.interPnt.x,e.interPnt.y,e.interPnt.z),this.setPointScale(o,this.POINTSIZE),o.objectType="Point",o.textID=t.id,o.AnimationEdit=e.AnimationEdit,o.Point=o.position.clone(),this.rootObject.add(o),this.viewer.container.appendChild(e),0==t.visible&&this.setPicTextVisible(e.id,!1),NDSWebViewer.COMMON.isMobileDevice()&&(e.childNodes[0].style.height="auto",e.childNodes[0].style.height=e.childNodes[0].scrollHeight+"px")}},a.prototype.setPicAnnotation=function(t){var e;-1<this.PicContents.findIndex(e=>e.id==t.id)||(this.createElement(t.base64,t.name),(e=this.PicContents[this.PicContents.length-1]).id=t.id,e.children[0].style.width=t.width+"px",e.children[0].style.height=t.height+"px",e.children[0].style.display=t.visible?"block":"none",e.style.width=t.width+4+"px",e.style.height=t.height+4+"px",e.style.display="flex",e.style["justify-content"]="center",e.style["align-items"]="center",e.style.left=t.left+"px",e.style.top=t.top+"px",e.style.visibility=t.visible?"visible":"hidden",e.AnimationEdit=t.AnimationEdit||!1,e.animationID=t.animationID)},a.prototype.clearAnnotation=function(){for(let e=0;e<this.rootObject.children.length;e++){var t=this.rootObject.children[e];this.rootObject.remove(t)}for(let e=0;e<this.TextContents.length;e++){var i=this.TextContents[e];this.viewer.container.removeChild(i)}for(let e=0;e<this.PicContents.length;e++){var o=this.PicContents[e];this.viewer.container.removeChild(o)}this.TextContents=[]},a.prototype.EditSelected=function(){for(let e=0;e<this.TextContents.length;e++){var t=this.TextContents[e];if(t.id==this.selectID)return t.childNodes[0].readOnly=!1,void t.childNodes[0].focus()}},a.prototype.getAnnotationColorAndOpacity=function(t){let i=!1;t!=this.selectID&&t!=this.picSelectID&&-1==this.selectIDs.indexOf(t)||(i=!0);for(let e=0;e<this.TextContents.length;e++){var o=this.TextContents[e];if(o.id==t)return{id:o.id,opacity:""==o.style.opacity?1:o.style.opacity,Notecolor:""==o.childNodes[0].style.color?"#000000":o.Notecolor,NoteLineColor:o.Color||"#FF6302",selected:i}}for(let e=0;e<this.PicContents.length;e++){var n=this.PicContents[e];if(n.id==t)return{id:n.id,opacity:""==n.childNodes[0].style.opacity?1:n.childNodes[0].style.opacity,selected:i}}},a.prototype.setTransparent=function(t,i){for(let e=0;e<this.PicContents.length;e++){var o=this.PicContents[e];o.id==t&&(o.childNodes[0].style.opacity=i)}for(let e=0;e<this.TextContents.length;e++){var n=this.TextContents[e];n.id==t&&(n.style.opacity=i)}for(let e=this.rootObject.children.length-1;0<=e;e--){var r=this.rootObject.children[e];if(r.textID==t){r.material.opacity=i,r.material.transparent=i<1,r.material.needsUpdate=!0,r.material.needsRefresh=!0;break}}this.viewer.render()},a.prototype.setNoteColor=function(t,i){for(let e=0;e<this.TextContents.length;e++){var o=this.TextContents[e];o.id==t&&(o.childNodes[0].style.color=i,o.Notecolor=i)}},a.prototype.setNoteLineColor=function(t,i){for(let e=0;e<this.TextContents.length;e++){var o=this.TextContents[e];o.id==t&&(o.Color=i)}},a.prototype.setNotePointColor=function(t,i){for(let e=this.rootObject.children.length-1;0<=e;e--){var o=this.rootObject.children[e];if(o.textID==t){o.material.color.setStyle(i);break}}},a.prototype.unloadAnnotation=function(t){for(let e=0;e<this.TextContents.length;e++){var i=this.TextContents[e],o=[];i.ndsModelId===t&&o.push(i.id),this.deleteNoteAnnotation(o)}},a.prototype.deleteNoteAnnotation=function(i,e=!0){let o=this,n=Array.isArray(i);if(n&&e)for(let e=0;e<i.length;e++)this.deleteNoteAnnotation(i[e]);let t=[],r=[],s=[];for(let e=0;e<this.TextContents.length;e++){var a=this.TextContents[e];(n?i.includes(a.id):a.id==i)&&a.PointMeasure&&(r.push(e),s.push(a.id))}s.includes(o.selectID)&&0!=o.selectID&&o.setSelectId(0,!1);for(let e=o.rootObject.children.length-1;0<=e;e--){var l=o.rootObject.children[e];s.includes(l.textID)&&o.rootObject.remove(l)}for(let e=r.length-1;0<=e;e--)o.viewer.container.removeChild(o.TextContents[r[e]]),o.TextContents.splice(r[e],1);r=[],s=[];for(let e=0;e<this.TextContents.length;e++){var d,c,h=this.TextContents[e];(n?!i.includes(h.id):h.id!=i)||(h=h).PointMeasure||(d=[],(c=this.viewer.ndsModel.getBodyNodeFromUuid(h.bodyUuid,h.ndsModelId))&&d.push(c.objectid),c={tagId:(u={id:h.id,uuid:h.id,interPnt:h.interPnt,projPt:h.pos,text:h.childNodes[0].value,configNum:this.viewer.ConfigNum,configName:this.viewer.ConfigName,bodyUuid:h.bodyUuid,origiType:"lineNote",name:h.animationName,animationID:h.animationID,ndsModelId:h.ndsModelId,objectId:d}).id,text:u.text,state:u,modelName:u.configName},t.push(NDSWebViewer.SETTING.AnimationEdit?c.state:c),r.push(e))}function p(){(n?i.includes(o.selectID):o.selectID==i)&&0!=o.selectID&&o.setSelectId(0,!1);for(let e=o.rootObject.children.length-1;0<=e;e--){var t=o.rootObject.children[e];(n?i.includes(t.textID):t.textID==i)&&o.rootObject.remove(t)}for(let e=r.length-1;0<=e;e--)o.viewer.container.removeChild(o.TextContents[r[e]]),o.TextContents.splice(r[e],1)}e&&t.length&&(NDSWebViewer.SETTING.AnimationEdit?this.viewer.dispatchEvent({type:"NoteDelete",data:t,delete:p}):this.viewer.dispatchEvent({type:"NoteDelete",data:t[0],delete:p})),e||p(),(n?i.includes(this.picSelectID):this.picSelectID==i)&&0!=this.picSelectID&&(this.picSelectID=0);for(let e=0;e<this.PicContents.length;e++){var u,g=this.PicContents[e];(n?i.includes(g.id):g.id==i)&&(this.viewer.container.removeChild(g),this.PicContents.splice(e,1),u={id:g.id,name:g.filename,configNum:this.viewer.ConfigNum,configName:this.viewer.ConfigName,type:"Pic",animationID:g.animationID},this.viewer.dispatchEvent({type:"PicDelete",data:u}))}"Note"!=this.mode&&this.setMode("normal"),this.update2DScene(),this.viewer.render()},a.prototype.getAllNoteContent=function(){var t=[];for(let e=0;e<this.TextContents.length;e++){var i,o,n=this.TextContents[e];n.PointMeasure||(o=[],(i=this.viewer.ndsModel.getBodyNodeFromUuid(n.bodyUuid,n.ndsModelId))&&o.push(i.objectid),i={id:n.id,uuid:n.id,interPnt:n.interPnt,projPt:n.pos,text:n.childNodes[0].value,configNum:this.viewer.ConfigNum,configName:this.viewer.ConfigName,bodyUuid:n.bodyUuid,origiType:"lineNote",visible:"hidden"!=n.style.visibility,name:n.animationName,animationID:n.animationID,ndsModelId:n.ndsModelId,objectId:o},o={tagId:n.id,text:i.text,state:i,modelName:i.configName},t.push(o))}return t},a.prototype.getSelectedNoteContent=function(){var t=[];for(let e=0;e<this.TextContents.length;e++){var i=this.TextContents[e],o=this.viewer.ndsModel.getBodyNodeFromUuid(i.bodyUuid,i.ndsModelId),n=[];o&&n.push(o.objectid),!i.PointMeasure&&(o={id:i.id,uuid:i.id,interPnt:i.interPnt,projPt:i.pos,text:i.childNodes[0].value,configNum:this.viewer.ConfigNum,configName:this.viewer.ConfigName,bodyUuid:i.bodyUuid,origiType:"lineNote",visible:"hidden"!=i.style.visibility,name:i.animationName,animationID:i.animationID,ndsModelId:i.ndsModelId,objectId:n},n={tagId:i.id,text:o.text,state:o,modelName:o.configName},this.selectID==i.id||this.selectIDs.includes(i.id))&&t.push(n)}return t},a.prototype.GetMeasurePointData=function(){var t=[];for(let e=0;e<this.TextContents.length;e++){var i=this.TextContents[e];if(i.PointMeasure){let e=0;i.isPic&&(e=Math.max(i.childNodes[0].height,i.childNodes[0].width));var o=i.interPnt.clone(),n=i.pos.clone(),r=(0<this.viewer.ndsModel.ModelUpMatrix4.length&&((r=new THREE.Matrix4).fromArray(this.viewer.ndsModel.ModelUpMatrix4),r.invert(),o.applyMatrix4(r),n.applyMatrix4(r)),{point:o,notePlace:n,url:i.isPic?i.childNodes[0].src:"",text:i.isPic?"":i.childNodes[0].value,configNum:this.viewer.ConfigNum,configName:this.viewer.ConfigName,inflection:i.Inflection,type:"MeasurePoint",picSize:e});t.push(r)}}return t},a.prototype.getNoteContentByID=function(t){for(let e=0;e<this.TextContents.length;e++){var i=this.TextContents[e],o=this.viewer.ndsModel.getBodyNodeFromUuid(i.bodyUuid,i.ndsModelId),n=[];if(o&&n.push(o.objectid),i.id==t)return{tagId:(o={id:i.id,uuid:i.id,interPnt:i.interPnt,projPt:i.pos,text:i.childNodes[0].value,configNum:this.viewer.ConfigNum,configName:this.viewer.ConfigName,bodyUuid:i.bodyUuid,origiType:"lineNote",visible:"hidden"!=i.style.visibility,name:i.animationName,animationID:i.animationID,ndsModelId:i.ndsModelId,objectId:n}).id,text:o.text,state:o,modelName:o.configName}}},a.prototype.getSelectContent=function(){var t=[];for(let e=0;e<this.PicContents.length;e++){var i=this.PicContents[e];i.id!=this.picSelectID&&-1==this.selectIDs.indexOf(i.id)||"hidden"!=i.style.visibility&&(n={id:i.id,name:i.filename,configNum:this.viewer.ConfigNum,configName:this.viewer.ConfigName,base64:i.childNodes[0].src,type:"Pic",width:parseInt(i.childNodes[0].style.width),left:parseInt(i.style.left),height:parseInt(i.childNodes[0].style.height),top:parseInt(i.style.top),visible:"hidden"!=i.style.visibility,name:i.animationName,animationID:i.animationID},t.push(n))}for(let e=0;e<this.TextContents.length;e++){var o,n,r,s=this.TextContents[e];s.id!=this.selectID&&-1==this.selectIDs.indexOf(s.id)||"hidden"!=s.style.visibility&&(o=[],(r=this.viewer.ndsModel.getBodyNodeFromUuid(s.bodyUuid,s.ndsModelId))&&o.push(r.objectid),r={tagId:(n={id:s.id,uuid:s.id,interPnt:s.interPnt,projPt:s.pos,text:s.childNodes[0].value,configNum:this.viewer.ConfigNum,configName:this.viewer.ConfigName,bodyUuid:s.bodyUuid,origiType:"lineNote",type:"lineNote",visible:"hidden"!=s.style.visibility,name:s.animationName,animationID:s.animationID,ndsModelId:s.ndsModelId,objectId:o}).id,text:n.text,state:n,modelName:n.configName},t.push(NDSWebViewer.SETTING.AnimationEdit?r.state:r))}return t},a.prototype.getallPicContent=function(){var t=[];for(let e=0;e<this.PicContents.length;e++){var i=this.PicContents[e],i={id:i.id,name:i.filename,configNum:this.viewer.ConfigNum,configName:this.viewer.ConfigName,base64:i.childNodes[0].src,type:"Pic",width:parseInt(i.childNodes[0].style.width),left:parseInt(i.style.left),height:parseInt(i.childNodes[0].style.height),top:parseInt(i.style.top),visible:"hidden"!=i.style.visibility,animationID:i.animationID};t.push(i)}return t},a.prototype.getSelectedPicContent=function(){var t=[];for(let e=0;e<this.PicContents.length;e++){var i=this.PicContents[e],o={id:i.id,name:i.filename,configNum:this.viewer.ConfigNum,configName:this.viewer.ConfigName,base64:i.childNodes[0].src,type:"Pic",width:parseInt(i.childNodes[0].style.width),left:parseInt(i.style.left),height:parseInt(i.childNodes[0].style.height),top:parseInt(i.style.top),visible:"hidden"!=i.style.visibility,animationID:i.animationID};this.picSelectIDs.includes(i.id)&&t.push(o)}return t},a.prototype.getPicContentByID=function(t){for(let e=0;e<this.PicContents.length;e++){var i=this.PicContents[e];if(i.id==t)return{id:i.id,name:i.filename,configNum:this.viewer.ConfigNum,configName:this.viewer.ConfigName,base64:i.childNodes[0].src,type:"Pic",width:parseInt(i.childNodes[0].style.width),left:parseInt(i.style.left),height:parseInt(i.childNodes[0].style.height),top:parseInt(i.style.top),visible:"hidden"!=i.style.visibility,animationID:i.animationID}}},a.prototype.release=function(){var e=this.viewer.renderer.getPixelRatio();this.viewer.canvas2D.getContext("2d").clearRect(0,0,window.innerWidth*e,window.innerHeight*e),this.clearAnnotation(),NDSWebViewer.OpBase.prototype.release.call(this)},a.prototype.onLMouseDown=function(e){NDSWebViewer.OpBase.prototype.onLMouseDown.call(this,e)},a.prototype.onLMouseUp=function(e){if(this._isDragging=!1,this._isResizing=!1,"NoteMove"==this.mode){this.MoveTarget=null,this.mode=this.oldmode,"NoteMove"==this.mode&&(this.mode="normal");let t=e.target.parentNode;var i=this.viewer.ndsModel.getBodyNodeFromUuid(t.bodyUuid,t.ndsModelId),o=[],i=(i&&o.push(i.objectid),{id:t.id,uuid:t.id,configNum:this.viewer.ConfigNum,configName:this.viewer.ConfigName,interPnt:t.interPnt,projPt:t.pos,text:t.childNodes[0].value,bodyUuid:t.bodyUuid,origiType:"lineNote",name:t.animationName,animationID:t.animationID,ndsModelId:t.ndsModelId,objectId:o}),o={tagId:i.id,text:i.text,state:i,modelName:i.configName};!t.PointMeasure&&t.hasAdd&&this.viewer.dispatchEvent({type:"NoteChange",data:NDSWebViewer.SETTING.AnimationEdit?o.state:o,editNote:function(e){e?t.oldText=t.childNodes[0].value:(t.childNodes[0].value=t.oldText,changeTextWidth(t.childNodes[0]),NDSWebViewer.COMMON.isMobileDevice()&&(t.childNodes[0].style.height="auto",t.childNodes[0].style.height=t.childNodes[0].scrollHeight+"px"))}})}NDSWebViewer.OpBase.prototype.onLMouseUp.call(this,e)},a.prototype._getBase64ByType=function(e){return"delete"==e?"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAARzQklUCAgICHwIZIgAAAEaSURBVFiF7ZY9bsMwDIVJJ0O3dOhJRA9dc5fkHFHP4R4mYwZRJ8nQbllidhENJ/VP5MgJHPgBBohHi/xMyIIAZj1ZGLvAGLNDRNuUExHrvf8aDaCreVUQce2c299aM4sBUImIZWasPyJiQ24XU+tiAkS0YubfphfrX6/N/hUL+a4pXPfAegIAfmLo79C7QlxMwBhDFRmiS9lRRHKNvffcu4CIhIjk3sZ9dQZtwpSaJgARbQBgUbMWwRsfgIg+AKDI8/xTvRAXITcuADMfAQDKsjypp7HmRgVIrRlgBpgegP7rWZa9VUVC/MhzYOucO6gX4u2Qc2AZuyBAfF9Z5wbvJk1vD7wcQO8eSHEr6lLrBNpuvkOUstas5PoD9pJ5PWI1yesAAAAASUVORK5CYII=":"edit"==e?"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB0AAAAdCAYAAABWk2cPAAAAAXNSR0IArs4c6QAAAARzQklUCAgICHwIZIgAAAD9SURBVEiJ7dQxTsMwFAbg/zdRF06QY8TJ3vYonIT2ZC0LU/JW1kqII8AU+bHUVWkJcZLXoSi/ZEWWX/zJlm1gzj3Ee/9clqVWVbXqq6UVSHJzmpRc13W976p3lqCqxu/urxVPQs9BkmsR2abAo9FLMG6niGwB7AEghLA0Q7vAOAZgBQDOuZff/h98kPrArrHRqAU4CLUCk1FLMAm1BoGE02sNJqExViAAZKmF8XUJISyngINQVd0dIUwBAeChryDP8wgdYiP5NBac8z9z9SIVRVGZAuSniLx1ot77kmRtiR7z2DTNV+z8uKdt275nWfbqnFtYaar6cQ7OuXm+AX5zoNbbzDxiAAAAAElFTkSuQmCC":null},a.prototype._getAppBase64ByType=function(e){return"delete"==e?"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAARzQklUCAgICHwIZIgAAAEaSURBVFiF7ZY9bsMwDIVJJ0O3dOhJRA9dc5fkHFHP4R4mYwZRJ8nQbllidhENJ/VP5MgJHPgBBohHi/xMyIIAZj1ZGLvAGLNDRNuUExHrvf8aDaCreVUQce2c299aM4sBUImIZWasPyJiQ24XU+tiAkS0YubfphfrX6/N/hUL+a4pXPfAegIAfmLo79C7QlxMwBhDFRmiS9lRRHKNvffcu4CIhIjk3sZ9dQZtwpSaJgARbQBgUbMWwRsfgIg+AKDI8/xTvRAXITcuADMfAQDKsjypp7HmRgVIrRlgBpgegP7rWZa9VUVC/MhzYOucO6gX4u2Qc2AZuyBAfF9Z5wbvJk1vD7wcQO8eSHEr6lLrBNpuvkOUstas5PoD9pJ5PWI1yesAAAAASUVORK5CYII=":"edit"==e?"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAAAXNSR0IArs4c6QAAAARzQklUCAgICHwIZIgAAAF/SURBVGiB7ZZNTsJAGEDfNxrvMGz0CrTsLffQhadwKSy9hYkHARKXtJzBVe/gouMGDBZoS+dvM29FwmS+9wLJfJBIJBIJC25iDc7zfDWZTD601tR1vRl7T5SAPM9XQAEgIoVNRPCAY/kDNhFBA87Ir4EHGB8RLKAtb4xZVFX1orVGRAoYFxEk4IL8EqCu641NhHjw/UeXfNe5siwHuSl7xcsMlc+y7K19bugMb7/ANfIisug7dwkvAaHkwUNASHlwHBBaHhwGxJAHRwGx5MFBQEx5sAyILQ8WD9m5xye0PFgEHHYXiCcPjlYJpdTJ4hVCHjztQm15YO1DHuDWxSVN0zzOZrO/z235siznLuacw0mAiCyMMYfPx195lQe/67R3ebB8B/b/9eLkUpHldrtd29ydSCQSiSD0vgNZlr2LyHMImTbGmM+qql67zvSuEiLyBGhnVlewn90ZMGSV+HKjM4re2YNWiel0eq+U+rH3GU7TNHe73e475MxEIpG4nl/sFCbjdJvargAAAABJRU5ErkJggg==":null},a.prototype._addEditDel=function(){let o=this;for(let e=0;e<this.TextContents.length;e++){var n,r=this.TextContents[e];if(r.hasAdd&&!r.AnimationEdit&&!r.NoEdit){let e=r.querySelector(".editDelete"),t=r.querySelector(".editImg"),i=r.querySelector(".delImg");-1==this.selectIDs.indexOf(r.id)&&this.selectID!=r.id||"visible"!=r.style.visibility?(t&&(t.style.visibility="hidden"),i&&(i.style.visibility="hidden"),e&&(e.style.visibility="hidden")):(e||((e=document.createElement("div")).className="editDelete",e.style.position="absolute",e.style.top=NDSWebViewer.COMMON.isMobileDevice()?"-30px":"-35px",e.style.display="flex",e.style.marginLeft="0",e.style.backgroundColor="rgba(255,255,255,0.9)",e.style.borderRadius="4px",r.appendChild(e)),t||(n=document.createElement("img"),(t=n).src=NDSWebViewer.COMMON.isMobileDevice()?this._getAppBase64ByType("edit"):this._getBase64ByType("edit"),n.className="editImg",n.style.cursor="pointer",n.style.width=NDSWebViewer.COMMON.isMobileDevice()?"16px":"20px",n.style.height=NDSWebViewer.COMMON.isMobileDevice()?"16px":"20px",n.style.padding="5px 6px",n.style.display="inline-block",n.style.visibility=this.viewer._editIconVisible?"visible":"hidden",n.addEventListener("click",function(e){var t=e.target.parentNode.previousSibling;t.readOnly=!1,t.focus(),o.selectID!=t.parentNode.id&&(t.parentNode.id,o.setSelectId(t.parentNode.id),t.style.border="1px solid #FFC300"),t.selectionStart=t.selectionEnd=t.value.length,t.style.userSelect="auto",t.style.cursor="default",t.readOnly=!o.enableMove,e.preventDefault(),e.stopImmediatePropagation(),e.stopPropagation(),o.setMode("NoteEdit")}),e.insertBefore(n,e.firstChild)),i||(n=document.createElement("img"),(i=n).src=NDSWebViewer.COMMON.isMobileDevice()?this._getAppBase64ByType("delete"):this._getBase64ByType("delete"),n.className="delImg",n.style.cursor="pointer",n.style.width=NDSWebViewer.COMMON.isMobileDevice()?"16px":"20px",n.style.height=NDSWebViewer.COMMON.isMobileDevice()?"16px":"20px",n.style.padding="5px 6px",n.style.display="inline-block",n.style.visibility=this.viewer._deleteIconVisible?"visible":"hidden",n.addEventListener("click",function(e){e=e.target.parentNode.parentNode;o.deleteNoteAnnotation(e.id)}),e.appendChild(n)),this.viewer._editIconVisible?(t.style.visibility=r.style.visibility,e.style.visibility=r.style.visibility):(t.style.visibility="hidden",e.removeChild(t)),this.viewer._deleteIconVisible?(i.style.visibility=r.style.visibility,e.style.visibility=r.style.visibility):(i.style.visibility="hidden",e.removeChild(i)),this.viewer._editIconVisible||this.viewer._deleteIconVisible||(e.style.visibility="hidden"))}}},a.prototype.EditNote=function(t){for(let e=0;e<this.TextContents.length;e++){var i=this.TextContents[e];!i.hasAdd||i.AnimationEdit||i.NoEdit||i.id==t&&((i=i.childNodes[0]).readOnly=!1,i.focus(),i.selectionStart=i.selectionEnd=i.value.length,i.style.userSelect="auto",i.style.cursor="default",i.readOnly=!this.enableMove,this.setMode("NoteEdit"))}};class l{constructor(e){this.__selectionManager__=e.selectionManager}getSelectedObjects(){return this.__selectionManager__.getSelectedObjects()}getSelectedleafObjects(){return this.__selectionManager__.getSelectedleafObjects()}getSelectedMeshes(){return this.__selectionManager__.getSelectedMeshes()}clearSelection(){this.__selectionManager__.clearSelection()}setSelectType(e){this.__selectionManager__.setSelectType(e)}selectByClick(e,t,i){this.__selectionManager__.selectByClick(e,t,i)}selectObject(e,t,i){this.__selectionManager__.selectObject(e,t,i)}deselectObject(e,t){this.__selectionManager__.deselectObject(e,t)}}i=new class extends o{constructor(){super(),this.setFlags(r.FLAG_ENABLE_NODE_BROADCAST),this.name="AnnotationExtension",console.log("AnnotationExtension version 1.0.0")}onLoad(e){this.sceneWraper=new n(e),e.annotationsManager=new s(e,this),this.coreView=e;this.selectWraper=new l(e),this.sceneWraper.registOperator("OpAnnotationNew",function(e){return new a(e)})}clear(){this.removeAllAnnotations(!1)}onNdsModelPrepareForRendering(){var e;this.coreView.controls.staticAnnotation||(e=this.coreView.controls.getOperator().type,this.coreView.setOperatorByID("OpAnnotationNew"),this.coreView.setOperatorByID(e))}onAfterNdsModelUpdate(){var e;this.coreView.controls.staticAnnotation||(e=this.coreView.controls.getOperator().type,this.coreView.setOperatorByID("OpAnnotationNew"),this.coreView.setOperatorByID(e))}onAfterNdsModelSetRender(){}onAfterWindowsResize(e,t,i){e&&this.coreView.annotationsManager.setSize(t,i)}onAfterGetBroadcastInfo(e){var t={};t.isAnnotationsVisible=this.isAnnotationsVisible(),t.selectAnnotation=this.getSelectAnnotation(),e.annotationInfo=t}onAfterSetBroadcastInfo(e){e=e.annotationInfo;e&&(null!=e.isAnnotationsVisible&&this.setAnnotationsVisibility(e.isAnnotationsVisible),null!=e.selectAnnotation&&this.selectAnnotation(e.selectAnnotation),void 0!==e.shouldShowAnnotationContent&&this.showNoteAnnotation(e.shouldShowAnnotationContent),void 0!==e.annotationNoteContent)&&(this.clearAnnotation(),this.setNoteAnnotation(e.annotationNoteContent))}createNote(){this.coreView.controls.staticAnnotation&&this.coreView.controls.staticAnnotation.createText()}setAnnotationsVisibilityByUuid(e,t){e=!!e,this.coreView.annotationsManager&&this.coreView.annotationsManager.setAnnotationsVisibilityByUuid(e,t),this.setPicTextVisible(t,e),this.updateBroadcastInfo()}setPicTextVisible(e,t){this.coreView.controls.staticAnnotation&&this.coreView.controls.staticAnnotation.setPicTextVisible(e,t)}showAnnotation(e,t,i){this.coreView.annotationsManager.addAnnotation(e,t),0!=i&&this.coreView.renderAllViews()}showAnnotations(e,t){this.coreView.annotationsManager.addAnnotations(e),0!=t&&this.coreView.renderAllViews()}removeAnnotation(e,t){this.coreView.annotationsManager&&(this.coreView.annotationsManager.removeAnnotation(e),0!=t)&&this.coreView.renderAllViews(),this.deleteNoteAnnotation(e)}removeAnnotations(e,t){if(this.coreView.annotationsManager){for(var i=0,o=e.length;i<o;++i)this.coreView.annotationsManager.removeAnnotation(e[i]);0!=t&&this.coreView.renderAllViews()}}getSelectAnnotation(){if(this.coreView.annotationsManager)return this.coreView.annotationsManager.getSelectAnnotation()}isAnnotationsVisible(){if(this.coreView.annotationsManager)return this.coreView.annotationsManager.isAnnotationsVisible()}updateBroadcastInfo(){NDSWebViewer.SETTING.enableBroadcast&&NDSWebViewer.SETTING.broadcastMajor&&NDSWebViewer.ExtensionManager.updateBroadcastInfo(this.name)}removeAllAnnotations(e){if(this.coreView.annotationsManager&&(this.coreView.annotationsManager.removeAllAnnotations(),0!=e)&&this.coreView.renderAllViews(),this.coreView.controls.staticAnnotation){var t=this.coreView.controls.staticAnnotation.getAllNoteContent();for(let e=0;e<t.length;e++)this.coreView.controls.staticAnnotation.deleteNoteAnnotation(t[e].tagId,!1)}}listenAnnotation(e){this.coreView.annotationsManager.listenAnnotation(e)}getHotPoint(e,t){return this.coreView.annotationsManager.getHotPoint(e,t)}deleteNoteAnnotation(e){this.coreView.controls.staticAnnotation&&this.coreView.controls.staticAnnotation.deleteNoteAnnotation(e,!1),this.coreView.renderAllViews()}showEditIcon(e){this.coreView._editIconVisible=e}showDeleteIcon(e){this.coreView._deleteIconVisible=e}clearAnnotation(){this.coreView.controls.staticAnnotation&&this.coreView.controls.staticAnnotation.clearAnnotation(),this.coreView.render()}setTransparent(e,t){this.coreView.controls.staticAnnotation&&this.coreView.controls.staticAnnotation.setTransparent(e,t),this.coreView.renderAllViews()}setNoteColor(e,t){this.coreView.controls.staticAnnotation&&this.coreView.controls.staticAnnotation.setNoteColor(e,t),this.coreView.renderAllViews()}setNoteLineColor(e,t){this.coreView.controls.staticAnnotation&&this.coreView.controls.staticAnnotation.setNoteLineColor(e,t),this.coreView.renderAllViews()}getNoteContentByID(e){if(this.coreView.controls.staticAnnotation)return this.coreView.controls.staticAnnotation.getNoteContentByID(e)}getPicContentByID(e){if(this.coreView.controls.staticAnnotation)return this.coreView.controls.staticAnnotation.getPicContentByID(e)}getallPicContent(){if(this.coreView.controls.staticAnnotation)return this.coreView.controls.staticAnnotation.getallPicContent()}getSelectedPicContent(){if(this.coreView.controls.staticAnnotation)return this.coreView.controls.staticAnnotation.getSelectedPicContent()}setNoteAnnotation(e){this.coreView.controls.staticAnnotation.setNoteAnnotation(e),this.coreView.renderAllViews()}clearMsgInfo(){this.coreView.controls.staticAnnotation.clearMsgInfo()}setPicAnnotation(e){this.coreView.controls.staticAnnotation.setPicAnnotation(e),this.coreView.renderAllViews()}onCancelHighlight(e){this.coreView.controls.staticAnnotation.onCancelHighlight(e),this.coreView.renderAllViews()}showNoteAnnotation(e){this.coreView.controls.staticAnnotation&&this.coreView.controls.staticAnnotation.showNoteAnnotation(e),this.coreView.render()}getShowNoteAnnotation(){if(this.coreView.controls.staticAnnotation)return this.coreView.controls.staticAnnotation.AnnotationShow}getAllAnnotation(){let n=this,e=[];var t,i=this.getAllNoteContent(),o=(i&&0<i.length&&(e=e.concat(i)),(i=this.GetMeasurePointData())&&0<i.length&&(e=e.concat(i)),[]);for(t in i=this.coreView.annotationsManager.getAnnotationsArray()){var r=i[t];r&&o.push(function(e){var t,i=e,o={};for(t in i)"locationObject"!=t&&(o[t]=i[t]);return o.type="Annotation",o.configNum=n.coreView.ConfigNum,o.configName=n.coreView.ConfigName,o}(r))}return e=e.concat(o)}changeAnnotationIndex(e,t){var i;this.coreView.annotationsManager&&(i=this.coreView.annotationsManager.getAnnotationsArray())[e]&&(i[e].index=t),this.coreView.renderAllViews()}getAllNoteContent(){if(this.coreView.controls.staticAnnotation)return this.coreView.controls.staticAnnotation.getAllNoteContent()}getSelectedNoteContent(){if(this.coreView.controls.staticAnnotation)return this.coreView.controls.staticAnnotation.getSelectedNoteContent()}GetMeasurePointData(){if(this.coreView.controls.staticAnnotation)return this.coreView.controls.staticAnnotation.GetMeasurePointData()}createPicNote(){"OpAnnotationNew"==this.coreView.controls.getOperator().type&&(document.getElementById("picLoad").click(),this.coreView.controls.getOperator().setMode("Picture"))}createPicNote2(e,t,i,o,n,r){this.coreView.controls.staticAnnotation||(s=this.coreView.controls.getOperator().type,this.coreView.setOperatorByID("OpAnnotationNew"),this.coreView.setOperatorByID(s));var s=new THREE.Vector3(e.x,e.y,e.z);0<this.coreView.ndsModel.ModelUpMatrix4.length&&((e=new THREE.Matrix4).fromArray(this.coreView.ndsModel.ModelUpMatrix4),s.applyMatrix4(e)),this.coreView.controls.staticAnnotation.createPicNote(s,t,i,o,n,r)}setPicTextVisible(e,t){this.coreView.controls.staticAnnotation&&this.coreView.controls.staticAnnotation.setPicTextVisible(e,t)}setSelectIdArray(e,t){this.coreView.controls.staticAnnotation&&this.coreView.controls.staticAnnotation.setSelectIdArray(e,t)}enterEditLineNote(e,t){this.coreView.controls.staticAnnotation&&(this.coreView.controls.staticAnnotation.setSelectId(e,!1),this.coreView.controls.staticAnnotation.EditNote(e,!1))}getSelectContent(){if(this.coreView.controls.staticAnnotation)return this.coreView.controls.staticAnnotation.getSelectContent()}setSplitMode(e,t){if(this.coreView.controls.staticAnnotation)return this.coreView.controls.staticAnnotation.setSplitMode(e,t)}getAnnotationColorAndOpacity(e){if(this.coreView.controls.staticAnnotation)return this.coreView.controls.staticAnnotation.getAnnotationColorAndOpacity(e)}resetSelectAnnotation(){this.coreView.annotationsManager&&this.coreView.annotationsManager.resetSelectAnnotation()}CountermandSelectedModel(){var e;this.coreView.annotationsManager&&"body"==this.coreView.annotationsManager.getAnnotationMode()&&0!=(e=this.selectWraper.getSelectedObjects()).length&&(e=e[e.length-1],this.selectWraper.deselectObject(e,!1),e=this.selectWraper.getSelectedObjects(),this.sceneWraper.dispatchEvent({type:"AnnotationSelectionChangeEvent",selectNum:e.length}),this.sceneWraper.renderAllViews())}confirmAnnotation(){if(this.coreView.annotationsManager&&"body"==this.coreView.annotationsManager.getAnnotationMode())return this.coreView.annotationsManager.confirmAnnotation()}getAnnotationMode(){return this.coreView.annotationsManager.getAnnotationMode()}setLineSegAnnotationStyle(e){this.coreView.annotationsManager.setLineSegAnnotationStyle(e)}getLineSegAnnotationStyle(){return this.coreView.annotationsManager.getLineSegAnnotationStyle()}selectAnnotation(t){this.coreView.annotationsManager.selectAnnotation(t),this.coreView.renderAllViews();let i=!1;for(let e=0;e<this.coreView.controls.staticAnnotation.TextContents.length;e++){var o=this.coreView.controls.staticAnnotation.TextContents[e];o.hasAdd&&o.id==t&&(i=!0,this.coreView.controls.staticAnnotation.setSelectId(t,!1),this.coreView.renderAllViews())}i||(this.coreView.controls.staticAnnotation.setSelectId(0),this.coreView.renderAllViews())}addAnnotationPicText(e,t){var i;this.coreView.ndsModel&&(!!((i=this.coreView.ndsModel.fileguidTouuid[e.fileguid])&&0<i.length)&&e.bOnModel&&e.rootfileguid!=this.coreView.ndsModel.rootBodyNode.fileguid&&e.fileguid?this.coreView.annotationsManager.addAnnotation(e,null,!0):(e.rootfileguid!=this.coreView.ndsModel.rootBodyNode.fileguid&&(e.other=!0),this.coreView.annotationsManager.addAnnotation(e))),0!=t&&this.coreView.render()}addAnnotation(e,t){"lineNote"==e.state.origiType?this.setNoteAnnotation(e.state):this.addAnnotationPicText(e.state,t)}addAnnotationSave(e){this.CorrectPosition(e),e.state&&this.addAnnotation(e)}CorrectPosition(t){var e,i;this.coreView.ndsModel&&t.state.rootfileguid&&(e=this.coreView.ndsModel.explodeFactor,this.coreView.ndsModel&&(i=this.coreView.controls.getBoundingBox().getCenter(),this.coreView.ndsModel.setExplodeFactor(i,0)),t.state.rootfileguid!=this.coreView.ndsModel.rootBodyNode.fileguid&&t.state.bOnModel&&t.state.fileguid&&(this.coreView.annotationsManager.getposFromFileGuid(t.state,t,!0),t.list)&&t.list.forEach(function(e){this.coreView.annotationsManager.getposFromFileGuid(t.state,e,!0),e.points&&e.points.forEach(function(e){this.coreView.annotationsManager.getposFromFileGuid(t.state,e,!0)})}),this.coreView.ndsModel)&&(i=this.coreView.controls.getBoundingBox().getCenter(),this.coreView.ndsModel.setExplodeFactor(i,e))}addAnnotations(e,t){this.coreView.annotationsManager.addAnnotations(e),0!=t&&this.coreView.renderAllViews()}setAnnotationsVisibility(e){this.coreView.annotationsManager&&this.coreView.annotationsManager.setAnnotationsVisibility(e),this.showNoteAnnotation(e),this.updateBroadcastInfo()}setAnnotationType(e,t){this.coreView.annotationsManager.setAnnotationType(e,t)}setAnnotationMode(e){this.coreView.annotationsManager.setAnnotationMode(e)}};NDSWebViewer.ExtensionManager.addExtension(i)}],o={},n.m=i,n.c=o,n.d=function(e,t,i){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)n.d(i,o,function(e){return t[e]}.bind(null,o));return i},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=0);function n(e){var t;return(o[e]||(t=o[e]={i:e,l:!1,exports:{}},i[e].call(t.exports,t,t.exports,n),t.l=!0,t)).exports}var i,o});