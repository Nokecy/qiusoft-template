!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.NDSPrintPDFEx=e():t.NDSPrintPDFEx=e()}(window,function(){return i=[function(t,e,i){i.r(e);console.log("NDS ExtensionFramework V0.1");let n={FLAG_ENABLE_NODE_TRANSFORM:NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM,FLAG_ENABLE_NODE_STOREVIEW:NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM<<1,FLAG_ENABLE_NODE_CAMERA2D:NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM<<2,FLAG_ENABLE_NODE_BLOCK:NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM<<3,FLAG_ENABLE_NODE_TEXT:NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM<<4};class r extends NDSWebViewer.Extension{constructor(){super()}onLoad(t){}onInitLights(){}update(t){}setFlags(t){super.setFlags(t)}onNdsModelPrepareForRendering(t){}onBeforeNdsModelUpdate(t,e){}onAfterNdsModelUpdate(t,e){}onBeforeNdsModelSetRender(t,e){}onAfterNdsModelSetRender(t,e){}onBeforeNdsMeshRender(t,e){}getExtensionWithFlags(t){return NDSWebViewer.ExtensionManager.getExtensionWithFlags(t)}resetToDefault(){}getStoreInfo(t){throw this.name+" Extesion did not implement method 'getStoreInfo' "}setStoreInfo(t){throw this.name+" Extesion did not implement method 'setStoreInfo' "}getBodyTransform(t){return new THREE.Matrix4}getBodyNodeTranslate(t){return new THREE.Vector3(0,0,0)}}class h{constructor(h){this.viewer=h,this.pdfInfo={fileName:"temp",colorType:"color",size:"A4",width:297,height:210,orientation:"l",align:0,xAlign:0,yAlign:0,scale:1,xSelMin:0,xSelMax:0,ySelMin:0,ySelMax:0,xLen:0,yLen:0};this.colorMap=new Map,this.linePointArray={},this.meshPointArray=[],this.textPointArray=[],this.pointPointArray={},this.imageInfoArray=[],this.fontArray=[],this.textInfoArray=[],this.lineStyleArray=[],this.totalPointNum=0,this.setPDFInfo=function(t,e,i,n,r,o){var a,s;this.viewer.is2DModel&&(s=this.viewer.getCameraInfo(),a=new THREE.Vector3(s.up.x,s.up.y,s.up.z),this.rad=-a.angleTo(new THREE.Vector3(0,1,0)),this.matrixWorld=(new THREE.Matrix4).makeRotationAxis(new THREE.Vector3(0,0,1),this.rad),this.transPosition=new THREE.Vector3(s.target.x,s.target.y,0),this.pdfInfo.fileName=t||"temp",this.pdfInfo.size=e||"A4",this.pdfInfo.orientation=i||"l",this.pdfInfo.colorType=n||"color",this.totalPointNum=0,a=new THREE.Matrix4,(s=new THREE.Matrix4).makeTranslation(-this.transPosition.x,-this.transPosition.y,-this.transPosition.z),a.premultiply(s),a.premultiply(this.matrixWorld),s.makeTranslation(this.transPosition.x,this.transPosition.y,this.transPosition.z),a.premultiply(s),this.cameraRotateMatrix=a,t=new THREE.Vector3,e=new THREE.Vector3,"view"===r?(i=h.renderer.getPixelRatio(),n=this.viewer.renderer.domElement.width/i,s=this.viewer.renderer.domElement.height/i,[t.x,t.y]=this.viewer.clientCoordToModelCoord([0,0]),[e.x,e.y]=this.viewer.clientCoordToModelCoord([n,s]),t.applyMatrix4(a),e.applyMatrix4(a)):"select"===r?(o[0]!==o[2]&&o[1]!==o[3]||(o[2]+=.01,o[3]+=.01),[t.x,t.y]=this.viewer.clientCoordToModelCoord([o[0],o[1]]),[e.x,e.y]=this.viewer.clientCoordToModelCoord([o[2],o[3]]),t.applyMatrix4(a),e.applyMatrix4(a)):(i=new THREE.Box3,this.getAllBBox(i),t.x=i.min.x-.001,t.y=i.min.y-.001,e.x=i.max.x+.001,e.y=i.max.y+.001),this.pdfInfo.xSelMin=Math.min(e.x,t.x),this.pdfInfo.xSelMax=Math.max(e.x,t.x),this.pdfInfo.ySelMin=Math.min(e.y,t.y),this.pdfInfo.ySelMax=Math.max(e.y,t.y),this.setPaperSize(this.pdfInfo.size,this.pdfInfo.orientation),this.setAlign(),this.drawPDFInfo())},this.setPaperSize=function(t,e){switch(t){case"A5":[this.pdfInfo.width,this.pdfInfo.height]=[210,148];break;case"A4":[this.pdfInfo.width,this.pdfInfo.height]=[297,210];break;case"A3":[this.pdfInfo.width,this.pdfInfo.height]=[420,297];break;case"A2":[this.pdfInfo.width,this.pdfInfo.height]=[594,420];break;case"A1":[this.pdfInfo.width,this.pdfInfo.height]=[841,594];break;case"A0":[this.pdfInfo.width,this.pdfInfo.height]=[1189,841];break;default:[this.pdfInfo.width,this.pdfInfo.height]=[297,210]}"l"!=e&&(t=this.pdfInfo.width,this.pdfInfo.width=this.pdfInfo.height,this.pdfInfo.height=t)},this.setAlign=function(){this.pdfInfo.xLen=this.pdfInfo.xSelMax-this.pdfInfo.xSelMin,this.pdfInfo.yLen=this.pdfInfo.ySelMax-this.pdfInfo.ySelMin;var t=this.pdfInfo.xLen/this.pdfInfo.yLen;this.pdfInfo.height,this.pdfInfo.width;t>this.pdfInfo.width/this.pdfInfo.height?(this.pdfInfo.xAlign=.02*this.pdfInfo.width,this.pdfInfo.yAlign=(this.pdfInfo.height-(this.pdfInfo.width-2*this.pdfInfo.xAlign)/t)/2,this.pdfInfo.scale=(this.pdfInfo.height-2*this.pdfInfo.yAlign)/this.pdfInfo.yLen):(this.pdfInfo.yAlign=.02*this.pdfInfo.height,this.pdfInfo.xAlign=(this.pdfInfo.width-(this.pdfInfo.height-2*this.pdfInfo.yAlign)*t)/2,this.pdfInfo.scale=(this.pdfInfo.width-2*this.pdfInfo.xAlign)/this.pdfInfo.xLen)},this.drawPDFInfo=function(){this.viewer.ndsModel.setDirty();var i=this.viewer.ndsModel.activeModel.getMeshSets();for(let t=0;t<i.length;t++)i[t].prepareForBatchDraw();var n=["opaque","line","ttf","shx","point","ltMesh","ltLine","ltPoint","line2World","line2Mesh","mapMesh"];for(let e=this.drawLinecount=0;e<n.length;e++)if("line2Mesh"!==n[e]||this.viewer.showLineWidth)for(let t=0;t<i.length;t++){var r=i[t];this.drawBatchedObjects(r,0,n[e],0)}},this.drawBatchedObjects=function(t,e,i,n){var r=81920,o=[];return"line"===i?(t.fetchLineForDraw(o,r),this.drawLine(t,o,n,2,!0)):"point"===i?(t.fetchPointForDraw(o,r),this.drawPoint(t,o,n,1)):"opaque"===i?(t.fetchOpaqueForDraw(o,e,r),this.drawMesh(t,o,n,3)):"ttf"===i?(t.fetchTTFTextForDraw(o,r),3<this.viewer.modelContentVersion?this.drawText(t,o,n,3):this.drawTextOld(t,o,n,3)):"shx"===i?(t.fetchSHXTextForDraw(o,r),this.drawText(t,o,n,2)):"ltMesh"===i?3<this.viewer.modelContentVersion&&(t.fetchLTMeshForDraw(o,r),this.drawLine(t,o,n,3)):"ltLine"===i?(t.fetchLTLineForDraw(o,r),this.drawLine(t,o,n,2)):"ltPoint"===i?(t.fetchLTPointForDraw(o,r),this.drawLine(t,o,n,1)):"line2Mesh"===i?t.fetchLine2MeshForDraw(o,r):"line2World"===i?(t.fetchLine2WorldForDraw(o,e=[],r),this.drawLine(t,e,n,2,!0)):"mapMesh"===i&&(t.fetchMapMeshForDraw(o,r),this.drawMesh(t,o,n,6)),o},this.drawPoint=function(e,i,n,r){for(let t=0;t<i.length;t++){i[t].material;var o=i[t].geometry,a=i[t].localIndex,s=this.getPointColor(e,a),s={colorId:this.getColorTableId(s)},h=new THREE.Matrix4;e.getPointWorldMatrix(a,h),h.premultiply(this.cameraRotateMatrix),this.draw(r,o,s,h,n)}},this.drawLine=function(e,i,n,r,o){for(let t=0;t<i.length;t++){var a=i[t].material,s=i[t].geometry,h=i[t].localIndex,l=this.getLineColor(e,h),l=this.getColorTableId(l),f=new THREE.Matrix4;e.getLineWorldMatrix(h,f),f.premultiply(this.cameraRotateMatrix),o&&-1<a.lineTypeId?this.drawLineType(r,s,{lineTypeId:a.lineTypeId,lineScale:a.lineScale,colorId:l},f,this.drawLinecount++):this.draw(r,s,{colorId:l},f,2===r?this.drawLinecount++:n)}},this.drawMesh=function(e,i,n,r){for(let t=0;t<i.length;t++){var o=i[t].material,a=i[t].geometry,s=i[t].localIndex,h=this.getMeshColor(e,s),h={colorId:this.getColorTableId(h),image:o.map?o.map.image:void 0},o=new THREE.Matrix4;e.getMeshWorldMatrix(s,o),o.premultiply(this.cameraRotateMatrix),this.draw(r,a,h,o,n)}},this.drawText=function(i,n,r,o){for(let e=0;e<n.length;e++){n[e].material;var a=n[e].geometry,s=n[e].localIndex,h=this.getTextColor(i,s),l=!!a.viewBox;let t=null;l&&(t=new THREE.Box3,f=new THREE.Vector3(a.viewBox.max2.x,a.viewBox.max2.y,0),d=new THREE.Vector3(a.viewBox.min2.x,a.viewBox.min2.y,0),t.expandByPoint(f),t.expandByPoint(d));var f={colorId:this.getColorTableId(h),hasViewBox:l,box:t},d=new THREE.Matrix4,h=(i.getTextWorldMatrix(s,d),(new THREE.Matrix4).copy(d).premultiply(this.cameraRotateMatrix));this.draw(o,a,f,h,2==o?this.drawLinecount++:r,d)}},this.getMeshColor=function(t,e){t=t.meshes[e],e=this.viewer.ndsModel.activeModel.meshManager,t=e.materialId[t];return e.mats[t].color.getHex()},this.getLineColor=function(t,e){t=t.lines[e],e=this.viewer.ndsModel.activeModel.meshManager,t=e.lineSegMaterialId[t];return e.mats[t].color.getHex()},this.getPointColor=function(t,e){t=t.points[e],e=this.viewer.ndsModel.activeModel.meshManager,t=e.lineSegMaterialId[t];return e.mats[t].color.getHex()},this.getTextColor=function(t,e){t=t.texts[e],e=this.viewer.ndsModel.activeModel.meshManager,t=e.textMaterialId[t];return e.mats[t].color.getHex()},this.draw=function(t,e,i,n,r,o){var a=i.colorId,s=e.getAttribute("position");let h,l,f;for(var d,p,x,y,u,g,c,m,w,I=new THREE.Vector3,A=new THREE.Vector3,M=new THREE.Vector3,E=t,T=e.drawRange.start,P=e.drawRange.start+e.drawRange.count;T<P;T+=E)if(1===t){if(h=e.index.getX(T),I.fromBufferAttribute(s,h),I.applyMatrix4(n),this.normalize(I),!(I.x<0||1<I.x||I.y<0||1<I.y)){var[v,b]=this.getPDFCood(I);let t=this.pointPointArray[a];t||(t=new Array,this.pointPointArray[a]=t),t.push(v,b),this.totalPointNum+=2}}else if(2===t){if(h=e.index.getX(T),l=e.index.getX(T+1),I.fromBufferAttribute(s,h),A.fromBufferAttribute(s,l),i.hasViewBox){v=(new THREE.Vector3).copy(I).applyMatrix4(o),b=(new THREE.Vector3).copy(A).applyMatrix4(o);if(!i.box.containsPoint(v)||!i.box.containsPoint(b))continue}I.applyMatrix4(n),A.applyMatrix4(n),this.normalize(I),this.normalize(A);var S=this.clipLine(I,A);if(0<S.length){var[S,R,F,D]=this.getPDFCood(S[0],S[1]);let t=this.linePointArray[r];t||(t=new Array,this.linePointArray[r]=t),t.push(S,R,F,D,a,-1),this.totalPointNum+=6}}else if(3===t){if(h=e.index.getX(T),l=e.index.getX(T+1),f=e.index.getX(T+2),I.fromBufferAttribute(s,h),A.fromBufferAttribute(s,l),M.fromBufferAttribute(s,f),i.hasViewBox){S=(new THREE.Vector3).copy(I).applyMatrix4(o),R=(new THREE.Vector3).copy(A).applyMatrix4(o),F=(new THREE.Vector3).copy(M).applyMatrix4(o);if(!i.box.containsPoint(S)||!i.box.containsPoint(R)||!i.box.containsPoint(F))continue}I.applyMatrix4(n),A.applyMatrix4(n),M.applyMatrix4(n),this.normalize(I),this.normalize(A),this.normalize(M);var L=this.clipTriangle(I,A,M);for(let t=0;t<L.length;t+=3){var[N,B,H,V,z,C]=this.getPDFCood(L[t],L[t+1],L[t+2]);this.meshPointArray.push(N,B,H,V,z,C,a),this.totalPointNum+=7}}else 6===t&&(D=new THREE.Box3,I.fromBufferAttribute(s,e.index.getX(T)),I.applyMatrix4(n),D.expandByPoint(I),I.fromBufferAttribute(s,e.index.getX(T+1)),I.applyMatrix4(n),D.expandByPoint(I),I.fromBufferAttribute(s,e.index.getX(T+2)),I.applyMatrix4(n),D.expandByPoint(I),I.fromBufferAttribute(s,e.index.getX(T+3)),I.applyMatrix4(n),D.expandByPoint(I),I.fromBufferAttribute(s,e.index.getX(T+4)),I.applyMatrix4(n),D.expandByPoint(I),I.fromBufferAttribute(s,e.index.getX(T+5)),I.applyMatrix4(n),D.expandByPoint(I),u=D.min.clone(),y=D.max.clone(),this.normalize(u),this.normalize(y),g=u.clone(),(c=y.clone()).x<0||1<g.x||c.y<0||1<g.y||(g.x<0&&(g.x=0),g.y<0&&(g.y=0),1<c.x&&(c.x=1),1<c.y&&(c.y=1),d=(g.x-u.x)/(y.x-u.x)*i.image.width,p=Math.abs(c.y-y.y)/(y.y-u.y)*i.image.height,x=(c.x-u.x)/(y.x-u.x)*i.image.width,y=Math.abs(g.y-y.y)/(y.y-u.y)*i.image.height,[u,g,c,m]=this.getPDFCood(g,c),(w=document.createElement("canvas")).width=x-d,w.height=y-p,w.getContext("2d").drawImage(i.image,d,p,w.width,w.height,0,0,w.width,w.height),w=w.toDataURL(),this.imageInfoArray.push({data:w,pos:[u,m,c,g],refs:[d,p,x,y]})))},this.drawLineType=function(t,e,i,n,r){var[o,a]=this.getLineStyleGeomInfoNewPDF(e,i.lineTypeId,i.lineScale),s=new THREE.Vector3,h=new THREE.Vector3;for(let t=0;t<o.length;t+=6)if(s.set(o[t+0],o[t+1],o[t+2]),h.set(o[t+3],o[t+4],o[t+5]),s.applyMatrix4(n),h.applyMatrix4(n),this.normalize(s),this.normalize(h),0<this.clipLine(s,h).length){var[l,f,d,p]=this.getPDFCood(s,h);let t=this.linePointArray[r];t||(t=new Array,this.linePointArray[r]=t),t.push(l,f,d,p,i.colorId,-1),this.totalPointNum+=6}if(a){var x,y=new THREE.Vector3;for(x in a){var u=a[x],g={name:u.fontName,size:u.size,isShx:u.isShx,style:"normal",weight:"normal",width:1};for(let t=0;t<u.data.length;t+=3){y.set(u.data[t],u.data[t+1],0),y.applyMatrix4(n),this.normalize(y);var[c,m]=this.getPDFCood(y),w=this.getFontTableId(g);this.setTextInfoArray(x,u.data[t+2],i.colorId,w,c,m)}}}},this.drawTextOld=function(e,i,n,r){for(let t=0;t<i.length;t++){i[t].material;var o=i[t].geometry,a=i[t].localIndex,s=this.getTextColor(e,a),s={colorId:this.getColorTableId(s)},h=new THREE.Matrix4;e.getTextWorldMatrix(a,h),this.drawTextImage(r,o,s,h,n)}},this.drawTextImage=function(t,e,i,n,r){var o=i.colorId,a=e.getAttribute("position");let s,h,l,f,d=0;for(var p,x,y=new THREE.Vector3,u=new THREE.Vector3,g=new THREE.Vector3,c=new THREE.Vector3,m=[],w=e.drawRange.start,I=e.drawRange.start+e.drawRange.count;w<I;w+=6)s=e.index.getX(w),h=e.index.getX(w+1),l=e.index.getX(w+2),f=e.index.getX(w+3),y.fromBufferAttribute(a,s),u.fromBufferAttribute(a,h),g.fromBufferAttribute(a,l),c.fromBufferAttribute(a,f),y.applyMatrix4(n),u.applyMatrix4(n),g.applyMatrix4(n),c.applyMatrix4(n),this.normalize(y),this.normalize(u),this.normalize(g),this.normalize(c),this.testPoint(y)&&this.testPoint(u)&&this.testPoint(g)&&this.testPoint(c)&&([p,x]=this.getPDFCood(u),0<m.length&&m[m.length-1][1]===d-1?m[m.length-1][1]++:m.push([d,d,p,x])),d++;if(0<m.length){var i=this.viewer.ndsModel.activeModel.SDFMaker.GetFontsInfo(e.font),A=this.getFontTableId(i),M=e.text;for(let t=0;t<m.length;t++){var E=M.substring(m[t][0],m[t][1]+1);this.setTextInfoArray(E,0,o,A,m[t][2],m[t][3])}}},this.setTextInfoArray=function(t,e,i,n,r,o){var a={},t=(a.text=t,a.data=[2,i,n],.001<Math.abs(+e)&&(a.angle=parseFloat((180*(0<e?2*Math.PI-e:Math.abs(e))/Math.PI).toFixed(8))),this.getTextInfoId(a));let s=this.textPointArray[t];s||(s=new Array,this.textPointArray[t]=s),s.push(parseFloat(r.toFixed(8)),parseFloat(o.toFixed(8))),this.totalPointNum+=2},this.getLineStyleGeomInfoNewPDF=function(o,t,C){let _=this.viewer.ndsModel.activeModel.lineTypes,O=_.lineTypeStyle[t],X=_.uuidToLineStyle[O.uuid],W=[],G={};if(X&&0<X.linePattern.length){let B=X.textPattern;var e=X.linePattern;let H=0<e[0],V=[0];V.push(e[0]);for(let t=1;t<e.length;t++)0<e[t]&&(H=!0),0<=e[t-1]*e[t]?V[V.length-1]+=e[t]:V.push(e[t]);let z=!1;for(let t=0;t<B.length;t++)B.isShx||(z=!0);if(z=z&&this.viewer.modelContentVersion<4,H||z){var a={totalLen:0,type:0,points:[],lens:[]};function s(r){if(0<r.points.length){var i=X.pattern,o=r.totalLen/C,[n,t,e,a]=_.getLineTypeAlign(O.array,i,o,r.type),s=r.points[0];r.points[r.points.length-1];if(n<1||1e4<n||B.length&&1e3<n)for(let t=0;t<r.points.length-1;t++){var h=r.points[t],l=r.points[t+1];W.push(h.x,h.y,h.z,l.x,l.y,l.z)}else{var f=new THREE.Vector3,d=new THREE.Vector3,p=Math.abs(e),x=Math.abs(t);if(H){d.copy(s);let t=0,e=0,i=0,n;for(;i<=1e4;){i++;var y=e%V.length;if(e++,(t+=Math.abs(V[y])*a)>o)break;var u=t-p+x;n=0<=V[y];for(let t=0;t<r.points.length-1;t++){var g=r.points[t],c=r.points[t+1],m=r.lens[t]/C,w=r.lens[t+1]/C;if(u<m+x)break;w-x<u?n&&(W.push(d.x,d.y,d.z),d.copy(c),W.push(d.x,d.y,d.z)):(f.subVectors(c,g),c=(u-m)/(w-m),n&&W.push(d.x,d.y,d.z),d.copy(g),d.addScaledVector(f,c),n&&W.push(d.x,d.y,d.z))}}}if(z){var I=new THREE.Vector3,A=new THREE.Vector3,M=new THREE.Vector3;for(let t=0;t<r.points.length-1;t++){var E=r.points[t],T=r.points[t+1],P=r.lens[t]/C,v=r.lens[t+1]/C,b=(f.subVectors(T,E),A.copy(f).normalize(),M.set(0,0,1),M.cross(A).normalize(),I.set(1,0,0),I.angleTo(A)),S=(I.cross(A).normalize(),0<=I.z?1:-1),R=b>Math.PI/2?(b-Math.PI)*S:b*S;I.set(0,0,1);for(let t=0;t<B.length;t++){var F=B[t];if(!F.isShx){var D=X.textGeomArray[t].translateX,L=X.textGeomArray[t].translateY;let e=G[F.text];e||(e={fontName:F.textFont.name,isShx:F.isShx,shapeId:F.shapeId,size:F.textFont.size,data:new Array},G[F.text]=e);for(let t=0;t<n;t++){var N=(F.dash+t*i)*a-p+x;if(!(N<P)){if(v<N)break;f.subVectors(T,E);N=(N-P)/(v-P);d.copy(E),d.addScaledVector(f,N),b>Math.PI/2&&(d.addScaledVector(A,D),F.isShx||d.addScaledVector(M,L)),d.addScaledVector(A,F.offset.x),d.addScaledVector(M,F.offset.y),e.data.push(d.x,d.y,R+F.rotation)}}}}}}}}}let i,n,r=-1;var h=new THREE.Vector3,l=new THREE.Vector3,f=new THREE.Vector3,d=o.getAttribute("position"),p=o.getAttribute("lineDistance");for(let t=o.drawRange.start,e=o.drawRange.start+o.drawRange.count;t<e;t+=2){i=o.index.getX(t),n=o.index.getX(t+1);var x=(new THREE.Vector3).fromBufferAttribute(d,i),y=(new THREE.Vector3).fromBufferAttribute(d,n);h.fromBufferAttribute(p,i),l.fromBufferAttribute(p,n),t!=o.drawRange.start&&r===i||f.equals(x)?(a.points.push(y),a.lens.push(l.x)):(s(a),a.totalLen=h.y,a.type=h.z,a.points=[],a.lens=[],a.points.push(x,y),a.lens.push(h.x,l.x)),f.copy(y),r=n}s(a)}}else{var i=o.getAttribute("position");for(let t=o.drawRange.start,e=o.drawRange.start+o.drawRange.count;t<e;t+=2){var n=o.index.getX(t),r=o.index.getX(t+1),n=(new THREE.Vector3).fromBufferAttribute(i,n),r=(new THREE.Vector3).fromBufferAttribute(i,r);W.push(n.x,n.y,n.z,r.x,r.y,r.z)}}return[W,G]},this.testPoint=function(t){return 0<=t.x&&t.x<=1&&0<=t.y&&t.y<=1},this.normalize=function(t){t.x=(t.x-this.pdfInfo.xSelMin)/this.pdfInfo.xLen,t.y=(t.y-this.pdfInfo.ySelMin)/this.pdfInfo.yLen},this.getPDFCood=function(t,e,i){var n=this.pdfInfo.width-2*this.pdfInfo.xAlign,r=this.pdfInfo.height-2*this.pdfInfo.yAlign;let o,a,s,h,l,f;return o=t.x*n+this.pdfInfo.xAlign,a=(1-t.y)*r+this.pdfInfo.yAlign,e&&(s=e.x*n+this.pdfInfo.xAlign,h=(1-e.y)*r+this.pdfInfo.yAlign),i?(l=i.x*n+this.pdfInfo.xAlign,f=(1-i.y)*r+this.pdfInfo.yAlign,[o,a,s,h,l,f]):e?[o,a,s,h]:[o,a]},this.getLineStyleTableId=function(e,i){for(let t=0;t<this.lineStyleArray.length;t++)if(this.lineStyleArray[t].lineTypeId===e&&Math.abs(this.lineStyleArray[t].scale-i)<1e-8)return t;return this.lineStyleArray.push({lineTypeId:e,data:this.getLineStyleArray(e),scale:i}),this.lineStyleArray.length-1},this.getColorTableId=function(t){var e,t=16777215===t?16777215-t:t;return this.colorMap.has(t)?this.colorMap.get(t):(e=this.colorMap.size,this.colorMap.set(t,e),e)},this.getFontTableId=function(e){var i;for(let t=0;t<this.fontArray.length;t++)if((i=this.fontArray[t]).name===e.name&&i.bigName===e.bigName&&i.style===e.style&&i.weight===e.weight&&Math.abs(i.size-e.size)<1e-8&&Math.abs(i.width-e.width)<1e-8)return t;return this.fontArray.push({bigName:e.bigName,name:e.name,style:e.style,weight:e.weight,size:e.size,width:e.width}),this.fontArray.length-1},this.getTextInfoId=function(e){for(let t=0;t<this.textInfoArray.length;t++)if(this.textInfoArray[t].text===e.text&&this.textInfoArray[t].data[1]===e.data[1]&&this.textInfoArray[t].data[2]===e.data[2]&&this.textInfoArray[t].angle===e.angle)return this.textInfoArray[t].data[0]+=2,t;return this.textInfoArray.push(e),this.textInfoArray.length-1},this.getLineStyleArray=function(t){t=this.viewer.ndsModel.activeModel.lineTypes.lineTypeStyle[t];return this.viewer.ndsModel.activeModel.lineTypes.uuidToLineStyle[t.uuid].linePattern},this.getStrUnicode=function(t){let e="",i="";for(var n=0;n<t.length;n++){var r=t.charCodeAt(n),o=r.toString(16);i=r<15?"\\u000"+o:r<255?"\\u00"+o:r<4095?"\\u0"+o:"\\u"+o,e+=i}return e},this.getAllBBox=function(i){var e=this.viewer.ndsModel.rootBodyNode;if(e&&e.children){var n=this.viewer.ndsModel.activeModel.meshManager;for(let t=0;t<e.children.length;t++){var r=e.children[t];if(r.leafBodyAttri&&!r.isHidden()){var o=r.leafBodyAttri.bodyMeshIds;if(o)for(let t=0,e=o.length;t<e;++t){var a,s=o[t];-1<n.geomId[s]&&(a=n.geomManager.getGeomFromId(n.geomId[s]),s=(new THREE.Matrix4).fromArray(n.matrixes,16*n.matrixId[s]),b(a=a.boundingBox.clone()))&&(a.applyMatrix4(s).applyMatrix4(this.cameraRotateMatrix),i.union(a))}var h=r.leafBodyAttri.bodyLineSegIds;if(h)for(let t=0,e=h.length;t<e;++t){var l,f=h[t];-1<n.lineSegGeomId[f]&&((l=n.geomManager.getGeomFromId(n.lineSegGeomId[f])).isPoints||(f=(new THREE.Matrix4).fromArray(n.matrixes,16*n.lineSegMatrixId[f]),b(l=l.boundingBox.clone())&&(l.applyMatrix4(f).applyMatrix4(this.cameraRotateMatrix),i.union(l))))}var d=r.leafBodyAttri.bodyTextIds;if(d)for(let t=0,e=d.length;t<e;++t){var p,x=d[t];-1<n.textGeomId[x]&&!function(e){if(e&&e.text&&" "!==e.text)for(let t=0;t<e.text.length;t++)if(" "!=e.text[t])return;return 1}(p=n.geomManager.getGeomFromId(n.textGeomId[x]))&&(x=(new THREE.Matrix4).fromArray(n.matrixes,16*n.textMatrixId[x]),b(p=p.boundingBox.clone()))&&(p.applyMatrix4(x).applyMatrix4(this.cameraRotateMatrix),i.union(p))}}}var y=this.viewer.ndsModel.activeModel.getMeshSets();for(let t=0;t<y.length;t++){var u=y[t];for(let t=0;t<u.ltLines.length;t++){var g=u.ltLines[t],c=u.drawingLines[g.drawingIndex];if(!c.bodyNode.isHidden())for(var m,w,I=new THREE.Matrix4,A=(u.getLineWorldMatrix(c.localIndex,I),g.geometry),M=A.getAttribute("position"),E=new THREE.Vector3,T=new THREE.Vector3,P=A.drawRange.start,v=A.drawRange.start+A.drawRange.count;P<v;P+=2)m=A.index.getX(P),w=A.index.getX(P+1),E.fromBufferAttribute(M,m),T.fromBufferAttribute(M,w),E.applyMatrix4(I).applyMatrix4(this.cameraRotateMatrix),T.applyMatrix4(I).applyMatrix4(this.cameraRotateMatrix),i.expandByPoint(E),i.expandByPoint(T)}}}function b(t){return t&&!t.min.equals(t.max)}},this.sendFile=function(t){let n={name:this.pdfInfo.fileName,size:this.pdfInfo.size,orientation:this.pdfInfo.orientation,unit:"mm",colorType:this.pdfInfo.colorType,version:this.viewer.modelContentVersion,color:[],font:[],lineStyle:[],image:[],meshInfo:{start:0,step:7,data:[]},lineInfo:{start:0,step:6,lineWidth:.1,data:[]},textInfo:{start:0,data:[]},pointInfo:{start:0,step:3,data:[]}};var e,i,r=new ArrayBuffer(4*this.totalPointNum),o=new Float32Array(r);let a=0;for(e in n.meshInfo.start=a,o.set(this.meshPointArray,a),a+=this.meshPointArray.length,n.meshInfo.data.push(this.meshPointArray.length),n.lineInfo.start=a,this.linePointArray){var s=this.linePointArray[e];o.set(s,a),a+=s.length,n.lineInfo.data.push(s.length)}n.textInfo.start=a;for(let t=0;t<this.textPointArray.length;t++){var h=this.textPointArray[t];o.set(h,a),a+=h.length}for(i in n.pointInfo.start=a,this.pointPointArray){var l=this.pointPointArray[i];o.set(l,a),a+=l.length,n.pointInfo.data.push(l.length,parseInt(i),.1)}this.colorMap.forEach(function(t,e){e=new THREE.Color(e);n.color[t]=e.getHexString()});for(let i=0;i<this.fontArray.length;i++){let e=this.fontArray[i].name;e=""===e?"YAHEI.ttf":-1===this.fontArray[i].name.search(/\./g)?this.fontArray[i].name+".ttf":this.fontArray[i].name;var f=this.viewer.ndsModel.activeModel.SDFMaker.IsShxFont(e);if(this.fontArray[i].isShx)n.font.push({name:e,size:parseFloat((this.fontArray[i].size*this.pdfInfo.scale).toFixed(8)),isShx:this.fontArray[i].isShx,style:this.fontArray[i].style,weight:this.fontArray[i].weight,width:this.fontArray[i].width,index:i});else{let t=this.fontArray[i].size*this.pdfInfo.scale;this.viewer.modelContentVersion<=2&&(t*=f?.9:1),this.viewer.modelContentVersion<=2&&"gbcbig.shx"===e&&(t*=.15),n.font.push({name:e,size:parseFloat(t.toFixed(8)),style:this.fontArray[i].style,weight:this.fontArray[i].weight,width:this.fontArray[i].width,index:i})}}for(let e=0;e<this.lineStyleArray.length;e++){var d=this.lineStyleArray[e].data.slice();for(let t=0;t<d.length;t++)d[t]=parseFloat((d[t]*this.lineStyleArray[e].scale*this.pdfInfo.scale).toFixed(8));n.lineStyle.push(d)}for(let t=0;t<this.textInfoArray.length;t++)this.textInfoArray[t].text=this.getStrUnicode(this.textInfoArray[t].text);return n.textInfo.data=this.textInfoArray,n.image=this.imageInfoArray,{jsonData:JSON.stringify(n),binData:r}},this.clear=function(){this.colorMap=null,this.linePointArray=null,this.meshPointArray=null,this.textPointArray=null,this.pointPointArray=null,this.imageInfoArray=null,this.fontArray=null,this.textInfoArray=null,this.lineStyleArray=null,this.totalPointNum=0}}PDFTest(){this.totalPointNum=0,this.pdfInfo.fileName="temp",this.pdfInfo.size="A4",this.pdfInfo.orientation="p",this.pdfInfo.colorType="color",this.pdfInfo.xSelMin=0,this.pdfInfo.ySelMin=0,this.pdfInfo.xSelMax=210,this.pdfInfo.ySelMax=297,this.setPaperSize(this.pdfInfo.size,this.pdfInfo.orientation),this.setAlign();{this.colorArray.push("000000"),this.lineStyleArray.push({lineTypeId:0,data:[10,-10],scale:1});let t=this.linePointArray[0];t||(t=new Array,this.linePointArray[0]=t),t.push(10,10,110,10,0,0),this.totalPointNum+=6,t.push(10,20,20,20,0,-1),this.totalPointNum+=6,t.push(30,20,40,20,0,-1),this.totalPointNum+=6,t.push(50,20,60,20,0,-1),this.totalPointNum+=6,t.push(70,20,80,20,0,-1),this.totalPointNum+=6,t.push(90,20,100,20,0,-1),this.totalPointNum+=6,t.push(10,30,110,30,0,-1),this.totalPointNum+=6,(t=this.pointPointArray[0])||(t=new Array,this.pointPointArray[0]=t),t.push(30,8),this.totalPointNum+=2,t.push(70,8),this.totalPointNum+=2}this.sendFile()}PDFTestDraw(t){this.group||(this.group=new THREE.Group,this.viewer.scene.add(this.group));t=new THREE.Box3Helper(t,16711680);t.updateMatrixWorld(!0),this.group.add(t)}clipLine(t,e){let i=[];return i=this.cohenSutherlandLineClipAndDraw(t,e)?[t,e]:i}computeOutCode(t,e){let i=0;return t<0?i|=1:1<t&&(i|=2),e<0?i|=4:1<e&&(i|=8),i}cohenSutherlandLineClipAndDraw(i,n){let r=this.computeOutCode(i.x,i.y),o=this.computeOutCode(n.x,n.y),t=!1;for(;;){if(!(r|o)){t=!0;break}if(r&o)break;{let t,e;var a=r||o;8&a?(t=i.x+(n.x-i.x)*(1-i.y)/(n.y-i.y),e=1):4&a?(t=i.x+(n.x-i.x)*(0-i.y)/(n.y-i.y),e=0):2&a?(e=i.y+(n.y-i.y)*(1-i.x)/(n.x-i.x),t=1):1&a&&(e=i.y+(n.y-i.y)*(0-i.x)/(n.x-i.x),t=0),a===r?(i.x=t,i.y=e,r=this.computeOutCode(i.x,i.y)):(n.x=t,n.y=e,o=this.computeOutCode(n.x,n.y))}}return!!t}clipTriangle(t,e,i){let n=[e,t,i];var r=[[0,0],[0,1],[1,1],[1,0]];for(let t=0;t<4;t++){var o=(t+1)%4;if(0===(n=this.sutherlandHodgman(n,n.length,r[t][0],r[t][1],r[o][0],r[o][1])).length)break}return 4===n.length&&n.push(n[0],n[2]),5===n.length&&n.push(n[0],n[0],n[2],n[3]),6===n.length&&n.push(n[0],n[2],n[3],n[0],n[3],n[5]),n}x_letersect(t,e,i,n,r,o,a,s){return((t*n-e*i)*(r-a)-(t-i)*(r*s-o*a))/((t-i)*(o-s)-(e-n)*(r-a))}y_letersect(t,e,i,n,r,o,a,s){return((t*n-e*i)*(o-s)-(e-n)*(r*s-o*a))/((t-i)*(o-s)-(e-n)*(r-a))}sutherlandHodgman(e,i,n,r,o,a){let s=[],h=0;for(let t=0;t<i;t++){var l,f,d=(t+1)%i,p=e[t].x,x=e[t].y,y=e[d].x,d=e[d].y,u=(o-n)*(x-r)-(a-r)*(p-n),g=(o-n)*(d-r)-(a-r)*(y-n);u<0&&g<0?(s.push(new THREE.Vector2(y,d)),h++):0<=u&&g<0?(l=this.x_letersect(n,r,o,a,p,x,y,d),f=this.y_letersect(n,r,o,a,p,x,y,d),s.push(new THREE.Vector2(l,f)),h++,s.push(new THREE.Vector2(y,d)),h++):u<0&&0<=g&&(l=this.x_letersect(n,r,o,a,p,x,y,d),f=this.y_letersect(n,r,o,a,p,x,y,d),s.push(new THREE.Vector2(l,f)),h++)}return s}}i=new class extends r{constructor(){super(),this.setFlags(n.FLAG_ENABLE_NODE_TEXT),this.name="NDSPDFExtension",console.log("NDSPDFExtension version 1.0.1"),this.viewer=null,this.printPDF=null,this.getPrintDataCallback=function(t,e,i,n,r,o,a){this.printPDF||(this.printPDF=new h(this.viewer));try{this.printPDF.setPDFInfo(e,i,n,r,o,a);var s=this.printPDF.sendFile();t&&t(s)}catch(t){console.log("print faild. ",t)}this.printPDF.clear(),this.printPDF=null},this.getPrintData=function(t,e,i,n,r,o){console.warn("getPrintData has been discard,use getPrintDataCallback"),this.printPDF||(this.printPDF=new h(this.viewer));let a=null;try{this.printPDF.setPDFInfo(t,e,i,n,r,o),a=this.printPDF.sendFile()}catch(t){console.log("print faild. ",t)}return this.printPDF.clear(),this.printPDF=null,a}}onLoad(t){this.viewer=t}};NDSWebViewer.ExtensionManager.addExtension(i)}],n={},r.m=i,r.c=n,r.d=function(t,e,i){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},r.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(r.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)r.d(i,n,function(t){return e[t]}.bind(null,n));return i},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="",r(r.s=0);function r(t){var e;return(n[t]||(e=n[t]={i:t,l:!1,exports:{}},i[t].call(e.exports,e,e.exports,r),e.l=!0,e)).exports}var i,n});