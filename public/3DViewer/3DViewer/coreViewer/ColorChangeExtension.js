!function(){"use strict";class e{constructor(e){this.__meshstate__=e}getMeshMaterial(e){return this.__meshstate__.getMeshMaterial(e)}setMeshMaterial(e,t){this.__meshstate__.setMeshMaterial(e,t)}setMeshMaterialTemporary(e,t){let r=this.__meshstate__.meshMtls.get(e);if(r){let e=r.material;r.material=t,this.__meshstate__.__updateMeshMtlBuffer(r.meshMtlIndex,r),this.__meshstate__.meshMtlTexture.needsUpdate=!0,r.material=e,r.meshSet.needsUpdate=!0,r.meshSet.prepareForBatchDraw()}}getLineMaterial(e){return this.__meshstate__.getLineMaterial(e)}setLineMaterial(e,t,r){this.__meshstate__.setLineMaterial(e,t,r)}setLineMaterialTemporary(e,t,r){let i=this.__meshstate__.lineMtls.get(e);if(i){let e=2*i.lineMtlIndex;this.__meshstate__.lineMtlBuffer[e]=t,this.__meshstate__.lineMtlBuffer[e+1]=Math.round(1e3*r),this.__meshstate__.lineMtlTexture.needsUpdate=!0}}}class t{constructor(e){this.__brepManager__=e}hasBrepInfo(){return this.__brepManager__.hasBrepInfo()}hasBrepFile(){return this.__brepManager__.hasBrepFile()}getBrepInfos(){return this.__brepManager__.brepInfos}}
/**
	 * @file 这是新迪轻量化引擎查看器插件框架代码，请不要修改此文件
	 * @copyright 新迪数字 2024
	 */class r{constructor(r){this.__ndsModel__=r,r.meshState&&(this.__meshState__=new e(r.meshState)),r.brepManager&&(this.__brepManager__=new t(r.brepManager))}get isMCAD3DModel(){return this.__ndsModel__.isMCAD3DModel}get isMCAD2DModel(){return this.__ndsModel__.isMCAD2DModel}get typeName(){return this.__ndsModel__.typeName}get ndsModelId(){return this.__ndsModel__.id}get numMesh(){}getMeshState(){return this.__meshState__}getBrepManager(){return this.__brepManager__}getPMIObject(){return this.__ndsModel__.pmiObject}getRootBodyNode(){return this.__ndsModel__.rootBodyNode}getBodyNode(e){return this.__ndsModel__.getBodyNode(e)}getLeafBodies(e){return this.__ndsModel__.getLeafBodies(e)}isSketchModel(){return!!this.__ndsModel__.sketchFileUrl}getLeafBodyNodes(){return this.__ndsModel__.wholeLeafBodyNodes}transparentizeBodies(e){this.__ndsModel__.transparentizeBodies(e)}isolateBodies(e){this.__ndsModel__.isolateBodies(e,NDSWebViewer.SETTING.bodyOpacity,NDSWebViewer.SETTING.lineOpacity)}clearTransparentBodies(){this.__ndsModel__.exitIsolate()}getMeshSets(){return this.__ndsModel__.getMeshSets()}changeObjectidTouuid(e){return this.__ndsModel__.objectidTouuid[e]}getMeshMaterial(e){if(!this.__ndsModel__)return null;let t=this.__ndsModel__.meshManager.materialId[e],r=this.__ndsModel__.meshManager.materialUuids[t];return this.__ndsModel__.meshManager.materials[r].mat}setMeshMaterial(e,t){if(!this.__ndsModel__)return!1;let r=this.__ndsModel__,i=0;if(r.meshManager.materials[t.uuid]){for(let e=0;e<r.meshManager.materialUuids.length;e++)if(r.meshManager.materialUuids[e]===t.uuid){i=e;break}}else r.meshManager.materials[t.uuid]={mat:t,refCount:0},i=r.meshManager.materialUuids.length,r.meshManager.materialUuids.push(t.uuid);let o=r.meshManager.materialId[e],s=r.meshManager.materialUuids[o];return r.meshManager.materials[s].refCount--,r.meshManager.materials[t.uuid].refCount++,r.meshManager.materialId[e]=i,r.meshManager.materialIdOriginal[e]=i,!0}removeAllBodyNodeMaterials(){this.__ndsModel__.removeAllBodyNodeMaterials()}removeBodyNodeMaterial(e){this.__ndsModel__.removeBodyNodeMaterial(e)}refreshBodyWorldMatrixUniforms(){this.__ndsModel__.refreshBodyWorldMatrixUniforms()}refreshMeshState(e=void 0){this.__ndsModel__.refreshMeshState(e||this.__ndsModel__.rootBodyNode)}}
/**
	 * @file 这是新迪轻量化引擎查看器插件框架代码，请不要修改此文件
	 * @copyright 新迪数字 2024
	 */console.log("NDS ExtensionFramework V0.1");const i={FLAG_ENABLE_NODE_TRANSFORM:NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM,FLAG_ENABLE_NODE_STOREVIEW:NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM<<1,FLAG_ENABLE_NODE_CAMERA2D:NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM<<2,FLAG_ENABLE_NODE_BLOCK:NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM<<3,FLAG_ENABLE_NODE_TEXT:NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM<<4};class o extends NDSWebViewer.Extension{constructor(){super()}onLoad(e){}onInitLights(){}update(e){}setFlags(e){super.setFlags(e)}onNdsModelPrepareForRendering(e){}onBeforeNdsModelUpdate(e,t){}onAfterNdsModelUpdate(e,t){}onBeforeNdsModelSetRender(e,t){}onAfterNdsModelSetRender(e,t){}onBeforeNdsMeshRender(e,t){}getExtensionWithFlags(e){return NDSWebViewer.ExtensionManager.getExtensionWithFlags(e)}resetToDefault(){}getStoreInfo(e){throw this.name+" Extesion did not implement method 'getStoreInfo' "}setStoreInfo(e){throw this.name+" Extesion did not implement method 'setStoreInfo' "}getBodyTransform(e){return new THREE.Matrix4}getBodyNodeTranslate(e){return new THREE.Vector3(0,0,0)}}
/**
	 * @file 这是新迪轻量化引擎查看器插件框架代码，请不要修改此文件
	 * @copyright 新迪数字 2024
	 */class s{static getModel(e){return e.ndsModel}static getModelId(e){return e.ndsModel.id}static getUUID(e){return e.uuid}static getObjectId(e){return e.objectid}static getId(e){return e.id}static getBodyNodeMaterial(e){let t=e.getMaterialBodyNodeUUid();return t&&e.useBodyNodeMaterial?e.ndsModel.bodyNodeUUidToMaterial[t]:null}static setBodyNodeMaterial(e,t){e.ndsModel.bodyNodeUUidToMaterial[e.uuid]=t,e.useBodyNodeMaterial=!!t}static getUserMaterial(e){return e.getUserMaterial()}static setUserMaterial(e,t){e.setUserMaterial(t)}static getBoundingBox(e){var t=new THREE.Box3;return e.getBoundingBox(t,!0)}static isLeafBodyNode(e){return!!e.leafBodyAttri}static isPartBodyNode(e){return"Part"===e.type}static getLeafBodyNodes(e){return e.ndsModel.getLeafBodies(e)}static getMeshesInLeafBodyNode(e){return e.leafBodyAttri?e.leafBodyAttri.bodyMeshIds:[]}static getMatrixLocal(e){return e.matrix}static getMatrixWorld(e){return e.worldMatrix}static setMatrixWorld(e,t){e.setMatrixWorld(t)}static applyTransform(e,t=null){e.applyTransform(t)}static updateMatrixWorld(e,t=!1){e.updateMatrixWorld(t,!0)}static hide(e){e.hide(e)}static show(e){e.show()}static isPreSelected(e){return e.isPreSelected()}static isSelected(e){return e.isSelected()}static isTransparent(e){return e.isTransparent()}static isHidden(e){return e.isHidden()}static isIsolated(e){return e.isIsolated()}static getRenderMode(e){switch(e.renderMode){case 3:return"wireframe";case 4:return"hiddenLineRemove";case 5:return"hiddenLineVisible"}return""}static getBodyNodeTranslate(e,t){let r=new THREE.Vector3(0,0,0),o=e.getExtensionWithFlags(i.FLAG_ENABLE_NODE_TRANSFORM);for(let e=0,i=o.length;e<i;++e)r.add(o[e].getBodyNodeTranslate(t));return r}static updateNodeMatrix(e,t){e.ndsModel.updateNodeMatrix(e.uuid,t,e.getModel().id)}static hideBody(e){e.ndsModel.hideBody(e)}static showBody(e){e.ndsModel.showBody(e)}}
/**
	 * @file 这是新迪轻量化引擎查看器插件框架代码，请不要修改此文件
	 * @copyright 新迪数字 2024
	 */class n{constructor(e){this.__coreView__=e}addEventListener(e,t){this.__coreView__.addEventListener(e,t)}hasEventListener(e,t){return this.__coreView__.hasEventListener(e,t)}removeEventListener(e,t){this.__coreView__.removeEventListener(e,t)}dispatchEvent(e){this.__coreView__.dispatchEvent(e)}getPixelRatio(){return this.__coreView__.renderer.getPixelRatio()}switchRotateCenterBySelection(){this.__coreView__.switchRotateCenterBySelection()}setDefaultEnvMap(e){e&&(this.__coreView__.hasPbrMaterial=!0,this.__coreView__.setDefaultEnvMap=()=>{this.__coreView__.setEnvMapEnabled(!0),this.__coreView__.defaultEnvMapTexture=e,this.__coreView__.updateEnvMap(this.__coreView__.defaultEnvMapTexture)},this.__coreView__.setDefaultEnvMap())}getBackgroundState(){return this.__coreView__.exchangeBackImage?{type:this.__coreView__.exchangeBackImage.type,value:this.__coreView__.exchangeBackImage.value}:void 0}setBackgroundState(e,t){"Image"===e?(this.__coreView__.setEnvMapTextures(null),this.__coreView__.setBackGroundImage(t)):"EnvMap"===e?this.__coreView__.setEnvMapTextures(t):"Color"===e&&(this.__coreView__.setEnvMapTextures(null),this.__coreView__.setBackGroundImage(null),this.__coreView__.setBackGroundColor(t))}removeAllLights(){this.__coreView__.lights.length=0}getLight(e){return this.__coreView__.lights[e]}setLight(e,t){this.__coreView__.lights[e]=t}getViewBox(){return this.__coreView__.viewBox}toggleAutoRotation(e){this.__coreView__.toggleAutoRotation(e)}randColor(){return this.__coreView__.materialsSetting.randColor()}getBoundingBox(e=!1){let t=this.__coreView__.ndsModel.getTotalBodyBoundingBox(null,e);return t.isEmpty()?this.__coreView__.modelRootObject.boundingBox:t}getModelTree(){return this.__coreView__.getModelTree()}getModelCount(){return this.__coreView__.ndsModel.models.length}setActiveModel(e){this.__coreView__.ndsModel.setActiveModel(e)}setActiveModelByModelId(e){let t=-1;for(let r=0;r<this.__coreView__.ndsModel.models.length;++r)if(this.__coreView__.ndsModel.models[r].id===e){t=r;break}this.setActiveModel(t)}getActiveModel(){return this.__coreView__.ndsModel.getActiveModel()}getModelById(e){return this.__coreView__.ndsModel.getModelById(e)}getModelByIndex(e){return this.__coreView__.ndsModel.models[e]}registOperator(e,t){this.__coreView__.registOperator(e,t)}setOperatorByID(e){this.__coreView__.setOperatorByID(e)}getCurrentOperator(){return this.__coreView__.controls.getOperator()}getCurrentOperatorID(){return this.__coreView__.getCurrentOperatorID()}setOperator(e){this.__coreView__.setOperator(e)}registCursor(e,t,r){this.__coreView__.registCursor(e,t,r)}hideSelectedObjects(){this.__coreView__.hideSelectedObjects()}getViewControlBoundingBox(){return this.__coreView__.controls.getBoundingBox()}setViewControlBoundingBox(e,t){this.__coreView__.controls.setBoundingBox(e,t)}getCamera(){return this.__coreView__.camera}setCameraControlBoundingBoxCenter(e){this.__coreView__.cameraControl.setBoundingBoxCenter(e)}setCameraControlBounding(e,t){this.__coreView__.cameraControl.setBoundingBox(e,t)}getRotateCenter(){return this.__coreView__.cameraControl.getRotateCenter()}setRotateCenter(e){this.__coreView__.cameraControl.setRotateCenter(e)}getViewLockedState(){return this.__coreView__.cameraControl.isViewLockedBySingleBody}setViewLockedState(e){this.__coreView__.cameraControl.isViewLockedBySingleBody=e}getCameraInfo(){return this.__coreView__.cameraControl.getCameraInfo()}adjustNearAndFar(){this.__coreView__.cameraControl.adjustNearAndFar()}updateViewBoxCamDir(){this.__coreView__.cameraControl.updateViewBoxCamDir()}startSmoothTranslation(e){this.__coreView__.cameraControl.startSmoothTranslation(e)}zoomExtents(e,t,r){this.__coreView__.cameraControl.zoomExtents(e,t,r)}setCameraInfo(e,t){this.__coreView__.cameraControl.setCameraInfo(e,t)}getOrginalCameraInfo(){return this.__coreView__.viewManager?this.__coreView__.viewManager.getOrginalCameraInfo():this.__coreView__.camera.getOrginalCameraInfo()}setOrginalCameraInfo(e,t,r){this.__coreView__.camera.setOrginalCameraInfo({center:e,up:t,position:r})}toPerspectiveCamera(){this.__coreView__.toPerspectiveCamera()}toOrthographicCamera(){this.__coreView__.toOrthographicCamera()}updateGroundTransform(e,t,r){return this.__coreView__.groundShadow.updateGroundTransform(e,t,r)}isRendererContainsClipPlanes(){return this.__coreView__.renderer.clippingPlanes.length>0}getCanvas2D(){return this.__coreView__.canvas2D}getCanvas3D(){return this.__coreView__.canvas3D}getContainer(){return this.__coreView__.container}getRenderDomElement(){return this.__coreView__.renderer.domElement}getAdditionalObjectsScene(){return this.__coreView__.additionalObjectsScene}getDispalyModelUnit(e,t){return this.__coreView__.getDispalyModelUnit(e,t)}modelCoordToClientCoord(e){return this.__coreView__.modelCoordToClientCoord(e)}clientCoordToModelCoord(e){return this.__coreView__.clientCoordToModelCoord(e)}showObject(e,t,r,i=!0){this.__coreView__.showObject(e,t,r,i)}showObjectReversed(e){this.__coreView__.showObjectReversed(e)}renderAllViews(){this.__coreView__.renderAllViews()}render(e){this.__coreView__.render(e)}setRenderMode(e,t){this.__coreView__.setRenderMode(e,t)}getRenderMode(){let e;switch(this.__coreView__.getRenderMode()){case 0:e="lighting";break;case 1:e="primarycolor";break;case 2:e="wireframe";break;case 3:e="whitemold";break;case 4:e="shadedWithEdges";break;case 5:e="shaded";break;case 6:e="hiddenLineRemove";break;case 7:e="hiddenLineVisible";break;case 8:e="transparent"}return e}getAssemblyPMIState(){return this.__coreView__.AssemblyPMIState}setAssemblyPMIState(e){this.__coreView__.AssemblyPMIState=e}getPartPMIState(){return this.__coreView__.PartPMIState}setPartPMIState(e){this.__coreView__.PartPMIState=e}getPmiVisible(){return this.__coreView__.pmiVisible}setPmiVisible(e){this.__coreView__.pmiVisible=e}setPMIObjectVisible(e,t){this.__coreView__.setPMIObjectVisible(e,t)}isPMIOccludeByModel(){return!NDSWebViewer.SETTING.StopPMIOcclusion}enablePMIOccludeByModel(e){this.__coreView__.stopPMIOcclusion(!e)}getPmiList(){return this.__coreView__.PMINDSBodys}getPMIObjectByUUID(e){return this.__coreView__.PMIUUIDtoPMIObject[e]}isPMIObjectOrSomeChildHidden(e){return this.__coreView__.isPMIObjectOrSomeChildHidden(e)}getPmiObjectTree(){return this.__coreView__.pmiObject}getSelectedPmiList(){return this.__coreView__.getPMINDSBodySelectList()}selectPMIObject(e){this.__coreView__.selectPMIObject(e)}deselectPMIObject(e){this.__coreView__.deselectPMIObject(e)}unmergeBodyNode(){this.__coreView__.ndsModel.unmergeNode()}mergeBodyNode(){this.__coreView__.ndsModel.mergeNode()}getAllTransparentBodies(e){return this.__coreView__.ndsModel.getAllTransparentBodies(e)}isolateBodiesOnly(e){this.__coreView__.ndsModel.isolateBodiesOnly(e)}unloadModelById(e){this.__coreView__.ndsModel.unloadModelById(e)}startLoadAnimationModel(e){let t=e.url,r=e.id,i={needsPMI:!1,needsAnimation:!1,needsSketchModel:!1,position:e.position,pmiVisible:this.__coreView__.pmiVisible,modelId:e.modelId};this.__coreView__.loadModel(r,t,null,null,"js",null,null,null,i)}getBodyNodeFromUuid(e,t=-1){var r=null;if(t>=0){let i=this.getModelById(t);if(i){let t=i.getBodyNodeFromUuid(e);t&&(r=t)}}else this.__coreView__.ndsModel.models.forEach((t=>{let i=t.getBodyNodeFromUuid(e);i&&(r=i)}));return r}loadBrepInfo(e){this.__coreView__.loadBrepInfo(e)}}class l{constructor(e){this.__selectionManager__=e.selectionManager}getSelectedObjects(){return this.__selectionManager__.getSelectedObjects()}getSelectedMeshes(){return this.__selectionManager__.getSelectedMeshes()}clearSelection(){this.__selectionManager__.clearSelection()}setSelectType(e){this.__selectionManager__.setSelectType(e)}selectByClick(e,t){this.__selectionManager__.selectByClick(e,t)}}var a=function(e,t){NDSWebViewer.OpBase.call(this,e),this.extension=t,this.type="OpColor",t.operator=this,this.ColorType="",this.preSelectBody=null,this.preSelectBodyMat=null,this.viewer=e,this.preSelectObj=null,this.selFaceLineInfors=[],this.selFaceLineObjs=[],this.materialPreSelectMeshopacity=new THREE.MeshPhongMaterial({color:65535,side:THREE.DoubleSide,depthTest:!0,depthWrite:!0,transparent:!1}),this.viewer.loadBrepInfo(!1),!this.viewer.hasBrepInfo()&&this.viewer.hasBrepFile()||this.viewer.dispatchEvent({type:"BrepInfoEvent"})};(a.prototype=Object.create(NDSWebViewer.OpBase.prototype)).setColorType=function(e){this.ColorType=e,"FaceLine"===e?this.viewer.setSelectBodyByRect(!1):this.viewer.setSelectBodyByRect(!0)},a.prototype.getSelectFaceLineInfo=function(){return this.selFaceLineInfors},a.prototype.onNMouseMove=function(e){var t=this.getViewClientCoords(e),r=t.x,i=t.y;let o=this.remapCoordnidateToFullView(r,i);r=o[0],i=o[1],"Body"===this.ColorType?this.changeBodyColorPre(r,i):"FaceLine"===this.ColorType&&this.changeFaceLineColorPre(r,i)},a.prototype.getViewClientCoords=function(e){var t=e.offsetX||e.clientX-this.viewer.container.getBoundingClientRect().left,r=e.offsetY||e.clientY-this.viewer.container.getBoundingClientRect().top;return e.srcElement&&e.srcElement!==this.viewer.renderer.domElement&&(t=e.clientX-this.viewer.container.getBoundingClientRect().left,r=e.clientY-this.viewer.container.getBoundingClientRect().top),null==e.srcElement&&e.target&&e.target!==this.viewer.renderer.domElement&&(t=e.clientX-this.viewer.container.getBoundingClientRect().left,r=e.clientY-this.viewer.container.getBoundingClientRect().top),new THREE.Vector2(t,r)},a.prototype.onLMouseClick=function(e){var t=this.getViewClientCoords(e),r=t.x,i=t.y;let o=this.remapCoordnidateToFullView(r,i);r=o[0],i=o[1],"Body"===this.ColorType?NDSWebViewer.OpBase.prototype.onLMouseClick.call(this,e):"FaceLine"===this.ColorType&&this.changeFaceLineColor(r,i,e.ctrlKey)},a.prototype.changeFaceLineColor=function(e,t,r){var i=this.getIntersectsByPriorityOfLine(e,t);if(i&&0!=i.length){for(var o=0;o<i.length;){var s=this.getSelectInfoFromIntersect(i[o]);if(s){var n=!1,l=-1;for(a=0,d=this.selFaceLineInfors.length;a<d;a++)if(this.isTwoTopolInfoTheSame(this.selFaceLineInfors[a],s)){n=!0,l=a;break}if(null!=r&&1==r)if(n)this.selFaceLineInfors.splice(l,1),this.extension.sceneWraper.getAdditionalObjectsScene().remove(this.selFaceLineObjs[l]),this.selFaceLineObjs[l]=null,this.selFaceLineObjs.splice(l,1),this.viewer.dispatchEvent({type:"selectFaceLineInfo",persist:null,modelId:null});else{this.selFaceLineInfors.push(s);let e=null;null!=s.area&&"face"===s.topolType?e=this.createFace(s,!1):"edge"===s.topolType&&(e=this.createLine(s,!1)),e&&(this.extension.sceneWraper.getAdditionalObjectsScene().add(e),this.selFaceLineObjs.push(e)),this.viewer.dispatchEvent({type:"selectFaceLineInfo",persist:s.persist,modelId:s.object.ndsModel.id})}else{this.selFaceLineInfors.length=0;for(a=0,d=this.selFaceLineObjs.length;a<d;a++)this.extension.sceneWraper.getAdditionalObjectsScene().remove(this.selFaceLineObjs[a]);if(this.selFaceLineObjs.length=0,n)this.viewer.dispatchEvent({type:"selectFaceLineInfo",persist:null,modelId:null});else{this.selFaceLineInfors.push(s);let e=null;null!=s.area&&"face"===s.topolType?e=this.createFace(s,!1):"edge"===s.topolType&&(e=this.createLine(s,!1)),e&&(this.extension.sceneWraper.getAdditionalObjectsScene().add(e),this.selFaceLineObjs.push(e)),this.viewer.dispatchEvent({type:"selectFaceLineInfo",persist:s.persist,modelId:s.object.ndsModel.id})}}return}o++}if(null==r||0==r){this.selFaceLineInfors.length=0;for(a=0,d=this.selFaceLineObjs.length;a<d;a++)this.extension.sceneWraper.getAdditionalObjectsScene().remove(this.selFaceLineObjs[a]);this.selFaceLineObjs.length=0}this.viewer.renderAllViews()}else{if(this.preSelectObj&&(this.extension.sceneWraper.getAdditionalObjectsScene().remove(this.preSelectObj),this.preSelectObj=null,this.preselectInfo=null),null==r||0==r){this.selFaceLineInfors.length=0;for(var a=0,d=this.selFaceLineObjs.length;a<d;a++)this.extension.sceneWraper.getAdditionalObjectsScene().remove(this.selFaceLineObjs[a]);this.selFaceLineObjs.length=0}this.viewer.dispatchEvent({type:"selectFaceLineInfo",persist:null,modelId:null})}},a.prototype.getLinePrecision=function(){var e=this.viewer.clientCoordToModelCoord([0,0]),t=new THREE.Vector3(e[0],e[1],e[2]),r=this.viewer.clientCoordToModelCoord([4,0]),i=new THREE.Vector3(r[0],r[1],r[2]);return t.distanceTo(i)},a.prototype.getIntersectsByPriorityOfLine=function(e,t,r){var i=this.viewer,o=i.renderer.domElement,s=i.renderer.getPixelRatio(),n=new THREE.Raycaster;return i.camera.setCastRay(n,e*s/o.width*2-1,-t*s/o.height*2+1),n.linePrecision=this.getLinePrecision(),r&&(n.linePrecision=r),i.ndsModel.intersect(n.ray,n.linePrecision)},a.prototype.changeBodyColorPre=function(e,t){var r=this.getIntersectsByPriorityOfLine(e,t),i=!1;if(this.preSelectBodyMat&&this.preSelectBody?(this.preSelectBody.setUserMaterial(this.preSelectBodyMat),i=!0,this.preSelectBodyMat=null):this.preSelectBody&&(this.preSelectBody.setUserMaterial(null),i=!0),r&&r.length>0){for(var o=0;o<r.length;){var s=r[o].object;if(null!=s){if(NDSWebViewer.SETTING.HideLeafBody){let e=s.parent.FirstVisibleNode?s.parent.FirstVisibleNode:0;s.parent.children[e].uuid!=s.uuid&&(s=s.parent.children[e])}this.preSelectBody=s;var n=this.preSelectBody.getUserMaterial();this.preSelectBodyMat=n||null,this.preSelectBody.setUserMaterial(this.materialPreSelectMeshopacity);break}o++}this.viewer.renderAllViews()}else this.preSelectBody=null,i&&this.viewer.renderAllViews()},a.prototype.getSelectInfoFromIntersect=function(e){if(!e)return;if(!this.viewer.hasBrepInfo())return;var t,r=e.object;if(!r)return;var i,o,s=r.uuid,n=e.object.uuid;let l=r.ndsModel;if(l&&(e.meshId>=0?(e.mesh=l.meshManager.getSingleMesh(e.meshId),e.mesh&&(i=e.faceIndex-e.mesh.geometry.drawRange.start/3,o="face")):e.lineSegId>=0&&(e.mesh=l.meshManager.getLineSegments(e.lineSegId),e.mesh&&(i=.5*(e.index-e.mesh.geometry.drawRange.start),o="edge")),n=e.geomUuid),i>=0&&(t=l.brepManager.GetBrepInfoByUUidAndTopolIndex(s,n,i,o))){if(t.parentObj=e.mesh,t.geometry=e.mesh.geometry,t.matrixWorld=e.mesh.matrixWorld.clone(),t.intersect=e.point.clone(),t.bodyId=e.bodyId,t.bodyUuid=e.bodyUuid,t.meshId=e.meshId,t.topolIndex=i,t.topolType=o,t.lineSegId=e.lineSegId,t.object=e.bodyNode,"face"==o&&(t.edgeInfos=l.brepManager.GetEdgeInfoFromFace(s,t.edgeIDS)),t.normal&&null==t.worldNormal){var a=new THREE.Vector3,d=new THREE.Quaternion,c=new THREE.Vector3;t.parentObj.matrixWorld.decompose(a,d,c),t.worldNormal=new THREE.Vector3(t.normal[0],t.normal[1],t.normal[2]),t.worldNormal.applyQuaternion(d)}t.origin&&null==t.worldOrigin&&(t.worldOrigin=new THREE.Vector3(t.origin[0],t.origin[1],t.origin[2]),t.worldOrigin.applyMatrix4(t.matrixWorld))}return t},a.prototype.createFace=function(e,t){if(e&&e.parentObj instanceof THREE.Mesh){var r,i=e.geometry,o=e.indexRange.concat();if(o[0]+=i.drawRange.start/3,o[1]+=i.drawRange.start/3,i.isBufferGeometry){for(var s=i.index,n=i.attributes.position,l=o[1]-o[0]+1,a=new Float32Array(9*l),d=0,c=new THREE.Vector3,h=o[0],g=o[1];h<=g;h++,d+=1){var _=3*h,p=s.getX(_),f=s.getX(_+1),u=s.getX(_+2),M=new THREE.Vector3,y=new THREE.Vector3,m=new THREE.Vector3;M.fromBufferAttribute(n,p),y.fromBufferAttribute(n,f),m.fromBufferAttribute(n,u);var I=(new THREE.Vector3).subVectors(y,M),B=(new THREE.Vector3).subVectors(m,M);I.cross(B).normalize(),c.add(I),a[9*d]=M.x,a[9*d+1]=M.y,a[9*d+2]=M.z,a[9*d+3]=y.x,a[9*d+4]=y.y,a[9*d+5]=y.z,a[9*d+6]=m.x,a[9*d+7]=m.y,a[9*d+8]=m.z,M=null,y=null,m=null}var v=new THREE.BufferGeometry;v.addAttribute("position",new THREE.BufferAttribute(a,3)),(r=new THREE.Mesh(v,0==t?NDSWebViewer.SETTING.selectedFaceMaterial:NDSWebViewer.SETTING.preSelectedFaceMaterial)).objectType="Face",r.FaceInfo=[];var b=this.viewer.ndsModel.geomManager.uuidToIdMap[e.geometry.uuid][0];r.FaceInfo.push(this.viewer.ndsModel.bodyUuid2NodeMap[e.bodyUuid].id),r.FaceInfo.push(b),r.FaceInfo.push(e.topolIndex),r.FaceInfo.push(e.meshId);var w=t?1:0;r.FaceInfo.push(w),r.applyMatrix(e.matrixWorld),r.matrixWorldNeedsUpdate=!0,c.normalize(),e.averagenormal=c}return r}},a.prototype.createLine=function(e,t){if(e&&e.parentObj instanceof THREE.Line){var r,i=e.geometry,o=e.indexRange.concat();if(o[0]+=i.drawRange.start/2,o[1]+=i.drawRange.start/2,i.isBufferGeometry){var s=o[1]-o[0]+1,n=i.index,l=i.attributes.position.array,a=new Float32Array(6*s);if(null!=n){for(var d=n.array,c=0,h=o[0],g=o[1],_=0,p=h,f=g;p<=f;p++,c+=1){var u=d[2*p],M=d[2*p+1],y=new THREE.Vector3,m=new THREE.Vector3;y.fromArray(l,3*u),m.fromArray(l,3*M),a[6*c]=y.x,a[6*c+1]=y.y,a[6*c+2]=y.z,a[6*c+3]=m.x,a[6*c+4]=m.y,a[6*c+5]=m.z,_+=y.clone().distanceTo(m),y=null,m=null}var I=0;for(p=h;p<=g;p++){u=d[2*p],M=d[2*p+1],y=new THREE.Vector3,m=new THREE.Vector3;if(y.fromArray(l,3*u),m.fromArray(l,3*M),(I+=y.clone().distanceTo(m))>.5*_){m.clone().sub(y).normalize();break}}let i;i=0==t?NDSWebViewer.SETTING.SelectedEdgeMaterial1:NDSWebViewer.SETTING.preSelectedEdgeMaterial;var B=new THREE.BufferGeometry;B.addAttribute("position",new THREE.BufferAttribute(a,3)),(r=new THREE.LineSegments(B,i)).objectType="SelLine",r.LineInfo=[],r.LineInfo.push(this.viewer.ndsModel.bodyUuid2NodeMap[e.bodyUuid].id);var v=this.viewer.ndsModel.geomManager.uuidToIdMap[e.geometry.uuid][0];r.LineInfo.push(v),r.LineInfo.push(e.topolIndex),r.LineInfo.push(e.lineSegId);var b=t?1:0;r.LineInfo.push(b),r.applyMatrix(e.matrixWorld),r.matrixWorldNeedsUpdate=!0}}return r}},a.prototype.isTwoTopolInfoTheSame=function(e,t){return!(e&&!t||!e&&t||!e&&!t)&&(e.bodyId==t.bodyId&&e.meshId==t.meshId&&e.lineSegId==t.lineSegId&&(e.parentObj==t.parentObj&&e.id==t.id))},a.prototype.changeFaceLineColorPre=function(e,t){var r=this.getIntersectsByPriorityOfLine(e,t);if(r&&r.length>0){var i=this.getSelectInfoFromIntersect(r[0]);i&&(this.isTwoTopolInfoTheSame(this.preselectInfo,i)||(this.preSelectObj&&this.extension.sceneWraper.getAdditionalObjectsScene().remove(this.preSelectObj),this.preselectInfo=i,null!=i.area&&"face"===i.topolType?this.preSelectObj=this.createFace(i,!0):"edge"===i.topolType&&(this.preSelectObj=this.createLine(i,!0)),this.extension.sceneWraper.getAdditionalObjectsScene().add(this.preSelectObj)))}else this.preSelectObj&&this.extension.sceneWraper.getAdditionalObjectsScene().remove(this.preSelectObj);this.viewer.renderAllViews()},a.prototype.release=function(e=!0){this.preSelectObj&&(this.extension.sceneWraper.getAdditionalObjectsScene().remove(this.preSelectObj),this.preSelectObj=null,this.preselectInfo=null),this.selFaceLineInfors.length=0;for(var t=0,r=this.selFaceLineObjs.length;t<r;t++)this.extension.sceneWraper.getAdditionalObjectsScene().remove(this.selFaceLineObjs[t]);this.selFaceLineObjs.length=0,this.preSelectBodyMat&&this.preSelectBody?(this.preSelectBody.setUserMaterial(this.preSelectBodyMat),this.preSelectBodyMat=null):this.preSelectBody&&this.preSelectBody.setUserMaterial(null),this.extension.selectionManager.clearSelection(),e&&NDSWebViewer.OpBase.prototype.release.call(this),this.viewer.setSelectBodyByRect(!0),this.viewer.renderAllViews()};"undefined"!=typeof token&&token;const d=new class extends o{constructor(){super(),this.setFlags(i.FLAG_ENABLE_NODE_STOREVIEW),this.name="ColorChangeExtension",console.log("ColorChangeExtension version 1.0.6"),this.exchangeNodeColor=[],this.oneKeyColor={isActive:!1,color:0},this.modelWraperMap=new Map,this.faceLineMtl=new Map,this.OperatorName="OpColor",this.bodyMtl=new Map}onLoad(e){this.sceneWraper=new n(e),this.selectionManager=new l(e);let t=this;this.sceneWraper.registOperator(this.OperatorName,(function(e){return new a(e,t)})),this.coreView=e}onNdsModelPrepareForRendering(e){const t=new r(e),i=t.ndsModelId;this.modelWraperMap.set(i,t)}resetToDefault(){this.bodyMtl.clear(),this.autoChangeObjectColor(!1,null),this.faceLineMtl.clear()}getStoreInfo(e){let t=this.oneKeyColor;if(null!=t.isActive&&!0===t.isActive?(e.useRandomColor=!0,e.randColor=t.color,this.oneKeyColor.isActive=!0):null!=t.isActive&&!1===t.isActive&&(e.useRandomColor=!1,e.randColor=null,this.oneKeyColor.isActive=null),this.exchangeNodeColor.length>0){let t=this.exchangeNodeColor;e.exchangeNodeColor=[];for(let r=0;r<t.length;++r)e.exchangeNodeColor.push({color:t[r].color,objectUUID:t[r].objectUUID,modelId:t[r].modelId})}var r=function(e){var t={};for(var r in e)Array.isArray(e[r])?t[r]=e[r].concat():t[r]=e[r];return t};if(this.faceLineMtl.size>0){e.faceLineMtl=[],this.faceLineMtl.forEach((t=>{e.faceLineMtl.push(r(t))}));for(let t=0;t<e.faceLineMtl.length;t++){let r=e.faceLineMtl[t];if(void 0===r.color||void 0===r.opacity){let e;"face"===r.type?e=this.getFaceColor([r.persistId],[r.leafBodyNodeUUID],(e=>{}),r.idType,[r.modelId]):"line"===r.type&&(e=this.getLineColor([r.persistId],[r.leafBodyNodeUUID],(e=>{}),r.idType,[r.modelId])),r.color=e.colors[0],r.opacity=e.opacities[0]}}}this.bodyMtl.size>0&&(e.bodyMtl=[],this.bodyMtl.forEach((t=>{e.bodyMtl.push(r(t))})))}setStoreInfo(e){let t=this,i=this.sceneWraper.getActiveModel(),o=new r(i);if(!o.getBrepManager().hasBrepFile()||o.getBrepManager().hasBrepInfo()){if(this.bodyMtl.clear(),this.autoChangeObjectColor(!1,null),null==e.useRandomColor){let e=this.exchangeNodeColor.length;for(let t=0;t<e;++t)this.changeObjectColor(this.exchangeNodeColor[t].objectUUID,null,!1,this.exchangeNodeColor[t].modelId)}if(null!=e.useRandomColor&&!0===e.useRandomColor?this.autoChangeObjectColor(!0,e.randColor):null!=e.useRandomColor&&!1===e.useRandomColor&&(this.autoChangeObjectColor(!1,null),e.useRandomColor=null),e.exchangeNodeColor&&e.exchangeNodeColor.length>0){this.exchangeNodeColor=[];for(var s=0;s<e.exchangeNodeColor.length;s++)this.changeObjectColor(e.exchangeNodeColor[s].objectUUID,e.exchangeNodeColor[s].color,!1,e.exchangeNodeColor[s].modelId)}this.removeAllPrimitiveMaterials();if(e.faceLineMtl&&e.faceLineMtl.length>0){for(s=0;s<e.faceLineMtl.length;s++){let t=e.faceLineMtl[s].persistId,r=e.faceLineMtl[s].color,i=e.faceLineMtl[s].opacity,o=e.faceLineMtl[s].type,n=e.faceLineMtl[s].idType,l=e.faceLineMtl[s].leafBodyNodeUUID,a=e.faceLineMtl[s].modelId,d={hex:r};if("face"===o){let e=this.getBrepInfoWithGivenId(t,"face",n,l,a),r=e.currentBrepInfo.ids[e.index];this.setFaceColorWithFaceId(r,d,i,e,l,a)}else if("line"===o){let e=this.getBrepInfoWithGivenId(t,"edge",n,l,a),r=e.currentBrepInfo.ids[e.index];this.setLineColorWithLineId(r,d,i,e,l,a)}}this.faceLineMtl.clear(),e.faceLineMtl.forEach((e=>{let r=`${e.persistId}-${e.leafBodyNodeUUID}`;t.faceLineMtl.set(r,function(e){var t={};for(var r in e)Array.isArray(e[r])?t[r]=e[r].concat():t[r]=e[r];return t}(e))}))}if(e.bodyMtl&&e.bodyMtl.length>0){let t=[],r=[],i=[],o=[];for(s=0;s<e.bodyMtl.length;s++)if(e.bodyMtl[s].colors&&e.bodyMtl[s].colors.length>0){let i=e.bodyMtl[s].id;t.push(i),o.push(e.bodyMtl[s].modelId),r.push(e.bodyMtl[s].colors)}t.length>0&&this.setObjectColorFromids(t,r,o),t=[],o=[];for(s=0;s<e.bodyMtl.length;s++)if(e.bodyMtl[s].opacities&&e.bodyMtl[s].opacities.length>0){let r=e.bodyMtl[s].id;t.push(r),o.push(e.bodyMtl[s].modelId),i.push(e.bodyMtl[s].opacities)}t.length>0&&this.setObjectOpacityFromids(t,i,!1,o)}}else this.loadBrepInfoForUpdatingPrimitiveColor({id:e},t.setStoreInfo)}findAllIndices(e,t){let r=[];for(let i=0;i<e.length;i++)e[i]===t&&r.push(i);return r}autoChangeObjectColor(e,t){var r=!1;t||(r=!0);let i=this.sceneWraper.getModelCount(),o=this;for(var s=0;s<i;s++){let i=this.sceneWraper.getModelByIndex(s);if(!i.isSketchModel){var n=i.rootBodyNode;e?(r&&(t=this.sceneWraper.randColor()),this.oneKeyColor.isActive=!0,this.oneKeyColor.color=t,i.changeBodyColor(n,t,!0)):(this.exchangeNodeColor=[],this.oneKeyColor.isActive=!1,i.changeBodyColor(n,null,!1))}}if(!e&&this.bodyMtl&&this.bodyMtl.size>0){let e=[],t=[],r=[],i=[];for(const r of this.bodyMtl.values())if(r.colors&&r.colors.length>0){let o=r.id;e.push(o),i.push(r.modelId),t.push(r.colors)}e.length>0&&this.setObjectColorFromids(e,t,i),e=[],i=[];for(const t of this.bodyMtl.values())if(t.colors&&t.colors.length>0){let o=t.id;e.push(o),i.push(t.modelId),r.push(t.opacities)}e.length>0&&this.setObjectOpacityFromids(e,r,!1,i)}var l=setInterval((function(){o.sceneWraper.renderAllViews()}),100);return setTimeout((function(){clearInterval(l)}),1e3),this.sceneWraper.renderAllViews(),t}changeObjectColor(e,t=null,r=!1,i=-1){var o=this.sceneWraper.getBodyNodeFromUuid(e,i);if(o){let i=this.sceneWraper.getModelById(s.getModel(o).id);i||(i=this.sceneWraper.getActiveModel()),i.changeBodyColor(o,t,!1);var n={objectUUID:e,color:t,modelId:i.id};this.exchangeNodeColor.push(n),r||this.sceneWraper.dispatchEvent({type:"colorChange",object:o})}this.sceneWraper.renderAllViews()}setFaceColor(e,t,i,o=[],s=0,n=[]){if(Array.isArray(t)&&t.length){if(1===t.length){let r=t[0];for(let i=0;i<e.length;i++)t[i]=r}}else if("object"==typeof t){let r=t;t=[];for(let i=0;i<e.length;i++)r.r||r.hex?t[i]=r:t[i]=void 0}if(Array.isArray(i)&&i.length){if(1===i.length){let t=i[0];for(let r=0;r<e.length;r++)i[r]=t}}else if(!Array.isArray(i)){let t=i;i=[];for(let r=0;r<e.length;r++)i[r]=t}let l=this,a=this.sceneWraper.getActiveModel(),d=new r(a);if(d.getBrepManager().hasBrepFile()&&(void 0!==t||void 0!==i))if(!d.getBrepManager().hasBrepFile()||d.getBrepManager().hasBrepInfo())for(let r=0;r<e.length;++r){let a=this.getBrepInfoWithGivenId(e[r],"face",s,o[r],n[r]);if(void 0===a.currentBrepInfo||void 0===a.geomUUID||a.index<0)return void(0===s?console.warn("指定persistId的面不存在。"):console.warn("指定Id的面不存在。"));let d=a.currentBrepInfo.ids[a.index];l.setFaceColorWithFaceId(d,t[r],i[r],a,o[r],n[r]);let c=e[r],h=o[r],g=n[r],_=`${c}-${h}`;this.faceLineMtl.has(_)||this.faceLineMtl.set(_,{color:void 0,opacity:void 0,persistId:c,idType:s,leafBodyNodeUUID:h,type:"face",modelId:g});let p=this.faceLineMtl.get(_);if(t[r]&&(t[r].r||t[r].hex)){let e;e=void 0!==t[r].hex?t[r].hex:"0x"+((1<<24)+(t[r].r<<16)+(t[r].g<<8)+t[r].b).toString(16).slice(1),p.color=e}i[r]&&(p.opacity=i[r])}else this.loadBrepInfoForUpdatingPrimitiveColor({id:e,color:t,opacity:i,bodyUUID:o,idType:s,modelIds:n},l.setFaceColor)}getFaceColor(e,t=[],i,o=0,s=[]){let n=this,l=this.sceneWraper.getActiveModel(),a=new r(l);if(!a.getBrepManager().hasBrepFile())return void i(null);if(a.getBrepManager().hasBrepFile()&&!a.getBrepManager().hasBrepInfo()){function h(){n.sceneWraper.removeEventListener("BrepInfoEvent",h),n.getFaceColor(e,t,i,o,s),n.sceneWraper.render()}return n.sceneWraper.loadBrepInfo(!1),void n.sceneWraper.addEventListener("BrepInfoEvent",h)}let d=[],c=[];for(let g=0;g<e.length;++g){let _=null,p=null,f=this.getBrepInfoWithGivenId(e[g],"face",o,t[g],s[g]);if(void 0===f.currentBrepInfo||void 0===f.geomUUID||f.index<0)return console.warn("指定persistId的面不存在。"),void i(null);let u=[0,1],M=-1,y=f.index;u[0]=3*f.currentBrepInfo.triIndexRanges[2*y],u[1]=3*f.currentBrepInfo.triIndexRanges[2*y+1]+2;let m=this.sceneWraper.getModelById(s[g]);m||(m=this.sceneWraper.getActiveModel());let I=m.meshManager.geomUuid;if(t&&0!=t.length&&null!=t[0]){let v=m.getBodyNodeFromUuid(t[g]);if(v&&v._leafBodyAttri&&v._leafBodyAttri._bodyMeshIds){let b=this.findAllIndices(I,f.geomUUID);for(let w=0;w<v._leafBodyAttri._bodyMeshIds.length;w++){const A=v._leafBodyAttri._bodyMeshIds[w];if(-1!==b.indexOf(A)){M=A;break}}}}else M=I.indexOf(f.geomUUID);if(M<0)return console.warn("指定id的面无法关联对应的Mesh。"),void i(null);a=new r(m);let B=a.getMeshState().getMeshMaterial(M);if(B){let E=0,S=B.faceMaterials;for(;E<S.length&&!(S[E].range[0]<=u[0]&&S[E].range[1]>=u[1]);++E);E<S.length?(_=S[E].color.hex,p=S[E].opacity?S[E].opacity:B.material.opacity):(_="0x"+B.material.color.hex.toString(16),p=B.material.opacity),d.push(_),c.push(p)}}return i(d,c),{colors:d,opacities:c}}setFaceColorWithFaceId(e,t,i,o=void 0,s=void 0,n=-1){let l=this,a=this.sceneWraper.getModelById(n);a||(a=this.sceneWraper.getActiveModel());let d=new r(a);if(!d.getBrepManager().hasBrepFile())return;if(void 0===t&&void 0===i)return;if(d.getBrepManager().hasBrepFile()&&!d.getBrepManager().hasBrepInfo())return void this.loadBrepInfoForUpdatingPrimitiveColor({id:e,color:t,opacity:i,bodyUUID:o,idType:s,modelIds:n},l.setFaceColorWithFaceId);let c=void 0===o?this.getBrepInfoWithGivenId(e,"face",1,s,n):o,h=c.index,g=c.currentBrepInfo,_=c.geomUUID;if(void 0===g||void 0===_||h<0)return void console.warn("指定id的面不存在。"+e);let p=this.sceneWraper.getModelById(n);p||(p=this.sceneWraper.getActiveModel());let f=[0,1],u=-1;f[0]=3*g.triIndexRanges[2*h],f[1]=3*g.triIndexRanges[2*h+1]+2;let M=p.meshManager.geomUuid;if(s){let e=p.getBodyNodeFromUuid(s);if(e&&e._leafBodyAttri&&e._leafBodyAttri._bodyMeshIds){let t=this.findAllIndices(M,_);for(let r=0;r<e._leafBodyAttri._bodyMeshIds.length;r++){const i=e._leafBodyAttri._bodyMeshIds[r];if(-1!==t.indexOf(i)){u=i;break}}}}else u=M.indexOf(_);if(u<0)console.warn("指定id的面无法关联对应的Mesh。");else{if(void 0!==t){let e;e=void 0!==t.hex?t.hex:"0x"+((1<<24)+(t.r<<16)+(t.g<<8)+t.b).toString(16).slice(1),p.setFaceColor(u,f,{hex:e})}if(void 0!==i){p.setFaceOpacity(u,f,i);let e=d.getMeshState().getMeshMaterial(u);e.material.side!=THREE.DoubleSide&&(e.material.side=THREE.DoubleSide,e.material.needsUpdate=!0,e.material.needsRefresh=!0,e.material.defaultFrontSide=!0)}l.sceneWraper.render()}}setLineColor(e,t,i=1,o=[],s=0,n=[]){if(Array.isArray(t)&&t.length){if(1===t.length){let r=t[0];for(let i=0;i<e.length;i++)t[i]=r}}else if("object"==typeof t){let r=t;t=[];for(let i=0;i<e.length;i++)r.r||r.hex?t[i]=r:t[i]=void 0}if(Array.isArray(i)&&i.length){if(1===i.length){let t=i[0];for(let r=0;r<e.length;r++)i[r]=t}}else if(!Array.isArray(i)){let t=i;i=[];for(let r=0;r<e.length;r++)i[r]=t}let l=this,a=this.sceneWraper.getActiveModel(),d=new r(a);if(d.getBrepManager().hasBrepFile()&&(void 0!==t||void 0!==i))if(!d.getBrepManager().hasBrepFile()||d.getBrepManager().hasBrepInfo())for(let r=0;r<e.length;++r){let a=this.getBrepInfoWithGivenId(e[r],"edge",s,o[r],n[r]);if(void 0===a.currentBrepInfo||void 0===a.geomUUID||a.index<0)return void console.warn("指定persistId的线不存在。");let d=a.currentBrepInfo.ids[a.index];l.setLineColorWithLineId(d,t[r],i[r],a,o[r],n[r]);let c=e[r],h=o[r],g=n[r],_=`${c}-${h}`;this.faceLineMtl.has(_)||this.faceLineMtl.set(_,{color:void 0,opacity:void 0,persistId:c,idType:s,leafBodyNodeUUID:h,type:"line",modelId:g});let p=this.faceLineMtl.get(_);if(t[r]&&(t[r].r||t[r].hex)){let e;e=void 0!==t[r].hex?t[r].hex:"0x"+((1<<24)+(t[r].r<<16)+(t[r].g<<8)+t[r].b).toString(16).slice(1),p.color=e}i[r]&&(p.opacity=i[r])}else this.loadBrepInfoForUpdatingPrimitiveColor({id:e,color:t,opacity:i,bodyUUID:o,idType:s,modelIds:n},l.setLineColor)}getLineColor(e,t=[],i,o=0,s=[]){let n=this,l=this.sceneWraper.getActiveModel(),a=new r(l);if(!a.getBrepManager().hasBrepFile())return void i(null);if(a.getBrepManager().hasBrepFile()&&!a.getBrepManager().hasBrepInfo()){function h(){n.sceneWraper.removeEventListener("BrepInfoEvent",h),n.getLineColor(e,t,i,o,s),n.sceneWraper.render()}return n.sceneWraper.loadBrepInfo(!1),void n.sceneWraper.addEventListener("BrepInfoEvent",h)}let d=[],c=[];for(let g=0;g<e.length;++g){let _=null,p=null,f=this.getBrepInfoWithGivenId(e[g],"edge",o,t[g],s[g]);if(void 0===f.currentBrepInfo||void 0===f.geomUUID||f.index<0)return console.warn("指定persistId的线不存在。"),void i(null);let u=this.sceneWraper.getModelById(s[g]);u||(u=this.sceneWraper.getActiveModel());let M=f.index,y=f.currentBrepInfo,m=f.geomUUID;if(void 0===y||void 0===m||M<0)return void console.warn("指定id的线不存在。");let I=[0,1],B=-1;I[0]=2*y.indexRanges[2*M],I[1]=2*y.indexRanges[2*M+1]+1;let v=u.meshManager.lineSegGeomUuid;if(t&&0!==t.length&&null!=t[0]){let w=u.getBodyNodeFromUuid(t[g]);if(w&&w._leafBodyAttri&&w._leafBodyAttri._bodyLineSegIds){let A=this.findAllIndices(v,m);for(let E=0;E<w._leafBodyAttri._bodyLineSegIds.length;E++){const S=w._leafBodyAttri._bodyLineSegIds[E];if(-1!==A.indexOf(S)){B=S;break}}}}else B=v.indexOf(m);a=new r(u);let b=a.getMeshState().getLineMaterial(B);if(b){let C=0,L=b.lineSegMaterials;for(;C<L.length&&!(L[C].range[0]<=I[0]&&L[C].range[1]>=I[1]);++C);C<L.length?(_=L[C].color.hex,p=L[C].opacity):(_="0x"+b.color.toString(16),p=b.opacity),d.push(_),c.push(p)}}return i(d,c),{colors:d,opacities:c}}setLineColorWithLineId(e,t,i=1,o=void 0,s=void 0,n=-1){let l=this,a=this.sceneWraper.getModelById(n);a||(a=this.sceneWraper.getActiveModel());let d=new r(a);if(!d.getBrepManager().hasBrepFile())return;if(void 0===t&&void 0===i)return;if(d.getBrepManager().hasBrepFile()&&!d.getBrepManager().hasBrepInfo())return void this.loadBrepInfoForUpdatingPrimitiveColor({id:e,color:t,opacity:i,bodyUUID:o,idType:s,modelIds:n},l.setLineColorWithLineId);let c=void 0===o?this.getBrepInfoWithGivenId(e,"edge",1,s,n):o,h=c.index,g=c.currentBrepInfo,_=c.geomUUID;if(void 0===g||void 0===_||h<0)return void console.warn("指定id的线不存在。");let p=this.sceneWraper.getModelById(n);p||(p=this.sceneWraper.getActiveModel());let f=[0,1],u=-1;f[0]=2*g.indexRanges[2*h],f[1]=2*g.indexRanges[2*h+1]+1;let M=p.meshManager.lineSegGeomUuid;if(s){let e=p.getBodyNodeFromUuid(s);if(e&&e._leafBodyAttri&&e._leafBodyAttri._bodyLineSegIds){let t=this.findAllIndices(M,_);for(let r=0;r<e._leafBodyAttri._bodyLineSegIds.length;r++){const i=e._leafBodyAttri._bodyLineSegIds[r];if(-1!==t.indexOf(i)){u=i;break}}}}else u=M.indexOf(_);if(u<0)console.warn("指定id的线无法关联对应的lineSegment。");else{if(void 0!==t){let e;e=void 0!==t.hex?t.hex:"0x"+((1<<24)+(t.r<<16)+(t.g<<8)+t.b).toString(16).slice(1),p.setLineColor(u,f,{hex:e})}void 0!==i&&p.setLineOpacity(u,f,i),this.sceneWraper.renderAllViews()}}removeFaceMaterial(e,t=!0,i=!0,o=[],s=0,n=[]){let l=this.sceneWraper.getActiveModel(),a=new r(l);if(a.getBrepManager().hasBrepFile()&&a.getBrepManager().hasBrepInfo())for(let r=0;r<e.length;++r){let l=this.getBrepInfoWithGivenId(e[r],"face",s,o[r],n[r]);if(void 0===l.currentBrepInfo||void 0===l.geomUUID||l.index<0)return void(0===s?console.warn("指定persistId的面不存在。"):console.warn("指定Id的面不存在。"));let a=l.currentBrepInfo.ids[l.index];this.removeFaceMaterialWithFaceId(a,t,i,l,o[r],n[r])}}removeFaceMaterialWithFaceId(e,t=!0,i=!0,o=void 0,s=void 0,n=-1){let l=this.sceneWraper.getModelById(n);l||(l=this.sceneWraper.getActiveModel());let a=new r(l);if(!a.getBrepManager().hasBrepFile()||!a.getBrepManager().hasBrepInfo())return;let d=void 0===o?this.getBrepInfoWithGivenId(e,"face",1,s):o,c=d.index,h=d.currentBrepInfo,g=d.geomUUID;if(void 0===h||void 0===g||c<0)return void console.warn("指定id的面不存在。");let _=this.sceneWraper.getModelById(n);_||(_=this.sceneWraper.getActiveModel());let p=[0,1],f=-1;p[0]=3*h.triIndexRanges[2*c],p[1]=3*h.triIndexRanges[2*c+1]+2;let u=_.meshManager.geomUuid;if(s){let e=_.getBodyNodeFromUuid(s);if(e&&e._leafBodyAttri&&e._leafBodyAttri._bodyMeshIds){let t=this.findAllIndices(u,g);for(let r=0;r<e._leafBodyAttri._bodyMeshIds.length;r++){const i=e._leafBodyAttri._bodyMeshIds[r];if(-1!==t.indexOf(i)){f=i;break}}}}else f=u.indexOf(g);let M=`${e}-${s}`;if(this.faceLineMtl.has(M)&&this.faceLineMtl.delete(M),f<0)return void console.warn("指定id的面无法关联对应的Mesh。");_.removeFaceMaterial(f,p,t,i);let y=a.getMeshState().getMeshMaterial(f);y.material.side==THREE.DoubleSide&&y.material.defaultFrontSide&&(y.material.side=THREE.FrontSide,y.material.needsUpdate=!0,y.material.needsRefresh=!0),this.sceneWraper.render()}removeLineMaterial(e,t=!0,i=!0,o=[],s=0,n=[]){let l=this.sceneWraper.getActiveModel(),a=new r(l);if(a.getBrepManager().hasBrepFile()&&a.getBrepManager().hasBrepInfo())for(let r=0;r<e.length;++r){let l=this.getBrepInfoWithGivenId(e[r],"edge",s,o[r],n[r]);if(void 0===l.currentBrepInfo||void 0===l.geomUUID||l.index<0)return void(0===s?console.warn("指定persistId的面不存在。"):console.warn("指定Id的面不存在。"));let a=l.currentBrepInfo.ids[l.index];this.removeLineMaterialWithLineId(a,t,i,l,o[r],n[r])}}removeLineMaterialWithLineId(e,t=!0,i=!0,o=void 0,s=void 0,n=-1){let l=this.sceneWraper.getModelById(n);l||(l=this.sceneWraper.getActiveModel());let a=new r(l);if(!a.getBrepManager().hasBrepFile()||!a.getBrepManager().hasBrepInfo())return;let d=void 0===o?this.getBrepInfoWithGivenId(e,"edge",1,s,n):o,c=d.index,h=d.currentBrepInfo,g=d.geomUUID;if(void 0===h||void 0===g||c<0)return void console.warn("指定id的面不存在。");let _=this.sceneWraper.getModelById(n);_||(_=this.sceneWraper.getActiveModel());let p=[0,1],f=-1;p[0]=2*h.indexRanges[2*c],p[1]=2*h.indexRanges[2*c+1]+1;let u=_.meshManager.lineSegGeomUuid;if(s){let e=_.getBodyNodeFromUuid(s);if(e&&e._leafBodyAttri&&e._leafBodyAttri._bodyLineSegIds){let t=this.findAllIndices(u,g);for(let r=0;r<e._leafBodyAttri._bodyLineSegIds.length;r++){const i=e._leafBodyAttri._bodyLineSegIds[r];if(-1!==t.indexOf(i)){f=i;break}}}}else f=u.indexOf(g);let M=`${e}-${s}`;this.faceLineMtl.has(M)&&this.faceLineMtl.delete(M),f<0?console.warn("指定id的线无法关联对应的lineSegment。"):(_.removeLineMarterial(f,p,t,i),this.sceneWraper.render())}removeAllPrimitiveMaterials(){for(let e=0;e<this.sceneWraper.getModelCount();e++){let t=this.sceneWraper.getModelByIndex(e);t.isSketchModel||(t.removeAllLineMaterials(),t.removeAllFaceMaterials())}this.faceLineMtl.clear()}loadBrepInfoForUpdatingPrimitiveColor(e,t){let i=this.sceneWraper.getActiveModel(),o=this,s=new r(i);function n(){o.sceneWraper.removeEventListener("BrepInfoEvent",n),t.call(o,e.id,e.color,e.opacity,e.bodyUUID,e.idType,e.modelIds),o.sceneWraper.render()}s.getBrepManager().hasBrepFile()&&!s.getBrepManager().hasBrepInfo()&&(o.sceneWraper.loadBrepInfo(!1),o.sceneWraper.addEventListener("BrepInfoEvent",n))}removeBodyNodeMaterial(e,t){let r=this.sceneWraper.getModelById(t);r||(r=this.sceneWraper.getActiveModel());let i=this.sceneWraper.getBodyNodeFromUuid(e,t);for(var o=s.getLeafBodyNodes(i),n=o.length,l=0;l<n;++l){if(!o[l].leafBodyAttri)continue;r.changeBodyColor(o[l],null,!1);let e=`${o[l].ndsModel.id}&${o[l].objectid}`;this.bodyMtl.has(e)&&this.bodyMtl.delete(e)}}getBrepInfoWithGivenId(e,t,i=1,o=void 0,s=-1){let n,l,a,d=-1,c=t=>{Object.entries(t).forEach((([t,r])=>{if(!n)if("geomUUID"!==t){if("loopPerimeters"!==t&&"loopStartEdgeId"!==t)if(0===i){if(!(r.persist&&r.persist.length>0))return void console.warn("Brep信息中不包含persistId信息。请确保persistId正确。");for(let t=0;t<r.persist.length;t++)if(r.persist[t]==e){d=t,n=r;break}}else if(1===i&&r.ids&&r.ids.length>0)for(let t=0;t<r.ids.length;t++)if(r.ids[t]==e){d=t,n=r;break}}else l=r}))};this.sceneWraper.setActiveModel(0);let h=this.sceneWraper.getModelById(s);h||(h=this.sceneWraper.getActiveModel());let g=new r(h).getBrepManager().getBrepInfos();if("face"===t?a=g.faceGroups:"edge"===t&&(a=g.edgeGroups),void 0!==o&&g.bodies.has(o)){let e,r=g.bodies.get(o),i=g.breps[r];"face"===t?e=i.faceGroups:"edge"===t&&(e=i.edgeGroups);for(let t=0;t<e.length;++t){c(a[e[t]])}}else for(let e=0;e<a.length;e++){c(a[e])}return{index:d,currentBrepInfo:n,geomUUID:l}}getObjectOpaticFromids(e,t=[]){let i=[];for(var o=0,n=e.length;o<n;++o){let n=this.sceneWraper.getModelById(t[o]);n||(n=this.sceneWraper.getActiveModel());let h=n.objectidTouuid[e[o]],g=new r(n),_=n.getBodyNodeFromUuid(h);for(var l=s.getLeafBodyNodes(_),a=l.length,d=0;d<a;++d){if(!l[d].leafBodyAttri)continue;var c=l[d].leafBodyAttri.bodyMeshIds;let e=[];c.forEach((t=>{let r=g.getMeshState().getMeshMaterial(t);e.push(r.material.opacity)}));let t={objectid:NDSWebViewer.SETTING.HideLeafBody?l[d].parent.objectid:l[d].objectid,opacities:e,modelId:n.id};i.push(t)}}return i}getObjectColorFromids(e,t=[]){let i=[];for(var o=0,n=e.length;o<n;++o){let n=this.sceneWraper.getModelById(t[o]);n||(n=this.sceneWraper.getActiveModel());let h=n.objectidTouuid[e[o]],g=new r(n),_=n.getBodyNodeFromUuid(h);for(var l=s.getLeafBodyNodes(_),a=l.length,d=0;d<a;++d){if(!l[d].leafBodyAttri)continue;var c=l[d].leafBodyAttri.bodyMeshIds;let e=[];c.forEach((t=>{let r=g.getMeshState().getMeshMaterial(t);e.push("0x"+r.material.color.hex.toString(16))}));let t={objectid:NDSWebViewer.SETTING.HideLeafBody?l[d].parent.objectid:l[d].objectid,colors:e,modelId:n.id};i.push(t)}}return i}meshArraytoValueArray(e){let t=[];return e&&e.forEach((e=>{e.value.hex?t.push(e.value.hex):t.push(e.value)})),t}getObjectColor(e,t){let r=this.sceneWraper.getBodyNodeFromUuid(e,t);if(r&&r.getUserMaterial()){var i=r.getUserMaterial().color.getHex();if(i)return i}return null}setObjectColorFromids(e,t,r=[]){if(!t){t=[];for(let d=0;d<e.length;d++){let c=this.sceneWraper.getModelById(r[d]);if(c||(c=this.sceneWraper.getActiveModel()),c.objectidTouuid){let r=[],h=c.objectidTouuid[e[d]],g=c.getBodyNodeFromUuid(h);for(var i=(a=s.getLeafBodyNodes(g)).length,o=0;o<i;++o){if(!a[o].leafBodyAttri)continue;var n=a[o].leafBodyAttri.bodyMeshIds,l=c.meshManager.materialId[n[0]];c.meshManager.mats[l]&&(n.forEach((e=>{const t=c.meshManager.materialId[e],i=c.meshManager.mats[t];if(i){const e=i.color.clone();r.push("0x"+e.getHexString())}})),t.push(r))}}}}if(Array.isArray(e)&&e.length){for(let c=0;c<e.length;c++){let h=this.sceneWraper.getModelById(r[c]);if(h||(h=this.sceneWraper.getActiveModel()),h.objectidTouuid){let r=h.objectidTouuid[e[c]],g=t[c];Array.isArray(g)&&1==g.length&&(g=g[0]),null!=g.r&&(g=g.r<<16^g.g<<8^g.b),"string"==typeof g&&(g=Math.floor(g));let _=h.getBodyNodeFromUuid(r);var a;for(i=(a=s.getLeafBodyNodes(_)).length,o=0;o<i;++o)if(a[o].leafBodyAttri){var d=a[o].getUserMaterial();if(d){if(Array.isArray(g))if(g[0]&&null!=g[0].meshId)d.colors=g;else{n=a[o].leafBodyAttri.bodyMeshIds;let e=[];n.forEach(((t,r)=>{let i=g[r];null!=i.r&&(i=i.r<<16^i.g<<8^i.b),"string"==typeof i&&(i=Math.floor(i)),e.push({meshId:t,value:new THREE.Color(i)})})),d.colors=e,d.backMaterial&&(d.backMaterial.colors=Array.from(d.colors),d.backoriMaterial.colors=Array.from(d.colors))}else{n=a[o].leafBodyAttri.bodyMeshIds;let e=[];n.forEach((t=>{e.push({meshId:t,value:new THREE.Color(g)})})),d.colors=e,d.backMaterial&&(d.backMaterial.colors=Array.from(d.colors),d.backoriMaterial.colors=Array.from(d.colors))}a[o].setUserMaterial(d);let e=`${a[o].ndsModel.id}&${a[o].objectid}`;if(this.bodyMtl.has(e)){this.bodyMtl.get(e).colors=this.meshArraytoValueArray(d.colors)}else this.bodyMtl.set(e,{colors:this.meshArraytoValueArray(d.colors),id:a[o].objectid,modelId:a[o].ndsModel.id})}else{n=a[o].leafBodyAttri.bodyMeshIds,l=h.meshManager.materialId[n[0]];let e=h.meshManager.mats[l];if(!e)continue;let t=[],r=[];n.forEach((e=>{const i=h.meshManager.materialId[e],o=h.meshManager.mats[i];if(o){const r=o.opacity;t.push({meshId:e,value:r})}r.push({meshId:e,value:new THREE.Color(g)})}));let i=e;if(i=e.clone(),Array.isArray(g))if(g[0]&&null!=g[0].meshId)i.colors=g;else{n=a[o].leafBodyAttri.bodyMeshIds;let e=[];n.forEach(((t,r)=>{let i=g[r];null!=i.r&&(i=i.r<<16^i.g<<8^i.b),"string"==typeof i&&(i=Math.floor(i)),e.push({meshId:t,value:new THREE.Color(i)})})),i.colors=e}else{n=a[o].leafBodyAttri.bodyMeshIds;let e=[];n.forEach((t=>{e.push({meshId:t,value:new THREE.Color(g)})})),i.colors=e}i.opacities=t,a[o].setUserMaterial(i);let s=`${a[o].ndsModel.id}&${a[o].objectid}`;if(this.bodyMtl.has(s)){this.bodyMtl.get(s).colors=this.meshArraytoValueArray(i.colors)}else this.bodyMtl.set(s,{colors:this.meshArraytoValueArray(i.colors),id:a[o].objectid,modelId:a[o].ndsModel.id})}}}}this.sceneWraper.renderAllViews()}}setObjectOpacityFromids(e,t,r=!1,i=[]){t||(t=[],e.forEach((e=>{t.push(.5)})));let o=this;if(Array.isArray(e)&&e.length){let _=[];for(let r=0;r<e.length;r++){let o=this.sceneWraper.getModelById(i[r]);if(o||(o=this.sceneWraper.getActiveModel()),o.objectidTouuid){let i=o.objectidTouuid[e[r]],p=o.getBodyNodeFromUuid(i);var n=s.getLeafBodyNodes(p);_.push(p);var l=n.length,a=t[r];Array.isArray(a)&&1==a.length&&(a=a[0]);let f=new Map;for(var d=0;d<l;++d)if(n[d].leafBodyAttri){var c=n[d].getUserMaterial();if(c){if(Array.isArray(a))if(a[0]&&null!=a[0].meshId)c.opacities=a;else{var h=n[d].leafBodyAttri.bodyMeshIds;let e=[];h.forEach(((t,r)=>{e.push({meshId:t,value:a[r]})})),c.opacities=e}else{h=n[d].leafBodyAttri.bodyMeshIds;let e=[];h.forEach((t=>{e.push({meshId:t,value:a})})),c.opacities=e}n[d].setUserMaterial(c);let e=`${n[d].ndsModel.id}&${n[d].objectid}`;if(this.bodyMtl.has(e)){this.bodyMtl.get(e).opacities=this.meshArraytoValueArray(c.opacities)}else this.bodyMtl.set(e,{opacities:this.meshArraytoValueArray(c.opacities),id:n[d].objectid,modelId:n[d].ndsModel.id})}else{h=n[d].leafBodyAttri.bodyMeshIds;var g=o.meshManager.materialId[h[0]];let e=o.meshManager.mats[g],t=[],r=[];if(h.forEach((e=>{const i=o.meshManager.materialId[e],s=o.meshManager.mats[i];if(s){const r=s.color.clone();t.push({meshId:e,value:r})}Array.isArray(a)||r.push({meshId:e,value:a})})),!e)continue;if(f.has(e.uuid))n[d].setUserMaterial(f.get(e.uuid));else{let i=e;if(i=e.clone(),Array.isArray(a))if(a[0]&&null!=a[0].meshId)i.opacities=a;else{h=n[d].leafBodyAttri.bodyMeshIds;let e=[];h.forEach(((t,r)=>{e.push({meshId:t,value:a[r]})})),i.opacities=e}else i.opacities=r;f.set(e.uuid,i),i.colors=t,n[d].setUserMaterial(i);let o=`${n[d].ndsModel.id}&${n[d].objectid}`;if(this.bodyMtl.has(o)){this.bodyMtl.get(o).opacities=this.meshArraytoValueArray(i.opacities)}else this.bodyMtl.set(o,{opacities:this.meshArraytoValueArray(i.opacities),id:n[d].objectid,modelId:n[d].ndsModel.id})}}}f.clear()}}let p=[];_.map((e=>{const t=s.getLeafBodyNodes(e);p.push(...t)})),r||this.sceneWraper.dispatchEvent({type:"opacityChange",objects:p}),this.sceneWraper.renderAllViews(),setTimeout((()=>{o.sceneWraper.renderAllViews()}),10)}for(let e=0;e<this.sceneWraper.getModelCount();e++){const t=this.sceneWraper.getModelByIndex(e);t.transparentBodyChanged=!0,t.getAllTransparentBodies()}}getSelectFaceLineInfo(){return this.operator.getSelectFaceLineInfo()}setColorType(e){this.operator.setColorType(e)}clearOpColor(){this.operator.release(!1)}clear(){this.coreView.ndsModel&&(this.bodyMtl.clear(),this.autoChangeObjectColor(!1,null),this.faceLineMtl.clear())}removeAllBodyNodeMaterials(){this.bodyMtl.clear(),this.autoChangeObjectColor(!1,null)}setAssemblyFacedShow(e){let t=this.sceneWraper.getModelCount();for(var r=0;r<t;r++){let t=this.sceneWraper.getModelByIndex(r);if(!t.isSketchModel){var i=[t.rootBodyNode];for(let t=0;t<i.length;++t){let r=i[t];!1===e&&!0===r.useBodyNodeMaterial?r.useBodyNodeMaterial=0:!0===e&&0===r.useBodyNodeMaterial&&(r.useBodyNodeMaterial=!0);for(let e=0,t=r.children.length;e<t;++e)i.push(r.children[e])}t.meshMtlNeedsUpdate=!0}}this.sceneWraper.renderAllViews()}hasAssemblyFacedshow(){let e=this.sceneWraper.getModelCount();for(var t=0;t<e;t++){let e=this.sceneWraper.getModelByIndex(t);if(!e.isSketchModel){var r=[e.rootBodyNode];for(let e=0;e<r.length;++e){let t=r[e];if(!0===t.useBodyNodeMaterial||0===t.useBodyNodeMaterial)return!0;for(let e=0,i=t.children.length;e<i;++e)r.push(t.children[e])}}}return!1}};NDSWebViewer.ExtensionManager.addExtension(d)}();
