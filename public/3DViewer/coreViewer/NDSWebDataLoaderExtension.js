!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.NDSWebDataLoaderExtension=t():e.NDSWebDataLoaderExtension=t()}(window,function(){return r=[function(e,t,r){var o;r.d(t,"a",function(){return o}),(r=o=o||{})[r.Trace=0]="Trace",r[r.Debug=1]="Debug",r[r.Information=2]="Information",r[r.Warning=3]="Warning",r[r.Error=4]="Error",r[r.Critical=5]="Critical",r[r.None=6]="None"},function(e,m,_){!function(t,e){_.d(m,"a",function(){return s}),_.d(m,"c",function(){return n}),_.d(m,"f",function(){return h}),_.d(m,"j",function(){return d}),_.d(m,"k",function(){return i}),_.d(m,"e",function(){return a}),_.d(m,"d",function(){return c}),_.d(m,"b",function(){return u}),_.d(m,"i",function(){return p}),_.d(m,"g",function(){return g}),_.d(m,"h",function(){return f});var l=_(0),r=_(2);let o="8.0.7";class s{static isRequired(e,t){if(null==e)throw new Error(`The '${t}' argument is required.`)}static isNotEmpty(e,t){if(!e||e.match(/^\s*$/))throw new Error(`The '${t}' argument should not be empty.`)}static isIn(e,t,r){if(!(e in t))throw new Error(`Unknown ${r} value: ${e}.`)}}class n{static get isBrowser(){return!n.isNode&&"object"==typeof window&&"object"==typeof window.document}static get isWebWorker(){return!n.isNode&&"object"==typeof self&&"importScripts"in self}static get isReactNative(){return!n.isNode&&"object"==typeof window&&void 0===window.document}static get isNode(){return void 0!==t&&t.release&&"node"===t.release.name}}function h(e,t){let r="";return d(e)?(r="Binary data of length "+e.byteLength,t&&(r+=`. Content: '${function(e){let t=new Uint8Array(e),r="";return t.forEach(e=>{var t=e<16?"0":"";r+=`0x${t}${e.toString(16)} `}),r.substr(0,r.length-1)}(e)}'`)):"string"==typeof e&&(r="String data of length "+e.length,t)&&(r+=`. Content: '${e}'`),r}function d(e){return e&&"undefined"!=typeof ArrayBuffer&&(e instanceof ArrayBuffer||e.constructor&&"ArrayBuffer"===e.constructor.name)}async function i(e,t,r,o,s,n){var i={},[a,c]=p(),a=(i[a]=c,e.log(l.a.Trace,`(${t} transport) sending data. ${h(s,n.logMessageContent)}.`),d(s)?"arraybuffer":"text"),c=await r.post(o,{content:s,headers:{...i,...n.headers},responseType:a,timeout:n.timeout,withCredentials:n.withCredentials});e.log(l.a.Trace,`(${t} transport) request complete. Response status: ${c.statusCode}.`)}function a(e){return void 0===e?new u(l.a.Information):null===e?r.a.instance:void 0!==e.log?e:new u(e)}class c{constructor(e,t){this._subject=e,this._observer=t}dispose(){var e=this._subject.observers.indexOf(this._observer);-1<e&&this._subject.observers.splice(e,1),0===this._subject.observers.length&&this._subject.cancelCallback&&this._subject.cancelCallback().catch(e=>{})}}class u{constructor(e){this._minLevel=e,this.out=console}log(e,t){if(e>=this._minLevel){var r=`[${(new Date).toISOString()}] ${l.a[e]}: `+t;switch(e){case l.a.Critical:case l.a.Error:this.out.error(r);break;case l.a.Warning:this.out.warn(r);break;case l.a.Information:this.out.info(r);break;default:this.out.log(r)}}}}function p(){let e="X-SignalR-User-Agent";return[e=n.isNode?"User-Agent":e,function(e,t,r,o){let s="Microsoft SignalR/",n=e.split(".");s=(s+=n[0]+"."+n[1])+` (${e}; `,s+=t&&""!==t?t+"; ":"Unknown OS; ";s+=""+r,s+=o?"; "+o:"; Unknown Runtime Version";return s+=")"}(o,function(){{if(!n.isNode)return"";switch(t.platform){case"win32":return"Windows NT";case"darwin":return"macOS";case"linux":return"Linux";default:return t.platform}}}(),n.isNode?"NodeJS":"Browser",function(){if(n.isNode)return t.versions.node;return}())]}function g(e){return e.stack||e.message||""+e}function f(){if("undefined"!=typeof globalThis)return globalThis;if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if(void 0!==e)return e;throw new Error("could not find global")}}.call(this,_(3),_(4))},function(e,t,r){r.d(t,"a",function(){return o});class o{constructor(){}log(e,t){}}o.instance=new o},function(e,t){var r,o,e=e.exports={};function s(){throw new Error("setTimeout has not been defined")}function n(){throw new Error("clearTimeout has not been defined")}try{r="function"==typeof setTimeout?setTimeout:s}catch(e){r=s}try{o="function"==typeof clearTimeout?clearTimeout:n}catch(e){o=n}function i(t){if(r===setTimeout)return setTimeout(t,0);if((r===s||!r)&&setTimeout)return(r=setTimeout)(t,0);try{return r(t,0)}catch(e){try{return r.call(null,t,0)}catch(e){return r.call(this,t,0)}}}var a,c=[],l=!1,h=-1;function d(){l&&a&&(l=!1,a.length?c=a.concat(c):h=-1,c.length)&&u()}function u(){if(!l){for(var e=i(d),t=(l=!0,c.length);t;){for(a=c,c=[];++h<t;)a&&a[h].run();h=-1,t=c.length}a=null,l=!1,!function(t){if(o===clearTimeout)return clearTimeout(t);if((o===n||!o)&&clearTimeout)return(o=clearTimeout)(t);try{o(t)}catch(e){try{return o.call(null,t)}catch(e){return o.call(this,t)}}}(e)}}function p(e,t){this.fun=e,this.array=t}function g(){}e.nextTick=function(e){var t=new Array(arguments.length-1);if(1<arguments.length)for(var r=1;r<arguments.length;r++)t[r-1]=arguments[r];c.push(new p(e,t)),1!==c.length||l||i(u)},p.prototype.run=function(){this.fun.apply(null,this.array)},e.title="browser",e.browser=!0,e.env={},e.argv=[],e.version="",e.versions={},e.on=g,e.addListener=g,e.once=g,e.off=g,e.removeListener=g,e.removeAllListeners=g,e.emit=g,e.prependListener=g,e.prependOnceListener=g,e.listeners=function(e){return[]},e.binding=function(e){throw new Error("process.binding is not supported")},e.cwd=function(){return"/"},e.chdir=function(e){throw new Error("process.chdir is not supported")},e.umask=function(){return 0}},function(e,t){var r=function(){return this}();try{r=r||new Function("return this")()}catch(e){"object"==typeof window&&(r=window)}e.exports=r},function(B,e,t){t.r(e);console.log("NDS ExtensionFramework V0.1"),NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM,NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM,NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM,NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM,NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM;class r extends NDSWebViewer.Extension{constructor(){super()}onLoad(e){}onInitLights(){}update(e){}setFlags(e){super.setFlags(e)}onNdsModelPrepareForRendering(e){}onBeforeNdsModelUpdate(e,t){}onAfterNdsModelUpdate(e,t){}onBeforeNdsModelSetRender(e,t){}onAfterNdsModelSetRender(e,t){}onBeforeNdsMeshRender(e,t){}getExtensionWithFlags(e){return NDSWebViewer.ExtensionManager.getExtensionWithFlags(e)}resetToDefault(){}getStoreInfo(e){throw this.name+" Extesion did not implement method 'getStoreInfo' "}setStoreInfo(e){throw this.name+" Extesion did not implement method 'setStoreInfo' "}getBodyTransform(e){return new THREE.Matrix4}getBodyNodeTranslate(e){return new THREE.Vector3(0,0,0)}}var b={CompressionMethod:{RAW:5718354,MG1:3229517,MG2:3295053},Flags:{NORMALS:1},File:function(e){this.load(e)}};b.File.prototype.load=function(e){this.header=new b.FileHeader(e),this.body=new b.FileBody(this.header),this.getReader().read(e,this.body)},b.File.prototype.getReader=function(){var e;switch(this.header.compressionMethod){case b.CompressionMethod.RAW:e=new b.ReaderRAW;break;case b.CompressionMethod.MG1:e=new b.ReaderMG1;break;case b.CompressionMethod.MG2:e=new b.ReaderMG2}return e},b.FileHeader=function(e){e.readInt32(),this.fileFormat=e.readInt32(),this.compressionMethod=e.readInt32(),this.vertexCount=e.readInt32(),this.triangleCount=e.readInt32(),this.uvMapCount=e.readInt32(),this.attrMapCount=e.readInt32(),this.flags=e.readInt32(),this.comment=e.readString()},b.FileHeader.prototype.hasNormals=function(){return this.flags&b.Flags.NORMALS},b.FileBody=function(e){var t=3*e.triangleCount,r=3*e.vertexCount,o=e.hasNormals()?3*e.vertexCount:0,s=2*e.vertexCount,n=4*e.vertexCount,i=0,a=new ArrayBuffer(4*(t+r+o+s*e.uvMapCount+n*e.attrMapCount));if(this.indices=new Uint32Array(a,0,t),this.vertices=new Float32Array(a,4*t,r),e.hasNormals()&&(this.normals=new Float32Array(a,4*(t+r),o)),e.uvMapCount)for(this.uvMaps=[],i=0;i<e.uvMapCount;++i)this.uvMaps[i]={uv:new Float32Array(a,4*(t+r+o+i*s),s)};if(e.attrMapCount)for(this.attrMaps=[],i=0;i<e.attrMapCount;++i)this.attrMaps[i]={attr:new Float32Array(a,4*(t+r+o+s*e.uvMapCount+i*n),n)}},b.FileMG2Header=function(e){e.readInt32(),this.vertexPrecision=e.readFloat32(),this.normalPrecision=e.readFloat32(),this.lowerBoundx=e.readFloat32(),this.lowerBoundy=e.readFloat32(),this.lowerBoundz=e.readFloat32(),this.higherBoundx=e.readFloat32(),this.higherBoundy=e.readFloat32(),this.higherBoundz=e.readFloat32(),this.divx=e.readInt32(),this.divy=e.readInt32(),this.divz=e.readInt32(),this.sizex=(this.higherBoundx-this.lowerBoundx)/this.divx,this.sizey=(this.higherBoundy-this.lowerBoundy)/this.divy,this.sizez=(this.higherBoundz-this.lowerBoundz)/this.divz},b.ReaderRAW=function(){},b.ReaderRAW.prototype.read=function(e,t){this.readIndices(e,t.indices),this.readVertices(e,t.vertices),t.normals&&this.readNormals(e,t.normals),t.uvMaps&&this.readUVMaps(e,t.uvMaps),t.attrMaps&&this.readAttrMaps(e,t.attrMaps)},b.ReaderRAW.prototype.readIndices=function(e,t){e.readInt32(),e.readArrayInt32(t)},b.ReaderRAW.prototype.readVertices=function(e,t){e.readInt32(),e.readArrayFloat32(t)},b.ReaderRAW.prototype.readNormals=function(e,t){e.readInt32(),e.readArrayFloat32(t)},b.ReaderRAW.prototype.readUVMaps=function(e,t){for(var r=0;r<t.length;++r)e.readInt32(),t[r].name=e.readString(),t[r].filename=e.readString(),e.readArrayFloat32(t[r].uv)},b.ReaderRAW.prototype.readAttrMaps=function(e,t){for(var r=0;r<t.length;++r)e.readInt32(),t[r].name=e.readString(),e.readArrayFloat32(t[r].attr)},b.ReaderMG1=function(){},b.ReaderMG1.prototype.read=function(e,t){this.readIndices(e,t.indices),this.readVertices(e,t.vertices),t.normals&&this.readNormals(e,t.normals),t.uvMaps&&this.readUVMaps(e,t.uvMaps),t.attrMaps&&this.readAttrMaps(e,t.attrMaps)},b.ReaderMG1.prototype.readIndices=function(e,t){e.readInt32(),e.readInt32();var r=new b.InterleavedStream(t,3);LZMA.decompress(e,e,r,r.data.length),b.restoreIndices(t,t.length)},b.ReaderMG1.prototype.readVertices=function(e,t){e.readInt32(),e.readInt32();t=new b.InterleavedStream(t,1);LZMA.decompress(e,e,t,t.data.length)},b.ReaderMG1.prototype.readNormals=function(e,t){e.readInt32(),e.readInt32();t=new b.InterleavedStream(t,3);LZMA.decompress(e,e,t,t.data.length)},b.ReaderMG1.prototype.readUVMaps=function(e,t){for(var r=0;r<t.length;++r){e.readInt32(),t[r].name=e.readString(),t[r].filename=e.readString(),e.readInt32();var o=new b.InterleavedStream(t[r].uv,2);LZMA.decompress(e,e,o,o.data.length)}},b.ReaderMG1.prototype.readAttrMaps=function(e,t){for(var r=0;r<t.length;++r){e.readInt32(),t[r].name=e.readString(),e.readInt32();var o=new b.InterleavedStream(t[r].attr,4);LZMA.decompress(e,e,o,o.data.length)}},b.ReaderMG2=function(){},b.ReaderMG2.prototype.read=function(e,t){this.MG2Header=new b.FileMG2Header(e),this.readVertices(e,t.vertices),this.readIndices(e,t.indices),t.normals&&this.readNormals(e,t),t.uvMaps&&this.readUVMaps(e,t.uvMaps),t.attrMaps&&this.readAttrMaps(e,t.attrMaps)},b.ReaderMG2.prototype.readVertices=function(e,t){e.readInt32(),e.readInt32();var r=new b.InterleavedStream(t,3),r=(LZMA.decompress(e,e,r,r.data.length),this.readGridIndices(e,t));b.restoreVertices(t,this.MG2Header,r,this.MG2Header.vertexPrecision)},b.ReaderMG2.prototype.readGridIndices=function(e,t){e.readInt32(),e.readInt32();var t=new Uint32Array(t.length/3),r=new b.InterleavedStream(t,1);return LZMA.decompress(e,e,r,r.data.length),b.restoreGridIndices(t,t.length),t},b.ReaderMG2.prototype.readIndices=function(e,t){e.readInt32(),e.readInt32();var r=new b.InterleavedStream(t,3);LZMA.decompress(e,e,r,r.data.length),b.restoreIndices(t,t.length)},b.ReaderMG2.prototype.readNormals=function(e,t){e.readInt32(),e.readInt32();var r=new b.InterleavedStream(t.normals,3),e=(LZMA.decompress(e,e,r,r.data.length),b.calcSmoothNormals(t.indices,t.vertices));b.restoreNormals(t.normals,e,this.MG2Header.normalPrecision)},b.ReaderMG2.prototype.readUVMaps=function(e,t){for(var r=0;r<t.length;++r){e.readInt32(),t[r].name=e.readString(),t[r].filename=e.readString();var o=e.readFloat32(),s=(e.readInt32(),new b.InterleavedStream(t[r].uv,2));LZMA.decompress(e,e,s,s.data.length),b.restoreMap(t[r].uv,2,o)}},b.ReaderMG2.prototype.readAttrMaps=function(e,t){for(var r=0;r<t.length;++r){e.readInt32(),t[r].name=e.readString();var o=e.readFloat32(),s=(e.readInt32(),new b.InterleavedStream(t[r].attr,4));LZMA.decompress(e,e,s,s.data.length),b.restoreMap(t[r].attr,4,o)}},b.restoreIndices=function(e,t){var r=3;for(0<t&&(e[2]+=e[0],e[1]+=e[0]);r<t;r+=3)e[r]+=e[r-3],e[r]===e[r-3]?e[r+1]+=e[r-2]:e[r+1]+=e[r],e[r+2]+=e[r]},b.restoreIndices2=function(e,t,r){var o=3;for(0<r&&(e[t+2]+=e[t+0],e[t+1]+=e[t+0]);o<r;o+=3)e[t+o]+=e[t+o-3],e[t+o]===e[t+o-3]?e[t+o+1]+=e[t+o-2]:e[t+o+1]+=e[t+o],e[t+o+2]+=e[t+o]},b.restoreGridIndices=function(e,t){for(var r=1;r<t;++r)e[r]+=e[r-1]},b.restoreVertices=function(e,t,r,o){for(var s,n,i,a,c,l=new Uint32Array(e.buffer,e.byteOffset,e.length),h=t.divx,d=h*t.divy,u=2147483647,p=0,g=0,f=0,m=r.length;g<m;f+=3)i=s=r[g++],i=(i-=~~((c=~~(i/d))*d))-~~((a=~~(i/h))*h),n=l[f],s===u&&(n+=p),e[f]=t.lowerBoundx+i*t.sizex+o*n,e[f+1]=t.lowerBoundy+a*t.sizey+o*l[f+1],e[f+2]=t.lowerBoundz+c*t.sizez+o*l[f+2],u=s,p=n},b.restoreNormals=function(e,t,r){for(var o,s,n,i,a,c,l=new Uint32Array(e.buffer,e.byteOffset,e.length),h=0,d=e.length,u=1.5707963267948966;h<d;h+=3)a=l[h]*r,0===(i=l[h+1])?(e[h]=t[h]*a,e[h+1]=t[h+1]*a,e[h+2]=t[h+2]*a):(n=i<=4?(l[h+2]-2)*u:(4*l[h+2]/i-2)*u,i*=r*u,o=(s=a*Math.sin(i))*Math.cos(n),s=s*Math.sin(n),n=a*Math.cos(i),a=t[h+1],i=t[h]-t[h+2],1e-20<(c=Math.sqrt(2*a*a+i*i))&&(i/=c,a/=c),e[h]=t[h]*n+(t[h+1]*a-t[h+2]*i)*s-a*o,e[h+1]=t[h+1]*n-(t[h+2]+t[h])*a*s+i*o,e[h+2]=t[h+2]*n+(t[h]*i+t[h+1]*a)*s+a*o)},b.restoreMap=function(e,t,r){for(var o,s,n,i=new Uint32Array(e.buffer,e.byteOffset,e.length),a=0,c=e.length;a<t;++a)for(o=0,n=a;n<c;n+=t)o+=1&(s=i[n])?-(s+1>>1):s>>1,e[n]=o*r},b.calcSmoothNormals=function(e,t){for(var r,o,s,n,i,a,c,l,h,d,u,p=new Float32Array(t.length),g=0,f=e.length;g<f;)r=3*e[g++],o=3*e[g++],s=3*e[g++],i=t[o]-t[r],l=t[s]-t[r],a=t[1+o]-t[1+r],h=t[1+s]-t[1+r],c=t[2+o]-t[2+r],n=a*(d=t[2+s]-t[2+r])-c*h,c=c*l-i*d,d=i*h-a*l,1e-10<(u=Math.sqrt(n*n+c*c+d*d))&&(n/=u,c/=u,d/=u),p[r]+=n,p[1+r]+=c,p[2+r]+=d,p[o]+=n,p[1+o]+=c,p[2+o]+=d,p[s]+=n,p[1+s]+=c,p[2+s]+=d;for(g=0,f=p.length;g<f;g+=3)1e-10<(u=Math.sqrt(p[g]*p[g]+p[g+1]*p[g+1]+p[g+2]*p[g+2]))&&(p[g]/=u,p[g+1]/=u,p[g+2]/=u);return p},b.isLittleEndian=(e=new ArrayBuffer(2),A=new Uint8Array(e),e=new Uint16Array(e),(A[0]=1)===e[0]),b.InterleavedStream=function(e,t){this.data=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),this.offset=b.isLittleEndian?3:0,this.count=4*t,this.len=this.data.length},b.InterleavedStream.prototype.writeByte=function(e){this.data[this.offset]=e,this.offset+=this.count,this.offset>=this.len&&(this.offset-=this.len-4,this.offset>=this.count)&&(this.offset-=this.count+(b.isLittleEndian?1:-1))},b.BIMStream=function(e,t,r){this.data=e,this.offset=t,this.count=r,this.len=this.data.length},b.BIMStream.prototype.writeByte=function(e){this.data[this.offset]=e,this.offset+=this.count,this.offset>=this.len&&(this.offset=0)},b.Stream=function(e){this.data=e,this.dataView=new DataView(e.buffer),this.offset=0},b.Stream.prototype.TWO_POW_MINUS23=Math.pow(2,-23),b.Stream.prototype.TWO_POW_MINUS126=Math.pow(2,-126),b.Stream.prototype.seek=function(e){this.offset=e},b.Stream.prototype.readByte=function(){return 255&this.data[this.offset++]},b.Stream.prototype.skipByte=function(){this.offset++},b.Stream.prototype.readUInt8=function(){return this.dataView.getUint8(this.offset++,!0)},b.Stream.prototype.skipUInt8=function(){this.offset++},b.Stream.prototype.readInt32=function(){var e=this.dataView.getInt32(this.offset,!0);return this.offset+=4,e},b.Stream.prototype.skipInt32=function(){this.offset+=4},b.Stream.prototype.readUInt32=function(){var e=this.dataView.getUint32(this.offset,!0);return this.offset+=4,e},b.Stream.prototype.skipUInt32=function(){this.offset+=4},b.Stream.prototype.readInt64=function(){var e=this.dataView.getUint32(this.offset,!0),t=(this.offset+=4,this.dataView.getUint32(this.offset,!0)),t=(this.offset+=4,BigInt(t)<<BigInt(32)|BigInt(e));return Number(t.valueOf())},b.Stream.prototype.skipInt64=function(){this.offset+=8},b.Stream.prototype.readInt16=function(){var e=this.dataView.getInt16(this.offset,!0);return this.offset+=2,e},b.Stream.prototype.skipInt16=function(){this.offset+=2},b.Stream.prototype.readUInt16=function(){var e=this.dataView.getUint16(this.offset,!0);return this.offset+=2,e},b.Stream.prototype.skipUInt16=function(){this.offset+=2},b.Stream.prototype.readFloat32=function(){var e=this.dataView.getFloat32(this.offset,!0);return this.offset+=4,e},b.Stream.prototype.skipFloat32=function(){this.offset+=4},b.Stream.prototype.readFloat64=function(){var e=this.dataView.getFloat64(this.offset,!0);return this.offset+=8,e},b.Stream.prototype.skipFloat64=function(){this.offset+=8},b.Stream.prototype.readString=function(){var e=this.readInt32();return this.offset+=e,String.fromCharCode.apply(null,this.data.subarray(this.offset-e,this.offset))},b.Stream.prototype.skipString=function(){var e=this.readInt32();this.offset+=e},b.Stream.prototype.readTexture=function(){for(var e=this.readByte(),t=[],r=0;r<8;r++){var o=4*r;e&Math.pow(2,r)?(t[o]=0,t[1+o]=0,t[2+o]=0,t[3+o]=255):(t[o]=255,t[1+o]=255,t[2+o]=255,t[3+o]=0)}return t},b.Stream.prototype.readGuid=function(){for(var e,t="";t+=e=String.fromCharCode(this.readByte()),0!==e.charCodeAt(0););return 0==NDSWebViewer.SETTING.ScenarioEditorid?t.substring(0,t.length-1):NDSWebViewer.COMMON.addSceneID(t.substring(0,t.length-1))},b.Stream.prototype.readArrayUint8=function(r){for(let e=0,t=r.length;e<t;++e)r[e]=this.data[this.offset++];return r},b.Stream.prototype.skipArrayUint8=function(e){this.offset+=e},b.Stream.prototype.readArrayInt32=function(e){for(var t=0,r=e.length;t<r;)e[t++]=this.readInt32();return e},b.Stream.prototype.skipArrayInt32=function(e){for(;0<e--;)this.skipInt32()},b.Stream.prototype.readArrayUInt32=function(e){for(var t=0,r=e.length;t<r;)e[t++]=this.readUInt32();return e},b.Stream.prototype.skipArrayUInt32=function(e){for(;0<e--;)this.skipUInt32()},b.Stream.prototype.readArrayInt16=function(e){for(var t=0,r=e.length;t<r;)e[t++]=this.readInt16();return e},b.Stream.prototype.skipArrayInt16=function(e){for(;0<e--;)this.skipInt16()},b.Stream.prototype.readArrayFloat32=function(e){for(var t=0,r=e.length;t<r;)e[t++]=this.readFloat32();return e},b.Stream.prototype.skipArrayFloat32=function(e){for(;0<e--;)this.skipFloat32()};let o=new Map,a={setKey:function(e){return""+e},set:function(e,t){o.set(this.setKey(e),JSON.stringify(t))},get:function(e){e=o.get(this.setKey(e));return void 0===e?e:JSON.parse(e)},remove:function(e){o.remove(this.setKey(e))},clear:function(){o.clear()}};class s{constructor(e){if(this.baseUrl=e,s.instance)throw new Error("AxiosService class can only have one instance!");"function"==typeof importScripts&&importScripts("./third-party/axios.min.js"),(s.instance=this).service=this.createService(),this.addInterceptorsRequest(),this.addInterceptorsResponse()}createService(){return axios.create({baseURL:this.baseUrl,timeout:6e5,headers:{"Content-Type":"application/json"}})}addInterceptorsRequest(){this.service.interceptors.request.use(function(e){return"/nds_lite/Common/GetToken"!==e.url&&a.get("token")&&(e.headers.Authorization="Bearer "+a.get("token")),e},function(e){return Promise.reject(e)})}addInterceptorsResponse(){this.service.interceptors.response.use(function(e){e=e.data;if(e.status&&e.status.code&&1!==e.status.code){if(401===e.status.code||4001===e.status.code)a.clear(),console.error("你已被登出，请重新登录");else if(-10134===e.status.code)return console.log(e.status.msg),e;return Promise.reject(this.service.interceptors.response)}return e},function(e){return-1!=e.message.indexOf("timeout")?console.error("网络超时"):"Network Error"==e.message?console.error("网络连接错误"):e.response.data?console.error(e.response.statusText):console.error("接口路径找不到"),Promise.reject(e)})}}function n(e=""){if(null!==s.instance||""!==e)return s.instance||new s(e),s.instance;console.error("The Fist Call this function, baseUrl is not empty!")}let G=[0,2e3,1e4,3e4,null];class c{constructor(e){this._retryDelays=void 0!==e?[...e,null]:G}nextRetryDelayInMilliseconds(e){return this._retryDelays[e.previousRetryCount]}}class d{}d.Authorization="Authorization",d.Cookie="Cookie";class l{constructor(e,t,r){this.statusCode=e,this.statusText=t,this.content=r}}class h{get(e,t){return this.send({...t,method:"GET",url:e})}post(e,t){return this.send({...t,method:"POST",url:e})}delete(e,t){return this.send({...t,method:"DELETE",url:e})}getCookieString(e){return""}}class F extends h{constructor(e,t){super(),this._innerClient=e,this._accessTokenFactory=t}async send(e){let t=!0;this._accessTokenFactory&&(!this._accessToken||e.url&&0<e.url.indexOf("/negotiate?"))&&(t=!1,this._accessToken=await this._accessTokenFactory()),this._setAuthorizationHeader(e);var r=await this._innerClient.send(e);return t&&401===r.statusCode&&this._accessTokenFactory?(this._accessToken=await this._accessTokenFactory(),this._setAuthorizationHeader(e),this._innerClient.send(e)):r}_setAuthorizationHeader(e){e.headers||(e.headers={}),this._accessToken?e.headers[d.Authorization]="Bearer "+this._accessToken:this._accessTokenFactory&&e.headers[d.Authorization]&&delete e.headers[d.Authorization]}getCookieString(e){return this._innerClient.getCookieString(e)}}class u extends Error{constructor(e,t){var r=new.target.prototype;super(e+`: Status code '${t}'`),this.statusCode=t,this.__proto__=r}}class p extends Error{constructor(e="A timeout occurred."){var t=new.target.prototype;super(e),this.__proto__=t}}class g extends Error{constructor(e="An abort occurred."){var t=new.target.prototype;super(e),this.__proto__=t}}class O extends Error{constructor(e,t){var r=new.target.prototype;super(e),this.transport=t,this.errorType="UnsupportedTransportError",this.__proto__=r}}class W extends Error{constructor(e,t){var r=new.target.prototype;super(e),this.transport=t,this.errorType="DisabledTransportError",this.__proto__=r}}class j extends Error{constructor(e,t){var r=new.target.prototype;super(e),this.transport=t,this.errorType="FailedToStartTransportError",this.__proto__=r}}class f extends Error{constructor(e){var t=new.target.prototype;super(e),this.errorType="FailedToNegotiateWithServerError",this.__proto__=t}}class L extends Error{constructor(e,t){var r=new.target.prototype;super(e),this.innerErrors=t,this.__proto__=r}}var m,_,y,v,w=t(0),C=t(1);class H extends h{constructor(e){super(),this._logger=e,"undefined"==typeof fetch||C.c.isNode?(e=require,this._jar=new(e("tough-cookie").CookieJar),"undefined"==typeof fetch?this._fetchType=e("node-fetch"):this._fetchType=fetch,this._fetchType=e("fetch-cookie")(this._fetchType,this._jar)):this._fetchType=fetch.bind(Object(C.h)()),"undefined"==typeof AbortController?(e=require,this._abortControllerType=e("abort-controller")):this._abortControllerType=AbortController}async send(e){if(e.abortSignal&&e.abortSignal.aborted)throw new g;if(!e.method)throw new Error("No method defined.");if(!e.url)throw new Error("No url defined.");let t=new this._abortControllerType,r,o=(e.abortSignal&&(e.abortSignal.onabort=()=>{t.abort(),r=new g}),null);var s;e.timeout&&(s=e.timeout,o=setTimeout(()=>{t.abort(),this._logger.log(w.a.Warning,"Timeout from HTTP request."),r=new p},s)),""===e.content&&(e.content=void 0),e.content&&(e.headers=e.headers||{},Object(C.j)(e.content)?e.headers["Content-Type"]="application/octet-stream":e.headers["Content-Type"]="text/plain;charset=UTF-8");let n;try{n=await this._fetchType(e.url,{body:e.content,cache:"no-cache",credentials:!0===e.withCredentials?"include":"same-origin",headers:{"X-Requested-With":"XMLHttpRequest",...e.headers},method:e.method,mode:"cors",redirect:"follow",signal:t.signal})}catch(e){if(r)throw r;throw this._logger.log(w.a.Warning,`Error from HTTP request. ${e}.`),e}finally{o&&clearTimeout(o),e.abortSignal&&(e.abortSignal.onabort=null)}if(n.ok)return s=await I(n,e.responseType),new l(n.status,n.statusText,s);throw e=await I(n,"text"),new u(e||n.statusText,n.status)}getCookieString(e){let r="";return C.c.isNode&&this._jar&&this._jar.getCookies(e,(e,t)=>r=t.join("; ")),r}}function I(e,t){let r;switch(t){case"arraybuffer":r=e.arrayBuffer();break;case"text":r=e.text();break;case"blob":case"document":case"json":throw new Error(t+" is not supported.");default:r=e.text()}return r}class V extends h{constructor(e){super(),this._logger=e}send(s){return s.abortSignal&&s.abortSignal.aborted?Promise.reject(new g):s.method?s.url?new Promise((e,t)=>{let r=new XMLHttpRequest,o=(r.open(s.method,s.url,!0),r.withCredentials=void 0===s.withCredentials||s.withCredentials,r.setRequestHeader("X-Requested-With","XMLHttpRequest"),""===s.content&&(s.content=void 0),s.content&&(Object(C.j)(s.content)?r.setRequestHeader("Content-Type","application/octet-stream"):r.setRequestHeader("Content-Type","text/plain;charset=UTF-8")),s.headers);o&&Object.keys(o).forEach(e=>{r.setRequestHeader(e,o[e])}),s.responseType&&(r.responseType=s.responseType),s.abortSignal&&(s.abortSignal.onabort=()=>{r.abort(),t(new g)}),s.timeout&&(r.timeout=s.timeout),r.onload=()=>{s.abortSignal&&(s.abortSignal.onabort=null),200<=r.status&&r.status<300?e(new l(r.status,r.statusText,r.response||r.responseText)):t(new u(r.response||r.responseText||r.statusText,r.status))},r.onerror=()=>{this._logger.log(w.a.Warning,`Error from HTTP request. ${r.status}: ${r.statusText}.`),t(new u(r.statusText,r.status))},r.ontimeout=()=>{this._logger.log(w.a.Warning,"Timeout from HTTP request."),t(new p)},r.send(s.content)}):Promise.reject(new Error("No url defined.")):Promise.reject(new Error("No method defined."))}}class $ extends h{constructor(e){if(super(),"undefined"!=typeof fetch||C.c.isNode)this._httpClient=new H(e);else{if("undefined"==typeof XMLHttpRequest)throw new Error("No usable HttpClient found.");this._httpClient=new V(e)}}send(e){return e.abortSignal&&e.abortSignal.aborted?Promise.reject(new g):e.method?e.url?this._httpClient.send(e):Promise.reject(new Error("No url defined.")):Promise.reject(new Error("No method defined."))}getCookieString(e){return this._httpClient.getCookieString(e)}}(A=m=m||{})[A.None=0]="None",A[A.WebSockets=1]="WebSockets",A[A.ServerSentEvents=2]="ServerSentEvents",A[A.LongPolling=4]="LongPolling",(e=_=_||{})[e.Text=1]="Text",e[e.Binary=2]="Binary";class z{constructor(){this._isAborted=!1,this.onabort=null}abort(){this._isAborted||(this._isAborted=!0,this.onabort&&this.onabort())}get signal(){return this}get aborted(){return this._isAborted}}class S{get pollAborted(){return this._pollAbort.aborted}constructor(e,t,r){this._httpClient=e,this._logger=t,this._pollAbort=new z,this._options=r,this._running=!1,this.onreceive=null,this.onclose=null}async connect(e,t){if(C.a.isRequired(e,"url"),C.a.isRequired(t,"transferFormat"),C.a.isIn(t,_,"transferFormat"),this._url=e,this._logger.log(w.a.Trace,"(LongPolling transport) Connecting."),t===_.Binary&&"undefined"!=typeof XMLHttpRequest&&"string"!=typeof(new XMLHttpRequest).responseType)throw new Error("Binary protocols over XmlHttpRequest not implementing advanced features are not supported.");var[r,o]=Object(C.i)(),r={[r]:o,...this._options.headers},o={abortSignal:this._pollAbort.signal,headers:r,timeout:1e5,withCredentials:this._options.withCredentials},r=(t===_.Binary&&(o.responseType="arraybuffer"),e+"&_="+Date.now()),t=(this._logger.log(w.a.Trace,`(LongPolling transport) polling: ${r}.`),await this._httpClient.get(r,o));200!==t.statusCode?(this._logger.log(w.a.Error,`(LongPolling transport) Unexpected response code: ${t.statusCode}.`),this._closeError=new u(t.statusText||"",t.statusCode),this._running=!1):this._running=!0,this._receiving=this._poll(this._url,o)}async _poll(e,t){try{for(;this._running;)try{var r=e+"&_="+Date.now(),o=(this._logger.log(w.a.Trace,`(LongPolling transport) polling: ${r}.`),await this._httpClient.get(r,t));204===o.statusCode?(this._logger.log(w.a.Information,"(LongPolling transport) Poll terminated by server."),this._running=!1):200!==o.statusCode?(this._logger.log(w.a.Error,`(LongPolling transport) Unexpected response code: ${o.statusCode}.`),this._closeError=new u(o.statusText||"",o.statusCode),this._running=!1):o.content?(this._logger.log(w.a.Trace,`(LongPolling transport) data received. ${Object(C.f)(o.content,this._options.logMessageContent)}.`),this.onreceive&&this.onreceive(o.content)):this._logger.log(w.a.Trace,"(LongPolling transport) Poll timed out, reissuing.")}catch(e){this._running?e instanceof p?this._logger.log(w.a.Trace,"(LongPolling transport) Poll timed out, reissuing."):(this._closeError=e,this._running=!1):this._logger.log(w.a.Trace,"(LongPolling transport) Poll errored after shutdown: "+e.message)}}finally{this._logger.log(w.a.Trace,"(LongPolling transport) Polling complete."),this.pollAborted||this._raiseOnClose()}}async send(e){return this._running?Object(C.k)(this._logger,"LongPolling",this._httpClient,this._url,e,this._options):Promise.reject(new Error("Cannot send until the transport is connected"))}async stop(){this._logger.log(w.a.Trace,"(LongPolling transport) Stopping polling."),this._running=!1,this._pollAbort.abort();try{await this._receiving,this._logger.log(w.a.Trace,`(LongPolling transport) sending DELETE request to ${this._url}.`);var e={},[r,o]=Object(C.i)(),s=(e[r]=o,{headers:{...e,...this._options.headers},timeout:this._options.timeout,withCredentials:this._options.withCredentials});let t;try{await this._httpClient.delete(this._url,s)}catch(e){t=e}t?t instanceof u&&(404===t.statusCode?this._logger.log(w.a.Trace,"(LongPolling transport) A 404 response was returned from sending a DELETE request."):this._logger.log(w.a.Trace,"(LongPolling transport) Error sending a DELETE request: "+t)):this._logger.log(w.a.Trace,"(LongPolling transport) DELETE request accepted.")}finally{this._logger.log(w.a.Trace,"(LongPolling transport) Stop finished."),this._raiseOnClose()}}_raiseOnClose(){if(this.onclose){let e="(LongPolling transport) Firing onclose event.";this._closeError&&(e+=" Error: "+this._closeError),this._logger.log(w.a.Trace,e),this.onclose(this._closeError)}}}class J{constructor(e,t,r,o){this._httpClient=e,this._accessToken=t,this._logger=r,this._options=o,this.onreceive=null,this.onclose=null}async connect(a,e){return C.a.isRequired(a,"url"),C.a.isRequired(e,"transferFormat"),C.a.isIn(e,_,"transferFormat"),this._logger.log(w.a.Trace,"(SSE transport) Connecting."),this._url=a,this._accessToken&&(a+=(a.indexOf("?")<0?"?":"&")+"access_token="+encodeURIComponent(this._accessToken)),new Promise((t,r)=>{let o=!1;if(e!==_.Text)r(new Error("The Server-Sent Events transport only supports the 'Text' transfer format"));else{let e;var s,n,i;e=C.c.isBrowser||C.c.isWebWorker?new this._options.EventSource(a,{withCredentials:this._options.withCredentials}):(n=this._httpClient.getCookieString(a),[n,i]=((s={}).Cookie=n,Object(C.i)()),s[n]=i,new this._options.EventSource(a,{withCredentials:this._options.withCredentials,headers:{...s,...this._options.headers}}));try{e.onmessage=e=>{if(this.onreceive)try{this._logger.log(w.a.Trace,`(SSE transport) data received. ${Object(C.f)(e.data,this._options.logMessageContent)}.`),this.onreceive(e.data)}catch(e){this._close(e)}},e.onerror=e=>{o?this._close():r(new Error("EventSource failed to connect. The connection could not be found on the server, either the connection ID is not present on the server, or a proxy is refusing/buffering the connection. If you have multiple servers check that sticky sessions are enabled."))},e.onopen=()=>{this._logger.log(w.a.Information,"SSE connected to "+this._url),this._eventSource=e,o=!0,t()}}catch(e){r(e)}}})}async send(e){return this._eventSource?Object(C.k)(this._logger,"SSE",this._httpClient,this._url,e,this._options):Promise.reject(new Error("Cannot send until the transport is connected"))}stop(){return this._close(),Promise.resolve()}_close(e){this._eventSource&&(this._eventSource.close(),this._eventSource=void 0,this.onclose)&&this.onclose(e)}}class Q{constructor(e,t,r,o,s,n){this._logger=r,this._accessTokenFactory=t,this._logMessageContent=o,this._webSocketConstructor=s,this._httpClient=e,this.onreceive=null,this.onclose=null,this._headers=n}async connect(c,l){C.a.isRequired(c,"url"),C.a.isRequired(l,"transferFormat"),C.a.isIn(l,_,"transferFormat"),this._logger.log(w.a.Trace,"(WebSockets transport) Connecting.");let h;return this._accessTokenFactory&&(h=await this._accessTokenFactory()),new Promise((t,r)=>{c=c.replace(/^http/,"ws");let o;var e,s,n,i=this._httpClient.getCookieString(c);let a=!1;C.c.isNode||C.c.isReactNative?(e={},[s,n]=Object(C.i)(),e[s]=n,h&&(e[d.Authorization]="Bearer "+h),i&&(e[d.Cookie]=i),o=new this._webSocketConstructor(c,void 0,{headers:{...e,...this._headers}})):h&&(c+=(c.indexOf("?")<0?"?":"&")+"access_token="+encodeURIComponent(h)),o=o||new this._webSocketConstructor(c),l===_.Binary&&(o.binaryType="arraybuffer"),o.onopen=e=>{this._logger.log(w.a.Information,`WebSocket connected to ${c}.`),this._webSocket=o,a=!0,t()},o.onerror=e=>{let t=null;t="undefined"!=typeof ErrorEvent&&e instanceof ErrorEvent?e.error:"There was an error with the transport",this._logger.log(w.a.Information,`(WebSockets transport) ${t}.`)},o.onmessage=e=>{if(this._logger.log(w.a.Trace,`(WebSockets transport) data received. ${Object(C.f)(e.data,this._logMessageContent)}.`),this.onreceive)try{this.onreceive(e.data)}catch(e){this._close(e)}},o.onclose=t=>{if(a)this._close(t);else{let e=null;e="undefined"!=typeof ErrorEvent&&t instanceof ErrorEvent?t.error:"WebSocket failed to connect. The connection could not be found on the server, either the endpoint may not be a SignalR endpoint, the connection ID is not present on the server, or there is a proxy blocking WebSockets. If you have multiple servers check that sticky sessions are enabled.",r(new Error(e))}}})}send(e){return this._webSocket&&this._webSocket.readyState===this._webSocketConstructor.OPEN?(this._logger.log(w.a.Trace,`(WebSockets transport) sending data. ${Object(C.f)(e,this._logMessageContent)}.`),this._webSocket.send(e),Promise.resolve()):Promise.reject("WebSocket is not in the OPEN state")}stop(){return this._webSocket&&this._close(void 0),Promise.resolve()}_close(e){this._webSocket&&(this._webSocket.onclose=()=>{},this._webSocket.onmessage=()=>{},this._webSocket.onerror=()=>{},this._webSocket.close(),this._webSocket=void 0),this._logger.log(w.a.Trace,"(WebSockets transport) socket closed."),this.onclose&&(!this._isCloseEvent(e)||!1!==e.wasClean&&1e3===e.code?e instanceof Error?this.onclose(e):this.onclose():this.onclose(new Error(`WebSocket closed with status code: ${e.code} (${e.reason||"no reason given"}).`)))}_isCloseEvent(e){return e&&"boolean"==typeof e.wasClean&&"number"==typeof e.code}}class X{constructor(e,t={}){if(this._stopPromiseResolver=()=>{},this.features={},this._negotiateVersion=1,C.a.isRequired(e,"url"),this._logger=Object(C.e)(t.logger),this.baseUrl=this._resolveUrl(e),(t=t||{}).logMessageContent=void 0!==t.logMessageContent&&t.logMessageContent,"boolean"!=typeof t.withCredentials&&void 0!==t.withCredentials)throw new Error("withCredentials option was not a 'boolean' or 'undefined' value");t.withCredentials=void 0===t.withCredentials||t.withCredentials,t.timeout=void 0===t.timeout?1e5:t.timeout;let r=null,o=null;C.c.isNode&&(e=require,r=e("ws"),o=e("eventsource")),C.c.isNode||"undefined"==typeof WebSocket||t.WebSocket?C.c.isNode&&!t.WebSocket&&r&&(t.WebSocket=r):t.WebSocket=WebSocket,C.c.isNode||"undefined"==typeof EventSource||t.EventSource?C.c.isNode&&!t.EventSource&&void 0!==o&&(t.EventSource=o):t.EventSource=EventSource,this._httpClient=new F(t.httpClient||new $(this._logger),t.accessTokenFactory),this._connectionState="Disconnected",this._connectionStarted=!1,this._options=t,this.onreceive=null,this.onclose=null}async start(e){return e=e||_.Binary,C.a.isIn(e,_,"transferFormat"),this._logger.log(w.a.Debug,`Starting connection with transfer format '${_[e]}'.`),"Disconnected"!==this._connectionState?Promise.reject(new Error("Cannot start an HttpConnection that is not in the 'Disconnected' state.")):(this._connectionState="Connecting",this._startInternalPromise=this._startInternal(e),await this._startInternalPromise,"Disconnecting"===this._connectionState?(this._logger.log(w.a.Error,e="Failed to start the HttpConnection before stop() was called."),await this._stopPromise,Promise.reject(new g(e))):"Connected"!==this._connectionState?(this._logger.log(w.a.Error,e="HttpConnection.startInternal completed gracefully but didn't enter the connection into the connected state!"),Promise.reject(new g(e))):void(this._connectionStarted=!0))}send(e){return"Connected"!==this._connectionState?Promise.reject(new Error("Cannot send data if the connection is not in the 'Connected' State.")):(this._sendQueue||(this._sendQueue=new M(this.transport)),this._sendQueue.send(e))}async stop(e){return"Disconnected"===this._connectionState?(this._logger.log(w.a.Debug,`Call to HttpConnection.stop(${e}) ignored because the connection is already in the disconnected state.`),Promise.resolve()):"Disconnecting"===this._connectionState?(this._logger.log(w.a.Debug,`Call to HttpConnection.stop(${e}) ignored because the connection is already in the disconnecting state.`),this._stopPromise):(this._connectionState="Disconnecting",this._stopPromise=new Promise(e=>{this._stopPromiseResolver=e}),await this._stopInternal(e),void await this._stopPromise)}async _stopInternal(e){this._stopError=e;try{await this._startInternalPromise}catch(e){}if(this.transport){try{await this.transport.stop()}catch(e){this._logger.log(w.a.Error,`HttpConnection.transport.stop() threw error '${e}'.`),this._stopConnection()}this.transport=void 0}else this._logger.log(w.a.Debug,"HttpConnection.transport is undefined in HttpConnection.stop() because start() failed.")}async _startInternal(r){let o=this.baseUrl;this._accessTokenFactory=this._options.accessTokenFactory,this._httpClient._accessTokenFactory=this._accessTokenFactory;try{if(this._options.skipNegotiation){if(this._options.transport!==m.WebSockets)throw new Error("Negotiation can only be skipped when using the WebSocket transport directly.");this.transport=this._constructTransport(m.WebSockets),await this._startTransport(o,r)}else{let t=null,e=0;do{if(t=await this._getNegotiationResponse(o),"Disconnecting"===this._connectionState||"Disconnected"===this._connectionState)throw new g("The connection was stopped during negotiation.");if(t.error)throw new Error(t.error);if(t.ProtocolVersion)throw new Error("Detected a connection attempt to an ASP.NET SignalR Server. This client only supports connecting to an ASP.NET Core SignalR Server. See https://aka.ms/signalr-core-differences for details.");if(t.url&&(o=t.url),t.accessToken){let e=t.accessToken;this._accessTokenFactory=()=>e,this._httpClient._accessToken=e,this._httpClient._accessTokenFactory=void 0}}while(e++,t.url&&e<100);if(100===e&&t.url)throw new Error("Negotiate redirection limit exceeded.");await this._createTransport(o,this._options.transport,t,r)}this.transport instanceof S&&(this.features.inherentKeepAlive=!0),"Connecting"===this._connectionState&&(this._logger.log(w.a.Debug,"The HttpConnection connected successfully."),this._connectionState="Connected")}catch(e){return this._logger.log(w.a.Error,"Failed to start the connection: "+e),this._connectionState="Disconnected",this.transport=void 0,this._stopPromiseResolver(),Promise.reject(e)}}async _getNegotiationResponse(e){var t={},[r,o]=Object(C.i)(),r=(t[r]=o,this._resolveNegotiateUrl(e));this._logger.log(w.a.Debug,`Sending negotiation request: ${r}.`);try{var s,n=await this._httpClient.post(r,{content:"",headers:{...t,...this._options.headers},timeout:this._options.timeout,withCredentials:this._options.withCredentials});return 200!==n.statusCode?Promise.reject(new Error(`Unexpected status code returned from negotiate '${n.statusCode}'`)):((!(s=JSON.parse(n.content)).negotiateVersion||s.negotiateVersion<1)&&(s.connectionToken=s.connectionId),s.useStatefulReconnect&&!0!==this._options._useStatefulReconnect?Promise.reject(new f("Client didn't negotiate Stateful Reconnect but the server did.")):s)}catch(e){let t="Failed to complete negotiation with the server: "+e;return e instanceof u&&404===e.statusCode&&(t+=" Either this is not a SignalR endpoint or there is a proxy blocking the connection."),this._logger.log(w.a.Error,t),Promise.reject(new f(t))}}_createConnectUrl(e,t){return t?e+(-1===e.indexOf("?")?"?":"&")+"id="+t:e}async _createTransport(e,r,o,s){let n=this._createConnectUrl(e,o.connectionToken);if(!this._isITransport(r)){var i,a=[];let t=o;for(i of o.availableTransports||[]){var c=this._resolveTransportOrError(i,r,s,!0===(null===t||void 0===t?void 0:t.useStatefulReconnect));if(c instanceof Error)a.push(i.transport+" failed:"),a.push(c);else if(this._isITransport(c)){if(this.transport=c,!t){try{t=await this._getNegotiationResponse(e)}catch(e){return Promise.reject(e)}n=this._createConnectUrl(e,t.connectionToken)}try{return await this._startTransport(n,s),void(this.connectionId=t.connectionId)}catch(e){if(this._logger.log(w.a.Error,`Failed to start the transport '${i.transport}': `+e),t=void 0,a.push(new j(i.transport+" failed: "+e,m[i.transport])),"Connecting"!==this._connectionState)return this._logger.log(w.a.Debug,c="Failed to select transport before stop() was called."),Promise.reject(new g(c))}}}return 0<a.length?Promise.reject(new L("Unable to connect to the server with any of the available transports. "+a.join(" "),a)):Promise.reject(new Error("None of the transports supported by the client are supported by the server."))}this._logger.log(w.a.Debug,"Connection was provided an instance of ITransport, using that directly."),this.transport=r,await this._startTransport(n,s),this.connectionId=o.connectionId}_constructTransport(e){switch(e){case m.WebSockets:if(this._options.WebSocket)return new Q(this._httpClient,this._accessTokenFactory,this._logger,this._options.logMessageContent,this._options.WebSocket,this._options.headers||{});throw new Error("'WebSocket' is not supported in your environment.");case m.ServerSentEvents:if(this._options.EventSource)return new J(this._httpClient,this._httpClient._accessToken,this._logger,this._options);throw new Error("'EventSource' is not supported in your environment.");case m.LongPolling:return new S(this._httpClient,this._logger,this._options);default:throw new Error(`Unknown transport: ${e}.`)}}_startTransport(r,o){return this.transport.onreceive=this.onreceive,this.features.reconnect?this.transport.onclose=async e=>{let t=!1;if(this.features.reconnect){try{this.features.disconnected(),await this.transport.connect(r,o),await this.features.resend()}catch{t=!0}t&&this._stopConnection(e)}else this._stopConnection(e)}:this.transport.onclose=e=>this._stopConnection(e),this.transport.connect(r,o)}_resolveTransportOrError(e,t,r,o){var s,n=m[e.transport];if(null==n)return this._logger.log(w.a.Debug,`Skipping transport '${e.transport}' because it is not supported by this client.`),new Error(`Skipping transport '${e.transport}' because it is not supported by this client.`);if(s=n,(t=t)&&0==(s&t))return this._logger.log(w.a.Debug,`Skipping transport '${m[n]}' because it was disabled by the client.`),new W(`'${m[n]}' is disabled by the client.`,n);if(!(0<=e.transferFormats.map(e=>_[e]).indexOf(r)))return this._logger.log(w.a.Debug,`Skipping transport '${m[n]}' because it does not support the requested transfer format '${_[r]}'.`),new Error(`'${m[n]}' does not support ${_[r]}.`);if(n===m.WebSockets&&!this._options.WebSocket||n===m.ServerSentEvents&&!this._options.EventSource)return this._logger.log(w.a.Debug,`Skipping transport '${m[n]}' because it is not supported in your environment.'`),new O(`'${m[n]}' is not supported in your environment.`,n);this._logger.log(w.a.Debug,`Selecting transport '${m[n]}'.`);try{return this.features.reconnect=n===m.WebSockets?o:void 0,this._constructTransport(n)}catch(e){return e}}_isITransport(e){return e&&"object"==typeof e&&"connect"in e}_stopConnection(t){if(this._logger.log(w.a.Debug,`HttpConnection.stopConnection(${t}) called while in state ${this._connectionState}.`),this.transport=void 0,t=this._stopError||t,this._stopError=void 0,"Disconnected"===this._connectionState)this._logger.log(w.a.Debug,`Call to HttpConnection.stopConnection(${t}) was ignored because the connection is already in the disconnected state.`);else{if("Connecting"===this._connectionState)throw this._logger.log(w.a.Warning,`Call to HttpConnection.stopConnection(${t}) was ignored because the connection is still in the connecting state.`),new Error(`HttpConnection.stopConnection(${t}) was called while the connection is still in the connecting state.`);if("Disconnecting"===this._connectionState&&this._stopPromiseResolver(),t?this._logger.log(w.a.Error,`Connection disconnected with error '${t}'.`):this._logger.log(w.a.Information,"Connection disconnected."),this._sendQueue&&(this._sendQueue.stop().catch(e=>{this._logger.log(w.a.Error,`TransportSendQueue.stop() threw error '${e}'.`)}),this._sendQueue=void 0),this.connectionId=void 0,this._connectionState="Disconnected",this._connectionStarted){this._connectionStarted=!1;try{this.onclose&&this.onclose(t)}catch(e){this._logger.log(w.a.Error,`HttpConnection.onclose(${t}) threw error '${e}'.`)}}}}_resolveUrl(e){if(0===e.lastIndexOf("https://",0)||0===e.lastIndexOf("http://",0))return e;var t;if(C.c.isBrowser)return(t=window.document.createElement("a")).href=e,this._logger.log(w.a.Information,`Normalizing '${e}' to '${t.href}'.`),t.href;throw new Error(`Cannot resolve '${e}'.`)}_resolveNegotiateUrl(e){var e=new URL(e),t=(e.pathname.endsWith("/")?e.pathname+="negotiate":e.pathname+="/negotiate",new URLSearchParams(e.searchParams));return t.has("negotiateVersion")||t.append("negotiateVersion",this._negotiateVersion.toString()),t.has("useStatefulReconnect")?"true"===t.get("useStatefulReconnect")&&(this._options._useStatefulReconnect=!0):!0===this._options._useStatefulReconnect&&t.append("useStatefulReconnect","true"),e.search=t.toString(),e.toString()}}class M{constructor(e){this._transport=e,this._buffer=[],this._executing=!0,this._sendBufferedData=new k,this._transportResult=new k,this._sendLoopPromise=this._sendLoop()}send(e){return this._bufferData(e),this._transportResult||(this._transportResult=new k),this._transportResult.promise}stop(){return this._executing=!1,this._sendBufferedData.resolve(),this._sendLoopPromise}_bufferData(e){if(this._buffer.length&&typeof this._buffer[0]!=typeof e)throw new Error(`Expected data to be of type ${typeof this._buffer} but was of type `+typeof e);this._buffer.push(e),this._sendBufferedData.resolve()}async _sendLoop(){for(;;){if(await this._sendBufferedData.promise,!this._executing){this._transportResult&&this._transportResult.reject("Connection stopped.");break}this._sendBufferedData=new k;var t=this._transportResult,e=(this._transportResult=void 0,"string"==typeof this._buffer[0]?this._buffer.join(""):M._concatBuffers(this._buffer));this._buffer.length=0;try{await this._transport.send(e),t.resolve()}catch(e){t.reject(e)}}}static _concatBuffers(e){var t,r=e.map(e=>e.byteLength).reduce((e,t)=>e+t),o=new Uint8Array(r);let s=0;for(t of e)o.set(new Uint8Array(t),s),s+=t.byteLength;return o.buffer}}class k{constructor(){this.promise=new Promise((e,t)=>[this._resolver,this._rejecter]=[e,t])}resolve(){this._resolver()}reject(e){this._rejecter(e)}}class R{static write(e){return""+e+R.RecordSeparator}static parse(e){if(e[e.length-1]!==R.RecordSeparator)throw new Error("Message is incomplete.");e=e.split(R.RecordSeparator);return e.pop(),e}}R.RecordSeparatorCode=30,R.RecordSeparator=String.fromCharCode(R.RecordSeparatorCode);class K{writeHandshakeRequest(e){return R.write(JSON.stringify(e))}parseHandshakeResponse(e){let t,r;if(Object(C.j)(e)){var o=new Uint8Array(e),s=o.indexOf(R.RecordSeparatorCode);if(-1===s)throw new Error("Message is incomplete.");s=s+1;t=String.fromCharCode.apply(null,Array.prototype.slice.call(o.slice(0,s))),r=o.byteLength>s?o.slice(s).buffer:null}else{o=e,s=o.indexOf(R.RecordSeparator);if(-1===s)throw new Error("Message is incomplete.");e=s+1;t=o.substring(0,e),r=o.length>e?o.substring(e):null}s=R.parse(t),o=JSON.parse(s[0]);if(o.type)throw new Error("Expected a handshake response from the server.");return[r,o]}}(A=y=y||{})[A.Invocation=1]="Invocation",A[A.StreamItem=2]="StreamItem",A[A.Completion=3]="Completion",A[A.StreamInvocation=4]="StreamInvocation",A[A.CancelInvocation=5]="CancelInvocation",A[A.Ping=6]="Ping",A[A.Close=7]="Close",A[A.Ack=8]="Ack",A[A.Sequence=9]="Sequence";class Z{constructor(){this.observers=[]}next(e){for(var t of this.observers)t.next(e)}error(e){for(var t of this.observers)t.error&&t.error(e)}complete(){for(var e of this.observers)e.complete&&e.complete()}subscribe(e){return this.observers.push(e),new C.d(this,e)}}class Y{constructor(e,t,r){this._bufferSize=1e5,this._messages=[],this._totalMessageCount=0,this._waitForSequenceMessage=!1,this._nextReceivingSequenceId=1,this._latestReceivedSequenceId=0,this._bufferedByteCount=0,this._reconnectInProgress=!1,this._protocol=e,this._connection=t,this._bufferSize=r}async _send(e){var t=this._protocol.writeMessage(e);let s=Promise.resolve();if(this._isInvocationMessage(e)){this._totalMessageCount++;let r=()=>{},o=()=>{};Object(C.j)(t)?this._bufferedByteCount+=t.byteLength:this._bufferedByteCount+=t.length,this._bufferedByteCount>=this._bufferSize&&(s=new Promise((e,t)=>{r=e,o=t})),this._messages.push(new ee(t,this._totalMessageCount,r,o))}try{this._reconnectInProgress||await this._connection.send(t)}catch{this._disconnected()}await s}_ack(t){let r=-1;for(let e=0;e<this._messages.length;e++){var o=this._messages[e];if(o._id<=t.sequenceId)r=e,Object(C.j)(o._message)?this._bufferedByteCount-=o._message.byteLength:this._bufferedByteCount-=o._message.length;else if(!(this._bufferedByteCount<this._bufferSize))break;o._resolver()}-1!==r&&(this._messages=this._messages.slice(r+1))}_shouldProcessMessage(e){if(this._waitForSequenceMessage)return e.type===y.Sequence&&!(this._waitForSequenceMessage=!1);if(this._isInvocationMessage(e)){e=this._nextReceivingSequenceId;if(this._nextReceivingSequenceId++,e<=this._latestReceivedSequenceId)return e===this._latestReceivedSequenceId&&this._ackTimer(),!1;this._latestReceivedSequenceId=e,this._ackTimer()}return!0}_resetSequence(e){e.sequenceId>this._nextReceivingSequenceId?this._connection.stop(new Error("Sequence ID greater than amount of messages we've received.")):this._nextReceivingSequenceId=e.sequenceId}_disconnected(){this._reconnectInProgress=!0,this._waitForSequenceMessage=!0}async _resend(){var e,t=0!==this._messages.length?this._messages[0]._id:this._totalMessageCount+1,t=(await this._connection.send(this._protocol.writeMessage({type:y.Sequence,sequenceId:t})),this._messages);for(e of t)await this._connection.send(e._message);this._reconnectInProgress=!1}_dispose(e){null==e&&(e=new Error("Unable to reconnect to server."));for(var t of this._messages)t._rejector(e)}_isInvocationMessage(e){switch(e.type){case y.Invocation:case y.StreamItem:case y.Completion:case y.StreamInvocation:case y.CancelInvocation:return!0;case y.Close:case y.Sequence:case y.Ping:case y.Ack:return!1}}_ackTimer(){void 0===this._ackTimerHandle&&(this._ackTimerHandle=setTimeout(async()=>{try{this._reconnectInProgress||await this._connection.send(this._protocol.writeMessage({type:y.Ack,sequenceId:this._latestReceivedSequenceId}))}catch{}clearTimeout(this._ackTimerHandle),this._ackTimerHandle=void 0},1e3))}}class ee{constructor(e,t,r,o){this._message=e,this._id=t,this._resolver=r,this._rejector=o}}(e=v=v||{}).Disconnected="Disconnected",e.Connecting="Connecting",e.Connected="Connected",e.Disconnecting="Disconnecting",e.Reconnecting="Reconnecting";class x{static create(e,t,r,o,s,n,i){return new x(e,t,r,o,s,n,i)}constructor(e,t,r,o,s,n,i){this._nextKeepAlive=0,this._freezeEventListener=()=>{this._logger.log(w.a.Warning,"The page is being frozen, this will likely lead to the connection being closed and messages being lost. For more information see the docs at https://learn.microsoft.com/aspnet/core/signalr/javascript-client#bsleep")},C.a.isRequired(e,"connection"),C.a.isRequired(t,"logger"),C.a.isRequired(r,"protocol"),this.serverTimeoutInMilliseconds=null!=s?s:3e4,this.keepAliveIntervalInMilliseconds=null!=n?n:15e3,this._statefulReconnectBufferSize=null!=i?i:1e5,this._logger=t,this._protocol=r,this.connection=e,this._reconnectPolicy=o,this._handshakeProtocol=new K,this.connection.onreceive=e=>this._processIncomingData(e),this.connection.onclose=e=>this._connectionClosed(e),this._callbacks={},this._methods={},this._closedCallbacks=[],this._reconnectingCallbacks=[],this._reconnectedCallbacks=[],this._invocationId=0,this._receivedHandshakeResponse=!1,this._connectionState=v.Disconnected,this._connectionStarted=!1,this._cachedPingMessage=this._protocol.writeMessage({type:y.Ping})}get state(){return this._connectionState}get connectionId(){return this.connection&&this.connection.connectionId||null}get baseUrl(){return this.connection.baseUrl||""}set baseUrl(e){if(this._connectionState!==v.Disconnected&&this._connectionState!==v.Reconnecting)throw new Error("The HubConnection must be in the Disconnected or Reconnecting state to change the url.");if(!e)throw new Error("The HubConnection url must be a valid url.");this.connection.baseUrl=e}start(){return this._startPromise=this._startWithStateTransitions(),this._startPromise}async _startWithStateTransitions(){if(this._connectionState!==v.Disconnected)return Promise.reject(new Error("Cannot start a HubConnection that is not in the 'Disconnected' state."));this._connectionState=v.Connecting,this._logger.log(w.a.Debug,"Starting HubConnection.");try{await this._startInternal(),C.c.isBrowser&&window.document.addEventListener("freeze",this._freezeEventListener),this._connectionState=v.Connected,this._connectionStarted=!0,this._logger.log(w.a.Debug,"HubConnection connected successfully.")}catch(e){return this._connectionState=v.Disconnected,this._logger.log(w.a.Debug,`HubConnection failed to start successfully because of error '${e}'.`),Promise.reject(e)}}async _startInternal(){this._stopDuringStartError=void 0,this._receivedHandshakeResponse=!1;var t=new Promise((e,t)=>{this._handshakeResolver=e,this._handshakeRejecter=t});await this.connection.start(this._protocol.transferFormat);try{let e=this._protocol.version;this.connection.features.reconnect||(e=1);var r={protocol:this._protocol.name,version:e};if(this._logger.log(w.a.Debug,"Sending handshake request."),await this._sendMessage(this._handshakeProtocol.writeHandshakeRequest(r)),this._logger.log(w.a.Information,`Using HubProtocol '${this._protocol.name}'.`),this._cleanupTimeout(),this._resetTimeoutPeriod(),this._resetKeepAliveInterval(),await t,this._stopDuringStartError)throw this._stopDuringStartError;(this.connection.features.reconnect||!1)&&(this._messageBuffer=new Y(this._protocol,this.connection,this._statefulReconnectBufferSize),this.connection.features.disconnected=this._messageBuffer._disconnected.bind(this._messageBuffer),this.connection.features.resend=()=>{if(this._messageBuffer)return this._messageBuffer._resend()}),this.connection.features.inherentKeepAlive||await this._sendMessage(this._cachedPingMessage)}catch(e){throw this._logger.log(w.a.Debug,`Hub handshake failed with error '${e}' during start(). Stopping HubConnection.`),this._cleanupTimeout(),this._cleanupPingTimer(),await this.connection.stop(e),e}}async stop(){var e=this._startPromise;this.connection.features.reconnect=!1,this._stopPromise=this._stopInternal(),await this._stopPromise;try{await e}catch(e){}}_stopInternal(e){var t;return this._connectionState===v.Disconnected?(this._logger.log(w.a.Debug,`Call to HubConnection.stop(${e}) ignored because it is already in the disconnected state.`),Promise.resolve()):this._connectionState===v.Disconnecting?(this._logger.log(w.a.Debug,`Call to HttpConnection.stop(${e}) ignored because the connection is already in the disconnecting state.`),this._stopPromise):(t=this._connectionState,this._connectionState=v.Disconnecting,this._logger.log(w.a.Debug,"Stopping HubConnection."),this._reconnectDelayHandle?(this._logger.log(w.a.Debug,"Connection stopped during reconnect delay. Done reconnecting."),clearTimeout(this._reconnectDelayHandle),this._reconnectDelayHandle=void 0,this._completeClose(),Promise.resolve()):(t===v.Connected&&this._sendCloseMessage(),this._cleanupTimeout(),this._cleanupPingTimer(),this._stopDuringStartError=e||new g("The connection was stopped before the hub handshake could complete."),this.connection.stop(e)))}async _sendCloseMessage(){try{await this._sendWithProtocol(this._createCloseMessage())}catch{}}stream(e,...t){var[r,o]=this._replaceStreamingParams(t);let s=this._createStreamInvocation(e,t,o),n,i=new Z;return i.cancelCallback=()=>{let e=this._createCancelInvocation(s.invocationId);return delete this._callbacks[s.invocationId],n.then(()=>this._sendWithProtocol(e))},this._callbacks[s.invocationId]=(e,t)=>{t?i.error(t):e&&(e.type===y.Completion?e.error?i.error(new Error(e.error)):i.complete():i.next(e.item))},n=this._sendWithProtocol(s).catch(e=>{i.error(e),delete this._callbacks[s.invocationId]}),this._launchStreams(r,n),i}_sendMessage(e){return this._resetKeepAliveInterval(),this.connection.send(e)}_sendWithProtocol(e){return this._messageBuffer?this._messageBuffer._send(e):this._sendMessage(this._protocol.writeMessage(e))}send(e,...t){var[r,o]=this._replaceStreamingParams(t),e=this._sendWithProtocol(this._createInvocation(e,t,!0,o));return this._launchStreams(r,e),e}invoke(e,...t){let[s,r]=this._replaceStreamingParams(t),n=this._createInvocation(e,t,!1,r);return new Promise((r,o)=>{this._callbacks[n.invocationId]=(e,t)=>{t?o(t):e&&(e.type===y.Completion?e.error?o(new Error(e.error)):r(e.result):o(new Error("Unexpected message type: "+e.type)))};var e=this._sendWithProtocol(n).catch(e=>{o(e),delete this._callbacks[n.invocationId]});this._launchStreams(s,e)})}on(e,t){e&&t&&(e=e.toLowerCase(),this._methods[e]||(this._methods[e]=[]),-1===this._methods[e].indexOf(t))&&this._methods[e].push(t)}off(e,t){var r;e&&(e=e.toLowerCase(),r=this._methods[e])&&(!t||-1!==(t=r.indexOf(t))&&(r.splice(t,1),0===r.length))&&delete this._methods[e]}onclose(e){e&&this._closedCallbacks.push(e)}onreconnecting(e){e&&this._reconnectingCallbacks.push(e)}onreconnected(e){e&&this._reconnectedCallbacks.push(e)}_processIncomingData(e){var t;if(this._cleanupTimeout(),this._receivedHandshakeResponse||(e=this._processHandshakeResponse(e),this._receivedHandshakeResponse=!0),e)for(t of this._protocol.parseMessages(e,this._logger))if(!this._messageBuffer||this._messageBuffer._shouldProcessMessage(t))switch(t.type){case y.Invocation:this._invokeClientMethod(t).catch(e=>{this._logger.log(w.a.Error,"Invoke client method threw error: "+Object(C.g)(e))});break;case y.StreamItem:case y.Completion:var r=this._callbacks[t.invocationId];if(r){t.type===y.Completion&&delete this._callbacks[t.invocationId];try{r(t)}catch(e){this._logger.log(w.a.Error,"Stream callback threw error: "+Object(C.g)(e))}}break;case y.Ping:break;case y.Close:this._logger.log(w.a.Information,"Close message received from server.");r=t.error?new Error("Server returned an error on close: "+t.error):void 0;!0===t.allowReconnect?this.connection.stop(r):this._stopPromise=this._stopInternal(r);break;case y.Ack:this._messageBuffer&&this._messageBuffer._ack(t);break;case y.Sequence:this._messageBuffer&&this._messageBuffer._resetSequence(t);break;default:this._logger.log(w.a.Warning,`Invalid message type: ${t.type}.`)}this._resetTimeoutPeriod()}_processHandshakeResponse(t){let e,r;try{[r,e]=this._handshakeProtocol.parseHandshakeResponse(t)}catch(e){t="Error parsing handshake response: "+e,t=(this._logger.log(w.a.Error,t),new Error(t));throw this._handshakeRejecter(t),t}if(e.error)throw t="Server returned handshake error: "+e.error,this._logger.log(w.a.Error,t),t=new Error(t),this._handshakeRejecter(t),t;return this._logger.log(w.a.Debug,"Server handshake complete."),this._handshakeResolver(),r}_resetKeepAliveInterval(){this.connection.features.inherentKeepAlive||(this._nextKeepAlive=(new Date).getTime()+this.keepAliveIntervalInMilliseconds,this._cleanupPingTimer())}_resetTimeoutPeriod(){if(!(this.connection.features&&this.connection.features.inherentKeepAlive||(this._timeoutHandle=setTimeout(()=>this.serverTimeout(),this.serverTimeoutInMilliseconds),void 0!==this._pingServerHandle))){let e=this._nextKeepAlive-(new Date).getTime();e<0&&(e=0),this._pingServerHandle=setTimeout(async()=>{if(this._connectionState===v.Connected)try{await this._sendMessage(this._cachedPingMessage)}catch{this._cleanupPingTimer()}},e)}}serverTimeout(){this.connection.stop(new Error("Server timeout elapsed without receiving a message from the server."))}async _invokeClientMethod(o){var s=o.target.toLowerCase(),n=this._methods[s];if(n){var i,n=n.slice(),a=!!o.invocationId;let e,t,r;for(i of n)try{var c=e;e=await i.apply(this,o.arguments),a&&e&&c&&(this._logger.log(w.a.Error,`Multiple results provided for '${s}'. Sending error to server.`),r=this._createCompletionMessage(o.invocationId,"Client provided multiple results.",null)),t=void 0}catch(e){t=e,this._logger.log(w.a.Error,`A callback for the method '${s}' threw error '${e}'.`)}r?await this._sendWithProtocol(r):a?(r=t?this._createCompletionMessage(o.invocationId,""+t,null):void 0!==e?this._createCompletionMessage(o.invocationId,null,e):(this._logger.log(w.a.Warning,`No result given for '${s}' method and invocation ID '${o.invocationId}'.`),this._createCompletionMessage(o.invocationId,"Client didn't provide a result.",null)),await this._sendWithProtocol(r)):e&&this._logger.log(w.a.Error,`Result given for '${s}' method but server is not expecting a result.`)}else this._logger.log(w.a.Warning,`No client method with the name '${s}' found.`),o.invocationId&&(this._logger.log(w.a.Warning,`No result given for '${s}' method and invocation ID '${o.invocationId}'.`),await this._sendWithProtocol(this._createCompletionMessage(o.invocationId,"Client didn't provide a result.",null)))}_connectionClosed(e){this._logger.log(w.a.Debug,`HubConnection.connectionClosed(${e}) called while in state ${this._connectionState}.`),this._stopDuringStartError=this._stopDuringStartError||e||new g("The underlying connection was closed before the hub handshake could complete."),this._handshakeResolver&&this._handshakeResolver(),this._cancelCallbacksWithError(e||new Error("Invocation canceled due to the underlying connection being closed.")),this._cleanupTimeout(),this._cleanupPingTimer(),this._connectionState===v.Disconnecting?this._completeClose(e):this._connectionState===v.Connected&&this._reconnectPolicy?this._reconnect(e):this._connectionState===v.Connected&&this._completeClose(e)}_completeClose(t){if(this._connectionStarted){this._connectionState=v.Disconnected,this._connectionStarted=!1,this._messageBuffer&&(this._messageBuffer._dispose(null!=t?t:new Error("Connection closed.")),this._messageBuffer=void 0),C.c.isBrowser&&window.document.removeEventListener("freeze",this._freezeEventListener);try{this._closedCallbacks.forEach(e=>e.apply(this,[t]))}catch(e){this._logger.log(w.a.Error,`An onclose callback called with error '${t}' threw error '${e}'.`)}}}async _reconnect(t){var r=Date.now();let o=0;var s=void 0!==t?t:new Error("Attempting to reconnect due to a unknown error.");let n=this._getNextRetryDelay(o++,0,s);if(null===n)this._logger.log(w.a.Debug,"Connection not reconnecting because the IRetryPolicy returned null on the first reconnect attempt."),this._completeClose(t);else{if(this._connectionState=v.Reconnecting,t?this._logger.log(w.a.Information,`Connection reconnecting because of error '${t}'.`):this._logger.log(w.a.Information,"Connection reconnecting."),0!==this._reconnectingCallbacks.length){try{this._reconnectingCallbacks.forEach(e=>e.apply(this,[t]))}catch(e){this._logger.log(w.a.Error,`An onreconnecting callback called with error '${t}' threw error '${e}'.`)}if(this._connectionState!==v.Reconnecting)return void this._logger.log(w.a.Debug,"Connection left the reconnecting state in onreconnecting callback. Done reconnecting.")}for(;null!==n;){if(this._logger.log(w.a.Information,`Reconnect attempt number ${o} will start in ${n} ms.`),await new Promise(e=>{this._reconnectDelayHandle=setTimeout(e,n)}),this._reconnectDelayHandle=void 0,this._connectionState!==v.Reconnecting)return void this._logger.log(w.a.Debug,"Connection left the reconnecting state during reconnect delay. Done reconnecting.");try{if(await this._startInternal(),this._connectionState=v.Connected,this._logger.log(w.a.Information,"HubConnection reconnected successfully."),0!==this._reconnectedCallbacks.length)try{this._reconnectedCallbacks.forEach(e=>e.apply(this,[this.connection.connectionId]))}catch(e){this._logger.log(w.a.Error,`An onreconnected callback called with connectionId '${this.connection.connectionId}; threw error '${e}'.`)}return}catch(e){if(this._logger.log(w.a.Information,`Reconnect attempt failed because of error '${e}'.`),this._connectionState!==v.Reconnecting)return this._logger.log(w.a.Debug,`Connection moved to the '${this._connectionState}' from the reconnecting state during reconnect attempt. Done reconnecting.`),void(this._connectionState===v.Disconnecting&&this._completeClose());s=e instanceof Error?e:new Error(e.toString()),n=this._getNextRetryDelay(o++,Date.now()-r,s)}}this._logger.log(w.a.Information,`Reconnect retries have been exhausted after ${Date.now()-r} ms and ${o} failed attempts. Connection disconnecting.`),this._completeClose()}}_getNextRetryDelay(t,r,e){try{return this._reconnectPolicy.nextRetryDelayInMilliseconds({elapsedMilliseconds:r,previousRetryCount:t,retryReason:e})}catch(e){return this._logger.log(w.a.Error,`IRetryPolicy.nextRetryDelayInMilliseconds(${t}, ${r}) threw error '${e}'.`),null}}_cancelCallbacksWithError(t){let r=this._callbacks;this._callbacks={},Object.keys(r).forEach(e=>{e=r[e];try{e(null,t)}catch(e){this._logger.log(w.a.Error,`Stream 'error' callback called with '${t}' threw error: `+Object(C.g)(e))}})}_cleanupPingTimer(){this._pingServerHandle&&(clearTimeout(this._pingServerHandle),this._pingServerHandle=void 0)}_cleanupTimeout(){this._timeoutHandle&&clearTimeout(this._timeoutHandle)}_createInvocation(e,t,r,o){return r?0!==o.length?{arguments:t,streamIds:o,target:e,type:y.Invocation}:{arguments:t,target:e,type:y.Invocation}:(r=this._invocationId,this._invocationId++,0!==o.length?{arguments:t,invocationId:r.toString(),streamIds:o,target:e,type:y.Invocation}:{arguments:t,invocationId:r.toString(),target:e,type:y.Invocation})}_launchStreams(e,o){if(0!==e.length){o=o||Promise.resolve();for(let r in e)e[r].subscribe({complete:()=>{o=o.then(()=>this._sendWithProtocol(this._createCompletionMessage(r)))},error:e=>{let t;t=e instanceof Error?e.message:e&&e.toString?e.toString():"Unknown error",o=o.then(()=>this._sendWithProtocol(this._createCompletionMessage(r,t)))},next:e=>{o=o.then(()=>this._sendWithProtocol(this._createStreamItemMessage(r,e)))}})}}_replaceStreamingParams(t){var r=[],o=[];for(let e=0;e<t.length;e++){var s,n=t[e];this._isObservable(n)&&(s=this._invocationId,this._invocationId++,r[s]=n,o.push(s.toString()),t.splice(e,1))}return[r,o]}_isObservable(e){return e&&e.subscribe&&"function"==typeof e.subscribe}_createStreamInvocation(e,t,r){var o=this._invocationId;return this._invocationId++,0!==r.length?{arguments:t,invocationId:o.toString(),streamIds:r,target:e,type:y.StreamInvocation}:{arguments:t,invocationId:o.toString(),target:e,type:y.StreamInvocation}}_createCancelInvocation(e){return{invocationId:e,type:y.CancelInvocation}}_createStreamItemMessage(e,t){return{invocationId:e,item:t,type:y.StreamItem}}_createCompletionMessage(e,t,r){return t?{error:t,invocationId:e,type:y.Completion}:{invocationId:e,result:r,type:y.Completion}}_createCloseMessage(){return{type:y.Close}}}var E=t(2);class te{constructor(){this.name="json",this.version=2,this.transferFormat=_.Text}parseMessages(e,t){if("string"!=typeof e)throw new Error("Invalid input for JSON hub protocol. Expected a string.");if(!e)return[];null===t&&(t=E.a.instance);var r,o=[];for(r of R.parse(e)){var s=JSON.parse(r);if("number"!=typeof s.type)throw new Error("Invalid payload.");switch(s.type){case y.Invocation:this._isInvocationMessage(s);break;case y.StreamItem:this._isStreamItemMessage(s);break;case y.Completion:this._isCompletionMessage(s);break;case y.Ping:case y.Close:break;case y.Ack:this._isAckMessage(s);break;case y.Sequence:this._isSequenceMessage(s);break;default:t.log(w.a.Information,"Unknown message type '"+s.type+"' ignored.");continue}o.push(s)}return o}writeMessage(e){return R.write(JSON.stringify(e))}_isInvocationMessage(e){this._assertNotEmptyString(e.target,"Invalid payload for Invocation message."),void 0!==e.invocationId&&this._assertNotEmptyString(e.invocationId,"Invalid payload for Invocation message.")}_isStreamItemMessage(e){if(this._assertNotEmptyString(e.invocationId,"Invalid payload for StreamItem message."),void 0===e.item)throw new Error("Invalid payload for StreamItem message.")}_isCompletionMessage(e){if(e.result&&e.error)throw new Error("Invalid payload for Completion message.");!e.result&&e.error&&this._assertNotEmptyString(e.error,"Invalid payload for Completion message."),this._assertNotEmptyString(e.invocationId,"Invalid payload for Completion message.")}_isAckMessage(e){if("number"!=typeof e.sequenceId)throw new Error("Invalid SequenceId for Ack message.")}_isSequenceMessage(e){if("number"!=typeof e.sequenceId)throw new Error("Invalid SequenceId for Sequence message.")}_assertNotEmptyString(e,t){if("string"!=typeof e||""===e)throw new Error(t)}}let re={trace:w.a.Trace,debug:w.a.Debug,info:w.a.Information,information:w.a.Information,warn:w.a.Warning,warning:w.a.Warning,error:w.a.Error,critical:w.a.Critical,none:w.a.None};class oe{configureLogging(e){var t;return C.a.isRequired(e,"logging"),void 0!==e.log?this.logger=e:"string"==typeof e?(t=function(e){var t=re[e.toLowerCase()];if(void 0!==t)return t;throw new Error("Unknown log level: "+e)}(e),this.logger=new C.b(t)):this.logger=new C.b(e),this}withUrl(e,t){return C.a.isRequired(e,"url"),C.a.isNotEmpty(e,"url"),this.url=e,this.httpConnectionOptions="object"==typeof t?{...this.httpConnectionOptions,...t}:{...this.httpConnectionOptions,transport:t},this}withHubProtocol(e){return C.a.isRequired(e,"protocol"),this.protocol=e,this}withAutomaticReconnect(e){if(this.reconnectPolicy)throw new Error("A reconnectPolicy has already been set.");return e?Array.isArray(e)?this.reconnectPolicy=new c(e):this.reconnectPolicy=e:this.reconnectPolicy=new c,this}withServerTimeout(e){return C.a.isRequired(e,"milliseconds"),this._serverTimeoutInMilliseconds=e,this}withKeepAliveInterval(e){return C.a.isRequired(e,"milliseconds"),this._keepAliveIntervalInMilliseconds=e,this}withStatefulReconnect(e){return void 0===this.httpConnectionOptions&&(this.httpConnectionOptions={}),this.httpConnectionOptions._useStatefulReconnect=!0,this._statefulReconnectBufferSize=null==e?void 0:e.bufferSize,this}build(){var e=this.httpConnectionOptions||{};if(void 0===e.logger&&(e.logger=this.logger),this.url)return e=new X(this.url,e),x.create(e,this.logger||E.a.instance,this.protocol||new te,this.reconnectPolicy,this._serverTimeoutInMilliseconds,this._keepAliveIntervalInMilliseconds,this._statefulReconnectBufferSize);throw new Error("The 'HubConnectionBuilder.withUrl' method must be called before building the connection.")}}class D{constructor(e){if(this.connection=null,this.baseUrl=e,D.instance)throw new Error("SignalRService class can only have one instance!");(D.instance=this).connectState=this.connect()}async connect(){let e="/ndslite/QueryData";this.baseUrl&&(e=this.baseUrl+e),this.connection=(new oe).withUrl(e,{accessTokenFactory:()=>""+a.get("token")}).withAutomaticReconnect().build();try{return this.connection.start().then(()=>{console.log("Connected to SignalR hub")})}catch(e){console.error("signalr connect error",e)}}onDisconnect(){if(this.connection){try{this.connection.stop().then(()=>{console.log("Disconnected from SignalR hub")})}catch(e){console.error("stop signalr error",e)}this.connection=null}}onReconnected(e){this.connection&&this.connection.onreconnected(e),console.log("add reconnected callback")}onReconnecting(e){this.connection&&this.connection.onreconnecting(e),console.log("add reconnecting callback")}onClosed(e){this.connection&&this.connection.onclose(e),console.log("add closed callback")}async sendRequest(t,e){if(await this.connectState,this.connection)try{this.connection.invoke(t,e)}catch(e){console.error("invoke method"+t+" error",e)}else console.log("signalr not connected")}addRequestCallback(t,e){if(this.connection)try{this.connection.on(t,e)}catch(e){console.error("on method"+t+" error",e)}else console.log("signalr not connected2")}removeRequestCallback(t,e){if(this.connection)try{this.connection.off(t,e)}catch(e){console.error("off method"+t+" error",e)}else console.log("signalr not connected2")}}function T(e=""){if(null!==D.instance||""!==e)return D.instance||new D(e),D.instance;console.error("The Fist Call this function, baseUrl is not empty!")}class P{constructor(e,t){if(this.baseUrl=e,this.signalrHubUrl=t,P.instance)throw new Error("QueryDataApi class can only have one instance!");(P.instance=this).callbackMap=new Map,this.callbackSet=new Set}getToken(e){return n(this.baseUrl).service({url:"/nds_lite/Common/GetToken",method:"post",data:{ApiKeyData:e}})}axiosServiceQuery(e,t){return n(this.baseUrl).service({url:"/nds_lite/QueryData/"+e,method:"post",data:t})}signalRServiceQuery(e,t,r){var o=t.itemCode,s=t.bufchunksIDs;let n;return n=s?e+`-${o}-`+s:e+"-"+o,this.callbackMap.set(n,r),this.callbackSet.has(e)||(this.callbackSet.add(e),T(this.signalrHubUrl).addRequestCallback(e,e=>{let t;var r,o,s;t=Array.isArray(e.data)&&0<e.data.length?(s=e.data[0].itemCode,o=e.data[0].queryName,r=e.data[0].itemID,"GetItemBvh"!==o?o+`-${s}-`+r:o+"-"+s):(r=e.data.itemCode,o=e.data.queryName,s=e.data.itemID,"GetItemBvh"!==o?o+`-${r}-`+s:o+"-"+r),this.callbackMap.has(t)&&(this.callbackMap.get(t)(e),this.callbackMap.delete(t))})),T(this.signalrHubUrl).sendRequest(e,t)}}function N(e,t){if(null!==P.instance&&void 0!==P.instance||""!==e&&""!==t)return P.instance||new P(e,t),P.instance;console.log("The Fist Call this function, baseUrl or signalrHubUrl is not empty!")}class q extends NDSWebViewer.NdsBrepManager{constructor(e,t,r){super(e,t,r),this._loadedTags=new Map,this.brepFaceQuery=new Map,this.brepEdgeQuery=new Map,this.brepVertexQuery=new Map,this.type=2,this.version=5,this.bodyIDToItemID=new Map,this.bodyIDToItemCode=new Map,this.uuidToRefUuid=new Map,this._brepFileUrls=[],this._modelIds=[],this.queryDataApi=N(t.baseUrl,t.signalrHubUrl),""!==t.baseUrl&&""!==t.signalrHubUrl&&this.queryDataApi.getToken(t.apiKeyData).then(e=>{a.set("token",e.data.token)})}addRequest(){if(this.modelRequestor)for(let e=0;e<this._brepFileUrls.length;e++)this._loadedTags.get(this._brepFileUrls[e])||(this.modelRequestor.addRequest(this._brepFileUrls[e],1e5,"loadBrepData",{modelId:this._modelIds[e]}),this._loadedTags.set(this._brepFileUrls[e],!0))}addBrepFileUrl(e,t){this._brepFileUrls.push(e),this._loadedTags.set(e,!1),this._modelIds.push(t)}onLoad(t,r){let o=0,s=0;for(let e=0;e<r.length;++e)this.brepInfos.breps.push({volume:r[e].volume,area:r[e].area}),this.brepInfos.bodies.set(r[e].uuid,this.brepInfos.breps.length-1),this.bodyIDToItemID.has(r[e].uuid)||this.bodyIDToItemID.set(r[e].uuid,r[e].itemID),void 0===r[e].refUuid||null===r[e].refUuid||this.uuidToRefUuid.has(r[e].uuid)||this.uuidToRefUuid.set(r[e].uuid,r[e].refUuid),this.bodyIDToItemCode.has(r[e].uuid)||this.bodyIDToItemCode.set(r[e].uuid,t),void 0!==r[e].refUuid&&null!==r[e].refUuid||(o+=r[e].area,s+=r[e].volume);this.viewer.brepInfo.BfaceArea=0<o,this.viewer.brepInfo.BbodyVolume=0<s,this.viewer.brepInfo.BbodyArea=0<s&&o,this.viewer.brepInfo.BtotalArea=o,this.viewer.brepInfo.BfacePerimeter=!!(o&&1<this.version),0<r.length&&(this._hasBrepInfo=!0),this.viewer.dispatchBrepEvent(),NDSWebViewer.SETTING.enableBroadcast&&this.viewer.broadcastManager.broadcastInfo&&this.viewer.broadcastManager.setBroadcastInfo(this.viewer.broadcastManager.broadcastInfo),!0===this.showWaitCursor&&this.viewer.exitWaitProcedure()}onError(e){this.viewer.exitWaitProcedure()}loadBreps(e,t){this.addRequest(),!0===e&&(this.showWaitCursor=!0,this.viewer.startWaitProcedure())}async queryBrepEdgeData(p){if(!this.brepEdgeQuery.has(p)){let e=null;this.uuidToRefUuid.has(p)&&(e=this.uuidToRefUuid.get(p));var t=this.bodyIDToItemID.get(null!==e?e:p),r=this.bodyIDToItemCode.get(p);await this.queryDataApi.axiosServiceQuery("GetItemBrepEdge",{itemCode:r,bodyID:t}).then(i=>{if(1===i.status.code)try{this.brepEdgeQuery.set(p,!0);let t=!1;var a={ids:[],indexRanges:[],lengthes:[],persist:[]};let r=!1;var c={ids:[],indexRanges:[],lengthes:[],persist:[],normals:[],radiuses:[],centers:[]};let o=!1;var l={ids:[],indexRanges:[],lengthes:[],persist:[],normals:[],centers:[],axisX:[],radiusX:[],radiusY:[]};let s=!1;var h={ids:[],indexRanges:[],lengthes:[],persist:[]};let n=!1;var d={ids:[],indexRanges:[],lengthes:[],persist:[]},u={};for(let e=0;e<i.data.length;++e)switch(u.geomUUID=i.data[e].refGeomUuid,i.data[e].type){case 0:t=!0,a.ids.push(i.data[e].id),a.indexRanges=a.indexRanges.concat(JSON.parse(i.data[e].linesegIndexRange)),a.lengthes.push(i.data[e].length),a.persist.push(i.data[e].persistentId);break;case 1:r=!0,c.ids.push(i.data[e].id),c.indexRanges=c.indexRanges.concat(JSON.parse(i.data[e].linesegIndexRange)),c.lengthes.push(i.data[e].length),c.radiuses.push(i.data[e].radius),c.normals=c.normals.concat(JSON.parse(i.data[e].normal)),c.persist.push(i.data[e].persistentId),c.centers=c.centers.concat(JSON.parse(i.data[e].center));break;case 2:o=!0,l.ids.push(i.data[e].id),l.indexRanges=l.indexRanges.concat(JSON.parse(i.data[e].linesegIndexRange)),l.lengthes.push(i.data[e].length),l.normals=l.normals.concat(JSON.parse(i.data[e].normal)),l.centers=l.centers.concat(JSON.parse(i.data[e].center)),l.axisX.c=l.axisX.concat(JSON.parse(i.data[e].axisX)),l.radiusX.push(i.data[e].radiusX),l.radiusY.push(i.data[e].radiusY),l.persist.push(i.data[e].persistentId);break;case 3:s=!0,h.ids.push(i.data[e].id),h.indexRanges=h.indexRanges.concat(JSON.parse(i.data[e].linesegIndexRange)),h.lengthes.push(i.data[e].length),h.persist.push(i.data[e].persistentId);break;case 4:n=!0,d.ids.push(i.data[e].id),d.indexRanges=d.indexRanges.concat(JSON.parse(i.data[e].linesegIndexRange)),d.lengthes.push(i.data[e].length),d.persist.push(i.data[e].persistentId)}t&&(u.lines=a),r&&(u.circles=c),o&&(u.ellipses=l),s&&(u.nurbses=h),n&&(u.others=d),this.brepInfos.edgeGroups.push(u);var e=this.brepInfos.bodies.get(p);void 0===this.brepInfos.breps[e].edgeGroups&&(this.brepInfos.breps[e].edgeGroups=[]),this.brepInfos.breps[e].edgeGroups.push(this.brepInfos.edgeGroups.length-1)}catch(e){this.brepEdgeQuery.set(p,!1),console.log(e)}else this.brepEdgeQuery.set(p,!1)})}}async queryBrepFaceData(C){if(!this.brepFaceQuery.has(C)){let e=null;this.uuidToRefUuid.has(C)&&(e=this.uuidToRefUuid.get(C));var t=this.bodyIDToItemID.get(null!==e?e:C),r=this.bodyIDToItemCode.get(C);await this.queryDataApi.axiosServiceQuery("GetItemBrepFace",{itemCode:r,bodyID:t}).then(l=>{if(1===l.status.code)try{this.brepFaceQuery.set(C,!0);var h=[],d=[];let t=!1;var u={areas:[],ids:[],loops:[],normals:[],origins:[],persist:[],triIndexRanges:[]};let r=!1;var p={areas:[],axis:[],axisX:[],heights:[],ids:[],loops:[],origins:[],persist:[],radiuses:[],triIndexRanges:[]};let o=!1;var g={areas:[],axis:[],axisX:[],halfAngles:[],ids:[],loops:[],origins:[],persist:[],radiuses:[],triIndexRanges:[]};let s=!1;var f={areas:[],axisZ:[],axisX:[],ids:[],loops:[],origins:[],persist:[],radiuses:[],triIndexRanges:[]};let n=!1;var m={areas:[],normals:[],axisX:[],ids:[],loops:[],origins:[],persist:[],centerLineRadius:[],sectionRadius:[],triIndexRanges:[]};let i=!1;var _={areas:[],ids:[],loops:[],persist:[],triIndexRanges:[]};let a=!1;var y={areas:[],ids:[],loops:[],persist:[],triIndexRanges:[]},v={};let c=0;for(let e=0;e<l.data.length;++e){v.geomUUID=l.data[e].refGeomUuid;var b=JSON.parse(l.data[e].loops);for(let e=0;e<b.length;++e)h.push(b[e].perimeter),d.push(b[e].startEdgeId);var w=b.length;switch(l.data[e].type){case 0:t=!0,u.ids.push(l.data[e].id),u.triIndexRanges=u.triIndexRanges.concat(JSON.parse(l.data[e].indexRange)),u.areas.push(l.data[e].area),u.origins=u.origins.concat(JSON.parse(l.data[e].planeOrigin)),u.normals=u.normals.concat(JSON.parse(l.data[e].planeNormal)),u.loops.push(c),u.loops.push(w),u.persist.push(l.data[e].persistentId);break;case 1:r=!0,p.ids.push(l.data[e].id),p.triIndexRanges=p.triIndexRanges.concat(JSON.parse(l.data[e].indexRange)),p.areas.push(l.data[e].area),p.axis=p.axis.concat(JSON.parse(l.data[e].normal)),p.origins=p.origins.concat(JSON.parse(l.data[e].origin)),p.axisX=p.axisX.concat(JSON.parse(l.data[e].axisX)),p.radiuses.push(l.data[e].radius),p.heights.push(l.data[e].height),p.persist.push(l.data[e].persistentId),p.loops.push(c),p.loops.push(w);break;case 2:o=!0,g.ids.push(l.data[e].id),g.triIndexRanges=g.triIndexRanges.concat(JSON.parse(l.data[e].indexRange)),g.areas.push(l.data[e].area),g.axis=g.axis.concat(JSON.parse(l.data[e].normal)),g.origins=g.origins.concat(JSON.parse(l.data[e].origin)),g.axisX=g.axisX.concat(JSON.parse(l.data[e].axisX)),g.radiuses.push(l.data[e].radius),g.halfAngles.push(l.data[e].halfAngles),g.persist.push(l.data[e].persistentId),g.loops.push(c),g.loops.push(w);break;case 3:s=!0,f.ids.push(l.data[e].id),f.triIndexRanges=f.triIndexRanges.concat(JSON.parse(l.data[e].indexRange)),f.areas.push(l.data[e].area),f.axisZ=f.axisZ.concat(JSON.parse(l.data[e].axisZ)),f.origins=f.origins.concat(JSON.parse(l.data[e].origin)),f.axisX=f.axisX.concat(JSON.parse(l.data[e].axisX)),f.radiuses.push(l.data[e].radius),f.persist.push(l.data[e].persistentId),f.loops.push(c),f.loops.push(w);break;case 4:n=!0,m.ids.push(l.data[e].id),m.triIndexRanges=m.triIndexRanges.concat(JSON.parse(l.data[e].indexRange)),m.areas.push(l.data[e].area),m.centerLineRadius=m.centerLineRadius.concat(JSON.parse(l.data[e].centerLineRadius)),m.origins=m.origins.concat(JSON.parse(l.data[e].origin)),m.axisX=m.axisX.concat(JSON.parse(l.data[e].axisX)),m.sectionRadius.push(l.data[e].sectionRadius),m.normals.push(l.data[e].normal),m.persist.push(l.data[e].persistentId),m.loops.push(c),m.loops.push(w);break;case 5:i=!0,_.ids.push(l.data[e].id),_.triIndexRanges=_.triIndexRanges.concat(JSON.parse(l.data[e].indexRange)),_.areas.push(l.data[e].area),_.persist.push(l.data[e].persistentId),_.loops.push(c),_.loops.push(w);break;case 6:a=!0,y.ids.push(l.data[e].id),y.triIndexRanges=y.triIndexRanges.concat(JSON.parse(l.data[e].indexRange)),y.areas.push(l.data[e].area),y.persist.push(l.data[e].persistentId),y.loops.push(c),y.loops.push(w)}c=h.length}t&&(v.planes=u),r&&(v.cylinders=p),o&&(v.cones=g),s&&(v.spheres=f),n&&(v.toruses=m),i&&(v.nurbses=_),a&&(v.others=y),v.loopPerimeters=h,v.loopStartEdgeId=d,this.brepInfos.faceGroups.push(v);var e=this.brepInfos.bodies.get(C);void 0===this.brepInfos.breps[e].faceGroups&&(this.brepInfos.breps[e].faceGroups=[]),this.brepInfos.breps[e].faceGroups.push(this.brepInfos.faceGroups.length-1)}catch(e){this.brepFaceQuery.set(C,!1),console.log(e)}else this.brepFaceQuery.set(C,!1)})}}async queryBrepVertexData(o){if(!this.brepVertexQuery.has(o)){let e=null;this.uuidToRefUuid.has(o)&&(e=this.uuidToRefUuid.get(o));var t=this.bodyIDToItemID.get(null!==e?e:o),r=this.bodyIDToItemCode.get(o);await this.queryDataApi.axiosServiceQuery("GetItemBrepVertex",{itemCode:r,bodyID:t}).then(t=>{if(1===t.status.code)try{this.brepVertexQuery.set(o,!0);var r={};for(let e=0;e<t.data.length;++e)r.ids.push(t.data[e].id),r.coords=r.coords.concat(JSON.parse(t.data[e].coords));this.brepInfos.vertices.push(r);var e=this.brepInfos.bodies.get(o);void 0===this.brepInfos.breps[e].vertices&&(this.brepInfos.breps[e].vertices=[]),this.brepInfos.breps[e].vertices.push(this.brepInfos.vertices.length-1)}catch(e){this.brepVertexQuery.set(o,!1),console.log(e)}else this.brepVertexQuery.set(o,!1)})}}async GetBrepInfo(e,t){return await Promise.all([this.queryBrepEdgeData(e),this.queryBrepFaceData(e)]),this.brepInfos}GetBodyVolumeAndAreaV2(e){var t=super.GetBodyVolumeAndAreaV2(e);if(null!==t)return t;this.queryDataApi.axiosServiceQuery("GetItemBrep",{itemCode:this.itemCode,bodyID:e}).then(e=>{if(1!==e.status.code)return console.log("GetItemBrep Status Code error!"),null;try{return{volume:e.data[i].volume,area:e.data[i].area}}catch(e){console.log(e)}})}GetEdegMeshIDfromIDV2(e,t){let r=this;if(this.brepEdgeQuery.has(e))return super.GetEdegMeshIDfromIDV2(e,t);this.queryBrepEdgeData(e).then(()=>r.GetEdegMeshIDfromIDV2(e,t))}GetBrepInfoByBodyUuidAndTopoIdV2(e,t,r){let o=this;if(this.brepFaceQuery.has(e))return super.GetBrepInfoByBodyUuidAndTopoIdV2(e,t,r);this.queryBrepFaceData(e).then(()=>o.GetBrepInfoByBodyUuidAndTopoIdV2(e,t,r))}GetEdgesExtremePointsByBodyUUIDV2(e,t){let r=this;if(this.brepEdgeQuery.has(e))return super.GetEdgesExtremePointsByBodyUUIDV2(e,t);this.queryBrepEdgeData(e).then(()=>r.GetEdgesExtremePointsByBodyUUIDV2(e,t))}GetCircleCenterFromLeafBodyNode(e){let t=this;if(this.brepEdgeQuery.has(bdUUID))return super.GetCircleCenterFromLeafBodyNode(e);this.queryBrepEdgeData(bdUUID).then(()=>t.GetCircleCenterFromLeafBodyNode(e))}GetVerticesByBodyUUIDV2(e){let t=this;if(this.brepVertexQuery.has(e))return super.GetVerticesByBodyUUIDV1(e);this.queryBrepVertexData(e).then(()=>t.GetVerticesByBodyUUIDV1(e))}GetEdgeInfoFromFaceV2(e,t){let r=this;if(this.brepEdgeQuery.has(e)&&this.brepFaceQuery.has(e))return super.GetEdgeInfoFromFaceV2(e,t);this.queryBrepEdgeData(e).then(()=>{r.queryBrepFaceData(e)}).then(()=>r.GetEdgeInfoFromFaceV2(e,t))}GetFaceByUUidAndFaceIndexV2(e,t,r){let o=this;if(this.brepFaceQuery.has(e))return super.GetFaceByUUidAndFaceIndexV2(e,t,r);this.queryBrepFaceData(e).then(()=>o.GetFaceByUUidAndFaceIndexV2(e,t,r))}GetEdgeByUUidAndEdgeIndexV2(e,t,r){let o=this;if(this.brepEdgeQuery.has(e))return super.GetEdgeByUUidAndEdgeIndexV2(e,t,r);this.queryBrepEdgeData(e).then(()=>o.GetEdgeByUUidAndEdgeIndexV2(e,t,r))}hasBrepFile(){return!0}}class U extends NDSWebViewer.PropertyManager{constructor(e){super(e),this.queryDataApi=N(e.modelRequestor.baseUrl,e.modelRequestor.signalrHubUrl),this.queryDataApi.getToken(e.modelRequestor.apiKeyData).then(e=>{a.set("token",e.data.token)})}getObjectUuiD(e){let t=e.uuid;return e=this.viewer.getObjectByUUID(t),t=e.refModelUri&&this.referenceMap&&this.referenceMap.has(t)?this.referenceMap.get(t):t}handleCacheProperties(s,t,r){try{var e;null!=this.cachedProperties&&(Object.entries(this.cachedProperties).forEach(([t,r])=>{for(let e=0;e<r.PropertyCategories.length;e++){var o;t===s&&(o=r.PropertyCategories[e],r.PropertyCategories[e]=this.DeepCopy(o))}}),null!=r)&&(null!=this.cachedProperties[s]?r(this.cachedProperties[s],t):(e=s.split("_"),null!=this.cachedProperties[e[0]]?r(socpe.cachedProperties[e[0]],t):r(null,t)))}catch(e){null!=r&&r(null,t)}}getObjectPropertyFromCacheProperties(e,t,r){var o=this.getObjectUuiD(e);if(void 0!==this.cachedProperties&&this.cachedPropertyFileName==e.propertyfile){if(null!=this.cachedProperties[o]&&null!=t)return t(this.cachedProperties[o],r),!0}else this.cachedPropertyFileName=e.propertyfile}getObjectProperty(s,n,i){if(!this.getObjectPropertyFromCacheProperties(s,n,i)){let e=s.propertyfile,o=this;if(!NDSWebViewer.SETTING.singleHTML&&void 0!==e){let t=this.getObjectUuiD(s),r=function(){o.queryDataApi.axiosServiceQuery("GetStructureProperty",{itemCode:e,uuid:t}).then(e=>{if(1===e.status.code)try{e.data.PropertyCategories=JSON.parse(e.data.propertyCategories),void 0===o.cachedProperties||null===o.cachedProperties?o.cachedProperties={[t]:e.data}:o.cachedProperties[t]=e.data,o.handleCacheProperties(t,i,n)}catch(e){null!=n&&n(null,i),console.log(e)}else null!=n&&n(null,i),console.log("GetStructureProperty Status Code error!")})};void 0===a.get("token")?this.queryDataApi.getToken(this.viewer.modelRequestor.apiKeyData).then(e=>{a.set("token",e.data.token),r()}):r()}}}}class se extends NDSWebViewer.ModelRequestor{constructor(e){super(e),this.viewer=e,this.requests=[],this.name="NdsWebModelRequestor",this.refModelContext,this.nodes=new Map,this.modelInfos=new Map,this.requestWorkers=[],this.waitingGeomChunks=[],this.loadingGeomChunks=new Map,this.loadingPmiGeomChunks=new Map,this.loadedGeomChunks=[],this.loadedPmiGeomChunks=[],this.loadedGeomChunkMap=new Map,this.maxWorkerCount=NDSWebViewer.COMMON.isMobileDevice()&&(NDSWebViewer.COMMON.isIOSDevice()||NDSWebViewer.COMMON.isIpadDevice())?6:7,this.url2worker=new Map,this.modelInfo2worker=new Map,this.pauseRequest=new Set,this.propertys=new Map,this.currentNdsModel=null,this.chunkRequestsTextNum=-1,this.loadingModel=0,this.modelSourceFile=new Map,this.baseUrl="",this.signalrHubUrl="",this.uuid="",this.configName="",this.workUrl="./coreviewer/NDSWebRequestWorker.min.js",this.apiKeyData=""}extractUrlBase(e){e=e.split("/");return 1===e.length?"./":(e.pop(),e.join("/")+"/")}createRefContext(e,t){return t&&t.needs&&0<t.needs.length&&t.ignores&&(t.ignores=null),{modelId:e,hasRefModel:!1,filter:{needs:t&&t.needs&&0<t.needs.length?new Set(t.needs):null,ignores:t&&t.ignores&&0<t.ignores.length?new Set(t.ignores):null},bodyNode_sptIndexNode:new WeakMap,modelCaches:new Map,uniqueMaterialMap:new Map,uuidMaterialMap:new Map,uniquePMIMaterialMap:new Map,uuidPMIMaterialMap:new Map,allModelLoaded:!1}}clearRefContext(){this.refModelContext.bodyNode_sptIndexNode=new WeakMap,this.refModelContext.filter={needs:null,ignores:null},this.refModelContext.modelCaches.forEach((e,t,r)=>{e.node.jsonMain.bvhData=null,e.node.jsonMain.modelContent=null,e.node.jsonMain.productData=null,e.node.jsonMain.pmiContent=null,e.node.jsonMain=null,e.node=null}),this.refModelContext.modelCaches=new Map,this.refModelContext.uniqueMaterialMap=new Map,this.refModelContext.uuidMaterialMap=new Map,this.refModelContext.uniquePMIMaterialMap=new Map,this.refModelContext.uuidPMIMaterialMap=new Map}loadModel(e){this.modelInfos.has(e)?this.viewer.__addModel(this.modelInfos.get(e)):this.addRequest(e,999999,"loadModelInfo")}getWorker(e=10,t){let r=null;return 0<this.requestWorkers.length&&(this.requestWorkers.sort((e,t)=>e.workingRequestCount-t.workingRequestCount),0===this.requestWorkers[0].workingRequestCount)?r=this.requestWorkers[0]:(this.requestWorkers.length<this.maxWorkerCount?(r=this.createWorker(this.workUrl),this.requestWorkers.push(r)):this.requestWorkers[0].workingRequestCount<e&&(r=this.requestWorkers[0]),r)}releaseWorker(e=0,t=!1){let r=!0;for(let e=0;e<this.requestWorkers.length;++e)if(0<this.requestWorkers[e].workingRequestCount){r=!1;break}if(r||t){for(let e=0;e<this.requestWorkers.length;++e)this.requestWorkers[e].terminate();this.requestWorkers=[],this.modelInfo2worker.clear(),this.url2worker.clear()}}afterModelLoaded(e){this.refModelContext.allModelLoaded=!0,this.clearRefContext(),e.isSketchModel||this.viewer.dispatchModelEvent({type:"BVHInfoEvent",hasbvh:!1})}handleModelRequest(){for(;this.requests.length&&!(NDSWebViewer.SETTING.singleHTML&&this.pauseRequest&&this.pauseRequest.has(this.requests[0].params.modelId));){let e=null;if(!(e="loadModelData"===this.requests[0].operate?this.modelInfo2worker.has(this.requests[0].uri)?this.modelInfo2worker.get(this.requests[0].uri):this.url2worker.has(this.requests[0].uri)?this.url2worker.get(this.requests[0].uri):this.requests[0].params.isProxy?1:this.getWorker(5,this.requests[0].params.modelId):this.getWorker(5,this.requests[0].params.modelId)))break;var t=this.requests.shift();if("loadModelData"===t.operate){if(this.lastModelId!==t.params.modelId&&(this.lastModelId=t.params.modelId,this.refModelContext=this.createRefContext(this.lastModelId)),this.currentNdsModel=null,t.params.isProxy){this.currentNdsModel=this.viewer.ndsModel.getModelById(t.params.modelId);for(let e=0;e<t.params.urls.length;++e){var r=t.params.urls[e];this.refModelContext.modelCaches.has(r)||this.refModelContext.modelCaches.set(r,{state:"waiting",numRef:0,numRefParsedMap:new Map,numRequest:0}),this.requests.push({weight:1e4,uri:r,operate:"loadModelData",params:{modelId:t.params.modelId,useRefItemCode:!0}})}continue}if(this.refModelContext.modelCaches.has(t.uri)){var o=this.refModelContext.modelCaches.get(t.uri);if(0<o.numRequest){o.numRequest++;continue}o.numRequest++,o.state="requesting"}else this.refModelContext.modelCaches.set(t.uri,{state:"requesting",numRef:0,numRefParsedMap:new Map,numRequest:1})}e.addTask({operate:t.operate,url:t.uri,baseUrl:this.baseUrl,signalrHubUrl:this.signalrHubUrl,ApiKeyData:this.apiKeyData,uuid:(void 0===t.uuid?this:t).uuid,configName:(void 0===t.params.configName?this:t.params).configName,modelId:t.params.modelId,useRefItemCode:t.params.useRefItemCode})}}handleGeometryChunkRequest(){for(;this.waitingGeomChunks.length;)if(this.waitingGeomChunks[0].isRefChunk){var e=this.waitingGeomChunks.shift();this.loadingGeomChunks.set(e.url,e),this.loadedGeomChunks.push({url:e.url,modelId:e.parameters.modelId})}else{e=this.getWorker(5,this.waitingGeomChunks[0].parameters.modelId);if(!e)break;var t=this.waitingGeomChunks.shift();void 0!==this.baseUrl&&void 0!==this.signalrHubUrl?e.addTask({operate:"loadChunkBuffer",url:t.url,isPMI:!!t.isPMI,bufferlenth:t.parameters.bufferlenth,modelId:t.parameters.modelId,baseUrl:this.baseUrl,signalrHubUrl:this.signalrHubUrl,ApiKeyData:this.apiKeyData}):e.addTask({operate:"loadChunkBuffer",url:t.url,isPMI:!!t.isPMI,bufferlenth:t.parameters.bufferlenth,modelId:t.parameters.modelId,keepSourceFile:!!t.parameters.keepSourceFile,gobalReqHeader:this.viewer.gobalReqHeader,isDraco:!!t.parameters.isDraco}),t.state="loading",(t.isPMI?this.loadingPmiGeomChunks:this.loadingGeomChunks).set(t.url,t)}}handleLoadedGeometryChunk(e){for(var t=this.loadedGeomChunks.length;e.numMergedGeom<t;++e.numMergedGeom){var n=this.viewer.ndsModel.getModelById(this.loadedGeomChunks[0].modelId);if(!(n.state<NDSWebViewer.NdsModel.StateType.RENDERING_PREPARED)){let o=this.loadedGeomChunks.shift(),s=this.loadingGeomChunks.get(o.url);if(this.loadingGeomChunks.delete(o.url),!s.isRefChunk)if(void 0===s.parameters.geomChunkGroup||1===s.parameters.geomChunkGroup.geomChunkUrl.length){var r=!s.parameters.geometriesArray,i=r?s.parameters.ndsGeometriesArray:s.parameters.geometriesArray;if(s.parameters.compress){var a=new b.Stream(o.chunkData),c=new NDSWebViewer.NdsBinParser({ndsModel:n}),l=(s.parameters.isDraco?c.readBIMBufferDraco(a,()=>{},i,null,s.parameters.needsLineType):c.readBIMBuffer(a,null,i,null,s.parameters.needsLineType),i.length);if(s.parameters.ndsGeometriesArray)for(let e=0;e<l;++e)r||s.parameters.ndsGeometriesArray[e].copy(s.parameters.geometriesArray[e]),s.parameters.ndsGeometriesArray[e].loaded=!0,s.parameters.ndsGeometriesArray[e].bufferChunkUrl=o.url}}else{this.loadedGeomChunkMap.set(o.url,{chunkData:o,chunkInfo:s});var h=s.parameters.geomChunkGroup,d=[];let t=!0;if(!h.isProcessed){for(let e=0;e<h.geomChunkUrl.length;++e){var u=h.geomChunkUrl[e];if(!this.loadedGeomChunkMap.has(u)){t=!1;break}d.push(this.loadedGeomChunkMap.get(u))}if(t){h.isProcessed=!0;var p=[],g=[];let t=void 0,r=void 0;for(let e=0;e<d.length;++e){o=d[e].chunkData,s=d[e].chunkInfo,this.loadedGeomChunkMap.delete(o.url);var f,m=!s.parameters.geometriesArray?s.parameters.ndsGeometriesArray:s.parameters.geometriesArray;s.parameters.compress&&(f=new b.Stream(o.chunkData),p.push(f),g.push(m),t=s.parameters.needsLineType,r=s.parameters.isDraco)}c=new NDSWebViewer.NdsBinParser({ndsModel:n});r||c.readMultipleBIMBuffer(p,null,g,null,t);for(let e=0;e<d.length;++e){o=d[e].chunkData;var _=!(s=d[e].chunkInfo).parameters.geometriesArray,y=_?s.parameters.ndsGeometriesArray:s.parameters.geometriesArray;if(s.parameters.compress){var v=y.length;if(s.parameters.ndsGeometriesArray)for(let e=0;e<v;++e)_||s.parameters.ndsGeometriesArray[e].copy(s.parameters.geometriesArray[e]),s.parameters.ndsGeometriesArray[e].loaded=!0,s.parameters.ndsGeometriesArray[e].bufferChunkUrl=o.url}}}}}}}}handleLoadedPmiGeometryChunk(e){for(var t=this.loadedPmiGeomChunks.length;e.numMergedGeom<t;++e.numMergedGeom){var r=this.loadedPmiGeomChunks.shift(),o=this.loadingPmiGeomChunks.get(r.url),s=(this.loadingPmiGeomChunks.delete(r.url),!o.parameters.geometriesArray),n=s?o.parameters.ndsGeometriesArray:o.parameters.geometriesArray,i=new b.Stream(r.chunkData),a=((new NDSWebViewer.NdsBinParser).readBIMBuffer(i,null,n,null,!1),n.length);if(o.parameters.ndsGeometriesArray)for(var c=0;c<a;++c)s||o.parameters.ndsGeometriesArray[c].copy(o.parameters.geometriesArray[c]),o.parameters.ndsGeometriesArray[c].loaded=!0,o.parameters.ndsGeometriesArray[c].bufferChunkUrl=r.url}}request(){if(this.handleModelRequest(),this.refModelContext&&this.refModelContext.modelCaches.forEach((e,t,r)=>{"requesting"===e.state&&(e=this.url2worker.get(t))&&(e.postMessage({operate:"getModelData",url:t}),this.nodes.set(t,{state:"asking"}))}),this.handleGeometryChunkRequest(),this.refModelContext&&this.refModelContext.allModelLoaded){var e={numMergedGeom:0};if(this.handleLoadedGeometryChunk(e),this.handleLoadedPmiGeometryChunk(e),0<e.numMergedGeom){if(this.params.onBufferChunkCallback)if(this.currentNdsModel.isSketchModel)this.currentNdsModel.state=NDSWebViewer.NdsModel.StateType.PREPARED;else{let e=!0;(!this.refModelContext.allModelLoaded||0<this.waitingGeomChunks.length||0<this.loadingGeomChunks.size||0<this.loadingPmiGeomChunks.size)&&(e=!1),this.params.onBufferChunkCallback(e,!0),e&&this.currentNdsModel.afterAllGeomLoaded()}}else{let e=!0;if((e=!this.refModelContext.allModelLoaded||0<this.waitingGeomChunks.length||0<this.loadingGeomChunks.size||0<this.loadingPmiGeomChunks.size?!1:e)&&this.viewer.ndsModel&&this.viewer.ndsModel.activeModel){let t=0;for(let e=0;e<this.viewer.ndsModel.models.length;e++){var r=this.viewer.ndsModel.models[e];t+=r.meshManager.geomManager.geoms.length}0!==t||this.viewer.GeomEmpty?0<t&&this.viewer.GeomEmpty&&(this.viewer.GeomEmpty=!1):(this.viewer.GeomEmpty=!0,this.viewer.dispatchEvent({type:"GeomEmpty"}),this.viewer.dispatchEvent({type:"loadBegin"}),this.viewer.dispatchAsyncEvent({type:"geometryLoadedEvent"}),this.viewer.dispatchAsyncEvent({type:"geometryAllLoadedEvent",modelLoadedTime:0,wholeModelLoadedTime:0,modelInfo:{}}),this.currentNdsModel.afterAllGeomLoaded(),this.viewer.loadRemainExtension())}e&&this.viewer.ndsModel&&this.viewer.ndsModel.activeModel&&0<this.viewer.ndsModel.meshManager.geomManager.geoms.length&&0<this.chunkRequestsTextNum&&(this.params.onBufferChunkCallback(e,!0),this.currentNdsModel.afterAllGeomLoaded(),this.chunkRequestsTextNum=-1)}}}initRequest(){this.lastModelId=-1,this.refModelContext=null,this.url2worker=new Map,NDSWebViewer.NdsModelParser.numObject=0}parse(e,t,r,o,s,n,i){e.metadata&&"CATIA"==e.metadata.format&&(this.viewer._CATIA=!0);var a=new NDSWebViewer.NdsModelParser(null,s.SDFMaker,this.viewer,s).parse(e,{basUri:t,modelId:r,numRef:i,needsPMI:s.needsPMI,needsAnimation:s.needsAnimation,needsSketchModel:s.needsSketchModel,needsProperty:s.needsProperty,needsBRep:s.needsBRep,keepSourceFile:o,modelRequestor:this,parentNode:n,parentSptIndexNode:null,refModelContext:this.refModelContext,hasRefModel:!!e.hasRefModel,modelUri:s.modelUri});if(a.rootObject.bodyNodeRoot&&a.rootObject.sptIndexRoot&&this.refModelContext.bodyNode_sptIndexNode.set(a.rootObject.bodyNodeRoot,a.rootObject.sptIndexRoot),n||(s.hasRefModel=this.refModelContext.hasRefModel),s.isSketchModel||e.modelContent.lightsPreset,a.rootObject.pmiObjectRoot&&s.addPMIObject(a.rootObject.pmiObjectRoot),a.binResquester.chunkRequests&&0<a.binResquester.chunkRequests.length){for(let e=0;e<a.binResquester.chunkRequests.length;++e)a.binResquester.chunkRequests[e].parameters.modelId=r,a.binResquester.chunkRequests[e].parameters.needsLineType=!s.isECAD2DModel&&(s.is2DModel||s.isSketchModel),a.binResquester.chunkRequests[e].parameters.keepSourceFile=o;this.waitingGeomChunks=this.waitingGeomChunks.concat(a.binResquester.chunkRequests)}else this.chunkRequestsTextNum=this.viewer.is2DModel?a.binResquester.chunkRequestsTextNum:-1;if(a.binResquester.pmiGeomRequests&&0<a.binResquester.pmiGeomRequests.length){for(let e=0;e<a.binResquester.pmiGeomRequests.length;++e)a.binResquester.pmiGeomRequests[e].isPMI=!0,a.binResquester.pmiGeomRequests[e].parameters.modelId=r,a.binResquester.pmiGeomRequests[e].parameters.keepSourceFile=o;this.waitingGeomChunks=this.waitingGeomChunks.concat(a.binResquester.pmiGeomRequests)}}createWorker(){let n=this,e;var t;return this.viewer.serverUrl?(t=new Blob(['importScripts("'+this.workUrl+'")'],{type:"application/javascript"}),t=window.URL.createObjectURL(t),e=new Worker(t)):NDSWebViewer.SETTING.singleHTML?(t=this.viewer.workerString,t=new Blob([t],{type:"application/javascript"}),t=window.URL.createObjectURL(t),e=new Worker(t),this.workUrl=t):e=new Worker(this.workUrl),Object.assign(e,{workingRequestCount:0}),e.onmessage=function(t){if("loadModelInfo"===t.data.operate)this.workingRequestCount--,n.viewer.__addModel(t.data.res);else if("getModelData"===t.data.operate)"successed"===t.data.res.state?(e=t.data.res,n.nodes.set(t.data.url,e),this.workingRequestCount--,n.loadingModel--,n.refModelContext.modelCaches.get(t.data.url).state="prepared",e.keepSourceFile&&!n.modelSourceFile.has(e.modelId)&&n.modelSourceFile.set(e.modelId,{url:t.data.url,modelSourceData:e.jsonMain.modelSourceData,modelContentSourceData:e.jsonMain.modelContentSourceData,bvhSourceData:e.jsonMain.bvhSourceData,pmiContentSourceData:e.jsonMain.pmiContentSourceData,animationSourceData:e.jsonMain.animationFileSourceData,geomBins:[],PropertyFile:[]})):"loading"===t.data.res.state?n.nodes.get(t.data.url).state="loading":(n.nodes.get(t.data.url).state="failed",this.workingRequestCount--,n.loadingModel--,n.refModelContext.modelCaches.get(t.data.url).state="failed");else if("loadChunkBuffer"===t.data.operate){var e;this.workingRequestCount--,"successed"!==t.data.state?console.log("load "+t.data.url+" failed"):t.data.isPMI?(n.loadedPmiGeomChunks.push(t.data),t.data.keepSourceFile&&(e=n.modelSourceFile.get(t.data.modelId))&&(e.pmiGeomBin={url:t.data.url,data:t.data.chunkSourceData})):(n.loadedGeomChunks.push(t.data),t.data.keepSourceFile&&(e=n.modelSourceFile.get(t.data.modelId))&&e.geomBins.push({url:t.data.url,data:t.data.chunkSourceData}))}else if("loadBrepData"===t.data.operate)this.workingRequestCount--,n.viewer.ndsModel.setActiveModelByModelId(t.data.modelId),"successed"!==t.data.state?(console.log("load "+t.data.url+" failed"),n.viewer.ndsModel.activeModel.brepManager.onError(t.data.url)):n.viewer.ndsModel.activeModel.brepManager.onLoad(t.data.itemCode,t.data.brepData);else if("requestRefModel"===t.data.operate){n.refModelContext.filter.ignores&&(t.data.refUUID&&n.refModelContext.filter.ignores.has(t.data.refUUID)||t.data.fileUUID&&n.refModelContext.filter.ignores.has(t.data.fileUUID))?(n.refModelContext.filter.ignores.add(t.data.uuid),t.data.refUUID&&n.refModelContext.filter.ignores.add(t.data.refUUID),t.data.refModelPathes.length=0):n.refModelContext.filter.needs&&t.data.uuid&&n.refModelContext.filter.needs.add(t.data.uuid);for(let e=0;e<t.data.refModelPathes.length;++e){var r=t.data.refModelPathes[e];n.refModelContext.filter.needs&&("Part"!==r.type||t.data.fileUUID&&n.refModelContext.filter.needs.has(t.data.fileUUID))&&n.refModelContext.filter.needs.add(r.uuid),n.refModelContext.filter.ignores&&((n.refModelContext.filter.ignores.has(t.data.refUUID)||t.data.fileUUID&&n.refModelContext.filter.ignores.has(t.data.fileUUID))&&n.refModelContext.filter.ignores.add(r.uuid),n.refModelContext.filter.ignores.has(r.uuid))?n.refModelContext.filter.needs&&n.refModelContext.filter.needs.has(r.uuid)&&n.refModelContext.filter.needs.delete(r.uuid):(o=r.path,s=r.uuid,r=r.configName,n.refModelContext.modelCaches.has(o)||n.refModelContext.modelCaches.set(o,{state:"waiting",numRef:0,numRefParsedMap:new Map,numRequest:0}),n.requests.push({weight:t.data.weight,uri:o,uuid:o,operate:"loadModelData",params:{modelId:t.data.modelId,refUUID:s,configName:r}}))}n.refModelContext.hasRefModel=!0}var o,s},e.addTask=function(e){this.workingRequestCount++,this.postMessage(e),"loadModelData"===e.operate&&n.loadingModel++,"loadModelInfo"===e.operate?n.modelInfo2worker.set(e.url,this):"loadChunkBuffer"!==e.operate&&n.url2worker.set(e.url,this)},e}tryMergeNode(e,t,r,o){let s=!1,n;if(!(n=e.path?null!==e.configName||void 0!==e.configName?e.path+"/"+e.configName:e.path:e))return!1;if(this.currentNdsModel||(this.currentNdsModel=t),r&&this.refModelContext.filter.ignores&&this.refModelContext.filter.ignores.has(r.uuid))return r.ignored=!0;let i=this.nodes.get(n),a=0;if(!i&&this.refModelContext.modelCaches&&this.refModelContext.modelCaches.has(n)&&"loaded"===(e=this.refModelContext.modelCaches.get(n)).state&&(i=e.node,a=++e.numRef,o)&&r&&((c=e.numRefParsedMap.get(r.refModelUri))?(null==c.count&&(c.count=0),++c.count,r.refNum=c.count+1,1==c.count&&c.firstParseNode&&(c.firstParseNode.refNum=1)):e.numRefParsedMap.set(r.refModelUri,{firstParseNode:r})),i&&"successed"===i.state&&o){var c=this.extractUrlBase(n);if(-1===t.dataVersion&&(t.dataVersion=Number(i.jsonMain.metadata.version)),this.refModelContext.filter.needs&&r&&"Part"===r.type?i.jsonMain.modelContent.object.externalRefUuid&&!this.refModelContext.filter.needs.has(i.jsonMain.modelContent.object.externalRefUuid)&&r.parent&&r.parent.externalRefUuid&&!this.refModelContext.filter.needs.has(r.parent.externalRefUuid)&&!this.refModelContext.filter.needs.has(i.jsonMain.modelContent.object.uuid)&&(r.ignored=!0):this.refModelContext.filter.ignores&&r&&(i.jsonMain.modelContent.object.externalRefUuid&&this.refModelContext.filter.ignores.has(i.jsonMain.modelContent.object.externalRefUuid)||this.refModelContext.filter.ignores.has(i.jsonMain.modelContent.object.uuid))&&(r.ignored=!0),(!r||!r.ignored)&&(this.parse(i.jsonMain,c,i.modelId,i.keepSourceFile,t,r,a),this.nodes.delete(n),r)&&"Assembly"===r.type)if(this.refModelContext.filter.needs&&r.parent&&this.refModelContext.filter.needs.has(r.parent.externalRefUuid)&&this.refModelContext.filter.needs.add(r.externalRefUuid),this.refModelContext.filter.needs&&this.refModelContext.filter.needs.has(r.externalRefUuid))for(let e=0,t=r.children.length;e<t;++e){var l=r.children[e];this.refModelContext.filter.ignores&&this.refModelContext.filter.ignores.has(l.uuid)||this.refModelContext.filter.needs.add(l.uuid)}else if(this.refModelContext.filter.ignores&&this.refModelContext.filter.ignores.has(r.externalRefUuid))for(let e=0,t=r.children.length;e<t;++e){var h=r.children[e];this.refModelContext.filter.ignores.add(h.uuid)}i.cached||(e=this.refModelContext.modelCaches.get(n))&&(e.state="loaded",i.cached=!0,e.node=i,r)&&!e.numRefParsedMap.has(r.refModelUri)&&e.numRefParsedMap.set(r.refModelUri,{firstParseNode:r}),s=!0}else i&&"loading"!==i.state?i&&"failed"===i.state&&(this.refModelContext.modelCaches.get(n).state="failed",this.viewer.loadErrorCallback(n+" load failed",this.refModelContext.hasRefModel),s=!0):(o=this.url2worker.get(n))&&(o.postMessage({operate:"getModelData",url:n}),this.nodes.set(n,{state:"asking"}));return s}getModelSourceFile(){return this.modelSourceFile}createBrepManager(e,t,r){return new q(e,t,r)}createPropertyManager(e){return new U(e)}}class ne extends NDSWebViewer.NdsMCAD3d{constructor(e,t,r={}){super(e,t,r),this.isWeb3DModel=!0,this.nodeRequestor=r.nodeRequestor||new NdsWebModelRequestor(this,{loadingManager:r.loadingManager,onLoadCallback:r.onLoadCallback,onRenderSettingCallback:r.onRenderSettingCallback,onBufferChunkCallback:r.onBufferChunkCallback,onLoadErrorCallback:r.onLoadErrorCallback}),this.brepManager=new q(e,this.nodeRequestor,this),e.propertyManager=new U(e)}}var A=new class extends r{constructor(){super(),this.name="NDSWebDataLoaderExtension",console.log("NDSWebDataLoaderExtension version 1.0.0"),this.OperatorName="OpWebDataLoader",this.modelRequestor=null}onLoad(e){this.coreView=e,this.modelRequestor=new se(e),this.coreView.modelRequestorManager.registerModelRequestor(this.modelRequestor)}createModel(e,t,r={}){if(r.modelType.isMCAD3DModel)return new ne(e,t,r)}setBaseUrl(e){this.modelRequestor.baseUrl=e}setSignalrHUbUrl(e){this.modelRequestor.signalrHubUrl=e}setUuid(e){this.modelRequestor.uuid=e}setConfigName(e){this.modelRequestor.configName=e}setTokenParam(e){this.modelRequestor.apiKeyData=e}getOperatorName(){return this.OperatorName}};NDSWebViewer.ExtensionManager.addExtension(A)}],o={},s.m=r,s.c=o,s.d=function(e,t,r){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(s.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)s.d(r,o,function(e){return t[e]}.bind(null,o));return r},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=5);function s(e){var t;return(o[e]||(t=o[e]={i:e,l:!1,exports:{}},r[e].call(t.exports,t,t.exports,s),t.l=!0,t)).exports}var r,o});