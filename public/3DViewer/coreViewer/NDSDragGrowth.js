!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.NDSDragGrowth=t():e.NDSDragGrowth=t()}(window,function(){return o=[function(e,t,o){o.r(t),o.d(t,"NDSDragGrowthExtension",function(){return n});function i(e){NDSWebViewer.OpBase.call(this,e),this.type="OpDrag",this.opMode="default",this.selectedBox=null,this.prompt=null,this.oldMatrix4=new THREE.Matrix4,this.oldQuaternion=new THREE.Quaternion,this.isNewAxis=!0,this.isChangeDispatch=!0,this.center=new THREE.Vector3,this.originQuat=new THREE.Quaternion,this.attachObj=null,this.domElement=null,e.canvas2D?this.domElement=e.canvas2D:this.domElement=e.canvas3D,this.transformControl=null,this.transformControlMode=null;let t=this;this.changeFunc=function(e){t.viewer.render()},this.objChangeFunc=function(e){t.onOpDrag(!0)}}(i.prototype=Object.create(NDSWebViewer.OpBase.prototype)).setMoveMode=function(){this.opMode="move",this.InitBall(),this.viewer.renderAllViews()},i.prototype.setBoxMoveMode=function(){this.opMode="BoxMove",this.prompt||(this.prompt=document.createElement("div"),this.prompt.className="pc-alert",this.prompt.innerHTML=NDSWebViewer.COMMON.translateString("MEASURE_PLACELINELOCATION"),this.prompt.style.display="block",this.viewer.container.appendChild(this.prompt))},i.prototype.setRestoreMode=function(){this.opMode="restore",this.InitBall()},i.prototype.setDefaultMode=function(){this.opMode="default",this.InitBall()},i.prototype.setDragBoxMode=function(){this.opMode="dragBox"},i.prototype.isModelMoved=function(){var t;return this.viewer.ndsModel?this.viewer.ndsModel.hasDraggedBodies():(t=!1,this.viewer.scene.traverse(function(e){e.hasOwnProperty("geometry")&&null!=e.matrixWorldTransOrginalDrag&&(t=!0)}),t)},i.prototype.hideSelectedModel=function(){this.viewer.hideSelectedObjects(),this.viewer.isSectionViewEnabled()&&this.viewer.clipPlaneManager&&this.viewer.clipPlaneManager.updateClipPlane()},i.prototype.showAllModel=function(){this.viewer.showObject(this.viewer.scene,!0),this.viewer.isSectionViewEnabled()&&this.viewer.clipPlaneManager&&this.viewer.clipPlaneManager.updateClipPlane(),this.render(!1,!1)},i.prototype.reverseVisibleAndHidingModel=function(){this.viewer.showObjectReversed(this.viewer.scene),this.viewer.isSectionViewEnabled()&&this.viewer.clipPlaneManager&&this.viewer.clipPlaneManager.updateClipPlane(),this.render(!1,!1)},i.prototype.create=function(){NDSWebViewer.SETTING.HideLeafBody?(this.viewer.selectionManager.setSelectType("part"),this.viewer.controls.getOperator().oldSelectType="part"):this.viewer.selectionManager.setSelectType("body"),NDSWebViewer.OpBase.prototype.create.call(this)},i.prototype.release=function(){this.InitBall(!0),this.transformControlMode=null,this.update(),this.prompt&&(this.viewer.container.removeChild(this.prompt),this.prompt=null),this.render(!1,!1),NDSWebViewer.OpBase.prototype.release.call(this)},i.prototype.update=function(){this.viewer.selectionManager.clearSelection(),NDSWebViewer.OpBase.prototype.update.call(this)},i.prototype.onLMouseClick=function(e){var r=this.viewer,t=(r.renderer.domElement,e.offsetX||e.clientX-this.viewer.container.getBoundingClientRect().left),o=e.offsetY||e.clientY-this.viewer.container.getBoundingClientRect().top,i=(e.srcElement&&e.srcElement!==this.viewer.renderer.domElement&&(t=e.clientX-this.viewer.container.getBoundingClientRect().left,o=e.clientY-this.viewer.container.getBoundingClientRect().top),null==e.srcElement&&e.target&&e.target!==this.viewer.renderer.domElement&&(t=e.clientX-this.viewer.container.getBoundingClientRect().left,o=e.clientY-this.viewer.container.getBoundingClientRect().top),this.remapCoordnidateToFullView(t,o)),t=i[0],o=i[1];if(Math.abs(t-this.lMouseDown.x)<1&&Math.abs(o-this.lMouseDown.y)<1)if("move"==this.opMode||"default"==this.opMode)r.selectionManager.selectByClick(t,o,e.ctrlKey),this.render(!1,!1);else if("restore"==this.opMode)this.onOpRestore(t,o);else if("dragBox"==this.opMode||"BoxMove"==this.opMode){let t=this.viewer.AnimationEdit._activeAnimationID,o=this,i=this.viewer.insertBox.position;r.loadModelAnimationEnd(this.selectedBox.url,function(){var e=o.viewer.ndsModel.models.length-1;o.viewer.ndsModel.models[e].animationId=t,o.viewer.ndsModel.models[e].position=i})}this.InitBall()},i.prototype.InitBall=function(e=!1){!e&&this.viewer.ndsModel.activeModel&&this.viewer.ndsModel.activeModel.sketchFileUrl&&this.viewer.ndsModel.models.length&&this.viewer.ndsModel.setActiveModel(0),this.transformControl&&(this.transformControl.removeEventListener("change",this.changeFunc),this.transformControl.removeEventListener("objectChange",this.objChangeFunc),this.transformControl.detach(),this.transformControl.dispose(),this.viewer.additionalObjectsScene.remove(this.transformControl),this.transformControl=null),this.attachObj&&(this.viewer.additionalObjectsScene.remove(this.attachObj),this.attachObj.geometry.dispose(),this.attachObj.material.dispose(),this.attachObj=null,this.center=new THREE.Vector3);var t=this.viewer.selectionManager.getSelectedBodyBoundingBox();!e&&t&&"move"==this.opMode?(t.getCenter(this.center),this.transformControl=new NDSWebViewer.TransformControls(this.viewer,this.domElement),this.transformControl.addEventListener("change",this.changeFunc),this.transformControl.addEventListener("objectChange",this.objChangeFunc),e=new THREE.SphereGeometry(.1,1,1),t=new THREE.MeshBasicMaterial({colorWrite:!1}),this.attachObj=new THREE.Mesh(e,t),this.attachObj.position.copy(this.center),this.attachObj.updateMatrixWorld(!0),this.transformControl.setMode("both"),this.transformControl.setSpace("world"),this.transformControl.attach(this.attachObj),NDSWebViewer.COMMON.isMobileDevice()?(this.transformControlMode=this.transformControlMode||"translate",this.transformControl.setMode(this.transformControlMode),this.transformControl.setSize(1)):this.transformControl.setSize(.8),this.transformControl.update(),this.viewer.additionalObjectsScene.add(this.attachObj),this.viewer.additionalObjectsScene.add(this.transformControl),this.oldQuaternion.copy(this.attachObj.quaternion),this.oldMatrix4.copy(this.attachObj.matrixWorld),this.originQuat.copy(this.attachObj.quaternion),this.isNewAxis=!0,this.dispatchChanges(this.center.clone(),this.oldQuaternion.clone())):this.dispatchChanges(new THREE.Vector3,new THREE.Quaternion)},i.prototype.setTransformCtrlMode=function(e){this.transformControlMode=e,this.transformControl&&this.transformControl.setMode(e)},i.prototype.onMMouseUp=function(e){NDSWebViewer.OpBase.prototype.onMMouseUp.call(this,e),this.InitBall()},i.prototype.MoveFromTextValueByDelta=function(e){var t,o;this.transformControl&&(e.x=parseFloat(e.x),e.y=parseFloat(e.y),e.z=parseFloat(e.z),t=this.viewer.getDispalyModelUnit(10),"translate"==e.mode?((o=new THREE.Vector3(e.x,e.y,e.z)).multiplyScalar(1/t.scale),this.transformControl.object.position.add(o),this.transformControl.object.updateMatrixWorld(!0)):"rotate"==e.mode&&(t=new THREE.Euler(e.x*Math.PI/180,e.y*Math.PI/180,e.z*Math.PI/180),(o=new THREE.Quaternion).setFromEuler(t),this.transformControl.object.quaternion.multiply(o),this.transformControl.object.updateMatrixWorld(!0)),this.onOpDrag(!0))},i.prototype.MoveFromTextValue=function(t){if(t){if(this.transformControl){t.x=parseFloat(t.x),t.y=parseFloat(t.y),t.z=parseFloat(t.z);var o=this.viewer.getDispalyModelUnit(10),i=this.viewer.ndsModel?this.viewer.selectionManager.getSelectedObjects():null;if(i){if(this.isChangeDispatch=!1,1==i.length){let e=i[0];var r,n,i=(e=0!=e.children.length&&void 0!==e.FirstVisibleNode?e.children[e.FirstVisibleNode]:e).leafBodyAttri;i&&(r=new THREE.Vector3(i.bodyDragTranslate[0],i.bodyDragTranslate[1],i.bodyDragTranslate[2]),i.bodyDragQuaternionOrigin.clone(),"translate"==t.mode?((n=new THREE.Vector3(t.x,t.y,t.z)).multiplyScalar(1/o.scale).sub(r),n.add(this.transformControl.object.position),this.transformControl.object.position.copy(n),this.transformControl.object.updateMatrixWorld(!0)):"rotate"==t.mode&&(i.bodyDragQuaternionOrigin=new THREE.Quaternion,r=new THREE.Euler(t.x*Math.PI/180,t.y*Math.PI/180,t.z*Math.PI/180),n=(new THREE.Quaternion).setFromEuler(r),this.transformControl.object.quaternion.copy(n),this.transformControl.object.updateMatrixWorld(!0),this.isNewAxis=!1),this.onOpDrag(!0),this.InitBall())}else"translate"==t.mode?((i=new THREE.Vector3(t.x,t.y,t.z)).multiplyScalar(1/o.scale),i.add(this.center),this.transformControl.object.position.copy(i),this.transformControl.object.updateMatrixWorld(!0)):"rotate"==t.mode&&(r=new THREE.Euler(t.x*Math.PI/180,t.y*Math.PI/180,t.z*Math.PI/180),(n=new THREE.Quaternion).setFromEuler(r),this.transformControl.object.quaternion.copy(this.originQuat.clone().invert().multiply(n)),this.transformControl.object.updateMatrixWorld(!0)),this.onOpDrag(!0);this.isChangeDispatch=!0}}}else this.viewer.selectionManager.clearSelection(),this.InitBall(),this.render(!1,!1)},i.prototype.MoveBox=function(e){var t,o,i;!this.selectedBox&&this.viewer.insertBox&&(this.selectedBox=this.viewer.insertBox,this.selectedBoxOri=this.viewer.insertBox.box.clone(),this.selectedBoxPos=this.selectedBox.position.clone()),this.selectedBox&&(i=this.pointer.x,t=this.pointer.y,o=this.viewer.modelCoordToClientCoord([this.selectedBoxPos.x,this.selectedBoxPos.y,this.selectedBoxPos.z]),t=[i-((i=this.viewer.modelCoordToClientCoord([this.selectedBoxOri.min.x,this.selectedBoxOri.max.y,this.selectedBoxOri.min.z]))[0]-o[0]),t-(i[1]-o[1]),i[2]],o=this.viewer.clientCoordToModelCoord(t),i=new THREE.Vector3(o[0],o[1],o[2]).clone(),this.selectedBox.position.copy(this.selectedBoxPos).add(i),this.selectedBox.updateMatrixWorld(!0),this.selectedBox.box.copy(this.selectedBoxOri).translate(i),this.render())},i.prototype.getOffsetPostion=function(e,t){var r=e.clone(),n=t.clone();return function(e){var t=(new THREE.Matrix4).getInverse(n.clone()).clone().multiply(e.clone()),t=r.clone().multiply(t.clone()),e=e.clone(),o=new THREE.Vector3,i=new THREE.Vector3;return t.decompose(i,new THREE.Quaternion,new THREE.Vector3(1,1,1)),e.decompose(o,new THREE.Quaternion,new THREE.Vector3(1,1,1)),i.sub(o)}},i.prototype.onOpDrag=function(e=!1){if(this.transformControl){var t=this.viewer.ndsModel?this.viewer.selectionManager.getSelectedObjects():this.viewer.selectionManager.getSelectedMeshes();if(null==this.viewer.draggedObjects&&(this.viewer.draggedObjects=new Array),this.viewer.ndsModel){for(var o=this.attachObj.quaternion.clone(),i=this.attachObj.matrixWorld.clone(),r=this.getOffsetPostion(i,this.oldMatrix4),n=o.normalize().clone(),s=0;s<t.length;++s){var a=t[s];n._isNewAxis=this.isNewAxis,this.viewer.ndsModel.dragBody(a,r,n),this.addDraggedObject(a)}this.viewer.isSectionViewEnabled()&&this.viewer.clipPlaneManager&&this.viewer.clipPlaneManager.updateClipPlane(),this.oldMatrix4=i,this.oldQuaternion=o;var o=new THREE.Vector3,l=new THREE.Quaternion;i.decompose(o,l,new THREE.Vector3(1,1,1)),this.isNewAxis=!1,this.dispatchChanges(o.clone(),l.clone())}else for(s=0;s<t.length;++s){void 0===(a=t[s].key).matrixWorldTransOrginal&&(a.matrixWorldTransOrginal=new THREE.Vector3,a.matrixWorldTransOrginal.setFromMatrixPosition(a.matrixWorld));var h=new THREE.Vector3;h.setFromMatrixPosition(a.matrixWorld),h.add(deltaVec),a.matrixWorld.setPosition(h),a.matrixWorldTransExplode?h.sub(a.matrixWorldTransExplode):h.sub(a.matrixWorldTransOrginal),void 0===a.matrixWorldTransOrginalDrag&&(a.matrixWorldTransOrginalDrag=new THREE.Vector3),a.matrixWorldTransOrginalDrag.copy(h),this.addDraggedObject(a)}e?this.viewer.renderAllViews():this.viewer.render(),this.viewer.dispatchEvent({type:"dragingModel"})}},i.prototype.getUnitStringmap=function(e){var t="mm";if(e)switch(e.toLowerCase()){case"meter":t="m";break;case"centimeter":t="cm";break;case"millimeter":t="mm";break;case"inch":t="in";break;case"um":t="um";break;case"feet":t="ft"}return t},i.prototype.dispatchChanges=function(o,i){if(this.viewer.ndsModel&&this.isChangeDispatch){let t=o.sub(this.center);o=new THREE.Euler(0,0,0),i=(o.setFromQuaternion(this.originQuat.clone().invert().multiply(i)),this.viewer.ndsModel?this.viewer.selectionManager.getSelectedObjects():null);if(i){if(1==i.length){let e=i[0];i=(e=0!=e.children.length&&void 0!==e.FirstVisibleNode?e.children[e.FirstVisibleNode]:e).leafBodyAttri;if(!i)return;t=new THREE.Vector3(i.bodyDragTranslate[0],i.bodyDragTranslate[1],i.bodyDragTranslate[2]),o.setFromQuaternion(i.bodyDragQuaternion.clone())}i=this.viewer.getDispalyModelUnit(10),i=(t.multiplyScalar(i.scale),this.getUnitStringmap(i.unit));this.viewer.dispatchEvent({type:"DragTranslate",position:{x:t.x,y:t.y,z:t.z},unit:i}),this.viewer.dispatchEvent({type:"DragRotate",angle:{x:180*o.x/Math.PI,y:180*o.y/Math.PI,z:180*o.z/Math.PI}})}}},i.prototype.onOpDragBox=function(){var e=this.pointer.x-this.pointerOld.x,t=this.pointer.y-this.pointerOld.y,o=[this.downModelPnt.x,this.downModelPnt.y,this.downModelPnt.z],o=this.viewer.modelCoordToClientCoord(o),e=[o[0]+e,o[1]+t,o[2]],t=this.viewer.clientCoordToModelCoord(e),o=new THREE.Vector3(t[0],t[1],t[2]).clone();this.selectedBox.position.add(o),this.selectedBox.updateMatrixWorld(!0),this.selectedBox.box.translate(o),this.render()},i.prototype.addDraggedObject=function(e){for(var t=0;t<this.viewer.draggedObjects.length;++t)if(e==this.viewer.draggedObjects[t])return;this.viewer.draggedObjects.push(e)},i.prototype.removeDraggedObject=function(e){if(null!=this.viewer.draggedObjects)for(var t=0;t<this.viewer.draggedObjects.length;++t)if(e==this.viewer.draggedObjects[t])return void this.viewer.draggedObjects.splice(t,1)},i.prototype.onOpRestore=function(e,t){if(this.viewer.selectionManager.clearSelection(),this.viewer.selectionManager.selectByClick(e,t),this.viewer.ndsModel){for(var o=this.viewer.selectionManager.getSelectedObjects(),i=0;i<o.length;++i){var r=o[i];this.viewer.ndsModel.restoreDraggedBody(r),this.removeDraggedObject(r)}this.viewer.isSectionViewEnabled()&&this.viewer.clipPlaneManager&&this.viewer.clipPlaneManager.updateClipPlane()}else for(o=this.viewer.selectionManager.getSelectedMeshes(),i=0;i<o.length;++i)(r=o[i].key).matrixWorldTransOrginalDrag&&(r.matrixWorldTransOrginalDrag=void 0),r.matrixWorldTransExplode?r.matrixWorld.setPosition(r.matrixWorldTransExplode):r.matrixWorldTransOrginal&&(r.matrixWorld.setPosition(r.matrixWorldTransOrginal),r.matrixWorldTransOrginal=void 0),this.removeDraggedObject(r);this.InitBall(!0),this.render(!1,!1),this.viewer.dispatchEvent({type:"dragingModel"})},i.prototype.onNMouseMove=function(e){this.selectedBox&&"BoxMove"==this.opMode?(this.prompt&&!NDSWebViewer.COMMON.isMobileDevice()&&(this.prompt.style.left=e.clientX+16+"px",this.prompt.style.top=e.clientY+18+"px"),this.MoveBox(e)):NDSWebViewer.OpBase.prototype.onNMouseMove.call(this,e)},i.prototype.onLMouseMove=function(e){var t=this.viewer.ndsModel?this.viewer.selectionManager.getSelectedObjects():this.viewer.selectionManager.getSelectedMeshes();this.transformControl&&this.transformControl.axis&&0<t.length&&"move"==this.opMode||(this.selectedBox&&"BoxMove"==this.opMode?this.onOpDragBox():NDSWebViewer.OpBase.prototype.onLMouseMove.call(this,e))},i.prototype.onLMouseUpEnd=function(e){if(0<(this.viewer.ndsModel?this.viewer.selectionManager.getSelectedObjects():this.viewer.selectionManager.getSelectedMeshes()).length){var t=new THREE.Vector3,o=new THREE.Vector3;if(this.viewer.ndsModel){let e;(e=this.viewer.is2DModel||!(this.viewer.ndsModel instanceof NDSWebViewer.NdsModelSet)||(e=this.viewer.ndsModel.getTotalBodyBoundingBox()).isEmpty()?this.viewer.modelRootObject.boundingBox.clone():e)&&(t.copy(e.min),o.copy(e.max))}t.x>o.x||t.y>o.y||t.z>o.z||this.viewer.cameraControl.setBoundingBox(t,o)}},i.prototype.onTouchSingleStart=function(e){NDSWebViewer.OpBase.prototype.onTouchSingleStart.call(this,e)},i.prototype.onTouchSingleMove=function(e){var t=this.viewer.ndsModel?this.viewer.selectionManager.getSelectedObjects():this.viewer.selectionManager.getSelectedMeshes();this.transformControl&&this.transformControl.axis&&0<t.length&&"move"==this.opMode||NDSWebViewer.OpBase.prototype.onTouchSingleMove.call(this,e)},i.prototype.onTouchSingleEnd=function(e){this.state=-1,Math.abs(this.singleTouchEndPos.x-this.singleTouchStartPos.x)<1&&Math.abs(this.singleTouchEndPos.y-this.singleTouchStartPos.y)<1&&("move"==this.opMode||"default"==this.opMode?(this.viewer.selectionManager.selectByClick(this.singleTouchEndPos.x,this.singleTouchEndPos.y),this.render(!1,!1)):"restore"==this.opMode&&this.onOpRestore(this.singleTouchEndPos.x,this.singleTouchEndPos.y)),this.hideRotateCenterHelper(),this.InitBall()};class r extends NDSWebViewer.Extension{constructor(){super(),this.name="NDSDragGrowthExtension",console.log("NDSDragGrowthExtension version 0.1"),this.viewer=null}getDrag(){return new i(this.viewer)}load(e){this.viewer||(super.load(e),this.viewer=e)}unload(e){this.release(),super.unload(e)}}let n=new r;NDSWebViewer.ExtensionManager.addExtension(n)}],i={},r.m=o,r.c=i,r.d=function(e,t,o){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var o=Object.create(null);if(r.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)r.d(o,i,function(e){return t[e]}.bind(null,i));return o},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=0);function r(e){var t;return(i[e]||(t=i[e]={i:e,l:!1,exports:{}},o[e].call(t.exports,t,t.exports,r),t.l=!0,t)).exports}var o,i});