!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.NDSBlockEx=t():e.NDSBlockEx=t()}(window,function(){return r=[function(e,t,r){r.r(t),r.d(t,"NDSBlockExtension",function(){return o});console.log("NDS ExtensionFramework V0.1");let i={FLAG_ENABLE_NODE_TRANSFORM:NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM,FLAG_ENABLE_NODE_STOREVIEW:NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM<<1,FLAG_ENABLE_NODE_CAMERA2D:NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM<<2,FLAG_ENABLE_NODE_BLOCK:NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM<<3,FLAG_ENABLE_NODE_TEXT:NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM<<4};class n extends NDSWebViewer.Extension{constructor(){super()}onLoad(e){}onInitLights(){}update(e){}setFlags(e){super.setFlags(e)}onNdsModelPrepareForRendering(e){}onBeforeNdsModelUpdate(e,t){}onAfterNdsModelUpdate(e,t){}onBeforeNdsModelSetRender(e,t){}onAfterNdsModelSetRender(e,t){}onBeforeNdsMeshRender(e,t){}getExtensionWithFlags(e){return NDSWebViewer.ExtensionManager.getExtensionWithFlags(e)}resetToDefault(){}getStoreInfo(e){throw this.name+" Extesion did not implement method 'getStoreInfo' "}setStoreInfo(e){throw this.name+" Extesion did not implement method 'setStoreInfo' "}getBodyTransform(e){return new THREE.Matrix4}getBodyNodeTranslate(e){return new THREE.Vector3(0,0,0)}}class o extends n{constructor(){super(),this.setFlags(i.FLAG_ENABLE_NODE_BLOCK),this.name="NDSBlockExtension",console.log("NDSBlockExtension version 1.0.0"),this.viewer=null,this.blockMap=new Map,this.blockType=1,this.copyCamera=null,this.constNum=256,this.scene=new THREE.Scene,this.blockTarget=new THREE.WebGLRenderTarget(this.constNum,this.constNum),this.Offcanvas=document.createElement("canvas"),this.Offcanvas.width=this.constNum,this.Offcanvas.height=this.constNum,this.Offcontext=this.Offcanvas.getContext("2d"),this.points=[],this.rootObject=new THREE.Group,this.rootObject.name="blockGroup",this.rootObject.visible=!1}onLoad(e){this.viewer=e,this.copyCamera=this.viewer.camera.clone()}onBeforeNdsModelSetRender(){this._findTextIconUpdate()}clear(){this.blockType=1}getBlocks(){this._createBlockInfo();let r=[];return this.blockMap.forEach(function(e,t){r.push(t)}),r}getBlocksNumByName(e){this._createBlockInfo();e=this.blockMap.get(e);return e?e.length:0}getBlocksPicture(e){if(this._createBlockInfo(),this.blockMap.size<1)return null;let t=null;for(var[r,i]of this.blockMap)r==e&&(t=i[0]);var n=t.bbox.max.x-t.bbox.min.x,o=t.bbox.max.y-t.bbox.min.y,n=1.1*Math.max(n,o),o=new THREE.Vector3;if(t.bbox.getCenter(o),!t)return null;let s=null;if(1===this.blockType){var a=[];!function t(r,i){if(i.geometries)for(let e=0;e<i.geometries.length;e++)r.push(i.geometries[e]);if(i.children)for(let e=0;e<i.children.length;e++)t(r,i.children[e])}(a,t),s=this._createNdsModelSet2(a,t.bbox)}else{if(2!==this.blockType)return null;s=this._createNdsModelSet3(t)}s.forceRenderAll=!0;var a=s.meshManager.supportInstancedArrays,l=(s.meshManager.supportInstancedArrays=!1,s.setDirty(),s.backupAllBodyFlag(),s.showAllBodies(),new NDSWebViewer.NdsModelSet(this.viewer)),h=(l.addModel(s),this.viewer.renderer.getClearColor()),d=this.viewer.renderer.getClearAlpha(),o=(this.viewer.renderer.setClearColor(h,1),this.viewer.renderer.clearTarget(this.blockTarget,!0,!0,!0),this.constNum,this.constNum,this.copyCamera.aspect=1,this.copyCamera.position.set(o.x,o.y,n),this.copyCamera.target.set(o.x,o.y,0),this.copyCamera.far<n&&(this.copyCamera.far=1+n),this.copyCamera.near>-n&&(this.copyCamera.near=-n-1),this.copyCamera.updateProjectionMatrix(),this.copyCamera.updateMatrixWorld(!0),this.scene.children=[],this.scene.children.push(l),new Uint8Array(this.constNum*this.constNum*4)),n=(this.viewer.renderer.render(this.scene,this.copyCamera,this.blockTarget,!1),this.viewer.renderer.readRenderTargetPixels(this.blockTarget,0,0,this.constNum,this.constNum,o),this.Offcontext.createImageData(this.constNum,this.constNum)),l=(n.data.set(o),function(e){var r=e.width,i=e.height,n=e.data;for(let t=0;t<i/2;t++)for(let e=0;e<r;e++){var o=4*(t*r+e),s=4*((i-t-1)*r+e);for(let e=0;e<4;e++){var a=n[o+e];n[o+e]=n[s+e],n[s+e]=a}}return e}(n)),o=(this.Offcontext.putImageData(l,0,0),this.Offcanvas.toDataURL("image/png"));return s.meshManager.supportInstancedArrays=a,this.viewer.renderer.setClearColor(h,d),s.resetAllBodyFlag(),this.viewer.render(),o}findBlocksByName(e,t){this._createBlockInfo(),this._addRootObject();var r,i,n=[],o=[],s=this.blockMap.get(e);let a=!0,l=null;if(t&&(this.points&&0<this.points.length?((l=new THREE.Box2).expandByPoint(this.points[0]),l.expandByPoint(this.points[1]),l.expandByPoint(this.points[2]),l.expandByPoint(this.points[3])):a=!1),s&&a){for(let e=0;e<s.length;e++)this._checkBlockVisible(s[e])&&(r=s[e].bbox.clone(),l&&!l.containsBox(r)||(i=new THREE.Vector3,r.getCenter(i),n.push({index:e,center:[i.x.toFixed(4),i.y.toFixed(4)]}),i=new THREE.Vector3(r.min.x,r.max.y,0),o.push(i)));if(0<n.length)return this._clearBlockFlag(),this.showBlocks(e,n[0].index),this._creatFindTextMesh(o),this.viewer.render(),n}return this._clearBlockFlag(),this._clearBlockBox(),this.viewer.render(),n}showBlocks(e,t){var r,i,e=this.blockMap.get(e);e&&e[t]&&(this._clearBlockBox(),this._moveCameraTo(e[t].bbox),i=this._boxToVectices(e[t].bbox),r=e[t].bbox.max.x-e[t].bbox.min.x,e=e[t].bbox.max.y-e[t].bbox.min.y,t=Math.abs(r,e),(r=new NDSWebViewer.LineSegmentsGeometry).setPositions(i),e=new NDSWebViewer.LineMaterialOrigin({linewidth:2,color:new THREE.Color(16711680),depthTest:!1,depthWrite:!1,side:THREE.DoubleSide,dashed:!0,dashSize:t/100,gapSize:t/50}),i=this.viewer.renderer.getPixelRatio(),t=this.viewer.renderer.domElement.width/i,i=this.viewer.renderer.domElement.height/i,e.resolution.set(t,i),(t=new NDSWebViewer.LineSegments2(r,e)).name="blockBox",t.computeLineDistances(),this.rootObject.add(t),this._findTextIconUpdate(),this.viewer.render())}drawSearchRect(e,t){this.viewer.is2DModel&&e&&t&&e.x&&e.y&&t.x&&t.y&&(this.clearSearchRect(),this.points=this._getBoxPoints(e,t),this._addRootObject(),this._drawTextRect("#1880E3",this.points,"selectArea"))}clearSearchRect(){this.points=[],this.rootObject.clear(),this.viewer.render()}exitBlock(){this.clearSearchRect(),this._clearBlockBox(),this._removeRootObject()}_addRootObject(){this.rootObject.visible||(this.rootObject.visible=!0,this.viewer.scene.add(this.rootObject))}_removeRootObject(){this.rootObject.visible&&(this.rootObject.visible=!1,this.viewer.scene.remove(this.rootObject))}_createNdsModelSet3(e){function r(e,t){return(h=new NDSWebViewer.MCAD2DMeshSet(e)).needsUpdate=!1,h.lineOffset=t.lineOffset,h.meshOffset=t.meshOffset,h.textOffset=t.textOffset,h.opaqueLevelEnd=t.opaqueLevelEnd,h.bodyWorldMatrixUniformBlock=t.bodyWorldMatrixUniformBlock,h.bodyWorldMatrixOffset=t.bodyWorldMatrixOffset,h.bodyWorldMatrixUniformMap=t.bodyWorldMatrixUniformMap,h.bodyWorldMatrixUniformMapSize=t.bodyWorldMatrixUniformMapSize,h.pointOffset=t.pointOffset,h}function d(e){var t,r={};for(t in e)r[t]=e[t];return r}var t,i=this.viewer.ndsModel.activeModel,n=new NDSWebViewer.NdsMCAD2d(this.viewer,i.modelUri);for(t in i)n[t]=i[t];let o=new Set,s=new Set,a=new Set,l=new Set;!function t(r){if(r.prims&&(r.prims[0].forEach(function(e,t){o.add(t)}),r.prims[1].forEach(function(e,t){s.add(t)}),r.prims[2].forEach(function(e,t){a.add(t)}),r.prims[3].forEach(function(e,t){l.add(t)})),r.children)for(let e=0;e<r.children.length;e++)t(r.children[e])}(e),n.meshSets=[];let h=null;for(let e=0;e<i.meshSets.length;e++){var c=i.meshSets[e];for(let e=0,t=c.getNumLineSegments();e<t;++e){var f=c.getLineSegmentsId(e);s.has(f)&&((h=h||r(n,c)).lineCount++,h.lines.push(f),h.drawingLines.push(c.drawingLines[e]),function(t,r,i,n){for(let e=0;e<r.line2Worlds.length;e++){var o;if(r.line2Worlds[e].localIndex==i)return(o=d(r.line2Worlds[e])).drawingIndex=n,t.line2Worlds.push(o)}for(let e=0;e<r.line2Meshes.length;e++){var s;if(r.line2Meshes[e].localIndex==i)return(s=d(r.line2Meshes[e])).drawingIndex=n,t.line2Meshes.push(s)}for(let e=0;e<r.ltMeshs.length;e++){var a;if(r.ltMeshs[e].localIndex==i)return(a=d(r.ltMeshs[e])).drawingIndex=n,t.ltMeshs.push(a)}for(let e=0;e<r.ltLines.length;e++){var l;if(r.ltLines[e].localIndex==i)return(l=d(r.ltLines[e])).drawingIndex=n,t.ltLines.push(l)}for(let e=0;e<r.ltPoints.length;e++){var h;if(r.ltPoints[e].localIndex==i)return(h=d(r.ltPoints[e])).drawingIndex=n,t.ltPoints.push(h)}}(h,c,e,h.drawingLines.length-1))}for(let e=0,t=c.getNumMeshes();e<t;++e){var m=c.getMeshId(e);o.has(m)&&(h=h||r(n,c),c.opaqueMeshes[e])&&(h.meshCount++,h.meshes.push(m),h.opaqueMeshes.push(c.opaqueMeshes[e]),c.opaqueMeshes[e].hasMap)&&h.mapMeshes.push(c.opaqueMeshes[e])}for(let e=0,t=c.getNumTTFTexts();e<t;++e){var u=c.getTTFTextId(e);l.has(u)&&((h=h||r(n,c)).ttfCount++,h.ttfTexts.push(u),h.texts.push(u),h.drawTTFTexts.push(c.drawTTFTexts[e]))}for(let e=0,t=c.getNumSHXTexts();e<t;++e){var p=c.getSHXTextId(e);l.has(p)&&((h=h||r(n,c)).shxCount++,h.shxTexts.push(p),h.texts.push(p),h.drawSHXTexts.push(c.drawSHXTexts[e]))}for(let e=0,t=c.getNumPoints();e<t;++e){var x=c.getPointId(e);a.has(x)&&((h=h||r(n,c)).pointCount++,h.points.push(x),h.drawPoints.push(c.drawPoints[e]))}h&&n.meshSets.push(h),h=null}return n}_createNdsModelSet2(i,e){function n(e,t){for(var r=0;r<16;r++)if(1e-7<Math.abs(e[r]-t[r]))return;return 1}function o(e,t){return(g=new NDSWebViewer.MCAD2DMeshSet(e)).needsUpdate=!1,g.lineOffset=t.lineOffset,g.meshOffset=t.meshOffset,g.textOffset=t.textOffset,g.opaqueLevelEnd=t.opaqueLevelEnd,g.bodyWorldMatrixUniformBlock=t.bodyWorldMatrixUniformBlock,g.bodyWorldMatrixOffset=t.bodyWorldMatrixOffset,g.pointOffset=t.pointOffset,g}function d(e){var t,r={};for(t in e)r[t]=e[t];return r}var t,r=this.viewer.ndsModel.activeModel,s=new NDSWebViewer.NdsMCAD2d(this.viewer,r.modelUri);for(t in r)s[t]=r[t];var a=[],l=[],h=[],c=[],f=[],m=[];for(let e=0;e<i.length;e++){var u=i[e],p=u.geometry;let t=-1,r=-1;for(let e=0;e<this.viewer.ndsModel.geomManager.geoms.length;e++)if(this.viewer.ndsModel.geomManager.geoms[e].uuid==p){r=e;break}if(-1!=r)if(0==u.geomType){for(let e=0;e<s.meshManager.geomId.length;e++)if(s.meshManager.geomId[e]==r){t=e;for(var x=0;x<16;++x)a[x]=s.meshManager.matrixes[16*s.meshManager.matrixId[t]+x];if(n(a,u.matrix))break;t=-1}-1!=t&&c.push(t)}else if(1==u.geomType||2==u.geomType){for(let e=0;e<s.meshManager.lineSegGeomId.length;e++)if(s.meshManager.lineSegGeomId[e]==r){t=e;for(x=0;x<16;++x)a[x]=s.meshManager.matrixes[16*s.meshManager.lineSegMatrixId[t]+x];if(n(a,u.matrix))break;t=-1}-1!=t&&(1==u.geomType?l:h).push(t)}else if(3==u.geomType){for(let e=0;e<s.meshManager.textGeomId.length;e++)if(s.meshManager.textGeomId[e]==r){t=e;for(x=0;x<16;++x)a[x]=s.meshManager.matrixes[16*s.meshManager.textMatrixId[t]+x];if(n(a,u.matrix))break;t=-1}-1!=t&&(this.viewer.ndsModel.geomManager.geoms[r].isTTF?f:m).push(t)}}s.meshSets=[];let g=null;for(let e=0;e<r.meshSets.length;e++){var w=r.meshSets[e];for(let r=0;r<l.length;r++)for(let e=0,t=w.getNumLineSegments();e<t;++e){var b=w.getLineSegmentsId(e);if(b===l[r]){(g=g||o(s,w)).lineCount++,g.lines.push(b),g.drawingLines.push(w.drawingLines[e]),!function(t,r,i,n){for(let e=0;e<r.line2Worlds.length;e++){var o;if(r.line2Worlds[e].localIndex==i)return(o=d(r.line2Worlds[e])).drawingIndex=n,t.line2Worlds.push(o)}for(let e=0;e<r.line2Meshes.length;e++){var s;if(r.line2Meshes[e].localIndex==i)return(s=d(r.line2Meshes[e])).drawingIndex=n,t.line2Meshes.push(s)}for(let e=0;e<r.ltMeshs.length;e++){var a;if(r.ltMeshs[e].localIndex==i)return(a=d(r.ltMeshs[e])).drawingIndex=n,t.ltMeshs.push(a)}for(let e=0;e<r.ltLines.length;e++){var l;if(r.ltLines[e].localIndex==i)return(l=d(r.ltLines[e])).drawingIndex=n,t.ltLines.push(l)}for(let e=0;e<r.ltPoints.length;e++){var h;if(r.ltPoints[e].localIndex==i)return(h=d(r.ltPoints[e])).drawingIndex=n,t.ltPoints.push(h)}}(g,w,e,g.drawingLines.length-1);break}}for(let r=0;r<c.length;r++)for(let e=0,t=w.getNumMeshes();e<t;++e){var M=w.getMeshId(e);if(M===c[r]){g=g||o(s,w),w.opaqueMeshes[e]&&(g.meshCount++,g.meshes.push(M),g.opaqueMeshes.push(w.opaqueMeshes[e]),w.opaqueMeshes[e].hasMap)&&g.mapMeshes.push(w.opaqueMeshes[e]);break}}for(let r=0;r<f.length;r++)for(let e=0,t=w.getNumTTFTexts();e<t;++e){var v=w.getTTFTextId(e);if(v===f[r]){g||((g=new NDSWebViewer.MCAD2DMeshSet(s)).needsUpdate=!1,g.lineOffset=w.lineOffset,g.meshOffset=w.meshOffset,g.textOffset=w.textOffset,g.bodyWorldMatrixUniformBlock=w.bodyWorldMatrixUniformBlock),g.ttfCount++,g.ttfTexts.push(v),g.texts.push(v),g.drawTTFTexts.push(w.drawTTFTexts[e]);break}}for(let r=0;r<m.length;r++)for(let e=0,t=w.getNumSHXTexts();e<t;++e){var E=w.getSHXTextId(e);if(E===m[r]){(g=g||o(s,w)).shxCount++,g.shxTexts.push(E),g.texts.push(E),g.drawSHXTexts.push(w.drawSHXTexts[e]);break}}for(let r=0;r<h.length;r++)for(let e=0,t=w.getNumPoints();e<t;++e){var T=w.getPointId(e);if(T===h[r]){(g=g||o(s,w)).pointCount++,g.points.push(T),g.drawPoints.push(w.drawPoints[e]);break}}g&&s.meshSets.push(g),g=null}return s}_checkBlockNotEmtpty(t){if(t.geometries&&0<t.geometries.length)return!0;if(t.children)for(let e=0;e<t.children.length;e++)if(this._checkBlockNotEmtpty(t.children[e]))return!0;return!1}_createBlockInfo(){if(this.viewer&&this.viewer.ndsModel.activeModel.modelObjectsData&&2!==this.blockType){this.blockType=2,this.blockMap.clear();let e=this;function r(t){if(2===t.type)e.blockMap.has(t.name)?e.blockMap.get(t.name).push(t):e.blockMap.set(t.name,[t]);else if(t.children&&3==t.type)for(let e=0;e<t.children.length;e++)r(t.children[e])}r(this.viewer.ndsModel.activeModel.modelObjectsData)}else if(this.viewer&&this.viewer.blockInfo&&!this.viewer.blockInfo.process){this.blockType=1,this.viewer.blockInfo.process=!0,this.blockMap.clear();var e=this.viewer.blockInfo.blockTable;if(e){let o=this;function r(t){if(t.user&&o._checkBlockNotEmtpty(t))o.blockMap.has(t.name)?o.blockMap.get(t.name).push(t):o.blockMap.set(t.name,[t]);else if(t.children)for(let e=0;e<t.children.length;e++)r(t.children[e])}!function t(r){if(r.bbox=new THREE.Box3,r.children)for(let e=0;e<r.children.length;e++)t(r.children[e]),r.bbox.union(r.children[e].bbox);if(r.geometries)for(let e=0;e<r.geometries.length;e++){var i,n=r.geometries[e].geometry;(n=o.viewer.ndsModel.meshManager.geomManager.getGeomFromUuid(n,0))&&n.drawRange&&1<n.drawRange.count&&(i=(new THREE.Matrix4).fromArray(r.geometries[e].matrix),(n=n.boundingBox.clone()).applyMatrix4(i),r.bbox.union(n))}}(e),r(e)}}}_moveCameraTo(e){var t=new THREE.Vector3,e=(e.getCenter(t),4*(Math.max(e.max.x-e.min.x,e.max.y-e.min.y)+4)),r=this.viewer.renderer.domElement,r=(r.height,r.width,new THREE.Vector3),t=(r.set(t.x,t.y,t.z),this.viewer.camera.target.clone().sub(this.viewer.camera.position).normalize()),e=(t.multiplyScalar(e),r.clone().sub(t));this.viewer.camera.far<e.z&&(this.viewer.camera.far=e.z+1),this.viewer.camera.near>r.z&&(this.viewer.camera.near=r.z-1),this.viewer.camera.position.set(e.x,e.y,e.z),this.viewer.camera.setCameraTarget(r),this.viewer.camera.updateProjectionMatrix(),this.viewer.camera.updateMatrixWorld(!0),this.viewer.render()}_boxToVectices(e){var t=new Float32Array(36);return t[0]=e.min.x,t[1]=e.min.y,t[2]=0,t[3]=e.min.x,t[4]=e.max.y,t[5]=0,t[6]=e.min.x,t[7]=e.max.y,t[8]=0,t[9]=e.max.x,t[10]=e.max.y,t[11]=0,t[12]=e.max.x,t[13]=e.max.y,t[14]=0,t[15]=e.max.x,t[16]=e.min.y,t[17]=0,t[18]=e.max.x,t[19]=e.min.y,t[20]=0,t[21]=e.min.x,t[22]=e.min.y,t[23]=0,t[24]=e.max.x,t[25]=e.max.y,t[26]=0,t[27]=e.min.x,t[28]=e.min.y,t[29]=0,t[30]=e.min.x,t[31]=e.max.y,t[32]=0,t[33]=e.max.x,t[34]=e.min.y,t[35]=0,t}_getBoxPoints(e,t){let r=e.x,i=t.x,n=e.y,o=t.y;var e=this.viewer.renderer.domElement,t=this.viewer.renderer.getPixelRatio(),s=(r>i&&([r,i]=[i,r]),n>o&&([n,o]=[o,n]),r*t/e.width*2-1),a=i*t/e.width*2-1,l=2*-(n*t/e.height)+1,t=2*-(o*t/e.height)+1,e=new THREE.Vector3(0,0,0),h=(e.copy(this.viewer.camera.target),e.project(this.viewer.camera),new THREE.Vector3(s,l,e.z)),l=new THREE.Vector3(a,l,e.z),a=new THREE.Vector3(a,t,e.z),s=new THREE.Vector3(s,t,e.z),t=[];return t.push(h.unproject(this.viewer.camera)),t.push(l.unproject(this.viewer.camera)),t.push(a.unproject(this.viewer.camera)),t.push(s.unproject(this.viewer.camera)),t}_checkBlockVisible(t){if(1===this.blockType){if(t.geometries)for(let e=0;e<t.geometries.length;e++){var r=this.viewer.ndsModel.getBodyNodeFromUuid(t.geometries[e].layer);if(r&&r.isHidden())return!1}if(t.children)for(let e=0;e<t.children.length;e++)if(!this._checkBlockVisible(t.children[e]))return!1}else if(2===this.blockType){var e,i,n,o,s=t.prims[0],a=t.prims[1],l=t.prims[2],h=t.prims[3],d=this.viewer.ndsModel.activeModel.meshManager;for(e of s)if(d.bodyNodes[e[0]].isHidden())return!1;for(i of a)if(d.lineSegBodyNodes[i[0]].isHidden())return!1;for(n of l)if(d.lineSegBodyNodes[n[0]].isHidden())return!1;for(o of h)if(d.textBodyNodes[o[0]].isHidden())return!1}return!0}_clearBlockBox(){var e=this.rootObject.children.findIndex(e=>"blockBox"==e.name);-1<e&&(this.rootObject.children.splice(e,1),this.viewer.render())}_clearBlockFlag(){var e;this.rootObject&&-1<(e=this.rootObject.children.findIndex(e=>"textGroup"==e.name))&&(this.rootObject.children.splice(e,1),this.viewer.render())}_drawTextRect(e,t,r="selectArea",i){e=new THREE.LineBasicMaterial({color:e}),t=(new THREE.BufferGeometry).setFromPoints(t),t=new THREE.LineLoop(t,e);i&&(t.matrixWorld.copy(i),t.matrixWorldNeedsUpdate=!0),t.name=r,this.rootObject.add(t),this.viewer.render()}_creatFindTextMesh(e){var t=new THREE.MeshBasicMaterial({color:"#FF0000"}),r=new THREE.CircleGeometry(2,32),r=new THREE.InstancedMesh(r,t,e.length),i=(r.name="circle",new THREE.PlaneGeometry(.5,6)),i=new THREE.InstancedMesh(i,t,e.length),t=(i.name="plane",new THREE.Group);t.name="textGroup",t.posArr=e,t.add(r),t.add(i),t.visible=!1,this.rootObject.add(t),this.viewer.render()}_findTextIconUpdate(){if(this.rootObject.visible){var t=this.rootObject.children.findIndex(e=>"textGroup"==e.name);if(-1!=t){let l=new THREE.Object3D,e=this.rootObject.children[t];e.visible=!0;t=this.viewer.controls.getBoundingBox();if(t){t=t.getCenter(new THREE.Vector3);if(t){var t=t.clone(),r=this.viewer.camera.getCameraTarget(),h=this.viewer.camera.position,d=new THREE.Vector3,r=(d.subVectors(r,h),t.clone()),t=this.viewer.camera.isPerspective?r.sub(h).dot(d.normalize()):1.2*d.length(),r=this.viewer.camera.fov,h=2*t*Math.tan(THREE.Math.degToRad(.5*r)),d=this.viewer.renderer.domElement.height;let i=5*h*this.viewer.renderer.getPixelRatio()/d;i<1e-5&&(i=1e-5);t=this.viewer.camera.up.angleTo(new THREE.Vector3(0,1,0));let n=new THREE.Quaternion,o=(n.setFromAxisAngle(new THREE.Vector3(0,0,1),t),new THREE.Matrix4),s=(o.makeRotationFromQuaternion(n),new THREE.Matrix4),a=new THREE.Matrix4;e.children.forEach(r=>{e.posArr.forEach((e,t)=>{s.makeTranslation(-e.x,-e.y,-e.z),a.makeTranslation(e.x,e.y,e.z),l.position.set(e.x,e.y,e.z),l.quaternion.copy(n),l.scale.set(i,i,i),l.updateMatrix(),"circle"==r.name&&(l.matrix.elements[13]=l.matrix.elements[13]+3*i,l.matrix.premultiply(s),l.matrix.premultiply(o),l.matrix.premultiply(a)),r.setMatrixAt(t,l.matrix)}),r.instanceMatrix.needsUpdate=!0,r.computeBoundingSphere()})}}}}}}r=new o;NDSWebViewer.ExtensionManager.addExtension(r)}],i={},n.m=r,n.c=i,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)n.d(r,i,function(e){return t[e]}.bind(null,i));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=0);function n(e){var t;return(i[e]||(t=i[e]={i:e,l:!1,exports:{}},r[e].call(t.exports,t,t.exports,n),t.l=!0,t)).exports}var r,i});