# 里程碑动态审批流（每里程碑绑定流程定义 + 表单）更改方案

更新时间：2025-12-16  
适用范围：`PDM / 项目管理 / 里程碑`

## 1. 目标与边界

### 1.1 目标
- 一个项目包含多个里程碑，每个里程碑可独立配置是否走审批、走哪条审批流、绑定哪张业务表单。
- 审批流定义由 `WorkflowHost(Elsa)` 维护，前端从宿主查询列表，保存 `workflowDefinitionId` 到里程碑。
- 待办点击“办理”可自动打开里程碑审批执行页，完成同意/驳回/撤回等动作。

### 1.2 关键约定（必须统一）
- 关联键：`correlationId = milestoneId`（工作流实例与业务里程碑强关联）。
- 表单绑定：里程碑与表单为**一对一**关系，字段为 `formId`（单值）。
- 流程定义：不允许重命名（已确认），因此 `workflowDefinitionId` 为唯一权威标识。
- 启动口径：后端启动流程必须按 `workflowDefinitionId`（Elsa `definitionId`）启动，而不是按实体 `[WorkflowName]` 的 `workflowName` 路由键启动（两者不是一回事）。

### 1.3 非目标
- 不在本次范围：将里程碑审批“注册/发现”升级为 `workflowName` 动态路由到业务服务（除非后续需要宿主统一查询业务实体待办/历史）。

## 2. 数据字段（后端口径）

里程碑（Milestone）关键字段：
- `isApproval: boolean` 是否需要审批
- `workflowDefinitionId?: string` 审批流定义 ID（Elsa）
- `formId?: string` 绑定表单 ID（ProjectForm，一对一）
- 运行期字段（已有则保持）：`workflowInstanceId/currentActivityName/workflowStatus/activityId/...`

## 3. 前端改动范围（caimen-react）

### 3.1 项目编辑页：里程碑表格（必做）
目标：编辑项目时可在里程碑行内配置 `isApproval + workflowDefinitionId + formId`。

- 新增“审批流程”列（`workflowDefinitionId`），并与 `isApproval` 做联动（勾选审批必填，否则置灰）  
  - `src/pages/appPdm/ProjectManagement/ProjectList/Edit/schema.ts`
- “关联表单”字段收敛为单值 `formId`（从 `formIds[]` 多选收敛）  
  - `src/pages/appPdm/ProjectManagement/ProjectList/Edit/schema.ts`
- 接入流程定义选择组件（从宿主 `/elsa/api/workflow-definitions` 拉取定义列表）  
  - `src/pages/appPdm/ProjectManagement/ProjectList/Edit/index.tsx`
  - 组件：`src/pages/appWorkflow/_utils/workflowDefinitionSelect.tsx`

### 3.2 模板导入 / 项目加载 / 提交映射（必做）
目标：保证模板导入、加载回填、提交保存时字段一致，避免 `formIds` 与 `formId` 口径冲突。

- 模板导入里程碑：输出 `formId`（单值）  
  - `src/pages/appPdm/_formWidgets/ProjectTemplateSelect.tsx`
- 项目加载回填：保留后端返回的 `formId`（不再转 `formIds[]`）  
  - `src/pages/appPdm/ProjectManagement/ProjectList/Edit/index.tsx`
- 项目提交转换：移除 `formIds[] -> formId` 的旧逻辑，保持单值 `formId`  
  - `src/pages/appPdm/ProjectManagement/ProjectList/Edit/index.tsx`

### 3.3 待办打开审批页（复用现状）
目标：待办点击办理自动打开里程碑执行页，并携带必要参数。

- 待办页按 WorkflowDefinitionSetting 的 `defaultForm` 跳转，并拼接：`workItemId/definitionId/workflowInstanceId/correlationId/activityId`  
  - `src/pages/appWorkflow/workflowSelf/doing/index.tsx`
- 里程碑审批执行页消费这些参数并调用后端执行接口  
  - `src/pages/appPdm/ProjectManagement/MilestoneList/execute.tsx`

## 4. 后端改动范围（Burn.Abp.Pdm）

### 4.1 CRUD：保存里程碑绑定信息（必做）
- Create/Update 项目或里程碑时，必须保存：
  - `isApproval`
  - `workflowDefinitionId`
  - `formId`
- 建议约束：
  - 里程碑进入审批/运行后禁止修改 `workflowDefinitionId/formId`（避免实例与绑定割裂）。

### 4.2 Complete：完成里程碑时的审批分支（必做）
接口：`POST /api/pdm/project-milestone/{id}/complete`

后端逻辑建议：
1. 若里程碑绑定 `formId`：校验该里程碑表单数据已提交（否则阻止完成）。
2. 若 `isApproval == true`：
   - 校验 `workflowDefinitionId` 非空。
   - 调用 WorkflowHost 启动流程（按 `workflowDefinitionId` 启动，并设置 `correlationId = milestoneId`）。
   - 写入/更新 `workflowInstanceId/workflowStatus/currentActivity...`（或写入 Proxy/Bookmarks）。
3. 若 `isApproval == false`：直接完成里程碑并推进下一里程碑（保持既有业务规则）。

### 4.3 Execute/Reject/Cancel：审批动作执行（必做）
接口（前端已调用）：
- `POST /api/pdm/project-milestone/{id}/execute-workflow`
- `POST /api/pdm/project-milestone/{id}/reject`
- `POST /api/pdm/project-milestone/{id}/cancel`

实现要点：
- 执行前校验 `workflowInstanceId` 非空且状态为 Running。
- `activityId` 必须来自待办数据（WorkItem），禁止前端硬编码猜测。
- 调用宿主执行服务后，确保回调落库更新状态与书签（用于后续待办/历史展示）。

### 4.4 表单数据：提交与回显（必做）
接口（前端已存在）：
- `GET /api/pdm/project-milestone/form-data/{milestoneId}`
- `POST /api/pdm/project-milestone/submit-form-data`

约束建议：
- `complete` 前若配置了 `formId`，必须校验存在已提交的数据（或满足你们的“提交态”规则）。

## 5. WorkflowHost(Elsa) 配置（必做）

对所有“用于里程碑审批”的流程定义设置：
- `WorkflowDefinitionSetting.defaultForm = /appPdm/ProjectManagement/MilestoneList/execute`

作用：待办“办理”会自动跳转到里程碑审批执行页并携带所需参数。

## 6. 联调与验收清单
- 能在“项目编辑页”对每个里程碑配置：`isApproval / workflowDefinitionId / formId`，保存后再次打开回显正确。
- 配置了 `isApproval=true` 的里程碑，点击完成后会启动流程实例，生成待办。
- 待办点击“办理”能打开 `MilestoneList/execute`，并能同意/驳回，回到待办列表后状态更新。
- 配置了 `formId` 的里程碑：未提交表单数据时 `complete` 被阻止；提交后允许继续。

## 7. 风险与控制
- 风险：审批运行中仍允许修改 `workflowDefinitionId/formId` → 会导致实例与业务绑定割裂。  
  建议：后端状态机约束（Draft 可改，Submitted/Running 不可改）。
- 风险：WorkflowHost 未配置 `defaultForm` → 待办会打开错误页面或通用页面。  
  建议：上线前对相关流程定义做配置核对清单。
