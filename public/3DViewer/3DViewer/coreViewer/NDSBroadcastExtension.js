!function(){"use strict";class e{constructor(e){this.__meshstate__=e}getMeshMaterial(e){return this.__meshstate__.getMeshMaterial(e)}setMeshMaterial(e,t){this.__meshstate__.setMeshMaterial(e,t)}setMeshMaterialTemporary(e,t){let r=this.__meshstate__.meshMtls.get(e);if(r){let e=r.material;r.material=t,this.__meshstate__.__updateMeshMtlBuffer(r.meshMtlIndex,r),this.__meshstate__.meshMtlTexture.needsUpdate=!0,r.material=e,r.meshSet.needsUpdate=!0,r.meshSet.prepareForBatchDraw()}}getLineMaterial(e){this.__meshstate__.getLineMaterial(e)}setLineMaterial(e,t,r){this.__meshstate__.setLineMaterial(e,t,r)}setLineMaterialTemporary(e,t,r){let s=this.__meshstate__.lineMtls.get(e);if(s){let e=2*s.lineMtlIndex;this.__meshstate__.lineMtlBuffer[e]=t,this.__meshstate__.lineMtlBuffer[e+1]=Math.round(1e3*r),this.__meshstate__.lineMtlTexture.needsUpdate=!0}}}class t{constructor(e){this.__brepManager__=e}hasBrepInfo(){return this.__brepManager__.hasBrepInfo()}hasBrepFile(){return this.__brepManager__.hasBrepFile()}}
/**
	 * @file 这是新迪轻量化引擎查看器插件框架代码，请不要修改此文件
	 * @copyright 新迪数字 2024
	 */class r{constructor(r){this.__ndsModel__=r,r.meshState&&(this.__meshState__=new e(r.meshState)),r.brepManager&&(this.__brepManager__=new t(r.brepManager))}get isMCAD3DModel(){return this.__ndsModel__.isMCAD3DModel}get isMCAD2DModel(){return this.__ndsModel__.isMCAD2DModel}get typeName(){return this.__ndsModel__.typeName}get ndsModelId(){return this.__ndsModel__.id}get numMesh(){}getMeshState(){return this.__meshState__}getBrepManager(){return this.__brepManager__}getPMIObject(){return this.__ndsModel__.pmiObject}getRootBodyNode(){return this.__ndsModel__.rootBodyNode}getBodyNode(e){return this.__ndsModel__.getBodyNode(e)}getLeafBodies(e){return this.__ndsModel__.getLeafBodies(e)}isSketchModel(){return!!this.__ndsModel__.isSketchModel}getLeafBodyNodes(){return this.__ndsModel__.wholeLeafBodyNodes}transparentizeBodies(e){this.__ndsModel__.transparentizeBodies(e)}isolateBodies(e){this.__ndsModel__.isolateBodies(e,NDSWebViewer.SETTING.bodyOpacity,NDSWebViewer.SETTING.lineOpacity)}clearTransparentBodies(){this.__ndsModel__.exitIsolate()}getMeshSets(){return this.__ndsModel__.getMeshSets()}changeObjectidTouuid(e){return this.__ndsModel__.objectidTouuid[e]}getMeshMaterial(e){if(!this.__ndsModel__)return null;let t=this.__ndsModel__.meshManager.materialId[e],r=this.__ndsModel__.meshManager.materialUuids[t];return this.__ndsModel__.meshManager.materials[r].mat}setMeshMaterial(e,t){if(!this.__ndsModel__)return!1;let r=this.__ndsModel__,s=0;if(r.meshManager.materials[t.uuid]){for(let e=0;e<r.meshManager.materialUuids.length;e++)if(r.meshManager.materialUuids[e]===t.uuid){s=e;break}}else r.meshManager.materials[t.uuid]={mat:t,refCount:0},s=r.meshManager.materialUuids.length,r.meshManager.materialUuids.push(t.uuid);let i=r.meshManager.materialId[e],a=r.meshManager.materialUuids[i];return r.meshManager.materials[a].refCount--,r.meshManager.materials[t.uuid].refCount++,r.meshManager.materialId[e]=s,r.meshManager.materialIdOriginal[e]=s,!0}removeAllBodyNodeMaterials(){this.__ndsModel__.removeAllBodyNodeMaterials()}refreshBodyWorldMatrixUniforms(){this.__ndsModel__.refreshBodyWorldMatrixUniforms()}refreshMeshState(e=void 0){this.__ndsModel__.refreshMeshState(e||this.__ndsModel__.rootBodyNode)}}
/**
	 * @file 这是新迪轻量化引擎查看器插件框架代码，请不要修改此文件
	 * @copyright 新迪数字 2024
	 */console.log("NDS ExtensionFramework V0.1");const s={FLAG_ENABLE_NODE_TRANSFORM:NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM,FLAG_ENABLE_NODE_STOREVIEW:NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM<<1,FLAG_ENABLE_NODE_CAMERA2D:NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM<<2,FLAG_ENABLE_NODE_BLOCK:NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM<<3,FLAG_ENABLE_NODE_TEXT:NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM<<4,FLAG_ENABLE_NODE_BROADCAST:NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM<<5};class i extends NDSWebViewer.Extension{constructor(){super()}onLoad(e){}onInitLights(){}update(e){}setFlags(e){super.setFlags(e)}onNdsModelPrepareForRendering(e){}onBeforeNdsModelUpdate(e,t){}onAfterNdsModelUpdate(e,t){}onBeforeNdsModelSetRender(e,t){}onAfterNdsModelSetRender(e,t){}onBeforeNdsMeshRender(e,t){}getExtensionWithFlags(e){return NDSWebViewer.ExtensionManager.getExtensionWithFlags(e)}resetToDefault(){}getStoreInfo(e){throw this.name+" Extesion did not implement method 'getStoreInfo' "}setStoreInfo(e){throw this.name+" Extesion did not implement method 'setStoreInfo' "}getBodyTransform(e){return new THREE.Matrix4}getBodyNodeTranslate(e){return new THREE.Vector3(0,0,0)}}
/**
	 * @file 这是新迪轻量化引擎查看器插件框架代码，请不要修改此文件
	 * @copyright 新迪数字 2024
	 */class a{static getModel(e){return e.ndsModel}static getModelId(e){return e.ndsModel.id}static getUUID(e){return e.uuid}static getObjectId(e){return e.objectid}static getId(e){return e.id}static getBodyNodeMaterial(e){let t=e.getMaterialBodyNodeUUid();return t&&e.useBodyNodeMaterial?e.ndsModel.bodyNodeUUidToMaterial[t]:null}static setBodyNodeMaterial(e,t){e.ndsModel.bodyNodeUUidToMaterial[e.uuid]=t,e.useBodyNodeMaterial=!!t}static getUserMaterial(e){return e.getUserMaterial()}static setUserMaterial(e,t){e.setUserMaterial(t)}static getBoundingBox(e){var t=new THREE.Box3;return e.getBoundingBox(t,!0)}static isLeafBodyNode(e){return!!e.leafBodyAttri}static isPartBodyNode(e){return"Part"===e.type}static getLeafBodyNodes(e){return e.ndsModel.getLeafBodies(e)}static getMeshesInLeafBodyNode(e){return e.leafBodyAttri?e.leafBodyAttri.bodyMeshIds:[]}static getMatrixLocal(e){return e.matrix}static getMatrixWorld(e){return e.worldMatrix}static setMatrixWorld(e,t){e.setMatrixWorld(t)}static applyTransform(e,t=null){e.applyTransform(t)}static updateMatrixWorld(e,t=!1){e.updateMatrixWorld(t,!0)}static hide(e){e.hide(),e.ndsModel.hideBodies.push(e)}static show(e){e.show(),e.ndsModel.RemoveElement(e.ndsModel.hideBodies,e)}static isPreSelected(e){return e.isPreSelected()}static isSelected(e){return e.isSelected()}static isTransparent(e){return e.isTransparent()}static isHidden(e){return e.isHidden()}static isIsolated(e){return e.isIsolated()}static getRenderMode(e){switch(e.renderMode){case 3:return"wireframe";case 4:return"hiddenLineRemove";case 5:return"hiddenLineVisible"}return""}static getBodyNodeTranslate(e,t){let r=new THREE.Vector3(0,0,0),i=e.getExtensionWithFlags(s.FLAG_ENABLE_NODE_TRANSFORM);for(let e=0,s=i.length;e<s;++e)r.add(i[e].getBodyNodeTranslate(t));return r}static updateNodeMatrix(e,t){e.ndsModel.updateNodeMatrix(e.uuid,t,e.getModel().id)}static hideBody(e){e.ndsModel.hideBody(e)}static showBody(e){e.ndsModel.showBody(e)}}
/**
	 * @file 这是新迪轻量化引擎查看器插件框架代码，请不要修改此文件
	 * @copyright 新迪数字 2024
	 */class o{static getBodyNodes(e){return e.bodyNodes}static updateMeshSetRenderMode(e,t,r){return e.updateMeshSetRenderMode(t,r)}static containsBodyNode(e,t){return e.containsBodyNode(t)}static getRenderMode(e){return e.renderMode}static setRenderMode(e,t){e.renderMode=t}}
/**
	 * @file 这是新迪轻量化引擎查看器插件框架代码，请不要修改此文件
	 * @copyright 新迪数字 2024
	 */class n{constructor(e){this.__coreView__=e}addEventListener(e,t){this.__coreView__.addEventListener(e,t)}hasEventListener(e,t){return this.__coreView__.hasEventListener(e,t)}removeEventListener(e,t){this.__coreView__.removeEventListener(e,t)}dispatchEvent(e){this.__coreView__.dispatchEvent(e)}getPixelRatio(){return this.__coreView__.renderer.getPixelRatio()}switchRotateCenterBySelection(){this.__coreView__.switchRotateCenterBySelection()}setDefaultEnvMap(e){e&&(this.__coreView__.hasPbrMaterial=!0,this.__coreView__.setDefaultEnvMap=()=>{this.__coreView__.setEnvMapEnabled(!0),this.__coreView__.defaultEnvMapTexture=e,this.__coreView__.updateEnvMap(this.__coreView__.defaultEnvMapTexture)},this.__coreView__.setDefaultEnvMap())}getBackgroundState(){return this.__coreView__.exchangeBackImage?{type:this.__coreView__.exchangeBackImage.type,value:this.__coreView__.exchangeBackImage.value}:void 0}setBackgroundState(e,t){"Image"===e?(this.__coreView__.setEnvMapTextures(null),this.__coreView__.setBackGroundImage(t)):"EnvMap"===e?this.__coreView__.setEnvMapTextures(t):"Color"===e&&(this.__coreView__.setEnvMapTextures(null),this.__coreView__.setBackGroundImage(null),this.__coreView__.setBackGroundColor(t))}removeAllLights(){this.__coreView__.lights.length=0}getLight(e){return this.__coreView__.lights[e]}setLight(e,t){this.__coreView__.lights[e]=t}getViewBox(){return this.__coreView__.viewBox}toggleAutoRotation(e){this.__coreView__.toggleAutoRotation(e)}randColor(){return this.__coreView__.materialsSetting.randColor()}getBoundingBox(e=!1){let t=this.__coreView__.ndsModel.getTotalBodyBoundingBox(null,e);return t.isEmpty()?this.__coreView__.modelRootObject.boundingBox:t}getModelTree(){return this.__coreView__.getModelTree()}getModelCount(){return this.__coreView__.ndsModel.models.length}setActiveModel(e){this.__coreView__.ndsModel.setActiveModel(e)}setActiveModelByModelId(e){let t=-1;for(let r=0;r<this.__coreView__.ndsModel.models.length;++r)if(this.__coreView__.ndsModel.models[r].id===e){t=r;break}this.setActiveModel(t)}getActiveModel(){return this.__coreView__.ndsModel.getActiveModel()}getModelById(e){return this.__coreView__.ndsModel.getModelById(e)}getModelByIndex(e){return this.__coreView__.ndsModel.models[e]}registOperator(e,t){this.__coreView__.registOperator(e,t)}setOperatorByID(e){this.__coreView__.setOperatorByID(e)}getCurrentOperator(){return this.__coreView__.controls.getOperator()}getCurrentOperatorID(){return this.__coreView__.getCurrentOperatorID()}getCurrentOperatorState(){return this.__coreView__.getCurrentOperatorState()}setOperator(e){this.__coreView__.setOperator(e)}registCursor(e,t,r){this.__coreView__.registCursor(e,t,r)}hideSelectedObjects(){this.__coreView__.hideSelectedObjects()}getViewControlBoundingBox(){return this.__coreView__.controls.getBoundingBox()}setViewControlBoundingBox(e,t){this.__coreView__.controls.setBoundingBox(e,t)}getCamera(){return this.__coreView__.camera}setCameraControlBoundingBoxCenter(e){this.__coreView__.cameraControl.setBoundingBoxCenter(e)}setCameraControlBounding(e,t){this.__coreView__.cameraControl.setBoundingBox(e,t)}getRotateCenter(){return this.__coreView__.cameraControl.getRotateCenter()}setRotateCenter(e){this.__coreView__.cameraControl.setRotateCenter(e)}getViewLockedState(){return this.__coreView__.cameraControl.isViewLockedBySingleBody}setViewLockedState(e){this.__coreView__.cameraControl.isViewLockedBySingleBody=e}getCameraInfo(){return this.__coreView__.cameraControl.getCameraInfo()}adjustNearAndFar(){this.__coreView__.cameraControl.adjustNearAndFar()}updateViewBoxCamDir(){this.__coreView__.cameraControl.updateViewBoxCamDir()}startSmoothTranslation(e){this.__coreView__.cameraControl.startSmoothTranslation(e)}zoomExtents(e,t,r){this.__coreView__.cameraControl.zoomExtents(e,t,r)}setCameraInfo(e,t){this.__coreView__.cameraControl.setCameraInfo(e,t)}getOrginalCameraInfo(){return this.__coreView__.viewManager?this.__coreView__.viewManager.getOrginalCameraInfo():this.__coreView__.camera.getOrginalCameraInfo()}setOrginalCameraInfo(e,t,r){this.__coreView__.camera.setOrginalCameraInfo({center:e,up:t,position:r})}toPerspectiveCamera(){this.__coreView__.toPerspectiveCamera()}toOrthographicCamera(){this.__coreView__.toOrthographicCamera()}updateGroundTransform(e,t,r){return this.__coreView__.groundShadow.updateGroundTransform(e,t,r)}isRendererContainsClipPlanes(){return this.__coreView__.renderer.clippingPlanes.length>0}getCanvas2D(){return this.__coreView__.canvas2D}getCanvas3D(){return this.__coreView__.canvas3D}getContainer(){return this.__coreView__.container}getRenderDomElement(){return this.__coreView__.renderer.domElement}getAdditionalObjectsScene(){return this.__coreView__.additionalObjectsScene}getDispalyModelUnit(e,t){return this.__coreView__.getDispalyModelUnit(e,t)}setDispalyModelUnit(e,t){return this.__coreView__.setDispalyModelUnit(e,t)}modelCoordToClientCoord(e){return this.__coreView__.modelCoordToClientCoord(e)}clientCoordToModelCoord(e){return this.__coreView__.clientCoordToModelCoord(e)}showObject(e,t,r,s=!0){this.__coreView__.showObject(e,t,r,s)}showObjectReversed(e){this.__coreView__.showObjectReversed(e)}renderAllViews(){this.__coreView__.renderAllViews()}render(e){this.__coreView__.render(e)}setRenderMode(e,t){this.__coreView__.setRenderMode(e,t)}getRenderMode(){let e;switch(this.__coreView__.getRenderMode()){case 0:e="lighting";break;case 1:e="primarycolor";break;case 2:e="wireframe";break;case 3:e="whitemold";break;case 4:e="shadedWithEdges";break;case 5:e="shaded";break;case 6:e="hiddenLineRemove";break;case 7:e="hiddenLineVisible";break;case 8:e="transparent"}return e}getAssemblyPMIState(){return this.__coreView__.AssemblyPMIState}setAssemblyPMIState(e){this.__coreView__.AssemblyPMIState=e}getPartPMIState(){return this.__coreView__.PartPMIState}setPartPMIState(e){this.__coreView__.PartPMIState=e}getPmiVisible(){return this.__coreView__.pmiVisible}setPmiVisible(e){this.__coreView__.pmiVisible=e}setPMIObjectVisible(e,t){this.__coreView__.setPMIObjectVisible(e,t)}isPMIOccludeByModel(){return!NDSWebViewer.SETTING.StopPMIOcclusion}enablePMIOccludeByModel(e){this.__coreView__.stopPMIOcclusion(!e)}getPmiList(){return this.__coreView__.PMINDSBodys}getPMIObjectByUUID(e,t=-1){return this.__coreView__.getPMIObjectByuuid(e,t)}isPMIObjectOrSomeChildHidden(e){return this.__coreView__.isPMIObjectOrSomeChildHidden(e)}isPMIObjectSelect(e){return this.__coreView__.isPMIObjectSelect(e)}getPmiObjectTree(){return this.__coreView__.pmiObject}getSelectedPmiList(){return this.__coreView__.getPMINDSBodySelectList()}selectPMIObject(e,t=!0){this.__coreView__.selectPMIObject(e,t)}deselectPMIObject(e,t=!0){this.__coreView__.deselectPMIObject(e,t)}unmergeBodyNode(){this.__coreView__.ndsModel.unmergeNode()}mergeBodyNode(){this.__coreView__.ndsModel.mergeNode()}getAllTransparentBodies(e){return this.__coreView__.ndsModel.getAllTransparentBodies(e)}isolateBodiesOnly(e){this.__coreView__.ndsModel.isolateBodiesOnly(e)}clearTransparentModeBodiesMap(){this.__coreView__.ndsModel.transparentModeBodiesMap.clear()}unloadModelById(e){this.__coreView__.unloadModelById(e)}startLoadAnimationModel(e){let t=e.url,r=e.id,s={needsPMI:!1,needsAnimation:!1,needsSketchModel:!1,position:e.position,pmiVisible:this.__coreView__.pmiVisible,modelId:e.modelId};this.__coreView__.loadModel(r,t,null,null,"js",null,null,null,s)}getBodyNodeFromUuid(e,t=-1){var r=null;if(t>=0){let s=this.getModelById(t);if(s){let t=s.getBodyNodeFromUuid(e);t&&(r=t)}}else this.__coreView__.ndsModel.models.forEach((t=>{let s=t.getBodyNodeFromUuid(e);s&&(r=s)}));return r}enableTransparent(e){this.__coreView__.enableTransparent(e)}getLineWidth(){return this.__coreView__.showLineWidth}setLineWidth(e){this.__coreView__.setLineWidth(e)}getViewManager(){return this.__coreView__.viewManager}switchViewport(e,t){return this.__coreView__.switchViewport(e,t)}}class d{constructor(e){this.__selectionManager__=e.selectionManager}getSelectedObjects(){return this.__selectionManager__.getSelectedObjects()}getSelectedMeshes(){return this.__selectionManager__.getSelectedMeshes()}clearSelection(){this.__selectionManager__.clearSelection()}setSelectType(e){this.__selectionManager__.setSelectType(e)}selectByClick(e,t){this.__selectionManager__.selectByClick(e,t)}selectObject(e,t,r){this.__selectionManager__.selectObject(e,t,r)}deselectObject(e,t){this.__selectionManager__.deselectObject(e,t)}}"undefined"!=typeof token&&token;const l=new class extends i{constructor(){super(),this.name="NDSBroadcastExtension",console.log("BroadcastExtension version 1.0.1")}onLoad(e){this.sceneWraper=new n(e),this.selectWraper=new d(e),this.viewer=e}resetModelState(e){e.meshVisible?a.hideBody(this.modelWraper.getRootBodyNode()):a.showBody(this.modelWraper.getRootBodyNode()),this.modelWraper.clearTransparentBodies();let t=this.modelWraper.getMeshSets();for(let e=0;e<t.length;++e){let r=t[e],s=o.getBodyNodes(r);if(void 0!==s&&void 0!==o.getRenderMode(r))for(let e=0;e<s.length;++e)o.updateMeshSetRenderMode(r,s[e],"")}}applyMeshState(e){if(!this.sceneWraper.getModelCount()>0)console.warn("ndsModel没有正确创建。请检查模型载入状态。");else{this.resetModelState(e);var t=this.selectWraper.getSelectedObjects();if(null!=e.meshSel&&e.meshSel.length>0){let a=this.sceneWraper.getModelById(e.id);a.meshManager.setSelectedMaterial(NDSWebViewer.SETTING.selectedMaterial,NDSWebViewer.SETTING.selectedLineMaterial);for(var r=0;r<e.meshSel.length;++r){var s,i=e.meshSel[r];(s=this.sceneWraper.getBodyNodeFromUuid(i,e.id))&&(a.addSelection(s),t.push(s))}}if(this.viewer.selectionManager.selectObjectList([]),e.meshVisible){let t;for(r=0;r<e.meshVisible.length;++r){var n=e.meshVisible[r];this.modelWraper.__ndsModel__.hasHiddenBodies=!0,t=this.modelWraper.getBodyNode(n),a.show(t)}}else if(e.meshInvisible){let t;for(r=0;r<e.meshInvisible.length;++r){n=e.meshInvisible[r];this.modelWraper.__ndsModel__.hasHiddenBodies=!0,t=this.modelWraper.getBodyNode(n),a.hide(t),a.setBodyNodeMaterial(t)}}if(e.meshTrans&&e.meshTrans.length>0){if(this.sceneWraper.getModelCount()>0){var d=[];for(r=0;r<e.meshTrans.length;++r){n=e.meshTrans[r];d.push(this.modelWraper.getBodyNode(n))}this.modelWraper.transparentizeBodies(d)}}else if(e.meshNoTrans)if(e.meshNoTrans.length>0){for(d=[],r=0;r<e.meshNoTrans.length;++r){n=e.meshNoTrans[r];d.push(this.modelWraper.getBodyNode(n))}this.modelWraper.isolateBodies(d)}else if(0==e.meshNoTrans.length){var l=[];l.push(this.modelWraper.getRootBodyNode()),this.modelWraper.transparentizeBodies(l)}if(void 0!==e.meshSetRenderInfos){let t=e.meshSetRenderInfos,r=this.modelWraper.getMeshSets();for(let e=0,s=t.length;e<s;++e){let s=t[e],i=r[s.index];if(!i)continue;o.setRenderMode(i,s.mode);let a=o.getBodyNodes(i),n=s.renderNodes;for(let e=0,t=n.length;e<t;++e){let t=n[e],r=a[t.index];o.updateMeshSetRenderMode(i,r,t.mode),""!==t.mode&&(this.viewer.singlePartMode=!0)}}}}}setBroadcastInfo(e,t){try{if(!NDSWebViewer.SETTING.enableBroadcast)return;if(null==e)return;let o={};switch(t){case 101:o.generalInfo=e;break;case 102:o.modelStates=e;break;case 103:o.PMIStates=e;break;case 104:o.Measure2DContent=e;break;case 105:o.measureState=e;break;case 106:o.clipInfo=e;break;case 107:o.explode=e;break;case 108:o.dragInfo=e;break;case 109:o.annotationInfo=e;break;case 110:break;case 111:o.viewerManagerInfo=e;break;case 112:o.textFindInfo=e}if(o.generalInfo&&this.applyGeneralInfo(o),o.modelStates){this.selectWraper.clearSelection();for(let e=0,t=o.modelStates.length;e<t;++e){let t=o.modelStates[e],s=t.id,i=t.auxiliaryLineVisible,n=this.sceneWraper.getModelById(s);n&&(this.modelWraper=new r(n),void 0!==i?i?a.showBody(this.modelWraper.getRootBodyNode()):a.hideBody(this.modelWraper.getRootBodyNode()):n.rootBodyNode&&this.applyMeshState(t),this.modelWraper=null)}}o.PMIStates&&this.applyPMIInfo(o.PMIStates),o.viewerManagerInfo&&this.setviewerManagerInfo(o.viewerManagerInfo);let n=NDSWebViewer.ExtensionManager.getExtensionWithFlags(s.FLAG_ENABLE_NODE_BROADCAST);for(let e=0;e<n.length;++e)n[e].onAfterSetBroadcastInfo(o);let d=this;var i=setInterval((function(){d.sceneWraper.renderAllViews()}),100);setTimeout((function(){clearInterval(i)}),500),this.sceneWraper.renderAllViews()}catch(e){console.error(e)}}startBroadcast(e){this.exitBroadcast(),NDSWebViewer.SETTING.enableBroadcast=!0,NDSWebViewer.SETTING.broadcastMajor=null!=e&&e;var t=this.sceneWraper.getCurrentOperator();let s=this.sceneWraper.getActiveModel();this.modelWraper=new r(s),"OpMeasure"==t.type&&this.modelWraper.isMCAD3DModel&&t.restrictMeasuretime();let i=NDSWebViewer.ExtensionManager.getExtension("ClipExtension");i&&(i.isSectionViewEnabled()||i.isClipBoxActive())&&(e?i.onOpenClipControl():i.onCloseClipControl())}exitBroadcast(){NDSWebViewer.SETTING.enableBroadcast=!1,NDSWebViewer.SETTING.broadcastMajor=!1}getRotationCenterInfo(e){let t=this.sceneWraper.getViewControlBoundingBox(),r=this.sceneWraper.getRotateCenter(),s=this.sceneWraper.getViewLockedState();r||(r=new THREE.Vector3,this.sceneWraper.getBoundingBox(!0).getCenter(r)),e.rotationCenterInfo={bound:{min:{x:t.min.x,y:t.min.y,z:t.min.z},max:{x:t.max.x,y:t.max.y,z:t.max.z}},center:{x:r.x,y:r.y,z:r.z},islocked:s}}applyRotationCenterInfo(e){if(null!=e.rotationCenterInfo){let r=e.rotationCenterInfo,s=r.bound,i=r.center;this.sceneWraper.setViewControlBoundingBox(new THREE.Vector3(s.min.x,s.min.y,s.min.z),new THREE.Vector3(s.max.x,s.max.y,s.max.z)),this.sceneWraper.setRotateCenter(new THREE.Vector3(i.x,i.y,i.z)),this.sceneWraper.setViewLockedState(r.islocked);var t=this.sceneWraper.getCurrentOperator();t&&t.updateRotateCenterHelper()}}getPMIInfo(e){var t=[],r=[],s=[],i=[];let o=this.sceneWraper.getPmiList();if(void 0!==o&&o.length>0){for(let e=0,n=o.length;e<n;++e)null!==a.getUUID(o[e])&&(this.sceneWraper.isPMIObjectOrSomeChildHidden(o[e])?i.push(`${a.getUUID(o[e])}&${a.getModelId(o[e])}`):r.push(`${a.getUUID(o[e])}&${a.getModelId(o[e])}`),this.sceneWraper.isPMIObjectSelect(o[e])?t.push(`${a.getUUID(o[e])}&${a.getModelId(o[e])}`):s.push(`${a.getUUID(o[e])}&${a.getModelId(o[e])}`));r.length>i.length?e.PMIObjectVisibleList=r:e.PMIObjectVisibleListNeg=i,t.length<s.length?e.PMIObjectSelList=t:e.PMIObjectSelListNeg=s}}applyPMIInfo(e){if(void 0!==e.PMIObjectVisibleList){this.sceneWraper.setPMIObjectVisible(this.sceneWraper.getPmiObjectTree(),!1);for(let t=0,r=e.PMIObjectVisibleList.length;t<r;t++){let r=e.PMIObjectVisibleList[t].split("&");this.sceneWraper.setPMIObjectVisible(this.sceneWraper.getPMIObjectByUUID(r[0],Number(r[1])),!0)}}if(void 0!==e.PMIObjectVisibleListNeg){this.sceneWraper.setPMIObjectVisible(this.sceneWraper.getPmiObjectTree(),!0);for(let t=0,r=e.PMIObjectVisibleListNeg.length;t<r;t++){let r=e.PMIObjectVisibleListNeg[t].split("&");this.sceneWraper.setPMIObjectVisible(this.sceneWraper.getPMIObjectByUUID(r[0],Number(r[1])),!1)}}if(void 0!==e.PMIObjectSelList){this.sceneWraper.deselectPMIObject(this.sceneWraper.getPmiObjectTree());for(let t=0,r=e.PMIObjectSelList.length;t<r;t++){let r=e.PMIObjectSelList[t].split("&");this.sceneWraper.selectPMIObject(this.sceneWraper.getPMIObjectByUUID(r[0],Number(r[1])))}}if(void 0!==e.PMIObjectSelListNeg){this.sceneWraper.selectPMIObject(this.sceneWraper.getPmiObjectTree());for(let t=0,r=e.PMIObjectSelListNeg.length;t<r;t++){let r=e.PMIObjectSelListNeg[t].split("&");this.sceneWraper.deselectPMIObject(this.sceneWraper.getPMIObjectByUUID(r[0],Number(r[1])))}}}getViewerManagerInfo(e){let t=this.sceneWraper.getViewManager();if(t){let r=t.getLayout().row,s=t.getLayout().col;e.bConnectView=t.getLayout().bConnectView,e.activeViewId=t.getLayout().activeView.viewId,e.enableViewManager=!0,1===r&&2===s?e.viewerManagerType="TwoPortHorizontal":2===r&&1===s?e.viewerManagerType="TwoPortVertical":2===r&&2===s&&(e.viewerManagerType="FourPort");let i=t.getView();e.cameraInfos=[],i.forEach((t=>{let r=t.getCameraInfo();e.cameraInfos.push(r)}))}else e.enableViewManager=!1,e.viewerManagerType="Normal"}setviewerManagerInfo(e){this.sceneWraper.switchViewport(e.viewerManagerType,!1);let t=this.sceneWraper.getViewManager();if(e.enableViewManager&&t){t.getLayout().activeView.resetDefaultRenderStates(),t.getLayout().activeView.enableViewBox(!1);let r=t.getView();for(let s=0;s<r.length;s++){const i=r[s];i.resetToDefaultView=!1;let a=e.cameraInfos[s];a.isPerspective?i.camera.setPerspectiveCameraInfo(a):i.camera.setOrthographicCameraInfo(a),i.resetDefaultRenderStates(),i.viewId==e.activeViewId&&(t.getLayout().activeView=i,t.getLayout().activeView.enableViewBox(!0))}}}getMeshState(e){if(!this.sceneWraper.getActiveModel())return void console.warn("ndsModel没有正确创建。请检查模型载入状态。");let t=[],r=[],s=[],i=[];var n=this.selectWraper.getSelectedObjects();if(n.length>0){e.meshSel=[];for(var d=0;d<n.length;++d)(this.modelWraper.isMCAD2DModel||n[d].ndsModel.id===e.id)&&e.meshSel.push(n[d].uuid)}let l=this.modelWraper.getLeafBodyNodes();for(var _=0,c=l.length;_<c;++_){var h=l[_];a.isLeafBodyNode(h)&&(a.isHidden(h)?r.push(a.getId(h)):t.push(a.getId(h)),this.sceneWraper.getAllTransparentBodies().length>0&&(a.isIsolated(h)||!a.isTransparent(h)||a.getRenderMode(h)?i.push(a.getId(h)):s.push(a.getId(h))))}0==r.length?e.meshInvisible=[]:0==t.length&&r.length>0?e.meshVisible=[]:r.length<=t.length?e.meshInvisible=r:e.meshVisible=t,s.length<=i.length?e.meshTrans=s:e.meshNoTrans=i;let g=[],M=this.modelWraper.getMeshSets();for(let e=0;e<M.length;++e){let t=M[e],r=o.getBodyNodes(t),s=o.getRenderMode(t);if(void 0!==r&&void 0!==s){let t={index:e,mode:s},i=[];for(let e=0;e<r.length;++e){let t=a.getRenderMode(r[e]);t&&i.push({index:e,mode:t})}t.renderNodes=i,g.push(t)}}g.length>0&&(e.meshSetRenderInfos=g)}applyGeneralInfo(e){if(!e.generalInfo)return;let t=e.generalInfo;if(t.renderMode&&this.sceneWraper.setRenderMode(t.renderMode,!0),!t.exchangeBackImage)return void this.sceneWraper.setBackgroundState("Color","0Xf2f2f2");this.sceneWraper.setBackgroundState(t.exchangeBackImage.type,t.exchangeBackImage.value),this.sceneWraper.setDispalyModelUnit(t.displaymodelUnit,!1),this.applyRotationCenterInfo(t),e.generalInfo.operator&&this.sceneWraper.getCurrentOperatorID()!=e.generalInfo.operator&&this.sceneWraper.setOperatorByID(e.generalInfo.operator);let r=this.sceneWraper.getCamera(),s=this.sceneWraper.getViewManager();null==t.cameraInfo||s||(r.fov=t.cameraInfo.fov,r.near=t.cameraInfo.near,r.far=t.cameraInfo.far,r.position.fromArray(t.cameraInfo.position),r.up.fromArray(t.cameraInfo.up),r.setCameraTarget((new THREE.Vector3).fromArray(t.cameraInfo.target)),r.isPerspective=t.cameraInfo.isPerspective,r.updateProjectionMatrix(),this.sceneWraper.getViewBox()&&this.sceneWraper.updateViewBoxCamDir()),void 0!==t.pmiVisible&&this.sceneWraper.setPmiVisible(t.pmiVisible),void 0!==t.shouldStopPMIOcclusion&&this.sceneWraper.enablePMIOccludeByModel(t.shouldStopPMIOcclusion);let i=this.sceneWraper.getModelByIndex(0);t.enableTransparent!==i.meshManager.enableTransparent&&this.sceneWraper.enableTransparent(t.enableTransparent),void 0!==t.showLineWidth&&this.sceneWraper.setLineWidth(t.showLineWidth)}getBroadcastInfo(e){try{let i=this.sceneWraper.getCameraInfo();var t={};101===e&&(t.generalInfo={cameraInfo:{position:[i.position.x,i.position.y,i.position.z],target:[i.target.x,i.target.y,i.target.z],fov:i.fov,isPerspective:i.isPerspective?1:0,near:i.near,far:i.far,up:[i.up.x,i.up.y,i.up.z]},displaymodelUnit:this.sceneWraper.getDispalyModelUnit(1).unit,exchangeBackImage:this.sceneWraper.getBackgroundState(),renderMode:this.sceneWraper.getRenderMode(),pmiVisible:this.sceneWraper.getPmiVisible(),shouldStopPMIOcclusion:this.sceneWraper.isPMIOccludeByModel(),operator:this.sceneWraper.getCurrentOperatorID(),state:this.sceneWraper.getCurrentOperatorState(),isMobile:NDSWebViewer.COMMON.isMobileDevice(),enableTransparent:this.sceneWraper.getModelByIndex(0).meshManager.enableTransparent,showLineWidth:this.sceneWraper.getLineWidth()},this.getRotationCenterInfo(t.generalInfo));let a=NDSWebViewer.ExtensionManager.getExtensionWithFlags(s.FLAG_ENABLE_NODE_BROADCAST);for(let e=0;e<a.length;++e)a[e].onAfterGetBroadcastInfo(t);if(102===e){let e=[];for(let t=0,s=this.sceneWraper.getModelCount();t<s;++t){let s={},i=this.sceneWraper.getModelByIndex(t);if(this.modelWraper=new r(i),s.id=i.id,this.modelWraper.isSketchModel()){if(this.modelWraper.getRootBodyNode()){let e=this.modelWraper.getRootBodyNode().visible;null!=e&&(s.auxiliaryLineVisible=e)}}else this.getMeshState(s);e.push(s),this.modelWraper=null}e.length>0&&(t.modelStates=e)}103==e&&this.sceneWraper.getPmiVisible()&&(t.PMIStates={},this.getPMIInfo(t.PMIStates)),111==e&&(t.viewerManagerInfo={},this.getViewerManagerInfo(t.viewerManagerInfo));let o=t;switch(e){case 101:o=t.generalInfo;break;case 102:o=t.modelStates;break;case 103:o=t.PMIStates;break;case 104:o=t.Measure2DContent;break;case 105:o=t.measureState;break;case 106:o=t.clipInfo;break;case 107:o=t.explode;break;case 108:o=t.dragInfo;break;case 109:o=t.annotationInfo;break;case 110:break;case 111:o=t.viewerManagerInfo;break;case 112:o=t.textFindInfo}return o}catch(e){console.log(e)}}updateExtensionState(e){this.dispatchAsyncBroadcastEvent(e)}dispatchAsyncBroadcastEvent(e){let t=this,r=101;switch(e){case"generalInfo":r=101;break;case"ModelState":r=102;break;case"PMIState":r=103;break;case"Measure2DPCExtension":r=104;break;case"MeasureExtension":r=105;break;case"ClipExtension":r=106;break;case"ExplodeModelExtension":r=107;break;case"TransformExtension":r=108;break;case"AnnotationExtension":r=109;break;case"ColorChangeExtension":r=110;break;case"ViewManager":r=111;break;case"NDSTextExtension":r=112}t.sceneWraper.dispatchEvent({type:"broadcastEvent",broadcastType:r});let s=t.sceneWraper.getViewManager();101==r&&s&&t.sceneWraper.dispatchEvent({type:"broadcastEvent",broadcastType:111})}};NDSWebViewer.ExtensionManager.addExtension(l)}();
