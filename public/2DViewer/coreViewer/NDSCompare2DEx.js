!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.NDSCompare2DEx=t():e.NDSCompare2DEx=t()}(window,function(){return i=[function(e,t,i){i.r(t),i.d(t,"NDSCompare2DExtension",function(){return d});console.log("NDS ExtensionFramework V0.1"),NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM,NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM,NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM,NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM,NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM;class r extends NDSWebViewer.Extension{constructor(){super()}onLoad(e){}onInitLights(){}update(e){}setFlags(e){super.setFlags(e)}onNdsModelPrepareForRendering(e){}onBeforeNdsModelUpdate(e,t){}onAfterNdsModelUpdate(e,t){}onBeforeNdsModelSetRender(e,t){}onAfterNdsModelSetRender(e,t){}onBeforeNdsMeshRender(e,t){}onBeforeScreenCapture(e){}onAfterScreenCapture(){}onBeforeChangeBackGroundColor(e){}onAfterChangeBackGroundColor(e){}onSetCaptureView(e,t){}getExtensionWithFlags(e){return NDSWebViewer.ExtensionManager.getExtensionWithFlags(e)}resetToDefault(){}needDisableInputEvent(){}getStoreInfo(e){throw this.name+" Extesion did not implement method 'getStoreInfo' "}setStoreInfo(e){throw this.name+" Extesion did not implement method 'setStoreInfo' "}getBodyTransform(e){return new THREE.Matrix4}getBodyNodeTranslate(e){return new THREE.Vector3(0,0,0)}}class s extends NDSWebViewer.ViewLayout{constructor(e){super(e),this.updateOperatorByViewState=()=>{this.activeView&&("OpPan"!=this.viewer.controls.getOperator().type?this.setConnectView(!1):this.viewer.setOperatorByID("OpPan"))},this.resetCamera=()=>{this.updateOperatorByViewState(),this.viewer.renderAllViews()},this.oldSetActiveView=this.setActiveView,this.setActiveView=(e,t)=>{this.oldSetActiveView(e,t),this.viewer.renderAllViews()}}updateConnectViewEvents(e,t){for(let e=0;e<t.length;++e)t[e].clearConnectViewEvent();this.indirectConnectViewMap.clear(),this.bConnectView&&(t[0].subscribeConnectViewEvent(t[1].cameraSyncEventHandler),t[1].subscribeConnectViewEvent(t[0].cameraSyncEventHandler))}updateDefaultViewState(e=!0){var t,i;this.row<=1&&this.col<=1||(this.getView(t=[]),i=this.row*this.col,this.loadBalancer.length=i,this.loadBalancer.fill(0),2==this.row&&1==this.col?(t[0].setDefaultViewDir("front","TwoPortBottom"),t[1].setDefaultViewDir("front","TwoPortTop"),this.update2DViewState(t),this.updateConnectViewEvents("TwoPortVertical",t),e&&this.setAndNotifyActiveViewChange(this.activeView||t[1])):1==this.row&&2==this.col&&(t[0].setDefaultViewDir("front","TwoPortLeft"),t[1].setDefaultViewDir("front","TwoPortRight"),this.update2DViewState(t),this.updateConnectViewEvents("TwoPortHorizonal",t),e)&&this.setAndNotifyActiveViewChange(this.activeView||t[0]),this.updateOperatorByViewState())}update2DViewState(t){if(t&&t.length)if(this.bConnectView)for(let e=0;e<t.length;++e)t[e].is2DView=!0;else for(let e=0;e<t.length;++e)t[e].is2DView=!1}}class o extends NDSWebViewer.ViewManager{constructor(e,t){super(e),this.baseEx=t,this.viewType=0,this.oldInit=this.init,this.init2D=!1,this.oldGetNextRenderedViewFunc=this.getNextRenderedView,this.getNextRenderedView=()=>{var e;return this.isLoadingModel()?null:((e=this.oldGetNextRenderedViewFunc())&&this.baseEx.renderModels(e.viewId,this.isShowingModel()),e)},this.initViewBoxForAllViews=function(){},this.updateViewConnectByOperator=function(e){this.getActiveView().is2DView&&"OpPan"!=e&&layout.updateOperatorByViewState()},this.init=()=>{this.init2D||(this.init2D=!0,this.oldInit())},this.resetToSingleView=e=>{this.setConnectView(!1);e=this.getViewByViewId(e),e&&e.apply(),this.clear(),this.viewer.initViewBox(),this.restoreRenderTargetToSingleView(),e=this.getOrginalCameraInfo();this.viewer.camera.setOrginalCameraInfo({center:new THREE.Vector3(e.center.x,e.center.y,e.center.z),up:new THREE.Vector3(e.up.x,e.up.y,e.up.z),position:new THREE.Vector3(e.position.x,e.position.y,e.position.z)})}}createLayout(e){return new s(e)}shouldDisableLoadBalancer(){return!1}initCompare(){}deInitCompare(){}initViews(){var t=this.getView();if(t&&1<t.length)for(let e=0;e<t.length;++e)t[e].bInit=!1,t[e].init()}isCommonModel(){return 0===this.viewType}isLoadingModel(){return 1===this.viewType}isShowingModel(){return 2===this.viewType}setViewType(e){this.viewType=e}getViewCamera(t){let i=null;var r=this.getView();if(r&&1<r.length)for(let e=0;e<r.length;++e)r[e].viewId===t&&(i=r[e].camera);return i}getViewByViewId(t){var i=this.getView();if(i&&1<i.length)for(let e=0;e<i.length;++e)if(i[e].viewId===t)return i[e];return null}relpaceViewRedraw(){var t=this.getView();if(t&&1<t.length)for(let e=0;e<t.length;++e)t[e].relpaceDraw||(t[e].oldmodelNeedsRedraw=t[e].modelNeedsRedraw,t[e].modelNeedsRedraw=function(){for(let e=0,t=this.viewer.ndsModel.models.length;e<t;++e){var i=this.viewer.ndsModel.models[e];if(i.modelVisible){if(this.viewer.viewManager.isCommonModel())if(this.viewer.viewManager.getViewIdByModel(i)!=this.viewId)continue;var r=this.modelStates.get(i.id);for(let e=0,t=r.meshSetVisualStates.length;e<t;++e)if(r.meshSetVisualStates[e].dirty&&r.meshSetVisualStates[e].visible)return!0;var s=i.getMeshSets();for(let e=0;e<s.length;++e){var o=s[e];if(o.mapMeshDrawCount<o.mapMeshes.length)return!0;if(o.opaqueDrawCount<o.opaqueMeshes.length)return!0;if(o.lineDrawCount<o.drawingLines.length)return!0;if(o.line2WorldDrawCount<o.line2Worlds.length)return!0;if(o.ltMeshDrawCount<o.ltMeshs.length)return!0;if(o.ltLineDrawCount<o.ltLines.length)return!0;if(o.ltPointDrawCount<o.ltPoints.length)return!0;if(o.pointDrawCount<o.drawPoints.length)return!0;if(o.ttfTextDrawCount<o.drawTTFTexts.length)return!0;if(o.shxTextDrawCount<o.drawSHXTexts.length)return!0}}}return!1},t[e].relpaceDraw=!0),t[e].relpaceApply||(t[e].oldApply=t[e].apply,t[e].apply=function(){this.viewer.camera=this.camera,this.viewer.camera.aspect=this.viewPort.width/this.viewPort.height,this.viewer.camera.updateProjectionMatrix(),this.viewer.setCameraInfo(this.viewer.getCameraInfo());var e=new THREE.Vector4(this.viewPortCanvasSize.x,this.viewPortCanvasSize.y,this.viewPortCanvasSize.width,this.viewPortCanvasSize.height);this.viewer.renderer.colorTarget.scissorTest=!0,this.viewer.renderer.colorTarget.scissor.copy(e),this.viewer.renderer.colorTarget.viewport.copy(e),this.viewer.renderStates.forceClear=this.renderStates.forceClear,this.viewer.renderStates.remainTime=this.renderStates.remainTime,this.viewer.renderStates.shouldRenderClipbox=this.renderStates.shouldRenderClipbox,this.viewer.renderStates.shouldRenderClipScene=this.renderStates.shouldRenderClipScene,this.viewer.defaultStandardView=this.defaultViewDir;for(let e=0,t=this.viewer.ndsModel.models.length;e<t;++e){var i=this.viewer.ndsModel.models[e],r=this.modelStates.get(i.id);if(!(i.state<NDSWebViewer.NdsModel.StateType.PREPARED)&&r){var s=i.getMeshSets();for(let e=0,t=s.length;e<t;++e)s[e].visualStates=r.meshSetVisualStates[e];i.meshManager.instancedMeshDirtyFlags=r.instancedMeshDirtyFlags,i.meshManager.instancedLineDirtyFlags=r.instancedLineDirtyFlags}}this.resetToDefaultView&&(this.resetToDefaultView=!1,this.viewer.viewManager.resetOriginView(this.viewId),this.defaultCameraInfo||(this.defaultCameraInfo=this.getCameraInfo()))},t[e].relpaceApply=!0)}getViewIdByModel(e){var t=this.baseEx.source.getModel();return t&&t.id===e.id?this.baseEx.source.getViewId():(t=this.baseEx.target.getModel())&&t.id===e.id?this.baseEx.target.getViewId():-1}resetOriginView(e){this.baseEx.resetOriginView(e)}initOriginalCamera(e){var t=this.getOrginalCameraInfo();t&&(t.position.copy(e.position),t.center.copy(e.target),t.up.copy(e.up))}}class a{constructor(){this.model=null,this.viewId=0,this.cameraInfo=null,this.compareModel=null}clear(){this.model=null,this.viewId=0,this.cameraInfo=null,this.compareModel=null}clearCompare(){this.compareModel=null}setCompareModel(e){this.compareModel=e}setVisible(e){this.model&&(this.model.modelVisible=e)}setViewId(e){this.viewId=e}setModel(e){this.model=e}storeCamera(e){this.cameraInfo={position:e.position.clone(),target:e.target.clone(),near:e.near,far:e.far}}applyCamera(e){this.cameraInfo&&(e.far=this.cameraInfo.far,e.near=this.cameraInfo.near,e.position.copy(this.cameraInfo.position),e.setCameraTarget(this.cameraInfo.target),e.updateProjectionMatrix(),e.updateMatrixWorld(!0))}getViewCamera(e){e=e.getViewCamera(this.viewId);return this.storeCamera(e),e}getCompareModel(){return this.compareModel}getViewId(){return this.viewId}getViewBox(){return this.model.originModelBBox}getModel(){return this.model}getName(){return this.model?this.model.rootBodyNode.name:null}getBBox(){var i=new THREE.Box3,t=this.model.rootBodyNode;if(t&&t.children){var r=this.model.meshManager;for(let e=0;e<t.children.length;e++){var s=t.children[e];if(s.leafBodyAttri&&!s.isHidden()){var o=s.leafBodyAttri.bodyMeshIds;if(o)for(let e=0,t=o.length;e<t;++e){var a,n=o[e];-1<r.geomId[n]&&(a=r.geomManager.getGeomFromId(r.geomId[n]),n=(new THREE.Matrix4).fromArray(r.matrixes,16*r.matrixId[n]),w(a=a.boundingBox.clone()))&&(a.applyMatrix4(n),i.union(a))}var h=s.leafBodyAttri.bodyLineSegIds;if(h)for(let e=0,t=h.length;e<t;++e){var l,d=h[e];-1<r.lineSegGeomId[d]&&((l=r.geomManager.getGeomFromId(r.lineSegGeomId[d])).isPoints||(d=(new THREE.Matrix4).fromArray(r.matrixes,16*r.lineSegMatrixId[d]),w(l=l.boundingBox.clone())&&(l.applyMatrix4(d),i.union(l))))}var c=s.leafBodyAttri.bodyTextIds;if(c)for(let e=0,t=c.length;e<t;++e){var m,g=c[e];-1<r.textGeomId[g]&&!function(t){if(t&&t.text&&" "!==t.text)for(let e=0;e<t.text.length;e++)if(" "!=t.text[e])return;return 1}(m=r.geomManager.getGeomFromId(r.textGeomId[g]))&&(g=(new THREE.Matrix4).fromArray(r.matrixes,16*r.textMatrixId[g]),w(m=m.boundingBox.clone()))&&(m.applyMatrix4(g),i.union(m))}}}}return i;function w(e){return e&&!e.min.equals(e.max)}}}let n=1e-5;class h{constructor(e,t,i,r){this.key=parseFloat(e[0].toFixed(6)),this.mat=i,this.positions=e,this.id=t,this.extra=r}isSame(){return 0===this.mat.type}setSame(){this.mat.type=0}equals(e){return this.mat.type===e.mat.type&&this.positions.length===e.positions.length&&!!this.compareExtra(e)&&!!this.comparePosition(e)&&(e.setSame(),this.setSame(),!0)}compareExtra(e){return!0}comparePosition(t){for(let e=0;e<this.positions.length;e++)if(Math.abs(this.positions[e]-t.positions[e])>n)return!1;return!0}comparePosNode(e,t,i,r){return Math.abs(e.positions[t]-i.positions[r])<n&&Math.abs(e.positions[t+1]-i.positions[r+1])<n}}class u extends h{constructor(e,t,i,r){super(e,t,i,r)}compareExtra(t){if(!!this.mat.map!=!!t.mat.map)return!1;if(this.extra.data.length!==t.extra.data.length)return!1;for(let e=0;e<this.extra.data.length;e++)if(Math.abs(this.extra.data[e]-t.extra.data[e])>n)return!1;return!(this.mat.map&&t.mat.map&&!this.compareMap(t))}compareMap(e){return this.extra.mapUrl===e.extra.mapUrl}comparePosition(e){return 6==this.positions.length?this.comparePosNode(this,0,e,0)&&this.comparePosNode(this,2,e,2)&&this.comparePosNode(this,4,e,4)||this.comparePosNode(this,0,e,0)&&this.comparePosNode(this,2,e,4)&&this.comparePosNode(this,4,e,2)||this.comparePosNode(this,0,e,2)&&this.comparePosNode(this,2,e,0)&&this.comparePosNode(this,4,e,4)||this.comparePosNode(this,0,e,2)&&this.comparePosNode(this,2,e,4)&&this.comparePosNode(this,4,e,0)||this.comparePosNode(this,0,e,4)&&this.comparePosNode(this,2,e,0)&&this.comparePosNode(this,4,e,2)||this.comparePosNode(this,0,e,4)&&this.comparePosNode(this,2,e,2)&&this.comparePosNode(this,4,e,0):super.comparePosition(e)}}class M extends h{constructor(e,t,i,r){super(e,t,i,r)}compareExtra(t){if(this.extra.length!==t.extra.length)return!1;for(let e=0;e<this.extra.length;e++)if(Math.abs(this.extra[e]-t.extra[e])>n)return!1;return!0}comparePosition(e){return 4==this.positions.length?this.comparePosNode(this,0,e,0)&&this.comparePosNode(this,2,e,2)||this.comparePosNode(this,0,e,2)&&this.comparePosNode(this,2,e,0):super.comparePosition(e)}}class f extends h{constructor(e,t,i,r){super(e,t,i,r)}}class w extends h{constructor(e,t,i,r){super(e,t,i,r)}compareExtra(e){return this.extra.type===e.extra.type&&this.extra.text===e.extra.text&&!(this.extra.font&&e.extra.font&&!this.compareFont(e))}compareFont(e){return this.extra.font.bigName===e.extra.font.bigName&&this.extra.font.name===e.extra.font.name&&this.extra.font.size===e.extra.font.size&&this.extra.font.width===e.extra.font.width&&this.extra.font.rotate===e.extra.font.rotate}}class C{constructor(e,t,i){for(var r in t)this[r]=t[r];this.compareModel=e,this.originMeshSet=t,this.commonBox=i,this.storeMeshSet()}getMeshSet(){return this.restoreMeshSet(),this.originMeshSet}storeMeshSet(){this.storeInfo={mapMeshes:this.mapMeshes,opaqueMeshes:this.opaqueMeshes,drawingLines:this.drawingLines,drawPoints:this.drawPoints,drawTTFTexts:this.drawTTFTexts,drawSHXTexts:this.drawSHXTexts,ltMeshs:this.ltMeshs,ltLines:this.ltLines,ltPoints:this.ltPoints,line2Meshes:this.line2Meshes,line2Worlds:this.line2Worlds,fetchOpaqueForDraw:this.fetchOpaqueForDraw,fetchMapMeshForDraw:this.fetchMapMeshForDraw,fetchLineForDraw:this.fetchLineForDraw,fetchLine2WorldForDraw:this.fetchLine2WorldForDraw,fetchLTMeshForDraw:this.fetchLTMeshForDraw,fetchLTLineForDraw:this.fetchLTLineForDraw,fetchLTPointForDraw:this.fetchLTPointForDraw,fetchPointForDraw:this.fetchPointForDraw,fetchTTFTextForDraw:this.fetchTTFTextForDraw,fetchSHXTextForDraw:this.fetchSHXTextForDraw},this.mapMeshes=[],this.opaqueMeshes=[],this.drawingLines=[],this.drawPoints=[],this.drawTTFTexts=[],this.drawSHXTexts=[],this.ltMeshs=[],this.ltLines=[],this.ltPoints=[],this.line2Meshes=[],this.line2Worlds=[],this.fetchOpaqueForDraw=this.cms_fetchOpaqueForDraw,this.fetchMapMeshForDraw=this.cms_fetchMapMeshForDraw,this.fetchLineForDraw=this.cms_fetchLineForDraw,this.fetchLine2WorldForDraw=this.cms_fetchLine2WorldForDraw,this.fetchLTMeshForDraw=this.cms_fetchLTMeshForDraw,this.fetchLTLineForDraw=this.cms_fetchLTLineForDraw,this.fetchLTPointForDraw=this.cms_fetchLTPointForDraw,this.fetchPointForDraw=this.cms_fetchPointForDraw,this.fetchTTFTextForDraw=this.cms_fetchTTFTextForDraw,this.fetchSHXTextForDraw=this.cms_fetchSHXTextForDraw}restoreMeshSet(){this.mapMeshes=this.storeInfo.mapMeshes,this.opaqueMeshes=this.storeInfo.opaqueMeshes,this.drawingLines=this.storeInfo.drawingLines,this.drawPoints=this.storeInfo.drawPoints,this.drawTTFTexts=this.storeInfo.drawTTFTexts,this.drawSHXTexts=this.storeInfo.drawSHXTexts,this.ltMeshs=this.storeInfo.ltMeshs,this.ltLines=this.storeInfo.ltLines,this.ltPoints=this.storeInfo.ltPoints,this.line2Meshes=this.storeInfo.line2Meshes,this.line2Worlds=this.storeInfo.line2Worlds,this.fetchOpaqueForDraw=this.storeInfo.fetchOpaqueForDraw,this.fetchMapMeshForDraw=this.storeInfo.fetchMapMeshForDraw,this.fetchLineForDraw=this.storeInfo.fetchLineForDraw,this.fetchLine2WorldForDraw=this.storeInfo.fetchLine2WorldForDraw,this.fetchLTMeshForDraw=this.storeInfo.fetchLTMeshForDraw,this.fetchLTLineForDraw=this.storeInfo.fetchLTLineForDraw,this.fetchLTPointForDraw=this.storeInfo.fetchLTPointForDraw,this.fetchPointForDraw=this.storeInfo.fetchPointForDraw,this.fetchTTFTextForDraw=this.storeInfo.fetchTTFTextForDraw,this.fetchSHXTextForDraw=this.storeInfo.fetchSHXTextForDraw}getMeshPosition(e,t,i){for(var r,s,o,a=[],n=new THREE.Vector3,h=new THREE.Vector3,l=new THREE.Vector3,d=e.attributes.position,c=e.drawRange.start,m=e.drawRange.start+e.drawRange.count;c<m;c+=3)r=e.index.getX(c),s=e.index.getX(c+1),o=e.index.getX(c+2),n.fromBufferAttribute(d,r),h.fromBufferAttribute(d,s),l.fromBufferAttribute(d,o),n.applyMatrix4(t),h.applyMatrix4(t),l.applyMatrix4(t),a.push(n.x,n.y,h.x,h.y,l.x,l.y);return i&&this.setPrecision(a),a}getMeshExtra(t,i){var e,r=[];let s=null;if(i.map&&i.map.source&&i.map.source.data?(r.push(1),(e=document.createElement("canvas")).width=i.map.source.data.naturalWidth,e.height=i.map.source.data.naturalHeight,e.getContext("2d").drawImage(i.map.source.data,0,0),s=e.toDataURL("image/png")):-1<i.hatchId&&r.push(2),r.push(0),-1<i.hatchId&&t.meshState.extraMtlBuffer){var o=t.meshState.extraMtlLineCount;for(let e=4;e<9;e++){var a=t.meshState.extraMtlBuffer[16*(o+i.hatchId)+e];r.push(a)}}return{data:r,mapUrl:s}}setPrecision(t){for(let e=0;e<t.length;e++){var i,r=t[e];1<=Math.abs(r)?(i=r.toPrecision(7),t[e]=parseFloat(i.substr(0,i.length-1))):t[e]=parseFloat(r.toPrecision(6))}}getLinePosition(e,t,i){for(var r,s,o,a,n,h,l=[],d=new THREE.Vector3,c=new THREE.Vector3,m=new THREE.Vector2,g=e.attributes.position,w=e.attributes.uv,p=e.drawRange.start,u=e.drawRange.start+e.drawRange.count;p<u;p+=2)r=e.index.getX(p),s=e.index.getX(p+1),d.fromBufferAttribute(g,r),c.fromBufferAttribute(g,s),d.applyMatrix4(t),c.applyMatrix4(t),l.push(d.x,d.y,c.x,c.y),w&&(m.fromBufferAttribute(w,r),l.push(m.x,m.y));return 2===e.drawRange.count&&(a=l[1],n=l[3],((h=l[2])<(o=l[0])||h===o&&n<a)&&(l[0]=h,l[1]=n,l[2]=o,l[3]=a,w)&&(h=l[4],g[4]=g[5],g[5]=h),i)&&this.setPrecision(l),l}getLineExtra(t,i){var r=[];if(-1<i.lineTypeId&&t.meshState.extraMtlBuffer){var s=t.meshState.extraMtlBuffer[16*i.lineTypeId+1]+2;for(let e=0;e<s;e++){var o=t.meshState.extraMtlBuffer[16*i.lineTypeId+e];r.push(o)}}return r}getPointPosition(e,t,i){for(var r,s=[],o=new THREE.Vector3,a=e.attributes.position,n=e.drawRange.start,h=e.drawRange.start+e.drawRange.count;n<h;n+=1)r=e.index.getX(n),o.fromBufferAttribute(a,r),o.applyMatrix4(t),s.push(o.x,o.y);return i&&this.setPrecision(s),s}getTextPosition(e,t,i){e=e.position.clone(),e.applyMatrix4(t),t=[e.x,e.y];return i&&this.setPrecision(t),t}getTextExtra(e,t){e=e.SDFMaker.GetFontsInfo(t.font);return{text:t.text,font:e,type:t.isShx}}copyGeometry(e,t,i,r){var s=new THREE.BufferGeometry;return s.attributes.position=e.attributes.position,e.attributes.lineDistance&&(s.attributes.lineDistance=e.attributes.lineDistance),e.attributes.uv&&(s.attributes.uv=e.attributes.uv),s.index=e.index,s.drawRange.start=e.drawRange.start+t*r,s.drawRange.count=(i-t+1)*r,s.boundingBox=e.boundingBox,s.drawRange.start+s.drawRange.count>e.drawRange.start+e.drawRange.count&&console.log("geometry drawRange error"),s}splitMesh(e,l,d,c,m){let g=this.storeInfo.opaqueMeshes[l],w=new THREE.Matrix4,p=(this.originMeshSet.getMeshWorldMatrix(g.localIndex,w),g.geometry.boundingBox.clone().applyMatrix4(w));var t,i;if(this.opaqueMeshes[l]||(t=m.meshUid++,i=this.compareModel.getMeshMaterial(t,g.material,p.clone()),this.opaqueMeshes[l]={bodyNode:g.bodyNode,geometry:g.geometry,material:i,localIndex:g.localIndex,hasMap:g.hasMap,box:p,same:!1,children:[],id:t}),!g.bodyNode.isHidden())if(this.commonBox.intersectsBox(p)){let h=this;e.forEach(function(e){var t,i,r,s=d[e];let o=!1,a=1/0,n=-1/0;for(let e=0;e<s.length;e+=4)0===s[e]&&s[e+1]==c&&(o=!0,a>s[e+2]&&(a=s[e+2]),n<s[e+3])&&(n=s[e+3]);o&&a<=n&&(e=m.meshUid++,i=h.copyGeometry(g.geometry,a,n,3),t=h.compareModel.getMeshMaterial(e,g.material,p.clone()),r={bodyNode:g.bodyNode,geometry:i,material:t,localIndex:g.localIndex,id:e,hasMap:g.hasMap},h.opaqueMeshes[l].same=!1,h.opaqueMeshes[l].children.push(r),r=h.getMeshPosition(i,w),i=h.getMeshExtra(h.compareModel,g.material),r=new u(r,e,t,i),h.compareModel.addMeshObject(r))})}else this.compareModel.morePrimsArray.meshUids.push(this.opaqueMeshes[l].id)}splitLine(e,l,d,c,m){let g=this.storeInfo.drawingLines[l],w=new THREE.Matrix4,p=(this.originMeshSet.getLineWorldMatrix(g.localIndex,w),g.geometry.boundingBox.clone().applyMatrix4(w));var t,i;if(this.drawingLines[l]||(t=m.lineUid++,i=this.compareModel.getLineMaterial(t,g.material.color,g.material.linewidth,p.clone()),this.drawingLines[l]={bodyNode:g.bodyNode,geometry:g.geometry,material:i,localIndex:g.localIndex,box:p,same:!0,children:[],id:t}),!g.bodyNode.isHidden())if(this.commonBox.intersectsBox(p)){let h=this;e.forEach(function(e){var t,i,r,s=d[e];let o=!1,a=1/0,n=-1/0;for(let e=0;e<s.length;e+=4)1===s[e]&&s[e+1]==c&&(o=!0,s[e+2]<a&&(a=s[e+2]),s[e+3]>n)&&(n=s[e+3]);o&&a<=n&&(e=m.lineUid++,i=h.copyGeometry(g.geometry,a,n,2),t=h.compareModel.getLineMaterial(e,g.material.color,g.material.linewidth,p.clone()),r={bodyNode:g.bodyNode,geometry:i,material:t,localIndex:g.localIndex,id:e},h.drawingLines[l].same=!1,h.drawingLines[l].children.push(r),r=h.getLinePosition(i,w),i=h.getLineExtra(h.compareModel,g.material),r=new M(r,e,t,i),h.compareModel.addLineObject(r))})}else this.compareModel.morePrimsArray.lineUids.push(this.drawingLines[l].id)}splitPoint(e,l,d,c,m){let g=this.storeInfo.drawPoints[l],w=new THREE.Matrix4,p=(this.originMeshSet.getPointWorldMatrix(g.localIndex,w),g.geometry.boundingBox.clone().applyMatrix4(w));var t,i;if(this.drawPoints[l]||(t=m.pointUid++,i=this.compareModel.getPointMaterial(t,g.material.color,p.clone()),this.drawPoints[l]={bodyNode:g.bodyNode,geometry:g.geometry,material:i,localIndex:g.localIndex,box:p,same:!0,children:[],id:t}),!g.bodyNode.isHidden())if(this.commonBox.intersectsBox(p)){let h=this;e.forEach(function(e){var t,i,r,s=d[e];let o=!1,a=1/0,n=-1/0;for(let e=0;e<s.length;e+=4)2===s[e]&&s[e+1]==c&&(o=!0,a>s[e+2]&&(a=s[e+2]),n<s[e+3])&&(n=s[e+3]);o&&a<=n&&(e=m.pointUid++,r=h.copyGeometry(g.geometry,a,n,1),t=h.compareModel.getPointMaterial(e,g.material.color,p.clone()),i={bodyNode:g.bodyNode,geometry:r,material:t,localIndex:g.localIndex,id:e},h.drawPoints[l].same=!1,h.drawPoints[l].children.push(i),i=h.getPointPosition(r,w),r=new f(i,e,t),h.compareModel.addPointObject(r))})}else this.compareModel.morePrimsArray.pointUids.push(this.drawPoints[l].id)}copyGeometry2(e,t,i,r){var s=new THREE.BufferGeometry;return s.attributes.position=e.attributes.position,e.attributes.lineDistance&&(s.attributes.lineDistance=e.attributes.lineDistance),e.attributes.uv&&(s.attributes.uv=e.attributes.uv),s.index=e.index,s.drawRange.start=t,s.drawRange.count=i,s.boundingBox=e.boundingBox,s.drawRange.start+s.drawRange.count>e.drawRange.start+e.drawRange.count&&console.log("geometry drawRange error"),s}strictSplitMesh_V2(e,r,s,o,t){var a=this.storeInfo.opaqueMeshes[s];let i=o.meshUid++;var n=a.geometry.boundingBox.clone().applyMatrix4(r);let h=this.compareModel.getMeshMaterial(i,a.material,n.clone());if(this.opaqueMeshes[s]={bodyNode:a.bodyNode,geometry:a.geometry,material:h,localIndex:a.localIndex,box:n,same:!0,children:[],id:i},!a.bodyNode.isHidden())if(t)this.compareModel.samePrimsArray.meshUids.push(i);else if(this.commonBox.intersectsBox(n)){var l=a.geometry.drawRange.start,d=a.geometry.drawRange.count;for(let i=0;i<d;i+=3){let e=o.meshUid++;var c=this.copyGeometry2(a.geometry,l+i,3,3);let t=this.compareModel.getMeshMaterial(e,a.material,n.clone());var m={bodyNode:a.bodyNode,geometry:c,material:t,localIndex:a.localIndex,id:e,hasMap:a.hasMap},m=(this.opaqueMeshes[s].same=!1,this.opaqueMeshes[s].children.push(m),this.getMeshPosition(c,r,!0)),c=this.getMeshExtra(this.compareModel,a.material),m=new u(m,e,t,c);this.compareModel.addMeshObject(m)}}else this.compareModel.morePrimsArray.meshUids.push(i)}strictSplitLine_V2(e,r,s,o,t){var a=this.storeInfo.drawingLines[s];let i=o.lineUid++;var n=a.geometry.boundingBox.clone().applyMatrix4(r);let h=this.compareModel.getLineMaterial(i,a.material.color,a.material.linewidth,n.clone());if(this.drawingLines[s]={bodyNode:a.bodyNode,geometry:a.geometry,material:h,localIndex:a.localIndex,box:n,same:!0,children:[],id:i},!a.bodyNode.isHidden())if(t)this.compareModel.samePrimsArray.lineUids.push(i);else if(this.commonBox.intersectsBox(n)){var l=a.geometry.drawRange.start,d=a.geometry.drawRange.count;for(let i=0;i<d;i+=2){let e=o.lineUid++;var c=this.copyGeometry2(a.geometry,l+i,2,2);let t=this.compareModel.getLineMaterial(e,a.material.color,a.material.linewidth,n.clone());var m={bodyNode:a.bodyNode,geometry:c,material:t,localIndex:a.localIndex,id:e},m=(this.drawingLines[s].same=!1,this.drawingLines[s].children.push(m),this.getLinePosition(c,r,!0)),c=this.getLineExtra(this.compareModel,a.material),m=new M(m,e,t,c);this.compareModel.addLineObject(m)}}else this.compareModel.morePrimsArray.lineUids.push(i)}strictSplitPoint_V2(e,r,s,o,t){var a=this.storeInfo.drawPoints[s];let i=o.pointUid++;var n=a.geometry.boundingBox.clone().applyMatrix4(r);let h=this.compareModel.getPointMaterial(i,a.material.color,n.clone());if(this.drawPoints[s]={bodyNode:a.bodyNode,geometry:a.geometry,material:h,localIndex:a.localIndex,box:n,same:!0,children:[],id:i},!a.bodyNode.isHidden())if(t)this.compareModel.samePrimsArray.pointUids.push(i);else if(this.commonBox.intersectsBox(n)){var l=a.geometry.drawRange.start,d=a.geometry.drawRange.count;for(let i=0;i<d;i++){let e=o.pointUid++;var c=this.copyGeometry2(a.geometry,l+i,1,1);let t=this.compareModel.getPointMaterial(e,a.material.color,n.clone());var m={bodyNode:a.bodyNode,geometry:c,material:t,localIndex:a.localIndex,id:e},m=(this.drawPoints[s].same=!1,this.drawPoints[s].children.push(m),this.getPointPosition(c,r,!0)),c=new f(m,e,t);this.compareModel.addPointObject(c)}}else this.compareModel.morePrimsArray.pointUids.push(i)}strictSplitTextTTF_V2(e,t,i,r,s){var o=this.storeInfo.drawTTFTexts[i],r=r.textUid++,a=o.geometry.boundingBox.clone().applyMatrix4(t),n=this.compareModel.getTextMaterial(r,o.material.color,a.clone());this.drawTTFTexts[i]={bodyNode:o.bodyNode,geometry:o.geometry,material:n,localIndex:o.localIndex,box:a,same:!0,children:[],id:r},o.bodyNode.isHidden()||(s?this.compareModel.samePrimsArray.textUids.push(r):this.commonBox.intersectsBox(a)?(i=this.getTextPosition(o.geometry,t,!0),s=this.getTextExtra(this.compareModel,o.geometry),a=new w(i,r,n,s),this.compareModel.addTextObject(a)):this.compareModel.morePrimsArray.textUids.push(r))}strictSplitTextSHX_V2(e,t,i,r,s){var o=this.storeInfo.drawSHXTexts[i],r=r.textUid++,a=o.geometry.boundingBox.clone().applyMatrix4(t),n=this.compareModel.getTextMaterial(r,o.material.color,a.clone());this.drawSHXTexts[i]={bodyNode:o.bodyNode,geometry:o.geometry,material:n,localIndex:o.localIndex,box:a,same:!0,children:[],id:r},o.bodyNode.isHidden()||(s?this.compareModel.samePrimsArray.textUids.push(r):this.commonBox.intersectsBox(a)?(i=this.getTextPosition(o.geometry,t,!0),s=this.getTextExtra(this.compareModel,o.geometry),a=new w(i,r,n,s),this.compareModel.addTextObject(a)):this.compareModel.morePrimsArray.textUids.push(r))}copyText(t,i,r){for(let e=0;e<this.storeInfo.drawTTFTexts.length;e++){var s=this.storeInfo.drawTTFTexts[e],o=t.textUid++,a=new THREE.Matrix4,n=(this.originMeshSet.getTextWorldMatrix(s.localIndex,a),s.geometry.boundingBox.clone().applyMatrix4(a)),h=this.compareModel.getTextMaterial(o,s.material.color,n.clone());this.drawTTFTexts[e]={bodyNode:s.bodyNode,geometry:s.geometry,material:h,localIndex:s.localIndex,box:n,same:!0,children:[],id:o},s.bodyNode.isHidden()||(i?this.compareModel.samePrimsArray.textUids.push(o):this.commonBox.intersectsBox(n)?(n=this.getTextPosition(s.geometry,a,r),a=this.getTextExtra(this.compareModel,s.geometry),s=new w(n,o,h,a),this.compareModel.addTextObject(s)):this.compareModel.morePrimsArray.textUids.push(o))}for(let e=0;e<this.storeInfo.drawSHXTexts.length;e++){var l=this.storeInfo.drawSHXTexts[e],d=t.textUid++,c=new THREE.Matrix4,m=(this.originMeshSet.getTextWorldMatrix(l.localIndex,c),l.geometry.boundingBox.clone().applyMatrix4(c)),g=this.compareModel.getTextMaterial(d,l.material.color,m.clone());this.drawSHXTexts[e]={bodyNode:l.bodyNode,geometry:l.geometry,material:g,localIndex:l.localIndex,box:m,same:!0,children:[],id:d},l.bodyNode.isHidden()||(i?this.compareModel.samePrimsArray.textUids.push(d):this.commonBox.intersectsBox(m)?(m=this.getTextPosition(l.geometry,c,r),c=this.getTextExtra(this.compareModel,l.geometry),l=new w(m,d,g,c),this.compareModel.addTextObject(l)):this.compareModel.morePrimsArray.textUids.push(d))}}copyMesh(t,i){for(let e=0;e<this.storeInfo.opaqueMeshes.length;e++){var r=this.storeInfo.opaqueMeshes[e],s=t.meshUid++,o=new THREE.Matrix4,a=(this.originMeshSet.getMeshWorldMatrix(r.localIndex,o),r.geometry.boundingBox.clone().applyMatrix4(o)),n=this.compareModel.getMeshMaterial(s,r.material,a.clone());this.opaqueMeshes[e]={bodyNode:r.bodyNode,geometry:r.geometry,material:n,localIndex:r.localIndex,box:a,same:!0,children:[],id:s},r.bodyNode.isHidden()||(i?this.compareModel.samePrimsArray.meshUids.push(s):this.commonBox.intersectsBox(a)?(a=this.getMeshPosition(r.geometry,o),o=this.getMeshExtra(this.compareModel,r.material),r=new u(a,s,n,o),this.compareModel.addMeshObject(r)):this.compareModel.morePrimsArray.meshUids.push(s))}}copyLine(t,i){for(let e=0;e<this.storeInfo.drawingLines.length;e++){var r=this.storeInfo.drawingLines[e],s=t.lineUid++,o=new THREE.Matrix4,a=(this.originMeshSet.getLineWorldMatrix(r.localIndex,o),r.geometry.boundingBox.clone().applyMatrix4(o)),n=this.compareModel.getLineMaterial(s,r.material.color,r.material.linewidth,a.clone());this.drawingLines[e]={bodyNode:r.bodyNode,geometry:r.geometry,material:n,localIndex:r.localIndex,box:a,same:!0,children:[],id:s},r.bodyNode.isHidden()||(i?this.compareModel.samePrimsArray.lineUids.push(s):this.commonBox.intersectsBox(a)?(a=this.getLinePosition(r.geometry,o),o=this.getLineExtra(this.compareModel,r.material),r=new M(a,s,n,o),this.compareModel.addLineObject(r)):this.compareModel.morePrimsArray.lineUids.push(s))}}copyPoint(t,i){for(let e=0;e<this.storeInfo.drawPoints.length;e++){var r=this.storeInfo.drawPoints[e],s=t.pointUid++,o=new THREE.Matrix4,a=(this.originMeshSet.getPointWorldMatrix(r.localIndex,o),r.geometry.boundingBox.clone().applyMatrix4(o)),n=this.compareModel.getPointMaterial(s,r.material.color,a.clone());this.drawPoints[e]={bodyNode:r.bodyNode,geometry:r.geometry,material:n,localIndex:r.localIndex,box:a,same:!0,children:[],id:s},r.bodyNode.isHidden()||(i?this.compareModel.samePrimsArray.pointUids.push(s):this.commonBox.intersectsBox(a)?(a=this.getPointPosition(r.geometry,o),r=new f(a,s,n),this.compareModel.addPointObject(r)):this.compareModel.morePrimsArray.pointUids.push(s))}}createLineType(){if(this.compareModel.lineTypes){let h=this;var s=[],o=[];for(let t=0;t<this.drawingLines.length;t++){var i=this.storeInfo.drawingLines[t];if(this.drawingLines[t].same){var e=this.drawingLines[t];e.material.visible&&-1<i.material.lineTypeId&&v(e,t,-1,i.material,o,s)}else{var r=this.drawingLines[t].children;if(-1<i.material.lineTypeId)for(let e=0;e<r.length;e++){var a=r[e];a.material.visible&&v(a,t,e,i.material,o,s)}}}if(0<s.length&&0<o.length){var n=h;var l=s;var d=o;var c=l.length/3,m=x(c);for(let e=0;e<c;e+=3)m[e+0]=e,m[e+1]=e+1,m[e+2]=e+2;var g,w,p=new THREE.BufferAttribute(new Float32Array(l),3,0,!1),u=new THREE.BufferAttribute(m,1);let t=null,i=null,r=0;for(let e=0;e<d.length;e++){if(0<d[e].geom.mesh.length){var M=d[e].geom.mesh.length/3,f=y(p,u,r,M);t||(t=x(2*c),i=new THREE.BufferAttribute(t,1));for(let e=r;e<r+M;e+=3)t[2*e+0]=m[e+0],t[2*e+1]=m[e+1],t[2*e+2]=m[e+1],t[2*e+3]=m[e+2],t[2*e+4]=m[e+2],t[2*e+5]=m[e+0];f.textWireFrame=y(p,i,2*r,2*M),r+=M,n.ltMeshs.push({geometry:f,drawingIndex:d[e].drawingIndex,subDrawingIndx:d[e].subDrawingIndx,localIndex:d[e].localIndex})}0<d[e].geom.line.length&&(f=d[e].geom.line.length/3,g=y(p,u,r,f),r+=f,n.ltLines.push({geometry:g,drawingIndex:d[e].drawingIndex,subDrawingIndx:d[e].subDrawingIndx,localIndex:d[e].localIndex})),0<d[e].geom.point.length&&(g=d[e].geom.point.length/3,w=y(p,u,r,g),r+=g,n.ltPoints.push({geometry:w,drawingIndex:d[e].drawingIndex,subDrawingIndx:d[e].subDrawingIndx,localIndex:d[e].localIndex}))}}function x(e){return new(65535<=e?Uint32Array:256<=e?Uint16Array:Uint8Array)(e)}function y(e,t,i,r){var s=new THREE.BufferGeometry;return s.addAttribute("position",e),s.setIndex(t),s.drawRange.count=r,s.drawRange.start=i,s.needsUpdate=!0,s}function v(e,t,i,r,s,o){var a=r.lineTypeId,r=r.lineScale,n=e.geometry,n=h.compareModel.lineTypes.getLineStyleGeomInfoNew(n,a,r);(0<n.mesh.length||0<n.line.length||0<n.point.length)&&(n.mesh.forEach(e=>{o.push(e)}),n.line.forEach(e=>{o.push(e)}),n.point.forEach(e=>{o.push(e)}),s.push({geom:n,localIndex:e.localIndex,drawingIndex:t,subDrawingIndx:i}))}}}createLineWidth(){let p=this;performance.now();let u=12,M=0;function i(e,t,i){if(999===e.material.linewidth){var r,s,o=e.geometry,a=[],n=new THREE.Vector3,h=new THREE.Vector3,l=new THREE.Vector2,d=o.getAttribute("position"),c=o.getAttribute("uv"),m=o.getAttribute("lineDistance");for(let e=o.drawRange.start;e<o.drawRange.start+o.drawRange.count;e+=2)r=o.index.getX(e),s=o.index.getX(e+1),n.fromBufferAttribute(d,r),h.fromBufferAttribute(d,s),a.push(n.x,n.y,n.z,h.x,h.y,h.z),a.push(m.array[3*r],m.array[3*s],m.array[3*s+1],m.array[3*s+2]),c?(l.fromBufferAttribute(c,r),a.push(l.x),a.push(l.y)):(a.push(meshMaterial.linewidth),a.push(meshMaterial.linewidth));0<o.drawRange.count&&(g={geometry:(g=a,g=new THREE.InstancedInterleavedBuffer(new Float32Array(g),u,1),(w=new NDSWebViewer.LineSegmentsGeometry).addAttribute("instanceStart",new THREE.InterleavedBufferAttribute(g,3,0,!1)),w.addAttribute("instanceEnd",new THREE.InterleavedBufferAttribute(g,3,3,!1)),w.addAttribute("instanceDistance",new THREE.InterleavedBufferAttribute(g,4,6,!1)),w.addAttribute("instanceWidth",new THREE.InterleavedBufferAttribute(g,2,10,!1)),w.needsUpdate=!0,w.LSKey=M++,w),count:o.drawRange.count/2,drawingIndex:t,subDrawingIndx:i,localIndex:e.localIndex},p.line2Worlds.push(g))}var g,w}for(let t=0;t<this.drawingLines.length;t++)if(this.drawingLines[t].same){var e=this.drawingLines[t];e.material.visible&&999===e.material.linewidth&&i(e,t,-1)}else{var r=this.drawingLines[t].children;if(999===this.drawingLines[t].material.linewidth)for(let e=0;e<r.length;e++){var s=r[e];s.material.visible&&i(s,t,e)}}}combineDrawing(t){function i(i){var e=[];let r=0,s=1,o=i.children[r].material.type;for(;s<i.children.length;s++){var a=i.children[s];if(o!=a.material.type){let t=0;for(let e=r;e<s;e++)t+=i.children[e].geometry.drawRange.count;i.children[r].geometry.drawRange.count=t,e.push(i.children[r]),o=a.material.type,r=s}}if(r<s){let t=0;for(let e=r;e<s;e++)t+=i.children[e].geometry.drawRange.count;i.children[r].geometry.drawRange.count=t,e.push(i.children[r])}i.children=e}for(let e=0;e<this.storeInfo.opaqueMeshes.length;e++){var r,s,o=this.opaqueMeshes[e];o?(!o.same&&1<o.children.length&&i(o),o.hasMap&&(this.mapMeshes[this.mapMeshes.length]=o)):(o=t.meshUid++,r=this.storeInfo.opaqueMeshes[e],(s=this.compareModel.getMeshMaterial(o,r.material)).visible=!1,this.opaqueMeshes[e]={bodyNode:r.bodyNode,geometry:r.geometry,material:s,localIndex:r.localIndex,hasMap:r.hasMap,same:!1,children:[],id:o})}for(let e=0;e<this.storeInfo.drawingLines.length;e++){var a,n,h=this.drawingLines[e];h?!h.same&&1<h.children.length&&i(h):(h=t.lineUid++,a=this.storeInfo.drawingLines[e],(n=this.compareModel.getLineMaterial(h,a.material.color,a.material.linewidth)).visible=!1,this.drawingLines[e]={bodyNode:a.bodyNode,geometry:a.geometry,material:n,localIndex:a.localIndex,same:!1,children:[],id:h})}for(let e=0;e<this.storeInfo.drawPoints.length;e++){var l,d,c=this.drawPoints[e];c?!c.same&&1<c.children.length&&i(c):(c=t.pointUid++,l=this.storeInfo.drawPoints[e],(d=this.compareModel.getPointMaterial(c,l.material.color)).visible=!1,this.drawPoints[e]={bodyNode:l.bodyNode,geometry:l.geometry,material:d,localIndex:l.localIndex,same:!1,children:[],id:c})}for(let e=0;e<this.storeInfo.drawTTFTexts.length;e++){var m,g,w;this.drawTTFTexts[e]||(m=t.textUid++,g=this.storeInfo.drawTTFTexts[e],(w=this.compareModel.getTextMaterial(m,g.material.color)).visible=!1,this.drawPoints[e]={bodyNode:g.bodyNode,geometry:g.geometry,material:w,localIndex:g.localIndex,same:!1,children:[],id:m})}for(let e=0;e<this.storeInfo.drawSHXTexts.length;e++){var p,u,M;this.drawSHXTexts[e]||(p=t.textUid++,u=this.storeInfo.drawSHXTexts[e],(M=this.compareModel.getTextMaterial(p,u.material.color)).visible=!1,this.drawPoints[e]={bodyNode:u.bodyNode,geometry:u.geometry,material:M,localIndex:u.localIndex,same:!1,children:[],id:p})}}cms_fetchOpaqueForDraw(i,e,r=-1){let s=0;for(let e=0,t=0;;++e){var o=e+this.opaqueDrawCount;if(o>=this.opaqueMeshes.length||e>=r)break;var a=this.opaqueMeshes[o];if(!a.bodyNode.isHidden()&&!a.hasMap&&a.material.visible)if(a.same)i[t++]=a;else{if(i.length+a.children.length>r)break;for(let e=0;e<a.children.length;e++)a.children[e].material.visible&&(i[t++]=a.children[e])}++s}this.opaqueDrawCount+=s}cms_fetchMapMeshForDraw(i,r=-1){let s=0;for(let e=0,t=0;e<r&&!(e+this.mapMeshDrawCount>=this.mapMeshes.length);++e){var o=this.mapMeshes[e+this.mapMeshDrawCount];if(!o.bodyNode.isHidden()&&o.material.visible)if(o.same)i[t++]=o;else{if(i.length+o.children.length>r)break;for(let e=0;e<o.children.length;e++)o.children[e].material.visible&&(i[t++]=o.children[e])}++s}this.mapMeshDrawCount+=s}cms_fetchLineForDraw(i,r=-1){let s=0;for(let e=0,t=0;e<r&&!(e+this.lineDrawCount>=this.drawingLines.length);++e){var o=this.drawingLines[e+this.lineDrawCount];if(!o.bodyNode.isHidden()&&999!==o.material.linewidth&&o.material.visible)if(o.same)i[t++]=o;else{if(i.length+o.children.length>r)break;for(let e=0;e<o.children.length;e++)o.children[e].material.visible&&(i[t++]=o.children[e])}++s}this.lineDrawCount+=s}cms_fetchLine2WorldForDraw(r,s,e=-1){let o=0;for(let t=0,i=0;t<e&&!(t+this.line2WorldDrawCount>=this.line2Worlds.length);++t){var a=this.line2Worlds[t+this.line2WorldDrawCount];let e=null;!(e=-1<a.subDrawingIndx?this.drawingLines[a.drawingIndex].children[a.subDrawingIndx]:this.drawingLines[a.drawingIndex]).bodyNode.isHidden()&&e.material.visible&&(a.material=e.material,r[i]=a,s[i++]=e),++o}this.line2WorldDrawCount+=o}cms_fetchPointForDraw(i,r=-1){let s=0;for(let e=0,t=0;e<r&&!(e+this.pointDrawCount>=this.drawPoints.length);++e){var o=this.drawPoints[e+this.pointDrawCount];if(!o.bodyNode.isHidden()&&o.material.visible)if(o.same)i[t++]=o;else{if(i.length+o.children.length>r)break;for(let e=0;e<o.children.length;e++)o.children[e].material.visible&&(i[t++]=o.children[e])}++s}this.pointDrawCount+=s}cms_fetchTTFTextForDraw(i,r=-1){let s=0;for(let e=0,t=0;e<r&&!(e+this.ttfTextDrawCount>=this.drawTTFTexts.length);++e){var o=this.drawTTFTexts[e+this.ttfTextDrawCount];!o.bodyNode.isHidden()&&o.material.visible&&(i[t++]=o),++s}this.ttfTextDrawCount+=s}cms_fetchSHXTextForDraw(i,r=-1){let s=0;for(let e=0,t=0;e<r&&!(e+this.shxTextDrawCount>=this.drawSHXTexts.length);++e){var o=this.drawSHXTexts[e+this.shxTextDrawCount];!o.bodyNode.isHidden()&&o.material.visible&&(i[t++]=o),++s}this.shxTextDrawCount+=s}cms_fetchLTMeshForDraw(r,e=-1){let s=0;for(let t=0,i=0;t<e&&!(t+this.ltMeshDrawCount>=this.ltMeshs.length);++t){var o=this.ltMeshs[t+this.ltMeshDrawCount];let e=null;!(e=-1<o.subDrawingIndx?this.drawingLines[o.drawingIndex].children[o.subDrawingIndx]:this.drawingLines[o.drawingIndex]).bodyNode.isHidden()&&e.material.visible&&(o.material=e.material,r[i++]=o),++s}this.ltMeshDrawCount+=s}cms_fetchLTLineForDraw(r,e=-1){let s=0;for(let t=0,i=0;t<e&&!(t+this.ltLineDrawCount>=this.ltLines.length);++t){var o=this.ltLines[t+this.ltLineDrawCount];let e=null;!(e=-1<o.subDrawingIndx?this.drawingLines[o.drawingIndex].children[o.subDrawingIndx]:this.drawingLines[o.drawingIndex]).bodyNode.isHidden()&&e.material.visible&&(o.material=e.material,r[i++]=o),++s}this.ltLineDrawCount+=s}cms_fetchLTPointForDraw(r,e=-1){let s=0;for(let t=0,i=0;t<e&&!(t+this.ltPointDrawCount>=this.ltPoints.length);++t){var o=this.ltPoints[t+this.ltPointDrawCount];let e=null;!(e=-1<o.subDrawingIndx?this.drawingLines[o.drawingIndex].children[o.subDrawingIndx]:this.drawingLines[o.drawingIndex]).bodyNode.isHidden()&&e.material.visible&&(o.material=e.material,r[i++]=o),++s}this.ltPointDrawCount+=s}}class l extends NDSWebViewer.NdsMCAD2d{constructor(e,t,i,I,r){for(var s in super(e.viewer,e.uri,e.params),e)this[s]=e[s];this.originNdsModel=e,this.commonBox=t,this.useSplit=i,this.useStrict=r,this._changedFlag=16777216,this.compareMeshMaterial=new Map,this.compareLineMaterial=new Map,this.comparePointMaterial=new Map,this.compareTextMaterial=new Map,this.samePrimsArray={meshUids:[],lineUids:[],pointUids:[],textUids:[]},this.morePrimsArray={meshUids:[],lineUids:[],pointUids:[],textUids:[]},this.meshObjectsMap=new Map,this.lineObjectsMap=new Map,this.pointObjectMap=new Map,this.textObjectMap=new Map,this.objectUids={meshUid:0,lineUid:0,pointUid:0,textUid:0};let T=this;this.createMeshSet=function(){var e=performance.now();for(let e=0;e<T.meshSets.length;e++)T.meshSets[e]=new C(T,T.meshSets[e],T.commonBox);if(T.useStrict){var t=T.originNdsModel.meshManager,i=T.originNdsModel.rootBodyNode.children,r=new Set,s=new Set,o=new Set;for(let e=0;e<i.length;e++){var a=i[e];if(a&&a.leafBodyAttri){var n=a.leafBodyAttri.bodyMeshIds;for(let e=0;e<n.length;++e){var h=n[e],l=t.geomId[h],d=t.materialId[h],c=t.matrixId[h],l=a.uuid+"_"+l+"_"+d+"_"+c;r.has(l)||(r.add(l),d=(new THREE.Matrix4).fromArray(t.matrixes,16*t.matrixId[h]),[c,l]=T.meshId2MeshSet.get(h),T.meshSets[c].strictSplitMesh_V2(h,d,l,T.objectUids,I))}var m=a.leafBodyAttri.bodyLineSegIds;for(let e=0;e<m.length;++e){var g,w=t.lineSegGeomId[m[e]],p=t.lineSegMaterialId[m[e]],u=t.lineSegMatrixId[m[e]],w=a.uuid+"_"+w+"_"+p+"_"+u;s.has(w)||(s.add(w),p=t.geomManager.getGeomFromId(t.lineSegGeomId[m[e]]),u=(new THREE.Matrix4).fromArray(t.matrixes,16*t.lineSegMatrixId[m[e]]),p&&2==p.geomType?(w=m[e],[p,g]=T.pointId2MeshSet.get(w),T.meshSets[p].strictSplitPoint_V2(w,u,g,T.objectUids,I)):(p=m[e],[w,g]=T.lineId2MeshSet.get(p),T.meshSets[w].strictSplitLine_V2(p,u,g,T.objectUids,I)))}var M=a.leafBodyAttri.bodyTextIds;for(let e=0;e<M.length;++e){var f,x=M[e],y=t.textGeomId[x],v=t.textMaterialId[x],b=t.textMatrixId[x],y=a.uuid+"_"+y+"_"+v+"_"+b;o.has(y)||(o.add(y),(v=t.geomManager.getGeomFromId(t.textGeomId[x]))&&v.index&&T.textId2MeshSet.get(x)&&(b=(new THREE.Matrix4).fromArray(t.matrixes,16*t.textMatrixId[x]),[y,f]=T.textId2MeshSet.get(x),y=T.meshSets[y],v&&v.isShx?y.strictSplitTextSHX_V2(x,b,f-y.ttfCount,T.objectUids,I):y.strictSplitTextTTF_V2(x,b,f,T.objectUids,I)))}}}for(let e=0;e<T.meshSets.length;e++)T.meshSets[e].needsUpdate=!1}else if(T.useSplit){!function t(s){if(s.prims&&(s.prims[0].forEach(function(e,t){var i,r;T.meshId2MeshSet.has(t)&&([i,r]=T.meshId2MeshSet.get(t),T.meshSets[i].splitMesh(e,r,s.objects,t,T.objectUids))}),s.prims[1].forEach(function(e,t){var i,r;T.lineId2MeshSet.has(t)&&([i,r]=T.lineId2MeshSet.get(t),T.meshSets[i].splitLine(e,r,s.objects,t,T.objectUids))}),s.prims[2].forEach(function(e,t){var i,r;T.pointId2MeshSet.has(t)&&([i,r]=T.pointId2MeshSet.get(t),T.meshSets[i].splitPoint(e,r,s.objects,t,T.objectUids))})),s.children)for(let e=0;e<s.children.length;e++)t(s.children[e])}(T.modelObjectsData);for(let e=0;e<T.meshSets.length;e++)T.meshSets[e].copyText(T.objectUids)}else for(let e=0;e<T.meshSets.length;e++)T.meshSets[e].copyMesh(T.objectUids,I),T.meshSets[e].copyLine(T.objectUids,I),T.meshSets[e].copyPoint(T.objectUids,I),T.meshSets[e].copyText(T.objectUids,I);console.log("Compare: create meshSets cost ",((performance.now()-e)/1e3).toFixed(2))}()}getOriginModel(){for(let e=0;e<this.meshSets.length;e++)this.meshSets[e]=this.meshSets[e].getMeshSet();return this.originNdsModel.modelVisible=!0,this.originNdsModel}getMeshMaterial(e,t,i){return this.compareMeshMaterial.has(e)?this.compareMeshMaterial.get(e):(t={color:t.color.hex,packColor:this._changedFlag|t.color.hex,visible:!0,map:t.map,type:1,box:i},this.compareMeshMaterial.set(e,t),t)}changeMeshMaterial(e,t){e=this.compareMeshMaterial.get(e);if(!e)return null;e.packColor=t&&t|this._changedFlag}changeMeshColorAndVisible(e,t,i){e=this.compareMeshMaterial.get(e);if(!e)return null;e.packColor=t&&t|this._changedFlag,e.visible=i}getLineMaterial(e,t,i,r){return this.compareLineMaterial.has(e)?this.compareLineMaterial.get(e):(i={linewidth:i,color:t,packColor:this._changedFlag|t,visible:!0,type:1,box:r},this.compareLineMaterial.set(e,i),i)}changeLineMaterial(e,t){e=this.compareLineMaterial.get(e);if(!e)return null;e.packColor=t&&t|this._changedFlag}changeLineColorAndVisible(e,t,i){e=this.compareLineMaterial.get(e);if(!e)return null;e.packColor=t&&t|this._changedFlag,e.visible=i}getPointMaterial(e,t,i){return this.comparePointMaterial.has(e)?this.comparePointMaterial.get(e):(t={color:t,packColor:this._changedFlag|t,visible:!0,type:1,box:i},this.comparePointMaterial.set(e,t),t)}changePointMaterial(e,t){e=this.comparePointMaterial.get(e);if(!e)return null;e.packColor=t&&t|this._changedFlag}changePointColorAndVisible(e,t,i){e=this.comparePointMaterial.get(e);if(!e)return null;e.packColor=t&&t|this._changedFlag,e.visible=i}getTextMaterial(e,t,i){return this.compareTextMaterial.has(e)?this.compareTextMaterial.get(e):(t={color:t,packColor:this._changedFlag|t,visible:!0,type:1,box:i},this.compareTextMaterial.set(e,t),t)}changeTextMaterial(e,t){e=this.compareTextMaterial.get(e);if(!e)return null;e.packColor=t&&t|this._changedFlag}changeTextColorAndVisible(e,t,i){e=this.compareTextMaterial.get(e);if(!e)return null;e.packColor=t&&t|this._changedFlag,e.visible=i}setPrimVisible(e,t,i){3===e?this.changeTextVisible(t,i):2===e?this.changePointVisible(t,i):1===e?this.changeLineVisible(t,i):this.changeMeshVisible(t,i)}setPrimsColor(e,t,i){3===e?this.changeTextMaterial(i,t):2===e?this.changePointMaterial(i,t):1===e?this.changeLineMaterial(i,t):this.changeMeshMaterial(i,t)}setSameColor(t,i){for(let e=0;e<this.samePrimsArray.meshUids.length;e++)this.changeMeshColorAndVisible(this.samePrimsArray.meshUids[e],t,i);for(let e=0;e<this.samePrimsArray.lineUids.length;e++)this.changeLineColorAndVisible(this.samePrimsArray.lineUids[e],t,i);for(let e=0;e<this.samePrimsArray.pointUids.length;e++)this.changePointColorAndVisible(this.samePrimsArray.pointUids[e],t,i);for(let e=0;e<this.samePrimsArray.textUids.length;e++)this.changeTextColorAndVisible(this.samePrimsArray.textUids[e],t,i)}setMoreColor(t,i){for(let e=0;e<this.morePrimsArray.meshUids.length;e++)this.changeMeshColorAndVisible(this.morePrimsArray.meshUids[e],t,i);for(let e=0;e<this.morePrimsArray.lineUids.length;e++)this.changeLineColorAndVisible(this.morePrimsArray.lineUids[e],t,i);for(let e=0;e<this.morePrimsArray.pointUids.length;e++)this.changePointColorAndVisible(this.morePrimsArray.pointUids[e],t,i);for(let e=0;e<this.morePrimsArray.textUids.length;e++)this.changeTextColorAndVisible(this.morePrimsArray.textUids[e],t,i)}addMeshObject(e){this.meshObjectsMap.has(e.key)?this.meshObjectsMap.get(e.key).push(e):this.meshObjectsMap.set(e.key,[e])}addLineObject(e){this.lineObjectsMap.has(e.key)?this.lineObjectsMap.get(e.key).push(e):this.lineObjectsMap.set(e.key,[e])}addPointObject(e){this.pointObjectMap.has(e.key)?this.pointObjectMap.get(e.key).push(e):this.pointObjectMap.set(e.key,[e])}addTextObject(e){this.textObjectMap.has(e.key)?this.textObjectMap.get(e.key).push(e):this.textObjectMap.set(e.key,[e])}compare(e){function t(e,t){e.forEach(function(i,e){var r=t.get(e);if(r)for(let t=0;t<r.length;t++)for(let e=0;e<i.length&&!r[t].equals(i[e]);e++);})}t(this.meshObjectsMap,e.meshObjectsMap),t(this.lineObjectsMap,e.lineObjectsMap),t(this.pointObjectMap,e.pointObjectMap),t(this.textObjectMap,e.textObjectMap),this.getCompareResult(),e.getCompareResult()}getCompareResult(){function e(e,i,r){e.forEach(function(e,t){e.forEach(function(e){(e.isSame()?i:r).push(e.id)})})}e(this.meshObjectsMap,this.samePrimsArray.meshUids,this.morePrimsArray.meshUids),e(this.lineObjectsMap,this.samePrimsArray.lineUids,this.morePrimsArray.lineUids),e(this.pointObjectMap,this.samePrimsArray.pointUids,this.morePrimsArray.pointUids),e(this.textObjectMap,this.samePrimsArray.textUids,this.morePrimsArray.textUids),console.log("Compare: split mesh ",this.meshObjectsMap.size," line ",this.lineObjectsMap.size," point ",this.pointObjectMap.size," text ",this.textObjectMap.size),console.log("Compare: more mesh ",this.morePrimsArray.meshUids.length," line ",this.morePrimsArray.lineUids.length," point ",this.morePrimsArray.pointUids.length," text ",this.morePrimsArray.textUids.length),this.meshObjectsMap.clear(),this.lineObjectsMap.clear(),this.pointObjectMap.clear(),this.textObjectMap.clear();for(let e=0;e<this.meshSets.length;e++)this.meshSets[e].combineDrawing(this.objectUids),this.meshSets[e].createLineType(),this.meshSets[e].createLineWidth()}}class d extends r{constructor(){super(),this.name="NDSCompare2DExtension",console.log("NDSCompare2DExtension version 1.2.1"),this.viewer=null,this.source=new a,this.target=new a,this.unionBox=new THREE.Box3,this.useStrict=!1,this.sourceCameraInfoFile=null,this.sourceCameraSave=null,this.initParams=function(){this.isHorizontal=!0,this.isSync=!0,this.sameVisible=!0,this.sameColor=10066329,this.sameColorUpdate=!0,this.moreVisible=!0,this.moreColor=13905968,this.lessVisible=!0,this.lessColor=47746},this.switchViewport=function(e){var t,i;e?this.viewer.viewManager&&(this.viewer.viewManager.resetToSingleView(this.source.getViewId()),this.viewer.viewManager.deInitCompare(),this.viewer.viewManager=void 0,this.viewer.render()):(e=this.isHorizontal?"TwoPortHorizontal":"TwoPortVertical",t=this.isSync,i=(e,t,i)=>{this.viewer.viewManager||(this.viewer.viewManager=new o(this.viewer,this),this.viewer.viewManager.setWindowSize(this.viewer.renderer.getSize().width,this.viewer.renderer.getSize().height),this.viewer.viewManager.init(),this.viewer.viewManager.initCompare()),this.viewer.viewManager.clear(),this.viewer.viewManager.setLayout(e,t),this.viewer.viewManager.setConnectView(i),this.viewer.viewManager.initViewBoxForAllViews(),this.viewer.viewManager.displayViewBox(!1),this.viewer.viewManager.relpaceViewRedraw(),this.viewer.renderAllViews()},"TwoPortVertical"==e?(i(2,1,t),this.source.setViewId(1),this.target.setViewId(0)):"TwoPortHorizontal"==e&&(i(1,2,t),this.source.setViewId(0),this.target.setViewId(1)))},this.renderModels=function(e,t){t?(this.sameColorUpdate&&(this.source.compareModel.setSameColor(this.sameColor,this.sameVisible),this.target.compareModel.setSameColor(this.sameColor,this.sameVisible),this.sameColorUpdate=!1),e===this.source.getViewId()?(this.source.compareModel.setMoreColor(this.moreColor,!0),this.target.compareModel.setMoreColor(this.lessColor,this.lessVisible)):(this.source.compareModel.setMoreColor(this.lessColor,this.lessVisible),this.target.compareModel.setMoreColor(this.moreColor,!0))):(t=e===this.source.getViewId(),this.source.setVisible(t),this.target.setVisible(!t),(e=(t||!this.target.model?this.source:this.target).model)&&(this.viewer.ndsModel.activeModel=e))},this.compare=function(){var e,t,i,r,s;this.viewer.viewManager&&(e=performance.now(),this.viewer.viewManager.setViewType(1),this.source.model)&&this.target.model&&(i=new THREE.Box3,r=this.source.model.geomManager.isRefGeometryManager,s=this.target.model.geomManager.isRefGeometryManager,(s=r&&s)?(r=(r?this.target:this.source).getBBox(),i.copy(r),this.unionBox.copy(r)):(r=this.source.getBBox(),t=this.target.getBBox(),i.copy(r).intersect(t),this.unionBox.copy(r).union(t)),r=!!this.source.model.modelObjectsData&&!!this.target.model.modelObjectsData,t=new l(this.source.model,i,!s&&r,s,this.useStrict),i=new l(this.target.model,i,!s&&r,s,this.useStrict),this.source.setCompareModel(t),this.target.setCompareModel(i),t.compare(i),this.sameColorUpdate=!0,r=this.source.getViewCamera(this.viewer.viewManager),s=this.target.getViewCamera(this.viewer.viewManager),this.changeCameraTo(r,s,this.unionBox),this.source.setVisible(!0),this.target.setVisible(!0),this.viewer.viewManager.setViewType(2),this.viewer.renderAllViews(),console.log("Compare: cost ",((performance.now()-e)/1e3).toFixed(2)))},this.changeCameraTo=function(e,t,i){var r=new THREE.Vector3,i=(i.getCenter(r),1.1*(Math.max(i.max.x-i.min.x,i.max.y-i.min.y)+4)),s=new THREE.Vector3,r=(s.set(r.x,r.y,r.z),e.target.clone().sub(e.position).normalize()),i=(r.multiplyScalar(i),s.clone().sub(r));e.far<i.z&&(e.far=i.z+1),e.near>s.z&&(e.near=s.z-1),e.position.set(i.x,i.y,i.z),e.setCameraTarget(s),e.updateProjectionMatrix(),e.updateMatrixWorld(!0),t&&this.copyCamera(e,t)},this.copyCamera=function(e,t){t.far<e.far&&(t.far=e.far),t.near>e.near&&(t.near=e.near),t.position.copy(e.position),t.setCameraTarget(e.target.clone()),t.updateProjectionMatrix(),t.updateMatrixWorld(!0)},this.removeModel=function(e){e&&this.viewer.unloadModelById(e.id)},this.getModelByViewId=function(e){return e===this.source.getViewId()?this.source.getModel():e===this.target.getViewId()?this.target.getModel():null},this.resetOriginView=function(e){var t,i=this.viewer.viewManager.getViewCamera(this.source.getViewId()),r=this.viewer.viewManager.getViewCamera(this.target.getViewId()),s=this.viewer.viewManager.isShowingModel();e===this.source.getViewId()?(t=s?this.unionBox:this.source.getViewBox(),this.changeCameraToOrigin(i,null,t,!0)):e===this.target.getViewId()&&(this.isSync?(i=s?this.unionBox:this.source.getViewBox(),this.changeCameraToOrigin(r,null,i,!1)):(t=s?this.unionBox:this.target.getViewBox(),this.changeCameraToOrigin(r,null,t,!1))),this.viewer.renderAllViews()},this.changeCameraToOrigin=function(e,t,i,r){var s=i.min.clone(),o=i.max.clone(),a=new THREE.Vector3;i.getCenter(a);let n=new THREE.Vector3,h=((n=n.subVectors(o,s)).length()<1e-6&&n.set(1,1,1),.5*n.length()/Math.sin(Math.PI/180*e.fov*.5));0==h&&(h=1e-4);i=new THREE.Vector3(0,0,1).applyQuaternion(e.quaternion),i.multiplyScalar(h),o=new THREE.Vector3;o.addVectors(a,i),e.far<o.z&&(e.far=o.z+1),e.near>a.z&&(e.near=a.z-1),r&&this.sourceCameraInfoFile&&e.up.set(this.sourceCameraInfoFile.up[0],this.sourceCameraInfoFile.up[1],this.sourceCameraInfoFile.up[2]),e.position.set(o.x,o.y,o.z),e.setCameraTarget(a),e.updateProjectionMatrix(),e.updateMatrixWorld(!0),t&&this.copyCamera(e,t)},this.changeCameraUp=function(){var e=this.sourceCameraInfoFile?(new THREE.Vector3).fromArray(this.sourceCameraInfoFile.up):new THREE.Vector3(0,1,0);this.viewer.camera.up.copy(e),this.viewer.camera.updateProjectionMatrix(),this.viewer.camera.updateMatrixWorld(!0)},this.setCameraInfoFileUp=function(){this.sourceCameraInfoFile=this.viewer.cameraInfoFile},this.stroeCurrentCamera=function(e){this.sourceCameraSave={position:e.position.clone(),target:e.target.clone(),up:e.up.clone(),near:e.near,far:e.far}},this.restoreCurrentCamera=function(){this.sourceCameraSave&&this.viewer.camera&&(this.viewer.camera.near=this.sourceCameraSave.near,this.viewer.camera.far=this.sourceCameraSave.far,this.viewer.camera.position.set(this.sourceCameraSave.position.x,this.sourceCameraSave.position.y,this.sourceCameraSave.position.z),this.viewer.camera.up.set(this.sourceCameraSave.up.x,this.sourceCameraSave.up.y,this.sourceCameraSave.up.z),this.viewer.camera.setCameraTarget(this.sourceCameraSave.target.clone()),this.viewer.camera.updateProjectionMatrix(),this.viewer.camera.updateMatrixWorld(!0),this.viewer.renderAllViews())}}onLoad(e){this.viewer=e}initModelCompare(){var e=this.viewer.getExtension("Select2DPCExtension");e&&(e.clearSelectObj(),e.setOpSelectType(!1)),this.stroeCurrentCamera(this.viewer.camera),this.initParams(),this.setCameraInfoFileUp(),this.changeCameraUp(),this.oldSelectionOutlinePass=this.viewer.selectionOutlinePass,this.viewer.selectionOutlinePass=void 0,this.source.setModel(this.viewer.ndsModel.models[0]),this.switchViewport()}deInitModelCompare(){this.clearCompare(),this.removeModel(this.target.getModel()),this.switchViewport(!0);var e=this.source.getViewBox(),e=(e&&(this.viewer.modelRootObject.boundingBox.copy(e),this.viewer.controls.setBoundingBox(e.min,e.max)),this.sourceCameraInfoFile&&(this.viewer.cameraInfoFile=this.sourceCameraInfoFile),this.restoreCurrentCamera(),this.source.setVisible(!0),this.source.clear(),this.target.clear(),this.viewer.selectionOutlinePass=this.oldSelectionOutlinePass,this.viewer.getExtension("Select2DPCExtension"));e&&e.setOpSelectType(!0)}loadModel(e,t,i){let n=this.isHorizontal?i:1===i?0:1;if(this.viewer.viewManager){this.clearCompare(),n===this.source.getViewId()?(this.removeModel(this.source.getModel()),this.source.setModel(null)):n===this.target.getViewId()&&(this.removeModel(this.target.getModel()),this.target.setModel(null)),this.viewer.renderAllViews();let o=this,a=!1;function r(){o.viewer.dispatchEvent({type:"modelVersionError"})}function s(){function s(){var e,t,i,r;o.viewer.removeEventListener("geometryAllLoadedEvent",s),e=n,a||(a=!0,console.log(" --------------------Compare Load ALL Geoms--------------------"),o.viewer.viewManager.initViews(),t=o.viewer.ndsModel.models.length-1,t=o.viewer.ndsModel.models[t],e===o.source.getViewId()?(o.source.setModel(t),r=o.viewer.viewManager.getViewCamera(o.source.getViewId()),i=o.viewer.viewManager.getViewCamera(o.target.getViewId()),o.setCameraInfoFileUp(),o.changeCameraToOrigin(r,o.isSync?i:null,o.source.getViewBox(),!0),o.viewer.viewManager.initOriginalCamera(r),o.stroeCurrentCamera(r)):e===o.target.getViewId()&&(o.target.setModel(t),i=o.viewer.viewManager.getViewCamera(o.source.getViewId()),r=o.viewer.viewManager.getViewCamera(o.target.getViewId()),o.isSync?o.copyCamera(i,r):o.changeCameraToOrigin(r,null,o.target.getViewBox(),!1)),o.viewer.viewManager.setViewType(0),o.viewer.renderAllViews(),o.viewer.dispatchEvent({type:"loadSuccess"}))}o.viewer.viewManager.setViewType(1),o.viewer.addEventListener("geometryAllLoadedEvent",s,!1),o.viewer.loadModel("idv",e,null,null,"js",null,function(){},null,t),setTimeout(function(){var e;1<o.viewer.ndsModel.models.length&&(e=o.viewer.ndsModel.models[1])&&e.geomManager.isRefGeometryManager&&s()},1e3)}var i=NDSWebViewer.COMMON.encodeURL(e),h=new NDSWebViewer.BIMXHRLoader;h.setCrossOrigin(o.viewer.crossOrigin),h.load(o.viewer.gobalReqHeader,i,function(e){(4<=JSON.parse(e).modelContentVersion?s:r)()},function(){},function(){r()})}}processCompare(){if(!this.viewer.viewManager||!this.viewer.viewManager.isLoadingModel()&&!this.viewer.viewManager.isShowingModel()){let e=this;e.viewer.dispatchEvent({type:"beginCompare"}),setTimeout(function(){try{e.compare()}catch(e){console.log("compare failed!")}setTimeout(function(){e.viewer.dispatchEvent({type:"endCompare"})},500)},100)}}clearCompare(){var e,t;this.viewer.viewManager&&this.viewer.viewManager.isShowingModel()&&(this.viewer.viewManager.setViewType(1),e=this.source.getCompareModel(),t=this.target.getCompareModel(),e&&e.getOriginModel(),e&&t.getOriginModel(),e=this.viewer.viewManager.getViewCamera(this.source.getViewId()),t=this.viewer.viewManager.getViewCamera(this.target.getViewId()),this.source.applyCamera(e),this.target.applyCamera(t),this.viewer.viewManager.setViewType(0)),this.source.clearCompare(),this.target.clearCompare(),this.viewer.renderAllViews()}setModelViewport(e){this.viewer.viewManager&&this.isHorizontal!==e&&(this.isHorizontal=e,this.switchViewport()),this.viewer.renderAllViews()}setModelSyncView(e){var t;this.viewer.viewManager&&this.isSync!==e&&(this.isSync=e,this.viewer.viewManager.setConnectView(this.isSync),this.target.getModel())&&this.isSync&&(e=this.viewer.viewManager.getViewCamera(this.source.getViewId()),t=this.viewer.viewManager.getViewCamera(this.target.getViewId()),this.copyCamera(e,t)),this.viewer.renderAllViews()}setSameAreaInfo(e,t,i){e=e?parseInt(t):void 0;this.sameColorUpdate=this.sameColor!=e,this.sameVisible=!0,this.sameColor=e,this.viewer.renderAllViews()}setMoreAreaInfo(e,t){this.moreVisible=e,this.moreColor=e?parseInt(t):void 0,this.viewer.renderAllViews()}setLessAreaInfo(e,t){this.lessVisible=e,this.lessColor=e?parseInt(t):void 0,this.viewer.renderAllViews()}getModelNames(){var e=[],t=this.source.getName();return t&&(e.push(t),t=this.target.getName())&&e.push(t),e}setUseStrict(e){this.useStrict=e}move(e,t){var i,r=this.target.getCompareModel(),s=this.target.getViewCamera(this.viewer.viewManager);let o=this;function a(e,t){o.changeCameraTo(e,null,t),o.viewer.renderAllViews()}r&&("mesh"==e&&(i=r.morePrimsArray.meshUids,-1<t)&&t<i.length&&-1<(i=i[t])&&(i=r.getMeshMaterial(i)).box&&a(s,i.box),"line"==e&&(i=r.morePrimsArray.lineUids,-1<t)&&t<i.length&&-1<(i=i[t])&&(i=r.getLineMaterial(i)).box&&a(s,i.box),"point"==e&&(i=r.morePrimsArray.pointUids,-1<t)&&t<i.length&&-1<(i=i[t])&&(i=r.getPointMaterial(i)).box&&a(s,i.box),"text"==e)&&(i=r.morePrimsArray.textUids,-1<t)&&t<i.length&&-1<(e=i[t])&&(i=r.getTextMaterial(e)).box&&a(s,i.box)}showCompare2D(){return 4<=this.viewer.modelContentVersion}}i=new d;NDSWebViewer.ExtensionManager.addExtension(i)}],r={},s.m=i,s.c=r,s.d=function(e,t,i){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)s.d(i,r,function(e){return t[e]}.bind(null,r));return i},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=0);function s(e){var t;return(r[e]||(t=r[e]={i:e,l:!1,exports:{}},i[e].call(t.exports,t,t.exports,s),t.l=!0,t)).exports}var i,r});