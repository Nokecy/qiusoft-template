!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.ExplodeModelExtension=t():e.ExplodeModelExtension=t()}(window,function(){return o=[function(e,t){t.endianness=function(){return"LE"},t.hostname=function(){return"undefined"!=typeof location?location.hostname:""},t.loadavg=function(){return[]},t.uptime=function(){return 0},t.freemem=function(){return Number.MAX_VALUE},t.totalmem=function(){return Number.MAX_VALUE},t.cpus=function(){return[]},t.type=function(){return"Browser"},t.release=function(){return"undefined"!=typeof navigator?navigator.appVersion:""},t.networkInterfaces=t.getNetworkInterfaces=function(){return{}},t.arch=function(){return"javascript"},t.platform=function(){return"browser"},t.tmpdir=t.tmpDir=function(){return"/tmp"},t.EOL="\n",t.homedir=function(){return"/"}},function(e,t,o){o.r(t);o(0);console.log("NDS ExtensionFramework V0.1");let s={FLAG_ENABLE_NODE_TRANSFORM:NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM,FLAG_ENABLE_NODE_STOREVIEW:NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM<<1,FLAG_ENABLE_NODE_CAMERA2D:NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM<<2,FLAG_ENABLE_NODE_BLOCK:NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM<<3,FLAG_ENABLE_NODE_TEXT:NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM<<4,FLAG_ENABLE_NODE_BROADCAST:NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM<<5};class i extends NDSWebViewer.Extension{constructor(){super()}onLoad(e){}onEnter(){}onExit(){}onInitLights(){}update(e){}setFlags(e){super.setFlags(e)}onNdsModelPrepareForRendering(e){}onBeforeNdsModelUpdate(e,t){}onAfterNdsModelUpdate(e,t){}onBeforeNdsModelSetRender(e,t){}onAfterNdsModelSetRender(e,t){}onBeforeNdsMeshRender(e,t){}getExtensionWithFlags(e){return NDSWebViewer.ExtensionManager.getExtensionWithFlags(e)}resetToDefault(){}getStoreInfo(e){throw this.name+" Extesion did not implement method 'getStoreInfo' "}setStoreInfo(e){throw this.name+" Extesion did not implement method 'setStoreInfo' "}getBodyTransform(e,t=0){return new THREE.Matrix4}getBodyNodeTranslate(e,t=0){return new THREE.Vector3(0,0,0)}}class l{static getModel(e){return e.ndsModel}static getUUID(e){return e.uuid}static getObjectId(e){return e.objectid}static getId(e){return e.id}static getBodyNodeMaterial(e){var t=e.getMaterialBodyNodeUUid();return t&&e.useBodyNodeMaterial?e.ndsModel.bodyNodeUUidToMaterial[t]:null}static setBodyNodeMaterial(e,t){e.ndsModel.bodyNodeUUidToMaterial[e.uuid]=t,e.useBodyNodeMaterial=!!t}static getUserMaterial(e){return e.getUserMaterial()}static setUserMaterial(e,t){e.setUserMaterial(t)}static getBoundingBox(e){var t=new THREE.Box3;return e.getBoundingBox(t,!0)}static isLeafBodyNode(e){return!!e.leafBodyAttri}static isPartBodyNode(e){return"Part"===e.type}static getLeafBodyNodes(e){return e.ndsModel.getLeafBodies(e)}static getMeshesInLeafBodyNode(e){return e.leafBodyAttri?e.leafBodyAttri.bodyMeshIds:[]}static getMatrixLocal(e){return e.matrix}static getMatrixWorld(e){return e.worldMatrix}static setMatrixWorld(e,t){e.setMatrixWorld(t)}static applyTransform(e,t=null){e.applyTransform(t)}static updateMatrixWorld(e,t=!1){e.updateMatrixWorld(t,!0)}static hide(e){e.hide(e)}static show(e){e.show()}static isPreSelected(e){return e.isPreSelected()}static isSelected(e){return e.isSelected()}static isTransparent(e){return e.isTransparent()}static isHidden(e){return e.isHidden()}static isIsolated(e){return e.isIsolated()}static getRenderMode(e){switch(e.renderMode){case 3:return"wireframe";case 4:return"hiddenLineRemove";case 5:return"hiddenLineVisible"}return""}static getBodyNodeTranslate(e,o){var i=new THREE.Vector3(0,0,0),r=e.getExtensionWithFlags(s.FLAG_ENABLE_NODE_TRANSFORM);for(let e=0,t=r.length;e<t;++e)i.add(r[e].getBodyNodeTranslate(o));return i}static updateNodeMatrix(e,t){e.ndsModel.updateNodeMatrix(e.uuid,t,e.getModel().id)}static hideBody(e){e.ndsModel.hideBody(e)}static showBody(e){e.ndsModel.showBody(e)}}class r{constructor(e){this.__coreView__=e}addEventListener(e,t){this.__coreView__.addEventListener(e,t)}hasEventListener(e,t){return this.__coreView__.hasEventListener(e,t)}removeEventListener(e,t){this.__coreView__.removeEventListener(e,t)}dispatchEvent(e){this.__coreView__.dispatchEvent(e)}getPixelRatio(){return this.__coreView__.renderer.getPixelRatio()}switchRotateCenterBySelection(){this.__coreView__.switchRotateCenterBySelection()}setDefaultEnvMap(e){e&&(this.__coreView__.hasPbrMaterial=!0,this.__coreView__.setDefaultEnvMap=()=>{this.__coreView__.setEnvMapEnabled(!0),this.__coreView__.defaultEnvMapTexture=e,this.__coreView__.updateEnvMap(this.__coreView__.defaultEnvMapTexture)},this.__coreView__.setDefaultEnvMap())}getBackgroundState(){return this.__coreView__.exchangeBackImage?{type:this.__coreView__.exchangeBackImage.type,value:this.__coreView__.exchangeBackImage.value}:void 0}setBackgroundState(e,t){"Image"===e?(this.__coreView__.setEnvMapTextures(null),this.__coreView__.setBackGroundImage(t)):"EnvMap"===e?this.__coreView__.setEnvMapTextures(t):"Color"===e&&(this.__coreView__.setEnvMapTextures(null),this.__coreView__.setBackGroundImage(null),this.__coreView__.setBackGroundColor(t))}removeAllLights(){this.__coreView__.lights.length=0}getLight(e){return this.__coreView__.lights[e]}setLight(e,t){this.__coreView__.lights[e]=t}getViewBox(){return this.__coreView__.viewBox}toggleAutoRotation(e){this.__coreView__.toggleAutoRotation(e)}randColor(){return this.__coreView__.materialsSetting.randColor()}getBoundingBox(e=!0){e=this.__coreView__.ndsModel.getTotalBodyBoundingBox(null,e);return e.isEmpty()?this.__coreView__.modelRootObject.boundingBox:e}getModelTree(){return this.__coreView__.getModelTree()}getModelCount(){return this.__coreView__.ndsModel.models.length}setActiveModel(e){this.__coreView__.ndsModel.setActiveModel(e)}setActiveModelByModelId(t){let o=-1;for(let e=0;e<this.__coreView__.ndsModel.models.length;++e)if(this.__coreView__.ndsModel.models[e].id===t){o=e;break}this.setActiveModel(o)}getActiveModel(){return this.__coreView__.ndsModel.getActiveModel()}getModelById(e){return this.__coreView__.ndsModel.getModelById(e)}getModelIndexByModelId(t){var o=this.__coreView__.ndsModel;for(let e=0;e<o.models.length;++e)if(o.models[e].id===t)return e}getModelByIndex(e){return this.__coreView__.ndsModel.models[e]}registOperator(e,t){this.__coreView__.registOperator(e,t)}setOperatorByID(e){this.__coreView__.setOperatorByID(e)}getCurrentOperator(){return this.__coreView__.controls.getOperator()}getCurrentOperatorID(){return this.__coreView__.getCurrentOperatorID()}setOperator(e){this.__coreView__.setOperator(e)}registCursor(e,t,o){this.__coreView__.registCursor(e,t,o)}hideSelectedObjects(){this.__coreView__.hideSelectedObjects()}getViewControlBoundingBox(){return this.__coreView__.controls.getBoundingBox()}setViewControlBoundingBox(e,t){this.__coreView__.controls.setBoundingBox(e,t)}getCamera(){return this.__coreView__.camera}setCameraControlBoundingBoxCenter(e){this.__coreView__.cameraControl.setBoundingBoxCenter(e)}setCameraControlBounding(e,t){this.__coreView__.cameraControl.setBoundingBox(e,t)}getRotateCenter(){return this.__coreView__.cameraControl.getRotateCenter()}setRotateCenter(e){this.__coreView__.cameraControl.setRotateCenter(e)}getViewLockedState(){return this.__coreView__.cameraControl.isViewLockedBySingleBody}setViewLockedState(e){this.__coreView__.cameraControl.isViewLockedBySingleBody=e}getCameraInfo(){return this.__coreView__.cameraControl.getCameraInfo()}adjustNearAndFar(){this.__coreView__.cameraControl.adjustNearAndFar()}updateViewBoxCamDir(){this.__coreView__.cameraControl.updateViewBoxCamDir()}startSmoothTranslation(e){this.__coreView__.cameraControl.startSmoothTranslation(e)}zoomExtents(e,t,o){this.__coreView__.cameraControl.zoomExtents(e,t,o)}setCameraInfo(e,t){this.__coreView__.cameraControl.setCameraInfo(e,t)}getOrginalCameraInfo(){return(this.__coreView__.viewManager||this.__coreView__.camera).getOrginalCameraInfo()}setOrginalCameraInfo(e,t,o){this.__coreView__.camera.setOrginalCameraInfo({center:e,up:t,position:o})}toPerspectiveCamera(){this.__coreView__.toPerspectiveCamera()}toOrthographicCamera(){this.__coreView__.toOrthographicCamera()}updateGroundTransform(e,t,o){return this.__coreView__.groundShadow.updateGroundTransform(e,t,o)}enableLocalClipping(){this.__coreView__.renderer.localClippingEnabled=!0}disableLocalClipping(){this.__coreView__.renderer.localClippingEnabled=!1}getCanvas2D(){return this.__coreView__.canvas2D}getCanvas3D(){return this.__coreView__.canvas3D}getContainer(){return this.__coreView__.container}getRenderDomElement(){return this.__coreView__.renderer.domElement}getAdditionalObjectsScene(){return this.__coreView__.additionalObjectsScene}getDispalyModelUnit(e,t){return this.__coreView__.getDispalyModelUnit(e,t)}modelCoordToClientCoord(e){return this.__coreView__.modelCoordToClientCoord(e)}clientCoordToModelCoord(e){return this.__coreView__.clientCoordToModelCoord(e)}showObject(e,t,o,i=!0){this.__coreView__.showObject(e,t,o,i)}showObjectReversed(e){this.__coreView__.showObjectReversed(e)}renderAllViews(){this.__coreView__.renderAllViews()}render(e){this.__coreView__.render(e)}setRenderMode(e,t){this.__coreView__.setRenderMode(e,t)}getRenderMode(){let e=void 0;switch(this.__coreView__.getRenderMode()){case 0:e="lighting";break;case 1:e="primarycolor";break;case 2:e="wireframe";break;case 3:e="whitemold";break;case 4:e="shadedWithEdges";break;case 5:e="shaded";break;case 6:e="hiddenLineRemove";break;case 7:e="hiddenLineVisible";break;case 8:e="transparent"}return e}getAssemblyPMIState(){return this.__coreView__.AssemblyPMIState}setAssemblyPMIState(e){this.__coreView__.AssemblyPMIState=e}getPartPMIState(){return this.__coreView__.PartPMIState}setPartPMIState(e){this.__coreView__.PartPMIState=e}getPmiVisible(){return this.__coreView__.pmiVisible}setPmiVisible(e){this.__coreView__.pmiVisible=e}setPMIObjectVisible(e,t){this.__coreView__.setPMIObjectVisible(e,t)}isPMIOccludeByModel(){return!NDSWebViewer.SETTING.StopPMIOcclusion}enablePMIOccludeByModel(e){this.__coreView__.stopPMIOcclusion(!e)}getPmiList(){return this.__coreView__.PMINDSBodys}getPMIObjectByUUID(e){return this.__coreView__.PMIUUIDtoPMIObject[e]}isPMIObjectOrSomeChildHidden(e){return this.__coreView__.isPMIObjectOrSomeChildHidden(e)}getPmiObjectTree(){return this.__coreView__.pmiObject}getSelectedPmiList(){return this.__coreView__.getPMINDSBodySelectList()}selectPMIObject(e){this.__coreView__.selectPMIObject(e)}deselectPMIObject(e){this.__coreView__.deselectPMIObject(e)}unmergeBodyNode(){this.__coreView__.ndsModel.unmergeNode()}mergeBodyNode(){this.__coreView__.ndsModel.mergeNode()}getAllTransparentBodies(e){return this.__coreView__.ndsModel.getAllTransparentBodies(e)}isolateBodiesOnly(e){this.__coreView__.ndsModel.isolateBodiesOnly(e)}unloadModelById(e){this.__coreView__.ndsModel.unloadModelById(e)}startLoadAnimationModel(e){var t=e.url,o=e.id,e={needsPMI:!1,needsAnimation:!1,needsSketchModel:!1,position:e.position,pmiVisible:this.__coreView__.pmiVisible,modelId:e.modelId};this.__coreView__.loadModel(o,t,null,null,"js",null,null,null,e)}getBodyNodeFromUuid(t,e=-1){var o=null;return 0<=e?(e=this.getModelById(e))&&(e=e.getBodyNodeFromUuid(t))&&(o=e):this.__coreView__.ndsModel.models.forEach(e=>{e=e.getBodyNodeFromUuid(t);e&&(o=e)}),o}loadBrepInfo(e){this.__coreView__.loadBrepInfo(e)}getForceClear(){return this.__coreView__.renderStates.forceClear}isBackgroundImageEnabled(){return!!this.__coreView__.backGroundScene}isEnvMapEnabled(){return!!this.__coreView__.envMapScene}setIgnoreModelSelection(e){var t=this.__coreView__.controls.getOperator();t&&t.ignoreModelSelection&&t.ignoreModelSelection(e)}logOperatorTimeShow(e,t){this.__coreView__.logOperatorTime&&this.__coreView__.logOperatorTimeShow(e,t)}isLoadedNdsModelEmpty(){return void 0!==this.__coreView__.GeomEmpty&&this.__coreView__.GeomEmpty}isECAD3DView(){return void 0!==this.__coreView__.isECAD3DViewer&&this.__coreView__.isECAD3DViewer}}class n{constructor(e){this.__sectionManager__=e.selectionManager}getSelectedObjects(){return this.__sectionManager__.getSelectedObjects()}getSelectedMeshes(){return this.__sectionManager__.getSelectedMeshes()}clearSelection(){this.__sectionManager__.clearSelection()}setSelectType(e){this.__sectionManager__.setSelectType(e)}selectByClick(e,t){this.__sectionManager__.selectByClick(e,t)}}t=new class extends i{constructor(){super(),this.setFlags(s.FLAG_ENABLE_NODE_TRANSFORM|s.FLAG_ENABLE_NODE_BROADCAST|s.FLAG_ENABLE_NODE_STOREVIEW),this.name="ExplodeModelExtension",console.log("ExplodeModelExtension version 1.0.4"),this.EXPLODEMODE={NORMAL:32,X:1,Y:2,Z:4,LEVEL:8,SELECTED:16,YZ:64,XZ:128,XY:256},this.explodeFactor=0,this.explodeFactorX=0,this.explodeFactorY=0,this.explodeFactorZ=0,this.explodeFactorZScale=-1,this.explodeFactorYZ=0,this.explodeFactorXZ=0,this.explodeFactorXY=0,this._explodeFactor=0,this.explodeMode=this.EXPLODEMODE.NORMAL,this.explodeLevel=0,this.explodeObject=null,this.explodeObjects=[],this.boundingBoxExplosion=void 0,this.bodyTranslateMap=new Map,this.bodyTransDeltaMap=new Map,this.worldCenter=null,this._matrix=new THREE.Matrix4,this.__bbox__=new THREE.Box3,this.totalBox=new THREE.Box3,this.__original_translation__=[],this.__wholeLeafBodyNodes=[],this.transformExtension=null,this.transformInfo={}}getTranslateId(e,t=void 0){return void 0!==t&&e.IsInstanceNode?e.id+`-${t}-`+e.getModel().id:e.id+"-"+e.getModel().id}clear(){this.explodeFactor=0,this.explodeFactorX=0,this.explodeFactorY=0,this.explodeFactorZ=0,this.explodeFactorZScale=-1,this._explodeFactor=0,this.explodeMode=this.EXPLODEMODE.NORMAL,this.explodeLevel=0,this.explodeObject=null,this.explodeObjects=[],this.boundingBoxExplosion=void 0,this.bodyTranslateMap=new Map,this.bodyTransDeltaMap=new Map,this.worldCenter=null,this.totalBox=new THREE.Box3,this._matrix=new THREE.Matrix4,this.__bbox__=new THREE.Box3,this.__setModelCull(!0),this.__original_translation__.length=0,this.__wholeLeafBodyNodes.length=0}onAfterGetBroadcastInfo(e){this.getStoreInfo(e)}onAfterSetBroadcastInfo(e){this.setStoreInfo(e)}getBodyNodeTranslate(e,t=void 0){e.getModel().NeedsMergeBodyNode&&e.IsMergedNode&&(o=void 0!==e.parent.FirstVisibleNode?e.parent.FirstVisibleNode:0,e=e.parent.children[o]);var o=this.getTranslateId(e,t);return this.bodyTransDeltaMap.has(o)?(e=this.bodyTransDeltaMap.get(o),new THREE.Vector3(e[0],e[1],e[2])):new THREE.Vector3(0,0,0)}resetToDefault(){this.setExplodeMode(!1),this.bodyTransDeltaMap.clear(),this.bodyTranslateMap.clear(),this.explodeObjects=[],this.explodeFactorZScale=-1,this.worldCenter=null,this.totalBox=new THREE.Box3,this.__setModelCull(!0),this.__original_translation__.length=0,this.__wholeLeafBodyNodes.length=0}getStoreInfo(e){e.explode={factor:this.getExplodeFactor(),mode:this.getExplodeMode(),level:this.getExplodeLevel(),obj:this.explodeObjects,selected:NDSWebViewer.NDS.EXPLODEMODE.SELECTED,dragInfo:this.transformInfo.dragInfo}}setStoreInfo(e){var t;null!=e.explode&&(this.__original_translation__.length=0,t={},this.transformExtension&&(this.transformExtension.getStoreInfo(t),this.transformExtension.restoreAllDraggedObjects()),e.explode.mode&e.explode.selected?(this.explodeObjects=e.explode.obj,this.setExplodeMode(e.explode.mode,e.explode.level,!0)):this.setExplodeMode(e.explode.mode,e.explode.level),this.getExplodeFactor()!=e.explode.factor&&this.onExplode(e.explode.factor),t.dragInfo)&&this.transformExtension.setStoreInfo(t)}onLoad(e){this.sceneWraper=new r(e),this.selectionWraper=new n(e),NDSWebViewer.NDS.EXPLODEMODE={NORMAL:32,X:1,Y:2,Z:4,LEVEL:8,SELECTED:16,YZ:64,XZ:128,XY:256},this.coreViewer=e}onEnter(){this.__setModelCull(!1),this.initExplodeInitialState()}onExit(){var t=this.__wholeLeafBodyNodes.length;for(let e=0;e<t;++e){var o=this.__wholeLeafBodyNodes[e];l.applyTransform(o)}this.__wholeLeafBodyNodes.length=0,this.__setModelCull(!0),this.__original_translation__.length=0}initExplodeInitialState(){let o=[];var t=this.sceneWraper.getModelCount();for(let e=0;e<t;e++){this.sceneWraper.setActiveModel(e);var i=this.sceneWraper.getActiveModel();i.isSketchModel||(o=i.wholeLeafBodyNodes.concat(o))}var e=o.length,r=new THREE.Matrix4;for(let t=0;t<e;++t){var s=o[t];if(r.identity(),s.matrix){for(let e=0;e<16;++e)r.elements[e]=s.matrix[e];s.parent&&r.premultiply(s.parent.worldMatrix)}else s.parent?r.copy(s.parent.worldMatrix):r.identity();this.transformExtension||(this.transformExtension=NDSWebViewer.ExtensionManager.getExtension("TransformExtension"));let e=s;s.ndsModel.NeedsMergeBodyNode&&s.IsMergedNode&&s.responsNode&&(e=s.responsNode);var n=this.transformExtension.getBodyTransform(e);r.premultiply(n),this.__original_translation__[t]=new THREE.Vector3(r.elements[12],r.elements[13],r.elements[14])}this.__wholeLeafBodyNodes=o}getBodyTransform(e,t=void 0){var o=[0,0,0],i=(e.getModel().NeedsMergeBodyNode&&e.IsMergedNode&&(i=void 0!==e.parent.FirstVisibleNode?e.parent.FirstVisibleNode:0,e=e.parent.children[i]),this.getTranslateId(e,t));return this.bodyTranslateMap.has(i)&&(t=this.bodyTranslateMap.get(i),this.explodeMode&this.EXPLODEMODE.NORMAL&&(this.explodeMode&this.EXPLODEMODE.SELECTED&&this.bodyInExplode(e)||0==(this.explodeMode&this.EXPLODEMODE.SELECTED))&&(o[0]=this._explodeFactor*t[0],o[1]=this._explodeFactor*t[1],o[2]=this._explodeFactor*t[2]),this.explodeMode&this.EXPLODEMODE.X&&(this.explodeMode&this.EXPLODEMODE.SELECTED&&this.bodyInExplode(e)||0==(this.explodeMode&this.EXPLODEMODE.SELECTED))&&(o[0]+=this.explodeFactorX*t[0]),this.explodeMode&this.EXPLODEMODE.Y&&(this.explodeMode&this.EXPLODEMODE.SELECTED&&this.bodyInExplode(e)||0==(this.explodeMode&this.EXPLODEMODE.SELECTED))&&(o[1]+=this.explodeFactorY*t[1]),this.explodeMode&this.EXPLODEMODE.Z&&(this.explodeMode&this.EXPLODEMODE.SELECTED&&this.bodyInExplode(e)||0==(this.explodeMode&this.EXPLODEMODE.SELECTED))&&(o[2]+=this.explodeFactorZ*t[2]),this.explodeMode&this.EXPLODEMODE.YZ&&(this.explodeMode&this.EXPLODEMODE.SELECTED&&this.bodyInExplode(e)||0==(this.explodeMode&this.EXPLODEMODE.SELECTED))&&(o[1]=this.explodeFactorYZ*t[1],o[2]=this.explodeFactorYZ*t[2]),this.explodeMode&this.EXPLODEMODE.XZ&&(this.explodeMode&this.EXPLODEMODE.SELECTED&&this.bodyInExplode(e)||0==(this.explodeMode&this.EXPLODEMODE.SELECTED))&&(o[0]=this.explodeFactorXZ*t[0],o[2]=this.explodeFactorXZ*t[2]),this.explodeMode&this.EXPLODEMODE.XY&&(this.explodeMode&this.EXPLODEMODE.SELECTED&&this.bodyInExplode(e)||0==(this.explodeMode&this.EXPLODEMODE.SELECTED))&&(o[0]=this.explodeFactorXY*t[0],o[1]=this.explodeFactorXY*t[1]),this.bodyTransDeltaMap.set(i,o)),this._matrix.makeTranslation(o[0],o[1],o[2])}calculateBodyBoundingBox(e){if(!e||0!=e.selectfromtree){let t=this;var o=(t=this.sceneWraper||"function"!=typeof this.getExtension?t:this.getExtension("ExplodeModelExtension")).selectionWraper.getSelectedObjects();if(1!=e){t.explodeObjects=[];for(var i=new THREE.Box3,r=0;r<o.length;++r){var s,n=o[r],a=(t.sceneWraper.setActiveModelByModelId(n.ndsModel.id),t.sceneWraper.getActiveModel());(g=a.getBodyBoundingBox(n,null,!1))&&!g.isEmpty()&&(i.expandByPoint(g.max),i.expandByPoint(g.min)),n.leafBodyAttri||null!=(a=(s=a.objectidTouuid?n.objectid:a.meshManager.bodyUuid2IdMap[n.uuid])+"-"+n.ndsModel.id)&&-1==t.explodeObjects.indexOf(a)&&t.explodeObjects.push(a)}for(var d=new THREE.Vector3,l=(d=(i.isEmpty()?t.calculateTotalBoundingBox():i).getCenter(d),new THREE.Box3),r=0;r<o.length;++r)for(var h,n=o[r],_=(t.sceneWraper.setActiveModelByModelId(n.ndsModel.id),t.sceneWraper.getActiveModel()),c=0,E=(M=_.getLeafBodies(n,n.ndsModel.id)).length;c<E;c++)M[c].leafBodyAttri&&(_.objectidTouuid?t.explodeObjects.push(M[c].objectid+"-"+n.ndsModel.id):t.explodeObjects.push(M[c].id+"-"+n.ndsModel.id),l.min.fromArray(M[c].leafBodyAttri.bodyBbox,0),l.max.fromArray(M[c].leafBodyAttri.bodyBbox,3),h=M[c].id+"-"+n.ndsModel.id,t.bodyTranslateMap.has(h)||t.bodyTranslateMap.set(h,[0,0,0]),(h=t.bodyTranslateMap.get(h))[0]=.5*(l.min.x+l.max.x)-d.x,h[1]=.5*(l.min.y+l.max.y)-d.y,h[2]=.5*(l.min.z+l.max.z)-d.z)}else{i=new THREE.Box3;t.sceneWraper.getActiveModel();for(r=0;r<t.explodeObjects.length;++r){var x=t.explodeObjects[r];let e=x.split("-")[0];var x=x.split("-")[1],p=t.sceneWraper.getModelById(Number(x)),n=(u=(p.objectidTouuid||p.meshManager.bodyUuids)[e],p.getBodyNodeFromUuid(u));if(n||(u=p.meshManager.lineSegBodyUuids[e],n=p.getBodyNodeFromUuid(u)),n.leafBodyAttri)(g=p.getBodyBoundingBox(n,null,!1))&&!g.isEmpty()&&(i.expandByPoint(g.max),i.expandByPoint(g.min));else for(var M,g,c=0,E=(M=p.getLeafBodies(n)).length;c<E;c++)M[c].leafBodyAttri&&(g=p.getBodyBoundingBox(M[c],null,!1))&&!g.isEmpty()&&(i.expandByPoint(g.max),i.expandByPoint(g.min))}for(d=i.getCenter(),l=new THREE.Box3,r=0;r<t.explodeObjects.length;++r){var u,m=t.explodeObjects[r];let e=m.split("-")[0];var m=m.split("-")[1],m=t.sceneWraper.getModelById(Number(m));u=(m.objectidTouuid||m.meshManager.bodyUuids)[e],(n=m.getBodyNodeFromUuid(u))||(u=m.meshManager.lineSegBodyUuids[e],n=m.getBodyNodeFromUuid(u)),n.leafBodyAttri&&(l.min.fromArray(n.leafBodyAttri.bodyBbox,0),l.max.fromArray(n.leafBodyAttri.bodyBbox,3),m=this.getTranslateId(n),t.bodyTranslateMap.has(m)||t.bodyTranslateMap.set(m,[0,0,0]),(m=t.bodyTranslateMap.get(m))[0]=.5*(l.min.x+l.max.x)-d.x,m[1]=.5*(l.min.y+l.max.y)-d.y,m[2]=.5*(l.min.z+l.max.z)-d.z)}}}}calculateRootBoundingBox(t){if(t._leafBodyAttri&&(0<t._leafBodyAttri._bodyLineSegIds.length&&(t.ndsModel.viewer.is2DModel||0===t.ndsModel.meshManager.nMeshes)||0<t._leafBodyAttri._bodyMeshIds.length))t._mesh_box_dirty_&&t._leafBodyAttri.updateBoundingBox(),this.__bbox__.min.fromArray(t._leafBodyAttri.bodyBbox,0),this.__bbox__.max.fromArray(t._leafBodyAttri.bodyBbox,3),this.totalBox.union(this.__bbox__);else for(let e=0;e<t.children.length;e++)this.calculateRootBoundingBox(t.children[e])}calculateTotalBoundingBox(){var t=this.sceneWraper.getModelCount();this.totalBox.makeEmpty();for(let e=0;e<t;e++){var o=this.sceneWraper.getModelByIndex(e);o.isSketchModel||this.calculateRootBoundingBox(o.rootBodyNode)}return this.totalBox}setExplodeMode(e,t=0,o=!1){var i=Date.now(),r=(0==(e&this.EXPLODEMODE.NORMAL)&&0==(e&this.EXPLODEMODE.X)&&0==(e&this.EXPLODEMODE.Y)&&0==(e&this.EXPLODEMODE.Z)&&0==(e&this.EXPLODEMODE.YZ)&&0==(e&this.EXPLODEMODE.XZ)&&0==(e&this.EXPLODEMODE.XY)&&(e+=this.EXPLODEMODE.NORMAL),this.sceneWraper.isECAD3DView()?this.explodeFactorZScale<0&&(_=this.calculateTotalBoundingBox(),a=Math.max(_.max.x-_.min.x,Math.max(_.max.y-_.min.y,_.max.z-_.min.z)),_=Math.min(_.max.x-_.min.x,Math.min(_.max.y-_.min.y,_.max.z-_.min.z)),a=Math.min(a/(Math.abs(_)<.01?1:_),8),this.explodeFactorZScale=a):this.explodeFactorZScale=1,this.isExploded()&&this.onExplode(0),this.transformExtension||(this.transformExtension=NDSWebViewer.ExtensionManager.getExtension("TransformExtension")),this.transformInfo={},this.transformExtension&&this.transformExtension.getStoreInfo(this.transformInfo),this.explodeMode=e,this.explodeLevel=t,[]),s=this.sceneWraper.getModelCount();for(let e=0;e<s;e++){var n=this.sceneWraper.getModelByIndex(e);n.isSketchModel||r.push(n.rootBodyNode)}var a,d=[],l=this.sceneWraper.getActiveModel(),h=new THREE.Vector3,_=NDSWebViewer.ExtensionManager.getExtension("NDSAnimationExtension");if(_&&_._enableAnimation){let e=_.getVisibleBoundingBox();e.isEmpty()||(h=e.getCenter(h))}else h=this.calculateTotalBoundingBox().getCenter(h);if(e&this.EXPLODEMODE.LEVEL){for(var c=0;c<r.length;++c){var E=r[c].getLevel();if(E==t)d.push(r[c]);else if(E<t&&0==r[c].children.length&&0<=r[c].id&&!r[c].isReferenceEntity())d.push(r[c]);else if(E<t&&0<r[c].children.length)for(var x=0,p=r[c].children.length;x<p;++x)r.push(r[c].children[x])}for(var M=new THREE.Box3,c=0;c<d.length;++c){var g=d[c],M=l.getBodyBoundingBox(g,null,!1),u=l.getLeafBodies(g);if(M)for(var m,y=0,O=u.length;y<O;y++)u[y].leafBodyAttri&&(m=u[y].id+"-"+g.ndsModel.id,this.bodyTranslateMap.has(m)||this.bodyTranslateMap.set(m,[0,0,0]),(m=this.bodyTranslateMap.get(m))[0]=.5*(M.min.x+M.max.x)-h.x,m[1]=.5*(M.min.y+M.max.y)-h.y,m[2]=.5*(M.min.z+M.max.z)-h.z)}for(let e=0;e<s;e++){this.sceneWraper.setActiveModel(e);var B=this.sceneWraper.getActiveModel();if(!B.isSketchModel)for(var c=0,w=B.geomManager.geoms.length;c<w;++c)B.geomManager.geoms[c].updateModelMatrix=!0}}if(e&this.EXPLODEMODE.NORMAL&&(this.explodeMode&=~this.EXPLODEMODE.X,this.explodeMode&=~this.EXPLODEMODE.Y,this.explodeMode&=~this.EXPLODEMODE.Z,this.explodeMode&=~this.EXPLODEMODE.YZ,this.explodeMode&=~this.EXPLODEMODE.XZ,this.explodeMode&=~this.EXPLODEMODE.XY,this.explodeObject)&&this.explodeObject.detach(),e&this.EXPLODEMODE.SELECTED?(this.calculateBodyBoundingBox(o),this.sceneWraper.addEventListener("selectObject",this.calculateBodyBoundingBox)):(this.explodeObjects=[],this.sceneWraper.removeEventListener("selectObject",this.calculateBodyBoundingBox)),(e&this.EXPLODEMODE.X||e&this.EXPLODEMODE.Y||e&this.EXPLODEMODE.Z||e&this.EXPLODEMODE.YZ||e&this.EXPLODEMODE.XZ||e&this.EXPLODEMODE.XY)&&(this.explodeObject?(this.explodeObject.attach(l.rootBodyNode),this.explodeObject.visible=!1,this.explodeObject.name="explodeObject"):(a=null,a=this.sceneWraper.getCanvas2D()?this.sceneWraper.getCanvas2D():this.sceneWraper.getCanvas3D(),(_=new NDSWebViewer.NdsCoordSystem(this.sceneWraper.getCamera(),a)).name="explodeObject",_.attach(l.rootBodyNode),this.explodeObject=_,this.sceneWraper.getAdditionalObjectsScene().add(_),this.explodeObject.visible=!1)),0==(this.explodeMode&this.EXPLODEMODE.LEVEL)&&0==(this.explodeMode&this.EXPLODEMODE.SELECTED))for(let e=0;e<s;e++){var f=this.sceneWraper.getModelByIndex(e);if(!f.isSketchModel){var b=f.wholeLeafBodyNodes.length;let o=this.__bbox__;for(let e=0;e<b;++e){var D=f.wholeLeafBodyNodes[e],L=f.wholeLeafBodyNodes[e].leafBodyAttri;if(L){let t="";if(D.IsInstanceNode&&1<D.instanceNum)for(let e=0;e<D.instanceNum;++e){o=D.getInstanceBoundingBox(e,o),t=this.getTranslateId(D,e),this.bodyTranslateMap.has(t)||this.bodyTranslateMap.set(t,[0,0,0]);var V=this.bodyTranslateMap.get(t);V[0]=.5*(o.min.x+o.max.x)-h.x,V[1]=.5*(o.min.y+o.max.y)-h.y,V[2]=.5*(o.min.z+o.max.z)-h.z}o.min.fromArray(L.bodyBbox,0),o.max.fromArray(L.bodyBbox,3),t=this.getTranslateId(D),this.bodyTranslateMap.has(t)||this.bodyTranslateMap.set(t,[0,0,0]);L=this.bodyTranslateMap.get(t);L[0]=.5*(o.min.x+o.max.x)-h.x,L[1]=.5*(o.min.y+o.max.y)-h.y,L[2]=.5*(o.min.z+o.max.z)-h.z}}}}this.sceneWraper.renderAllViews(),this.sceneWraper.logOperatorTimeShow("[爆炸-设置]",i)}selectExplodeEvent(e){0!=(this.explodeMode&NDS.EXPLODEMODE.SELECTED)&&(e?this.sceneWraper.addEventListener("selectObject",this.calculateBodyBoundingBox):this.sceneWraper.removeEventListener("selectObject",this.calculateBodyBoundingBox))}isExploded(){return 1e-6<Math.abs(this.explodeFactor)}getCurrentEstimateSceneBox(e,t){var o,i=e.clone(),r=1.3,s=1/r;return this.explodeMode&this.EXPLODEMODE.NORMAL?(o=this._explodeFactor<s?1:r*this._explodeFactor,i.min.x=t.x+(e.min.x-t.x)*o,i.min.y=t.y+(e.min.y-t.y)*o,i.min.z=t.z+(e.min.z-t.z)*o,i.max.x=t.x+(e.max.x-t.x)*o,i.max.y=t.y+(e.max.y-t.y)*o,i.max.z=t.z+(e.max.z-t.z)*o):this.explodeMode&this.EXPLODEMODE.X?(o=this.explodeFactorX<s?1:r*this.explodeFactorX,i.min.x=t.x+(e.min.x-t.x)*o,i.max.x=t.x+(e.max.x-t.x)*o):this.explodeMode&this.EXPLODEMODE.Y?(o=this.explodeFactorY<s?1:r*this.explodeFactorY,i.min.y=t.y+(e.min.y-t.y)*o,i.max.y=t.y+(e.max.y-t.y)*o):this.explodeMode&this.EXPLODEMODE.Z?(o=this.explodeFactorZ<s?1:r*this.explodeFactorZ,i.min.z=t.z+(e.min.z-t.z)*o,i.max.z=t.z+(e.max.z-t.z)*o):this.explodeMode&this.EXPLODEMODE.YZ?(o=this.explodeFactorYZ<s?1:r*this.explodeFactorYZ,i.min.y=t.y+(e.min.y-t.y)*o,i.max.y=t.y+(e.max.y-t.y)*o,i.min.z=t.z+(e.min.z-t.z)*o,i.max.z=t.z+(e.max.z-t.z)*o):this.explodeMode&this.EXPLODEMODE.XZ?(o=this.explodeFactorXZ<s?1:r*this.explodeFactorXZ,i.min.x=t.x+(e.min.x-t.x)*o,i.max.x=t.x+(e.max.x-t.x)*o,i.min.z=t.z+(e.min.z-t.z)*o,i.max.z=t.z+(e.max.z-t.z)*o):this.explodeMode&this.EXPLODEMODE.XY&&(o=this.explodeFactorXY<s?1:r*this.explodeFactorXY,i.min.x=t.x+(e.min.x-t.x)*o,i.max.x=t.x+(e.max.x-t.x)*o,i.min.y=t.y+(e.min.y-t.y)*o,i.max.y=t.y+(e.max.y-t.y)*o),i}onExplode(e,t){var o,i,r=Date.now();e!=this.explodeFactor&&(this.sceneWraper.toggleAutoRotation(!1),this.worldCenter&&this.totalBox||(this.worldCenter=new THREE.Vector3,this.totalBox=this.calculateTotalBoundingBox(),this.worldCenter=this.totalBox.getCenter(this.worldCenter)),this.setExplodeFactor(this.worldCenter,4*e),this.explodeFactor=e,i=this.getCurrentEstimateSceneBox(this.totalBox,this.worldCenter),0==e?(this.sceneWraper.updateGroundTransform(this.sceneWraper.getCamera(),i,this.sceneWraper.getCamera().worldup),this.sceneWraper.getCamera().setOrthoNear(i)):(this.sceneWraper.updateGroundTransform(this.sceneWraper.getCamera(),i,this.sceneWraper.getCamera().worldup),this.sceneWraper.getCamera().setOrthoNear(i),e=i,i=new THREE.Vector3,e.getCenter(i),e=e.min.distanceTo(e.max),o=this.sceneWraper.getCamera().position.clone(),i=Math.abs(i.distanceTo(o))+10*e,this.sceneWraper.getCamera().adjustNearFar(i,i)),0!=t&&this.sceneWraper.renderAllViews(),this.sceneWraper.dispatchEvent({type:"explodingModel"}),NDSWebViewer.SETTING.enableBroadcast&&NDSWebViewer.SETTING.broadcastMajor&&NDSWebViewer.ExtensionManager.updateBroadcastInfo(this.name),this.sceneWraper.logOperatorTimeShow("[爆炸-缩放]",r))}setExplodeFactor(e,t){this._explodeFactor=0,this.explodeFactorX=0,this.explodeFactorY=0,this.explodeFactorZ=0,this.explodeFactorYZ=0,this.explodeFactorXZ=0,this.explodeFactorXY=0,this.explodeMode&this.EXPLODEMODE.NORMAL?this._explodeFactor=t:this.explodeMode&this.EXPLODEMODE.X?this.explodeFactorX=t:this.explodeMode&this.EXPLODEMODE.Y?this.explodeFactorY=t:this.explodeMode&this.EXPLODEMODE.Z?this.explodeFactorZ=this.explodeFactorZScale<0?t:t*this.explodeFactorZScale:this.explodeMode&this.EXPLODEMODE.YZ?this.explodeFactorYZ=t:this.explodeMode&this.EXPLODEMODE.XZ?this.explodeFactorXZ=t:this.explodeMode&this.EXPLODEMODE.XY&&(this.explodeFactorXY=t);let o=[];var i,r=this.sceneWraper.getModelCount();for(let e=0;e<r;e++){this.sceneWraper.setActiveModel(e);var s=this.sceneWraper.getActiveModel();s.isSketchModel||(o=s.wholeLeafBodyNodes.concat(o))}var n=o.length;for(let e=0;e<n;++e){var a=o[e];if(0===this.__original_translation__.length)l.applyTransform(a);else if(!0===a.IsInstanceNode&&1<a.instanceNum)a._updateInstancedBodyMatrix();else if(a._leafBodyAttri){i=this.getBodyTransform(a),a.worldMatrix.elements[12]=this.__original_translation__[e].x+i.elements[12],a.worldMatrix.elements[13]=this.__original_translation__[e].y+i.elements[13],a.worldMatrix.elements[14]=this.__original_translation__[e].z+i.elements[14];for(let e=0;e<a.synchronizedWorldMatrix.length;++e)a.synchronizedWorldMatrix[e].copy(a.worldMatrix);a._mesh_box_dirty_=!0,a.__setBoundingBoxDirty__(),a.ndsModel.meshManager.makeMeshBBoxDirty(a._leafBodyAttri._bodyMeshIds)}}this.__wholeLeafBodyNodes=o;for(let e=0;e<r;e++){var d=this.sceneWraper.getModelByIndex(e);d.isSketchModel||d.refreshBodyWorldMatrixUniforms()}}setExplodeAxisVisible(e,t){t&&(t=t.toUpperCase(),this.explodeAxis=t),this.explodeObject&&(this.explodeObject.visible=!0,this.explodeObject.axisVisible(e,t)),this.sceneWraper.renderAllViews()}bodyInExplode(e){var t=e.ndsModel;return t.objectidTouuid?-1!==this.explodeObjects.indexOf(e.objectid+"-"+t.id):-1!==this.explodeObjects.indexOf(e.id+"-"+t.id)}getExplodeObjects(){return this.explodeObjects}setExplodeObjects(e){this.explodeObjects=e}getExplodeLevel(){return this.explodeLevel}getExplodeFactor(){return this.explodeFactor}getExplodeMode(){return this.explodeMode}__setModelCull(t){var o=this.sceneWraper.getModelCount();for(let e=0;e<o;e++){var i=this.sceneWraper.getModelByIndex(e);i.isSketchModel||void 0===i.shouldApplyCull||(i.shouldApplyCull=t)}}};NDSWebViewer.ExtensionManager.addExtension(t)}],i={},r.m=o,r.c=i,r.d=function(e,t,o){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var o=Object.create(null);if(r.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)r.d(o,i,function(e){return t[e]}.bind(null,i));return o},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=1);function r(e){var t;return(i[e]||(t=i[e]={i:e,l:!1,exports:{}},o[e].call(t.exports,t,t.exports,r),t.l=!0,t)).exports}var o,i});