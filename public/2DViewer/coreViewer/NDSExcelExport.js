!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.NDSExcelExport=t():e.NDSExcelExport=t()}(window,function(){return r=[function(e,t,r){r.r(t);console.log("NDS ExtensionFramework V0.1"),NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM,NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM,NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM,NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM,NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM;class i extends NDSWebViewer.Extension{constructor(){super()}onLoad(e){}onInitLights(){}update(e){}setFlags(e){super.setFlags(e)}onNdsModelPrepareForRendering(e){}onBeforeNdsModelUpdate(e,t){}onAfterNdsModelUpdate(e,t){}onBeforeNdsModelSetRender(e,t){}onAfterNdsModelSetRender(e,t){}onBeforeNdsMeshRender(e,t){}onBeforeScreenCapture(e){}onAfterScreenCapture(){}onBeforeChangeBackGroundColor(e){}onAfterChangeBackGroundColor(e){}onAfterWindowResize(e,t,r){}onSetCaptureView(e,t){}getExtensionWithFlags(e){return NDSWebViewer.ExtensionManager.getExtensionWithFlags(e)}resetToDefault(){}needDisableInputEvent(){}getStoreInfo(e){throw this.name+" Extesion did not implement method 'getStoreInfo' "}setStoreInfo(e){throw this.name+" Extesion did not implement method 'setStoreInfo' "}getBodyTransform(e){return new THREE.Matrix4}getBodyNodeTranslate(e){return new THREE.Vector3(0,0,0)}}class n{constructor(e){this.__meshstate__=e}getMeshMaterial(e){return this.__meshstate__.getMeshMaterial(e)}setMeshMaterial(e,t){this.__meshstate__.setMeshMaterial(e,t)}setMeshMaterialTemporary(e,t){var r,e=this.__meshstate__.meshMtls.get(e);e&&(r=e.material,e.material=t,this.__meshstate__.__updateMeshMtlBuffer(e.meshMtlIndex,e),this.__meshstate__.meshMtlTexture.needsUpdate=!0,e.material=r,e.meshSet.needsUpdate=!0,e.meshSet.prepareForBatchDraw())}getLineMaterial(e){this.__meshstate__.getLineMaterial(e)}setLineMaterial(e,t,r){this.__meshstate__.setLineMaterial(e,t,r)}setLineMaterialTemporary(e,t,r){var e=this.__meshstate__.lineMtls.get(e);e&&(e=2*e.lineMtlIndex,this.__meshstate__.lineMtlBuffer[e]=t,this.__meshstate__.lineMtlBuffer[1+e]=Math.round(1e3*r),this.__meshstate__.lineMtlTexture.needsUpdate=!0)}}class s{constructor(e){this.__brepManager__=e}get brepInfos(){return this.__brepManager__.brepInfos}hasBrepInfo(){return this.__brepManager__.hasBrepInfo()}hasBrepFile(){return this.__brepManager__.hasBrepFile()}}class o{constructor(e){(this.__ndsModel__=e).meshState&&(this.__meshState__=new n(e.meshState)),e.brepManager&&(this.__brepManager__=new s(e.brepManager))}get isMCAD3DModel(){return this.__ndsModel__.isMCAD3DModel}get isMCAD2DModel(){return this.__ndsModel__.isMCAD2DModel}get typeName(){return this.__ndsModel__.typeName}get ndsModelId(){return this.__ndsModel__.id}get numMesh(){}getMeshState(){return this.__meshState__}getBrepManager(){return this.__brepManager__}getPMIObject(){return this.__ndsModel__.pmiObject}getRootBodyNode(){return this.__ndsModel__.rootBodyNode}getBodyNode(e){return this.__ndsModel__.getBodyNode(e)}getLeafBodies(e){return this.__ndsModel__.getLeafBodies(e)}isSketchModel(){return!!this.__ndsModel__.isSketchModel}getLeafBodyNodes(){return this.__ndsModel__.wholeLeafBodyNodes}transparentizeBodies(e){this.__ndsModel__.transparentizeBodies(e)}isolateBodies(e){this.__ndsModel__.isolateBodies(e,NDSWebViewer.SETTING.bodyOpacity,NDSWebViewer.SETTING.lineOpacity)}clearTransparentBodies(){this.__ndsModel__.exitIsolate()}getMeshSets(){return this.__ndsModel__.getMeshSets()}changeObjectidTouuid(e){return this.__ndsModel__.objectidTouuid[e]}getMeshMaterial(e){return this.__ndsModel__?(e=this.__ndsModel__.meshManager.materialId[e],e=this.__ndsModel__.meshManager.materialUuids[e],this.__ndsModel__.meshManager.materials[e].mat):null}setMeshMaterial(e,t){if(!this.__ndsModel__)return!1;var r=this.__ndsModel__;let i=0;if(r.meshManager.materials[t.uuid]){for(let e=0;e<r.meshManager.materialUuids.length;e++)if(r.meshManager.materialUuids[e]===t.uuid){i=e;break}}else r.meshManager.materials[t.uuid]={mat:t,refCount:0},i=r.meshManager.materialUuids.length,r.meshManager.materialUuids.push(t.uuid);var n=r.meshManager.materialId[e],n=r.meshManager.materialUuids[n];return r.meshManager.materials[n].refCount--,r.meshManager.materials[t.uuid].refCount++,r.meshManager.materialId[e]=i,r.meshManager.materialIdOriginal[e]=i,!0}removeAllBodyNodeMaterials(){this.__ndsModel__.removeAllBodyNodeMaterials()}refreshBodyWorldMatrixUniforms(){this.__ndsModel__.refreshBodyWorldMatrixUniforms()}refreshMeshState(e=void 0){this.__ndsModel__.refreshMeshState(e||this.__ndsModel__.rootBodyNode)}}class a{constructor(e){this.__coreView__=e}addEventListener(e,t){this.__coreView__.addEventListener(e,t)}hasEventListener(e,t){return this.__coreView__.hasEventListener(e,t)}removeEventListener(e,t){this.__coreView__.removeEventListener(e,t)}dispatchEvent(e){this.__coreView__.dispatchEvent(e)}getPixelRatio(){return this.__coreView__.renderer.getPixelRatio()}switchRotateCenterBySelection(){this.__coreView__.switchRotateCenterBySelection()}setDefaultEnvMap(e){e&&(this.__coreView__.hasPbrMaterial=!0,this.__coreView__.setDefaultEnvMap=()=>{this.__coreView__.setEnvMapEnabled(!0),this.__coreView__.defaultEnvMapTexture=e,this.__coreView__.updateEnvMap(this.__coreView__.defaultEnvMapTexture)},this.__coreView__.setDefaultEnvMap())}getBackgroundState(){return this.__coreView__.exchangeBackImage?{type:this.__coreView__.exchangeBackImage.type,value:this.__coreView__.exchangeBackImage.value}:void 0}setBackgroundState(e,t){"Image"===e?(this.__coreView__.setEnvMapTextures(null),this.__coreView__.setBackGroundImage(t)):"EnvMap"===e?this.__coreView__.setEnvMapTextures(t):"Color"===e&&(this.__coreView__.setEnvMapTextures(null),this.__coreView__.setBackGroundImage(null),this.__coreView__.setBackGroundColor(t))}removeAllLights(){this.__coreView__.lights.length=0}getLight(e){return this.__coreView__.lights[e]}setLight(e,t){this.__coreView__.lights[e]=t}getViewBox(){return this.__coreView__.viewBox}toggleAutoRotation(e){this.__coreView__.toggleAutoRotation(e)}randColor(){return this.__coreView__.materialsSetting.randColor()}getBoundingBox(e=!1){e=this.__coreView__.ndsModel.getTotalBodyBoundingBox(null,e);return e.isEmpty()?this.__coreView__.modelRootObject.boundingBox:e}getModelTree(){return this.__coreView__.getModelTree()}getModelCount(){return this.__coreView__.ndsModel.models.length}setActiveModel(e){this.__coreView__.ndsModel.setActiveModel(e)}setActiveModelByModelId(t){let r=-1;for(let e=0;e<this.__coreView__.ndsModel.models.length;++e)if(this.__coreView__.ndsModel.models[e].id===t){r=e;break}this.setActiveModel(r)}getActiveModel(){return this.__coreView__.ndsModel.getActiveModel()}getModelById(e){return this.__coreView__.ndsModel.getModelById(e)}getModelByIndex(e){return this.__coreView__.ndsModel.models[e]}registOperator(e,t){this.__coreView__.registOperator(e,t)}setOperatorByID(e){this.__coreView__.setOperatorByID(e)}getCurrentOperator(){return this.__coreView__.controls.getOperator()}getCurrentOperatorID(){return this.__coreView__.getCurrentOperatorID()}setOperator(e){this.__coreView__.setOperator(e)}registCursor(e,t,r){this.__coreView__.registCursor(e,t,r)}hideSelectedObjects(){this.__coreView__.hideSelectedObjects()}getViewControlBoundingBox(){return this.__coreView__.controls.getBoundingBox()}setViewControlBoundingBox(e,t){this.__coreView__.controls.setBoundingBox(e,t)}getCamera(){return this.__coreView__.camera}setCameraControlBoundingBoxCenter(e){this.__coreView__.cameraControl.setBoundingBoxCenter(e)}setCameraControlBounding(e,t){this.__coreView__.cameraControl.setBoundingBox(e,t)}getRotateCenter(){return this.__coreView__.cameraControl.getRotateCenter()}setRotateCenter(e){this.__coreView__.cameraControl.setRotateCenter(e)}getViewLockedState(){return this.__coreView__.cameraControl.isViewLockedBySingleBody}setViewLockedState(e){this.__coreView__.cameraControl.isViewLockedBySingleBody=e}getCameraInfo(){return this.__coreView__.cameraControl.getCameraInfo()}adjustNearAndFar(){this.__coreView__.cameraControl.adjustNearAndFar()}updateViewBoxCamDir(){this.__coreView__.cameraControl.updateViewBoxCamDir()}startSmoothTranslation(e){this.__coreView__.cameraControl.startSmoothTranslation(e)}zoomExtents(e,t,r){this.__coreView__.cameraControl.zoomExtents(e,t,r)}setCameraInfo(e,t){this.__coreView__.cameraControl.setCameraInfo(e,t)}getOrginalCameraInfo(){return(this.__coreView__.viewManager||this.__coreView__.camera).getOrginalCameraInfo()}setOrginalCameraInfo(e,t,r){this.__coreView__.camera.setOrginalCameraInfo({center:e,up:t,position:r})}toPerspectiveCamera(){this.__coreView__.toPerspectiveCamera()}toOrthographicCamera(){this.__coreView__.toOrthographicCamera()}updateGroundTransform(e,t,r){return this.__coreView__.groundShadow.updateGroundTransform(e,t,r)}isRendererContainsClipPlanes(){return 0<this.__coreView__.renderer.clippingPlanes.length}getCanvas2D(){return this.__coreView__.canvas2D}getCanvas3D(){return this.__coreView__.canvas3D}getContainer(){return this.__coreView__.container}getRenderDomElement(){return this.__coreView__.renderer.domElement}getAdditionalObjectsScene(){return this.__coreView__.additionalObjectsScene}getDispalyModelUnit(e,t){return this.__coreView__.getDispalyModelUnit(e,t)}modelCoordToClientCoord(e){return this.__coreView__.modelCoordToClientCoord(e)}clientCoordToModelCoord(e){return this.__coreView__.clientCoordToModelCoord(e)}showObject(e,t,r,i=!0){this.__coreView__.showObject(e,t,r,i)}showObjectReversed(e){this.__coreView__.showObjectReversed(e)}renderAllViews(){this.__coreView__.renderAllViews()}render(e){this.__coreView__.render(e)}setRenderMode(e,t){this.__coreView__.setRenderMode(e,t)}getRenderMode(){let e=void 0;switch(this.__coreView__.getRenderMode()){case 0:e="lighting";break;case 1:e="primarycolor";break;case 2:e="wireframe";break;case 3:e="whitemold";break;case 4:e="shadedWithEdges";break;case 5:e="shaded";break;case 6:e="hiddenLineRemove";break;case 7:e="hiddenLineVisible";break;case 8:e="transparent"}return e}getAssemblyPMIState(){return this.__coreView__.AssemblyPMIState}setAssemblyPMIState(e){this.__coreView__.AssemblyPMIState=e}getPartPMIState(){return this.__coreView__.PartPMIState}setPartPMIState(e){this.__coreView__.PartPMIState=e}getPmiVisible(){return this.__coreView__.pmiVisible}setPmiVisible(e){this.__coreView__.pmiVisible=e}setPMIObjectVisible(e,t){this.__coreView__.setPMIObjectVisible(e,t)}isPMIOccludeByModel(){return!NDSWebViewer.SETTING.StopPMIOcclusion}enablePMIOccludeByModel(e){this.__coreView__.stopPMIOcclusion(!e)}getPmiList(){return this.__coreView__.PMINDSBodys}getPMIObjectByUUID(e){return this.__coreView__.PMIUUIDtoPMIObject[e]}isPMIObjectOrSomeChildHidden(e){return this.__coreView__.isPMIObjectOrSomeChildHidden(e)}getPmiObjectTree(){return this.__coreView__.pmiObject}getSelectedPmiList(){return this.__coreView__.getPMINDSBodySelectList()}selectPMIObject(e,t=!0){this.__coreView__.selectPMIObject(e,t)}deselectPMIObject(e,t=!0){this.__coreView__.deselectPMIObject(e,t)}unmergeBodyNode(){this.__coreView__.ndsModel.unmergeNode()}mergeBodyNode(){this.__coreView__.ndsModel.mergeNode()}getAllTransparentBodies(e){return this.__coreView__.ndsModel.getAllTransparentBodies(e)}isolateBodiesOnly(e){this.__coreView__.ndsModel.isolateBodiesOnly(e)}unloadModelById(e){this.__coreView__.ndsModel.unloadModelById(e)}startLoadAnimationModel(e){var t=e.url,r=e.id,i={needsPMI:!1,needsAnimation:!1,needsSketchModel:!1,position:e.position,pmiVisible:this.__coreView__.pmiVisible,modelId:e.modelId};this.__coreView__.ndsModel.setGlobalObjectId&&this.__coreView__.ndsModel.setGlobalObjectId(0),e.singleHTML?this.__coreView__.loadModelFlate(t,i):this.__coreView__.loadModel(r,t,null,null,"js",null,null,null,i)}getBodyNodeFromUuid(t,e=-1){var r=null;return 0<=e?(e=this.getModelById(e))&&(e=e.getBodyNodeFromUuid(t))&&(r=e):this.__coreView__.ndsModel.models.forEach(e=>{e=e.getBodyNodeFromUuid(t);e&&(r=e)}),r}loadBrepInfo(e){this.__coreView__.loadBrepInfo(e)}enableTransparent(e){this.__coreView__.enableTransparent(e)}}function l(e,t){NDSWebViewer.OpBase.call(this,e),this.extension=t,this.sceneWraper=this.extension.sceneWraper,e=this.sceneWraper.getModelByIndex(0),this.extension.modelWraper&&this.extension.modelWraper.ndsModelId==e.id||(this.extension.modelWraper=new o(e)),this.modelWraper=this.extension.modelWraper,this.brepManager=this.modelWraper.getBrepManager(),this.camera=this.sceneWraper.getCamera(),this.type="OpExcelExport",this.opMode="normal",this.selectPos=-1,this.selectStep=NDSWebViewer.COMMON.isMobileDevice()?16:5,!this.brepManager.hasBrepInfo()&&this.brepManager.hasBrepFile()?this.sceneWraper.loadBrepInfo(!1):this.sceneWraper.dispatchEvent({type:"BrepInfoEvent"}),this.intersectBodies=[],this.textIntersectBodies=[],this.prettyExcels=[],this.offsetModelCoord1=null,this.offsetModelCoord2=null,this.longClick=0,this.points=[],this.horizontalLine=new Map,this.verticalLine=new Map,this.createDiv(),this.PostInfo(1)}(l.prototype=Object.create(NDSWebViewer.OpBase.prototype)).onNMouseMove=function(e){this.prompt&&!NDSWebViewer.COMMON.isMobileDevice()&&(0<this.InfoType?this.prompt.style.display="block":this.prompt.style.display="none",this.prompt.style.left=e.clientX+16+"px",this.prompt.style.top=e.clientY+18+"px")},l.prototype.PostInfo=function(t){if(this.prompt)if(this.Popup&&(clearTimeout(this.Popup),this.Popup=null),t){this.InfoType=t;var r="";NDSWebViewer.COMMON.isMobileDevice(),1==t&&(r=NDSWebViewer.COMMON.translateString("Excel_SelectTableArea")),this.prompt.innerHTML=r,this.prompt.style.display="block";let e=this;NDSWebViewer.COMMON.isMobileDevice()&&(this.Popup=setTimeout(function(){e.prompt&&(e.prompt.style.display="none")},3e3))}else this.InfoType=0,this.prompt.style.display="none",this.prompt.innerHTML=""},l.prototype.createDiv=function(e){this.prompt=document.getElementById("excel_prompt"),this.prompt||(this.prompt=document.createElement("div"),this.prompt.id="excel_prompt",NDSWebViewer.COMMON.isMobileDevice()?this.prompt.className="app-alert":this.prompt.className="pc-alert",this.sceneWraper.getContainer().appendChild(this.prompt))},l.prototype.onLMouseUp=function(e){var t,r,i;0<this.viewer.Rectangle.length&&("ExcelExtend"!=this.opMode&&(this.sceneWraper.dispatchEvent({type:"ExcelEnd"}),this.opMode="ExcelExtend",this.PostInfo(0)),this.rectX1=this.viewer.Rectangle[0],this.rectX2=this.viewer.Rectangle[1],this.rectY1=this.viewer.Rectangle[2],this.rectY2=this.viewer.Rectangle[3],t=this.sceneWraper.getPixelRatio(),r=[this.rectX1,this.rectY1],i=[this.rectX2,this.rectY2],r[0]/=t,r[1]/=t,i[0]/=t,i[1]/=t,this.offsetModelCoord1=this.sceneWraper.clientCoordToModelCoord(r),this.offsetModelCoord2=this.sceneWraper.clientCoordToModelCoord(i)),NDSWebViewer.OpBase.prototype.onLMouseUp.call(this,e)},l.prototype.onRMouseUp=function(e){var t,r,i;0<this.viewer.Rectangle.length&&(this.rectX1=this.viewer.Rectangle[0],this.rectX2=this.viewer.Rectangle[1],this.rectY1=this.viewer.Rectangle[2],this.rectY2=this.viewer.Rectangle[3],t=[this.rectX1,this.rectY1],r=[this.rectX2,this.rectY2],i=this.sceneWraper.getPixelRatio(),t[0]/=i,t[1]/=i,r[0]/=i,r[1]/=i,this.offsetModelCoord1=this.sceneWraper.clientCoordToModelCoord(t),this.offsetModelCoord2=this.sceneWraper.clientCoordToModelCoord(r)),NDSWebViewer.OpBase.prototype.onRMouseUp.call(this,e)},l.prototype.onTouchSingleStart=function(r){NDSWebViewer.OpBase.prototype.onTouchSingleStart.call(this,r);var r=this,i=r.viewer.renderer.getPixelRatio();if(r.selectPos=-1,0<r.viewer.Rectangle.length){var n=(r.viewer.Rectangle[0]+r.viewer.Rectangle[1])/2,s=(r.viewer.Rectangle[2]+r.viewer.Rectangle[3])/2,o=Math.min(r.viewer.Rectangle[0],r.viewer.Rectangle[1]),a=Math.max(r.viewer.Rectangle[0],r.viewer.Rectangle[1]),l=Math.min(r.viewer.Rectangle[2],r.viewer.Rectangle[3]),h=Math.max(r.viewer.Rectangle[2],r.viewer.Rectangle[3]),c=r.singleTouchStartPos.x*i,d=r.singleTouchStartPos.y*i;let e=-1,t=-1;i=r.selectStep*i;Math.abs(c-o)<i?e=0:Math.abs(c-n)<i?e=1:Math.abs(c-a)<i&&(e=2),Math.abs(d-l)<i?t=0:Math.abs(d-s)<i?t=1:Math.abs(d-h)<i&&(t=2),0==e&&0==t?r.selectPos=0:1==e&&0==t?r.selectPos=1:2==e&&0==t?r.selectPos=2:2==e&&1==t?r.selectPos=3:2==e&&2==t?r.selectPos=4:1==e&&2==t?r.selectPos=5:0==e&&2==t?r.selectPos=6:0==e&&1==t&&(r.selectPos=7)}-1!=r.selectPos&&(r.opMode="ExcelChange")},l.prototype.onTouchSingleEnd=function(e){var t,r,i;0<this.viewer.Rectangle.length&&("ExcelExtend"!=this.opMode&&(this.sceneWraper.dispatchEvent({type:"ExcelEnd"}),this.opMode="ExcelExtend",this.PostInfo(0)),this.rectX1=this.viewer.Rectangle[0],this.rectX2=this.viewer.Rectangle[1],this.rectY1=this.viewer.Rectangle[2],this.rectY2=this.viewer.Rectangle[3],t=[this.rectX1,this.rectY1],r=[this.rectX2,this.rectY2],i=this.sceneWraper.getPixelRatio(),t[0]/=i,t[1]/=i,r[0]/=i,r[1]/=i,this.offsetModelCoord1=this.sceneWraper.clientCoordToModelCoord(t),this.offsetModelCoord2=this.sceneWraper.clientCoordToModelCoord(r)),NDSWebViewer.OpBase.prototype.onTouchSingleEnd.call(this,e)},l.prototype.onTouchSingleMove=function(e){if("ExcelExtend"==this.opMode)this.pointer.x,this.pointerOld.x,this.pointer.y,this.pointerOld.y;else{var r,i,n=this.sceneWraper.getPixelRatio(),s=(this.viewer.Rectangle[0],this.viewer.Rectangle[1],this.viewer.Rectangle[2],this.viewer.Rectangle[3],Math.min(this.viewer.Rectangle[0],this.viewer.Rectangle[1])),o=Math.max(this.viewer.Rectangle[0],this.viewer.Rectangle[1]),a=Math.min(this.viewer.Rectangle[2],this.viewer.Rectangle[3]),l=Math.max(this.viewer.Rectangle[2],this.viewer.Rectangle[3]);let e=Math.sign(s-o),t=Math.sign(a-l);if(-1==this.selectPos)r=[this.singleTouchStartPos.x*n,this.singleTouchStartPos.y*n],i=[this.pointer.x*n,this.pointer.y*n];else{var h=2*n*(this.selectStep+2);switch(this.selectPos){case 0:if(r=[this.pointer.x*n,this.pointer.y*n],i=[o,l],Math.sign(r[0]-e*h-o)!=e)return;if(Math.sign(r[1]-t*h-l)!=t)return;break;case 1:if(r=[s,this.pointer.y*n],i=[o,l],Math.sign(r[0]-e*h-o)!=e)return;if(Math.sign(r[1]-t*h-l)!=t)return;break;case 2:if(r=[this.pointer.x*n,this.pointer.y*n],i=[s,l],e=Math.sign(o-s),t=Math.sign(a-l),Math.sign(r[0]-e*h-i[0])!=e)return;if(Math.sign(r[1]-t*h-l)!=t)return;break;case 3:if(r=[s,a],i=[this.pointer.x*n,l],e=Math.sign(o-s),Math.sign(i[0]-e*h-r[0])!=e)return;break;case 4:if(r=[s,a],i=[this.pointer.x*n,this.pointer.y*n],e=Math.sign(o-s),t=Math.sign(l-a),Math.sign(i[0]-e*h-r[0])!=e)return;if(Math.sign(i[1]-t*h-r[1])!=t)return;break;case 5:if(r=[s,a],i=[o,this.pointer.y*n],t=Math.sign(l-a),Math.sign(i[1]-t*h-r[1])!=t)return;break;case 6:if(r=[o,a],i=[this.pointer.x*n,this.pointer.y*n],e=Math.sign(s-o),t=Math.sign(l-a),Math.sign(i[0]-e*h-r[0])!=e)return;if(Math.sign(i[1]-t*h-r[1])!=t)return;break;case 7:if(r=[this.pointer.x*n,a],i=[o,l],e=Math.sign(s-o),Math.sign(r[0]-e*h-i[0])!=e)return}}this.drawRectangle(r[0],r[1],i[0],i[1]),r[0]/=n,r[1]/=n,i[0]/=n,i[1]/=n,this.offsetModelCoord1=this.sceneWraper.clientCoordToModelCoord(r),this.offsetModelCoord2=this.sceneWraper.clientCoordToModelCoord(i)}},l.prototype.onLMouseDown=function(r){r.preventDefault();var i=this.sceneWraper.getPixelRatio();if(this.sceneWraper.render(),NDSWebViewer.OpBase.prototype.onLMouseDown.call(this,r),this.selectPos=-1,0<this.viewer.Rectangle.length){var r=(this.viewer.Rectangle[0]+this.viewer.Rectangle[1])/2,n=(this.viewer.Rectangle[2]+this.viewer.Rectangle[3])/2,s=Math.min(this.viewer.Rectangle[0],this.viewer.Rectangle[1]),o=Math.max(this.viewer.Rectangle[0],this.viewer.Rectangle[1]),a=Math.min(this.viewer.Rectangle[2],this.viewer.Rectangle[3]),l=Math.max(this.viewer.Rectangle[2],this.viewer.Rectangle[3]),h=this.MouseDown.x*i,c=this.MouseDown.y*i;let e=-1,t=-1;i=this.selectStep*i;Math.abs(h-s)<i?e=0:Math.abs(h-r)<i?e=1:Math.abs(h-o)<i&&(e=2),Math.abs(c-a)<i?t=0:Math.abs(c-n)<i?t=1:Math.abs(c-l)<i&&(t=2),0==e&&0==t?this.selectPos=0:1==e&&0==t?this.selectPos=1:2==e&&0==t?this.selectPos=2:2==e&&1==t?this.selectPos=3:2==e&&2==t?this.selectPos=4:1==e&&2==t?this.selectPos=5:0==e&&2==t?this.selectPos=6:0==e&&1==t&&(this.selectPos=7)}-1!=this.selectPos&&(this.opMode="ExcelChange")},l.prototype.release=function(){this.viewer.Rectangle=[],this.sceneWraper.render(),this.prompt&&(this.sceneWraper.getContainer().removeChild(this.prompt),this.prompt=null),NDSWebViewer.OpBase.prototype.release.call(this)},l.prototype.SegmentsIntersect=function(e,t){function r(e,t,r,i,n,s,o,a){var l=r-e,h=i-t,c=o-n,d=a-s;if(l*d-h*c!=0)return h=(l*(t-s)-h*(e-n))/(l=l*d-h*c),0<=(c=(c*(t-s)-d*(e-n))/l)&&c<=1&&0<=h&&h<=1;d=Math.min(e,r),l=Math.max(e,r),c=Math.min(n,o),h=Math.max(n,o);if(c<=l&&d<=h){e=Math.min(t,i),r=Math.min(t,i),n=Math.min(s,a),o=Math.min(s,a);if(n<=r&&e<=o)return 1}}var i=e.start.x,n=e.start.y,s=e.end.x,e=e.end.y,o=t.min,t=t.max;return i<t.x&&i>o.x&&s<t.x&&s>o.x&&n<t.y&&n>o.y&&e<t.y&&e>o.y||!!(r(i,n,s,e,o.x,o.y,o.x,t.y)||r(i,n,s,e,o.x,t.y,t.x,t.y)||r(i,n,s,e,t.x,t.y,t.x,o.y)||r(i,n,s,e,t.x,o.y,o.x,o.y))||void 0},l.prototype.selectBody=function(){if(this.brepManager.hasBrepInfo()||!this.brepManager.hasBrepFile()){var e=this.viewer.Rectangle[0],t=this.viewer.Rectangle[1],r=this.viewer.Rectangle[2],n=this.viewer.Rectangle[3],s=this.sceneWraper.getRenderDomElement(),e=(this.sceneWraper.getPixelRatio(),t<e&&([e,t]=[t,e]),n<r&&([r,n]=[n,r]),e/s.width*2-1),t=t/s.width*2-1,r=2*-(r/s.height)+1,n=2*-(n/s.height)+1,s=new THREE.Vector2(e,r),e=new THREE.Vector2(t,n),r=new THREE.Vector3(s.x,s.y,0).unproject(this.camera),t=new THREE.Vector3(e.x,e.y,0).unproject(this.camera),o=new THREE.Box2,n=Math.max(r.x,t.x),s=Math.min(r.x,t.x),e=Math.max(r.y,t.y),r=Math.min(r.y,t.y),a=(o.set(new THREE.Vector2(s,r),new THREE.Vector2(n,e)),this.box2=o,[]),l=[];let i=this.viewer.ndsModel.meshManager;for(let e=0;e<this.modelWraper.getLeafBodyNodes().length;e++){let t=this.modelWraper.getLeafBodyNodes()[e];if(!t.isHidden()&&t.leafBodyAttri&&t.leafBodyAttri.bodyLineSegIds){let r=new THREE.Box3;t.leafBodyAttri.bodyLineSegIds.forEach(e=>{var t=i.geomManager.getGeomFromId(i.lineSegGeomId[e]),e=(new THREE.Matrix4).fromArray(i.matrixes,16*i.lineSegMatrixId[e]),t=t.boundingBox.clone();t.applyMatrix4(e),r.union(t)});var h=new THREE.Box2;h.set(new THREE.Vector2(r.min.x,r.min.y),new THREE.Vector2(r.max.x,r.max.y)),o.intersectsBox(h)&&(a.push(t),l.push(t))}if(!t.isHidden()&&t.leafBodyAttri&&t.leafBodyAttri.bodyTextIds&&!l.find(e=>e.uuid==t.uuid)){let r=new THREE.Box3;t.leafBodyAttri.bodyTextIds.forEach(e=>{if(i.textGeomId[e]<0)return!0;var t=i.geomManager.getGeomFromId(i.textGeomId[e]),e=(new THREE.Matrix4).fromArray(i.matrixes,16*i.textMatrixId[e]),t=t.boundingBox.clone();t.applyMatrix4(e),r.union(t)});h=new THREE.Box2;h.set(new THREE.Vector2(r.min.x,r.min.y),new THREE.Vector2(r.max.x,r.max.y)),o.intersectsBox(h)&&l.push(t)}}this.intersectBodies=a,this.textIntersectBodies=l;t=this.modelWraper.getBrepManager().type;return 1==t?(this.sceneWraper.dispatchEvent({type:"ExcelFormatError"}),t):(this.prettyExcels=[],this.getIntersectLineV2(a,o),this.prettyExcelToBlob())}},l.prototype.stitchContours=function(e,s){var t=[],r={};function o(t,r){for(let e=0;e<t.length;e++)if(Math.abs(r-t[e])<.01)return 1}for(var i=0;i<e.length;i++){var n=e[i];n.p1!==n.p2&&(void 0!==r[n.p1]?r[n.p1].push(n.p2):r[n.p1]=[n.p2],void 0!==r[n.p2]?r[n.p2].push(n.p1):r[n.p2]=[n.p1])}for(var a=[];;){for(var l in r)if(1==r[l].length)for(var h in delete r[l],r){var c=parseInt(l),d=r[h].indexOf(c);-1!=d&&r[h].splice(d,1)}var _=!1;for(l in r)if(1==r[l].length){_=!0;break}if(!_)break}for(;;){var g=void 0;for(l in r)if(1<r[l].length){g=l;break}if(!g)for(var l in r)if(0<r[l].length){g=l;break}if(!g)break;var p=-1,c=parseInt(g),u=r[g];for(a.push(c);u&&u.length;){var f=u.shift();if(void 0===(f=f===p?u.shift():f)){delete r[c];break}a.push(f);for(_=!1,i=0;i<a.length-1;++i)if(f==a[i]){a=a.slice(i),_=!0;break}if(_)break;(0==u.length||u[0]===p)&&delete r[c],p=c,u=r[c=f]}!function(t){var r=[],i=[];for(let e=0;e<t.length;e++){var n=t[e],n=s[n];o(r,n.x)||r.push(n.x),o(i,n.y)||i.push(n.y)}return!(2<r.length&&2<i.length)&&1!=r.length&&1!=i.length}(a)||a[0]!=a[a.length-1]||t.push(a),a=[]}return t},l.prototype.getIntersectLineV2=function(t,r){var i=this.modelWraper.getBrepManager(),n=[];for(let e=0;e<t.length;e++){var s=t[e].uuid,o=t[e].leafBodyAttri.bodyLineSegIds;if(o&&0!=o.length){var a=new THREE.Matrix4,l=i.brepInfos.breps[i.brepInfos.bodies.get(s)];if(l.edgeGroups)for(var h=0,c=l.edgeGroups.length;h<c;h++){var d=i.brepInfos.edgeGroups[l.edgeGroups[h]],_=d.geomUUID;if(d.lines)for(let e=0;e<d.lines.ids.length;e++){var g=[d.lines.indexRanges[2*e],d.lines.indexRanges[2*e+1]],p=this.viewer.ndsModel.meshManager.geomManager.getGeomFromUuid(_,0),u=(g[0]+=p.drawRange.start/2,g[1]+=p.drawRange.start/2,p.index),f=p.attributes.position.array;if(null!=u){var M=u.array,x=g[0],m=g[1];for(let e=0;e<p.refLineSegs.length;e++){var y,w=new THREE.Vector3,v=new THREE.Vector3,E=(w.fromArray(f,3*M[2*x]),v.fromArray(f,3*M[2*m+1]),a.identity(),p.refLineSegs[e]);if(this.viewer.ndsModel.meshManager.matrixes)for(var b=0;b<16;++b)a.elements[b]=this.viewer.ndsModel.meshManager.matrixes[16*this.viewer.ndsModel.meshManager.lineSegMatrixId[E]+b];w.applyMatrix4(a),v.applyMatrix4(a),1<Math.abs(w.y-v.y)&&1<Math.abs(w.x-v.x)||(y=Math.min(Math.abs(this.box2.min.x-this.box2.max.x),Math.abs(this.box2.min.y-this.box2.max.y)),w.distanceTo(v)<y/1e3)||1!=this.checkEdge(r,y={start:w,end:v})&&n.push(y)}}}}}}var e=this.handleEdges(n);this.EdgeToExcel(e,this.points)},l.prototype.handleEdges=function(e){var{horizontalArray:e,verticalArray:t}=this._getRowColumn(e),r=this._generateGrid(e,t),e=(this._handleUnExistEdges(r),this._mergeEdges(e,t,r));return this._filterEdges(e)},l.prototype._generateGrid=function(r,i){var n=[],s=[];for(let t=0;t<r.length;t++){var o=r[t],a=r[t+1];for(let e=0;e<i.length-1;e++){var l,h=i[e],c=i[e+1];n.push(new THREE.Vector3(h,o,0)),e==i.length-2&&n.push(new THREE.Vector3(c,o,0)),0<t&&t<r.length-1&&(l={start:l=(new THREE.Vector3).set(h,o,0),end:c=(new THREE.Vector3).set(c,o,0),p1:d(l),p2:d(c),vertical:!1},s.push(l)),0<e&&t<r.length-1&&(h={start:c=(new THREE.Vector3).set(h,o,0),end:l=(new THREE.Vector3).set(h,a,0),p1:d(c),p2:d(l),vertical:!0},s.push(h))}}var e=(new THREE.Vector3).set(i[0],r[0],0),t=(new THREE.Vector3).set(i[i.length-1],r[0],0),e={start:e,end:t,p1:d(e),p2:d(t),vertical:!1,isSideLine:!0},t=(s.push(e),(new THREE.Vector3).set(i[0],r[r.length-1],0)),e=(new THREE.Vector3).set(i[i.length-1],r[r.length-1],0),t={start:t,end:e,p1:d(t),p2:d(e),vertical:!1,isSideLine:!0},e=(s.push(t),(new THREE.Vector3).set(i[0],r[0],0)),t=(new THREE.Vector3).set(i[0],r[r.length-1],0),e={start:e,end:t,p1:d(e),p2:d(t),vertical:!0,isSideLine:!0},t=(s.push(e),(new THREE.Vector3).set(i[i.length-1],r[0],0)),e=(new THREE.Vector3).set(i[i.length-1],r[r.length-1],0),t={start:t,end:e,p1:d(t),p2:d(e),vertical:!0,isSideLine:!0};function d(t){return r.findIndex(e=>e==t.y)*i.length+i.findIndex(e=>e==t.x)}return s.push(t),this.points=n,s},l.prototype._filterEdges=function(t){var{horizontalArray:e,verticalArray:r}=this._getRowColumn(t);let n={x:r[0],y:e[0]},s={x:r[r.length-1],y:e[0]},o=this;function a(e,t=1){if(e.vertical){if(1==t&&Math.abs(e.start.y-n.y)<.01)return!0;if(2==t&&Math.abs(e.start.y-s.y)<.01)return!0}else{if(1==t&&Math.abs(e.start.x-n.x)<.01)return!0;if(2==t&&Math.abs(e.end.x-s.x)<.01)return!0}let r=null,i=e.start.x;return!!(r=e.vertical?o.horizontalLine.get(e.start.y):(2==t&&(i=e.end.x),o.verticalLine.get(i)))&&!!(e=function(t,r,i){for(let e=0;e<t.length;e++){var n=t[e];if(!n.delete){if(n.vertical){if(1==i){if(r.start.y>n.start.y&&r.start.y<=n.end.y)return n}else if(2==i&&r.start.y>n.start.y&&r.start.y<=n.end.y)return n}else if(1==i){if(r.start.x>n.start.x&&r.start.x<=n.end.x)return n}else if(2==i&&r.start.x>=n.start.x&&r.start.x<n.end.x)return n;return null}}return null}(r,e,t))&&a(e,t)}for(let e=t.length-1;0<=e;e--){var i=t[e];i.isSideLine||a(i,1)&&a(i,2)||(i.delete=!0,t.splice(e,1))}return t},l.prototype._mergeEdges=function(r,i,n){var s=[];for(let e=0;e<r.length;e++){let t=r[e];var o=n.filter(e=>0==e.vertical&&Math.abs(e.start.y-t)<.01);if(o.length){o.sort((e,t)=>e.start.x-t.start.x);let t=[],r=!0;for(let e=0;e<o.length-1;e++){var a=o[e];r=!(Math.abs(a.end.x-o[e+1].start.x)<.01&&(r?t.push(e,e+1):t[t.length-1]=e+1,1))}for(let e=0;e<t.length;e+=2){var l=t[e],h=t[e+1],l={start:o[l].start,end:o[h].end,p1:o[l].p1,p2:o[h].p2,isMerge:!0,vertical:!1};s.push(l)}0==t.length&&(o[0].isMerge=!0,s.push(o[0]))}}for(let e=0;e<i.length;e++){let t=i[e];var c=n.filter(e=>1==e.vertical&&Math.abs(e.start.x-t)<.01);if(c.length){c.sort((e,t)=>e.start.y-t.start.y);let t=[],r=!0;for(let e=0;e<c.length-1;e++){var d=c[e];r=!(Math.abs(d.end.y-c[e+1].start.y)<.01&&(r?t.push(e,e+1):t[t.length-1]=e+1,1))}for(let e=0;e<t.length;e+=2){var _=t[e],g=t[e+1],_={start:c[_].start,end:c[g].end,p1:c[_].p1,p2:c[g].p2,isMerge:!0,vertical:!0};s.push(_)}0==t.length&&(c[0].isMerge=!0,s.push(c[0]))}}return s},l.prototype._handleUnExistEdges=function(t){let o=this;for(let e=t.length-1;0<=e;e--){var r=t[e],i={x:(r.start.x+r.end.x)/2,y:(r.start.y+r.end.y)/2};r.isSideLine||function(t,e){if(e.vertical){if(o.verticalLine.has(e.start.x)){var r=o.verticalLine.get(e.start.x);for(let e=0;e<r.length;e++){var i=r[e];if(t.y>=i.start.y&&t.y<=i.end.y)return 1}return}}else if(o.horizontalLine.has(e.start.y)){var n=o.horizontalLine.get(e.start.y);for(let e=0;e<n.length;e++){var s=n[e];if(t.x>=s.start.x&&t.x<=s.end.x)return 1}return}return 1}(i,r)||t.splice(e,1)}},l.prototype._getRowColumn=function(t){this.verticalLine.clear(),this.horizontalLine.clear();for(let e=0;e<t.length;e++){var i,n=t[e];if(Math.abs(n.start.x-n.end.x)<.01){n.start.y>n.end.y&&(i=n.start.y,n.start.y=n.end.y,n.end.y=i);let r=n.start.x;this.verticalLine.forEach((e,t)=>{Math.abs(r-t)<.01&&(r=t)}),this.verticalLine.has(r)||this.verticalLine.set(r,[]),this.verticalLine.get(r).push(n)}else if(Math.abs(n.start.y-n.end.y)<.01){n.start.x>n.end.x&&(i=n.start.x,n.start.x=n.end.x,n.end.x=i);let r=n.start.y;this.horizontalLine.forEach((e,t)=>{Math.abs(r-t)<.01&&(r=t)}),this.horizontalLine.has(r)||this.horizontalLine.set(r,[]),this.horizontalLine.get(r).push(n)}}return{horizontalArray:Array.from(this.horizontalLine.keys()).sort((e,t)=>e-t),verticalArray:Array.from(this.verticalLine.keys()).sort((e,t)=>e-t)}},l.prototype.checkEdge=function(e,t){if(!(.01<Math.abs(t.start.x-t.end.x)&&.01<Math.abs(t.start.y-t.end.y))){if(e.containsPoint(t.start)&&e.containsPoint(t.end))return 0;if(e.containsPoint(t.start))return 2;if(e.containsPoint(t.end))return 2;if(Math.abs(t.start.x-t.end.x)<.01&&t.end.x>e.min.x&&t.end.x<e.max.x){var r=Math.min(t.start.y,t.end.y),i=Math.max(t.start.y,t.end.y);if(r<e.min.y&&i>e.max.y)return 2}if(Math.abs(t.start.y-t.end.y)<.01&&t.end.y>e.min.y&&t.end.y<e.max.y){r=Math.min(t.start.x,t.end.x),i=Math.max(t.start.x,t.end.x);if(r<e.min.x&&i>e.max.x)return 2}}return 1},l.prototype.ClearRedundancyEdge=function(t){var r=[],i=[];for(let e=0;e<t.length;e++){var n=t[e];if(Math.abs(n.start.x-n.end.x)<.01){let t=!1;for(let e=0;e<r.length;e++){var s=r[e];if(Math.abs(n.start.x-s)<.01){t=!0;break}}t||r.push(n.start.x)}else if(Math.abs(n.start.y-n.end.y)<.01){let t=!1;for(let e=0;e<i.length;e++){var o=i[e];if(Math.abs(n.start.y-o)<.01){t=!0;break}}t||i.push(n.start.y)}}for(let e=t.length-1;-1<e;e--){var a=t[e];Math.abs(a.start.x-a.end.x)<.01&&(-1==i.indexOf(a.start.y)||-1==i.indexOf(a.end.y))?t.splice(e,1):Math.abs(a.start.y-a.end.y)<.01&&(-1!=r.indexOf(a.start.x)&&-1!=r.indexOf(a.end.x)||t.splice(e,1))}},l.prototype.EdgeToExcel=function(t,r){var i=[],n=this.stitchContours(t,r);for(let e=0;e<n.length;e++){var s=n[e];let t=new THREE.Box2;s.forEach(e=>{e=r[e];t.expandByPoint(new THREE.Vector2(e.x,e.y))});s={contour:s,box2:t,edges:[]};i.push(s)}for(let e=0;e<i.length;e++){var o=i[e];for(let e=t.length-1;0<=e;e--){var a=t[e];o.box2.containsPoint(a.start)&&o.box2.containsPoint(a.end)&&(t.splice(e,1),o.edges.push(a))}this.ClearRedundancyEdge(o.edges)}for(let e=0;e<i.length;e++){var l=i[e],l=this.getExcelInfo(l);0<l.textMap.size&&0<l.columnLength.length&&0<l.rowLength.length&&(1<l.columnLength.length||1<l.rowLength.length)&&(l=this.prettyExcel(l,this.prettyExcels.length),this.prettyExcels.push(l))}},l.prototype._addEdges=function(e){e.forEach(e=>{var e=[e.start,e.end],t=new THREE.LineBasicMaterial({color:16711680}),e=(new THREE.BufferGeometry).setFromPoints(e),e=new THREE.Line(e,t);this.viewer.scene.add(e)})},l.prototype._addBox=function(e){e.forEach(e=>{var t=(new THREE.Vector3).copy(e.min),e=[t,new THREE.Vector3(e.max.x,e.min.y,0),(new THREE.Vector3).copy(e.max),new THREE.Vector3(e.min.x,e.max.y,0),t],t=new THREE.LineBasicMaterial({color:16711680}),e=(new THREE.BufferGeometry).setFromPoints(e),e=new THREE.Line(e,t);this.viewer.scene.add(e)})},l.prototype.prettyExcelToBlob=async function(){if(0==this.prettyExcels.length)return this.sceneWraper.dispatchEvent({type:"ExcelError"}),null;let l=new ExcelJS.Workbook;l.views=[{x:0,y:0,width:1e3,height:2e3,firstSheet:0,activeTab:1,visibility:"visible"}];try{this.prettyExcels.forEach(e=>{{let r=l.addWorksheet(e.sheetName||"");var t=e.tableData||{};t.forEach(i=>{Object.keys(i).forEach(e=>{var t=i[e];let r="";r=t&&Array.isArray(t)?t.join("\n"):null,i[e]=r})});let i=Object.keys(t[0]);t.forEach((t,e)=>{r.insertRow(e+1,i.map(e=>t[e]))});var n=e.columnLength||[];for(let e=0;e<n.length;e++){var s=n[e];r.getColumn(e+1).width=s,r.getColumn(e+1).alignment={wrapText:!0,vertical:"middle",horizontal:"left"}}var o=e.rowLength||[];for(let e=0;e<o.length;e++){var a=o[e];r.getRow(e+1).height=a}(e.mergeCells||[]).forEach(e=>{r.mergeCells(e[0]+":"+e[1])});for(let t=1;t<=o.length;t++)for(let e=1;e<=n.length;e++)r.getCell(t,e).border={top:{style:"thin"},left:{style:"thin"},bottom:{style:"thin"},right:{style:"thin"}}}})}catch(e){return null}var e=await l.xlsx.writeBuffer();return new Blob([e],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;charset=UTF-8"})},l.prototype.prettyExcel=function(i,e){let r={};r.sheetName="sheet"+e;var e=i.rowLength.slice().sort((e,t)=>e-t)[Math.floor(i.rowLength.length/2)],t=14/e;for(let e=0;e<i.rowLength.length;e++)i.rowLength[e]*=t;var n=i.columnLength.slice().sort((e,t)=>e-t)[Math.floor(i.columnLength.length/2)],s=e<=n?n/e*t/4:e/n*t;for(let e=0;e<i.columnLength.length;e++)i.columnLength[e]*=s;r.columnLength=i.columnLength,r.rowLength=i.rowLength,r.mergeCells=[],i.mergeCell.forEach(e=>{var t=[];t.push(e[0]),t.push(e[e.length-1]),r.mergeCells.push(t)}),r.tableData=[];for(let t=1;t<i.rowLength.length+1;t++){var o={};for(let e=1;e<i.columnLength.length+1;e++){var a="key"+e,l=""+this.numToLetter(e)+t;if(i.textMap.has(l)){let t=[],r="";l=i.textMap.get(l);this.sortObjects(l).forEach(e=>{let o=[];r="",e.onCross?(e.elements.forEach((t,e)=>{let r=0;if(t.geom.name.length){var i=t.geom.name.split("");for(let e=0;e<i.length;e++){r+=t.geom.characterWidthHeight[2*e];var n={};n.x=t.box.min.x+r,n.name=i[e],o.push(n)}var s={};s.x=o[o.length-1].x+1e-10,s.name=" ",o.push(s)}}),o.sort((e,t)=>e.x-t.x),o.forEach(e=>{r+=e.name})):e.elements.forEach((e,t)=>{r=r+" "+e.geom.name}),t.push(r)}),o[a]=t}else o[a]=[]}r.tableData.push(o)}return r},l.prototype.sortObjects=function(r){if(0==r.length)return[];var e=r[0],i=e.box.max.y-e.box.min.y,n=[{refMinY:e.box.min.y,elements:[e],onCross:!1}];for(let t=1;t<r.length;t++){var s,o=r[t];let e=!1;for(s of n)if(Math.abs(o.box.min.y-s.refMinY)<=i){s.elements.push(o),e=!0;break}e||n.push({refMinY:o.box.min.y,elements:[o],onCross:!1})}return n.sort((e,t)=>t.refMinY-e.refMinY),n.forEach(t=>{t.elements.sort((e,t)=>e.box.min.x-t.box.min.x);for(let e=0;e<t.elements.length;e++){var r=t.elements[e],i=t.elements[e+1];if(i&&i.box.min.x<r.box.max.x){t.onCross=!0;break}}}),n},l.prototype.numToLetter=function(e){let t="";for(;0<e;)e--,t=String.fromCharCode(e%26+65)+t,e=Math.floor(e/26);return t},l.prototype.getExcelInfo=function(t){function r(e,r,i){let n=!1;e.forEach((e,t)=>{-1!=e.indexOf(r)&&(e.push(i),n=!0)}),n||(e.set(r,[]),e.get(r).push(r),e.get(r).push(i))}var i=new Map,n=new Map;for(let e=0;e<t.edges.length;e++){var s=t.edges[e];if(Math.abs(s.start.x-s.end.x)<.01){let r=s.start.x;n.forEach((e,t)=>{Math.abs(r-t)<.01&&(r=t)}),n.has(r)||n.set(r,[]),n.get(r).push(s)}else if(Math.abs(s.start.y-s.end.y)<.01){let r=s.start.y;i.forEach((e,t)=>{Math.abs(r-t)<.01&&(r=t)}),i.has(r)||i.set(r,[]),i.get(r).push(s)}}var o=Array.from(i.keys()).sort((e,t)=>e-t),a=Array.from(n.keys()).sort((e,t)=>e-t),l=i.size-1,h=n.size-1,c=[];let d=null;for(let e=o.length-1;0<=e;e--){var D=o[e];d=(null==d||c.push(d-D),D)}for(let e=o.length-2;0<e;e--){var k=o[e],_=i.get(k);for(let e=0;e<_.length;e++){var A,g=_[e];g.start.x>g.end.x&&(A=g.start.x,g.start.x=g.end.x,g.end.x=A)}for(let t=0;t<_.length;t++){var p=_[t];for(let e=t+1;e<_.length;e++){var u=_[e];if(Math.abs(p.start.x-u.start.x)<.01){if(!(p.end.x>u.end.x)){_.splice(t,1),t--;break}_.splice(e,1),e--}if(Math.abs(p.end.x-u.end.x)<.01){if(!(p.start.x<u.start.x)){_.splice(t,1),t--;break}_.splice(e,1),e--}}}_.sort((e,t)=>e.start.x-t.start.x)}var H=[];let f=null;for(let e=0;e<a.length;e++){var j=a[e];f=(null==f||H.push(j-f),j)}for(let e=1;e<a.length-1;e++){var F=a[e],M=n.get(F);for(let e=0;e<M.length;e++){var Y,x=M[e];x.start.y<x.end.y&&(Y=x.start.y,x.start.y=x.end.y,x.end.y=Y)}for(let t=0;t<M.length;t++){var m=M[t];for(let e=t+1;e<M.length;e++){var y=M[e];if(Math.abs(m.start.y-y.start.y)<.01){if(!(m.end.y<y.end.y)){M.splice(t,1),t--;break}M.splice(e,1),e--}if(Math.abs(m.end.y-y.end.y)<.01){if(!(m.start.y>y.start.y)){M.splice(t,1),t--;break}M.splice(e,1),e--}}}M.sort((e,t)=>e.start.y-t.start.y)}var w=[];for(let e=o.length-2;0<e;e--){var v,E,G=o[e],U=o.length-e-1,b=i.get(G);let t=null,r=null;var R=[];for(let e=0;e<b.length;e++){var V=b[e];if(V.isMerge)v=a.indexOf(V.start.x),E=a.indexOf(V.end.x),-1<v&&-1<E&&R.push(v,E);else{if(null==t&&(t=V.start.x),null==r&&(r=V.end.x),1==b.length){v=a.indexOf(t),E=a.indexOf(r),-1<v&&-1<E&&R.push(v,E),t=null,r=null;break}if(Math.abs(V.start.x-r)<.01){if(r=V.end.x,e==b.length-1){v=a.indexOf(t),E=a.indexOf(r),-1<v&&-1<E&&R.push(v,E),t=null,r=null;break}}else 0!=e&&(v=a.indexOf(t),E=a.indexOf(r),-1<v&&-1<E&&R.push(v,E),t=V.start.x,r=V.end.x)}}w.push({row:U,indexArray:R,column:-1})}for(let e=1;e<a.length-1;e++){var X=a[e],z=e,C=n.get(X);let t=null,r=null;var B=[];for(let e=C.length-1;0<=e;e--){var T=C[e];if(T.isMerge)v=o.length-1-o.indexOf(T.start.y),E=o.length-1-o.indexOf(T.end.y),-1<v&&-1<E&&B.push(v,E);else{if(null==t&&(t=T.start.y),null==r&&(r=T.end.y),1==C.length){v=o.length-1-o.indexOf(t),E=o.length-1-o.indexOf(r),-1<v&&-1<E&&B.push(v,E),t=null,r=null;break}if(Math.abs(T.end.y-t)<.01){if(t=T.start.y,e==C.length-1){v=o.length-1-o.indexOf(t),E=o.length-1-o.indexOf(r),-1<v&&-1<E&&B.push(v,E),t=null,r=null;break}}else 0!=e&&(v=o.length-1-o.indexOf(t),E=o.length-1-o.indexOf(r),-1<v&&-1<E&&B.push(v,E),t=T.start.y,r=T.end.y)}}w.push({row:-1,indexArray:B,column:z})}var O=new Map;for(let e=0;e<w.length;e++){var S=w[e];if(-1==S.column){var I=S.row,L=S.indexArray;for(let t=1;t<L.length;t+=2){if(0!=L[0])for(let e=1;e<=L[0];e++){var q=this.numToLetter(e);r(O,""+q+I,""+q+(I+1))}if(t+1==L.length&&L[t]!=h)for(let e=L[t]+1;e<=h;e++){var J=this.numToLetter(e);r(O,""+J+I,""+J+(I+1))}else{var K=L[t],Q=L[t+1];if(K<Q)for(let e=K+1;e<=Q;e++){var Z=this.numToLetter(e);r(O,""+Z+I,""+Z+(I+1))}}}}if(-1==S.row){var P=S.column,W=S.indexArray;for(let t=1;t<W.length;t+=2){if(0!=W[0])for(let e=1;e<=W[0];e++){var $=this.numToLetter(P),ee=this.numToLetter(P+1);r(O,""+$+e,""+ee+e)}if(t+1==W.length&&W[t]!=l)for(let e=W[t]+1;e<=l;e++){var te=this.numToLetter(P),re=this.numToLetter(P+1);r(O,""+te+e,""+re+e)}else{var ie=W[t],ne=W[t+1];if(ie<ne)for(let e=ie+1;e<=ne;e++){var se=this.numToLetter(P),oe=this.numToLetter(P+1);r(O,""+se+e,""+oe+e)}}}}}var ae=Array.from(O.keys());for(let e=0;e<ae.length;e++){let r=ae[e],i=!1;O.forEach((e,t)=>{-1!=e.indexOf(r)&&t!=r&&(i=!0)}),i&&O.delete(r)}t.box2.min.x=a[0],t.box2.min.y=o[0],t.box2.max.x=a[a.length-1],t.box2.max.y=o[o.length-1];var N=this.TextExcel(a,o,t.box2),le=Array.from(N.keys());for(let e=0;e<le.length;e++){let r=le[e],i=null;O.forEach((e,t)=>{-1!=e.indexOf(r)&&t!=r&&(i=t)}),i&&(N.has(i)||N.set(i,[]),N.set(i,N.get(i).concat(N.get(r))),N.delete(r))}return{textMap:N,mergeCell:O,columnLength:H,rowLength:c}},l.prototype.ClearRedundancyText=function(r){var i=[];for(let e=0;e<r.length;e++){var n=r[e];let t=0;for(let e=0;e<i.length;e++){var s=i[e];if(s.geom.name==n.geom.name&&n.box.equals(s.box)){t=1;break}}0==t&&i.push(n)}return i},l.prototype.TextExcel=function(n,s,t){var r=this.viewer.ndsModel.meshManager;let o=[];var i=new THREE.Matrix4;for(let e=0;e<this.textIntersectBodies.length;e++){var a=this.textIntersectBodies[e].leafBodyAttri.bodyTextIds;if(0<a.length)for(let e=0;e<a.length;e++){var l,h,c=a[e];if(i.identity(),r.matrixes)for(var d=0;d<16;++d)i.elements[d]=r.matrixes[16*r.textMatrixId[c]+d];r.textGeomId[c]<0||(h=(l=r.geomManager.getGeomFromId(r.textGeomId[c])).boundingBox.clone().applyMatrix4(i),h=new THREE.Box2(new THREE.Vector2(h.min.x,h.min.y),new THREE.Vector2(h.max.x,h.max.y)),t.containsBox(h)&&o.push({geom:l,box:h}))}}o=this.ClearRedundancyText(o);var _=new THREE.Box2,g=new Map;for(let e=0;e<o.length;e++){var p=o[e];let i=s[s.length-1];for(let r=s.length-2;-1<r;r--){var u=s[r];let t=n[0];for(let e=1;e<n.length;e++){var f=n[e],M=(_.min.x=t,_.max.x=f,_.min.y=u,_.max.y=i,new THREE.Vector3(p.box.min.x,(p.box.min.y+p.box.max.y)/2,0));_.containsPoint(M)&&(M=""+this.numToLetter(e)+(s.length-r-1),g.has(M)||g.set(M,[]),g.get(M).push(p)),t=f}i=u}}return g},l.prototype.reDrawExcel=function(){this.opMode="normal",this.viewer.Rectangle=[],this.offsetModelCoord1=null,this.offsetModelCoord2=null,this.PostInfo(1),this.sceneWraper.render()},l.prototype.MouseWheel=function(){var e,t,r;this.offsetModelCoord1&&this.offsetModelCoord2&&3==this.offsetModelCoord1.length&&3==this.offsetModelCoord2.length&&(e=this.sceneWraper.getPixelRatio(),t=this.sceneWraper.modelCoordToClientCoord(this.offsetModelCoord1),r=this.sceneWraper.modelCoordToClientCoord(this.offsetModelCoord2),t[0]*=e,t[1]*=e,r[0]*=e,r[1]*=e,this.drawRectangle(t[0],t[1],r[0],r[1]))},l.prototype.onLMouseMove=function(e){if(e.preventDefault(),"normal"!=this.opMode&&"ExcelChange"!=this.opMode)NDSWebViewer.OpBase.prototype.onRMouseMove.call(this,e);else{var r,i,n=this.sceneWraper.getPixelRatio(),s=(this.viewer.Rectangle[0],this.viewer.Rectangle[1],this.viewer.Rectangle[2],this.viewer.Rectangle[3],Math.min(this.viewer.Rectangle[0],this.viewer.Rectangle[1])),o=Math.max(this.viewer.Rectangle[0],this.viewer.Rectangle[1]),a=Math.min(this.viewer.Rectangle[2],this.viewer.Rectangle[3]),l=Math.max(this.viewer.Rectangle[2],this.viewer.Rectangle[3]);let e=Math.sign(s-o),t=Math.sign(a-l);if(-1==this.selectPos)r=[this.MouseDown.x*n,this.MouseDown.y*n],i=[this.pointer.x*n,this.pointer.y*n];else{var h=2*n*this.selectStep;switch(this.selectPos){case 0:if(r=[this.pointer.x*n,this.pointer.y*n],i=[o,l],Math.sign(r[0]-e*h-o)!=e)return;if(Math.sign(r[1]-t*h-l)!=t)return;break;case 1:if(r=[s,this.pointer.y*n],i=[o,l],Math.sign(r[0]-e*h-o)!=e)return;if(Math.sign(r[1]-t*h-l)!=t)return;break;case 2:if(r=[this.pointer.x*n,this.pointer.y*n],i=[s,l],e=Math.sign(o-s),t=Math.sign(a-l),Math.sign(r[0]-e*h-i[0])!=e)return;if(Math.sign(r[1]-t*h-l)!=t)return;break;case 3:if(r=[s,a],i=[this.pointer.x*n,l],e=Math.sign(o-s),Math.sign(i[0]-e*h-r[0])!=e)return;break;case 4:if(r=[s,a],i=[this.pointer.x*n,this.pointer.y*n],e=Math.sign(o-s),t=Math.sign(l-a),Math.sign(i[0]-e*h-r[0])!=e)return;if(Math.sign(i[1]-t*h-r[1])!=t)return;break;case 5:if(r=[s,a],i=[o,this.pointer.y*n],t=Math.sign(l-a),Math.sign(i[1]-t*h-r[1])!=t)return;break;case 6:if(r=[o,a],i=[this.pointer.x*n,this.pointer.y*n],e=Math.sign(s-o),t=Math.sign(l-a),Math.sign(i[0]-e*h-r[0])!=e)return;if(Math.sign(i[1]-t*h-r[1])!=t)return;break;case 7:if(r=[this.pointer.x*n,a],i=[o,l],e=Math.sign(s-o),Math.sign(r[0]-e*h-i[0])!=e)return}}this.drawRectangle(r[0],r[1],i[0],i[1]),r[0]/=n,r[1]/=n,i[0]/=n,i[1]/=n,this.offsetModelCoord1=this.sceneWraper.clientCoordToModelCoord(r),this.offsetModelCoord2=this.sceneWraper.clientCoordToModelCoord(i)}},l.prototype.renderModel=function(){if(4==this.viewer.Rectangle.length){var r=this.sceneWraper.getCanvas2D().getContext("2d");let t=this.sceneWraper.getPixelRatio();this.MouseWheel(),rectX1=this.viewer.Rectangle[0],rectX2=this.viewer.Rectangle[1],rectY1=this.viewer.Rectangle[2],rectY2=this.viewer.Rectangle[3],r.strokeStyle="#1880E3",r.fillStyle="#F2F2F2",r.beginPath(),r.lineWidth=2*t,r.moveTo(rectX1,rectY1),r.lineTo(rectX2,rectY1),r.lineTo(rectX2,rectY2),r.lineTo(rectX1,rectY2),r.lineTo(rectX1,rectY1),r.closePath(),r.stroke(),[{x:rectX1,y:rectY1},{x:(rectX1+rectX2)/2,y:rectY1},{x:rectX2,y:rectY1},{x:rectX1,y:(rectY1+rectY2)/2},{x:rectX2,y:(rectY1+rectY2)/2},{x:rectX1,y:rectY2},{x:(rectX1+rectX2)/2,y:rectY2},{x:rectX2,y:rectY2}].forEach(function(e){r.beginPath(),r.arc(e.x,e.y,5*t,0,2*Math.PI),r.fill(),r.stroke()}),r.lineWidth=1}};r=new class extends i{constructor(){super(),this.name="NDSExcelExportExtension",console.log("NDSExcelExportExtension version 1.0.0"),this.OperatorName="OpExcel",this.viewer=null}onLoad(e){this.sceneWraper=new a(e);let t=this;this.sceneWraper.registOperator(this.OperatorName,function(e){return new l(e,t)})}onUnLoad(){"OpExcelExport"==this.sceneWraper.getCurrentOperator().type&&this.sceneWraper.getCurrentOperator().release()}onInitLights(e){}onNdsModelPrepareForRendering(e){this.modelWraper=new o(e)}clear(){"OpExcelExport"==this.sceneWraper.getCurrentOperator().type&&this.sceneWraper.getCurrentOperator().release()}extendExcel(){if("OpExcelExport"==this.sceneWraper.getCurrentOperator().type)return this.sceneWraper.getCurrentOperator().selectBody()}reDrawExcel(){"OpExcelExport"==this.sceneWraper.getCurrentOperator().type&&this.sceneWraper.getCurrentOperator().reDrawExcel()}exitExcel(){"OpExcelExport"==this.sceneWraper.getCurrentOperator().type&&this.sceneWraper.getCurrentOperator().release()}getFileName(){return this.modelWraper.getRootBodyNode().name}};NDSWebViewer.ExtensionManager.addExtension(r)}],i={},n.m=r,n.c=i,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)n.d(r,i,function(e){return t[e]}.bind(null,i));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=0);function n(e){var t;return(i[e]||(t=i[e]={i:e,l:!1,exports:{}},r[e].call(t.exports,t,t.exports,n),t.l=!0,t)).exports}var r,i});