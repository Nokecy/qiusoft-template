!function(){"use strict";
/**
	 * @file 这是新迪轻量化引擎查看器插件框架代码，请不要修改此文件
	 * @copyright 新迪数字 2024
	 */console.log("NDS ExtensionFramework V0.1");const e={FLAG_ENABLE_NODE_TRANSFORM:NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM,FLAG_ENABLE_NODE_STOREVIEW:NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM<<1,FLAG_ENABLE_NODE_CAMERA2D:NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM<<2,FLAG_ENABLE_NODE_BLOCK:NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM<<3,FLAG_ENABLE_NODE_TEXT:NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM<<4,FLAG_ENABLE_NODE_BROADCAST:NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM<<5};class t extends NDSWebViewer.Extension{constructor(){super()}onLoad(e){}onInitLights(){}update(e){}setFlags(e){super.setFlags(e)}onNdsModelPrepareForRendering(e){}onBeforeNdsModelUpdate(e,t){}onAfterNdsModelUpdate(e,t){}onBeforeNdsModelSetRender(e,t){}onAfterNdsModelSetRender(e,t){}onBeforeNdsMeshRender(e,t){}getExtensionWithFlags(e){return NDSWebViewer.ExtensionManager.getExtensionWithFlags(e)}resetToDefault(){}getStoreInfo(e){throw this.name+" Extesion did not implement method 'getStoreInfo' "}setStoreInfo(e){throw this.name+" Extesion did not implement method 'setStoreInfo' "}getBodyTransform(e,t=void 0){return new THREE.Matrix4}getBodyNodeTranslate(e,t=void 0){return new THREE.Vector3(0,0,0)}}class r{constructor(e){this.__sectionManager__=e.selectionManager}getSelectedObjects(){return this.__sectionManager__.getSelectedObjects()}getSelectedMeshes(){return this.__sectionManager__.getSelectedMeshes()}clearSelection(){this.__sectionManager__.clearSelection()}setSelectType(e){this.__sectionManager__.setSelectType(e)}selectByClick(e,t,r){this.__sectionManager__.selectByClick(e,t,r)}}
/**
	 * @file 这是新迪轻量化引擎查看器插件框架代码，请不要修改此文件
	 * @copyright 新迪数字 2024
	 */class o{constructor(e){this.__coreView__=e}addEventListener(e,t){this.__coreView__.addEventListener(e,t)}hasEventListener(e,t){return this.__coreView__.hasEventListener(e,t)}removeEventListener(e,t){this.__coreView__.removeEventListener(e,t)}dispatchEvent(e){this.__coreView__.dispatchEvent(e)}getPixelRatio(){return this.__coreView__.renderer.getPixelRatio()}switchRotateCenterBySelection(){this.__coreView__.switchRotateCenterBySelection()}setDefaultEnvMap(e){e&&(this.__coreView__.hasPbrMaterial=!0,this.__coreView__.setDefaultEnvMap=()=>{this.__coreView__.setEnvMapEnabled(!0),this.__coreView__.defaultEnvMapTexture=e,this.__coreView__.updateEnvMap(this.__coreView__.defaultEnvMapTexture)},this.__coreView__.setDefaultEnvMap())}getBackgroundState(){return this.__coreView__.exchangeBackImage?{type:this.__coreView__.exchangeBackImage.type,value:this.__coreView__.exchangeBackImage.value}:void 0}setBackgroundState(e,t){"Image"===e?(this.__coreView__.setEnvMapTextures(null),this.__coreView__.setBackGroundImage(t)):"EnvMap"===e?this.__coreView__.setEnvMapTextures(t):"Color"===e&&(this.__coreView__.setEnvMapTextures(null),this.__coreView__.setBackGroundImage(null),this.__coreView__.setBackGroundColor(t))}removeAllLights(){this.__coreView__.lights.length=0}getLight(e){return this.__coreView__.lights[e]}setLight(e,t){this.__coreView__.lights[e]=t}getViewBox(){return this.__coreView__.viewBox}toggleAutoRotation(e){this.__coreView__.toggleAutoRotation(e)}randColor(){return this.__coreView__.materialsSetting.randColor()}getBoundingBox(){let e=this.__coreView__.ndsModel.getTotalBodyBoundingBox();return e.isEmpty()?this.__coreView__.modelRootObject.boundingBox:e}getModelTree(){return this.__coreView__.getModelTree()}getModelCount(){return this.__coreView__.ndsModel.models.length}setActiveModel(e){this.__coreView__.ndsModel.setActiveModel(e)}setActiveModelByModelId(e){let t=-1;for(let r=0;r<this.__coreView__.ndsModel.models.length;++r)if(this.__coreView__.ndsModel.models[r].id===e){t=r;break}this.setActiveModel(t)}getActiveModel(){return this.__coreView__.ndsModel.getActiveModel()}getModelById(e){return this.__coreView__.ndsModel.getModelById(e)}getModelIndexByModelId(e){let t=this.__coreView__.ndsModel;for(let r=0;r<t.models.length;++r)if(t.models[r].id===e)return r}getModelByIndex(e){return this.__coreView__.ndsModel.models[e]}registOperator(e,t){this.__coreView__.registOperator(e,t)}setOperatorByID(e){this.__coreView__.setOperatorByID(e)}getCurrentOperator(){return this.__coreView__.controls.getOperator()}getCurrentOperatorID(){return this.__coreView__.getCurrentOperatorID()}setOperator(e){this.__coreView__.setOperator(e)}registCursor(e,t,r){this.__coreView__.registCursor(e,t,r)}hideSelectedObjects(){this.__coreView__.hideSelectedObjects()}getViewControlBoundingBox(){return this.__coreView__.controls.getBoundingBox()}setViewControlBoundingBox(e,t){this.__coreView__.controls.setBoundingBox(e,t)}getCamera(){return this.__coreView__.camera}setCameraControlBoundingBoxCenter(e){this.__coreView__.cameraControl.setBoundingBoxCenter(e)}setCameraControlBounding(e,t){this.__coreView__.cameraControl.setBoundingBox(e,t)}getCameraInfo(){return this.__coreView__.cameraControl.getCameraInfo()}adjustNearAndFar(){this.__coreView__.cameraControl.adjustNearAndFar()}updateViewBoxCamDir(){this.__coreView__.cameraControl.updateViewBoxCamDir()}startSmoothTranslation(e){this.__coreView__.cameraControl.startSmoothTranslation(e)}zoomExtents(e,t,r){this.__coreView__.cameraControl.zoomExtents(e,t,r)}setCameraInfo(e,t){this.__coreView__.cameraControl.setCameraInfo(e,t)}getOrginalCameraInfo(){return this.__coreView__.viewManager?this.__coreView__.viewManager.getOrginalCameraInfo():this.__coreView__.camera.getOrginalCameraInfo()}setOrginalCameraInfo(e,t,r){this.__coreView__.camera.setOrginalCameraInfo({center:e,up:t,position:r})}toPerspectiveCamera(){this.__coreView__.toPerspectiveCamera()}toOrthographicCamera(){this.__coreView__.toOrthographicCamera()}updateGroundTransform(e,t,r){return this.__coreView__.groundShadow.updateGroundTransform(e,t,r)}isRendererContainsClipPlanes(){return this.__coreView__.renderer.clippingPlanes.length>0}getCanvas2D(){return this.__coreView__.canvas2D}getCanvas3D(){return this.__coreView__.canvas3D}getContainer(){return this.__coreView__.container}getRenderDomElement(){return this.__coreView__.renderer.domElement}getAdditionalObjectsScene(){return this.__coreView__.additionalObjectsScene}getDispalyModelUnit(e,t){return this.__coreView__.getDispalyModelUnit(e,t)}modelCoordToClientCoord(e){return this.__coreView__.modelCoordToClientCoord(e)}clientCoordToModelCoord(e){return this.__coreView__.clientCoordToModelCoord(e)}showObject(e,t,r,o=!0){this.__coreView__.showObject(e,t,r,o)}showObjectReversed(e){this.__coreView__.showObjectReversed(e)}renderAllViews(){this.__coreView__.renderAllViews()}render(e){this.__coreView__.render(e)}setRenderMode(e,t){this.__coreView__.setRenderMode(e,t)}getRenderMode(){let e;switch(this.__coreView__.getRenderMode()){case 0:e="lighting";break;case 1:e="primarycolor";break;case 2:e="wireframe";break;case 3:e="whitemold";break;case 4:e="shadedWithEdges";break;case 5:e="shaded";break;case 6:e="hiddenLineRemove";break;case 7:e="hiddenLineVisible";break;case 8:e="transparent"}return e}getAssemblyPMIState(){return this.__coreView__.AssemblyPMIState}setAssemblyPMIState(e){this.__coreView__.AssemblyPMIState=e}getPartPMIState(){return this.__coreView__.PartPMIState}setPartPMIState(e){this.__coreView__.PartPMIState=e}getPmiVisible(){return this.__coreView__.pmiVisible}setPmiVisible(e){this.__coreView__.pmiVisible=e}setPMIObjectVisible(e,t){this.__coreView__.setPMIObjectVisible(e,t)}isPMIOccludeByModel(){return!NDSWebViewer.SETTING.StopPMIOcclusion}enablePMIOccludeByModel(e){this.__coreView__.stopPMIOcclusion(!e)}getPmiList(){return this.__coreView__.PMINDSBodys}getPMIObjectByUUID(e){return this.__coreView__.PMIUUIDtoPMIObject[e]}isPMIObjectOrSomeChildHidden(e){return this.__coreView__.isPMIObjectOrSomeChildHidden(e)}getPmiObjectTree(){return this.__coreView__.pmiObject}getSelectedPmiList(){return this.__coreView__.getPMINDSBodySelectList()}selectPMIObject(e){this.__coreView__.selectPMIObject(e)}deselectPMIObject(e){this.__coreView__.deselectPMIObject(e)}unmergeBodyNode(){this.__coreView__.ndsModel.unmergeNode()}mergeBodyNode(){this.__coreView__.ndsModel.mergeNode()}getAllTransparentBodies(e){return this.__coreView__.ndsModel.getAllTransparentBodies(e)}isolateBodiesOnly(e){this.__coreView__.ndsModel.isolateBodiesOnly(e)}unloadModelById(e){this.__coreView__.ndsModel.unloadModelById(e)}startLoadAnimationModel(e){let t=e.url,r=e.id,o={needsPMI:!1,needsAnimation:!1,needsSketchModel:!1,position:e.position,pmiVisible:this.__coreView__.pmiVisible,modelId:e.modelId};this.__coreView__.loadModel(r,t,null,null,"js",null,null,null,o)}getBodyNodeFromUuid(e,t=-1){var r=null;if(t>=0){let o=this.getModelById(t);if(o){let t=o.getBodyNodeFromUuid(e);t&&(r=t)}}else this.__coreView__.ndsModel.models.forEach((t=>{let o=t.getBodyNodeFromUuid(e);o&&(r=o)}));return r}}class s{constructor(e){this.__meshstate__=e}getMeshMaterial(e){return this.__meshstate__.getMeshMaterial(e)}setMeshMaterial(e,t){this.__meshstate__.setMeshMaterial(e,t)}setMeshMaterialTemporary(e,t){let r=this.__meshstate__.meshMtls.get(e);if(r){let e=r.material;r.material=t,this.__meshstate__.__updateMeshMtlBuffer(r.meshMtlIndex,r),this.__meshstate__.meshMtlTexture.needsUpdate=!0,r.material=e,r.meshSet.needsUpdate=!0,r.meshSet.prepareForBatchDraw()}}getLineMaterial(e){this.__meshstate__.getLineMaterial(e)}setLineMaterial(e,t,r){this.__meshstate__.setLineMaterial(e,t,r)}setLineMaterialTemporary(e,t,r){let o=this.__meshstate__.lineMtls.get(e);if(o){let e=2*o.lineMtlIndex;this.__meshstate__.lineMtlBuffer[e]=t,this.__meshstate__.lineMtlBuffer[e+1]=Math.round(1e3*r),this.__meshstate__.lineMtlTexture.needsUpdate=!0}}}class i{constructor(e){this.__brepManager__=e}hasBrepInfo(){return this.__brepManager__.hasBrepInfo()}hasBrepFile(){return this.__brepManager__.hasBrepFile()}}
/**
	 * @file 这是新迪轻量化引擎查看器插件框架代码，请不要修改此文件
	 * @copyright 新迪数字 2024
	 */class n{constructor(e){this.__ndsModel__=e,e.meshState&&(this.__meshState__=new s(e.meshState)),e.brepManager&&(this.__brepManager__=new i(e.brepManager))}get isMCAD3DModel(){return this.__ndsModel__.isMCAD3DModel}get isMCAD2DModel(){return this.__ndsModel__.isMCAD2DModel}get typeName(){return this.__ndsModel__.typeName}get ndsModelId(){return this.__ndsModel__.id}get numMesh(){}getMeshState(){return this.__meshState__}getBrepManager(){return this.__brepManager__}getPMIObject(){return this.__ndsModel__.pmiObject}getRootBodyNode(){return this.__ndsModel__.rootBodyNode}getBodyNode(e){return this.__ndsModel__.getBodyNode(e)}getLeafBodies(e){return this.__ndsModel__.getLeafBodies(e)}isSketchModel(){return!!this.__ndsModel__.isSketchModel}getLeafBodyNodes(){return this.__ndsModel__.wholeLeafBodyNodes}transparentizeBodies(e){this.__ndsModel__.transparentizeBodies(e)}isolateBodies(e){this.__ndsModel__.isolateBodies(e,NDSWebViewer.SETTING.bodyOpacity,NDSWebViewer.SETTING.lineOpacity)}clearTransparentBodies(){this.__ndsModel__.exitIsolate()}getMeshSets(){return this.__ndsModel__.getMeshSets()}changeObjectidTouuid(e){return this.__ndsModel__.objectidTouuid[e]}getMeshMaterial(e){if(!this.__ndsModel__)return null;let t=this.__ndsModel__.meshManager.materialId[e],r=this.__ndsModel__.meshManager.materialUuids[t];return this.__ndsModel__.meshManager.materials[r].mat}setMeshMaterial(e,t){if(!this.__ndsModel__)return!1;let r=this.__ndsModel__,o=0;if(r.meshManager.materials[t.uuid]){for(let e=0;e<r.meshManager.materialUuids.length;e++)if(r.meshManager.materialUuids[e]===t.uuid){o=e;break}}else r.meshManager.materials[t.uuid]={mat:t,refCount:0},o=r.meshManager.materialUuids.length,r.meshManager.materialUuids.push(t.uuid);let s=r.meshManager.materialId[e],i=r.meshManager.materialUuids[s];return r.meshManager.materials[i].refCount--,r.meshManager.materials[t.uuid].refCount++,r.meshManager.materialId[e]=o,r.meshManager.materialIdOriginal[e]=o,!0}removeAllBodyNodeMaterials(){this.__ndsModel__.removeAllBodyNodeMaterials()}refreshBodyWorldMatrixUniforms(){this.__ndsModel__.refreshBodyWorldMatrixUniforms()}refreshMeshState(e=void 0){this.__ndsModel__.refreshMeshState(e||this.__ndsModel__.rootBodyNode)}}
/**
	 * @file 这是新迪轻量化引擎查看器插件框架代码，请不要修改此文件
	 * @copyright 新迪数字 2024
	 */class a{static getModel(e){return e.ndsModel}static getModelId(e){return e.ndsModel.id}static getUUID(e){return e.uuid}static getObjectId(e){return e.objectid}static getId(e){return e.id}static getBodyNodeMaterial(e){let t=e.getMaterialBodyNodeUUid();return t&&e.useBodyNodeMaterial?e.ndsModel.bodyNodeUUidToMaterial[t]:null}static setBodyNodeMaterial(e,t){e.ndsModel.bodyNodeUUidToMaterial[e.uuid]=t,e.useBodyNodeMaterial=!!t}static getUserMaterial(e){return e.getUserMaterial()}static setUserMaterial(e,t){e.setUserMaterial(t)}static getBoundingBox(e){var t=new THREE.Box3;return e.getBoundingBox(t,!0)}static getInstanceBoundingBox(e,t){var r=new THREE.Box3;return e.IsInstanceNode&&void 0!==t?e.getInstanceBoundingBox(t,r):e.getBoundingBox(r,!0)}static isLeafBodyNode(e){return!!e.leafBodyAttri}static isPartBodyNode(e){return"Part"===e.type}static getLeafBodyNodes(e){return e.ndsModel.getLeafBodies(e)}static getMeshesInLeafBodyNode(e){return e.leafBodyAttri?e.leafBodyAttri.bodyMeshIds:[]}static getMatrixLocal(e){return e.matrix}static getMatrixWorld(e){return e.worldMatrix}static setMatrixWorld(e,t){e.setMatrixWorld(t)}static applyTransform(e,t=null){e.applyTransform(t)}static updateMatrixWorld(e,t=!1){e.updateMatrixWorld(t,!0)}static hide(e){e.hide(e)}static show(e){e.show()}static isPreSelected(e){return e.isPreSelected()}static isSelected(e){return e.isSelected()}static isTransparent(e){return e.isTransparent()}static isHidden(e){return e.isHidden()}static isIsolated(e){return e.isIsolated()}static getRenderMode(e){switch(e.renderMode){case 3:return"wireframe";case 4:return"hiddenLineRemove";case 5:return"hiddenLineVisible"}return""}static getBodyNodeTranslate(t,r,o=void 0){let s=new THREE.Vector3(0,0,0),i=t.getExtensionWithFlags(e.FLAG_ENABLE_NODE_TRANSFORM);for(let e=0,t=i.length;e<t;++e)s.add(i[e].getBodyNodeTranslate(r,o));return s}static updateNodeMatrix(e,t){e.ndsModel.updateNodeMatrix(e.uuid,t,e.getModel().id)}static hideBody(e){e.ndsModel.hideBody(e)}static showBody(e){e.ndsModel.showBody(e)}}class d extends NDSWebViewer.OpBase{constructor(e){super(e)}setFrameListener(e){this.__frameListener__&&this.viewer.removeFrameListener(this.__frameListener__),this.__frameListener__=e,e&&this.viewer.addFrameListener(e)}render(e=!1,t=!0){super.render(e,t)}init(){super.init()}release(){super.release()}update(){super.update()}selectByClick(e,t,r){super.selectByClick(e,t,r)}mouseEvent(e){super.mouseEvent(e)}onTouchSingleStart(e){super.onTouchSingleStart(e)}onTouchSingleMove(e){super.onTouchSingleMove(e)}onTouchSingleEnd(e){super.onTouchSingleEnd(e)}onTouchDoubleStart(e){super.onTouchDoubleStart(e)}onTouchDoubleMove(e){super.onTouchDoubleMove(e)}onTouchDoubleEnd(e){super.onTouchDoubleEnd(e)}onLMouseDbClick(e){super.onLMouseDbClick(e)}onLMouseClick(e){super.onLMouseClick(e)}onMMouseClick(e){super.onMMouseClick(e)}onRMouseClick(e){super.onRMouseClick(e)}onLMouseDown(e){super.onLMouseDown(e)}onMMouseDown(e){super.onMMouseDown(e)}onRMouseDown(e){super.onRMouseDown(e)}onLMouseMove(e){super.onLMouseMove(e)}onMMouseMove(e){super.onMMouseMove(e)}onRMouseMove(e){super.onRMouseMove(e)}onNMouseMove(e){super.onNMouseMove(e)}onLMouseUp(e){super.onLMouseUp(e)}onMMouseUp(e){super.onMMouseUp(e)}onRMouseUp(e){super.onRMouseUp(e)}}class l extends d{constructor(e,t){super(e),this.sceneWraper=new o(e),this.selectWraper=new r(e),this.__globalClipExtension=void 0,this.type="OpDrag",this.opMode="default",this.selectedBox=null,this.prompt=null,this.oldMatrix4=new THREE.Matrix4,this.oldQuaternion=new THREE.Quaternion,this.isNewAxis=!0,this.isChangeDispatch=!0,this.center=new THREE.Vector3,this.originQuat=new THREE.Quaternion,this.extension=t,this.attachObj=null,this.domElement=null,this.sceneWraper.getCanvas2D()?this.domElement=this.sceneWraper.getCanvas2D():this.domElement=this.sceneWraper.getCanvas3D(),this.transformControl=null,this.transformControlMode=null;let s=this;this.changeFunc=function(e){s.sceneWraper.render()},this.objChangeFunc=function(e){s.onOpDrag(!0)}}__retrieveSelectedObject(e){return void 0!==e.instanceOrPartIndex?e.bodyNode:e}setMoveMode(){this.opMode="move",this.InitBall();for(let e=0,t=this.sceneWraper.getModelCount();e<t;++e){let t=this.sceneWraper.getModelByIndex(e),r=new n(t);r.isSketchModel()&&a.hideBody(r.getRootBodyNode())}this.sceneWraper.renderAllViews()}setBoxMoveMode(){this.opMode="BoxMove",this.prompt||(this.prompt=document.createElement("div"),this.prompt.className="pc-alert",this.prompt.innerHTML=NDSWebViewer.COMMON.translateString("MEASURE_PLACELINELOCATION"),this.prompt.style.display="block",this.sceneWraper.getContainer().appendChild(this.prompt))}setRestoreMode(){this.opMode="restore",this.InitBall()}setDefaultMode(){this.opMode="default",this.InitBall()}setDragBoxMode(){this.opMode="dragBox"}isModelMoved(){if(this.sceneWraper.getModelCount()>0)return this.extension.dragBodies.size>0;var e=!1;return this.sceneWraper.getScene.traverse((function(t){t.hasOwnProperty("geometry")&&null!=t.matrixWorldTransOrginalDrag&&(e=!0)})),e}hideSelectedModel(){this.sceneWraper.hideSelectedObjects();let e=this.getClipExtension();e&&e.isSectionViewEnabled()&&e.updateClipPlane()}showAllModel(){this.sceneWraper.showObject(this.viewer.scene,!0);let e=this.getClipExtension();e&&e.isSectionViewEnabled()&&clipExtensionupdateClipPlane(),this.render(!1,!1)}reverseVisibleAndHidingModel(){this.sceneWraper.showObjectReversed(this.viewer.scene);let e=this.getClipExtension();e&&e.isSectionViewEnabled()&&e.updateClipPlane(),this.render(!1,!1)}create(){NDSWebViewer.SETTING.HideLeafBody?(this.selectWraper.setSelectType("part"),this.sceneWraper.getCurrentOperator().oldSelectType="part"):this.selectWraper.setSelectType("body"),super.create()}release(){this.InitBall(!0),this.transformControlMode=null,this.update(),this.prompt&&(this.sceneWraper.getContainer().removeChild(this.prompt),this.prompt=null),this.render(!1,!1),super.release()}update(){this.selectWraper.clearSelection(),super.update()}onLMouseClick(e){var t=this.sceneWraper.getRenderDomElement(),r=e.offsetX||e.clientX-this.sceneWraper.getContainer().getBoundingClientRect().left,o=e.offsetY||e.clientY-this.sceneWraper.getContainer().getBoundingClientRect().top;e.srcElement&&e.srcElement!==t&&(r=e.clientX-this.sceneWraper.getContainer().getBoundingClientRect().left,o=e.clientY-this.sceneWraper.getContainer().getBoundingClientRect().top),null==e.srcElement&&e.target&&e.target!==t&&(r=e.clientX-this.sceneWraper.getContainer().getBoundingClientRect().left,o=e.clientY-this.sceneWraper.getContainer().getBoundingClientRect().top);let s=this.remapCoordnidateToFullView(r,o);if(r=s[0],o=s[1],Math.abs(r-this.lMouseDown.x)<1&&Math.abs(o-this.lMouseDown.y)<1)if("move"==this.opMode||"default"==this.opMode)this.selectWraper.selectByClick(r,o,e.ctrlKey),this.render(!1,!1);else if("restore"==this.opMode)this.onOpRestore(r,o);else if("dragBox"==this.opMode||"BoxMove"==this.opMode){let e=this.viewer.AnimationEdit._activeAnimationID,t=this,r=this.viewer.insertBox.position;this.viewer.loadModelAnimationEnd(this.selectedBox.url,(function(){let o=t.viewer.ndsModel.models.length-1;t.viewer.ndsModel.models[o].animationId=e,t.viewer.ndsModel.models[o].position=r}))}this.InitBall()}InitBall(e=!1){this.transformControl&&(this.transformControl.removeEventListener("change",this.changeFunc),this.transformControl.removeEventListener("objectChange",this.objChangeFunc),this.transformControl.detach(),this.transformControl.dispose(),this.sceneWraper.getAdditionalObjectsScene().remove(this.transformControl),this.transformControl=null),this.attachObj&&(this.sceneWraper.getAdditionalObjectsScene().remove(this.attachObj),this.attachObj.geometry.dispose(),this.attachObj.material.dispose(),this.attachObj=null,this.center=new THREE.Vector3);let t=this.getSelectedBodyBoundingBox();if(!e&&t&&"move"==this.opMode){t.getCenter(this.center),this.transformControl=new NDSWebViewer.TransformControls(this.viewer,this.domElement),this.transformControl.addEventListener("change",this.changeFunc),this.transformControl.addEventListener("objectChange",this.objChangeFunc);const e=new THREE.SphereGeometry(.1,1,1),r=new THREE.MeshBasicMaterial({colorWrite:!1});return this.attachObj=new THREE.Mesh(e,r),this.attachObj.position.copy(this.center),this.attachObj.updateMatrixWorld(!0),this.transformControl.setMode("both"),this.transformControl.setSpace("world"),this.transformControl.attach(this.attachObj),NDSWebViewer.COMMON.isMobileDevice()?(this.transformControlMode=this.transformControlMode?this.transformControlMode:"translate",this.transformControl.setMode(this.transformControlMode),this.transformControl.setSize(1)):this.transformControl.setSize(.8),this.transformControl.update(),this.sceneWraper.getAdditionalObjectsScene().add(this.attachObj),this.sceneWraper.getAdditionalObjectsScene().add(this.transformControl),this.oldQuaternion.copy(this.attachObj.quaternion),this.oldMatrix4.copy(this.attachObj.matrixWorld),this.originQuat.copy(this.attachObj.quaternion),this.isNewAxis=!0,void this.dispatchChanges(this.center.clone(),this.oldQuaternion.clone())}this.dispatchChanges(new THREE.Vector3,new THREE.Quaternion)}setTransformCtrlMode(e){this.transformControlMode=e,this.transformControl&&this.transformControl.setMode(e)}onMMouseUp(e){super.onMMouseUp(e),this.InitBall()}MoveFromTextValue(e){if(!e)return this.selectWraper.clearSelection(),this.InitBall(),void this.render(!1,!1);if(this.transformControl){e.x=parseFloat(e.x),e.y=parseFloat(e.y),e.z=parseFloat(e.z);var t=this.sceneWraper.getDispalyModelUnit(10),r=this.sceneWraper.getModelCount()>0?this.selectWraper.getSelectedObjects():null;if(r){if(this.isChangeDispatch=!1,1==r.length){let s=this.__retrieveSelectedObject(r[0]);var o=a.getLeafBodyNodes(s);for(let e=0;e<o.length;++e)if(a.isLeafBodyNode(o[e])){s=o[e];break}let i=null,n=this.sceneWraper.getModelIndexByModelId(a.getModelId(s));this.extension.dragBodies.has(n)||this.extension.dragBodies.set(n,new Map);let d=this.extension.dragBodies.get(n),l=this.extension.getBodyNodeIdKey(s,r[0].instanceOrPartIndex);if(!d.has(l)){let e=new THREE.Vector3;a.getInstanceBoundingBox(s,r[0].instanceOrPartIndex).getCenter(e);let t=a.getBodyNodeTranslate(this.extension,s,r[0].instanceOrPartIndex);e.x-=t.x,e.y-=t.y,e.z-=t.z,d.set(l,{bodyDragTranslate:new Float32Array(3),bodyDragQuaternion:new THREE.Quaternion,bodyDragQuaternionOrigin:new THREE.Quaternion,center:e.clone()})}if(i=d.get(l),i){let r=new THREE.Vector3(i.bodyDragTranslate[0],i.bodyDragTranslate[1],i.bodyDragTranslate[2]);if(i.bodyDragQuaternionOrigin.clone(),"translate"==e.mode){let o=new THREE.Vector3(e.x,e.y,e.z);o.multiplyScalar(1/t.scale).sub(r),o.add(this.transformControl.object.position),this.transformControl.object.position.copy(o),this.transformControl.object.updateMatrixWorld(!0)}else if("rotate"==e.mode){i.bodyDragQuaternionOrigin=new THREE.Quaternion;let t=new THREE.Euler(e.x*Math.PI/180,e.y*Math.PI/180,e.z*Math.PI/180),r=(new THREE.Quaternion).setFromEuler(t);this.transformControl.object.quaternion.copy(r),this.transformControl.object.updateMatrixWorld(!0),this.isNewAxis=!1}this.onOpDrag(!0),s.updateBoundingBox(),this.InitBall()}}else{if("translate"==e.mode){var s=new THREE.Vector3(e.x,e.y,e.z);s.multiplyScalar(1/t.scale),s.add(this.center),this.transformControl.object.position.copy(s),this.transformControl.object.updateMatrixWorld(!0)}else if("rotate"==e.mode){let t=new THREE.Euler(e.x*Math.PI/180,e.y*Math.PI/180,e.z*Math.PI/180),r=new THREE.Quaternion;r.setFromEuler(t),this.transformControl.object.quaternion.copy(this.originQuat.clone().invert().multiply(r)),this.transformControl.object.updateMatrixWorld(!0)}this.onOpDrag(!0)}this.isChangeDispatch=!0}}}MoveBox(e){if(!this.selectedBox&&this.viewer.insertBox&&(this.selectedBox=this.viewer.insertBox,this.selectedBoxOri=this.viewer.insertBox.box.clone(),this.selectedBoxPos=this.selectedBox.position.clone()),!this.selectedBox)return;var t=this.pointer.x,r=this.pointer.y;let o=this.sceneWraper.modelCoordToClientCoord([this.selectedBoxPos.x,this.selectedBoxPos.y,this.selectedBoxPos.z]),s=this.sceneWraper.modelCoordToClientCoord([this.selectedBoxOri.min.x,this.selectedBoxOri.max.y,this.selectedBoxOri.min.z]);var i=[t-(s[0]-o[0]),r-(s[1]-o[1]),s[2]],n=this.sceneWraper.clientCoordToModelCoord(i),a=new THREE.Vector3(n[0],n[1],n[2]).clone();this.selectedBox.position.copy(this.selectedBoxPos).add(a),this.selectedBox.updateMatrixWorld(!0),this.selectedBox.box.copy(this.selectedBoxOri).translate(a),this.render()}getOffsetPostion(e,t){var r=e.clone(),o=t.clone();return function(e){let t=(new THREE.Matrix4).getInverse(o.clone()).clone().multiply(e.clone()),s=r.clone().multiply(t.clone()),i=e.clone();var n=new THREE.Vector3,a=new THREE.Vector3;return s.decompose(a,new THREE.Quaternion,new THREE.Vector3(1,1,1)),i.decompose(n,new THREE.Quaternion,new THREE.Vector3(1,1,1)),a.sub(n)}}dragBody(e,t,r=null,o=void 0){for(var s=a.getLeafBodyNodes(e),i=0,d=s.length;i<d;++i){var l=s[i];if(!a.isLeafBodyNode(l))continue;let e=this.sceneWraper.getModelIndexByModelId(a.getModelId(l));this.extension.dragBodies.has(e)||this.extension.dragBodies.set(e,new Map);let n,d=this.extension.dragBodies.get(e),h=new THREE.Vector3;l.IsInstanceNode&&void 0!==o?(a.getInstanceBoundingBox(l,o).getCenter(h),n=a.getBodyNodeTranslate(this.extension,l,o)):(a.getBoundingBox(l).getCenter(h),n=a.getBodyNodeTranslate(this.extension,l));let c=this.extension.getBodyNodeIdKey(l,o);d.has(c)||(h.x-=n.x,h.y-=n.y,h.z-=n.z,d.set(c,{bodyDragTranslate:new Float32Array(3),bodyDragQuaternion:new THREE.Quaternion,bodyDragQuaternionOrigin:new THREE.Quaternion,center:h.clone()}));let _=d.get(c);if(h.x=_.center.x+n.x,h.y=_.center.y+n.y,h.z=_.center.z+n.z,t){let e=new THREE.Matrix4;e.compose(h,new THREE.Quaternion,new THREE.Vector3(1,1,1));let r=t(e.clone());_.bodyDragTranslate[0]+=r.x,_.bodyDragTranslate[1]+=r.y,_.bodyDragTranslate[2]+=r.z}r&&(r._isNewAxis&&_.bodyDragQuaternionOrigin.copy(_.bodyDragQuaternion),_.bodyDragQuaternion.copy(r.clone().multiply(_.bodyDragQuaternionOrigin).normalize())),a.setBodyNodeMaterial(l)}a.applyTransform(e),new n(a.getModel(e)).refreshBodyWorldMatrixUniforms()}onOpDrag(e=!1){if(this.transformControl){var t=this.sceneWraper.getModelCount()>0?this.selectWraper.getSelectedObjects():this.selectWraper.getSelectedMeshes();if(this.sceneWraper.getModelCount()>0){let e=this.sceneWraper.getBoundingBox();this.viewer.cameraControl.setBoundingBox(e.min,e.max),this.viewer.cameraControl.adjustNearAndFar();let a=this.attachObj.quaternion.clone(),d=this.attachObj.matrixWorld.clone();for(var r=this.getOffsetPostion(d,this.oldMatrix4),o=a.normalize().clone(),s=0;s<t.length;++s){var i=this.__retrieveSelectedObject(t[s]);o._isNewAxis=this.isNewAxis,this.dragBody(i,r,o,t[s].instanceOrPartIndex)}let l=this.getClipExtension();l&&l.isSectionViewEnabled()&&l.updateClipPlane(),this.oldMatrix4=d,this.oldQuaternion=a;var n=new THREE.Vector3;let h=new THREE.Quaternion;d.decompose(n,h,new THREE.Vector3(1,1,1)),this.isNewAxis=!1,this.dispatchChanges(n.clone(),h.clone())}e?this.sceneWraper.renderAllViews():this.sceneWraper.render(),this.sceneWraper.dispatchEvent({type:"dragingModel"})}}getUnitStringmap(e){var t="mm";if(e)switch(e.toLowerCase()){case"meter":t="m";break;case"centimeter":t="cm";break;case"millimeter":t="mm";break;case"inch":t="in";break;case"um":t="um";break;case"feet":t="ft"}return t}dispatchChanges(e,t){if(!this.sceneWraper.getModelCount()>0||!this.isChangeDispatch)return;let r=e.sub(this.center),o=new THREE.Euler(0,0,0);o.setFromQuaternion(this.originQuat.clone().invert().multiply(t));var s=this.sceneWraper.getModelCount()>0?this.selectWraper.getSelectedObjects():null;if(!s)return;if(1==s.length){let e=this.__retrieveSelectedObject(s[0]);0!=e.children.length&&void 0!==e.FirstVisibleNode&&(e=e.children[e.FirstVisibleNode]);let t=this.extension.dragBodies.get(this.sceneWraper.getModelIndexByModelId(a.getModelId(e)));if(!t)return;let i=t.get(this.extension.getBodyNodeIdKey(e,s[0].instanceOrPartIndex));i&&(r=new THREE.Vector3(i.bodyDragTranslate[0],i.bodyDragTranslate[1],i.bodyDragTranslate[2]),o.setFromQuaternion(i.bodyDragQuaternion.clone()))}var i=this.sceneWraper.getDispalyModelUnit(10);r.multiplyScalar(i.scale);let n=this.getUnitStringmap(i.unit);NDSWebViewer.SETTING.enableBroadcast&&!NDSWebViewer.SETTING.broadcastMajor||(this.sceneWraper.dispatchEvent({type:"DragTranslate",position:{x:r.x,y:r.y,z:r.z},unit:n}),this.sceneWraper.dispatchEvent({type:"DragRotate",angle:{x:180*o.x/Math.PI,y:180*o.y/Math.PI,z:180*o.z/Math.PI}}))}onOpDragBox(){var e=this.pointer.x-this.pointerOld.x,t=this.pointer.y-this.pointerOld.y,r=[this.downModelPnt.x,this.downModelPnt.y,this.downModelPnt.z],o=this.sceneWraper.modelCoordToClientCoord(r),s=[o[0]+e,o[1]+t,o[2]],i=this.sceneWraper.clientCoordToModelCoord(s),n=new THREE.Vector3(i[0],i[1],i[2]).clone();this.selectedBox.position.add(n),this.selectedBox.updateMatrixWorld(!0),this.selectedBox.box.translate(n),this.render()}onOpRestore(e,t){this.selectWraper.clearSelection(),this.selectWraper.selectByClick(e,t);let r=this.getClipExtension();if(this.sceneWraper.getModelCount()>0){for(var o=this.selectWraper.getSelectedObjects(),s=0;s<o.length;++s){var i=this.__retrieveSelectedObject(o[s]);this.extension.restoreDraggedBody(i,o[s].instanceOrPartIndex)}r&&r.isSectionViewEnabled()&&r.updateClipPlane()}this.InitBall(!0),this.render(!1,!1),this.sceneWraper.dispatchEvent({type:"dragingModel"})}onNMouseMove(e){this.selectedBox&&"BoxMove"==this.opMode?(this.prompt&&!NDSWebViewer.COMMON.isMobileDevice()&&(this.prompt.style.left=e.clientX+16+"px",this.prompt.style.top=e.clientY+18+"px"),this.MoveBox(e)):super.onNMouseMove.call(e)}onLMouseMove(e){var t=this.sceneWraper.getModelCount()>0?this.selectWraper.getSelectedObjects():this.selectWraper.getSelectedMeshes();this.transformControl&&this.transformControl.axis&&t.length>0&&"move"==this.opMode||(this.selectedBox&&"BoxMove"==this.opMode?this.onOpDragBox():super.onLMouseMove(e))}onLMouseUpEnd(e){if((this.sceneWraper.getModelCount()>0?this.selectWraper.getSelectedObjects():this.selectWraper.getSelectedMeshes()).length>0){let e=new THREE.Vector3,t=new THREE.Vector3;if(this.sceneWraper.getModelCount()>0){let r=this.sceneWraper.getBoundingBox();r&&(e.copy(r.min),t.copy(r.max))}if(e.x>t.x||e.y>t.y||e.z>t.z)return;this.sceneWraper.setCameraControlBounding(e,t)}this.extension.updateBroadcastInfo()}onTouchSingleStart(e){super.onTouchSingleStart(e)}onTouchSingleMove(e){var t=this.sceneWraper.getModelCount()>0?this.selectWraper.getSelectedObjects():this.selectWraper.getSelectedMeshes();this.transformControl&&this.transformControl.axis&&t.length>0&&"move"==this.opMode||super.onTouchSingleMove(e)}onTouchSingleEnd(e){this.state=-1,Math.abs(this.singleTouchEndPos.x-this.singleTouchStartPos.x)<1&&Math.abs(this.singleTouchEndPos.y-this.singleTouchStartPos.y)<1&&("move"==this.opMode||"default"==this.opMode?(this.selectWraper.selectByClick(this.singleTouchEndPos.x,this.singleTouchEndPos.y),this.render(!1,!1)):"restore"==this.opMode&&this.onOpRestore(this.singleTouchEndPos.x,this.singleTouchEndPos.y)),this.hideRotateCenterHelper(),this.InitBall()}getSelectedBodyBoundingBox(){let e=null,t=this.selectWraper.getSelectedObjects();0===t.length&&this.selectWraper.clearSelection();for(let r=0;r<t.length;r++){const o=this.__retrieveSelectedObject(t[r]);let s=a.getModel(o);if(s){let i=s.getLeafBodies(o);for(let o=0;o<i.length;++o)if(i[o]&&a.isLeafBodyNode(i[o])){let s;s=i[o].IsInstanceNode?a.getInstanceBoundingBox(i[o],t[r].instanceOrPartIndex):a.getBoundingBox(i[o]),e?e.union(s):e=s.clone()}}}return e}getClipExtension(){return void 0===this.__globalClipExtension&&(this.__globalClipExtension=NDSWebViewer.ExtensionManager.getExtension("ClipExtension")),this.__globalClipExtension}}"undefined"!=typeof token&&token;const h=new class extends t{constructor(){super(),this.setFlags(e.FLAG_ENABLE_NODE_TRANSFORM|e.FLAG_ENABLE_NODE_STOREVIEW|e.FLAG_ENABLE_NODE_BROADCAST),this.name="TransformExtension",console.log("TransformExtension version 1.0.2"),this.coreView=null,this.OperatorName="OpDrag",this.dragBodies=new Map}onLoad(e){this.sceneWraper=new o(e),this.selectWraper=new r(e);let t=this;this.sceneWraper.registOperator(this.OperatorName,(function(e){return new l(e,t)})),this.coreView=e}onInitLights(e){}onNdsModelPrepareForRendering(e){}onBeforeNdsModelSetRender(e,t){"OpDrag"!=this.sceneWraper.getCurrentOperator().type||t.stopRenderingEarly||this.sceneWraper.getCurrentOperator().transformControl&&(this.sceneWraper.getCurrentOperator().transformControl.updateMatrixWorld(),this.sceneWraper.getCurrentOperator().transformControl.update())}onAfterGetBroadcastInfo(e){this.getStoreInfo(e),e.dragInfo||(e.dragInfo=[])}onAfterSetBroadcastInfo(e){e.dragInfo&&this.setStoreInfo(e)}updateBroadcastInfo(){NDSWebViewer.SETTING.enableBroadcast&&NDSWebViewer.SETTING.broadcastMajor&&(NDSWebViewer.ExtensionManager.updateBroadcastInfo(this.name),NDSWebViewer.ExtensionManager.updateBroadcastInfo("ModelState"))}getBodyNodeIdKey(e,t=void 0){return void 0!==t&&e.IsInstanceNode?`${e.id}-${t}`:e.id}getBodyNodeIdFromKey(e){if(Number.isInteger(e))return{bodyId:e,bodyInstanceId:void 0};if(-1!=e.indexOf("-")){let t=e.split("-");return{bodyId:Number(t[0]),bodyInstanceId:Number(t[1])}}return{bodyId:e,bodyInstanceId:void 0}}getBodyNodeTranslate(e,t){let r=this.sceneWraper.getModelIndexByModelId(a.getModelId(e)),o=this.getBodyNodeIdKey(e,t);if(!this.dragBodies.has(r))return new THREE.Vector3(0,0,0);let s=this.dragBodies.get(r);if(!s.has(o))return new THREE.Vector3(0,0,0);let i=s.get(o);return new THREE.Vector3(i.bodyDragTranslate[0],i.bodyDragTranslate[1],i.bodyDragTranslate[2])}getBodyTransform(e,t){let r=this.getBodyNodeIdKey(e,t),o=this.sceneWraper.getModelIndexByModelId(a.getModelId(e));if(!this.dragBodies.has(o))return new THREE.Matrix4;let s=this.dragBodies.get(o);if(!e._leafBodyAttri||!s.has(r))return new THREE.Matrix4;let i=s.get(r),n=i.bodyDragTranslate,d=new THREE.Vector3;d.x=i.center.x,d.y=i.center.y,d.z=i.center.z;let l=new THREE.Matrix4;l.makeTranslation(d.x,d.y,d.z);let h=new THREE.Matrix4;return h.getInverse(l),l.elements[12]+=n[0],l.elements[13]+=n[1],l.elements[14]+=n[2],l.multiply((new THREE.Matrix4).makeRotationFromQuaternion(i.bodyDragQuaternion)).multiply(h)}resetToDefault(){this.restoreAllDraggedObjects()}clear(){this.dragBodies.clear()}getStoreInfo(e){let t=[];for(const[e,r]of this.dragBodies.entries()){let o=[];for(const[e,t]of r.entries()){let r=this.getBodyNodeIdFromKey(e),s={id:r.bodyId,translate:[t.bodyDragTranslate[0],t.bodyDragTranslate[1],t.bodyDragTranslate[2]],quat:[t.bodyDragQuaternion.x,t.bodyDragQuaternion.y,t.bodyDragQuaternion.z,t.bodyDragQuaternion.w],center:[t.center.x,t.center.y,t.center.z]};void 0!==r.bodyInstanceId&&(s.bodyInstanceId=r.bodyInstanceId),o.push(s)}t.push({id:e,list:o})}t.length>0&&(e.dragInfo=t)}setStoreInfo(e){if(this.restoreAllDraggedObjects(),e.dragInfo){let i=e.dragInfo;for(let e=0;e<i.length;++e){let d=this.sceneWraper.getModelByIndex(i[e].id);if(!d)continue;let l=new n(d),h=i[e].list;this.dragBodies.has(i[e].id)||this.dragBodies.set(i[e].id,new Map);let c=this.dragBodies.get(i[e].id);if(h&&h.length>0){for(var t=0;t<h.length;++t){let e=h[t];var r=new THREE.Vector3,o=new THREE.Quaternion,s=new THREE.Vector3;r.fromArray(e.translate),o.fromArray(e.quat),s.fromArray(e.center);let i=l.getBodyNode(e.id),n=this.getBodyNodeIdKey(i,e.bodyInstanceId);c.set(n,{bodyDragTranslate:new Float32Array([r.x,r.y,r.z]),bodyDragQuaternion:o,bodyDragQuaternionOrigin:new THREE.Quaternion,center:s}),a.applyTransform(i.parent)}l.refreshBodyWorldMatrixUniforms()}}}}attach2View(){this.coreView.MoveFromTextValue=(e=>{let t=this;return e=>{t.MoveFromTextValue(e)}})(),this.coreView.onSelectAndRestoreModel=(e=>{let t=this;return e=>{t.onSelectAndRestoreModel(e)}})(),this.coreView.restoreAllDraggedObjects=(e=>{let t=this;return(e,r=!0)=>{t.restoreAllDraggedObjects(e,r)}})(),this.coreView.getMaxDistance=(e=>{let t=this;return(e=1.3)=>{t.getMaxDistance(e)}})()}restoreDraggedBody(e,t=void 0){let r=a.getModel(e),o=new n(r),s=this.sceneWraper.getModelIndexByModelId(r.id);if(!this.dragBodies.has(s))return;let i=this.dragBodies.get(s);for(var d=o.getLeafBodies(e),l=0,h=d.length;l<h;++l){var c=d[l];let e=this.getBodyNodeIdKey(c,t);a.isLeafBodyNode(c)&&i.has(e)&&(i.delete(e),a.setBodyNodeMaterial(c))}a.applyTransform(e),o.refreshBodyWorldMatrixUniforms()}MoveFromTextValue(e){this.sceneWraper.getCurrentOperator().type==this.OperatorName&&this.sceneWraper.getCurrentOperator().MoveFromTextValue(e),this.updateBroadcastInfo()}onSelectAndRestoreModel(e){this.sceneWraper.getCurrentOperator().type==this.OperatorName&&(e?this.sceneWraper.getCurrentOperator().setRestoreMode():this.sceneWraper.getCurrentOperator().setDefaultMode())}restoreAllDraggedObjects(e,t=!0){if(Array.from(this.dragBodies.keys()).length>0){for(const[e,t]of this.dragBodies.entries()){let s=this.sceneWraper.getModelByIndex(e);if(!s)continue;let i=new n(s),a=Array.from(t.keys());for(var r=0,o=a.length;r<o;++r){let e=this.getBodyNodeIdFromKey(a[r]),t=i.getBodyNode(e.bodyId);t=t.parent?t.parent:t,this.restoreDraggedBody(t,e.bodyInstanceId)}}this.selectWraper.clearSelection(),t&&this.sceneWraper.getCurrentOperator().type==this.OperatorName&&this.sceneWraper.getCurrentOperator().setDefaultMode(),this.sceneWraper.setCameraControlBoundingBoxCenter(null),this.sceneWraper.getCurrentOperator().updateViewCenterByVisibleBody(),null!=e&&1!=e||this.sceneWraper.renderAllViews()}this.dragBodies=new Map,this.updateBroadcastInfo()}getMaxDistance(e=1.3){let t=new THREE.Vector3;t=this.sceneWraper.getViewControlBoundingBox().getSize(t);let r=Math.max(t.x,t.y,t.z);return r*=e,r}setTransformCtrlMode(e){this.sceneWraper.getCurrentOperator().type==this.OperatorName&&this.sceneWraper.getCurrentOperator().setTransformCtrlMode(e)}};NDSWebViewer.ExtensionManager.addExtension(h)}();
