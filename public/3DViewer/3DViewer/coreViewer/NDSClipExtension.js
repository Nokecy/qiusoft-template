!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.NDSClipExtension=t():e.NDSClipExtension=t()}(window,function(){return i=[function(e,I,w){!function(e){w.d(I,"a",function(){return E});var t,E={version:"6.4.2.2",use_lines:!0,use_xyz:!1},i=!1,i=(e.exports?(e.exports=E,i=!0):("function"==typeof define&&w(2)&&define(E),"undefined"!=typeof document?window.ClipperLib=E:self.ClipperLib=E),e=i?(t="chrome","Netscape"):(t=navigator.userAgent.toString().toLowerCase(),navigator.appName),{});-1!=t.indexOf("chrome")&&-1==t.indexOf("chromium")?i.chrome=1:i.chrome=0,-1!=t.indexOf("chromium")?i.chromium=1:i.chromium=0,-1!=t.indexOf("safari")&&-1==t.indexOf("chrome")&&-1==t.indexOf("chromium")?i.safari=1:i.safari=0,-1!=t.indexOf("firefox")?i.firefox=1:i.firefox=0,-1!=t.indexOf("firefox/17")?i.firefox17=1:i.firefox17=0,-1!=t.indexOf("firefox/15")?i.firefox15=1:i.firefox15=0,-1!=t.indexOf("firefox/3")?i.firefox3=1:i.firefox3=0,-1!=t.indexOf("opera")?i.opera=1:i.opera=0,-1!=t.indexOf("msie 10")?i.msie10=1:i.msie10=0,-1!=t.indexOf("msie 9")?i.msie9=1:i.msie9=0,-1!=t.indexOf("msie 8")?i.msie8=1:i.msie8=0,-1!=t.indexOf("msie 7")?i.msie7=1:i.msie7=0,-1!=t.indexOf("msie ")?i.msie=1:i.msie=0,E.biginteger_used=null;function _(e,t,i){E.biginteger_used=1,null!=e&&("number"==typeof e&&void 0===t?this.fromInt(e):"number"==typeof e?this.fromNumber(e,t,i):null==t&&"string"!=typeof e?this.fromString(e,256):this.fromString(e,t))}function C(){return new _(null,void 0,void 0)}t="Microsoft Internet Explorer"==e?(_.prototype.am=function(e,t,i,n,o,r){for(var s=32767&t,l=t>>15;0<=--r;){var a=32767&this[e],p=this[e++]>>15,h=l*a+p*s;o=((a=s*a+((32767&h)<<15)+i[n]+(1073741823&o))>>>30)+(h>>>15)+l*p+(o>>>30),i[n++]=1073741823&a}return o},30):"Netscape"!=e?(_.prototype.am=function(e,t,i,n,o,r){for(;0<=--r;){var s=t*this[e++]+i[n]+o;o=Math.floor(s/67108864),i[n++]=67108863&s}return o},26):(_.prototype.am=function(e,t,i,n,o,r){for(var s=16383&t,l=t>>14;0<=--r;){var a=16383&this[e],p=this[e++]>>14,h=l*a+p*s;o=((a=s*a+((16383&h)<<14)+i[n]+o)>>28)+(h>>14)+l*p,i[n++]=268435455&a}return o},28),_.prototype.DB=t,_.prototype.DM=(1<<t)-1,_.prototype.DV=1<<t;_.prototype.FV=Math.pow(2,52),_.prototype.F1=52-t,_.prototype.F2=2*t-52;for(var n="0123456789abcdefghijklmnopqrstuvwxyz",o=new Array,r="0".charCodeAt(0),s=0;s<=9;++s)o[r++]=s;for(r="a".charCodeAt(0),s=10;s<36;++s)o[r++]=s;for(r="A".charCodeAt(0),s=10;s<36;++s)o[r++]=s;function a(e){return n.charAt(e)}function p(e,t){e=o[e.charCodeAt(t)];return null==e?-1:e}function g(e){var t=C();return t.fromInt(e),t}function P(e){var t,i=1;return 0!=(t=e>>>16)&&(e=t,i+=16),0!=(t=e>>8)&&(e=t,i+=8),0!=(t=e>>4)&&(e=t,i+=4),0!=(t=e>>2)&&(e=t,i+=2),0!=(t=e>>1)&&(e=t,i+=1),i}function y(e){this.m=e}function v(e){this.m=e,this.mp=e.invDigit(),this.mpl=32767&this.mp,this.mph=this.mp>>15,this.um=(1<<e.DB-15)-1,this.mt2=2*e.t}function l(e,t){return e&t}function h(e,t){return e|t}function d(e,t){return e^t}function c(e,t){return e&~t}function u(){}function f(e){return e}function x(e){this.r2=C(),this.q3=C(),_.ONE.dlShiftTo(2*e.t,this.r2),this.mu=this.r2.divide(e),this.m=e}y.prototype.convert=function(e){return e.s<0||0<=e.compareTo(this.m)?e.mod(this.m):e},y.prototype.revert=function(e){return e},y.prototype.reduce=function(e){e.divRemTo(this.m,null,e)},y.prototype.mulTo=function(e,t,i){e.multiplyTo(t,i),this.reduce(i)},y.prototype.sqrTo=function(e,t){e.squareTo(t),this.reduce(t)},v.prototype.convert=function(e){var t=C();return e.abs().dlShiftTo(this.m.t,t),t.divRemTo(this.m,null,t),e.s<0&&0<t.compareTo(_.ZERO)&&this.m.subTo(t,t),t},v.prototype.revert=function(e){var t=C();return e.copyTo(t),this.reduce(t),t},v.prototype.reduce=function(e){for(;e.t<=this.mt2;)e[e.t++]=0;for(var t=0;t<this.m.t;++t){var i=32767&e[t],n=i*this.mpl+((i*this.mph+(e[t]>>15)*this.mpl&this.um)<<15)&e.DM;for(e[i=t+this.m.t]+=this.m.am(0,n,e,t,0,this.m.t);e[i]>=e.DV;)e[i]-=e.DV,e[++i]++}e.clamp(),e.drShiftTo(this.m.t,e),0<=e.compareTo(this.m)&&e.subTo(this.m,e)},v.prototype.mulTo=function(e,t,i){e.multiplyTo(t,i),this.reduce(i)},v.prototype.sqrTo=function(e,t){e.squareTo(t),this.reduce(t)},_.prototype.copyTo=function(e){for(var t=this.t-1;0<=t;--t)e[t]=this[t];e.t=this.t,e.s=this.s},_.prototype.fromInt=function(e){this.t=1,this.s=e<0?-1:0,0<e?this[0]=e:e<-1?this[0]=e+this.DV:this.t=0},_.prototype.fromString=function(e,t){var i;if(16==t)i=4;else if(8==t)i=3;else if(256==t)i=8;else if(2==t)i=1;else if(32==t)i=5;else{if(4!=t)return void this.fromRadix(e,t);i=2}this.t=0,this.s=0;for(var n=e.length,o=!1,r=0;0<=--n;){var s=8==i?255&e[n]:p(e,n);s<0?"-"==e.charAt(n)&&(o=!0):(o=!1,0==r?this[this.t++]=s:r+i>this.DB?(this[this.t-1]|=(s&(1<<this.DB-r)-1)<<r,this[this.t++]=s>>this.DB-r):this[this.t-1]|=s<<r,(r+=i)>=this.DB&&(r-=this.DB))}8==i&&0!=(128&e[0])&&(this.s=-1,0<r)&&(this[this.t-1]|=(1<<this.DB-r)-1<<r),this.clamp(),o&&_.ZERO.subTo(this,this)},_.prototype.clamp=function(){for(var e=this.s&this.DM;0<this.t&&this[this.t-1]==e;)--this.t},_.prototype.dlShiftTo=function(e,t){for(var i=this.t-1;0<=i;--i)t[i+e]=this[i];for(i=e-1;0<=i;--i)t[i]=0;t.t=this.t+e,t.s=this.s},_.prototype.drShiftTo=function(e,t){for(var i=e;i<this.t;++i)t[i-e]=this[i];t.t=Math.max(this.t-e,0),t.s=this.s},_.prototype.lShiftTo=function(e,t){for(var i=e%this.DB,n=this.DB-i,o=(1<<n)-1,r=Math.floor(e/this.DB),s=this.s<<i&this.DM,l=this.t-1;0<=l;--l)t[l+r+1]=this[l]>>n|s,s=(this[l]&o)<<i;for(l=r-1;0<=l;--l)t[l]=0;t[r]=s,t.t=this.t+r+1,t.s=this.s,t.clamp()},_.prototype.rShiftTo=function(e,t){t.s=this.s;var i=Math.floor(e/this.DB);if(i>=this.t)t.t=0;else{var n=e%this.DB,o=this.DB-n,r=(1<<n)-1;t[0]=this[i]>>n;for(var s=i+1;s<this.t;++s)t[s-i-1]|=(this[s]&r)<<o,t[s-i]=this[s]>>n;0<n&&(t[this.t-i-1]|=(this.s&r)<<o),t.t=this.t-i,t.clamp()}},_.prototype.subTo=function(e,t){for(var i=0,n=0,o=Math.min(e.t,this.t);i<o;)n+=this[i]-e[i],t[i++]=n&this.DM,n>>=this.DB;if(e.t<this.t){for(n-=e.s;i<this.t;)n+=this[i],t[i++]=n&this.DM,n>>=this.DB;n+=this.s}else{for(n+=this.s;i<e.t;)n-=e[i],t[i++]=n&this.DM,n>>=this.DB;n-=e.s}t.s=n<0?-1:0,n<-1?t[i++]=this.DV+n:0<n&&(t[i++]=n),t.t=i,t.clamp()},_.prototype.multiplyTo=function(e,t){var i=this.abs(),n=e.abs(),o=i.t;for(t.t=o+n.t;0<=--o;)t[o]=0;for(o=0;o<n.t;++o)t[o+i.t]=i.am(0,n[o],t,o,0,i.t);t.s=0,t.clamp(),this.s!=e.s&&_.ZERO.subTo(t,t)},_.prototype.squareTo=function(e){for(var t=this.abs(),i=e.t=2*t.t;0<=--i;)e[i]=0;for(i=0;i<t.t-1;++i){var n=t.am(i,t[i],e,2*i,0,1);(e[i+t.t]+=t.am(i+1,2*t[i],e,2*i+1,n,t.t-i-1))>=t.DV&&(e[i+t.t]-=t.DV,e[i+t.t+1]=1)}0<e.t&&(e[e.t-1]+=t.am(i,t[i],e,2*i,0,1)),e.s=0,e.clamp()},_.prototype.divRemTo=function(e,t,i){var n=e.abs();if(!(n.t<=0)){var o=this.abs();if(o.t<n.t)null!=t&&t.fromInt(0),null!=i&&this.copyTo(i);else{null==i&&(i=C());var r=C(),s=this.s,e=e.s,l=this.DB-P(n[n.t-1]),a=(0<l?(n.lShiftTo(l,r),o.lShiftTo(l,i)):(n.copyTo(r),o.copyTo(i)),r.t),p=r[a-1];if(0!=p){var n=p*(1<<this.F1)+(1<a?r[a-2]>>this.F2:0),h=this.FV/n,d=(1<<this.F1)/n,c=1<<this.F2,u=i.t,f=u-a,m=null==t?C():t;for(r.dlShiftTo(f,m),0<=i.compareTo(m)&&(i[i.t++]=1,i.subTo(m,i)),_.ONE.dlShiftTo(a,m),m.subTo(r,r);r.t<a;)r[r.t++]=0;for(;0<=--f;){var g=i[--u]==p?this.DM:Math.floor(i[u]*h+(i[u-1]+c)*d);if((i[u]+=r.am(0,g,i,f,0,a))<g)for(r.dlShiftTo(f,m),i.subTo(m,i);i[u]<--g;)i.subTo(m,i)}null!=t&&(i.drShiftTo(a,t),s!=e)&&_.ZERO.subTo(t,t),i.t=a,i.clamp(),0<l&&i.rShiftTo(l,i),s<0&&_.ZERO.subTo(i,i)}}}},_.prototype.invDigit=function(){var e,t;return this.t<1||0==(1&(e=this[0]))?0:0<(t=(t=(t=(t=(t=3&e)*(2-(15&e)*t)&15)*(2-(255&e)*t)&255)*(2-((65535&e)*t&65535))&65535)*(2-e*t%this.DV)%this.DV)?this.DV-t:-t},_.prototype.isEven=function(){return 0==(0<this.t?1&this[0]:this.s)},_.prototype.exp=function(e,t){if(4294967295<e||e<1)return _.ONE;var i,n=C(),o=C(),r=t.convert(this),s=P(e)-1;for(r.copyTo(n);0<=--s;)t.sqrTo(n,o),0<(e&1<<s)?t.mulTo(o,r,n):(i=n,n=o,o=i);return t.revert(n)},_.prototype.toString=function(e){if(this.s<0)return"-"+this.negate().toString(e);var t;if(16==e)t=4;else if(8==e)t=3;else if(2==e)t=1;else if(32==e)t=5;else{if(4!=e)return this.toRadix(e);t=2}var i,n=(1<<t)-1,o=!1,r="",s=this.t,l=this.DB-s*this.DB%t;if(0<s--)for(l<this.DB&&0<(i=this[s]>>l)&&(o=!0,r=a(i));0<=s;)l<t?(i=(this[s]&(1<<l)-1)<<t-l,i|=this[--s]>>(l+=this.DB-t)):(i=this[s]>>(l-=t)&n,l<=0&&(l+=this.DB,--s)),(o=0<i?!0:o)&&(r+=a(i));return o?r:"0"},_.prototype.negate=function(){var e=C();return _.ZERO.subTo(this,e),e},_.prototype.abs=function(){return this.s<0?this.negate():this},_.prototype.compareTo=function(e){var t=this.s-e.s;if(0!=t)return t;var i=this.t;if(0!=(t=i-e.t))return this.s<0?-t:t;for(;0<=--i;)if(0!=(t=this[i]-e[i]))return t;return 0},_.prototype.bitLength=function(){return this.t<=0?0:this.DB*(this.t-1)+P(this[this.t-1]^this.s&this.DM)},_.prototype.mod=function(e){var t=C();return this.abs().divRemTo(e,null,t),this.s<0&&0<t.compareTo(_.ZERO)&&e.subTo(t,t),t},_.prototype.modPowInt=function(e,t){return t=new(e<256||t.isEven()?y:v)(t),this.exp(e,t)},_.ZERO=g(0),_.ONE=g(1),u.prototype.convert=f,u.prototype.revert=f,u.prototype.mulTo=function(e,t,i){e.multiplyTo(t,i)},u.prototype.sqrTo=function(e,t){e.squareTo(t)},x.prototype.convert=function(e){var t;return e.s<0||e.t>2*this.m.t?e.mod(this.m):e.compareTo(this.m)<0?e:(t=C(),e.copyTo(t),this.reduce(t),t)},x.prototype.revert=function(e){return e},x.prototype.reduce=function(e){for(e.drShiftTo(this.m.t-1,this.r2),e.t>this.m.t+1&&(e.t=this.m.t+1,e.clamp()),this.mu.multiplyUpperTo(this.r2,this.m.t+1,this.q3),this.m.multiplyLowerTo(this.q3,this.m.t+1,this.r2);e.compareTo(this.r2)<0;)e.dAddOffset(1,this.m.t+1);for(e.subTo(this.r2,e);0<=e.compareTo(this.m);)e.subTo(this.m,e)},x.prototype.mulTo=function(e,t,i){e.multiplyTo(t,i),this.reduce(i)},x.prototype.sqrTo=function(e,t){e.squareTo(t),this.reduce(t)};var m=[2,3,5,7,11,13,17,19,23,29,31,37,41,43,47,53,59,61,67,71,73,79,83,89,97,101,103,107,109,113,127,131,137,139,149,151,157,163,167,173,179,181,191,193,197,199,211,223,227,229,233,239,241,251,257,263,269,271,277,281,283,293,307,311,313,317,331,337,347,349,353,359,367,373,379,383,389,397,401,409,419,421,431,433,439,443,449,457,461,463,467,479,487,491,499,503,509,521,523,541,547,557,563,569,571,577,587,593,599,601,607,613,617,619,631,641,643,647,653,659,661,673,677,683,691,701,709,719,727,733,739,743,751,757,761,769,773,787,797,809,811,821,823,827,829,839,853,857,859,863,877,881,883,887,907,911,919,929,937,941,947,953,967,971,977,983,991,997],T=(1<<26)/m[m.length-1];_.prototype.chunkSize=function(e){return Math.floor(Math.LN2*this.DB/Math.log(e))},_.prototype.toRadix=function(e){if(null==e&&(e=10),0==this.signum()||e<2||36<e)return"0";var t=this.chunkSize(e),i=Math.pow(e,t),n=g(i),o=C(),r=C(),s="";for(this.divRemTo(n,o,r);0<o.signum();)s=(i+r.intValue()).toString(e).substr(1)+s,o.divRemTo(n,o,r);return r.intValue().toString(e)+s},_.prototype.fromRadix=function(e,t){this.fromInt(0);for(var i=this.chunkSize(t=null==t?10:t),n=Math.pow(t,i),o=!1,r=0,s=0,l=0;l<e.length;++l){var a=p(e,l);a<0?"-"==e.charAt(l)&&0==this.signum()&&(o=!0):(s=t*s+a,++r>=i&&(this.dMultiply(n),this.dAddOffset(s,0),s=r=0))}0<r&&(this.dMultiply(Math.pow(t,r)),this.dAddOffset(s,0)),o&&_.ZERO.subTo(this,this)},_.prototype.fromNumber=function(e,t,i){if("number"==typeof t)if(e<2)this.fromInt(1);else for(this.fromNumber(e,i),this.testBit(e-1)||this.bitwiseTo(_.ONE.shiftLeft(e-1),h,this),this.isEven()&&this.dAddOffset(1,0);!this.isProbablePrime(t);)this.dAddOffset(2,0),this.bitLength()>e&&this.subTo(_.ONE.shiftLeft(e-1),this);else{var i=new Array,n=7&e;i.length=1+(e>>3),t.nextBytes(i),0<n?i[0]&=(1<<n)-1:i[0]=0,this.fromString(i,256)}},_.prototype.bitwiseTo=function(e,t,i){for(var n,o=Math.min(e.t,this.t),r=0;r<o;++r)i[r]=t(this[r],e[r]);if(e.t<this.t){for(n=e.s&this.DM,r=o;r<this.t;++r)i[r]=t(this[r],n);i.t=this.t}else{for(n=this.s&this.DM,r=o;r<e.t;++r)i[r]=t(n,e[r]);i.t=e.t}i.s=t(this.s,e.s),i.clamp()},_.prototype.changeBit=function(e,t){return e=_.ONE.shiftLeft(e),this.bitwiseTo(e,t,e),e},_.prototype.addTo=function(e,t){for(var i=0,n=0,o=Math.min(e.t,this.t);i<o;)n+=this[i]+e[i],t[i++]=n&this.DM,n>>=this.DB;if(e.t<this.t){for(n+=e.s;i<this.t;)n+=this[i],t[i++]=n&this.DM,n>>=this.DB;n+=this.s}else{for(n+=this.s;i<e.t;)n+=e[i],t[i++]=n&this.DM,n>>=this.DB;n+=e.s}t.s=n<0?-1:0,0<n?t[i++]=n:n<-1&&(t[i++]=this.DV+n),t.t=i,t.clamp()},_.prototype.dMultiply=function(e){this[this.t]=this.am(0,e-1,this,0,0,this.t),++this.t,this.clamp()},_.prototype.dAddOffset=function(e,t){if(0!=e){for(;this.t<=t;)this[this.t++]=0;for(this[t]+=e;this[t]>=this.DV;)this[t]-=this.DV,++t>=this.t&&(this[this.t++]=0),++this[t]}},_.prototype.multiplyLowerTo=function(e,t,i){var n,o=Math.min(this.t+e.t,t);for(i.s=0,i.t=o;0<o;)i[--o]=0;for(n=i.t-this.t;o<n;++o)i[o+this.t]=this.am(0,e[o],i,o,0,this.t);for(n=Math.min(e.t,t);o<n;++o)this.am(0,e[o],i,o,0,t-o);i.clamp()},_.prototype.multiplyUpperTo=function(e,t,i){var n=i.t=this.t+e.t- --t;for(i.s=0;0<=--n;)i[n]=0;for(n=Math.max(t-this.t,0);n<e.t;++n)i[this.t+n-t]=this.am(t-n,e[n],i,0,0,this.t+n-t);i.clamp(),i.drShiftTo(1,i)},_.prototype.modInt=function(e){if(e<=0)return 0;var t=this.DV%e,i=this.s<0?e-1:0;if(0<this.t)if(0==t)i=this[0]%e;else for(var n=this.t-1;0<=n;--n)i=(t*i+this[n])%e;return i},_.prototype.millerRabin=function(e){var t=this.subtract(_.ONE),i=t.getLowestSetBit();if(i<=0)return!1;for(var n=t.shiftRight(i),o=(m.length<(e=e+1>>1)&&(e=m.length),C()),r=0;r<e;++r){o.fromInt(m[Math.floor(Math.random()*m.length)]);var s=o.modPow(n,this);if(0!=s.compareTo(_.ONE)&&0!=s.compareTo(t)){for(var l=1;l++<i&&0!=s.compareTo(t);)if(0==(s=s.modPowInt(2,this)).compareTo(_.ONE))return!1;if(0!=s.compareTo(t))return!1}}return!0},_.prototype.clone=function(){var e=C();return this.copyTo(e),e},_.prototype.intValue=function(){if(this.s<0){if(1==this.t)return this[0]-this.DV;if(0==this.t)return-1}else{if(1==this.t)return this[0];if(0==this.t)return 0}return(this[1]&(1<<32-this.DB)-1)<<this.DB|this[0]},_.prototype.byteValue=function(){return 0==this.t?this.s:this[0]<<24>>24},_.prototype.shortValue=function(){return 0==this.t?this.s:this[0]<<16>>16},_.prototype.signum=function(){return this.s<0?-1:this.t<=0||1==this.t&&this[0]<=0?0:1},_.prototype.toByteArray=function(){var e,t=this.t,i=new Array,n=(i[0]=this.s,this.DB-t*this.DB%8),o=0;if(0<t--)for(n<this.DB&&(e=this[t]>>n)!=(this.s&this.DM)>>n&&(i[o++]=e|this.s<<this.DB-n);0<=t;)n<8?(e=(this[t]&(1<<n)-1)<<8-n,e|=this[--t]>>(n+=this.DB-8)):(e=this[t]>>(n-=8)&255,n<=0&&(n+=this.DB,--t)),0!=(128&e)&&(e|=-256),0==o&&(128&this.s)!=(128&e)&&++o,(0<o||e!=this.s)&&(i[o++]=e);return i},_.prototype.equals=function(e){return 0==this.compareTo(e)},_.prototype.min=function(e){return this.compareTo(e)<0?this:e},_.prototype.max=function(e){return 0<this.compareTo(e)?this:e},_.prototype.and=function(e){var t=C();return this.bitwiseTo(e,l,t),t},_.prototype.or=function(e){var t=C();return this.bitwiseTo(e,h,t),t},_.prototype.xor=function(e){var t=C();return this.bitwiseTo(e,d,t),t},_.prototype.andNot=function(e){var t=C();return this.bitwiseTo(e,c,t),t},_.prototype.not=function(){for(var e=C(),t=0;t<this.t;++t)e[t]=this.DM&~this[t];return e.t=this.t,e.s=~this.s,e},_.prototype.shiftLeft=function(e){var t=C();return e<0?this.rShiftTo(-e,t):this.lShiftTo(e,t),t},_.prototype.shiftRight=function(e){var t=C();return e<0?this.lShiftTo(-e,t):this.rShiftTo(e,t),t},_.prototype.getLowestSetBit=function(){for(var e,t,i=0;i<this.t;++i)if(0!=this[i])return i*this.DB+(e=this[i],t=void 0,0==e?-1:((t=0)==(65535&e)&&(e>>=16,t+=16),0==(255&e)&&(e>>=8,t+=8),0==(15&e)&&(e>>=4,t+=4),0==(3&e)&&(e>>=2,t+=2),0==(1&e)&&++t,t));return this.s<0?this.t*this.DB:-1},_.prototype.bitCount=function(){for(var e=0,t=this.s&this.DM,i=0;i<this.t;++i)e+=function(e){for(var t=0;0!=e;)e&=e-1,++t;return t}(this[i]^t);return e},_.prototype.testBit=function(e){var t=Math.floor(e/this.DB);return t>=this.t?0!=this.s:0!=(this[t]&1<<e%this.DB)},_.prototype.setBit=function(e){return this.changeBit(e,h)},_.prototype.clearBit=function(e){return this.changeBit(e,c)},_.prototype.flipBit=function(e){return this.changeBit(e,d)},_.prototype.add=function(e){var t=C();return this.addTo(e,t),t},_.prototype.subtract=function(e){var t=C();return this.subTo(e,t),t},_.prototype.multiply=function(e){var t=C();return this.multiplyTo(e,t),t},_.prototype.divide=function(e){var t=C();return this.divRemTo(e,t,null),t},_.prototype.remainder=function(e){var t=C();return this.divRemTo(e,null,t),t},_.prototype.divideAndRemainder=function(e){var t=C(),i=C();return this.divRemTo(e,t,i),new Array(t,i)},_.prototype.modPow=function(e,t){var i=e.bitLength(),n=g(1);if(i<=0)return n;var o=i<18?1:i<48?3:i<144?4:i<768?5:6,r=new(i<8?y:t.isEven()?x:v)(t),s=new Array,l=3,a=o-1,p=(1<<o)-1;if(s[1]=r.convert(this),1<o){var h=C();for(r.sqrTo(s[1],h);l<=p;)s[l]=C(),r.mulTo(h,s[l-2],s[l]),l+=2}for(var d,c,u=e.t-1,f=!0,m=C(),i=P(e[u])-1;0<=u;){for(a<=i?d=e[u]>>i-a&p:(d=(e[u]&(1<<i+1)-1)<<a-i,0<u&&(d|=e[u-1]>>this.DB+i-a)),l=o;0==(1&d);)d>>=1,--l;if((i-=l)<0&&(i+=this.DB,--u),f)s[d].copyTo(n),f=!1;else{for(;1<l;)r.sqrTo(n,m),r.sqrTo(m,n),l-=2;0<l?r.sqrTo(n,m):(c=n,n=m,m=c),r.mulTo(m,s[d],n)}for(;0<=u&&0==(e[u]&1<<i);)r.sqrTo(n,m),c=n,n=m,m=c,--i<0&&(i=this.DB-1,--u)}return r.revert(n)},_.prototype.modInverse=function(e){var t=e.isEven();if(this.isEven()&&t||0==e.signum())return _.ZERO;for(var i=e.clone(),n=this.clone(),o=g(1),r=g(0),s=g(0),l=g(1);0!=i.signum();){for(;i.isEven();)i.rShiftTo(1,i),t?(o.isEven()&&r.isEven()||(o.addTo(this,o),r.subTo(e,r)),o.rShiftTo(1,o)):r.isEven()||r.subTo(e,r),r.rShiftTo(1,r);for(;n.isEven();)n.rShiftTo(1,n),t?(s.isEven()&&l.isEven()||(s.addTo(this,s),l.subTo(e,l)),s.rShiftTo(1,s)):l.isEven()||l.subTo(e,l),l.rShiftTo(1,l);0<=i.compareTo(n)?(i.subTo(n,i),t&&o.subTo(s,o),r.subTo(l,r)):(n.subTo(i,n),t&&s.subTo(o,s),l.subTo(r,l))}return 0!=n.compareTo(_.ONE)?_.ZERO:0<=l.compareTo(e)?l.subtract(e):l.signum()<0&&(l.addTo(e,l),l.signum()<0)?l.add(e):l},_.prototype.pow=function(e){return this.exp(e,new u)},_.prototype.gcd=function(e){var t=this.s<0?this.negate():this.clone(),i=e.s<0?e.negate():e.clone(),n=(t.compareTo(i)<0&&(e=t,t=i,i=e),t.getLowestSetBit());if((e=i.getLowestSetBit())<0)return t;for(0<(e=n<e?n:e)&&(t.rShiftTo(e,t),i.rShiftTo(e,i));0<t.signum();)0<(n=t.getLowestSetBit())&&t.rShiftTo(n,t),0<(n=i.getLowestSetBit())&&i.rShiftTo(n,i),0<=t.compareTo(i)?(t.subTo(i,t),t.rShiftTo(1,t)):(i.subTo(t,i),i.rShiftTo(1,i));return 0<e&&i.lShiftTo(e,i),i},_.prototype.isProbablePrime=function(e){var t,i=this.abs();if(1==i.t&&i[0]<=m[m.length-1]){for(t=0;t<m.length;++t)if(i[0]==m[t])return!0;return!1}if(i.isEven())return!1;for(t=1;t<m.length;){for(var n=m[t],o=t+1;o<m.length&&n<T;)n*=m[o++];for(n=i.modInt(n);t<o;)if(n%m[t++]==0)return!1}return i.millerRabin(e)},_.prototype.square=function(){var e=C();return this.squareTo(e),e};function S(e,t){if(void 0===Object.getOwnPropertyNames)for(var i in t.prototype)void 0!==e.prototype[i]&&e.prototype[i]!==Object.prototype[i]||(e.prototype[i]=t.prototype[i]);else for(var n=Object.getOwnPropertyNames(t.prototype),o=0;o<n.length;o++)void 0===Object.getOwnPropertyDescriptor(e.prototype,n[o])&&Object.defineProperty(e.prototype,n[o],Object.getOwnPropertyDescriptor(t.prototype,n[o]));for(i in t)void 0===e[i]&&(e[i]=t[i]);e.$baseCtor=t}var M=_;M.prototype.IsNegative=function(){return-1==this.compareTo(M.ZERO)},M.op_Equality=function(e,t){return 0==e.compareTo(t)},M.op_Inequality=function(e,t){return 0!=e.compareTo(t)},M.op_GreaterThan=function(e,t){return 0<e.compareTo(t)},M.op_LessThan=function(e,t){return e.compareTo(t)<0},M.op_Addition=function(e,t){return new M(e,void 0,void 0).add(new M(t,void 0,void 0))},M.op_Subtraction=function(e,t){return new M(e,void 0,void 0).subtract(new M(t,void 0,void 0))},M.Int128Mul=function(e,t){return new M(e,void 0,void 0).multiply(new M(t,void 0,void 0))},M.op_Division=function(e,t){return e.divide(t)},M.prototype.ToDouble=function(){return parseFloat(this.toString())},E.Path=function(){return[]},E.Path.prototype.push=Array.prototype.push,E.Paths=function(){return[]},E.Paths.prototype.push=Array.prototype.push,E.DoublePoint=function(){var e=arguments;this.X=0,this.Y=0,1===e.length?(this.X=e[0].X,this.Y=e[0].Y):2===e.length&&(this.X=e[0],this.Y=e[1])},E.DoublePoint0=function(){this.X=0,this.Y=0},E.DoublePoint0.prototype=E.DoublePoint.prototype,E.DoublePoint1=function(e){this.X=e.X,this.Y=e.Y},E.DoublePoint1.prototype=E.DoublePoint.prototype,E.DoublePoint2=function(e,t){this.X=e,this.Y=t},E.DoublePoint2.prototype=E.DoublePoint.prototype,E.PolyNode=function(){this.m_Parent=null,this.m_polygon=new E.Path,this.m_Index=0,this.m_jointype=0,this.m_endtype=0,this.m_Childs=[],this.IsOpen=!1},E.PolyNode.prototype.IsHoleNode=function(){for(var e=!0,t=this.m_Parent;null!==t;)e=!e,t=t.m_Parent;return e},E.PolyNode.prototype.ChildCount=function(){return this.m_Childs.length},E.PolyNode.prototype.Contour=function(){return this.m_polygon},E.PolyNode.prototype.AddChild=function(e){var t=this.m_Childs.length;this.m_Childs.push(e),e.m_Parent=this,e.m_Index=t},E.PolyNode.prototype.GetNext=function(){return 0<this.m_Childs.length?this.m_Childs[0]:this.GetNextSiblingUp()},E.PolyNode.prototype.GetNextSiblingUp=function(){return null===this.m_Parent?null:this.m_Index===this.m_Parent.m_Childs.length-1?this.m_Parent.GetNextSiblingUp():this.m_Parent.m_Childs[this.m_Index+1]},E.PolyNode.prototype.Childs=function(){return this.m_Childs},E.PolyNode.prototype.Parent=function(){return this.m_Parent},E.PolyNode.prototype.IsHole=function(){return this.IsHoleNode()},E.PolyTree=function(){this.m_AllPolys=[],E.PolyNode.call(this)},E.PolyTree.prototype.Clear=function(){for(var e=0,t=this.m_AllPolys.length;e<t;e++)this.m_AllPolys[e]=null;this.m_AllPolys.length=0,this.m_Childs.length=0},E.PolyTree.prototype.GetFirst=function(){return 0<this.m_Childs.length?this.m_Childs[0]:null},E.PolyTree.prototype.Total=function(){var e=this.m_AllPolys.length;return 0<e&&this.m_Childs[0]!==this.m_AllPolys[0]&&e--,e},S(E.PolyTree,E.PolyNode),E.Math_Abs_Int64=E.Math_Abs_Int32=E.Math_Abs_Double=function(e){return Math.abs(e)},E.Math_Max_Int32_Int32=function(e,t){return Math.max(e,t)},E.Cast_Int32=i.msie||i.opera||i.safari?function(e){return 0|e}:function(e){return~~e},void 0===Number.toInteger&&(Number.toInteger=null),i.chrome?E.Cast_Int64=function(e){return e<-2147483648||2147483647<e?e<0?Math.ceil(e):Math.floor(e):~~e}:i.firefox&&"function"==typeof Number.toInteger?E.Cast_Int64=function(e){return Number.toInteger(e)}:E.Cast_Int64=i.msie7||i.msie8?function(e){return parseInt(e,10)}:i.msie?function(e){return e<-2147483648||2147483647<e?e<0?Math.ceil(e):Math.floor(e):0|e}:function(e){return e<0?Math.ceil(e):Math.floor(e)},E.Clear=function(e){e.length=0},E.PI=3.141592653589793,E.PI2=6.283185307179586,E.IntPoint=function(){var e,t,i=arguments,n=i.length;this.X=0,this.Y=0,E.use_xyz?(this.Z=0,3===n?(this.X=i[0],this.Y=i[1],this.Z=i[2]):2===n?(this.X=i[0],this.Y=i[1],this.Z=0):1===n?i[0]instanceof E.DoublePoint?(this.X=E.Clipper.Round((e=i[0]).X),this.Y=E.Clipper.Round(e.Y),this.Z=0):(void 0===(t=i[0]).Z&&(t.Z=0),this.X=t.X,this.Y=t.Y,this.Z=t.Z):(this.X=0,this.Y=0,this.Z=0)):2===n?(this.X=i[0],this.Y=i[1]):1===n?i[0]instanceof E.DoublePoint?(this.X=E.Clipper.Round((e=i[0]).X),this.Y=E.Clipper.Round(e.Y)):(this.X=(t=i[0]).X,this.Y=t.Y):(this.X=0,this.Y=0)},E.IntPoint.op_Equality=function(e,t){return e.X===t.X&&e.Y===t.Y},E.IntPoint.op_Inequality=function(e,t){return e.X!==t.X||e.Y!==t.Y},E.IntPoint0=function(){this.X=0,this.Y=0,E.use_xyz&&(this.Z=0)},E.IntPoint0.prototype=E.IntPoint.prototype,E.IntPoint1=function(e){this.X=e.X,this.Y=e.Y,E.use_xyz&&(void 0===e.Z?this.Z=0:this.Z=e.Z)},E.IntPoint1.prototype=E.IntPoint.prototype,E.IntPoint1dp=function(e){this.X=E.Clipper.Round(e.X),this.Y=E.Clipper.Round(e.Y),E.use_xyz&&(this.Z=0)},E.IntPoint1dp.prototype=E.IntPoint.prototype,E.IntPoint2=function(e,t,i){this.X=e,this.Y=t,E.use_xyz&&(this.Z=void 0===i?0:i)},E.IntPoint2.prototype=E.IntPoint.prototype,E.IntRect=function(){var e=arguments,t=e.length;4===t?(this.left=e[0],this.top=e[1],this.right=e[2],this.bottom=e[3]):1===t?(this.left=(t=e[0]).left,this.top=t.top,this.right=t.right,this.bottom=t.bottom):(this.left=0,this.top=0,this.right=0,this.bottom=0)},E.IntRect0=function(){this.left=0,this.top=0,this.right=0,this.bottom=0},E.IntRect0.prototype=E.IntRect.prototype,E.IntRect1=function(e){this.left=e.left,this.top=e.top,this.right=e.right,this.bottom=e.bottom},E.IntRect1.prototype=E.IntRect.prototype,E.IntRect4=function(e,t,i,n){this.left=e,this.top=t,this.right=i,this.bottom=n},E.IntRect4.prototype=E.IntRect.prototype,E.ClipType={ctIntersection:0,ctUnion:1,ctDifference:2,ctXor:3},E.PolyType={ptSubject:0,ptClip:1},E.PolyFillType={pftEvenOdd:0,pftNonZero:1,pftPositive:2,pftNegative:3},E.JoinType={jtSquare:0,jtRound:1,jtMiter:2},E.EndType={etOpenSquare:0,etOpenRound:1,etOpenButt:2,etClosedLine:3,etClosedPolygon:4},E.EdgeSide={esLeft:0,esRight:1},E.Direction={dRightToLeft:0,dLeftToRight:1},E.TEdge=function(){this.Bot=new E.IntPoint0,this.Curr=new E.IntPoint0,this.Top=new E.IntPoint0,this.Delta=new E.IntPoint0,this.Dx=0,this.PolyTyp=E.PolyType.ptSubject,this.Side=E.EdgeSide.esLeft,this.WindDelta=0,this.WindCnt=0,this.WindCnt2=0,this.OutIdx=0,this.Next=null,this.Prev=null,this.NextInLML=null,this.NextInAEL=null,this.PrevInAEL=null,this.NextInSEL=null,this.PrevInSEL=null},E.IntersectNode=function(){this.Edge1=null,this.Edge2=null,this.Pt=new E.IntPoint0},E.MyIntersectNodeSort=function(){},E.MyIntersectNodeSort.Compare=function(e,t){t=t.Pt.Y-e.Pt.Y;return 0<t?1:t<0?-1:0},E.LocalMinima=function(){this.Y=0,this.LeftBound=null,this.RightBound=null,this.Next=null},E.Scanbeam=function(){this.Y=0,this.Next=null},E.Maxima=function(){this.X=0,this.Next=null,this.Prev=null},E.OutRec=function(){this.Idx=0,this.IsHole=!1,this.IsOpen=!1,this.FirstLeft=null,this.Pts=null,this.BottomPt=null,this.PolyNode=null},E.OutPt=function(){this.Idx=0,this.Pt=new E.IntPoint0,this.Next=null,this.Prev=null},E.Join=function(){this.OutPt1=null,this.OutPt2=null,this.OffPt=new E.IntPoint0},E.ClipperBase=function(){this.m_MinimaList=null,this.m_CurrentLM=null,this.m_edges=new Array,this.m_UseFullRange=!1,this.m_HasOpenPaths=!1,this.PreserveCollinear=!1,this.m_Scanbeam=null,this.m_PolyOuts=null,this.m_ActiveEdges=null},E.ClipperBase.horizontal=-9007199254740992,E.ClipperBase.Skip=-2,E.ClipperBase.Unassigned=-1,E.ClipperBase.tolerance=1e-20,E.ClipperBase.loRange=47453132,E.ClipperBase.hiRange=0xfffffffffffff,E.ClipperBase.near_zero=function(e){return e>-E.ClipperBase.tolerance&&e<E.ClipperBase.tolerance},E.ClipperBase.IsHorizontal=function(e){return 0===e.Delta.Y},E.ClipperBase.prototype.PointIsVertex=function(e,t){var i=t;do{if(E.IntPoint.op_Equality(i.Pt,e))return!0}while((i=i.Next)!==t);return!1},E.ClipperBase.prototype.PointOnLineSegment=function(e,t,i,n){return n?e.X===t.X&&e.Y===t.Y||e.X===i.X&&e.Y===i.Y||e.X>t.X==e.X<i.X&&e.Y>t.Y==e.Y<i.Y&&M.op_Equality(M.Int128Mul(e.X-t.X,i.Y-t.Y),M.Int128Mul(i.X-t.X,e.Y-t.Y)):e.X===t.X&&e.Y===t.Y||e.X===i.X&&e.Y===i.Y||e.X>t.X==e.X<i.X&&e.Y>t.Y==e.Y<i.Y&&(e.X-t.X)*(i.Y-t.Y)==(i.X-t.X)*(e.Y-t.Y)},E.ClipperBase.prototype.PointOnPolygon=function(e,t,i){for(var n=t;;){if(this.PointOnLineSegment(e,n.Pt,n.Next.Pt,i))return!0;if((n=n.Next)===t)break}return!1},E.ClipperBase.prototype.SlopesEqual=E.ClipperBase.SlopesEqual=function(){var e,t,i,n,o,r=arguments,s=r.length;return 3===s?(o=r[0],e=r[1],r[2]?M.op_Equality(M.Int128Mul(o.Delta.Y,e.Delta.X),M.Int128Mul(o.Delta.X,e.Delta.Y)):E.Cast_Int64(o.Delta.Y*e.Delta.X)===E.Cast_Int64(o.Delta.X*e.Delta.Y)):4===s?(t=r[0],i=r[1],n=r[2],r[3]?M.op_Equality(M.Int128Mul(t.Y-i.Y,i.X-n.X),M.Int128Mul(t.X-i.X,i.Y-n.Y)):E.Cast_Int64((t.Y-i.Y)*(i.X-n.X))-E.Cast_Int64((t.X-i.X)*(i.Y-n.Y))==0):(t=r[0],i=r[1],n=r[2],o=r[3],r[4]?M.op_Equality(M.Int128Mul(t.Y-i.Y,n.X-o.X),M.Int128Mul(t.X-i.X,n.Y-o.Y)):E.Cast_Int64((t.Y-i.Y)*(n.X-o.X))-E.Cast_Int64((t.X-i.X)*(n.Y-o.Y))==0)},E.ClipperBase.SlopesEqual3=function(e,t,i){return i?M.op_Equality(M.Int128Mul(e.Delta.Y,t.Delta.X),M.Int128Mul(e.Delta.X,t.Delta.Y)):E.Cast_Int64(e.Delta.Y*t.Delta.X)===E.Cast_Int64(e.Delta.X*t.Delta.Y)},E.ClipperBase.SlopesEqual4=function(e,t,i,n){return n?M.op_Equality(M.Int128Mul(e.Y-t.Y,t.X-i.X),M.Int128Mul(e.X-t.X,t.Y-i.Y)):E.Cast_Int64((e.Y-t.Y)*(t.X-i.X))-E.Cast_Int64((e.X-t.X)*(t.Y-i.Y))==0},E.ClipperBase.SlopesEqual5=function(e,t,i,n,o){return o?M.op_Equality(M.Int128Mul(e.Y-t.Y,i.X-n.X),M.Int128Mul(e.X-t.X,i.Y-n.Y)):E.Cast_Int64((e.Y-t.Y)*(i.X-n.X))-E.Cast_Int64((e.X-t.X)*(i.Y-n.Y))==0},E.ClipperBase.prototype.Clear=function(){this.DisposeLocalMinimaList();for(var e=0,t=this.m_edges.length;e<t;++e){for(var i=0,n=this.m_edges[e].length;i<n;++i)this.m_edges[e][i]=null;E.Clear(this.m_edges[e])}E.Clear(this.m_edges),this.m_UseFullRange=!1,this.m_HasOpenPaths=!1},E.ClipperBase.prototype.DisposeLocalMinimaList=function(){for(;null!==this.m_MinimaList;){var e=this.m_MinimaList.Next;this.m_MinimaList=null,this.m_MinimaList=e}this.m_CurrentLM=null},E.ClipperBase.prototype.RangeTest=function(e,t){t.Value?(e.X>E.ClipperBase.hiRange||e.Y>E.ClipperBase.hiRange||-e.X>E.ClipperBase.hiRange||-e.Y>E.ClipperBase.hiRange)&&E.Error("Coordinate outside allowed range in RangeTest()."):(e.X>E.ClipperBase.loRange||e.Y>E.ClipperBase.loRange||-e.X>E.ClipperBase.loRange||-e.Y>E.ClipperBase.loRange)&&(t.Value=!0,this.RangeTest(e,t))},E.ClipperBase.prototype.InitEdge=function(e,t,i,n){e.Next=t,e.Prev=i,e.Curr.X=n.X,e.Curr.Y=n.Y,E.use_xyz&&(e.Curr.Z=n.Z),e.OutIdx=-1},E.ClipperBase.prototype.InitEdge2=function(e,t){e.Curr.Y>=e.Next.Curr.Y?(e.Bot.X=e.Curr.X,e.Bot.Y=e.Curr.Y,E.use_xyz&&(e.Bot.Z=e.Curr.Z),e.Top.X=e.Next.Curr.X,e.Top.Y=e.Next.Curr.Y,E.use_xyz&&(e.Top.Z=e.Next.Curr.Z)):(e.Top.X=e.Curr.X,e.Top.Y=e.Curr.Y,E.use_xyz&&(e.Top.Z=e.Curr.Z),e.Bot.X=e.Next.Curr.X,e.Bot.Y=e.Next.Curr.Y,E.use_xyz&&(e.Bot.Z=e.Next.Curr.Z)),this.SetDx(e),e.PolyTyp=t},E.ClipperBase.prototype.FindNextLocMin=function(e){for(var t;;){for(;E.IntPoint.op_Inequality(e.Bot,e.Prev.Bot)||E.IntPoint.op_Equality(e.Curr,e.Top);)e=e.Next;if(e.Dx!==E.ClipperBase.horizontal&&e.Prev.Dx!==E.ClipperBase.horizontal)break;for(;e.Prev.Dx===E.ClipperBase.horizontal;)e=e.Prev;for(t=e;e.Dx===E.ClipperBase.horizontal;)e=e.Next;if(e.Top.Y!==e.Prev.Bot.Y){t.Prev.Bot.X<e.Bot.X&&(e=t);break}}return e},E.ClipperBase.prototype.ProcessBound=function(e,t){var i,n,o,r=e;if(r.OutIdx===E.ClipperBase.Skip){if(e=r,t){for(;e.Top.Y===e.Next.Bot.Y;)e=e.Next;for(;e!==r&&e.Dx===E.ClipperBase.horizontal;)e=e.Prev}else{for(;e.Top.Y===e.Prev.Bot.Y;)e=e.Prev;for(;e!==r&&e.Dx===E.ClipperBase.horizontal;)e=e.Next}e===r?r=t?e.Next:e.Prev:(e=t?r.Next:r.Prev,(o=new E.LocalMinima).Next=null,o.Y=e.Bot.Y,o.LeftBound=null,(o.RightBound=e).WindDelta=0,r=this.ProcessBound(e,t),this.InsertLocalMinima(o))}else if(e.Dx===E.ClipperBase.horizontal&&((i=t?e.Prev:e.Next).Dx===E.ClipperBase.horizontal?i.Bot.X!==e.Bot.X&&i.Top.X!==e.Bot.X&&this.ReverseHorizontal(e):i.Bot.X!==e.Bot.X&&this.ReverseHorizontal(e)),i=e,t){for(;r.Top.Y===r.Next.Bot.Y&&r.Next.OutIdx!==E.ClipperBase.Skip;)r=r.Next;if(r.Dx===E.ClipperBase.horizontal&&r.Next.OutIdx!==E.ClipperBase.Skip){for(n=r;n.Prev.Dx===E.ClipperBase.horizontal;)n=n.Prev;n.Prev.Top.X>r.Next.Top.X&&(r=n.Prev)}for(;e!==r;)e.NextInLML=e.Next,e.Dx===E.ClipperBase.horizontal&&e!==i&&e.Bot.X!==e.Prev.Top.X&&this.ReverseHorizontal(e),e=e.Next;e.Dx===E.ClipperBase.horizontal&&e!==i&&e.Bot.X!==e.Prev.Top.X&&this.ReverseHorizontal(e),r=r.Next}else{for(;r.Top.Y===r.Prev.Bot.Y&&r.Prev.OutIdx!==E.ClipperBase.Skip;)r=r.Prev;if(r.Dx===E.ClipperBase.horizontal&&r.Prev.OutIdx!==E.ClipperBase.Skip){for(n=r;n.Next.Dx===E.ClipperBase.horizontal;)n=n.Next;(n.Next.Top.X===r.Prev.Top.X||n.Next.Top.X>r.Prev.Top.X)&&(r=n.Next)}for(;e!==r;)e.NextInLML=e.Prev,e.Dx===E.ClipperBase.horizontal&&e!==i&&e.Bot.X!==e.Next.Top.X&&this.ReverseHorizontal(e),e=e.Prev;e.Dx===E.ClipperBase.horizontal&&e!==i&&e.Bot.X!==e.Next.Top.X&&this.ReverseHorizontal(e),r=r.Prev}return r},E.ClipperBase.prototype.AddPath=function(e,t,i){E.use_lines?i||t!==E.PolyType.ptClip||E.Error("AddPath: Open paths must be subject."):i||E.Error("AddPath: Open paths have been disabled.");var n=e.length-1;if(i)for(;0<n&&E.IntPoint.op_Equality(e[n],e[0]);)--n;for(;0<n&&E.IntPoint.op_Equality(e[n],e[n-1]);)--n;if(i&&n<2||!i&&n<1)return!1;for(var o=new Array,r=0;r<=n;r++)o.push(new E.TEdge);var s=!0,l=(o[1].Curr.X=e[1].X,o[1].Curr.Y=e[1].Y,E.use_xyz&&(o[1].Curr.Z=e[1].Z),{Value:this.m_UseFullRange});this.RangeTest(e[0],l),this.m_UseFullRange=l.Value,l.Value=this.m_UseFullRange,this.RangeTest(e[n],l),this.m_UseFullRange=l.Value,this.InitEdge(o[0],o[1],o[n],e[0]),this.InitEdge(o[n],o[0],o[n-1],e[n]);for(r=n-1;1<=r;--r)l.Value=this.m_UseFullRange,this.RangeTest(e[r],l),this.m_UseFullRange=l.Value,this.InitEdge(o[r],o[r+1],o[r-1],e[r]);for(var a=o[0],p=a,h=a;;)if(p.Curr!==p.Next.Curr||!i&&p.Next===a){if(p.Prev===p.Next)break;if(!i||!E.ClipperBase.SlopesEqual4(p.Prev.Curr,p.Curr,p.Next.Curr,this.m_UseFullRange)||this.PreserveCollinear&&this.Pt2IsBetweenPt1AndPt3(p.Prev.Curr,p.Curr,p.Next.Curr)){if((p=p.Next)===h||!i&&p.Next===a)break}else p===a&&(a=p.Next),h=p=(p=this.RemoveEdge(p)).Prev}else{if(p===p.Next)break;p===a&&(a=p.Next),h=p=this.RemoveEdge(p)}if(!i&&p===p.Next||i&&p.Prev===p.Next)return!1;for(i||(this.m_HasOpenPaths=!0,a.Prev.OutIdx=E.ClipperBase.Skip),p=a;this.InitEdge2(p,t),p=p.Next,s&&p.Curr.Y!==a.Curr.Y&&(s=!1),p!==a;);if(s){if(i)return!1;for(p.Prev.OutIdx=E.ClipperBase.Skip,(u=new E.LocalMinima).Next=null,u.Y=p.Bot.Y,u.LeftBound=null,u.RightBound=p,u.RightBound.Side=E.EdgeSide.esRight,u.RightBound.WindDelta=0;p.Bot.X!==p.Prev.Top.X&&this.ReverseHorizontal(p),p.Next.OutIdx!==E.ClipperBase.Skip;)p.NextInLML=p.Next,p=p.Next;this.InsertLocalMinima(u),this.m_edges.push(o)}else{this.m_edges.push(o);var d,c=null;for(E.IntPoint.op_Equality(p.Prev.Bot,p.Prev.Top)&&(p=p.Next);(p=this.FindNextLocMin(p))!==c;){null===c&&(c=p);(u=new E.LocalMinima).Next=null,u.Y=p.Bot.Y,d=p.Dx<p.Prev.Dx?(u.LeftBound=p.Prev,u.RightBound=p,!1):(u.LeftBound=p,u.RightBound=p.Prev,!0),u.LeftBound.Side=E.EdgeSide.esLeft,u.RightBound.Side=E.EdgeSide.esRight,i?u.LeftBound.Next===u.RightBound?u.LeftBound.WindDelta=-1:u.LeftBound.WindDelta=1:u.LeftBound.WindDelta=0,u.RightBound.WindDelta=-u.LeftBound.WindDelta,(p=this.ProcessBound(u.LeftBound,d)).OutIdx===E.ClipperBase.Skip&&(p=this.ProcessBound(p,d));var u,f=this.ProcessBound(u.RightBound,!d);f.OutIdx===E.ClipperBase.Skip&&(f=this.ProcessBound(f,!d)),u.LeftBound.OutIdx===E.ClipperBase.Skip?u.LeftBound=null:u.RightBound.OutIdx===E.ClipperBase.Skip&&(u.RightBound=null),this.InsertLocalMinima(u),d||(p=f)}}return!0},E.ClipperBase.prototype.AddPaths=function(e,t,i){for(var n=!1,o=0,r=e.length;o<r;++o)this.AddPath(e[o],t,i)&&(n=!0);return n},E.ClipperBase.prototype.Pt2IsBetweenPt1AndPt3=function(e,t,i){return!(E.IntPoint.op_Equality(e,i)||E.IntPoint.op_Equality(e,t)||E.IntPoint.op_Equality(i,t))&&(e.X!==i.X?t.X>e.X==t.X<i.X:t.Y>e.Y==t.Y<i.Y)},E.ClipperBase.prototype.RemoveEdge=function(e){e.Prev.Next=e.Next,e.Next.Prev=e.Prev;var t=e.Next;return e.Prev=null,t},E.ClipperBase.prototype.SetDx=function(e){e.Delta.X=e.Top.X-e.Bot.X,e.Delta.Y=e.Top.Y-e.Bot.Y,0===e.Delta.Y?e.Dx=E.ClipperBase.horizontal:e.Dx=e.Delta.X/e.Delta.Y},E.ClipperBase.prototype.InsertLocalMinima=function(e){if(null===this.m_MinimaList)this.m_MinimaList=e;else if(e.Y>=this.m_MinimaList.Y)e.Next=this.m_MinimaList,this.m_MinimaList=e;else{for(var t=this.m_MinimaList;null!==t.Next&&e.Y<t.Next.Y;)t=t.Next;e.Next=t.Next,t.Next=e}},E.ClipperBase.prototype.PopLocalMinima=function(e,t){return t.v=this.m_CurrentLM,null!==this.m_CurrentLM&&this.m_CurrentLM.Y===e&&(this.m_CurrentLM=this.m_CurrentLM.Next,!0)},E.ClipperBase.prototype.ReverseHorizontal=function(e){var t=e.Top.X;e.Top.X=e.Bot.X,e.Bot.X=t,E.use_xyz&&(t=e.Top.Z,e.Top.Z=e.Bot.Z,e.Bot.Z=t)},E.ClipperBase.prototype.Reset=function(){if(this.m_CurrentLM=this.m_MinimaList,null!==this.m_CurrentLM){this.m_Scanbeam=null;for(var e=this.m_MinimaList;null!==e;){this.InsertScanbeam(e.Y);var t=e.LeftBound;null!==t&&(t.Curr.X=t.Bot.X,t.Curr.Y=t.Bot.Y,E.use_xyz&&(t.Curr.Z=t.Bot.Z),t.OutIdx=E.ClipperBase.Unassigned),null!==(t=e.RightBound)&&(t.Curr.X=t.Bot.X,t.Curr.Y=t.Bot.Y,E.use_xyz&&(t.Curr.Z=t.Bot.Z),t.OutIdx=E.ClipperBase.Unassigned),e=e.Next}this.m_ActiveEdges=null}},E.ClipperBase.prototype.InsertScanbeam=function(e){if(null===this.m_Scanbeam)this.m_Scanbeam=new E.Scanbeam,this.m_Scanbeam.Next=null,this.m_Scanbeam.Y=e;else if(e>this.m_Scanbeam.Y){var t=new E.Scanbeam;t.Y=e,t.Next=this.m_Scanbeam,this.m_Scanbeam=t}else{for(var i=this.m_Scanbeam;null!==i.Next&&e<=i.Next.Y;)i=i.Next;e!==i.Y&&((t=new E.Scanbeam).Y=e,t.Next=i.Next,i.Next=t)}},E.ClipperBase.prototype.PopScanbeam=function(e){return null===this.m_Scanbeam?(e.v=0,!1):(e.v=this.m_Scanbeam.Y,this.m_Scanbeam=this.m_Scanbeam.Next,!0)},E.ClipperBase.prototype.LocalMinimaPending=function(){return null!==this.m_CurrentLM},E.ClipperBase.prototype.CreateOutRec=function(){var e=new E.OutRec;return e.Idx=E.ClipperBase.Unassigned,e.IsHole=!1,e.IsOpen=!1,e.FirstLeft=null,e.Pts=null,e.BottomPt=null,e.PolyNode=null,this.m_PolyOuts.push(e),e.Idx=this.m_PolyOuts.length-1,e},E.ClipperBase.prototype.DisposeOutRec=function(e){this.m_PolyOuts[e].Pts=null,this.m_PolyOuts[e]=null},E.ClipperBase.prototype.UpdateEdgeIntoAEL=function(e){null===e.NextInLML&&E.Error("UpdateEdgeIntoAEL: invalid call");var t=e.PrevInAEL,i=e.NextInAEL;return e.NextInLML.OutIdx=e.OutIdx,null!==t?t.NextInAEL=e.NextInLML:this.m_ActiveEdges=e.NextInLML,null!==i&&(i.PrevInAEL=e.NextInLML),e.NextInLML.Side=e.Side,e.NextInLML.WindDelta=e.WindDelta,e.NextInLML.WindCnt=e.WindCnt,e.NextInLML.WindCnt2=e.WindCnt2,(e=e.NextInLML).Curr.X=e.Bot.X,e.Curr.Y=e.Bot.Y,e.PrevInAEL=t,e.NextInAEL=i,E.ClipperBase.IsHorizontal(e)||this.InsertScanbeam(e.Top.Y),e},E.ClipperBase.prototype.SwapPositionsInAEL=function(e,t){var i,n;e.NextInAEL!==e.PrevInAEL&&t.NextInAEL!==t.PrevInAEL&&(e.NextInAEL===t?(null!==(i=t.NextInAEL)&&(i.PrevInAEL=e),null!==(n=e.PrevInAEL)&&(n.NextInAEL=t),t.PrevInAEL=n,(t.NextInAEL=e).PrevInAEL=t,e.NextInAEL=i):t.NextInAEL===e?(null!==(n=e.NextInAEL)&&(n.PrevInAEL=t),null!==(i=t.PrevInAEL)&&(i.NextInAEL=e),e.PrevInAEL=i,(e.NextInAEL=t).PrevInAEL=e,t.NextInAEL=n):(i=e.NextInAEL,n=e.PrevInAEL,e.NextInAEL=t.NextInAEL,null!==e.NextInAEL&&(e.NextInAEL.PrevInAEL=e),e.PrevInAEL=t.PrevInAEL,null!==e.PrevInAEL&&(e.PrevInAEL.NextInAEL=e),t.NextInAEL=i,null!==t.NextInAEL&&(t.NextInAEL.PrevInAEL=t),t.PrevInAEL=n,null!==t.PrevInAEL&&(t.PrevInAEL.NextInAEL=t)),null===e.PrevInAEL?this.m_ActiveEdges=e:null===t.PrevInAEL&&(this.m_ActiveEdges=t))},E.ClipperBase.prototype.DeleteFromAEL=function(e){var t=e.PrevInAEL,i=e.NextInAEL;null===t&&null===i&&e!==this.m_ActiveEdges||(null!==t?t.NextInAEL=i:this.m_ActiveEdges=i,null!==i&&(i.PrevInAEL=t),e.NextInAEL=null,e.PrevInAEL=null)},E.Clipper=function(e){void 0===e&&(e=0),this.m_PolyOuts=null,this.m_ClipType=E.ClipType.ctIntersection,this.m_Scanbeam=null,this.m_Maxima=null,this.m_ActiveEdges=null,this.m_SortedEdges=null,this.m_IntersectList=null,this.m_IntersectNodeComparer=null,this.m_ExecuteLocked=!1,this.m_ClipFillType=E.PolyFillType.pftEvenOdd,this.m_SubjFillType=E.PolyFillType.pftEvenOdd,this.m_Joins=null,this.m_GhostJoins=null,this.m_UsingPolyTree=!1,this.ReverseSolution=!1,this.StrictlySimple=!1,E.ClipperBase.call(this),this.m_Scanbeam=null,this.m_Maxima=null,this.m_ActiveEdges=null,this.m_SortedEdges=null,this.m_IntersectList=new Array,this.m_IntersectNodeComparer=E.MyIntersectNodeSort.Compare,this.m_ExecuteLocked=!1,this.m_UsingPolyTree=!1,this.m_PolyOuts=new Array,this.m_Joins=new Array,this.m_GhostJoins=new Array,this.ReverseSolution=0!=(1&e),this.StrictlySimple=0!=(2&e),this.PreserveCollinear=0!=(4&e),E.use_xyz&&(this.ZFillFunction=null)},E.Clipper.ioReverseSolution=1,E.Clipper.ioStrictlySimple=2,E.Clipper.ioPreserveCollinear=4,E.Clipper.prototype.Clear=function(){0!==this.m_edges.length&&(this.DisposeAllPolyPts(),E.ClipperBase.prototype.Clear.call(this))},E.Clipper.prototype.InsertMaxima=function(e){var t=new E.Maxima;if(t.X=e,null===this.m_Maxima)this.m_Maxima=t,this.m_Maxima.Next=null,this.m_Maxima.Prev=null;else if(e<this.m_Maxima.X)t.Next=this.m_Maxima,t.Prev=null,this.m_Maxima=t;else{for(var i=this.m_Maxima;null!==i.Next&&e>=i.Next.X;)i=i.Next;e!==i.X&&(t.Next=i.Next,null!==(t.Prev=i).Next&&(i.Next.Prev=t),i.Next=t)}},E.Clipper.prototype.Execute=function(){var e=arguments,t=e.length,i=e[1]instanceof E.PolyTree;if(4!==t||i){if(4===t&&i){var n=e[0],o=e[1],r=e[2],s=e[3];if(this.m_ExecuteLocked)return!1;this.m_ExecuteLocked=!0,this.m_SubjFillType=r,this.m_ClipFillType=s,this.m_ClipType=n,this.m_UsingPolyTree=!0;try{(l=this.ExecuteInternal())&&this.BuildResult2(o)}finally{this.DisposeAllPolyPts(),this.m_ExecuteLocked=!1}return l}return 2!==t||i?2===t&&i?this.Execute(n=e[0],o=e[1],E.PolyFillType.pftEvenOdd,E.PolyFillType.pftEvenOdd):void 0:this.Execute(n=e[0],a=e[1],E.PolyFillType.pftEvenOdd,E.PolyFillType.pftEvenOdd)}var l,n=e[0],a=e[1],r=e[2],s=e[3];if(this.m_ExecuteLocked)return!1;this.m_HasOpenPaths&&E.Error("Error: PolyTree struct is needed for open path clipping."),this.m_ExecuteLocked=!0,E.Clear(a),this.m_SubjFillType=r,this.m_ClipFillType=s,this.m_ClipType=n,this.m_UsingPolyTree=!1;try{(l=this.ExecuteInternal())&&this.BuildResult(a)}finally{this.DisposeAllPolyPts(),this.m_ExecuteLocked=!1}return l},E.Clipper.prototype.FixHoleLinkage=function(e){if(null!==e.FirstLeft&&(e.IsHole===e.FirstLeft.IsHole||null===e.FirstLeft.Pts)){for(var t=e.FirstLeft;null!==t&&(t.IsHole===e.IsHole||null===t.Pts);)t=t.FirstLeft;e.FirstLeft=t}},E.Clipper.prototype.ExecuteInternal=function(){try{this.Reset(),this.m_SortedEdges=null,this.m_Maxima=null;var e,t,i,n={},o={};if(!this.PopScanbeam(n))return!1;for(this.InsertLocalMinimaIntoAEL(n.v);this.PopScanbeam(o)||this.LocalMinimaPending();){if(this.ProcessHorizontals(),this.m_GhostJoins.length=0,!this.ProcessIntersections(o.v))return!1;this.ProcessEdgesAtTopOfScanbeam(o.v),n.v=o.v,this.InsertLocalMinimaIntoAEL(n.v)}for(t=0,i=this.m_PolyOuts.length;t<i;t++)null===(e=this.m_PolyOuts[t]).Pts||e.IsOpen||(e.IsHole^this.ReverseSolution)==0<this.Area$1(e)&&this.ReversePolyPtLinks(e.Pts);for(this.JoinCommonEdges(),t=0,i=this.m_PolyOuts.length;t<i;t++)null!==(e=this.m_PolyOuts[t]).Pts&&(e.IsOpen?this.FixupOutPolyline(e):this.FixupOutPolygon(e));return this.StrictlySimple&&this.DoSimplePolygons(),!0}finally{this.m_Joins.length=0,this.m_GhostJoins.length=0}},E.Clipper.prototype.DisposeAllPolyPts=function(){for(var e=0,t=this.m_PolyOuts.length;e<t;++e)this.DisposeOutRec(e);E.Clear(this.m_PolyOuts)},E.Clipper.prototype.AddJoin=function(e,t,i){var n=new E.Join;n.OutPt1=e,n.OutPt2=t,n.OffPt.X=i.X,n.OffPt.Y=i.Y,E.use_xyz&&(n.OffPt.Z=i.Z),this.m_Joins.push(n)},E.Clipper.prototype.AddGhostJoin=function(e,t){var i=new E.Join;i.OutPt1=e,i.OffPt.X=t.X,i.OffPt.Y=t.Y,E.use_xyz&&(i.OffPt.Z=t.Z),this.m_GhostJoins.push(i)},E.Clipper.prototype.SetZ=function(e,t,i){null!==this.ZFillFunction&&0===e.Z&&null!==this.ZFillFunction&&(E.IntPoint.op_Equality(e,t.Bot)?e.Z=t.Bot.Z:E.IntPoint.op_Equality(e,t.Top)?e.Z=t.Top.Z:E.IntPoint.op_Equality(e,i.Bot)?e.Z=i.Bot.Z:E.IntPoint.op_Equality(e,i.Top)?e.Z=i.Top.Z:this.ZFillFunction(t.Bot,t.Top,i.Bot,i.Top,e))},E.Clipper.prototype.InsertLocalMinimaIntoAEL=function(e){for(var t={};this.PopLocalMinima(e,t);){var i=t.v.LeftBound,n=t.v.RightBound,o=null;if(null===i?(this.InsertEdgeIntoAEL(n,null),this.SetWindingCount(n),this.IsContributing(n)&&(o=this.AddOutPt(n,n.Bot))):(null===n?(this.InsertEdgeIntoAEL(i,null),this.SetWindingCount(i),this.IsContributing(i)&&(o=this.AddOutPt(i,i.Bot))):(this.InsertEdgeIntoAEL(i,null),this.InsertEdgeIntoAEL(n,i),this.SetWindingCount(i),n.WindCnt=i.WindCnt,n.WindCnt2=i.WindCnt2,this.IsContributing(i)&&(o=this.AddLocalMinPoly(i,n,i.Bot))),this.InsertScanbeam(i.Top.Y)),null!==n&&(E.ClipperBase.IsHorizontal(n)?(null!==n.NextInLML&&this.InsertScanbeam(n.NextInLML.Top.Y),this.AddEdgeToSEL(n)):this.InsertScanbeam(n.Top.Y)),null!==i&&null!==n){if(null!==o&&E.ClipperBase.IsHorizontal(n)&&0<this.m_GhostJoins.length&&0!==n.WindDelta)for(var r=0,s=this.m_GhostJoins.length;r<s;r++){var l=this.m_GhostJoins[r];this.HorzSegmentsOverlap(l.OutPt1.Pt.X,l.OffPt.X,n.Bot.X,n.Top.X)&&this.AddJoin(l.OutPt1,o,l.OffPt)}if(0<=i.OutIdx&&null!==i.PrevInAEL&&i.PrevInAEL.Curr.X===i.Bot.X&&0<=i.PrevInAEL.OutIdx&&E.ClipperBase.SlopesEqual5(i.PrevInAEL.Curr,i.PrevInAEL.Top,i.Curr,i.Top,this.m_UseFullRange)&&0!==i.WindDelta&&0!==i.PrevInAEL.WindDelta&&(a=this.AddOutPt(i.PrevInAEL,i.Bot),this.AddJoin(o,a,i.Top)),i.NextInAEL!==n){0<=n.OutIdx&&0<=n.PrevInAEL.OutIdx&&E.ClipperBase.SlopesEqual5(n.PrevInAEL.Curr,n.PrevInAEL.Top,n.Curr,n.Top,this.m_UseFullRange)&&0!==n.WindDelta&&0!==n.PrevInAEL.WindDelta&&(a=this.AddOutPt(n.PrevInAEL,n.Bot),this.AddJoin(o,a,n.Top));var a,p=i.NextInAEL;if(null!==p)for(;p!==n;)this.IntersectEdges(n,p,i.Curr),p=p.NextInAEL}}}},E.Clipper.prototype.InsertEdgeIntoAEL=function(e,t){if(null===this.m_ActiveEdges)e.PrevInAEL=null,e.NextInAEL=null,this.m_ActiveEdges=e;else if(null===t&&this.E2InsertsBeforeE1(this.m_ActiveEdges,e))e.PrevInAEL=null,e.NextInAEL=this.m_ActiveEdges,this.m_ActiveEdges.PrevInAEL=e,this.m_ActiveEdges=e;else{for(null===t&&(t=this.m_ActiveEdges);null!==t.NextInAEL&&!this.E2InsertsBeforeE1(t.NextInAEL,e);)t=t.NextInAEL;e.NextInAEL=t.NextInAEL,null!==t.NextInAEL&&(t.NextInAEL.PrevInAEL=e),(e.PrevInAEL=t).NextInAEL=e}},E.Clipper.prototype.E2InsertsBeforeE1=function(e,t){return t.Curr.X===e.Curr.X?t.Top.Y>e.Top.Y?t.Top.X<E.Clipper.TopX(e,t.Top.Y):e.Top.X>E.Clipper.TopX(t,e.Top.Y):t.Curr.X<e.Curr.X},E.Clipper.prototype.IsEvenOddFillType=function(e){return e.PolyTyp===E.PolyType.ptSubject?this.m_SubjFillType===E.PolyFillType.pftEvenOdd:this.m_ClipFillType===E.PolyFillType.pftEvenOdd},E.Clipper.prototype.IsEvenOddAltFillType=function(e){return e.PolyTyp===E.PolyType.ptSubject?this.m_ClipFillType===E.PolyFillType.pftEvenOdd:this.m_SubjFillType===E.PolyFillType.pftEvenOdd},E.Clipper.prototype.IsContributing=function(e){var t,i=e.PolyTyp===E.PolyType.ptSubject?(t=this.m_SubjFillType,this.m_ClipFillType):(t=this.m_ClipFillType,this.m_SubjFillType);switch(t){case E.PolyFillType.pftEvenOdd:if(0===e.WindDelta&&1!==e.WindCnt)return!1;break;case E.PolyFillType.pftNonZero:if(1!==Math.abs(e.WindCnt))return!1;break;case E.PolyFillType.pftPositive:if(1!==e.WindCnt)return!1;break;default:if(-1!==e.WindCnt)return!1}switch(this.m_ClipType){case E.ClipType.ctIntersection:switch(i){case E.PolyFillType.pftEvenOdd:case E.PolyFillType.pftNonZero:return 0!==e.WindCnt2;case E.PolyFillType.pftPositive:return 0<e.WindCnt2;default:return e.WindCnt2<0}case E.ClipType.ctUnion:switch(i){case E.PolyFillType.pftEvenOdd:case E.PolyFillType.pftNonZero:return 0===e.WindCnt2;case E.PolyFillType.pftPositive:return e.WindCnt2<=0;default:return 0<=e.WindCnt2}case E.ClipType.ctDifference:if(e.PolyTyp===E.PolyType.ptSubject)switch(i){case E.PolyFillType.pftEvenOdd:case E.PolyFillType.pftNonZero:return 0===e.WindCnt2;case E.PolyFillType.pftPositive:return e.WindCnt2<=0;default:return 0<=e.WindCnt2}else switch(i){case E.PolyFillType.pftEvenOdd:case E.PolyFillType.pftNonZero:return 0!==e.WindCnt2;case E.PolyFillType.pftPositive:return 0<e.WindCnt2;default:return e.WindCnt2<0}case E.ClipType.ctXor:if(0!==e.WindDelta)return!0;switch(i){case E.PolyFillType.pftEvenOdd:case E.PolyFillType.pftNonZero:return 0===e.WindCnt2;case E.PolyFillType.pftPositive:return e.WindCnt2<=0;default:return 0<=e.WindCnt2}}return!0},E.Clipper.prototype.SetWindingCount=function(e){for(var t=e.PrevInAEL;null!==t&&(t.PolyTyp!==e.PolyTyp||0===t.WindDelta);)t=t.PrevInAEL;if(null===t){var i=e.PolyTyp===E.PolyType.ptSubject?this.m_SubjFillType:this.m_ClipFillType;0===e.WindDelta?e.WindCnt=i===E.PolyFillType.pftNegative?-1:1:e.WindCnt=e.WindDelta,e.WindCnt2=0,t=this.m_ActiveEdges}else{if(0===e.WindDelta&&this.m_ClipType!==E.ClipType.ctUnion)e.WindCnt=1;else if(this.IsEvenOddFillType(e))if(0===e.WindDelta){for(var n=!0,o=t.PrevInAEL;null!==o;)o.PolyTyp===t.PolyTyp&&0!==o.WindDelta&&(n=!n),o=o.PrevInAEL;e.WindCnt=n?0:1}else e.WindCnt=e.WindDelta;else t.WindCnt*t.WindDelta<0?1<Math.abs(t.WindCnt)?t.WindDelta*e.WindDelta<0?e.WindCnt=t.WindCnt:e.WindCnt=t.WindCnt+e.WindDelta:e.WindCnt=0===e.WindDelta?1:e.WindDelta:0===e.WindDelta?e.WindCnt=t.WindCnt<0?t.WindCnt-1:t.WindCnt+1:t.WindDelta*e.WindDelta<0?e.WindCnt=t.WindCnt:e.WindCnt=t.WindCnt+e.WindDelta;e.WindCnt2=t.WindCnt2,t=t.NextInAEL}if(this.IsEvenOddAltFillType(e))for(;t!==e;)0!==t.WindDelta&&(e.WindCnt2=0===e.WindCnt2?1:0),t=t.NextInAEL;else for(;t!==e;)e.WindCnt2+=t.WindDelta,t=t.NextInAEL},E.Clipper.prototype.AddEdgeToSEL=function(e){null===this.m_SortedEdges?((this.m_SortedEdges=e).PrevInSEL=null,e.NextInSEL=null):(e.NextInSEL=this.m_SortedEdges,e.PrevInSEL=null,this.m_SortedEdges.PrevInSEL=e,this.m_SortedEdges=e)},E.Clipper.prototype.PopEdgeFromSEL=function(e){var t;return e.v=this.m_SortedEdges,null!==e.v&&(t=e.v,this.m_SortedEdges=e.v.NextInSEL,null!==this.m_SortedEdges&&(this.m_SortedEdges.PrevInSEL=null),t.NextInSEL=null,!(t.PrevInSEL=null))},E.Clipper.prototype.CopyAELToSEL=function(){var e=this.m_ActiveEdges;for(this.m_SortedEdges=e;null!==e;)e.PrevInSEL=e.PrevInAEL,e.NextInSEL=e.NextInAEL,e=e.NextInAEL},E.Clipper.prototype.SwapPositionsInSEL=function(e,t){var i,n;null===e.NextInSEL&&null===e.PrevInSEL||null===t.NextInSEL&&null===t.PrevInSEL||(e.NextInSEL===t?(null!==(i=t.NextInSEL)&&(i.PrevInSEL=e),null!==(n=e.PrevInSEL)&&(n.NextInSEL=t),t.PrevInSEL=n,(t.NextInSEL=e).PrevInSEL=t,e.NextInSEL=i):t.NextInSEL===e?(null!==(i=e.NextInSEL)&&(i.PrevInSEL=t),null!==(n=t.PrevInSEL)&&(n.NextInSEL=e),e.PrevInSEL=n,(e.NextInSEL=t).PrevInSEL=e,t.NextInSEL=i):(i=e.NextInSEL,n=e.PrevInSEL,e.NextInSEL=t.NextInSEL,null!==e.NextInSEL&&(e.NextInSEL.PrevInSEL=e),e.PrevInSEL=t.PrevInSEL,null!==e.PrevInSEL&&(e.PrevInSEL.NextInSEL=e),t.NextInSEL=i,null!==t.NextInSEL&&(t.NextInSEL.PrevInSEL=t),t.PrevInSEL=n,null!==t.PrevInSEL&&(t.PrevInSEL.NextInSEL=t)),null===e.PrevInSEL?this.m_SortedEdges=e:null===t.PrevInSEL&&(this.m_SortedEdges=t))},E.Clipper.prototype.AddLocalMaxPoly=function(e,t,i){this.AddOutPt(e,i),0===t.WindDelta&&this.AddOutPt(t,i),e.OutIdx===t.OutIdx?(e.OutIdx=-1,t.OutIdx=-1):e.OutIdx<t.OutIdx?this.AppendPolygon(e,t):this.AppendPolygon(t,e)},E.Clipper.prototype.AddLocalMinPoly=function(e,t,i){var n,o,r,t=(E.ClipperBase.IsHorizontal(t)||e.Dx>t.Dx?(n=this.AddOutPt(e,i),t.OutIdx=e.OutIdx,e.Side=E.EdgeSide.esLeft,t.Side=E.EdgeSide.esRight,(o=e).PrevInAEL===t?t:o):(n=this.AddOutPt(t,i),e.OutIdx=t.OutIdx,e.Side=E.EdgeSide.esRight,t.Side=E.EdgeSide.esLeft,(o=t).PrevInAEL===e?e:o)).PrevInAEL;return null!==t&&0<=t.OutIdx&&t.Top.Y<i.Y&&o.Top.Y<i.Y&&(e=E.Clipper.TopX(t,i.Y))===(r=E.Clipper.TopX(o,i.Y))&&0!==o.WindDelta&&0!==t.WindDelta&&E.ClipperBase.SlopesEqual5(new E.IntPoint2(e,i.Y),t.Top,new E.IntPoint2(r,i.Y),o.Top,this.m_UseFullRange)&&(e=this.AddOutPt(t,i),this.AddJoin(n,e,o.Top)),n},E.Clipper.prototype.AddOutPt=function(e,t){var i,n,o;return e.OutIdx<0?((i=this.CreateOutRec()).IsOpen=0===e.WindDelta,o=new E.OutPt,(i.Pts=o).Idx=i.Idx,o.Pt.X=t.X,o.Pt.Y=t.Y,E.use_xyz&&(o.Pt.Z=t.Z),(o.Next=o).Prev=o,i.IsOpen||this.SetHoleState(e,i),e.OutIdx=i.Idx,o):(n=(i=this.m_PolyOuts[e.OutIdx]).Pts,(e=e.Side===E.EdgeSide.esLeft)&&E.IntPoint.op_Equality(t,n.Pt)?n:!e&&E.IntPoint.op_Equality(t,n.Prev.Pt)?n.Prev:((o=new E.OutPt).Idx=i.Idx,o.Pt.X=t.X,o.Pt.Y=t.Y,E.use_xyz&&(o.Pt.Z=t.Z),o.Next=n,o.Prev=n.Prev,o.Prev.Next=o,n.Prev=o,e&&(i.Pts=o),o))},E.Clipper.prototype.GetLastOutPt=function(e){var t=this.m_PolyOuts[e.OutIdx];return e.Side===E.EdgeSide.esLeft?t.Pts:t.Pts.Prev},E.Clipper.prototype.SwapPoints=function(e,t){var i=new E.IntPoint1(e.Value);e.Value.X=t.Value.X,e.Value.Y=t.Value.Y,E.use_xyz&&(e.Value.Z=t.Value.Z),t.Value.X=i.X,t.Value.Y=i.Y,E.use_xyz&&(t.Value.Z=i.Z)},E.Clipper.prototype.HorzSegmentsOverlap=function(e,t,i,n){var o;return t<e&&(o=e,e=t,t=o),n<i&&(o=i,i=n,n=o),e<n&&i<t},E.Clipper.prototype.SetHoleState=function(e,t){for(var i=e.PrevInAEL,n=null;null!==i;)0<=i.OutIdx&&0!==i.WindDelta&&(null===n?n=i:n.OutIdx===i.OutIdx&&(n=null)),i=i.PrevInAEL;null===n?(t.FirstLeft=null,t.IsHole=!1):(t.FirstLeft=this.m_PolyOuts[n.OutIdx],t.IsHole=!t.FirstLeft.IsHole)},E.Clipper.prototype.GetDx=function(e,t){return e.Y===t.Y?E.ClipperBase.horizontal:(t.X-e.X)/(t.Y-e.Y)},E.Clipper.prototype.FirstIsBottomPt=function(e,t){for(var i=e.Prev;E.IntPoint.op_Equality(i.Pt,e.Pt)&&i!==e;)i=i.Prev;for(var n=Math.abs(this.GetDx(e.Pt,i.Pt)),i=e.Next;E.IntPoint.op_Equality(i.Pt,e.Pt)&&i!==e;)i=i.Next;var o=Math.abs(this.GetDx(e.Pt,i.Pt));for(i=t.Prev;E.IntPoint.op_Equality(i.Pt,t.Pt)&&i!==t;)i=i.Prev;var r=Math.abs(this.GetDx(t.Pt,i.Pt));for(i=t.Next;E.IntPoint.op_Equality(i.Pt,t.Pt)&&i!==t;)i=i.Next;var s=Math.abs(this.GetDx(t.Pt,i.Pt));return Math.max(n,o)===Math.max(r,s)&&Math.min(n,o)===Math.min(r,s)?0<this.Area(e):r<=n&&s<=n||r<=o&&s<=o},E.Clipper.prototype.GetBottomPt=function(e){for(var t=null,i=e.Next;i!==e;)i.Pt.Y>e.Pt.Y?(e=i,t=null):i.Pt.Y===e.Pt.Y&&i.Pt.X<=e.Pt.X&&(i.Pt.X<e.Pt.X?(t=null,e=i):i.Next!==e&&i.Prev!==e&&(t=i)),i=i.Next;if(null!==t)for(;t!==i;)for(this.FirstIsBottomPt(i,t)||(e=t),t=t.Next;E.IntPoint.op_Inequality(t.Pt,e.Pt);)t=t.Next;return e},E.Clipper.prototype.GetLowermostRec=function(e,t){null===e.BottomPt&&(e.BottomPt=this.GetBottomPt(e.Pts)),null===t.BottomPt&&(t.BottomPt=this.GetBottomPt(t.Pts));var i=e.BottomPt,n=t.BottomPt;return i.Pt.Y>n.Pt.Y||!(i.Pt.Y<n.Pt.Y)&&(i.Pt.X<n.Pt.X||!(i.Pt.X>n.Pt.X)&&i.Next!==i&&(n.Next===n||this.FirstIsBottomPt(i,n)))?e:t},E.Clipper.prototype.OutRec1RightOfOutRec2=function(e,t){do{if((e=e.FirstLeft)===t)return!0}while(null!==e);return!1},E.Clipper.prototype.GetOutRec=function(e){for(var t=this.m_PolyOuts[e];t!==this.m_PolyOuts[t.Idx];)t=this.m_PolyOuts[t.Idx];return t},E.Clipper.prototype.AppendPolygon=function(e,t){for(var i=this.m_PolyOuts[e.OutIdx],n=this.m_PolyOuts[t.OutIdx],o=this.OutRec1RightOfOutRec2(i,n)?n:this.OutRec1RightOfOutRec2(n,i)?i:this.GetLowermostRec(i,n),r=i.Pts,s=r.Prev,l=n.Pts,a=l.Prev,p=(e.Side===E.EdgeSide.esLeft?t.Side===E.EdgeSide.esLeft?(this.ReversePolyPtLinks(l),(l.Next=r).Prev=l,(s.Next=a).Prev=s,i.Pts=a):((a.Next=r).Prev=a,(l.Prev=s).Next=l,i.Pts=l):t.Side===E.EdgeSide.esRight?(this.ReversePolyPtLinks(l),(s.Next=a).Prev=s,(l.Next=r).Prev=l):((s.Next=l).Prev=s,(r.Prev=a).Next=r),i.BottomPt=null,o===n&&(n.FirstLeft!==i&&(i.FirstLeft=n.FirstLeft),i.IsHole=n.IsHole),n.Pts=null,n.BottomPt=null,n.FirstLeft=i,e.OutIdx),h=t.OutIdx,d=(e.OutIdx=-1,t.OutIdx=-1,this.m_ActiveEdges);null!==d;){if(d.OutIdx===h){d.OutIdx=p,d.Side=e.Side;break}d=d.NextInAEL}n.Idx=i.Idx},E.Clipper.prototype.ReversePolyPtLinks=function(e){if(null!==e)for(var t,i=e;t=i.Next,i.Next=i.Prev,i.Prev=t,(i=t)!==e;);},E.Clipper.SwapSides=function(e,t){var i=e.Side;e.Side=t.Side,t.Side=i},E.Clipper.SwapPolyIndexes=function(e,t){var i=e.OutIdx;e.OutIdx=t.OutIdx,t.OutIdx=i},E.Clipper.prototype.IntersectEdges=function(e,t,i){var n,o,r,s,l,a,p,h,d=0<=e.OutIdx,c=0<=t.OutIdx;if(E.use_xyz&&this.SetZ(i,e,t),E.use_lines&&(0===e.WindDelta||0===t.WindDelta))return 0===e.WindDelta&&0===t.WindDelta?void 0:void(e.PolyTyp===t.PolyTyp&&e.WindDelta!==t.WindDelta&&this.m_ClipType===E.ClipType.ctUnion?0===e.WindDelta?c&&(this.AddOutPt(e,i),d)&&(e.OutIdx=-1):d&&(this.AddOutPt(t,i),c)&&(t.OutIdx=-1):e.PolyTyp!==t.PolyTyp&&(0!==e.WindDelta||1!==Math.abs(t.WindCnt)||this.m_ClipType===E.ClipType.ctUnion&&0!==t.WindCnt2?0!==t.WindDelta||1!==Math.abs(e.WindCnt)||this.m_ClipType===E.ClipType.ctUnion&&0!==e.WindCnt2||(this.AddOutPt(t,i),c&&(t.OutIdx=-1)):(this.AddOutPt(e,i),d&&(e.OutIdx=-1))));switch(e.PolyTyp===t.PolyTyp?this.IsEvenOddFillType(e)?(r=e.WindCnt,e.WindCnt=t.WindCnt,t.WindCnt=r):(e.WindCnt+t.WindDelta===0?e.WindCnt=-e.WindCnt:e.WindCnt+=t.WindDelta,t.WindCnt-e.WindDelta==0?t.WindCnt=-t.WindCnt:t.WindCnt-=e.WindDelta):(this.IsEvenOddFillType(t)?e.WindCnt2=0===e.WindCnt2?1:0:e.WindCnt2+=t.WindDelta,this.IsEvenOddFillType(e)?t.WindCnt2=0===t.WindCnt2?1:0:t.WindCnt2-=e.WindDelta),r=e.PolyTyp===E.PolyType.ptSubject?(n=this.m_SubjFillType,this.m_ClipFillType):(n=this.m_ClipFillType,this.m_SubjFillType),s=t.PolyTyp===E.PolyType.ptSubject?(o=this.m_SubjFillType,this.m_ClipFillType):(o=this.m_ClipFillType,this.m_SubjFillType),n){case E.PolyFillType.pftPositive:l=e.WindCnt;break;case E.PolyFillType.pftNegative:l=-e.WindCnt;break;default:l=Math.abs(e.WindCnt)}switch(o){case E.PolyFillType.pftPositive:a=t.WindCnt;break;case E.PolyFillType.pftNegative:a=-t.WindCnt;break;default:a=Math.abs(t.WindCnt)}if(d&&c)0!==l&&1!==l||0!==a&&1!==a||e.PolyTyp!==t.PolyTyp&&this.m_ClipType!==E.ClipType.ctXor?this.AddLocalMaxPoly(e,t,i):(this.AddOutPt(e,i),this.AddOutPt(t,i),E.Clipper.SwapSides(e,t),E.Clipper.SwapPolyIndexes(e,t));else if(d)0!==a&&1!==a||(this.AddOutPt(e,i),E.Clipper.SwapSides(e,t),E.Clipper.SwapPolyIndexes(e,t));else if(c)0!==l&&1!==l||(this.AddOutPt(t,i),E.Clipper.SwapSides(e,t),E.Clipper.SwapPolyIndexes(e,t));else if(!(0!==l&&1!==l||0!==a&&1!==a)){switch(r){case E.PolyFillType.pftPositive:p=e.WindCnt2;break;case E.PolyFillType.pftNegative:p=-e.WindCnt2;break;default:p=Math.abs(e.WindCnt2)}switch(s){case E.PolyFillType.pftPositive:h=t.WindCnt2;break;case E.PolyFillType.pftNegative:h=-t.WindCnt2;break;default:h=Math.abs(t.WindCnt2)}if(e.PolyTyp!==t.PolyTyp)this.AddLocalMinPoly(e,t,i);else if(1===l&&1===a)switch(this.m_ClipType){case E.ClipType.ctIntersection:0<p&&0<h&&this.AddLocalMinPoly(e,t,i);break;case E.ClipType.ctUnion:p<=0&&h<=0&&this.AddLocalMinPoly(e,t,i);break;case E.ClipType.ctDifference:(e.PolyTyp===E.PolyType.ptClip&&0<p&&0<h||e.PolyTyp===E.PolyType.ptSubject&&p<=0&&h<=0)&&this.AddLocalMinPoly(e,t,i);break;case E.ClipType.ctXor:this.AddLocalMinPoly(e,t,i)}else E.Clipper.SwapSides(e,t)}},E.Clipper.prototype.DeleteFromSEL=function(e){var t=e.PrevInSEL,i=e.NextInSEL;null===t&&null===i&&e!==this.m_SortedEdges||(null!==t?t.NextInSEL=i:this.m_SortedEdges=i,null!==i&&(i.PrevInSEL=t),e.NextInSEL=null,e.PrevInSEL=null)},E.Clipper.prototype.ProcessHorizontals=function(){for(var e={};this.PopEdgeFromSEL(e);)this.ProcessHorizontal(e.v)},E.Clipper.prototype.GetHorzDirection=function(e,t){e.Bot.X<e.Top.X?(t.Left=e.Bot.X,t.Right=e.Top.X,t.Dir=E.Direction.dLeftToRight):(t.Left=e.Top.X,t.Right=e.Bot.X,t.Dir=E.Direction.dRightToLeft)},E.Clipper.prototype.ProcessHorizontal=function(e){for(var t={Dir:null,Left:null,Right:null},i=(this.GetHorzDirection(e,t),t.Dir),n=t.Left,o=t.Right,r=0===e.WindDelta,s=e,l=null;null!==s.NextInLML&&E.ClipperBase.IsHorizontal(s.NextInLML);)s=s.NextInLML;null===s.NextInLML&&(l=this.GetMaximaPair(s));var a=this.m_Maxima;if(null!==a)if(i===E.Direction.dLeftToRight){for(;null!==a&&a.X<=e.Bot.X;)a=a.Next;null!==a&&a.X>=s.Top.X&&(a=null)}else{for(;null!==a.Next&&a.Next.X<e.Bot.X;)a=a.Next;a.X<=s.Top.X&&(a=null)}for(var p,h=null;;){for(var d=e===s,c=this.GetNextInAEL(e,i);null!==c;){if(null!==a)if(i===E.Direction.dLeftToRight)for(;null!==a&&a.X<c.Curr.X;)0<=e.OutIdx&&!r&&this.AddOutPt(e,new E.IntPoint2(a.X,e.Bot.Y)),a=a.Next;else for(;null!==a&&a.X>c.Curr.X;)0<=e.OutIdx&&!r&&this.AddOutPt(e,new E.IntPoint2(a.X,e.Bot.Y)),a=a.Prev;if(i===E.Direction.dLeftToRight&&c.Curr.X>o||i===E.Direction.dRightToLeft&&c.Curr.X<n)break;if(c.Curr.X===e.Top.X&&null!==e.NextInLML&&c.Dx<e.NextInLML.Dx)break;if(0<=e.OutIdx&&!r){E.use_xyz&&(i===E.Direction.dLeftToRight?this.SetZ(c.Curr,e,c):this.SetZ(c.Curr,c,e));for(var h=this.AddOutPt(e,c.Curr),u=this.m_SortedEdges;null!==u;)0<=u.OutIdx&&this.HorzSegmentsOverlap(e.Bot.X,e.Top.X,u.Bot.X,u.Top.X)&&(g=this.GetLastOutPt(u),this.AddJoin(g,h,u.Top)),u=u.NextInSEL;this.AddGhostJoin(h,e.Bot)}if(c===l&&d)return 0<=e.OutIdx&&this.AddLocalMaxPoly(e,l,e.Top),this.DeleteFromAEL(e),void this.DeleteFromAEL(l);i===E.Direction.dLeftToRight?(f=new E.IntPoint2(c.Curr.X,e.Curr.Y),this.IntersectEdges(e,c,f)):(f=new E.IntPoint2(c.Curr.X,e.Curr.Y),this.IntersectEdges(c,e,f));var f,m=this.GetNextInAEL(c,i);this.SwapPositionsInAEL(e,c),c=m}if(null===e.NextInLML||!E.ClipperBase.IsHorizontal(e.NextInLML))break;0<=(e=this.UpdateEdgeIntoAEL(e)).OutIdx&&this.AddOutPt(e,e.Bot),this.GetHorzDirection(e,t={Dir:i,Left:n,Right:o}),i=t.Dir,n=t.Left,o=t.Right}if(0<=e.OutIdx&&null===h){h=this.GetLastOutPt(e);for(var g,u=this.m_SortedEdges;null!==u;)0<=u.OutIdx&&this.HorzSegmentsOverlap(e.Bot.X,e.Top.X,u.Bot.X,u.Top.X)&&(g=this.GetLastOutPt(u),this.AddJoin(g,h,u.Top)),u=u.NextInSEL;this.AddGhostJoin(h,e.Top)}null!==e.NextInLML?0<=e.OutIdx?(h=this.AddOutPt(e,e.Top),0!==(e=this.UpdateEdgeIntoAEL(e)).WindDelta&&(p=e.PrevInAEL,m=e.NextInAEL,null!==p&&p.Curr.X===e.Bot.X&&p.Curr.Y===e.Bot.Y&&0===p.WindDelta&&0<=p.OutIdx&&p.Curr.Y>p.Top.Y&&E.ClipperBase.SlopesEqual3(e,p,this.m_UseFullRange)?(g=this.AddOutPt(p,e.Bot),this.AddJoin(h,g,e.Top)):null!==m&&m.Curr.X===e.Bot.X&&m.Curr.Y===e.Bot.Y&&0!==m.WindDelta&&0<=m.OutIdx&&m.Curr.Y>m.Top.Y&&E.ClipperBase.SlopesEqual3(e,m,this.m_UseFullRange)&&(g=this.AddOutPt(m,e.Bot),this.AddJoin(h,g,e.Top)))):this.UpdateEdgeIntoAEL(e):(0<=e.OutIdx&&this.AddOutPt(e,e.Top),this.DeleteFromAEL(e))},E.Clipper.prototype.GetNextInAEL=function(e,t){return t===E.Direction.dLeftToRight?e.NextInAEL:e.PrevInAEL},E.Clipper.prototype.IsMinima=function(e){return null!==e&&e.Prev.NextInLML!==e&&e.Next.NextInLML!==e},E.Clipper.prototype.IsMaxima=function(e,t){return null!==e&&e.Top.Y===t&&null===e.NextInLML},E.Clipper.prototype.IsIntermediate=function(e,t){return e.Top.Y===t&&null!==e.NextInLML},E.Clipper.prototype.GetMaximaPair=function(e){return E.IntPoint.op_Equality(e.Next.Top,e.Top)&&null===e.Next.NextInLML?e.Next:E.IntPoint.op_Equality(e.Prev.Top,e.Top)&&null===e.Prev.NextInLML?e.Prev:null},E.Clipper.prototype.GetMaximaPairEx=function(e){e=this.GetMaximaPair(e);return null===e||e.OutIdx===E.ClipperBase.Skip||e.NextInAEL===e.PrevInAEL&&!E.ClipperBase.IsHorizontal(e)?null:e},E.Clipper.prototype.ProcessIntersections=function(e){if(null!==this.m_ActiveEdges){try{if(this.BuildIntersectList(e),0===this.m_IntersectList.length)return!0;if(1!==this.m_IntersectList.length&&!this.FixupIntersectionOrder())return!1;this.ProcessIntersectList()}catch(e){this.m_SortedEdges=null,this.m_IntersectList.length=0,E.Error("ProcessIntersections error")}this.m_SortedEdges=null}return!0},E.Clipper.prototype.BuildIntersectList=function(e){if(null!==this.m_ActiveEdges){var t=this.m_ActiveEdges;for(this.m_SortedEdges=t;null!==t;)t.PrevInSEL=t.PrevInAEL,t.NextInSEL=t.NextInAEL,t.Curr.X=E.Clipper.TopX(t,e),t=t.NextInAEL;for(var i=!0;i&&null!==this.m_SortedEdges;){for(i=!1,t=this.m_SortedEdges;null!==t.NextInSEL;){var n,o=t.NextInSEL,r=new E.IntPoint0;t.Curr.X>o.Curr.X?(this.IntersectPoint(t,o,r),r.Y<e&&(r=new E.IntPoint2(E.Clipper.TopX(t,e),e)),(n=new E.IntersectNode).Edge1=t,n.Edge2=o,n.Pt.X=r.X,n.Pt.Y=r.Y,E.use_xyz&&(n.Pt.Z=r.Z),this.m_IntersectList.push(n),this.SwapPositionsInSEL(t,o),i=!0):t=o}if(null===t.PrevInSEL)break;t.PrevInSEL.NextInSEL=null}this.m_SortedEdges=null}},E.Clipper.prototype.EdgesAdjacent=function(e){return e.Edge1.NextInSEL===e.Edge2||e.Edge1.PrevInSEL===e.Edge2},E.Clipper.IntersectNodeSort=function(e,t){return t.Pt.Y-e.Pt.Y},E.Clipper.prototype.FixupIntersectionOrder=function(){this.m_IntersectList.sort(this.m_IntersectNodeComparer),this.CopyAELToSEL();for(var e=this.m_IntersectList.length,t=0;t<e;t++){if(!this.EdgesAdjacent(this.m_IntersectList[t])){for(var i=t+1;i<e&&!this.EdgesAdjacent(this.m_IntersectList[i]);)i++;if(i===e)return!1;var n=this.m_IntersectList[t];this.m_IntersectList[t]=this.m_IntersectList[i],this.m_IntersectList[i]=n}this.SwapPositionsInSEL(this.m_IntersectList[t].Edge1,this.m_IntersectList[t].Edge2)}return!0},E.Clipper.prototype.ProcessIntersectList=function(){for(var e=0,t=this.m_IntersectList.length;e<t;e++){var i=this.m_IntersectList[e];this.IntersectEdges(i.Edge1,i.Edge2,i.Pt),this.SwapPositionsInAEL(i.Edge1,i.Edge2)}this.m_IntersectList.length=0};E.Clipper.Round=i.msie?function(e){return e<0?Math.ceil(e-.5):Math.round(e)}:i.chromium?function(e){return e<0?-Math.round(Math.abs(e)):Math.round(e)}:i.safari?function(e){return e<0?(e-=.5)<-2147483648?Math.ceil(e):0|e:2147483647<(e+=.5)?Math.floor(e):0|e}:function(e){return e<0?Math.ceil(e-.5):Math.floor(e+.5)},E.Clipper.TopX=function(e,t){return t===e.Top.Y?e.Top.X:e.Bot.X+E.Clipper.Round(e.Dx*(t-e.Bot.Y))},E.Clipper.prototype.IntersectPoint=function(e,t,i){var n,o,r;if(i.X=0,i.Y=0,e.Dx===t.Dx)i.Y=e.Curr.Y,i.X=E.Clipper.TopX(e,i.Y);else{if(0===e.Delta.X?(i.X=e.Bot.X,E.ClipperBase.IsHorizontal(t)?i.Y=t.Bot.Y:(o=t.Bot.Y-t.Bot.X/t.Dx,i.Y=E.Clipper.Round(i.X/t.Dx+o))):0===t.Delta.X?(i.X=t.Bot.X,E.ClipperBase.IsHorizontal(e)?i.Y=e.Bot.Y:(n=e.Bot.Y-e.Bot.X/e.Dx,i.Y=E.Clipper.Round(i.X/e.Dx+n))):(n=e.Bot.X-e.Bot.Y*e.Dx,r=((o=t.Bot.X-t.Bot.Y*t.Dx)-n)/(e.Dx-t.Dx),i.Y=E.Clipper.Round(r),Math.abs(e.Dx)<Math.abs(t.Dx)?i.X=E.Clipper.Round(e.Dx*r+n):i.X=E.Clipper.Round(t.Dx*r+o)),i.Y<e.Top.Y||i.Y<t.Top.Y){if(e.Top.Y>t.Top.Y)return i.Y=e.Top.Y,i.X=E.Clipper.TopX(t,e.Top.Y),i.X<e.Top.X;i.Y=t.Top.Y,Math.abs(e.Dx)<Math.abs(t.Dx)?i.X=E.Clipper.TopX(e,i.Y):i.X=E.Clipper.TopX(t,i.Y)}i.Y>e.Curr.Y&&(i.Y=e.Curr.Y,Math.abs(e.Dx)>Math.abs(t.Dx)?i.X=E.Clipper.TopX(t,i.Y):i.X=E.Clipper.TopX(e,i.Y))}},E.Clipper.prototype.ProcessEdgesAtTopOfScanbeam=function(e){for(var t,i=this.m_ActiveEdges;null!==i;)var n,o,r,s,l=this.IsMaxima(i,e),i=(l=l?null===(o=this.GetMaximaPairEx(i))||!E.ClipperBase.IsHorizontal(o):l)?(this.StrictlySimple&&this.InsertMaxima(i.Top.X),n=i.PrevInAEL,this.DoMaxima(i),null===n?this.m_ActiveEdges:n.NextInAEL):(this.IsIntermediate(i,e)&&E.ClipperBase.IsHorizontal(i.NextInLML)?(0<=(i=this.UpdateEdgeIntoAEL(i)).OutIdx&&this.AddOutPt(i,i.Bot),this.AddEdgeToSEL(i)):(i.Curr.X=E.Clipper.TopX(i,e),i.Curr.Y=e),E.use_xyz&&(i.Top.Y===e?i.Curr.Z=i.Top.Z:i.Bot.Y===e?i.Curr.Z=i.Bot.Z:i.Curr.Z=0),this.StrictlySimple&&(n=i.PrevInAEL,0<=i.OutIdx)&&0!==i.WindDelta&&null!==n&&0<=n.OutIdx&&n.Curr.X===i.Curr.X&&0!==n.WindDelta&&(o=new E.IntPoint1(i.Curr),E.use_xyz&&this.SetZ(o,n,i),r=this.AddOutPt(n,o),s=this.AddOutPt(i,o),this.AddJoin(r,s,o)),i.NextInAEL);for(this.ProcessHorizontals(),this.m_Maxima=null,i=this.m_ActiveEdges;null!==i;)this.IsIntermediate(i,e)&&(r=null,0<=i.OutIdx&&(r=this.AddOutPt(i,i.Top)),n=(i=this.UpdateEdgeIntoAEL(i)).PrevInAEL,t=i.NextInAEL,null!==n&&n.Curr.X===i.Bot.X&&n.Curr.Y===i.Bot.Y&&null!==r&&0<=n.OutIdx&&n.Curr.Y===n.Top.Y&&E.ClipperBase.SlopesEqual5(i.Curr,i.Top,n.Curr,n.Top,this.m_UseFullRange)&&0!==i.WindDelta&&0!==n.WindDelta?(s=this.AddOutPt(ePrev2,i.Bot),this.AddJoin(r,s,i.Top)):null!==t&&t.Curr.X===i.Bot.X&&t.Curr.Y===i.Bot.Y&&null!==r&&0<=t.OutIdx&&t.Curr.Y===t.Top.Y&&E.ClipperBase.SlopesEqual5(i.Curr,i.Top,t.Curr,t.Top,this.m_UseFullRange)&&0!==i.WindDelta&&0!==t.WindDelta&&(s=this.AddOutPt(t,i.Bot),this.AddJoin(r,s,i.Top))),i=i.NextInAEL},E.Clipper.prototype.DoMaxima=function(e){var t=this.GetMaximaPairEx(e);if(null===t)0<=e.OutIdx&&this.AddOutPt(e,e.Top),this.DeleteFromAEL(e);else{for(var i=e.NextInAEL;null!==i&&i!==t;)this.IntersectEdges(e,i,e.Top),this.SwapPositionsInAEL(e,i),i=e.NextInAEL;-1===e.OutIdx&&-1===t.OutIdx?(this.DeleteFromAEL(e),this.DeleteFromAEL(t)):0<=e.OutIdx&&0<=t.OutIdx?(0<=e.OutIdx&&this.AddLocalMaxPoly(e,t,e.Top),this.DeleteFromAEL(e),this.DeleteFromAEL(t)):E.use_lines&&0===e.WindDelta?(0<=e.OutIdx&&(this.AddOutPt(e,e.Top),e.OutIdx=E.ClipperBase.Unassigned),this.DeleteFromAEL(e),0<=t.OutIdx&&(this.AddOutPt(t,e.Top),t.OutIdx=E.ClipperBase.Unassigned),this.DeleteFromAEL(t)):E.Error("DoMaxima error")}},E.Clipper.ReversePaths=function(e){for(var t=0,i=e.length;t<i;t++)e[t].reverse()},E.Clipper.Orientation=function(e){return 0<=E.Clipper.Area(e)},E.Clipper.prototype.PointCount=function(e){if(null===e)return 0;for(var t=0,i=e;t++,(i=i.Next)!==e;);return t},E.Clipper.prototype.BuildResult=function(e){E.Clear(e);for(var t=0,i=this.m_PolyOuts.length;t<i;t++){var n=this.m_PolyOuts[t];if(null!==n.Pts){var o=n.Pts.Prev,r=this.PointCount(o);if(!(r<2)){for(var s=new Array(r),l=0;l<r;l++)s[l]=o.Pt,o=o.Prev;e.push(s)}}}},E.Clipper.prototype.BuildResult2=function(e){e.Clear();for(var t=0,i=this.m_PolyOuts.length;t<i;t++){var n=this.m_PolyOuts[t],o=this.PointCount(n.Pts);if(!(n.IsOpen&&o<2||!n.IsOpen&&o<3)){this.FixHoleLinkage(n);for(var r=new E.PolyNode,s=(e.m_AllPolys.push(r),(n.PolyNode=r).m_polygon.length=o,n.Pts.Prev),l=0;l<o;l++)r.m_polygon[l]=s.Pt,s=s.Prev}}for(t=0,i=this.m_PolyOuts.length;t<i;t++)null!==(n=this.m_PolyOuts[t]).PolyNode&&(n.IsOpen?(n.PolyNode.IsOpen=!0,e):null!==n.FirstLeft&&null!==n.FirstLeft.PolyNode?n.FirstLeft.PolyNode:e).AddChild(n.PolyNode)},E.Clipper.prototype.FixupOutPolyline=function(e){for(var t=(n=e.Pts).Prev;n!==t;){var i,n=n.Next;E.IntPoint.op_Equality(n.Pt,n.Prev.Pt)&&(n===t&&(t=n.Prev),(i=n.Prev).Next=n.Next,n.Next.Prev=i,n=i)}n===n.Prev&&(e.Pts=null)},E.Clipper.prototype.FixupOutPolygon=function(e){for(var t=null,i=(e.BottomPt=null,e.Pts),n=this.PreserveCollinear||this.StrictlySimple;;){if(i.Prev===i||i.Prev===i.Next)return void(e.Pts=null);if(E.IntPoint.op_Equality(i.Pt,i.Next.Pt)||E.IntPoint.op_Equality(i.Pt,i.Prev.Pt)||E.ClipperBase.SlopesEqual4(i.Prev.Pt,i.Pt,i.Next.Pt,this.m_UseFullRange)&&(!n||!this.Pt2IsBetweenPt1AndPt3(i.Prev.Pt,i.Pt,i.Next.Pt)))t=null,i.Prev.Next=i.Next,i.Next.Prev=i.Prev,i=i.Prev;else{if(i===t)break;null===t&&(t=i),i=i.Next}}e.Pts=i},E.Clipper.prototype.DupOutPt=function(e,t){var i=new E.OutPt;return i.Pt.X=e.Pt.X,i.Pt.Y=e.Pt.Y,E.use_xyz&&(i.Pt.Z=e.Pt.Z),i.Idx=e.Idx,t?(i.Next=e.Next,(i.Prev=e).Next.Prev=i,e.Next=i):(i.Prev=e.Prev,(i.Next=e).Prev.Next=i,e.Prev=i),i},E.Clipper.prototype.GetOverlap=function(e,t,i,n,o){return e<t?i<n?(o.Left=Math.max(e,i),o.Right=Math.min(t,n)):(o.Left=Math.max(e,n),o.Right=Math.min(t,i)):i<n?(o.Left=Math.max(t,i),o.Right=Math.min(e,n)):(o.Left=Math.max(t,n),o.Right=Math.min(e,i)),o.Left<o.Right},E.Clipper.prototype.JoinHorz=function(e,t,i,n,o,r){var s=e.Pt.X>t.Pt.X?E.Direction.dRightToLeft:E.Direction.dLeftToRight,l=i.Pt.X>n.Pt.X?E.Direction.dRightToLeft:E.Direction.dLeftToRight;if(s===l)return!1;if(s===E.Direction.dLeftToRight){for(;e.Next.Pt.X<=o.X&&e.Next.Pt.X>=e.Pt.X&&e.Next.Pt.Y===o.Y;)e=e.Next;r&&e.Pt.X!==o.X&&(e=e.Next),t=this.DupOutPt(e,!r),E.IntPoint.op_Inequality(t.Pt,o)&&((e=t).Pt.X=o.X,e.Pt.Y=o.Y,E.use_xyz&&(e.Pt.Z=o.Z),t=this.DupOutPt(e,!r))}else{for(;e.Next.Pt.X>=o.X&&e.Next.Pt.X<=e.Pt.X&&e.Next.Pt.Y===o.Y;)e=e.Next;r||e.Pt.X===o.X||(e=e.Next),t=this.DupOutPt(e,r),E.IntPoint.op_Inequality(t.Pt,o)&&((e=t).Pt.X=o.X,e.Pt.Y=o.Y,E.use_xyz&&(e.Pt.Z=o.Z),t=this.DupOutPt(e,r))}if(l===E.Direction.dLeftToRight){for(;i.Next.Pt.X<=o.X&&i.Next.Pt.X>=i.Pt.X&&i.Next.Pt.Y===o.Y;)i=i.Next;r&&i.Pt.X!==o.X&&(i=i.Next),n=this.DupOutPt(i,!r),E.IntPoint.op_Inequality(n.Pt,o)&&((i=n).Pt.X=o.X,i.Pt.Y=o.Y,E.use_xyz&&(i.Pt.Z=o.Z),n=this.DupOutPt(i,!r))}else{for(;i.Next.Pt.X>=o.X&&i.Next.Pt.X<=i.Pt.X&&i.Next.Pt.Y===o.Y;)i=i.Next;r||i.Pt.X===o.X||(i=i.Next),n=this.DupOutPt(i,r),E.IntPoint.op_Inequality(n.Pt,o)&&((i=n).Pt.X=o.X,i.Pt.Y=o.Y,E.use_xyz&&(i.Pt.Z=o.Z),n=this.DupOutPt(i,r))}return s===E.Direction.dLeftToRight===r?((e.Prev=i).Next=e,(t.Next=n).Prev=t):((e.Next=i).Prev=e,(t.Prev=n).Next=t),!0},E.Clipper.prototype.JoinPoints=function(e,t,i){var n=e.OutPt1,o=new E.OutPt,r=e.OutPt2,s=new E.OutPt,l=e.OutPt1.Pt.Y===e.OffPt.Y;if(l&&E.IntPoint.op_Equality(e.OffPt,e.OutPt1.Pt)&&E.IntPoint.op_Equality(e.OffPt,e.OutPt2.Pt)){if(t!==i)return!1;for(o=e.OutPt1.Next;o!==n&&E.IntPoint.op_Equality(o.Pt,e.OffPt);)o=o.Next;for(var a=o.Pt.Y>e.OffPt.Y,s=e.OutPt2.Next;s!==r&&E.IntPoint.op_Equality(s.Pt,e.OffPt);)s=s.Next;return a==s.Pt.Y>e.OffPt.Y?!1:(a?(o=this.DupOutPt(n,!1),s=this.DupOutPt(r,!0),(n.Prev=r).Next=n,(o.Next=s).Prev=o):(o=this.DupOutPt(n,!0),s=this.DupOutPt(r,!1),(n.Next=r).Prev=n,(o.Prev=s).Next=o),e.OutPt1=n,e.OutPt2=o,!0)}if(l){for(o=n;n.Prev.Pt.Y===n.Pt.Y&&n.Prev!==o&&n.Prev!==r;)n=n.Prev;for(;o.Next.Pt.Y===o.Pt.Y&&o.Next!==n&&o.Next!==r;)o=o.Next;if(o.Next===n||o.Next===r)return!1;for(s=r;r.Prev.Pt.Y===r.Pt.Y&&r.Prev!==s&&r.Prev!==o;)r=r.Prev;for(;s.Next.Pt.Y===s.Pt.Y&&s.Next!==r&&s.Next!==n;)s=s.Next;return s.Next===r||s.Next===n?!1:!!this.GetOverlap(n.Pt.X,o.Pt.X,r.Pt.X,s.Pt.X,a={Left:null,Right:null})&&(l=a.Left,a=a.Right,p=new E.IntPoint0,l=n.Pt.X>=l&&n.Pt.X<=a?(p.X=n.Pt.X,p.Y=n.Pt.Y,E.use_xyz&&(p.Z=n.Pt.Z),n.Pt.X>o.Pt.X):r.Pt.X>=l&&r.Pt.X<=a?(p.X=r.Pt.X,p.Y=r.Pt.Y,E.use_xyz&&(p.Z=r.Pt.Z),r.Pt.X>s.Pt.X):o.Pt.X>=l&&o.Pt.X<=a?(p.X=o.Pt.X,p.Y=o.Pt.Y,E.use_xyz&&(p.Z=o.Pt.Z),o.Pt.X>n.Pt.X):(p.X=s.Pt.X,p.Y=s.Pt.Y,E.use_xyz&&(p.Z=s.Pt.Z),s.Pt.X>r.Pt.X),e.OutPt1=n,e.OutPt2=r,this.JoinHorz(n,o,r,s,p,l))}for(o=n.Next;E.IntPoint.op_Equality(o.Pt,n.Pt)&&o!==n;)o=o.Next;a=o.Pt.Y>n.Pt.Y||!E.ClipperBase.SlopesEqual4(n.Pt,o.Pt,e.OffPt,this.m_UseFullRange);if(a){for(o=n.Prev;E.IntPoint.op_Equality(o.Pt,n.Pt)&&o!==n;)o=o.Prev;if(o.Pt.Y>n.Pt.Y||!E.ClipperBase.SlopesEqual4(n.Pt,o.Pt,e.OffPt,this.m_UseFullRange))return!1}for(s=r.Next;E.IntPoint.op_Equality(s.Pt,r.Pt)&&s!==r;)s=s.Next;var p=s.Pt.Y>r.Pt.Y||!E.ClipperBase.SlopesEqual4(r.Pt,s.Pt,e.OffPt,this.m_UseFullRange);if(p){for(s=r.Prev;E.IntPoint.op_Equality(s.Pt,r.Pt)&&s!==r;)s=s.Prev;if(s.Pt.Y>r.Pt.Y||!E.ClipperBase.SlopesEqual4(r.Pt,s.Pt,e.OffPt,this.m_UseFullRange))return!1}return o!==n&&s!==r&&o!==s&&(t!==i||a!=p)&&(a?(o=this.DupOutPt(n,!1),s=this.DupOutPt(r,!0),(n.Prev=r).Next=n,(o.Next=s).Prev=o):(o=this.DupOutPt(n,!0),s=this.DupOutPt(r,!1),(n.Next=r).Prev=n,(o.Prev=s).Next=o),e.OutPt1=n,e.OutPt2=o,!0)},E.Clipper.GetBounds=function(e){for(var t=0,i=e.length;t<i&&0===e[t].length;)t++;if(t===i)return new E.IntRect(0,0,0,0);var n=new E.IntRect;for(n.left=e[t][0].X,n.right=n.left,n.top=e[t][0].Y,n.bottom=n.top;t<i;t++)for(var o=0,r=e[t].length;o<r;o++)e[t][o].X<n.left?n.left=e[t][o].X:e[t][o].X>n.right&&(n.right=e[t][o].X),e[t][o].Y<n.top?n.top=e[t][o].Y:e[t][o].Y>n.bottom&&(n.bottom=e[t][o].Y);return n},E.Clipper.prototype.GetBounds2=function(e){var t=e,i=new E.IntRect;for(i.left=e.Pt.X,i.right=e.Pt.X,i.top=e.Pt.Y,i.bottom=e.Pt.Y,e=e.Next;e!==t;)e.Pt.X<i.left&&(i.left=e.Pt.X),e.Pt.X>i.right&&(i.right=e.Pt.X),e.Pt.Y<i.top&&(i.top=e.Pt.Y),e.Pt.Y>i.bottom&&(i.bottom=e.Pt.Y),e=e.Next;return i},E.Clipper.PointInPolygon=function(e,t){var i=0,n=t.length;if(n<3)return 0;for(var o=t[0],r=1;r<=n;++r){var s,l=r===n?t[0]:t[r];if(l.Y===e.Y&&(l.X===e.X||o.Y===e.Y&&l.X>e.X==o.X<e.X))return-1;if(o.Y<e.Y!=l.Y<e.Y)if(o.X>=e.X)if(l.X>e.X)i=1-i;else{if(0===(s=(o.X-e.X)*(l.Y-e.Y)-(l.X-e.X)*(o.Y-e.Y)))return-1;0<s==l.Y>o.Y&&(i=1-i)}else if(l.X>e.X){if(0===(s=(o.X-e.X)*(l.Y-e.Y)-(l.X-e.X)*(o.Y-e.Y)))return-1;0<s==l.Y>o.Y&&(i=1-i)}o=l}return i},E.Clipper.prototype.PointInPolygon=function(e,t){var i=0,n=t,o=e.X,r=e.Y,s=t.Pt.X,l=t.Pt.Y;do{var a,p=(t=t.Next).Pt.X,h=t.Pt.Y;if(h===r&&(p===o||l===r&&o<p==s<o))return-1;if(l<r!=h<r)if(o<=s)if(o<p)i=1-i;else{if(0===(a=(s-o)*(h-r)-(p-o)*(l-r)))return-1;0<a==l<h&&(i=1-i)}else if(o<p){if(0===(a=(s-o)*(h-r)-(p-o)*(l-r)))return-1;0<a==l<h&&(i=1-i)}}while(s=p,l=h,n!==t);return i},E.Clipper.prototype.Poly2ContainsPoly1=function(e,t){var i=e;do{var n=this.PointInPolygon(i.Pt,t);if(0<=n)return 0<n}while((i=i.Next)!==e);return!0},E.Clipper.prototype.FixupFirstLefts1=function(e,t){for(var i,n,o=0,r=this.m_PolyOuts.length;o<r;o++)i=this.m_PolyOuts[o],n=E.Clipper.ParseFirstLeft(i.FirstLeft),null!==i.Pts&&n===e&&this.Poly2ContainsPoly1(i.Pts,t.Pts)&&(i.FirstLeft=t)},E.Clipper.prototype.FixupFirstLefts2=function(e,t){for(var i,n,o=t.FirstLeft,r=0,s=this.m_PolyOuts.length;r<s;r++)null===(i=this.m_PolyOuts[r]).Pts||i===t||i===e||(n=E.Clipper.ParseFirstLeft(i.FirstLeft))!==o&&n!==e&&n!==t||(this.Poly2ContainsPoly1(i.Pts,e.Pts)?i.FirstLeft=e:this.Poly2ContainsPoly1(i.Pts,t.Pts)?i.FirstLeft=t:i.FirstLeft!==e&&i.FirstLeft!==t||(i.FirstLeft=o))},E.Clipper.prototype.FixupFirstLefts3=function(e,t){for(var i,n,o=0,r=this.m_PolyOuts.length;o<r;o++)i=this.m_PolyOuts[o],n=E.Clipper.ParseFirstLeft(i.FirstLeft),null!==i.Pts&&n===e&&(i.FirstLeft=t)},E.Clipper.ParseFirstLeft=function(e){for(;null!==e&&null===e.Pts;)e=e.FirstLeft;return e},E.Clipper.prototype.JoinCommonEdges=function(){for(var e=0,t=this.m_Joins.length;e<t;e++){var i,n=this.m_Joins[e],o=this.GetOutRec(n.OutPt1.Idx),r=this.GetOutRec(n.OutPt2.Idx);null===o.Pts||null===r.Pts||o.IsOpen||r.IsOpen||(i=o===r?o:this.OutRec1RightOfOutRec2(o,r)?r:this.OutRec1RightOfOutRec2(r,o)?o:this.GetLowermostRec(o,r),this.JoinPoints(n,o,r)&&(o===r?(o.Pts=n.OutPt1,o.BottomPt=null,(r=this.CreateOutRec()).Pts=n.OutPt2,this.UpdateOutPtIdxs(r),this.Poly2ContainsPoly1(r.Pts,o.Pts)?(r.IsHole=!o.IsHole,r.FirstLeft=o,this.m_UsingPolyTree&&this.FixupFirstLefts2(r,o),(r.IsHole^this.ReverseSolution)==0<this.Area$1(r)&&this.ReversePolyPtLinks(r.Pts)):this.Poly2ContainsPoly1(o.Pts,r.Pts)?(r.IsHole=o.IsHole,o.IsHole=!r.IsHole,r.FirstLeft=o.FirstLeft,o.FirstLeft=r,this.m_UsingPolyTree&&this.FixupFirstLefts2(o,r),(o.IsHole^this.ReverseSolution)==0<this.Area$1(o)&&this.ReversePolyPtLinks(o.Pts)):(r.IsHole=o.IsHole,r.FirstLeft=o.FirstLeft,this.m_UsingPolyTree&&this.FixupFirstLefts1(o,r))):(r.Pts=null,r.BottomPt=null,r.Idx=o.Idx,o.IsHole=i.IsHole,i===r&&(o.FirstLeft=r.FirstLeft),r.FirstLeft=o,this.m_UsingPolyTree&&this.FixupFirstLefts3(r,o))))}},E.Clipper.prototype.UpdateOutPtIdxs=function(e){for(var t=e.Pts;t.Idx=e.Idx,(t=t.Prev)!==e.Pts;);},E.Clipper.prototype.DoSimplePolygons=function(){for(var e=0;e<this.m_PolyOuts.length;){var t=this.m_PolyOuts[e++],i=t.Pts;if(null!==i&&!t.IsOpen)do{for(var n,o,r=i.Next;r!==t.Pts;)E.IntPoint.op_Equality(i.Pt,r.Pt)&&r.Next!==i&&r.Prev!==i&&(n=i.Prev,o=r.Prev,(i.Prev=o).Next=i,(r.Prev=n).Next=r,t.Pts=i,(o=this.CreateOutRec()).Pts=r,this.UpdateOutPtIdxs(o),this.Poly2ContainsPoly1(o.Pts,t.Pts)?(o.IsHole=!t.IsHole,o.FirstLeft=t,this.m_UsingPolyTree&&this.FixupFirstLefts2(o,t)):this.Poly2ContainsPoly1(t.Pts,o.Pts)?(o.IsHole=t.IsHole,t.IsHole=!o.IsHole,o.FirstLeft=t.FirstLeft,t.FirstLeft=o,this.m_UsingPolyTree&&this.FixupFirstLefts2(t,o)):(o.IsHole=t.IsHole,o.FirstLeft=t.FirstLeft,this.m_UsingPolyTree&&this.FixupFirstLefts1(t,o)),r=i),r=r.Next}while((i=i.Next)!==t.Pts)}},E.Clipper.Area=function(e){if(!Array.isArray(e))return 0;var t=e.length;if(t<3)return 0;for(var i=0,n=0,o=t-1;n<t;++n)i+=(e[o].X+e[n].X)*(e[o].Y-e[n].Y),o=n;return.5*-i},E.Clipper.prototype.Area=function(e){var t=e;if(null===e)return 0;for(var i=0;i+=(e.Prev.Pt.X+e.Pt.X)*(e.Prev.Pt.Y-e.Pt.Y),(e=e.Next)!==t;);return.5*i},E.Clipper.prototype.Area$1=function(e){return this.Area(e.Pts)},E.Clipper.SimplifyPolygon=function(e,t){var i=new Array,n=new E.Clipper(0);return n.StrictlySimple=!0,n.AddPath(e,E.PolyType.ptSubject,!0),n.Execute(E.ClipType.ctUnion,i,t,t),i},E.Clipper.SimplifyPolygons=function(e,t){void 0===t&&(t=E.PolyFillType.pftEvenOdd);var i=new Array,n=new E.Clipper(0);return n.StrictlySimple=!0,n.AddPaths(e,E.PolyType.ptSubject,!0),n.Execute(E.ClipType.ctUnion,i,t,t),i},E.Clipper.DistanceSqrd=function(e,t){var i=e.X-t.X,e=e.Y-t.Y;return i*i+e*e},E.Clipper.DistanceFromLineSqrd=function(e,t,i){var n=t.Y-i.Y,i=i.X-t.X,t=n*t.X+i*t.Y;return(t=n*e.X+i*e.Y-t)*t/(n*n+i*i)},E.Clipper.SlopesNearCollinear=function(e,t,i,n){return Math.abs(e.X-t.X)>Math.abs(e.Y-t.Y)?e.X>t.X==e.X<i.X?E.Clipper.DistanceFromLineSqrd(e,t,i)<n:t.X>e.X==t.X<i.X?E.Clipper.DistanceFromLineSqrd(t,e,i)<n:E.Clipper.DistanceFromLineSqrd(i,e,t)<n:e.Y>t.Y==e.Y<i.Y?E.Clipper.DistanceFromLineSqrd(e,t,i)<n:t.Y>e.Y==t.Y<i.Y?E.Clipper.DistanceFromLineSqrd(t,e,i)<n:E.Clipper.DistanceFromLineSqrd(i,e,t)<n},E.Clipper.PointsAreClose=function(e,t,i){var n=e.X-t.X,e=e.Y-t.Y;return n*n+e*e<=i},E.Clipper.ExcludeOp=function(e){var t=e.Prev;return t.Next=e.Next,(e.Next.Prev=t).Idx=0,t},E.Clipper.CleanPolygon=function(e,t){void 0===t&&(t=1.415);var i=e.length;if(0===i)return new Array;for(var n=new Array(i),o=0;o<i;++o)n[o]=new E.OutPt;for(o=0;o<i;++o)n[o].Pt=e[o],n[o].Next=n[(o+1)%i],n[o].Next.Prev=n[o],n[o].Idx=0;for(var r=t*t,s=n[0];0===s.Idx&&s.Next!==s.Prev;)E.Clipper.PointsAreClose(s.Pt,s.Prev.Pt,r)?(s=E.Clipper.ExcludeOp(s),i--):E.Clipper.PointsAreClose(s.Prev.Pt,s.Next.Pt,r)?(E.Clipper.ExcludeOp(s.Next),s=E.Clipper.ExcludeOp(s),i-=2):E.Clipper.SlopesNearCollinear(s.Prev.Pt,s.Pt,s.Next.Pt,r)?(s=E.Clipper.ExcludeOp(s),i--):(s.Idx=1,s=s.Next);i<3&&(i=0);for(var l=new Array(i),o=0;o<i;++o)l[o]=new E.IntPoint1(s.Pt),s=s.Next;return n=null,l},E.Clipper.CleanPolygons=function(e,t){for(var i=new Array(e.length),n=0,o=e.length;n<o;n++)i[n]=E.Clipper.CleanPolygon(e[n],t);return i},E.Clipper.Minkowski=function(e,t,i,n){var o=n?1:0,r=e.length,s=t.length,l=new Array;if(i)for(var a=0;a<s;a++){for(var p=new Array(r),h=0,d=e.length,c=e[h];h<d;c=e[++h])p[h]=new E.IntPoint2(t[a].X+c.X,t[a].Y+c.Y);l.push(p)}else for(a=0;a<s;a++){for(p=new Array(r),h=0,d=e.length,c=e[h];h<d;c=e[++h])p[h]=new E.IntPoint2(t[a].X-c.X,t[a].Y-c.Y);l.push(p)}for(var u=new Array,a=0;a<s-1+o;a++)for(h=0;h<r;h++){var f=new Array;f.push(l[a%s][h%r]),f.push(l[(a+1)%s][h%r]),f.push(l[(a+1)%s][(h+1)%r]),f.push(l[a%s][(h+1)%r]),E.Clipper.Orientation(f)||f.reverse(),u.push(f)}return u},E.Clipper.MinkowskiSum=function(e,t,i){if(t[0]instanceof Array){for(var n=t,o=new E.Paths,r=new E.Clipper,s=0;s<n.length;++s){var l,a=E.Clipper.Minkowski(e,n[s],!0,i);r.AddPaths(a,E.PolyType.ptSubject,!0),i&&(l=E.Clipper.TranslatePath(n[s],e[0]),r.AddPath(l,E.PolyType.ptClip,!0))}return r.Execute(E.ClipType.ctUnion,o,E.PolyFillType.pftNonZero,E.PolyFillType.pftNonZero),o}return n=E.Clipper.Minkowski(e,l=t,!0,i),(r=new E.Clipper).AddPaths(n,E.PolyType.ptSubject,!0),r.Execute(E.ClipType.ctUnion,n,E.PolyFillType.pftNonZero,E.PolyFillType.pftNonZero),n},E.Clipper.TranslatePath=function(e,t){for(var i=new E.Path,n=0;n<e.length;n++)i.push(new E.IntPoint2(e[n].X+t.X,e[n].Y+t.Y));return i},E.Clipper.MinkowskiDiff=function(e,t){e=E.Clipper.Minkowski(e,t,!1,!0),t=new E.Clipper;return t.AddPaths(e,E.PolyType.ptSubject,!0),t.Execute(E.ClipType.ctUnion,e,E.PolyFillType.pftNonZero,E.PolyFillType.pftNonZero),e},E.Clipper.PolyTreeToPaths=function(e){var t=new Array;return E.Clipper.AddPolyNodeToPaths(e,E.Clipper.NodeType.ntAny,t),t},E.Clipper.AddPolyNodeToPaths=function(e,t,i){var n=!0;switch(t){case E.Clipper.NodeType.ntOpen:return;case E.Clipper.NodeType.ntClosed:n=!e.IsOpen}0<e.m_polygon.length&&n&&i.push(e.m_polygon);for(var o=0,r=e.Childs(),s=r.length,l=r[o];o<s;l=r[++o])E.Clipper.AddPolyNodeToPaths(l,t,i)},E.Clipper.OpenPathsFromPolyTree=function(e){for(var t=new E.Paths,i=0,n=e.ChildCount();i<n;i++)e.Childs()[i].IsOpen&&t.push(e.Childs()[i].m_polygon);return t},E.Clipper.ClosedPathsFromPolyTree=function(e){var t=new E.Paths;return E.Clipper.AddPolyNodeToPaths(e,E.Clipper.NodeType.ntClosed,t),t},S(E.Clipper,E.ClipperBase),E.Clipper.NodeType={ntAny:0,ntOpen:1,ntClosed:2},E.ClipperOffset=function(e,t){void 0===e&&(e=2),void 0===t&&(t=E.ClipperOffset.def_arc_tolerance),this.m_destPolys=new E.Paths,this.m_srcPoly=new E.Path,this.m_destPoly=new E.Path,this.m_normals=new Array,this.m_delta=0,this.m_sinA=0,this.m_sin=0,this.m_cos=0,this.m_miterLim=0,this.m_StepsPerRad=0,this.m_lowest=new E.IntPoint0,this.m_polyNodes=new E.PolyNode,this.MiterLimit=e,this.ArcTolerance=t,this.m_lowest.X=-1},E.ClipperOffset.two_pi=6.28318530717959,E.ClipperOffset.def_arc_tolerance=.25,E.ClipperOffset.prototype.Clear=function(){E.Clear(this.m_polyNodes.Childs()),this.m_lowest.X=-1},E.ClipperOffset.Round=E.Clipper.Round,E.ClipperOffset.prototype.AddPath=function(e,t,i){var n=e.length-1;if(!(n<0)){var o=new E.PolyNode;if(o.m_jointype=t,(o.m_endtype=i)===E.EndType.etClosedLine||i===E.EndType.etClosedPolygon)for(;0<n&&E.IntPoint.op_Equality(e[0],e[n]);)n--;o.m_polygon.push(e[0]);for(var r=0,s=0,l=1;l<=n;l++)E.IntPoint.op_Inequality(o.m_polygon[r],e[l])&&(r++,o.m_polygon.push(e[l]),e[l].Y>o.m_polygon[s].Y||e[l].Y===o.m_polygon[s].Y&&e[l].X<o.m_polygon[s].X)&&(s=r);i===E.EndType.etClosedPolygon&&r<2||(this.m_polyNodes.AddChild(o),i===E.EndType.etClosedPolygon&&(this.m_lowest.X<0||(t=this.m_polyNodes.Childs()[this.m_lowest.X].m_polygon[this.m_lowest.Y],o.m_polygon[s].Y>t.Y)||o.m_polygon[s].Y===t.Y&&o.m_polygon[s].X<t.X)&&(this.m_lowest=new E.IntPoint2(this.m_polyNodes.ChildCount()-1,s)))}},E.ClipperOffset.prototype.AddPaths=function(e,t,i){for(var n=0,o=e.length;n<o;n++)this.AddPath(e[n],t,i)},E.ClipperOffset.prototype.FixOrientations=function(){if(0<=this.m_lowest.X&&!E.Clipper.Orientation(this.m_polyNodes.Childs()[this.m_lowest.X].m_polygon))for(var e=0;e<this.m_polyNodes.ChildCount();e++)((t=this.m_polyNodes.Childs()[e]).m_endtype===E.EndType.etClosedPolygon||t.m_endtype===E.EndType.etClosedLine&&E.Clipper.Orientation(t.m_polygon))&&t.m_polygon.reverse();else for(var t,e=0;e<this.m_polyNodes.ChildCount();e++)(t=this.m_polyNodes.Childs()[e]).m_endtype!==E.EndType.etClosedLine||E.Clipper.Orientation(t.m_polygon)||t.m_polygon.reverse()},E.ClipperOffset.GetUnitNormal=function(e,t){var i=t.X-e.X,t=t.Y-e.Y;return 0==i&&0==t?new E.DoublePoint2(0,0):(e=1/Math.sqrt(i*i+t*t),new E.DoublePoint2(t*=e,-(i*=e)))},E.ClipperOffset.prototype.DoOffset=function(e){if(this.m_destPolys=new Array,this.m_delta=e,E.ClipperBase.near_zero(e))for(var t=0;t<this.m_polyNodes.ChildCount();t++)(o=this.m_polyNodes.Childs()[t]).m_endtype===E.EndType.etClosedPolygon&&this.m_destPolys.push(o.m_polygon);else{2<this.MiterLimit?this.m_miterLim=2/(this.MiterLimit*this.MiterLimit):this.m_miterLim=.5,i=this.ArcTolerance<=0?E.ClipperOffset.def_arc_tolerance:this.ArcTolerance>Math.abs(e)*E.ClipperOffset.def_arc_tolerance?Math.abs(e)*E.ClipperOffset.def_arc_tolerance:this.ArcTolerance;var i,n=3.14159265358979/Math.acos(1-i/Math.abs(e));this.m_sin=Math.sin(E.ClipperOffset.two_pi/n),this.m_cos=Math.cos(E.ClipperOffset.two_pi/n),this.m_StepsPerRad=n/E.ClipperOffset.two_pi,e<0&&(this.m_sin=-this.m_sin);for(t=0;t<this.m_polyNodes.ChildCount();t++){var o=this.m_polyNodes.Childs()[t],r=(this.m_srcPoly=o.m_polygon,this.m_srcPoly.length);if(!(0===r||e<=0&&(r<3||o.m_endtype!==E.EndType.etClosedPolygon))){if(this.m_destPoly=new Array,1===r)if(o.m_jointype===E.JoinType.jtRound)for(var s=1,l=0,a=1;a<=n;a++){this.m_destPoly.push(new E.IntPoint2(E.ClipperOffset.Round(this.m_srcPoly[0].X+s*e),E.ClipperOffset.Round(this.m_srcPoly[0].Y+l*e)));var p=s;s=s*this.m_cos-this.m_sin*l,l=p*this.m_sin+l*this.m_cos}else for(s=-1,l=-1,a=0;a<4;++a)this.m_destPoly.push(new E.IntPoint2(E.ClipperOffset.Round(this.m_srcPoly[0].X+s*e),E.ClipperOffset.Round(this.m_srcPoly[0].Y+l*e))),s<0?s=1:l<0?l=1:s=-1;else{for(a=this.m_normals.length=0;a<r-1;a++)this.m_normals.push(E.ClipperOffset.GetUnitNormal(this.m_srcPoly[a],this.m_srcPoly[a+1]));if(o.m_endtype===E.EndType.etClosedLine||o.m_endtype===E.EndType.etClosedPolygon?this.m_normals.push(E.ClipperOffset.GetUnitNormal(this.m_srcPoly[r-1],this.m_srcPoly[0])):this.m_normals.push(new E.DoublePoint1(this.m_normals[r-2])),o.m_endtype===E.EndType.etClosedPolygon)for(var h=r-1,a=0;a<r;a++)h=this.OffsetPoint(a,h,o.m_jointype);else if(o.m_endtype===E.EndType.etClosedLine){for(h=r-1,a=0;a<r;a++)h=this.OffsetPoint(a,h,o.m_jointype);this.m_destPolys.push(this.m_destPoly),this.m_destPoly=new Array;for(var d=this.m_normals[r-1],a=r-1;0<a;a--)this.m_normals[a]=new E.DoublePoint2(-this.m_normals[a-1].X,-this.m_normals[a-1].Y);this.m_normals[0]=new E.DoublePoint2(-d.X,-d.Y),h=0;for(a=r-1;0<=a;a--)h=this.OffsetPoint(a,h,o.m_jointype)}else{for(var c,h=0,a=1;a<r-1;++a)h=this.OffsetPoint(a,h,o.m_jointype);o.m_endtype===E.EndType.etOpenButt?(c=new E.IntPoint2(E.ClipperOffset.Round(this.m_srcPoly[a=r-1].X+this.m_normals[a].X*e),E.ClipperOffset.Round(this.m_srcPoly[a].Y+this.m_normals[a].Y*e)),this.m_destPoly.push(c),c=new E.IntPoint2(E.ClipperOffset.Round(this.m_srcPoly[a].X-this.m_normals[a].X*e),E.ClipperOffset.Round(this.m_srcPoly[a].Y-this.m_normals[a].Y*e)),this.m_destPoly.push(c)):(a=r-1,h=r-2,this.m_sinA=0,this.m_normals[a]=new E.DoublePoint2(-this.m_normals[a].X,-this.m_normals[a].Y),o.m_endtype===E.EndType.etOpenSquare?this.DoSquare(a,h):this.DoRound(a,h));for(a=r-1;0<a;a--)this.m_normals[a]=new E.DoublePoint2(-this.m_normals[a-1].X,-this.m_normals[a-1].Y);this.m_normals[0]=new E.DoublePoint2(-this.m_normals[1].X,-this.m_normals[1].Y);for(a=(h=r-1)-1;0<a;--a)h=this.OffsetPoint(a,h,o.m_jointype);o.m_endtype===E.EndType.etOpenButt?(c=new E.IntPoint2(E.ClipperOffset.Round(this.m_srcPoly[0].X-this.m_normals[0].X*e),E.ClipperOffset.Round(this.m_srcPoly[0].Y-this.m_normals[0].Y*e)),this.m_destPoly.push(c),c=new E.IntPoint2(E.ClipperOffset.Round(this.m_srcPoly[0].X+this.m_normals[0].X*e),E.ClipperOffset.Round(this.m_srcPoly[0].Y+this.m_normals[0].Y*e)),this.m_destPoly.push(c)):(h=1,this.m_sinA=0,o.m_endtype===E.EndType.etOpenSquare?this.DoSquare(0,1):this.DoRound(0,1))}}this.m_destPolys.push(this.m_destPoly)}}}},E.ClipperOffset.prototype.Execute=function(){var e=arguments;if(e[0]instanceof E.PolyTree){s=e[0],l=e[1];if(s.Clear(),this.FixOrientations(),this.DoOffset(l),(n=new E.Clipper(0)).AddPaths(this.m_destPolys,E.PolyType.ptSubject,!0),0<l)n.Execute(E.ClipType.ctUnion,s,E.PolyFillType.pftPositive,E.PolyFillType.pftPositive);else{o=E.Clipper.GetBounds(this.m_destPolys);if((r=new E.Path).push(new E.IntPoint2(o.left-10,o.bottom+10)),r.push(new E.IntPoint2(o.right+10,o.bottom+10)),r.push(new E.IntPoint2(o.right+10,o.top-10)),r.push(new E.IntPoint2(o.left-10,o.top-10)),n.AddPath(r,E.PolyType.ptSubject,!0),n.ReverseSolution=!0,n.Execute(E.ClipType.ctUnion,s,E.PolyFillType.pftNegative,E.PolyFillType.pftNegative),1===s.ChildCount()&&0<s.Childs()[0].ChildCount()){var t=s.Childs()[0];s.Childs()[0]=t.Childs()[0],s.Childs()[0].m_Parent=s;for(var i=1;i<t.ChildCount();i++)s.AddChild(t.Childs()[i])}else s.Clear()}}else{var n,o,r,s=e[0],l=e[1];E.Clear(s),this.FixOrientations(),this.DoOffset(l),(n=new E.Clipper(0)).AddPaths(this.m_destPolys,E.PolyType.ptSubject,!0),0<l?n.Execute(E.ClipType.ctUnion,s,E.PolyFillType.pftPositive,E.PolyFillType.pftPositive):(o=E.Clipper.GetBounds(this.m_destPolys),(r=new E.Path).push(new E.IntPoint2(o.left-10,o.bottom+10)),r.push(new E.IntPoint2(o.right+10,o.bottom+10)),r.push(new E.IntPoint2(o.right+10,o.top-10)),r.push(new E.IntPoint2(o.left-10,o.top-10)),n.AddPath(r,E.PolyType.ptSubject,!0),n.ReverseSolution=!0,n.Execute(E.ClipType.ctUnion,s,E.PolyFillType.pftNegative,E.PolyFillType.pftNegative),0<s.length&&s.splice(0,1))}},E.ClipperOffset.prototype.OffsetPoint=function(e,t,i){if(this.m_sinA=this.m_normals[t].X*this.m_normals[e].Y-this.m_normals[e].X*this.m_normals[t].Y,Math.abs(this.m_sinA*this.m_delta)<1){if(0<this.m_normals[t].X*this.m_normals[e].X+this.m_normals[e].Y*this.m_normals[t].Y)return this.m_destPoly.push(new E.IntPoint2(E.ClipperOffset.Round(this.m_srcPoly[e].X+this.m_normals[t].X*this.m_delta),E.ClipperOffset.Round(this.m_srcPoly[e].Y+this.m_normals[t].Y*this.m_delta))),t}else 1<this.m_sinA?this.m_sinA=1:this.m_sinA<-1&&(this.m_sinA=-1);if(this.m_sinA*this.m_delta<0)this.m_destPoly.push(new E.IntPoint2(E.ClipperOffset.Round(this.m_srcPoly[e].X+this.m_normals[t].X*this.m_delta),E.ClipperOffset.Round(this.m_srcPoly[e].Y+this.m_normals[t].Y*this.m_delta))),this.m_destPoly.push(new E.IntPoint1(this.m_srcPoly[e])),this.m_destPoly.push(new E.IntPoint2(E.ClipperOffset.Round(this.m_srcPoly[e].X+this.m_normals[e].X*this.m_delta),E.ClipperOffset.Round(this.m_srcPoly[e].Y+this.m_normals[e].Y*this.m_delta)));else switch(i){case E.JoinType.jtMiter:var n=this.m_normals[e].X*this.m_normals[t].X+this.m_normals[e].Y*this.m_normals[t].Y+1;n>=this.m_miterLim?this.DoMiter(e,t,n):this.DoSquare(e,t);break;case E.JoinType.jtSquare:this.DoSquare(e,t);break;case E.JoinType.jtRound:this.DoRound(e,t)}return t=e},E.ClipperOffset.prototype.DoSquare=function(e,t){var i=Math.tan(Math.atan2(this.m_sinA,this.m_normals[t].X*this.m_normals[e].X+this.m_normals[t].Y*this.m_normals[e].Y)/4);this.m_destPoly.push(new E.IntPoint2(E.ClipperOffset.Round(this.m_srcPoly[e].X+this.m_delta*(this.m_normals[t].X-this.m_normals[t].Y*i)),E.ClipperOffset.Round(this.m_srcPoly[e].Y+this.m_delta*(this.m_normals[t].Y+this.m_normals[t].X*i)))),this.m_destPoly.push(new E.IntPoint2(E.ClipperOffset.Round(this.m_srcPoly[e].X+this.m_delta*(this.m_normals[e].X+this.m_normals[e].Y*i)),E.ClipperOffset.Round(this.m_srcPoly[e].Y+this.m_delta*(this.m_normals[e].Y-this.m_normals[e].X*i))))},E.ClipperOffset.prototype.DoMiter=function(e,t,i){i=this.m_delta/i;this.m_destPoly.push(new E.IntPoint2(E.ClipperOffset.Round(this.m_srcPoly[e].X+(this.m_normals[t].X+this.m_normals[e].X)*i),E.ClipperOffset.Round(this.m_srcPoly[e].Y+(this.m_normals[t].Y+this.m_normals[e].Y)*i)))},E.ClipperOffset.prototype.DoRound=function(e,t){for(var i,n=Math.atan2(this.m_sinA,this.m_normals[t].X*this.m_normals[e].X+this.m_normals[t].Y*this.m_normals[e].Y),o=Math.max(E.Cast_Int32(E.ClipperOffset.Round(this.m_StepsPerRad*Math.abs(n))),1),r=this.m_normals[t].X,s=this.m_normals[t].Y,l=0;l<o;++l)this.m_destPoly.push(new E.IntPoint2(E.ClipperOffset.Round(this.m_srcPoly[e].X+r*this.m_delta),E.ClipperOffset.Round(this.m_srcPoly[e].Y+s*this.m_delta))),r=(i=r)*this.m_cos-this.m_sin*s,s=i*this.m_sin+s*this.m_cos;this.m_destPoly.push(new E.IntPoint2(E.ClipperOffset.Round(this.m_srcPoly[e].X+this.m_normals[e].X*this.m_delta),E.ClipperOffset.Round(this.m_srcPoly[e].Y+this.m_normals[e].Y*this.m_delta)))},E.Error=function(e){try{throw new Error(e)}catch(e){alert(e.message)}},E.JS={},E.JS.AreaOfPolygon=function(e,t){return t=t||1,E.Clipper.Area(e)/(t*t)},E.JS.AreaOfPolygons=function(e,t){t=t||1;for(var i=0,n=0;n<e.length;n++)i+=E.Clipper.Area(e[n]);return i/(t*t)},E.JS.BoundsOfPath=function(e,t){return E.JS.BoundsOfPaths([e],t)},E.JS.BoundsOfPaths=function(e,t){t=t||1;e=E.Clipper.GetBounds(e);return e.left/=t,e.bottom/=t,e.right/=t,e.top/=t,e},E.JS.Clean=function(e,t){if(!(e instanceof Array))return[];var i=e[0]instanceof Array,e=E.JS.Clone(e);if("number"!=typeof t||null===t)return E.Error("Delta is not a number in Clean()."),e;if(0===e.length||1===e.length&&0===e[0].length||t<0)return e;for(var n,o,r,s,l,a,p,h=(e=i?e:[e]).length,d=[],c=0;c<h;c++)if(0!==(n=(o=e[c]).length))if(n<3)d.push(r=o);else{for(s=t*t,l=(r=o)[0],p=a=1;p<n;p++)(o[p].X-l.X)*(o[p].X-l.X)+(o[p].Y-l.Y)*(o[p].Y-l.Y)<=s||(r[a]=o[p],l=o[p],a++);l=o[a-1],(o[0].X-l.X)*(o[0].X-l.X)+(o[0].Y-l.Y)*(o[0].Y-l.Y)<=s&&a--,a<n&&r.splice(a,n-a),r.length&&d.push(r)}return!i&&d.length?d=d[0]:i||0!==d.length?i&&0===d.length&&(d=[[]]):d=[],d},E.JS.Clone=function(e){if(!(e instanceof Array))return[];if(0===e.length)return[];if(1===e.length&&0===e[0].length)return[[]];for(var t,i,n,o=e[0]instanceof Array,r=(e=o?e:[e]).length,s=new Array(r),l=0;l<r;l++){for(t=e[l].length,n=new Array(t),i=0;i<t;i++)n[i]={X:e[l][i].X,Y:e[l][i].Y};s[l]=n}return s=o?s:s[0]},E.JS.Lighten=function(e,t){if(!(e instanceof Array))return[];if("number"!=typeof t||null===t)return E.Error("Tolerance is not a number in Lighten()."),E.JS.Clone(e);if(0===e.length||1===e.length&&0===e[0].length||t<0)return E.JS.Clone(e);for(var i,n,o,r,s,l,a,p,h,d,c,u,f,m,g=e[0]instanceof Array,_=(e=g?e:[e]).length,C=t*t,P=[],y=0;y<_;y++)if(0!==(s=(n=e[y]).length)){for(o=0;o<1e6;o++){for(r=[],n[(s=n.length)-1].X!==n[0].X||n[s-1].Y!==n[0].Y?(h=1,n.push({X:n[0].X,Y:n[0].Y}),s=n.length):h=0,p=[],i=0;i<s-2;i++)m=n[i],a=n[i+1],l=n[i+2],f=m.X,m=m.Y,d=l.X-f,c=l.Y-m,0==d&&0==c||(1<(u=((a.X-f)*d+(a.Y-m)*c)/(d*d+c*c))?(f=l.X,m=l.Y):0<u&&(f+=d*u,m+=c*u)),(d=a.X-f)*d+(c=a.Y-m)*c<=C&&(p[i+1]=1,i++);for(r.push({X:n[0].X,Y:n[0].Y}),i=1;i<s-1;i++)p[i]||r.push({X:n[i].X,Y:n[i].Y});if(r.push({X:n[s-1].X,Y:n[s-1].Y}),h&&n.pop(),!p.length)break;n=r}r[(s=r.length)-1].X===r[0].X&&r[s-1].Y===r[0].Y&&r.pop(),2<r.length&&P.push(r)}return P=void 0===(P=g?P:P[0])?[]:P},E.JS.PerimeterOfPath=function(e,t,i){if(void 0===e)return 0;var n,o,r,s,l=Math.sqrt,a=0,p=e.length;if(p<2)return 0;for(t&&(e[p]=e[0],p++);--p;)s=(o=e[p]).X,o=o.Y,a+=l((s-(r=(n=e[p-1]).X))*(s-r)+(o-(s=n.Y))*(o-s));return t&&e.pop(),a/i},E.JS.PerimeterOfPaths=function(e,t,i){i=i||1;for(var n=0,o=0;o<e.length;o++)n+=E.JS.PerimeterOfPath(e[o],t,i);return n},E.JS.ScaleDownPath=function(e,t){var i,n;for(t=t||1,i=e.length;i--;)(n=e[i]).X=n.X/t,n.Y=n.Y/t},E.JS.ScaleDownPaths=function(e,t){var i,n,o;for(t=t||1,i=e.length;i--;)for(n=e[i].length;n--;)(o=e[i][n]).X=o.X/t,o.Y=o.Y/t},E.JS.ScaleUpPath=function(e,t){var i,n,o=Math.round;for(t=t||1,i=e.length;i--;)(n=e[i]).X=o(n.X*t),n.Y=o(n.Y*t)},E.JS.ScaleUpPaths=function(e,t){var i,n,o,r=Math.round;for(t=t||1,i=e.length;i--;)for(n=e[i].length;n--;)(o=e[i][n]).X=r(o.X*t),o.Y=r(o.Y*t)},E.ExPolygons=function(){return[]},E.ExPolygon=function(){this.outer=null,this.holes=null},E.JS.AddOuterPolyNodeToExPolygons=function(e,t){var i,n,o,r,s,l,a=new E.ExPolygon,p=(a.outer=e.Contour(),e.Childs()),h=p.length;for(a.holes=new Array(h),o=0;o<h;o++)for(i=p[o],a.holes[o]=i.Contour(),r=0,l=(s=i.Childs()).length;r<l;r++)n=s[r],E.JS.AddOuterPolyNodeToExPolygons(n,t);t.push(a)},E.JS.ExPolygonsToPaths=function(e){for(var t,i,n=new E.Paths,o=0,r=e.length;o<r;o++)for(n.push(e[o].outer),t=0,i=e[o].holes.length;t<i;t++)n.push(e[o].holes[t]);return n},E.JS.PolyTreeToExPolygons=function(e){for(var t,i=new E.ExPolygons,n=0,o=e.Childs(),r=o.length;n<r;n++)t=o[n],E.JS.AddOuterPolyNodeToExPolygons(t,i);return i}}.call(this,w(1)(e))},function(e,t){e.exports=function(e){var t;return e.webpackPolyfill||((t=Object.create(e)).children||(t.children=[]),Object.defineProperty(t,"loaded",{enumerable:!0,get:function(){return t.l}}),Object.defineProperty(t,"id",{enumerable:!0,get:function(){return t.i}}),Object.defineProperty(t,"exports",{enumerable:!0}),t.webpackPolyfill=1),t}},function(t,e){!function(e){t.exports=e}.call(this,{})},function(A,e,t){t.r(e);console.log("NDS ExtensionFramework V0.1");let i={FLAG_ENABLE_NODE_TRANSFORM:NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM,FLAG_ENABLE_NODE_STOREVIEW:NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM<<1,FLAG_ENABLE_NODE_CAMERA2D:NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM<<2,FLAG_ENABLE_NODE_BLOCK:NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM<<3,FLAG_ENABLE_NODE_TEXT:NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM<<4,FLAG_ENABLE_NODE_BROADCAST:NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM<<5};class L extends NDSWebViewer.Extension{constructor(){super()}onLoad(e){}onInitLights(){}update(e){}setFlags(e){super.setFlags(e)}onNdsModelPrepareForRendering(e){}onBeforeNdsModelUpdate(e,t){}onAfterNdsModelUpdate(e,t){}onBeforeNdsModelSetRender(e,t){}onAfterNdsModelSetRender(e,t){}onBeforeNdsMeshRender(e,t){}onAfterAllNdsModelSetRender(e,t){}onBeforeScreenCapture(e){}onAfterScreenCapture(){}onSetCaptureView(e,t){}getExtensionWithFlags(e){return NDSWebViewer.ExtensionManager.getExtensionWithFlags(e)}resetToDefault(){}needDisableInputEvent(){return!1}getStoreInfo(e){throw this.name+" Extesion did not implement method 'getStoreInfo' "}setStoreInfo(e){throw this.name+" Extesion did not implement method 'setStoreInfo' "}getBodyTransform(e){return new THREE.Matrix4}getBodyNodeTranslate(e){return new THREE.Vector3(0,0,0)}}class n{constructor(e){this.__coreView__=e}addEventListener(e,t){this.__coreView__.addEventListener(e,t)}hasEventListener(e,t){return this.__coreView__.hasEventListener(e,t)}removeEventListener(e,t){this.__coreView__.removeEventListener(e,t)}dispatchEvent(e){this.__coreView__.dispatchEvent(e)}getPixelRatio(){return this.__coreView__.renderer.getPixelRatio()}switchRotateCenterBySelection(){this.__coreView__.switchRotateCenterBySelection()}setDefaultEnvMap(e){e&&(this.__coreView__.hasPbrMaterial=!0,this.__coreView__.setDefaultEnvMap=()=>{this.__coreView__.setEnvMapEnabled(!0),this.__coreView__.defaultEnvMapTexture=e,this.__coreView__.updateEnvMap(this.__coreView__.defaultEnvMapTexture)},this.__coreView__.setDefaultEnvMap())}getBackgroundState(){return this.__coreView__.exchangeBackImage?{type:this.__coreView__.exchangeBackImage.type,value:this.__coreView__.exchangeBackImage.value}:void 0}setBackgroundState(e,t){"Image"===e?(this.__coreView__.setEnvMapTextures(null),this.__coreView__.setBackGroundImage(t)):"EnvMap"===e?this.__coreView__.setEnvMapTextures(t):"Color"===e&&(this.__coreView__.setEnvMapTextures(null),this.__coreView__.setBackGroundImage(null),this.__coreView__.setBackGroundColor(t))}removeAllLights(){this.__coreView__.lights.length=0}getLight(e){return this.__coreView__.lights[e]}setLight(e,t){this.__coreView__.lights[e]=t}getViewBox(){return this.__coreView__.viewBox}toggleAutoRotation(e){this.__coreView__.toggleAutoRotation(e)}randColor(){return this.__coreView__.materialsSetting.randColor()}getBoundingBox(e=!0){e=this.__coreView__.ndsModel.getTotalBodyBoundingBox(null,e);return e.isEmpty()?this.__coreView__.modelRootObject.boundingBox:e}getModelUnit(){return this.__coreView__.modelUnit}getModelTree(){return this.__coreView__.getModelTree()}getModelCount(){return this.__coreView__.ndsModel.models.length}setActiveModel(e){this.__coreView__.ndsModel.setActiveModel(e)}setActiveModelByModel(e){this.__coreView__.ndsModel.activeModel=e}setActiveModelByModelId(t){let i=-1;for(let e=0;e<this.__coreView__.ndsModel.models.length;++e)if(this.__coreView__.ndsModel.models[e].id===t){i=e;break}this.setActiveModel(i)}getActiveModel(){return this.__coreView__.ndsModel.getActiveModel()}getModelById(e){return this.__coreView__.ndsModel.getModelById(e)}getModelIndexByModelId(t){var i=this.__coreView__.ndsModel;for(let e=0;e<i.models.length;++e)if(i.models[e].id===t)return e}getModelByIndex(e){return this.__coreView__.ndsModel.models[e]}getMeshManager(){return this.__coreView__.ndsModel.meshManager}registOperator(e,t){this.__coreView__.registOperator(e,t)}setOperatorByID(e){this.__coreView__.setOperatorByID(e)}getCurrentOperator(){return this.__coreView__.controls.getOperator()}getCurrentOperatorID(){return this.__coreView__.getCurrentOperatorID()}setOperator(e){this.__coreView__.setOperator(e)}registCursor(e,t,i){this.__coreView__.registCursor(e,t,i)}hideSelectedObjects(){this.__coreView__.hideSelectedObjects()}getViewControlBoundingBox(){return this.__coreView__.controls.getBoundingBox()}setViewControlBoundingBox(e,t){this.__coreView__.controls.setBoundingBox(e,t)}getCamera(){return this.__coreView__.camera}setCameraControlBoundingBoxCenter(e){this.__coreView__.cameraControl.setBoundingBoxCenter(e)}setCameraControlBounding(e,t){this.__coreView__.cameraControl.setBoundingBox(e,t)}getRotateCenter(){return this.__coreView__.cameraControl.getRotateCenter()}setRotateCenter(e){this.__coreView__.cameraControl.setRotateCenter(e)}getViewLockedState(){return this.__coreView__.cameraControl.isViewLockedBySingleBody}setViewLockedState(e){this.__coreView__.cameraControl.isViewLockedBySingleBody=e}getCameraInfo(){return this.__coreView__.cameraControl.getCameraInfo()}adjustNearAndFar(){this.__coreView__.cameraControl.adjustNearAndFar()}updateViewBoxCamDir(){this.__coreView__.cameraControl.updateViewBoxCamDir()}startSmoothTranslation(e){this.__coreView__.cameraControl.startSmoothTranslation(e)}zoomExtents(e,t,i){this.__coreView__.cameraControl.zoomExtents(e,t,i)}setCameraInfo(e,t){this.__coreView__.cameraControl.setCameraInfo(e,t)}getOrginalCameraInfo(){return(this.__coreView__.viewManager||this.__coreView__.camera).getOrginalCameraInfo()}setOrginalCameraInfo(e,t,i){this.__coreView__.camera.setOrginalCameraInfo({center:e,up:t,position:i})}toPerspectiveCamera(){this.__coreView__.toPerspectiveCamera()}toOrthographicCamera(){this.__coreView__.toOrthographicCamera()}updateGroundTransform(e,t,i){return this.__coreView__.groundShadow.updateGroundTransform(e,t,i)}enableLocalClipping(){this.__coreView__.renderer.localClippingEnabled=!0}disableLocalClipping(){this.__coreView__.renderer.localClippingEnabled=!1}getCanvas2D(){return this.__coreView__.canvas2D}getCanvas3D(){return this.__coreView__.canvas3D}getContainer(){return this.__coreView__.container}getRenderDomElement(){return this.__coreView__.renderer.domElement}getAdditionalObjectsScene(){return this.__coreView__.additionalObjectsScene}getDispalyModelUnit(e,t){return this.__coreView__.getDispalyModelUnit(e,t)}modelCoordToClientCoord(e){return this.__coreView__.modelCoordToClientCoord(e)}clientCoordToModelCoord(e){return this.__coreView__.clientCoordToModelCoord(e)}showObject(e,t,i,n=!0){this.__coreView__.showObject(e,t,i,n)}showObjectReversed(e){this.__coreView__.showObjectReversed(e)}renderAllViews(){this.__coreView__.renderAllViews()}render(e){this.__coreView__.render(e)}setRenderMode(e,t){this.__coreView__.setRenderMode(e,t)}getRenderMode(){let e=void 0;switch(this.__coreView__.getRenderMode()){case 0:e="lighting";break;case 1:e="primarycolor";break;case 2:e="wireframe";break;case 3:e="whitemold";break;case 4:e="shadedWithEdges";break;case 5:e="shaded";break;case 6:e="hiddenLineRemove";break;case 7:e="hiddenLineVisible";break;case 8:e="transparent"}return e}getAssemblyPMIState(){return this.__coreView__.AssemblyPMIState}setAssemblyPMIState(e){this.__coreView__.AssemblyPMIState=e}getPartPMIState(){return this.__coreView__.PartPMIState}setPartPMIState(e){this.__coreView__.PartPMIState=e}getPmiVisible(){return this.__coreView__.pmiVisible}setPmiVisible(e){this.__coreView__.pmiVisible=e}setPMIObjectVisible(e,t){this.__coreView__.setPMIObjectVisible(e,t)}isPMIOccludeByModel(){return!NDSWebViewer.SETTING.StopPMIOcclusion}enablePMIOccludeByModel(e){this.__coreView__.stopPMIOcclusion(!e)}getPmiList(){return this.__coreView__.PMINDSBodys}getPMIObjectByUUID(e){return this.__coreView__.PMIUUIDtoPMIObject[e]}isPMIObjectOrSomeChildHidden(e){return this.__coreView__.isPMIObjectOrSomeChildHidden(e)}getPmiObjectTree(){return this.__coreView__.pmiObject}getSelectedPmiList(){return this.__coreView__.getPMINDSBodySelectList()}selectPMIObject(e){this.__coreView__.selectPMIObject(e)}deselectPMIObject(e){this.__coreView__.deselectPMIObject(e)}unmergeBodyNode(){this.__coreView__.ndsModel.unmergeNode()}mergeBodyNode(){this.__coreView__.ndsModel.mergeNode()}getAllTransparentBodies(e){return this.__coreView__.ndsModel.getAllTransparentBodies(e)}isolateBodiesOnly(e){this.__coreView__.ndsModel.isolateBodiesOnly(e)}unloadModelById(e){this.__coreView__.ndsModel.unloadModelById(e)}startLoadAnimationModel(e){var t=e.url,i=e.id,e={needsPMI:!1,needsAnimation:!1,needsSketchModel:!1,position:e.position,pmiVisible:this.__coreView__.pmiVisible,modelId:e.modelId};this.__coreView__.loadModel(i,t,null,null,"js",null,null,null,e)}getBodyNodeFromUuid(t,e=-1){var i=null;return 0<=e?(e=this.getModelById(e))&&(e=e.getBodyNodeFromUuid(t))&&(i=e):this.__coreView__.ndsModel.models.forEach(e=>{e=e.getBodyNodeFromUuid(t);e&&(i=e)}),i}loadBrepInfo(e){this.__coreView__.loadBrepInfo(e)}getForceClear(){return this.__coreView__.renderStates.forceClear}isBackgroundImageEnabled(){return!!this.__coreView__.backGroundScene}isEnvMapEnabled(){return!!this.__coreView__.envMapScene}setIgnoreModelSelection(e){var t=this.__coreView__.controls.getOperator();t&&t.ignoreModelSelection&&t.ignoreModelSelection(e)}logOperatorTimeShow(e,t){this.__coreView__.logOperatorTime&&this.__coreView__.logOperatorTimeShow(e,t)}isLoadedNdsModelEmpty(){return void 0!==this.__coreView__.GeomEmpty&&this.__coreView__.GeomEmpty}isECAD3DView(){return void 0!==this.__coreView__.isECAD3DViewer&&this.__coreView__.isECAD3DViewer}}class o{constructor(e){this.__clipDataManager__=e}registerClipExtensionCallback(e){return this.__clipDataManager__.registerClipExtensionCallback(e)}getEventType(){return this.__clipDataManager__.EVENT_TYPE}enableBoxClip(){this.__clipDataManager__.enableBoxClip()}disableBoxClip(){this.__clipDataManager__.disableBoxClip()}setClipPlanes(e,t){this.__clipDataManager__.setClipPlanes(e,t)}enablePlaneClip(){this.__clipDataManager__.enablePlaneClip()}disablePlaneClip(){this.__clipDataManager__.disablePlaneClip()}updatePartClip(e,t,i){this.__clipDataManager__.updatePartClip(e,t,i)}updateClippingObjects(e){this.__clipDataManager__.updateClippingObjects(e)}showSupplementClip(e){this.__clipDataManager__.showSupplementClip(e)}isObjectIncludeInClipping(e){return this.__clipDataManager__.__clippingObjectsUuidsSet.has(e)}}var s=t(0);class ${constructor(e=9){this._maxEntries=Math.max(4,e),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),this.clear()}all(){return this._all(this.data,[])}search(t){let i=this.data;var n=[];if(a(t,i))for(var o=this.toBBox,r=[];i;){for(let e=0;e<i.children.length;e++){var s=i.children[e],l=i.leaf?o(s):s;a(t,l)&&(i.leaf?n.push(s):u(t,l)?this._all(s,n):r.push(s))}i=r.pop()}return n}collides(t){let i=this.data;if(a(t,i))for(var n=[];i;){for(let e=0;e<i.children.length;e++){var o=i.children[e],r=i.leaf?this.toBBox(o):o;if(a(t,r)){if(i.leaf||u(t,r))return!0;n.push(o)}}i=n.pop()}return!1}load(t){if(t&&t.length)if(t.length<this._minEntries)for(let e=0;e<t.length;e++)this.insert(t[e]);else{let e=this._build(t.slice(),0,t.length-1,0);var i;this.data.children.length?this.data.height===e.height?this._splitRoot(this.data,e):(this.data.height<e.height&&(i=this.data,this.data=e,e=i),this._insert(e,this.data.height-e.height-1,!0)):this.data=e}return this}insert(e){return e&&this._insert(e,this.data.height-1),this}clear(){return this.data=g([]),this}remove(o,r){if(o){let e=this.data;var s=this.toBBox(o),l=[],a=[];let t,i,n;for(;e||l.length;){if(e||(e=l.pop(),i=l[l.length-1],t=a.pop(),n=!0),e.leaf){var p=function(t,i,n){if(!n)return i.indexOf(t);for(let e=0;e<i.length;e++)if(n(t,i[e]))return e;return-1}(o,e.children,r);if(-1!==p)return e.children.splice(p,1),l.push(e),this._condense(l),this}n||e.leaf||!u(e,s)?i?(t++,e=i.children[t],n=!1):e=null:(l.push(e),a.push(t),t=0,e=(i=e).children[0])}}return this}toBBox(e){return e}compareMinX(e,t){return e.minX-t.minX}compareMinY(e,t){return e.minY-t.minY}toJSON(){return this.data}fromJSON(e){return this.data=e,this}_all(e,t){for(var i=[];e;)(e.leaf?t:i).push(...e.children),e=i.pop();return t}_build(i,e,n,o){var t=n-e+1;let r=this._maxEntries,s;if(t<=r)d(s=g(i.slice(e,n+1)),this.toBBox);else{o||(o=Math.ceil(Math.log(t)/Math.log(r)),r=Math.ceil(t/Math.pow(r,o-1))),(s=g([])).leaf=!1,s.height=o;var l=Math.ceil(t/r),a=l*Math.ceil(Math.sqrt(r));Y(i,e,n,a,this.compareMinX);for(let t=e;t<=n;t+=a){var p=Math.min(t+a-1,n);Y(i,t,p,l,this.compareMinY);for(let e=t;e<=p;e+=l){var h=Math.min(e+l-1,p);s.children.push(this._build(i,e,h,o-1))}}d(s,this.toBBox)}return s}_chooseSubtree(o,r,e,s){for(;;){if(s.push(r),r.leaf||s.length-1===e)break;let t=1/0,i=1/0,n;for(let e=0;e<r.children.length;e++){var l=r.children[e],a=m(l),p=(h=o,p=l,(Math.max(p.maxX,h.maxX)-Math.min(p.minX,h.minX))*(Math.max(p.maxY,h.maxY)-Math.min(p.minY,h.minY))-a);p<i?(i=p,t=a<t?a:t,n=l):p===i&&a<t&&(t=a,n=l)}r=n||r.children[0]}var h,p;return r}_insert(e,t,i){var i=i?e:this.toBBox(e),n=[],o=this._chooseSubtree(i,this.data,t,n);for(o.children.push(e),h(o,i);0<=t&&n[t].children.length>this._maxEntries;)this._split(n,t),t--;this._adjustParentBBoxes(i,n,t)}_split(e,t){var i=e[t],n=i.children.length,o=this._minEntries,o=(this._chooseSplitAxis(i,o,n),this._chooseSplitIndex(i,o,n)),n=g(i.children.splice(o,i.children.length-o));n.height=i.height,n.leaf=i.leaf,d(i,this.toBBox),d(n,this.toBBox),t?e[t-1].children.push(n):this._splitRoot(i,n)}_splitRoot(e,t){this.data=g([e,t]),this.data.height=e.height+1,this.data.leaf=!1,d(this.data,this.toBBox)}_chooseSplitIndex(t,i,n){let o,r=1/0,s=1/0;for(let e=i;e<=n-i;e++){var l=f(t,0,e,this.toBBox),a=f(t,e,n,this.toBBox),p=(d=l,p=a,h=u=c=void 0,c=Math.max(d.minX,p.minX),u=Math.max(d.minY,p.minY),h=Math.min(d.maxX,p.maxX),d=Math.min(d.maxY,p.maxY),Math.max(0,h-c)*Math.max(0,d-u)),h=m(l)+m(a);p<r?(r=p,o=e,s=h<s?h:s):p===r&&h<s&&(s=h,o=e)}var d,p,c,u,h;return o||n-i}_chooseSplitAxis(e,t,i){var n=e.leaf?this.compareMinX:B,o=e.leaf?this.compareMinY:D;this._allDistMargin(e,t,i,n)<this._allDistMargin(e,t,i,o)&&e.children.sort(n)}_allDistMargin(t,i,n,e){t.children.sort(e);var o=this.toBBox,r=f(t,0,i,o),s=f(t,n-i,n,o);let l=c(r)+c(s);for(let e=i;e<n-i;e++){var a=t.children[e];h(r,t.leaf?o(a):a),l+=c(r)}for(let e=n-i-1;e>=i;e--){var p=t.children[e];h(s,t.leaf?o(p):p),l+=c(s)}return l}_adjustParentBBoxes(t,i,n){for(let e=n;0<=e;e--)h(i[e],t)}_condense(i){for(let e=i.length-1,t;0<=e;e--)0===i[e].children.length?0<e?(t=i[e-1].children).splice(t.indexOf(i[e]),1):this.clear():d(i[e],this.toBBox)}}function d(e,t){f(e,0,e.children.length,t,e)}function f(t,i,n,o,r){(r=r||g(null)).minX=1/0,r.minY=1/0,r.maxX=-1/0,r.maxY=-1/0;for(let e=i;e<n;e++){var s=t.children[e];h(r,t.leaf?o(s):s)}return r}function h(e,t){e.minX=Math.min(e.minX,t.minX),e.minY=Math.min(e.minY,t.minY),e.maxX=Math.max(e.maxX,t.maxX),e.maxY=Math.max(e.maxY,t.maxY)}function B(e,t){return e.minX-t.minX}function D(e,t){return e.minY-t.minY}function m(e){return(e.maxX-e.minX)*(e.maxY-e.minY)}function c(e){return e.maxX-e.minX+(e.maxY-e.minY)}function u(e,t){return e.minX<=t.minX&&e.minY<=t.minY&&t.maxX<=e.maxX&&t.maxY<=e.maxY}function a(e,t){return t.minX<=e.maxX&&t.minY<=e.maxY&&t.maxX>=e.minX&&t.maxY>=e.minY}function g(e){return{children:e,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function V(i,n,o=0,r=i.length-1,s=(e,t)=>e<t?-1:t<e?1:0){for(var l=(e,t,i)=>{var n=e[t];e[t]=e[i],e[i]=n};o<r;){600<r-o&&(a=r-o+1,p=n-o+1,d=Math.log(a),h=.5*Math.exp(2*d/3),d=.5*Math.sqrt(d*h*(a-h)/a)*(p-a/2<0?-1:1),V(i,n,Math.max(o,Math.floor(n-p*h/a+d)),Math.min(r,Math.floor(n+(a-p)*h/a+d)),s));var a,p,h,d,c=i[n];let e=o,t=r;for(l(i,o,n),0<s(i[r],c)&&l(i,o,r);e<t;){for(l(i,e,t),e++,t--;s(i[e],c)<0;)e++;for(;0<s(i[t],c);)t--}0===s(i[o],c)?l(i,o,t):l(i,++t,r),t<=n&&(o=t+1),n<=t&&(r=t-1)}}function Y(e,t,i,n,o){for(var r,s=[t,i];s.length;)(i=s.pop())-(t=s.pop())<=n||(V(e,r=t+Math.ceil((i-t)/n/2)*n,t,i,o),s.push(t,r,r,i))}class ee{constructor(e){this.container=Array.from({length:e},(e,t)=>t),this.rank=new Int32Array(e)}find(e){return this.container[e]!==e&&(this.container[e]=this.find(this.container[e])),this.container[e]}union(e,t){e=this.find(e),t=this.find(t);e!==t&&(this.rank[e]<this.rank[t]?this.container[e]=t:this.rank[e]>this.rank[t]?this.container[t]=e:(this.container[t]=e,this.rank[e]++))}getGroups(){let n=new Map;return this.container.forEach((e,t)=>{var i=this.find(t);n.has(i)||n.set(i,[]),n.get(i).push(t)}),Array.from(n.values())}}var l=1e-12,_={CW:1,CCW:-1,COLLINEAR:0},C=function(e,t){this.name="PointError",this.points=t=t||[],this.message=e||"Invalid Points!";for(var i=0;i<t.length;i++)this.message+=" "+r.toString(t[i])},r={};function W(e){return"("+e.x+";"+e.y+")"}function H(e,t,i,n){t=(e.x-t.x)*(n.y-t.y)-(n.x-t.x)*(e.y-t.y);return!(-l<=t||(e.x-i.x)*(n.y-i.y)-(n.x-i.x)*(e.y-i.y)<=l)}function P(e,t){if(!e)throw new Error(t||"Assert Failed")}function y(e,t,i){e=(e.x-i.x)*(t.y-i.y)-(e.y-i.y)*(t.x-i.x);return-l<e&&e<l?_.COLLINEAR:0<e?_.CCW:_.CW}function j(e,t,i){var n=t.x-e.x,t=t.y-e.y;return n*(i.x-e.x)+t*(i.y-e.y)<0}r.toString=function(e){var t=e.toString();return"[object Object]"===t?W(e):t},r.toStringBase=W,r.compare=function(e,t){return e.y===t.y?e.x-t.x:e.y-t.y},r.equals=function(e,t){return e.x===t.x&&e.y===t.y};function p(e,t){this.head_=e,this.tail_=t,this.search_node_=e}function E(e,t){this.x=+e||0,this.y=+t||0,this._p2t_edge_list=null}var v=function(e,t){this.point=e,this.triangle=t||null,this.next=null,this.prev=null,this.value=e.x},G=(p.prototype.head=function(){return this.head_},p.prototype.setHead=function(e){this.head_=e},p.prototype.tail=function(){return this.tail_},p.prototype.setTail=function(e){this.tail_=e},p.prototype.search=function(){return this.search_node_},p.prototype.setSearch=function(e){this.search_node_=e},p.prototype.findSearchNode=function(){return this.search_node_},p.prototype.locateNode=function(e){var t=this.search_node_;if(e<t.value){for(;t=t.prev;)if(e>=t.value)return this.search_node_=t}else for(;t=t.next;)if(e<t.value)return this.search_node_=t.prev,t.prev;return null},p.prototype.locatePoint=function(e){var t=e.x,i=this.findSearchNode(t),n=i.point.x;if(t===n){if(e!==i.point)if(e===i.prev.point)i=i.prev;else{if(e!==i.next.point)throw new Error("poly2tri Invalid AdvancingFront.locatePoint() call");i=i.next}}else if(t<n)for(;(i=i.prev)&&e!==i.point;);else for(;(i=i.next)&&e!==i.point;);return i&&(this.search_node_=i),i},E.prototype.toString=function(){return r.toStringBase(this)},E.prototype.toJSON=function(){return{x:this.x,y:this.y}},E.prototype.clone=function(){return new E(this.x,this.y)},E.prototype.set_zero=function(){return this.x=0,this.y=0,this},E.prototype.set=function(e,t){return this.x=+e||0,this.y=+t||0,this},E.prototype.negate=function(){return this.x=-this.x,this.y=-this.y,this},E.prototype.add=function(e){return this.x+=e.x,this.y+=e.y,this},E.prototype.sub=function(e){return this.x-=e.x,this.y-=e.y,this},E.prototype.mul=function(e){return this.x*=e,this.y*=e,this},E.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},E.prototype.normalize=function(){var e=this.length();return this.x/=e,this.y/=e,e},E.prototype.equals=function(e){return this.x===e.x&&this.y===e.y},E.negate=function(e){return new E(-e.x,-e.y)},E.add=function(e,t){return new E(e.x+t.x,e.y+t.y)},E.sub=function(e,t){return new E(e.x-t.x,e.y-t.y)},E.mul=function(e,t){return new E(e*t.x,e*t.y)},E.cross=function(e,t){return"number"==typeof e?"number"==typeof t?e*t:new E(-e*t.y,e*t.x):"number"==typeof t?new E(t*e.y,-t*e.x):e.x*t.y-e.y*t.x},E.toString=r.toString,E.compare=r.compare,E.cmp=r.compare,E.equals=r.equals,E.dot=function(e,t){return e.x*t.x+e.y*t.y},{triangulate:function(e){e.initTriangulation(),e.createAdvancingFront(),function(e){var t,i=e.pointCount();for(t=1;t<i;++t)for(var n=e.getPoint(t),o=function(e,t){var i=e.locateNode(t),n=function(e,t,i){var n=new b(t,i.point,i.next.point),t=(n.markNeighbor(i.triangle),e.addToMap(n),new v(t));t.next=i.next,(t.prev=i).next.prev=t,i.next=t,S(e,n)||e.mapTriangleToNodes(n);return t}(e,t,i);t.x<=i.point.x+l&&T(e,i);return function(e,t){var i=t.next;for(;i.next&&!j(i.point,i.next.point,i.prev.point);)T(e,i),i=i.next;i=t.prev;for(;i.prev&&!j(i.point,i.next.point,i.prev.point);)T(e,i),i=i.prev;t.next&&t.next.next&&(!function(e){var t=e.point.x-e.next.next.point.x,e=e.point.y-e.next.next.point.y;return P(0<=e,"unordered y"),0<=t||Math.abs(t)<e}(t)||!function(e,t){y(t.point,t.next.point,t.next.next.point)===_.CCW?e.basin.left_node=t.next.next:e.basin.left_node=t.next;e.basin.bottom_node=e.basin.left_node;for(;e.basin.bottom_node.next&&e.basin.bottom_node.point.y>=e.basin.bottom_node.next.point.y;)e.basin.bottom_node=e.basin.bottom_node.next;if(e.basin.bottom_node!==e.basin.left_node){for(e.basin.right_node=e.basin.bottom_node;e.basin.right_node.next&&e.basin.right_node.point.y<e.basin.right_node.next.point.y;)e.basin.right_node=e.basin.right_node.next;e.basin.right_node!==e.basin.bottom_node&&(e.basin.width=e.basin.right_node.point.x-e.basin.left_node.point.x,e.basin.left_highest=e.basin.left_node.point.y>e.basin.right_node.point.y,function e(t,i){if(Z(t,i))return;T(t,i);{if(i.prev===t.basin.left_node&&i.next===t.basin.right_node)return;if(i.prev===t.basin.left_node){if(y(i.point,i.next.point,i.next.next.point)===_.CW)return;i=i.next}else if(i.next===t.basin.right_node){if(y(i.point,i.prev.point,i.prev.prev.point)===_.CCW)return;i=i.prev}else i=i.prev.point.y<i.next.point.y?i.prev:i.next}e(t,i)}(e,e.basin.bottom_node))}}(e,t))}(e,n),n}(e,n),r=n._p2t_edge_list,s=0;r&&s<r.length;++s)!function(e,t,i){if(e.edge_event.constrained_edge=t,e.edge_event.right=t.p.x>t.q.x,!z(i.triangle,t.p,t.q)){!function(e,t,i){(e.edge_event.right?function(e,t,i){for(;i.next.point.x<t.p.x;)y(t.q,i.next.point,t.p)===_.CCW?function e(t,i,n){n.point.x<i.p.x&&(y(n.point,n.next.point,n.next.next.point)===_.CCW?M:(q(t,i,n),e))(t,i,n)}(e,t,i):i=i.next}:function(e,t,i){for(;i.prev.point.x>t.p.x;)y(t.q,i.prev.point,t.p)===_.CW?function e(t,i,n){n.point.x>i.p.x&&(y(n.point,n.prev.point,n.prev.prev.point)===_.CW?I:(J(t,i,n),e))(t,i,n)}(e,t,i):i=i.prev})(e,t,i)}(e,t,i);try{x(e,t.p,t.q,i.triangle,t.q)}catch(e){}}}(e,r[s],o)}(e),function(e){var t=e.front().head().next.triangle,i=e.front().head().next.point;for(;!t.getConstrainedEdgeCW(i);)t=t.neighborCCW(i);e.meshClean(t)}(e)}});function x(e,t,i,n,o){if(!z(n,t,i)){var r=n.pointCCW(o),s=y(i,r,t);if(s===_.COLLINEAR)throw new C("poly2tri EdgeEvent: Collinear not supported!",[i,r,t]);var r=n.pointCW(o),l=y(i,r,t);if(l===_.COLLINEAR)throw new C("poly2tri EdgeEvent: Collinear not supported!",[i,r,t]);s===l?x(e,t,i,n=s===_.CW?n.neighborCCW(o):n.neighborCW(o),o):w(e,t,i,n,o)}}function z(e,t,i){var n=e.edgeIndex(t,i);if(-1!==n)return e.markConstrainedEdgeByIndex(n),(e=e.getNeighbor(n))&&e.markConstrainedEdgeByPoints(t,i),1}function T(e,t){var i=new b(t.prev.point,t.point,t.next.point);i.markNeighbor(t.prev.triangle),i.markNeighbor(t.triangle),e.addToMap(i),t.prev.next=t.next,t.next.prev=t.prev,S(e,i)||e.mapTriangleToNodes(i)}function S(e,t){for(var i=0;i<3;++i)if(!t.delaunay_edge[i]){var n=t.getNeighbor(i);if(n){var o=t.getPoint(i),r=n.oppositePoint(t,o),s=n.index(r);if(n.constrained_edge[s]||n.delaunay_edge[s])t.constrained_edge[i]=n.constrained_edge[s];else if(function(e,t,i,n){var o=e.x-n.x,e=e.y-n.y,r=t.x-n.x,t=t.y-n.y,s=o*t-r*e;if(s<=0)return!1;var l=i.x-n.x,i=i.y-n.y,n=l*e-o*i;if(n<=0)return!1;return 0<(o*o+e*e)*(r*i-l*t)+(r*r+t*t)*n+(l*l+i*i)*s}(o,t.pointCCW(o),t.pointCW(o),r))return t.delaunay_edge[i]=!0,n.delaunay_edge[s]=!0,k(t,o,n,r),!S(e,t)&&e.mapTriangleToNodes(t),!S(e,n)&&e.mapTriangleToNodes(n),t.delaunay_edge[i]=!1,n.delaunay_edge[s]=!1,1}}}function k(e,t,i,n){var o=e.neighborCCW(t),r=e.neighborCW(t),s=i.neighborCCW(n),l=i.neighborCW(n),a=e.getConstrainedEdgeCCW(t),p=e.getConstrainedEdgeCW(t),h=i.getConstrainedEdgeCCW(n),d=i.getConstrainedEdgeCW(n),c=e.getDelaunayEdgeCCW(t),u=e.getDelaunayEdgeCW(t),f=i.getDelaunayEdgeCCW(n),m=i.getDelaunayEdgeCW(n);e.legalize(t,n),i.legalize(n,t),i.setDelaunayEdgeCCW(t,c),e.setDelaunayEdgeCW(t,u),e.setDelaunayEdgeCCW(n,f),i.setDelaunayEdgeCW(n,m),i.setConstrainedEdgeCCW(t,a),e.setConstrainedEdgeCW(t,p),e.setConstrainedEdgeCCW(n,h),i.setConstrainedEdgeCW(n,d),e.clearNeighbors(),i.clearNeighbors(),o&&i.markNeighbor(o),r&&e.markNeighbor(r),s&&e.markNeighbor(s),l&&i.markNeighbor(l),e.markNeighbor(i)}function Z(e,t){t=e.basin.left_highest?e.basin.left_node.point.y-t.point.y:e.basin.right_node.point.y-t.point.y;return e.basin.width>t}function M(e,t,i){T(e,i.next),i.next.point!==t.p&&y(t.q,i.next.point,t.p)===_.CCW&&y(i.point,i.next.point,i.next.next.point)===_.CCW&&M(e,t,i)}function q(e,t,i){y(i.next.point,i.next.next.point,i.next.next.next.point)===_.CCW?M(e,t,i.next):y(t.q,i.next.next.point,t.p)===_.CCW&&q(e,t,i.next)}function J(e,t,i){y(i.prev.point,i.prev.prev.point,i.prev.prev.prev.point)===_.CW?I(e,t,i.prev):y(t.q,i.prev.prev.point,t.p)===_.CW&&J(e,t,i.prev)}function I(e,t,i){T(e,i.prev),i.prev.point!==t.p&&y(t.q,i.prev.point,t.p)===_.CW&&y(i.point,i.prev.point,i.prev.prev.point)===_.CW&&I(e,t,i)}function w(e,t,i,n,o){var r,s,l,a,p,h,d,c=n.neighborAcross(o),u=(P(c,"FLIP failed due to missing triangle!"),c.oppositePoint(n,o));if(n.getConstrainedEdgeAcross(o))throw r=n.index(o),new C("poly2tri Intersecting Constraints",[o,u,n.getPoint((r+1)%3),n.getPoint((r+2)%3)]);H(o,n.pointCCW(o),n.pointCW(o),u)?(k(n,o,c,u),e.mapTriangleToNodes(n),e.mapTriangleToNodes(c),o===i&&u===t?i===e.edge_event.constrained_edge.q&&t===e.edge_event.constrained_edge.p&&(n.markConstrainedEdgeByPoints(t,i),c.markConstrainedEdgeByPoints(t,i),S(e,n),S(e,c)):(r=y(i,u,t),l=n,a=c,p=o,h=u,w(s=e,t,i,n=r!==_.CCW?(d=l.edgeIndex(p,h),l.delaunay_edge[d]=!0,S(s,l),l.clearDelaunayEdges(),a):(d=a.edgeIndex(p,h),a.delaunay_edge[d]=!0,S(s,a),a.clearDelaunayEdges(),l),o))):(function e(t,i,n,o,r,s){var l=r.neighborAcross(s);P(l,"FLIP failed due to missing triangle");r=l.oppositePoint(r,s);H(n,o.pointCCW(n),o.pointCW(n),r)?w(t,n,r,l,r):(s=Q(i,n,l,r),e(t,i,n,o,l,s))}(e,t,i,n,c,Q(t,i,c,u)),x(e,t,i,n,o))}function Q(e,t,i,n){var o=y(t,n,e);if(o===_.CW)return i.pointCCW(n);if(o===_.CCW)return i.pointCW(n);throw new C("poly2tri [Unsupported] nextFlipPoint: opposing point on constrained edge!",[t,n,e])}function K(e,t){if(this.p=e,this.q=t,e.y>t.y)this.q=e,this.p=t;else if(e.y===t.y)if(e.x>t.x)this.q=e,this.p=t;else if(e.x===t.x)throw new C("poly2tri Invalid Edge constructor: repeated points!",[e]);this.q._p2t_edge_list||(this.q._p2t_edge_list=[]),this.q._p2t_edge_list.push(this)}function te(){this.left_node=null,this.bottom_node=null,this.right_node=null,this.width=0,this.left_highest=!1}function ie(){this.constrained_edge=null,this.right=!1}function ne(){function l(e,t,i){return e<t?i+`:${e}:`+t:i+`:${t}:`+e}function y(e,t,i,n,o,r,s){this.pt1=e,this.pt2=t,this.p1=-1,this.p2=-1,this.meshId=s,this.eid1=l(i,n,s),this.eid2=l(o,r,s)}function d(){this.bbox=new THREE.Box2,this.left=null,this.right=null,this.node_edges=[]}function e(e,t,i){this.pts=e,this.edges=t,this.bbox=i,this.pipResult=!1}e.prototype.splitNode=function(e){if(!(e.bbox.min.y>=e.bbox.max.y||e.node_edges.length<3)){for(var t=.5*(e.bbox.min.y+e.bbox.max.y),i=(e.left=new d,e.right=new d,this.pts),n=e.node_edges,o=[],r=new THREE.Vector2,s=0;s<n.length;s++){var l=this.edges[n[s]],a=i[l.p1].y,p=i[l.p2].y,h=(p<a&&(h=a,a=p,p=h),null);p<t?(e.left.node_edges.push(n[s]),h=e.left.bbox):t<a?(e.right.node_edges.push(n[s]),h=e.right.bbox):o.push(n[s]),h&&(r.set(i[l.p1].x,i[l.p1].y),h.expandByPoint(r),r.set(i[l.p2].x,i[l.p2].y),h.expandByPoint(r))}e.node_edges=o,e.left.node_edges.length&&this.splitNode(e.left),e.right.node_edges.length&&this.splitNode(e.right)}},e.prototype.build=function(){this.root=new d;for(var e=this.root.node_edges,t=0;t<this.edges.length;t++)e.push(t);this.root.bbox.copy(this.bbox),this.splitNode(this.root)},e.prototype.pointInPolygonRec=function(e,t,i){if(e.bbox.min.y<=i&&e.bbox.max.y>=i)for(var n=this.pts,o=e.node_edges,r=0,s=o.length;r<s;r++){var l=this.edges[o[r]],a=n[l.p1],p=a.x,a=a.y,l=n[l.p2],h=l.x,l=l.y,d=i<=l;i<=a!=d&&(h-t)*(a-l)<=(l-i)*(p-h)==d&&(this.pipResult=!this.pipResult)}var c=e.left,c=(c&&c.bbox.min.y<=i&&c.bbox.max.y>=i&&this.pointInPolygonRec(c,t,i),e.right);c&&c.bbox.min.y<=i&&c.bbox.max.y>=i&&this.pointInPolygonRec(c,t,i)},e.prototype.pointInPolygon=function(e,t){return this.pipResult=!1,this.pointInPolygonRec(this.root,e,t),this.pipResult};let i=new THREE.Vector3;function t(e,t){this.edges=e,this.bbox=t,this.pts=[],this.idmap=new Map,this.xymap=new Map,this.contours=[],this.point2EdgeMap=new Map,this.scale=1e6/this.bbox.getSize(i).length()}t.prototype.getPoint2EdgeKey=function(e,t){return e<t?e+":"+t:t+":"+e},t.prototype.getPointIndex=function(e,t,i){var n,o,r=this.idmap.get(i);return void 0!==r||(r=0|e*this.scale,n=0|t*this.scale,void 0===(r=void 0===(o=this.xymap.get(r))?(o=new Map,void this.xymap.set(r,o)):o.get(n))&&(r=this.pts.length,o.set(n,r),this.idmap.set(i,r),o=this.pts.length,this.pts.push({x:e,y:t,id:o}))),r},t.prototype.snapEdges=function(){for(var e=0;e<this.edges.length;e++){var t=this.edges[e],i=(t.p1=this.getPointIndex(t.pt1.x,t.pt1.y,t.eid1),t.p2=this.getPointIndex(t.pt2.x,t.pt2.y,t.eid2),this.getPoint2EdgeKey(t.p1,t.p2));this.point2EdgeMap.set(i,t)}},t.prototype.sanitizeEdges=function(){for(var e=new Set,t=[],i=0,n=this.edges.length;i<n;i++){var o,r=this.edges[i];r.p1===r.p2||(o=this.getPoint2EdgeKey(r.p1,r.p2),e.has(o))||(e.add(o),t.push(r))}this.edges=t};let k=(e,i,n,t=!1)=>{if(n.has(i)&&!t)return[];var o=[];let r=i,s=!1;for(;e.has(r)&&!s;){o.push(r),n.add(r);var l=e.get(r);let t=-1;for(let e=0;e<l.length;++e){var a=l[e];if(a===i&&2<o.length){o.push(a),s=!0;break}if(!n.has(a)){t=a;break}}r=t}return o},Z=(t,i,n,o=[],r=-1,s,l)=>{var a=n[n.length-1],p=t.get(a);for(let e=0;e<p.length;++e){var h=p[e];if(h===i&&3<n.length)n.push(h),o.push(n.slice()),n.pop();else if(h!==r&&!l.has(h))if(s.has(h)){var d=[h];for(let e=n.length-1;0<=e;--e)if(d.push(n[e]),n[e]===h){o.push(d);break}}else s.add(h),n.push(h),Z(t,i,n,o,a,s,l),n.pop(),s.delete(h)}s.add(a),l.add(a)},q=(e,t)=>{return e=(0,Math.round)(e*(t=t||1))},J=(e,t)=>{var i=Math.round;return e.X=i(e.X*(t=t||1)),e.Y=i(e.Y*t),e},Q=new Map,K=[];function n(t){this.indices=[],this.cset=t;var i=this.pts=t.pts;if(t.groupedContours)for(var n=this.cset.groupedContours,o=[],r=[],s=[],l=0;l<n.length;l++){var a=new THREE.Box2,p=[],h=new O([]);for(let e=r.length=o.length=0;e<n[l].length;++e){var d=n[l][e],c=d[s.length=0]!==d[d.length-1];if(!c){for(var u=o.length,f=0;f<d.length-1;f++){var m,g,_={x:i[d[f]].x,y:i[d[f]].y,id:i[d[f]].id},_=(s.push(_),r.push(_),o.length),C=(o.push({x:i[d[f]].x,y:i[d[f]].y,id:_,originalId:d[f]}),d[f]),P=d[f+1],P=(a.expandByPoint(i[d[f]]),a.expandByPoint(i[d[f+1]]),t.getPoint2EdgeKey(C,P)),P=t.point2EdgeMap.get(P);P&&(m=new y({x:P.pt1.x,y:P.pt1.y,z:P.pt1.z},{x:P.pt2.x,y:P.pt2.y,z:P.pt2.z}),g=f===d.length-2?u:_+1,m.p1=C===P.p1?_:g,m.p2=C===P.p1?g:_,m.meshId=P.meshId,p.push(m))}h.initEdges(s,c)}}h.points_=r,this.intervalTree=new e(o,p,a),this.intervalTree.build(),0<h.edge_list.length&&(this.triangulate(h),this.processResult(h))}}t.prototype.stitchContours=function(D=!1){var t=new Map;Q.clear();for(var e=K.length=0;e<this.edges.length;e++){var i=this.edges[e];Q.set(i.meshId,e),K[e]=i.meshId,i.p1!==i.p2&&(void 0!==t.get(i.p1)?t.get(i.p1).push(i.p2):t.set(i.p1,[i.p2]),void 0!==t.get(i.p2)?t.get(i.p2).push(i.p1):t.set(i.p2,[i.p1]))}var n,o,r=new Set,s=[],l=[],V=new Set;for([n,o]of t.entries())o.length<=1&&s.push(n),2<o.length&&(l.push(n),V.add(n));let a=0,p=0;for(let e=0;e<s.length;++e){var h=s[e],h=k(t,h,r);1<h.length&&(this.contours.push(h),a++)}var X,Y,d,c,u,W;if(t.size<100)for(let e=0;e<l.length;++e){var f=l[e];if(!r.has(f)){X=t,f=f,Y=r,u=c=d=void 0,d=new Set,c=[],u=[f],Z(X,f,u,c,-1,d,Y);var H=c;for(let e=0;e<H.length;++e){var m=H[e];1<m.length&&(this.contours.push(m),2<m.length&&m[0]===m[m.length-1]?p++:a++)}}}else for(let e=0;e<l.length;++e){var g=l[e];if(r.has(g)){r.delete(g);var _=t.get(g);for(let e=0;e<_.length;++e)V.has(_[e])&&r.has(_[e])&&r.delete(_[e])}g=k(t,g,r);2<g.length&&(this.contours.push(g),g[0]===g[g.length-1]?p++:a++)}for(W of t.keys()){var C=k(t,W,r);2<C.length&&(this.contours.push(C),C[0]===C[C.length-1]?p++:a++)}var P=new Map,y=[],E=new $;let v=void 0;1<Q.size&&(v=new ee(Q.size+1));for(let e=0;e<this.contours.length;++e){var x=this.contours[e];if(x[0]!==x[x.length-1]&&(w=this.pts[x[0]],b=this.pts[x[x.length-1]],Math.abs(w.x-b.x)<.001)&&Math.abs(w.y-b.y)<.001&&x.push(x[0]),!(x[0]!==x[x.length-1]||x.length<3)){let t=void 0,i=-1;var T=new THREE.Box2,S=[];for(let e=1;e<x.length;++e){var M=x[e-1],I=x[e],M=(S.push(J({X:this.pts[M].x,Y:this.pts[M].y},1e3)),T.expandByPoint(this.pts[M]),e===x.length-1&&(S.push(J({X:this.pts[I].x,Y:this.pts[I].y},1e3)),T.expandByPoint(this.pts[I])),this.getPoint2EdgeKey(M,I)),I=this.point2EdgeMap.get(M);I&&(-1!==i&&void 0!==v&&v.union(Q.get(i),Q.get(I.meshId)),i=I.meshId,void 0===t&&(t=I.meshId),y.push(I))}var w=T.max.clone().manhattanDistanceTo(T.min),b=void 0!==v?K[v.find(Q.get(t))]:t;P.has(b)||P.set(b,[]),P.get(b).push({id:e,minX:q(T.min.x),minY:q(T.min.y),maxX:q(T.max.x),maxY:q(T.max.y),bbox:T,boxSize:q(w),pts:S})}}var F,N,O=[],R=new Map,U=new Set,A=r;for([F,N]of P)if(N.length<=1)O.push([this.contours[N[0].id]]);else{var j,G,L=N;if(L.sort((e,t)=>t.boxSize-e.boxSize),R.clear(),L.length<6)this.groupClosedContours(L,R,1e3,void 0,U);else{E.clear(),E.load(L),A.clear();for(let e=0;e<L.length;++e){var z,B=L[e];A.has(B.id)||(1!==(z=E.search(B)).length||A.has(B.id)?this.groupClosedContours(z,R,1e3,A,U):(A.add(B.id),R.has(0)||R.set(0,[]),R.get(0).push(this.contours[B.id]),U.add(B.id)))}}for([j,G]of R)O.push(G)}this.groupedContours=O,0<y.length&&(this.edges=y),D&&(console.log("The number of closed contour: "+p),console.log("The number of open contour: "+a))},t.prototype.groupClosedContours=function(i,t,n,o,r){var s=Array(i.length).fill(0);let l=0;for(let t=0;t<i.length;++t){var a=i[t];o&&o.add(a.id);for(let e=t+1;e<i.length;++e){var p=i[e];o&&o.has(p.id)||(-1===(p=this.detectContourIntersection(a,p,n))?s[e]=s[t]:1===p&&s[e]===s[t]&&(l=s[e]===l?l+1:l,s[e]=l))}}for(let e=0;e<i.length;++e){var h,d=i[e].id;r.has(d)||(r.add(d),h=s[e],t.has(h)||t.set(h,[]),t.get(h).push(this.contours[d]))}},t.prototype.detectContourIntersection=function(e,t,i=1e3){var n=e.bbox,o=t.bbox,r=n.containsBox(o),n=n.intersectsBox(o);return(r||n)&&((o=new s.a.Clipper).AddPath(e.pts,s.a.PolyType.ptClip,!0),o.AddPath(t.pts,s.a.PolyType.ptSubject,!0),r=new s.a.Paths,o.Execute(s.a.ClipType.ctIntersection,r,s.a.PolyFillType.pftNonZero,s.a.PolyFillType.pftNonZero))&&0!==r.length?(n=Math.abs(s.a.Clipper.Area(e.pts)),o=Math.abs(s.a.Clipper.Area(t.pts)),e=Math.abs(r.reduce((e,t)=>e+s.a.Clipper.Area(t),0)),t=1/(i*i),Math.abs(n-e)<t||Math.abs(o-e)<t?-1:1):0},t.prototype.isConvex=function(t){var i=t.length;let n=0;for(let e=0;e<i;++e){var o=(e+1)%i,r=(e+2)%i,s=this.pts[t[e]],o=this.pts[t[o]],r=this.pts[t[r]],l=o.x-s.x,s=o.y-s.y,a=r.x-o.x,r=r.y-o.y;if(3===(n|=l*r-a*s<0?1:2))return-1}return 0<n?1:0},n.prototype.triangulate=function(e){try{e.triangulate()}catch(e){}},n.prototype.processResult=function(e){for(var t=0;t<e.map_.length;t++){var i=e.map_[t],n=i.points_[0],o=i.points_[1],i=i.points_[2];void 0!==n.id&&void 0!==o.id&&void 0!==i.id&&this.filterFace(n.id,o.id,i.id)}},n.prototype.pointInEdgeList=function(e,t){for(var i=this.cset.pts,n=this.cset.edges,o=!1,r=0,s=n.length;r<s;++r){var l,a=n[r],p=i[a.p1].x,h=i[a.p1].y,d=i[a.p2].x;t<=h!=(l=t<=(a=i[a.p2].y))&&(d-e)*(h-a)<=(a-t)*(p-d)==l&&(o=!o)}return o},n.prototype.pointInContour=function(e,t,i){for(var n,o,r,s=!1,l=this.cset.pts,a=l[i[i.length-1]].x,p=l[i[i.length-1]].y,h=t<=p,d=0,c=i.length;d<c;++d)o=l[i[d]].x,h!=(n=t<=(r=l[i[d]].y))&&(o-e)*(p-r)<=(r-t)*(a-o)==n&&(s=!s),h=n,a=o,p=r;return s},n.prototype.pointInPolygon=function(e,t){for(var i=!1,n=0;n<this.cset.contours.length;n++)this.pointInContour(e,t,this.cset.contours[n])&&(i=!i);return i},n.prototype.filterFace=function(e,t,i){var n,o=this.pts[e],r=this.pts[t],s=this.pts[i],l=(o.x+r.x+s.x)/3,a=(o.y+r.y+s.y)/3;this.intervalTree.pointInPolygon(l,a)&&(l=r.x-o.x,a=r.y-o.y,n=s.x-o.x,0<l*(s.y-o.y)-n*a?this.indices.push(null==o.originalId?e:o.originalId,null==r.originalId?t:r.originalId,null==s.originalId?i:s.originalId):this.indices.push(null==o.originalId?e:o.originalId,null==s.originalId?i:s.originalId,null==r.originalId?t:r.originalId))},this.TriangulatedSurface=n,this.ContourSet=t,this.Edge=y}function oe(){var v,x,T,S,M,I=1e-10,w=(new ne).Edge;function d(e){return Math.abs(e)<I}this.intersectSegmentPlane=function(e,t,i,n,o){var r,s=(new THREE.Vector3).subVectors(i,t);return d(r=e.normal.dot(s))?(n.copy(t),o.copy(i),2):(r=1/r,(o=-(t.dot(e.normal)*r+e.constant*r))<-I||1+I<o?0:(i=s.multiplyScalar(o).add(t),n.copy(i),1))},this.intersectTrianglePlane=function(e,t,i,n,o,r,s,l,a){var p,h,d,c,u,f,m,g,_,C,P=new THREE.Vector3,y=e.distanceToPoint(t),E=e.distanceToPoint(i),e=e.distanceToPoint(n);return y<-I&&E<-I&&e<-I||I<y&&I<E&&I<e||(p=Math.sign(y),C=Math.sign(E),h=Math.sign(e),0===p&&0===C&&0===h)?null:(0==p&&0!=C&&0!=h?(f=u=o,d=t.clone()):0!=p&&0==C&&0!=h?(f=u=r,d=i.clone()):0!=p&&0!=C&&0==h&&(f=u=s,d=n.clone()),void(0==p&&0==C?l.push(new w(t.clone(),i.clone(),o,o,r,r,a)):(y*E<0&&(m=1/(E-y),P=t.clone().multiplyScalar(E*m).sub(i.clone().multiplyScalar(y*m)),d?P.distanceTo(d)>I&&(g=o,_=r,c=P.clone()):(u=o,f=r,d=P)),0==C&&0==h?l.push(new w(i.clone(),n.clone(),r,r,s,s,a)):(E*e<0&&(m=1/(e-E),g=r,_=s,P=i.clone().multiplyScalar(e*m).sub(n.clone().multiplyScalar(E*m)),d?P.distanceTo(d)>I&&(g=r,_=s,c=P.clone()):(u=r,f=s,d=P.clone())),0==p&&0==h?l.push(new w(n.clone(),t.clone(),s,s,o,o,a)):(e*y<0&&(C=1/(y-e),P=n.clone().multiplyScalar(y*C).sub(t.clone().multiplyScalar(e*C)),d?P.distanceTo(d)>I&&(g=s,_=o,c=P.clone()):(u=s,f=o,d=P.clone())),d&&c&&l.push(new w(d,c,u,f,g,_,a)))))))},this.intersectBoxPlane=function(e,t){var i=new THREE.Vector3,n=(i.set(t.min.x,t.min.y,t.min.z),e.distanceToPoint(i)),n=Math.sign(n),o=(i.set(t.min.x,t.min.y,t.max.z),e.distanceToPoint(i));return Math.sign(o)!==n||(i.set(t.min.x,t.max.y,t.min.z),o=e.distanceToPoint(i),Math.sign(o)!==n)||(i.set(t.min.x,t.max.y,t.max.z),o=e.distanceToPoint(i),Math.sign(o)!==n)||(i.set(t.max.x,t.min.y,t.min.z),o=e.distanceToPoint(i),Math.sign(o)!==n)||(i.set(t.max.x,t.min.y,t.max.z),o=e.distanceToPoint(i),Math.sign(o)!==n)||(i.set(t.max.x,t.max.y,t.min.z),o=e.distanceToPoint(i),Math.sign(o)!==n)||(i.set(t.max.x,t.max.y,t.max.z),o=e.distanceToPoint(i),Math.sign(o)!==n)},this.intersectMeshPlane=(v=new THREE.Vector3,x=new THREE.Vector3,T=new THREE.Vector3,S=new THREE.Matrix4,M=new THREE.Plane,function(e,t,i,n,o){var r,s,l,a=o.length,p=t.attributes,h=i;if(S.getInverse(h),M.copy(e).applyMatrix4(S),void 0!==p.index||null!=t.index){var d=(p.index?p:t).index.array,c=t.vb||p.position.array,u=t.vb?t.vbstride:3,f=(p.position&&p.position instanceof THREE.InterleavedBufferAttribute&&(c=p.position.data.array,u=p.position.data.stride),t.groups);f&&0!==f.length||(f=[{start:0,count:d.length,index:0}],t.drawRange&&t.drawRange.count!=1/0&&(f[0].start=t.drawRange.start,f[0].count=t.drawRange.count));for(var m=0,g=f.length;m<g;++m)for(var _=f[m].start,C=f[m].count,P=f[m].index,y=_,E=_+C;y<E;y+=3)r=P+d[y],s=P+d[y+1],l=P+d[y+2],v.x=c[r*u],v.y=c[r*u+1],v.z=c[r*u+2],x.x=c[s*u],x.y=c[s*u+1],x.z=c[s*u+2],T.x=c[l*u],T.y=c[l*u+1],T.z=c[l*u+2],this.intersectTrianglePlane(M,v,x,T,r,s,l,o,n)}else{c=t.vb||p.position.array,u=t.vb?t.vbstride:3;p.position&&p.position instanceof THREE.InterleavedBufferAttribute&&(c=p.position.data.array,u=p.position.data.stride);for(y=0,E=c.length;y<E;y+=3,0)s=(r=y)+1,l=y+2,v.x=c[r*u],v.y=c[r*u+1],v.z=c[r*u+2],x.x=c[s*u],x.y=c[s*u+1],x.z=c[s*u+2],T.x=c[l*u],T.y=c[l*u+1],T.z=c[l*u+2],this.intersectTrianglePlane(M,v,x,T,r,s,l,o,n)}for(y=a,E=o.length;y<E;y++)o[y].pt1.applyMatrix4(h),o[y].pt2.applyMatrix4(h)}),this.makePlaneBasis=function(e){var t,i,n,o,r,s,l,a=new THREE.Vector3(0,0,1),p=(p=e.normal.clone().cross(a)).normalize(),a=a.dot(e.normal),h=new THREE.Matrix4;return d(p.x)&&d(p.y)&&d(p.z)?h.elements[14]=a*e.constant:(p=p,a=a,t=h,i=Math.sqrt(1-a*a),n=1-a,o=p.x,r=p.y,p=p.z,s=n*o,l=n*r,t.set(s*o+a,s*r-i*p,s*p+i*r,0,s*r+i*p,l*r+a,l*p-i*o,0,s*p-i*r,l*p+i*o,n*p*p+a,0,0,0,0,1),h.elements[14]=e.constant),h},this.convertToPlaneCoords=function(e,t,i){for(var n=0,o=t.length;n<o;n++){var r=t[n];r.pt1.applyMatrix4(e),r.pt2.applyMatrix4(e),i.expandByPoint(r.pt1),i.expandByPoint(r.pt2)}}}var b=function(e,t,i){this.points_=[e,t,i],this.neighbors_=[null,null,null],this.interior_=!1,this.constrained_edge=[!1,!1,!1],this.delaunay_edge=[!1,!1,!1]},N=r.toString,O=(b.prototype.toString=function(){return"["+N(this.points_[0])+N(this.points_[1])+N(this.points_[2])+"]"},b.prototype.getPoint=function(e){return this.points_[e]},b.prototype.GetPoint=b.prototype.getPoint,b.prototype.getPoints=function(){return this.points_},b.prototype.getNeighbor=function(e){return this.neighbors_[e]},b.prototype.containsPoint=function(e){var t=this.points_;return e===t[0]||e===t[1]||e===t[2]},b.prototype.containsEdge=function(e){return this.containsPoint(e.p)&&this.containsPoint(e.q)},b.prototype.containsPoints=function(e,t){return this.containsPoint(e)&&this.containsPoint(t)},b.prototype.isInterior=function(){return this.interior_},b.prototype.setInterior=function(e){return this.interior_=e,this},b.prototype.markNeighborPointers=function(e,t,i){var n=this.points_;if(e===n[2]&&t===n[1]||e===n[1]&&t===n[2])this.neighbors_[0]=i;else if(e===n[0]&&t===n[2]||e===n[2]&&t===n[0])this.neighbors_[1]=i;else{if(!(e===n[0]&&t===n[1]||e===n[1]&&t===n[0]))throw new Error("poly2tri Invalid Triangle.markNeighborPointers() call");this.neighbors_[2]=i}},b.prototype.markNeighbor=function(e){var t=this.points_;e.containsPoints(t[1],t[2])?(this.neighbors_[0]=e).markNeighborPointers(t[1],t[2],this):e.containsPoints(t[0],t[2])?(this.neighbors_[1]=e).markNeighborPointers(t[0],t[2],this):e.containsPoints(t[0],t[1])&&(this.neighbors_[2]=e).markNeighborPointers(t[0],t[1],this)},b.prototype.clearNeighbors=function(){this.neighbors_[0]=null,this.neighbors_[1]=null,this.neighbors_[2]=null},b.prototype.clearDelaunayEdges=function(){this.delaunay_edge[0]=!1,this.delaunay_edge[1]=!1,this.delaunay_edge[2]=!1},b.prototype.pointCW=function(e){var t=this.points_;return e===t[0]?t[2]:e===t[1]?t[0]:e===t[2]?t[1]:null},b.prototype.pointCCW=function(e){var t=this.points_;return e===t[0]?t[1]:e===t[1]?t[2]:e===t[2]?t[0]:null},b.prototype.neighborCW=function(e){return e===this.points_[0]?this.neighbors_[1]:e===this.points_[1]?this.neighbors_[2]:this.neighbors_[0]},b.prototype.neighborCCW=function(e){return e===this.points_[0]?this.neighbors_[2]:e===this.points_[1]?this.neighbors_[0]:this.neighbors_[1]},b.prototype.getConstrainedEdgeCW=function(e){return e===this.points_[0]?this.constrained_edge[1]:e===this.points_[1]?this.constrained_edge[2]:this.constrained_edge[0]},b.prototype.getConstrainedEdgeCCW=function(e){return e===this.points_[0]?this.constrained_edge[2]:e===this.points_[1]?this.constrained_edge[0]:this.constrained_edge[1]},b.prototype.getConstrainedEdgeAcross=function(e){return e===this.points_[0]?this.constrained_edge[0]:e===this.points_[1]?this.constrained_edge[1]:this.constrained_edge[2]},b.prototype.setConstrainedEdgeCW=function(e,t){e===this.points_[0]?this.constrained_edge[1]=t:e===this.points_[1]?this.constrained_edge[2]=t:this.constrained_edge[0]=t},b.prototype.setConstrainedEdgeCCW=function(e,t){e===this.points_[0]?this.constrained_edge[2]=t:e===this.points_[1]?this.constrained_edge[0]=t:this.constrained_edge[1]=t},b.prototype.getDelaunayEdgeCW=function(e){return e===this.points_[0]?this.delaunay_edge[1]:e===this.points_[1]?this.delaunay_edge[2]:this.delaunay_edge[0]},b.prototype.getDelaunayEdgeCCW=function(e){return e===this.points_[0]?this.delaunay_edge[2]:e===this.points_[1]?this.delaunay_edge[0]:this.delaunay_edge[1]},b.prototype.setDelaunayEdgeCW=function(e,t){e===this.points_[0]?this.delaunay_edge[1]=t:e===this.points_[1]?this.delaunay_edge[2]=t:this.delaunay_edge[0]=t},b.prototype.setDelaunayEdgeCCW=function(e,t){e===this.points_[0]?this.delaunay_edge[2]=t:e===this.points_[1]?this.delaunay_edge[0]=t:this.delaunay_edge[1]=t},b.prototype.neighborAcross=function(e){return e===this.points_[0]?this.neighbors_[0]:e===this.points_[1]?this.neighbors_[1]:this.neighbors_[2]},b.prototype.oppositePoint=function(e,t){e=e.pointCW(t);return this.pointCW(e)},b.prototype.legalize=function(e,t){var i=this.points_;if(e===i[0])i[1]=i[0],i[0]=i[2],i[2]=t;else if(e===i[1])i[2]=i[1],i[1]=i[0],i[0]=t;else{if(e!==i[2])throw new Error("poly2tri Invalid Triangle.legalize() call");i[0]=i[2],i[2]=i[1],i[1]=t}},b.prototype.index=function(e){var t=this.points_;if(e===t[0])return 0;if(e===t[1])return 1;if(e===t[2])return 2;throw new Error("poly2tri Invalid Triangle.index() call")},b.prototype.edgeIndex=function(e,t){var i=this.points_;if(e===i[0]){if(t===i[1])return 2;if(t===i[2])return 1}else if(e===i[1]){if(t===i[2])return 0;if(t===i[0])return 2}else if(e===i[2]){if(t===i[0])return 1;if(t===i[1])return 0}return-1},b.prototype.markConstrainedEdgeByIndex=function(e){this.constrained_edge[e]=!0},b.prototype.markConstrainedEdgeByEdge=function(e){this.markConstrainedEdgeByPoints(e.p,e.q)},b.prototype.markConstrainedEdgeByPoints=function(e,t){var i=this.points_;t===i[0]&&e===i[1]||t===i[1]&&e===i[0]?this.constrained_edge[2]=!0:t===i[0]&&e===i[2]||t===i[2]&&e===i[0]?this.constrained_edge[1]=!0:(t===i[1]&&e===i[2]||t===i[2]&&e===i[1])&&(this.constrained_edge[0]=!0)},te.prototype.clear=function(){this.left_node=null,this.bottom_node=null,this.right_node=null,this.width=0,this.left_highest=!1},function(e,t){t=t||{},this.triangles_=[],this.map_=[],this.points_=t.cloneArrays?e.slice(0):e,this.edge_list=[],this.pmin_=this.pmax_=null,this.front_=null,this.head_=null,this.tail_=null,this.af_head_=null,this.af_middle_=null,this.af_tail_=null,this.basin=new te,this.edge_event=new ie,this.initEdges(this.points_)});O.prototype.addHole=function(e){this.initEdges(e);for(var t=e.length,i=0;i<t;i++)this.points_.push(e[i]);return this},O.prototype.AddHole=O.prototype.addHole,O.prototype.addHoles=function(e){for(var t=e.length,i=0;i<t;i++)this.initEdges(e[i]);return this.points_=this.points_.concat.apply(this.points_,e),this},O.prototype.addPoint=function(e){return this.points_.push(e),this},O.prototype.AddPoint=O.prototype.addPoint,O.prototype.addPoints=function(e){return this.points_=this.points_.concat(e),this},O.prototype.triangulate=function(){return G.triangulate(this),this},O.prototype.getBoundingBox=function(){return{min:this.pmin_,max:this.pmax_}},O.prototype.getTriangles=function(){return this.triangles_},O.prototype.GetTriangles=O.prototype.getTriangles,O.prototype.front=function(){return this.front_},O.prototype.pointCount=function(){return this.points_.length},O.prototype.head=function(){return this.head_},O.prototype.setHead=function(e){this.head_=e},O.prototype.tail=function(){return this.tail_},O.prototype.setTail=function(e){this.tail_=e},O.prototype.getMap=function(){return this.map_},O.prototype.initTriangulation=function(){for(var e=this.points_[0].x,t=this.points_[0].x,i=this.points_[0].y,n=this.points_[0].y,o=this.points_.length,r=1;r<o;r++){var s=this.points_[r];s.x>e&&(e=s.x),s.x<t&&(t=s.x),s.y>i&&(i=s.y),s.y<n&&(n=s.y)}this.pmin_=new E(t,n),this.pmax_=new E(e,i);var l=.3*(e-t),a=.3*(i-n);this.head_=new E(e+l,n-a),this.tail_=new E(t-l,n-a),this.points_.sort(E.compare)},O.prototype.initEdges=function(e,t){for(var i=e.length,n=t?e.length-1:e.length,o=0;o<n;++o)this.edge_list.push(new K(e[o],e[(o+1)%i]))},O.prototype.getPoint=function(e){return this.points_[e]},O.prototype.addToMap=function(e){this.map_.push(e)},O.prototype.locateNode=function(e){return this.front_.locateNode(e.x)},O.prototype.createAdvancingFront=function(){var e,t,i=new b(this.points_[0],this.tail_,this.head_);this.map_.push(i),e=new v(i.getPoint(1),i),t=new v(i.getPoint(0),i),i=new v(i.getPoint(2)),this.front_=new p(e,i),(e.next=t).next=i,t.prev=e,i.prev=t},O.prototype.removeNode=function(e){},O.prototype.mapTriangleToNodes=function(e){for(var t,i=0;i<3;++i)e.getNeighbor(i)||(t=this.front_.locatePoint(e.pointCW(e.getPoint(i))))&&(t.triangle=e)},O.prototype.removeFromMap=function(e){for(var t=this.map_,i=t.length,n=0;n<i;n++)if(t[n]===e){t.splice(n,1);break}},O.prototype.meshClean=function(e){for(var t,i,n=[e];t=n.pop();)if(!t.isInterior())for(t.setInterior(!0),this.triangles_.push(t),i=0;i<3;i++)t.constrained_edge[i]||n.push(t.getNeighbor(i))};class re{constructor(e){this.edgeGroup=void 0,this.faceGroup=void 0,this.vertexContourMapping=void 0,this.loopPerimeters=void 0,this.loopStartEdgeIds=void 0,this.GLOBAL_IDENTITY_MATRIX=new THREE.Matrix4,this.DEBUG_CLOSED_CONTOUR_COLOR=65280,this.DEBUG_PRIMITIVE_COLOR_TABLE=[16776960,16711680,65535,255,0,16711935,15921906],this.modelUnit=e}clearClipInfo(){this.edgeGroup=void 0,this.faceGroup=void 0,this.vertexContourMapping=void 0,this.loopPerimeters=void 0,this.loopStartEdgeIds=void 0}createLineSegmentGeo(n){var o=[],r=[];let s=0;var e=new NDSWebViewer.NdsGeometry,l=new THREE.Box3,a=[],p=[];let h=0;var d=[],t={geomUUID:e.uuid,lines:{}};let c=0;var u=[];let f=-1;var m=[],g={start:void 0,end:void 0},_=new Uint16Array(n.pts.length);for(let i=0;i<n.contours.length;i++){var C=n.contours[i];c=0,f=-1,g.start=void 0,g.end=void 0;for(let t=1;t<C.length;t++){var P,y=n.pts[C[t-1]],E=n.pts[C[t]],y=new THREE.Vector3(y.x,y.y,0),E=new THREE.Vector3(E.x,E.y,0);l.expandByPoint(y),l.expandByPoint(E),_[C[t-1]]=i,_[C[t]]=i;let e=!1;void 0!==g.start&&this.pointsCollinear(g.start,g.end,E)?(P=this.syncWithModelUnit(E.distanceTo(g.start)),c=c-p[p.length-1]+P,p[p.length-1]=P,o[(P=o.length)-3]=E.x,o[P-2]=E.y,o[P-1]=E.z,g.end=E,e=!0):(d.push(h),d.push(h),P=this.syncWithModelUnit(y.distanceTo(E)),c+=P,p.push(P),o.push((g.start=y).x,y.y,y.z,(g.end=E).x,E.y,E.z)),e||(h++,r.push(s++),r.push(s++),a.push(h)),-1==f&&(f=h)}u.push(c),m.push(f)}var i=new Uint16Array(r),v=new Float32Array(o);return e.setAttribute("position",new THREE.BufferAttribute(v,3)),e.setIndex(new THREE.BufferAttribute(i,1)),e.drawRange.count=i.length,e.boundingBox=l,e.subGeomId=0,e.loaded=!0,e.isLines=!0,t.lines={ids:new Int32Array(a),indexRanges:new Int32Array(d),lengthes:new Float32Array(p)},this.edgeGroup=t,this.vertexContourMapping=_,this.loopPerimeters=u,this.loopStartEdgeIds=m,e}createDebugPointMesh(t){var i=new THREE.Geometry;for(let e=0;e<t.pts.length;++e)i.vertices.push(new THREE.Vector3(t.pts[e].x,t.pts[e].y,0));var e=new THREE.PointsMaterial({size:5,color:this.DEBUG_PRIMITIVE_COLOR_TABLE[0]});return new THREE.Points(i,e)}createDebugContourPointMesh(t,i,e){var n=new THREE.Geometry,o=this.DEBUG_PRIMITIVE_COLOR_TABLE.length,e=i[0]===i[i.length-1]?this.DEBUG_CLOSED_CONTOUR_COLOR:this.DEBUG_PRIMITIVE_COLOR_TABLE[e%o],o=i[0]===i[i.length-1]?8:5;for(let e=0;e<i.length;++e){var r=i[e];n.vertices.push(new THREE.Vector3(t.pts[r].x,t.pts[r].y,0))}o=new THREE.PointsMaterial({size:o,color:e});return new THREE.Points(n,o)}createDebugContourEdgeMesh(t){var i=new THREE.Geometry,e=this.DEBUG_PRIMITIVE_COLOR_TABLE.length,e=this.DEBUG_PRIMITIVE_COLOR_TABLE[0%e];for(let e=0;e<t.length;++e){var n=t[e];i.vertices.push(new THREE.Vector3(n.pt1.x,n.pt1.y,0)),i.vertices.push(new THREE.Vector3(n.pt2.x,n.pt2.y,0))}e=new THREE.PointsMaterial({size:8,color:e});return new THREE.Points(i,e)}createFaceMeshGeo(t,e,i){var n={geomUUID:void 0,loopPerimeters:[],loopStartEdgeId:[],planes:{ids:[],triIndexRanges:[],normals:[],origins:[],loops:[],areas:[]}},o=new ee(e.contours.length),e=(t.vertexContourMapping=this.vertexContourMapping,e.contours.length),r=[],s=new THREE.Box3,l=new NDSWebViewer.NdsGeometry,a=new Float32Array(3*t.pts.length),p=new THREE.Vector3,h=(n.geomUUID=l.uuid,[]);let d=void 0;for(let e=0;e<t.indices.length/3;++e){var c=t.pts[t.indices[3*e]],u=c.id,u=t.vertexContourMapping[u],f=t.pts[t.indices[3*e+1]],m=f.id,m=t.vertexContourMapping[m],g=t.pts[t.indices[3*e+2]],_=g.id,_=t.vertexContourMapping[_];o.union(u,m),o.union(m,_),h.push({pt1:c,pt2:f,pt3:g,contourId:this.getTriangleContourId2D(u,m,_),area:this.getTriangleArea2D(c,f,g)})}if(1<e){var C,P,y=new Map;for(let e=0;e<h.length;++e){var E=h[e].contourId[0],E=o.find(E);y.has(E)||y.set(E,[]),y.get(E).push(h[e])}d=[];for([C,P]of y)d.push(P)}else d=[h];let v=0;var x=[],T=[],S=d.length,M=[];for(let i=0;i<d.length;++i){var I=d[i];let t=0;M.push(new Set);for(let e=0;e<I.length;++e){var w=I[e];for(let e=0;e<w.contourId.length;++e){var b=w.contourId[e];M[i].add(b)}t+=w.area,x.push(i),r.push(w.pt1.id,w.pt2.id,w.pt3.id)}T.push([v,r.length/3-1]),v=r.length/3,n.planes.areas.push(t)}let N=0;for(let e=0;e<S;++e){n.planes.ids.push(e),n.planes.triIndexRanges.push(T[e][0]),n.planes.triIndexRanges.push(T[e][1]);var O,R=M[e];for(O of R)n.loopStartEdgeId.push(this.loopStartEdgeIds[O]),n.loopPerimeters.push(this.loopPerimeters[O]);n.planes.loops.push(N),n.planes.loops.push(R.size),N+=R.size}for(var A=0;A<t.pts.length;A++)a[3*A]=t.pts[A].x,a[3*A+1]=t.pts[A].y,a[3*A+2]=0,p.x=t.pts[A].x,p.y=t.pts[A].y,p.z=0,n.planes.origins.push(p.x,p.y,p.z),s.expandByPoint(p);for(var e=new Uint16Array(r.length),L=(e.set(r),l.addAttribute("position",new THREE.BufferAttribute(a,3)),l.boundingBox=s,i?new Uint16Array(2*t.pts.length):new Float32Array(3*t.pts.length)),A=0;A<t.pts.length;A++)i?(L[2*A]=32767,L[2*A+1]=65535,n.planes.normals.push(L[2*A],L[2*A+1])):(L[3*A]=0,L[3*A+1]=0,L[3*A+2]=1,n.planes.normals.push(L[3*A],L[3*A+1],L[3*A+2]));return l.addAttribute("normal",new THREE.BufferAttribute(L,i?2:3)),i&&(l.attributes.normal.bytesPerItem=2,l.attributes.normal.normalize=!0),l.setIndex(new THREE.BufferAttribute(e,1)),l.drawRange.count=e.length,l.streamingDraw=!0,l.streamingIndex=!0,l.loaded=!0,l.subGeomId=0,this.faceGroup=n,l}getTriangleArea2D(e,t,i){var n=this.syncWithModelUnit(e.x),e=this.syncWithModelUnit(e.y),o=this.syncWithModelUnit(t.x),t=this.syncWithModelUnit(t.y),r=this.syncWithModelUnit(i.x),i=this.syncWithModelUnit(i.y);return.5*Math.abs(n*(t-i)+o*(i-e)+r*(e-t))}getTriangleContourId2D(e,t,i){return e==t&&e===i?[e]:e===t?[e,i]:e===i||t===i?[e,t]:[e,t,i]}pointsCollinear(e,t,i){var n=e.x<.01?1e3:1,t=(t.x*n-e.x*n)*(i.y*n-e.y*n)-(t.y*n-e.y*n)*(i.x*n-e.x*n);return Math.abs(t)<1e-8}sortPoints(e){return e.sort((e,t)=>e.x===t.x?e.y-t.y:e.x-t.x),e}syncWithModelUnit(e){if(this.modelUnit)return"inch"===this.modelUnit?e/.03937:"feet"===this.modelUnit?e/.0033:"centimeter"===this.modelUnit?e/.1:"meter"===this.modelUnit?e/.001:e}}class F{static get UPDATE_CAP_MESH_EVENT(){return"[UPDATE_CAP_MESH_ALL]"}static get RELEASE_OLD_CAP_MESH(){return"[RELEASE_OLD_CAP_MESH]"}static get CLIP_NDS_MODEL(){return"  [CLIP_NDS_MODEL]"}static get COMPUTE_INTERSECTIONS(){return"  [COMPUTE_PLANE_MESH_INTERSECTIONS]"}static get COMPUTE_INTERSECTIONS_PLANE_MESH(){return"     [COMPUTE_INTERSECTIONS_PLANE_MESH]"}static get GENERATE_CAP_MESH_SINGLE_CLIP(){return"  [GENERATE_CAP_MESH_SINGLE_CLIP]"}static get GENERATE_CONTOURS(){return"  [GENERATE_CONTOURS]"}static get GENERATE_CONTOURS_SNAP_EDGES(){return"      [GENERATE_CONTOURS_SNAP_EDGES]"}static get GENERATE_CONTOURS_SANITIZE_EDGES(){return"      [GENERATE_CONTOURS_SANITIZE_EDGES]"}static get GENERATE_CONTOURS_STICH_CONTOURS(){return"      [GENERATE_CONTOURS_STICH_CONTOURS]"}static get TRIANGULATE_CONTOURS(){return"  [TRIANGULATE_CONTOURS]"}static get GENERATE_MESHES_TOTAL_COST(){return"  [GENERATE_MESHES_TOTAL_COST]"}static get GENERATE_LINES_TOTAL_COST(){return"  [GENERATE_LINES_TOTAL_COST]"}static get GENERATE_LINE_MATERIALS_TOTAL_COST(){return"  [GENERATE_LINE_MATERIALS_TOTAL_COST]"}static get GENERATE_MESH_MATERIALS_TOTAL_COST(){return"  [GENERATE_MESH_MATERIALS_TOTAL_COST]"}static get TOTAL_NUMBER_GENERATED_MESHES(){return"  [TOTAL_NUMBER_GENERATED_MESHES]"}static get TOTAL_NUMBER_GENERATED_LINES(){return"  [TOTAL_NUMBER_GENERATED_LINES]"}static get TOTAL_NUMBER_CREATED_LINE_MATERIALS(){return"  [TOTAL_NUMBER_CREATED_LINE_MATERIALS]"}static get TOTAL_NUMBER_CREATED_MESH_MATERIALS(){return"  [TOTAL_NUMBER_CREATED_MESH_MATERIALS]"}constructor(){let o=!1;this.logOperatorTimeInfo={},this.logOperatorAccumutiveInfo={},this.totalGeneratedMeshes=0,this.totalGeneratedMeshMaterials=0,this.totalGeneratedLines=0,this.totalGeneratedLineMaterials=0,this.enableLogPerformance=()=>{o=!0},this.logOperatorTimeBegin=e=>{o&&(this.logOperatorTimeInfo[e]=Date.now())},this.logOperatorTimeEnd=e=>{var t,i;o&&(t=Date.now(),i=this.logOperatorTimeInfo[e],void 0===this.logOperatorAccumutiveInfo[e]&&(this.logOperatorAccumutiveInfo[e]=0),this.logOperatorAccumutiveInfo[e]+=t-i)},this.logOperatorTimeShow=function(e,t=!1,i=!1){var n;o&&(t?(console.log(e+"[Total Time]",this.logOperatorAccumutiveInfo[e]+"ms"),this.logOperatorAccumutiveInfo[e]=0):(t=Date.now(),n=this.logOperatorTimeInfo[e],i&&console.log("New loop starts: ========>"),console.log(e+"["+n+"-"+t+"]",t-n+"ms"),this.logOperatorTimeInfo[e]=void 0))},this.logGatheredStatistics=()=>{o&&(this.logOperatorTimeShow(F.COMPUTE_INTERSECTIONS,!0),this.logOperatorTimeShow(F.COMPUTE_INTERSECTIONS_PLANE_MESH,!0),this.logOperatorTimeShow(F.GENERATE_CONTOURS,!0),this.logOperatorTimeShow(F.GENERATE_CONTOURS_SNAP_EDGES,!0),this.logOperatorTimeShow(F.GENERATE_CONTOURS_SANITIZE_EDGES,!0),this.logOperatorTimeShow(F.GENERATE_CONTOURS_STICH_CONTOURS,!0),this.logOperatorTimeShow(F.TRIANGULATE_CONTOURS,!0),this.logOperatorTimeShow(F.GENERATE_MESHES_TOTAL_COST,!0),this.logOperatorTimeShow(F.GENERATE_MESH_MATERIALS_TOTAL_COST,!0),this.logOperatorTimeShow(F.GENERATE_LINES_TOTAL_COST,!0),this.logOperatorTimeShow(F.GENERATE_LINE_MATERIALS_TOTAL_COST,!0),console.log(F.TOTAL_NUMBER_GENERATED_MESHES,this.totalGeneratedMeshes+". "),console.log(F.TOTAL_NUMBER_CREATED_MESH_MATERIALS,this.totalGeneratedMeshMaterials+". "),console.log(F.TOTAL_NUMBER_GENERATED_LINES,this.totalGeneratedLines+". "),console.log(F.TOTAL_NUMBER_CREATED_LINE_MATERIALS,this.totalGeneratedLineMaterials+". "),this.logOperatorTimeShow(F.GENERATE_CAP_MESH_SINGLE_CLIP,!0),this.logOperatorTimeShow(F.CLIP_NDS_MODEL))},this.resetLogOperatorTime=()=>{o&&(this.totalGeneratedMeshes=0,this.totalGeneratedMeshMaterials=0,this.totalGeneratedLines=0,this.totalGeneratedLineMaterials=0,this.logOperatorTimeInfo={},this.logOperatorAccumutiveInfo={})}}}class U{static get SECTION_ROOT_NAME(){return"sectionRoot"}constructor(e){this.sceneWrapper=e,this.measureClipUtil=new re(e.getModelUnit()),this.intersector=new oe,this.triangulator=new ne,this.bGenerateCapMeshes=!0,this.showSectionPlane=!0,this.showClipLineVisible=!0,this.boxCenter=new THREE.Vector3,this.fakeMeshMaterial=new THREE.MeshBasicMaterial,this._clipImageSize={xMax:-1/0,xMin:1/0,yMax:-1/0,yMin:1/0},this._clipImagePoints=[],this.showDebugIntersections=!1,this.logger=new F}getClippingObjectUUID(e){return e.uuid+"-"+e.ndsModel.id}setEnableGenerateCapMeshes(e){this.bGenerateCapMeshes=e}isObjectExcludeFromClipping(e){return!1}preprocessPlaneBeforeClipping(e){}needsShowClipImage(e){return!1}onBeforeUpdateCapMeshes(){}onAfterUpdateCapMeshes(){}onAfterCapLineCreated(e,t,i){}onAfterCapMeshCreated(e){}onAfterCapMeshAndLineGenerated(e,t){}onAfterClipImageCreated(){}prepareCapMeshMaterial(e,t){}toggleShowDebugIntersectionPoint(){this.showDebugIntersections=!this.showDebugIntersections}enableLogPerformance(){this.logger.enableLogPerformance()}updateCapMeshs(r,e){if(e&&this.bGenerateCapMeshes){var s=this.logger,t=(s.resetLogOperatorTime(),s.logOperatorTimeBegin(F.UPDATE_CAP_MESH_EVENT),s.logOperatorTimeBegin(F.RELEASE_OLD_CAP_MESH),e.getObjectByName(U.SECTION_ROOT_NAME)),t=(t&&(NDSWebViewer.COMMON.disposeObject(t),e.remove(t)),this.onBeforeUpdateCapMeshes(),s.logOperatorTimeShow(F.RELEASE_OLD_CAP_MESH,!1,!0),new THREE.Group),l=(t.name=U.SECTION_ROOT_NAME,e.add(t),new THREE.Group),a=(t.add(l),new THREE.Group),p=(t.add(a),new THREE.Box3);if(0<this.sceneWrapper.getModelCount()){s.logOperatorTimeBegin(F.GENERATE_LINE_MATERIALS_TOTAL_COST);for(var h=new THREE.LineBasicMaterial({opacity:1}),d=(h.color.setRGB(1,0,0),s.totalGeneratedLineMaterials++,s.logOperatorTimeEnd(F.GENERATE_LINE_MATERIALS_TOTAL_COST),this._clipImageSize.xMax=-1/0,this._clipImageSize.xMin=1/0,this._clipImageSize.yMax=-1/0,this._clipImageSize.yMin=1/0,new THREE.Plane),c=0;c<r.length;c++){let e=r[c].clone(),t=(this.preprocessPlaneBeforeClipping(e),this.intersector.makePlaneBasis(e)),i=(new THREE.Matrix4).getInverse(t),n=0,o={};for(var u=this.sceneWrapper.getModelCount(),f=0;f<u;f++){s.logOperatorTimeBegin(F.CLIP_NDS_MODEL),this.sceneWrapper.setActiveModel(f);var m=this.sceneWrapper.getMeshManager(),g=this.sceneWrapper.getModelByIndex(f);if(!g.isSketchModel&&(g.rootBodyNode.getBoundingBox(p),this.intersector.intersectBoxPlane(e,p))){for(var _=g.wholeLeafBodyNodes,C=0,Y=_.length;C<Y;++C){var P=_[C],y=this.getClippingObjectUUID(P);if(!this.isObjectExcludeFromClipping(y)){y=P._leafBodyAttri;if(y&&(P.getBoundingBox(p),this.intersector.intersectBoxPlane(e,p))){var E=y._bodyMeshIds;if(E&&!(E.length<1)){s.logOperatorTimeBegin(F.COMPUTE_INTERSECTIONS);for(var v=[],x=null,T=0;T<E.length;T++){var S=E[T];if(!m.isMeshHidden(S)&&(m.getMeshBBox(S,p),this.intersector.intersectBoxPlane(e,p))){for(var M,I,w,b=!0,N=0;N<r.length;++N)if(N!=c){d.copy(r[N]);var O=d,R=(this.preprocessPlaneBeforeClipping(O),O.distanceToPoint(p.getCenter(this.boxCenter)));if(!this.intersector.intersectBoxPlane(O,p)&&Math.sign(R)<0){b=!1;break}}b&&(m.getMeshInfor(S,M={}),x=x||M.material,I={},w=[],s.logOperatorTimeBegin(F.COMPUTE_INTERSECTIONS_PLANE_MESH),this.intersector.intersectMeshPlane(e,M.geometry,M.matrixWorld,S,w),s.logOperatorTimeEnd(F.COMPUTE_INTERSECTIONS_PLANE_MESH),v=v.concat(w))}}if(v.length<1)s.logOperatorTimeEnd(F.COMPUTE_INTERSECTIONS);else{for(N=0;N<r.length;++N){if(N!=c){d.copy(r[N]);for(var A,O=d,L=(this.preprocessPlaneBeforeClipping(O),[]),T=0;T<v.length;T++){var B=new THREE.Vector3,D=new THREE.Vector3;1!=this.intersector.intersectSegmentPlane(O,v[T].pt1,v[T].pt2,B,D)?(R=O.distanceToPoint(v[T].pt1),Math.sign(R)<0&&1e-6<Math.abs(R)&&(v.splice(T,1),T--)):(R=O.distanceToPoint(v[T].pt1),D=O.distanceToPoint(v[T].pt2),V=v[T],Math.abs(R)<1e-6?(Math.sign(D)<0&&(v.splice(T,1),T--),I[V.eid1]=B):Math.sign(R)<0?(Math.abs(D)<1e-6?(v.splice(T,1),T--):(V.pt1=B,V.eid1=V.eid1+":"+N),I[V.eid1]=B):0<Math.sign(R)&&(1e-6<Math.abs(D)&&(V.pt2=B,V.eid2=V.eid2+":"+N),I[V.eid2]=B),L.find(function(e){return Math.abs(B.x-e.x)<1e-6&&Math.abs(B.y-e.y)<1e-6&&Math.abs(B.z-e.z)<1e-6})||L.push(B.clone()))}if(0<L.length&&L.length%2==0){2<L.length&&(A=this.intersector.makePlaneBasis(O),L.sort(function(e,t){e=e.clone().applyMatrix4(A),t=t.clone().applyMatrix4(A);return 1e-6<Math.abs(e.x-t.x)?e.x-t.x:e.y-t.y}));for(T=0;T<L.length;T+=2){var V,W=X(I,L[T]),H=X(I,L[T+1]);(V=new this.triangulator.Edge(L[T],L[T+1],0,0,1,1,2)).eid1=W,V.eid2=H,v.push(V)}}}function X(t,i){return Object.keys(t).find(function(e){e=t[e];return Math.abs(e.x-i.x)<1e-6&&Math.abs(e.y-i.y)<1e-6&&Math.abs(e.z-i.z)<1e-6})}}s.logOperatorTimeEnd(F.COMPUTE_INTERSECTIONS);P=!1;this.needsShowClipImage(c)&&(P=!0),s.logOperatorTimeBegin(F.GENERATE_CAP_MESH_SINGLE_CLIP),this._generateCapLineAndMesh(v,x,t,i,h,a,l,P,o),s.logOperatorTimeEnd(F.GENERATE_CAP_MESH_SINGLE_CLIP)}}}}}s.logGatheredStatistics()}}Object.keys(o).sort(function(e,t){return e-t}).forEach(function(e){o[e].material.polygonOffsetFactor=n,n+=.01}),this.needsShowClipImage(c)&&this._createClipImage(o),o={}}this.onAfterUpdateCapMeshes()}s.logOperatorTimeShow(F.UPDATE_CAP_MESH_EVENT),s.resetLogOperatorTime()}}disposeCapMesh(e){e&&e.name===U.SECTION_ROOT_NAME&&NDSWebViewer.COMMON.disposeObject(e)}_generateCapLineAndMesh(e,t,i,n,o,r,s,l,a){if(0<e.length){var p=this.logger,h=(this.measureClipUtil.clearClipInfo(),new THREE.Box3),d=(p.logOperatorTimeBegin(F.GENERATE_CONTOURS),this.intersector.convertToPlaneCoords(i,e,h),new this.triangulator.ContourSet(e,h)),i=(p.logOperatorTimeBegin(F.GENERATE_CONTOURS_SNAP_EDGES),d.snapEdges(),p.logOperatorTimeEnd(F.GENERATE_CONTOURS_SNAP_EDGES),p.logOperatorTimeBegin(F.GENERATE_CONTOURS_SANITIZE_EDGES),d.sanitizeEdges(),p.logOperatorTimeEnd(F.GENERATE_CONTOURS_SANITIZE_EDGES),p.logOperatorTimeBegin(F.GENERATE_CONTOURS_STICH_CONTOURS),d.stitchContours(),p.logOperatorTimeEnd(F.GENERATE_CONTOURS_STICH_CONTOURS),p.logOperatorTimeEnd(F.GENERATE_CONTOURS),p.logOperatorTimeBegin(F.GENERATE_LINES_TOTAL_COST),this.measureClipUtil.createLineSegmentGeo(d)),e=new THREE.LineSegments(i,o);if(e.matrix.copy(n),e.matrixAutoUpdate=!1,e.frustumCulled=!1,r.add(e),p.totalGeneratedLines++,p.logOperatorTimeEnd(F.GENERATE_LINES_TOTAL_COST),this.showDebugIntersections){let t=void 0;if(d.contours){for(let e=0;e<d.contours.length;++e)(t=this.measureClipUtil.createDebugContourPointMesh(d,d.contours[e],e)).applyMatrix4(n),t.frustumCulled=!1,r.add(t);var c=[];for(let e=0;e<d.contours.length;++e){var u=d.contours[e],f=u.length;if(u[0]!==u[f-1])for(let e=0;e<u.length;++e)c.push([d.pts[u[e]].x,d.pts[u[e]].y])}}else(t=this.measureClipUtil.createDebugPointMesh(d)).applyMatrix4(n),t.frustumCulled=!1,r.add(t)}h={};if(this.onAfterCapLineCreated(e,n,h),this.showSectionPlane){p.logOperatorTimeBegin(F.TRIANGULATE_CONTOURS);var m=new this.triangulator.TriangulatedSurface(d);if(p.logOperatorTimeEnd(F.TRIANGULATE_CONTOURS),m.indices.length){p.logOperatorTimeBegin(F.GENERATE_MESHES_TOTAL_COST),this._clipImagePoints.length=0;var i=this.measureClipUtil.createFaceMeshGeo(m,d,t.packedNormals),g=(m.cset.bbox.max.x-m.cset.bbox.min.x)*(m.cset.bbox.max.y-m.cset.bbox.min.y);if(this._clipImageSize.xMax=Math.max(m.cset.bbox.max.x,this._clipImageSize.xMax),this._clipImageSize.yMax=Math.max(m.cset.bbox.max.y,this._clipImageSize.yMax),this._clipImageSize.xMin=Math.min(m.cset.bbox.min.x,this._clipImageSize.xMin),this._clipImageSize.yMin=Math.min(m.cset.bbox.min.y,this._clipImageSize.yMin),l)for(var _=0;_<m.indices.length;_+=3){var C=m.pts[m.indices[_]],P=m.pts[m.indices[_+1]],y=m.pts[m.indices[_+2]];this._clipImagePoints.push(new THREE.Vector2(C.x,C.y)),this._clipImagePoints.push(new THREE.Vector2(P.x,P.y)),this._clipImagePoints.push(new THREE.Vector2(y.x,y.y))}p.logOperatorTimeBegin(F.GENERATE_MESH_MATERIALS_TOTAL_COST);o=new THREE.ShaderMaterial({side:THREE.DoubleSide,uniforms:{color:{type:"c",value:new THREE.Color(1,1,1)},hatchParams:{type:"v2",value:new THREE.Vector2(1,10)},hatchTintColor:{type:"c",value:new THREE.Color(0,1,1)},hatchTintIntensity:{type:"f",value:.2},hatchLineColor:{type:"c",value:new THREE.Color(0,0,0)},showLine:{type:"f",value:1},showMesh:{type:"f",value:1}},vertexShader:NDSWebViewer.ClippingShader.ClippingPlanesShader3.vertex,fragmentShader:NDSWebViewer.ClippingShader.ClippingPlanesShader3.fragment});for(o.polygonOffset=!0,o.polygonOffsetFactor=0,o.polygonOffsetUnits=1;-1!=Object.keys(a).indexOf(g.toString());)g*=1+1e-5;a[g]={material:o,triangle:this._clipImagePoints.concat()};e=Object.keys(a).length*Math.PI*10/180+Math.PI/4,l=Math.tan(e),e=(o.uniforms.hatchParams.value=new THREE.Vector2(l,20),o.uniforms.color.value=t.color.clone(),this.prepareCapMeshMaterial(o,t),o.needsUpdate=!0,p.totalGeneratedMeshMaterials++,p.logOperatorTimeEnd(F.GENERATE_MESH_MATERIALS_TOTAL_COST),new THREE.Mesh(i,o));e.matrix.copy(n),e.matrixAutoUpdate=!1,s.add(e),this.onAfterCapMeshCreated(e),p.totalGeneratedMeshes++,p.logOperatorTimeEnd(F.GENERATE_MESHES_TOTAL_COST)}else this.onAfterCapMeshCreated({fakeMesh:!0,geometry:new NDSWebViewer.NdsGeometry,matrix:this.measureClipUtil.GLOBAL_IDENTITY_MATRIX,id:-1,material:this.fakeMeshMaterial})}this.onAfterCapMeshAndLineGenerated(h.bodyNodeUUID,{edgeGroup:this.measureClipUtil.edgeGroup,faceGroup:this.measureClipUtil.faceGroup})}}_createClipImage(d){var e=document.createElement("canvas"),t=Math.max(this._clipImageSize.xMax-this._clipImageSize.xMin,this._clipImageSize.yMax-this._clipImageSize.yMin),c=(e.width=1.1*t,e.height=1.1*t,1),u=(t<40?(e.width=420,e.height=420,c=400/t):e.width<400?(e.width=10*t+40,e.height=10*t+40,c=10):6e3<e.width&&(e.width=640,e.height=640,c=600/t),e.width/2-(this._clipImageSize.xMax+this._clipImageSize.xMin)*c/2),f=e.height/2-(this._clipImageSize.yMax+this._clipImageSize.yMin)*c/2,m=e.getContext("2d");let g=this;Object.keys(d).sort(function(e,t){return t-e}).forEach(function(e){m.beginPath();var[t,i,n]=[Math.floor(176*Math.random()+79),Math.floor(112*Math.random()+15),Math.floor(32*Math.random()+15)];m.fillStyle=`rgb(${t},${i},${n})`,g._clipImagePoints=d[e].triangle;for(var o=0;o<g._clipImagePoints.length;o+=3){var r=g._clipImagePoints[o].x,s=g._clipImagePoints[o].y,r=r*c+u,s=s*c+f,l=g._clipImagePoints[o+1].x,a=g._clipImagePoints[o+1].y,l=l*c+u,a=a*c+f,p=g._clipImagePoints[o+2].x,h=g._clipImagePoints[o+2].y,p=p*c+u,h=h*c+f;m.moveTo(r,s),m.lineTo(l,a),m.lineTo(p,h)}m.fill()});t=e.toDataURL("image/png");this.sceneWrapper.dispatchEvent({type:"ActiveSectionViewChangeEvent",base64Img:t}),this.onAfterClipImageCreated()}}function X(e,t,i){THREE.Mesh.call(this,e,t,!1),this.tempVector3=new THREE.Vector3,this.plane=i,this.planeVec=new THREE.Vector4(i.normal.x,i.normal.y,i.normal.z,i.constant),this.connectivity=[],this.outlines=[]}((X.prototype=Object.create(THREE.Mesh.prototype)).constructor=X).prototype.update=function(){this.plane.normal.set(0,0,-1),this.plane.normal.applyQuaternion(this.quaternion);var e=this.plane.normal,t=-1*this.getWorldPosition(this.tempVector3).dot(e);this.planeVec.set(e.x,e.y,e.z,t),this.plane.constant=t};class se{constructor(e){this.viewer=e,this.sceneWrapper=new n(e),this.clipDataManagerWrapper=new o(e.clipDataManager);let y=new U(this.sceneWrapper);var E=this,v=(this.active=!1,[[0,1],[1,3],[3,2],[2,0]]),x=(this.tempVector3=new THREE.Vector3,this._domElement=null,[]),T=[],S=null,M=null,I=null,w=null,b=null,N={},r="Right",O={},R={},A=1;function L(){this.run=function(){I&&(I.update(),I.updateMatrixWorld(!0)),w&&w.update()}}this.tempCenterBox=new THREE.Vector3,N.clipping_planes_fragment=THREE.ShaderChunk.clipping_planes_fragment,N.clipping_planes_pars_fragment=THREE.ShaderChunk.clipping_planes_pars_fragment,N.meshphong_frag=THREE.ShaderChunk.meshphong_frag,N.meshphysical_frag=THREE.ShaderChunk.meshphysical_frag,N.phongFrag=THREE.ShaderLib.phong.fragmentShader,N.physicalFrag=THREE.ShaderLib.physical.fragmentShader,this.init(e),this.getTransformControls=function(){return I},this.getPlaneEditControls=function(){return w},this.SetRenderBox=function(e){M&&(M.visible=e)},this.setEnableGenerateCapMeshes=function(e){y.setEnableGenerateCapMeshes(e)},this.getBoxClipInfo=function(){var e={};if(e.clipBoxActive=E.active,e.clipBoxActive){for(var t=E.getPlaneEditControls(),i=(t.getCurrAttachObj()&&(e.PlaneName=t.getCurrAttachObj().name,e.PlanePosition=t.getCurrentControls().newPosition),E.viewer.renderer.clippingPlanes),n=new THREE.Vector3(-1e4,-1e4,-1e4),o=new THREE.Vector3(1e4,1e4,1e4),r=0;r<i.length;r++).001<Math.abs(i[r].normal.x)?(n.x=Math.max(n.x,-1*i[r].normal.x*i[r].constant),o.x=Math.min(o.x,-1*i[r].normal.x*i[r].constant)):.001<Math.abs(i[r].normal.y)?(n.y=Math.max(n.y,-1*i[r].normal.y*i[r].constant),o.y=Math.min(o.y,-1*i[r].normal.y*i[r].constant)):(n.z=Math.max(n.z,-1*i[r].normal.z*i[r].constant),o.z=Math.min(o.z,-1*i[r].normal.z*i[r].constant));t=E.getTransformControls().object.position,t=(e.BoxPosition=t,new THREE.Box3(o,n));e.clipbox=t,e.planeMeshPositions=[];for(var s=0;s<x.length;++s)e.planeMeshPositions[s]=x[s].position}return e},this.setPlanePosition=function(e){for(var t=0;t<x.length;++t)x[t].position.copy(e[t])};function B(){(I=new NDSWebViewer.TransformControls(E.viewer,E._domElement)).setSize(.6),I.setMode("translate"),I.setSpace("local"),I.addEventListener("change",function(){E.viewer.render()}),I.addEventListener("objectChange",function(){var e=Date.now();D(),NDSWebViewer.SETTING.enableBroadcast&&NDSWebViewer.SETTING.broadcastMajor&&NDSWebViewer.ExtensionManager.updateBroadcastInfo("ClipExtension"),E.viewer.logOperatorTime&&E.viewer.logOperatorTimeShow("[][]",e)}),I.attach(S),M.add(I),(w=new NDSWebViewer.EditControls({objects:x,domElement:E._domElement,viewer:E.viewer,group:M})).setSize(.5),w.activate("translate","translateZ"),w.addEventListener("change",function(){E.viewer.render()}),w.addEventListener("objectChange",function(){var e=Date.now(),t=(D(),V(),E.viewer.renderer.clippingPlanes);if(t&&!(t.length<3)&&S){for(var i=E.viewer.controls.getBoundingBox().min.clone(),n=.001,o=0;o<t.length;o++)Math.abs(t[o].normal.x)>n?i.x=Math.max(i.x,-1*t[o].normal.x*t[o].constant):Math.abs(t[o].normal.y)>n?i.y=Math.max(i.y,-1*t[o].normal.y*t[o].constant):i.z=Math.max(i.z,-1*t[o].normal.z*t[o].constant);n=1e-6;var r,s=i.clone().sub(S.position),l=(s.x=Math.abs(s.x)<n?0:s.x,s.y=Math.abs(s.y)<n?0:s.y,s.z=Math.abs(s.z)<n?0:s.z,S.position.add(s),w.getCurrentControls());l&&(r=l.getOldPosition(),r=(r=r||new THREE.Vector3).clone().sub(s),l.setOldPosition(r));for(o=0;o<S.children.length;o++){var a=S.children[o];a instanceof X&&a.position.sub(s)}S.updateMatrixWorld(!0)}E.viewer.render(),NDSWebViewer.SETTING.enableBroadcast&&NDSWebViewer.SETTING.broadcastMajor&&NDSWebViewer.ExtensionManager.updateBroadcastInfo("ClipExtension"),E.viewer.logOperatorTime&&E.viewer.logOperatorTimeShow("[][]",e)})}var D=function(){S&&S.traverse(function(e){e instanceof X&&e.update()});for(var e=[],t=0;t<T.length;t++){var i=(new THREE.Plane).setComponents(T[t].x,T[t].y,T[t].z,T[t].w);e.push(i)}y.updateCapMeshs(e,M),E.viewer.renderer.clippingPlanes=e};this.getOperateMode=function(){return A},this.setOperateMode=function(e){A=e},this.setActivePlaneByName=function(e){r=e},this.getActivePlaneName=function(){return r},this.activePlaneCanForward=function(){if(!this.active)return!1;var e=!0,t=(O[r].updateMatrixWorld(!0),O[r].position),i=null;switch(r){case"Right":O.Left.updateMatrixWorld(!0),i=O.Left.position,t.distanceTo(i)<1&&(e=!1);break;case"Left":i=O.Right.position,t.distanceTo(i)<1&&(e=!1);break;case"Up":i=O.Down.position,t.distanceTo(i)<1&&(e=!1);break;case"Down":i=O.Up.position,t.distanceTo(i)<1&&(e=!1);break;case"Front":i=O.Back.position,t.distanceTo(i)<1&&(e=!1);break;case"Back":i=O.Front.position,t.distanceTo(i)<1&&(e=!1)}return e},this.planeTranslate=function(e){if(!this.active)return!1;var t=null,i=null,n=null,o=null;switch(r){case"Right":i=R.Left,n=R.Right,t=i.clone().sub(n),o=n.clone().add(t.multiplyScalar(e)),O[r].position.copy(o);break;case"Left":i=R.Right,n=R.Left,t=i.clone().sub(n),o=n.clone().add(t.multiplyScalar(e)),O[r].position.copy(o);break;case"Up":i=R.Down,n=R.Up,t=i.clone().sub(n),o=n.clone().add(t.multiplyScalar(e)),O[r].position.copy(o);break;case"Down":i=R.Up,n=R.Down,t=i.clone().sub(n),o=n.clone().add(t.multiplyScalar(e)),O[r].position.copy(o);break;case"Front":i=R.Back,n=R.Front,t=i.clone().sub(n),o=n.clone().add(t.multiplyScalar(e)),O[r].position.copy(o);break;case"Back":i=R.Front,n=R.Back,t=i.clone().sub(n),o=n.clone().add(t.multiplyScalar(e)),O[r].position.copy(o)}return O[r].updateMatrixWorld(!0),V(),D(),E.viewer.render(),!0},this.isClipTransformControlSelected=function(){var e=!1,t=!1;return I&&(e=I.isSelected()),w&&(t=w.isSelected()),e||t},this.renderClipBox=function(e,t){M&&M.visible&&(e?E.viewer.renderer.render(M,E.viewer.camera,e,t):E.viewer.renderer.render(M,E.viewer.camera))},this.toggleShowDebugIntersectionPoint=()=>{y.toggleShowDebugIntersectionPoint()},this.enableLogPerformance=()=>{y.enableLogPerformance()};this.onBoxSectionView=function(e,t){if(this.sceneWrapper.isLoadedNdsModelEmpty())this.active=e;else{if(e){this.active=!0,THREE.ShaderChunk.clipping_planes_fragment=NDSWebViewer.ClippingShader.ClippingPlanesShader_fragment1,THREE.ShaderChunk.clipping_planes_pars_fragment=NDSWebViewer.ClippingShader.ClippingPlanesShader_pars_fragment1,THREE.ShaderChunk.meshphong_frag=NDSWebViewer.ClippingShader.ClippingPlanesShader1_MeshPhong,THREE.ShaderLib.phong.fragmentShader=NDSWebViewer.ClippingShader.ClippingPlanesShader1_MeshPhong,THREE.ShaderChunk.meshphysical_frag=NDSWebViewer.ClippingShader.ClippingPlanesShader1_MeshPhysical,THREE.ShaderLib.physical.fragmentShader=NDSWebViewer.ClippingShader.ClippingPlanesShader1_MeshPhysical;var e=t,i=[new THREE.Vector3(1,0,0),new THREE.Vector3(0,1,0),new THREE.Vector3(0,0,1),new THREE.Vector3(-1,0,0),new THREE.Vector3(0,-1,0),new THREE.Vector3(0,0,-1)],n=["Right","Up","Front","Left","Down","Back"],o=[[[1,2],[1,5],[2,4],[4,5]],[[3,5],[0,5],[2,3],[0,2]],[[1,3],[0,1],[3,4],[0,4]],[[1,5],[1,2],[4,5],[2,4]],[[2,3],[0,2],[3,5],[0,5]],[[0,1],[3,1],[0,4],[3,4]]],r=new THREE.Group,t=(S=r,null),s=(t=E.viewer.controls.getBoundingBox()).getSize(),s=Math.max(Math.max(s.x,s.y),s.z)/50,s=new THREE.Vector3(s,s,s),l=t.clone();l.expandByVector(s),e&&l.copy(e);for(var a=l.max,p=(r.position.copy(a),[]),h=[],d=0;d<i.length;d++){var c=new THREE.Plane(i[d],-1*a.dot(i[d]));p.push(c),2<d&&(3==d?c.constant-=l.max.x-l.min.x:4==d?c.constant-=l.max.y-l.min.y:5==d&&(c.constant-=l.max.z-l.min.z)),(u=function(e,t){var i=new THREE.Quaternion;i.setFromUnitVectors(new THREE.Vector3(0,0,1),e.normal),h=t?(n=e.projectPoint(t.max),r=e.projectPoint(t.min),s=i.clone().inverse(),n.applyQuaternion(s),r.applyQuaternion(s),s=(new THREE.Vector3).subVectors(n,r),new THREE.PlaneGeometry(s.x,s.y)):(s=2*(t=_viewer.getVisibleBounds()).getBoundingSphere().radius,new THREE.PlaneGeometry(s,s));for(var n=new THREE.MeshBasicMaterial({opacity:.1,color:16777215,side:THREE.DoubleSide,depthTest:!1,depthWrite:!1,transparent:!0}),o=new X(h,n,e),r=t.getCenter(),s=e.projectPoint(r),n=(o.position.copy(s),o.quaternion.multiply(i),new THREE.Color(16711680)),l=new THREE.LineBasicMaterial({color:n,linewidth:1}),a=o.geometry.getAttribute("position"),p=0;p<v.length;p++){(h=new THREE.Geometry).vertices.push((new THREE.Vector3).fromArray(a.array,v[p][0]*a.itemSize),(new THREE.Vector3).fromArray(a.array,v[p][1]*a.itemSize));var h,d=new THREE.Line(h,l);o.add(d),o.outlines.push(d)}return o}(c,l)).position.sub(a),u.name=d,r.add(u),h.push(u),x.push(u),O[n[d]]=u,R[n[d]]=u.position.clone(),T.push(u.planeVec)}for(d=0;d<h.length;d++)for(var u=h[d],f=o[d],m=0;m<f.length;m++){for(var g=[],_=f[m],C=0;C<_.length;C++)g.push(p[_[C]]);u.connectivity.push(g)}null==M&&(M=new THREE.Scene),S.updateMatrixWorld(!0),M.add(S),V(),D(),1==A&&B(),null==b&&(b=new L),E.viewer.addFrameListener(b),this.initClipDataManager()}else{this.active=!1,THREE.ShaderChunk.clipping_planes_fragment=N.clipping_planes_fragment,THREE.ShaderChunk.clipping_planes_pars_fragment=N.clipping_planes_pars_fragment,THREE.ShaderChunk.meshphong_frag=N.meshphong_frag,THREE.ShaderChunk.meshphysical_frag=N.meshphysical_frag,THREE.ShaderLib.phong.fragmentShader=N.phongFrag,THREE.ShaderLib.physical.fragmentShader=N.physicalFrag,b&&(E.viewer.removeFrameListener(b),b=null);for(var P=0;P<x.length;P++)NDSWebViewer.COMMON.disposeObject(x[P]);if(x=[],T=[],S=null,this.clearClipDataManager(),M)for(P=0;P<M.children.length;P++)y.disposeCapMesh(M.children[P]),M.remove(M.children[P]),P--;M=null,I&&(I.dispose(),I=null),w&&(w.dispose(),w=null),E.viewer.renderer.clippingPlanes=[]}E.viewer.render()}};s=new THREE.Matrix3,l=new THREE.Vector3,a=new THREE.Vector3,p=new THREE.Vector3;var s,l,a,p,h=function(e,t,i,n){s.set(e.normal.x,e.normal.y,e.normal.z,t.normal.x,t.normal.y,t.normal.z,i.normal.x,i.normal.y,i.normal.z);var o=s.determinant();return 0===o?null:(l.crossVectors(t.normal,i.normal).multiplyScalar(-e.constant),a.crossVectors(i.normal,e.normal).multiplyScalar(-t.constant),p.crossVectors(e.normal,t.normal).multiplyScalar(-i.constant),(n||new THREE.Vector3).copy(l).add(a).add(p).divideScalar(o))};function V(){for(var e=0;e<S.children.length;e++){var t=S.children[e];if(t instanceof X&&0<t.connectivity.length){for(var i=(new THREE.Matrix4).getInverse(t.matrixWorld),n=new THREE.Vector3,o=t.geometry.getAttribute("position"),r=0;r<3*o.count/o.itemSize;r++){var s=t.connectivity[r];null!==h(t.plane,s[0],s[1],n)&&(n.applyMatrix4(i),o.setXYZ(r,n.x,n.y,n.z),n.clone().add(t.position))}o.needsUpdate=!0,t.geometry.computeBoundingBox(),t.geometry.computeBoundingSphere();for(r=0;r<t.outlines.length;r++){var l=t.outlines[r];l.geometry.vertices[0].fromArray(o.array,v[r][0]*o.itemSize),l.geometry.vertices[1].fromArray(o.array,v[r][1]*o.itemSize),l.geometry.verticesNeedUpdate=!0}}}}this.isSectionBoxEnabled=function(){return!!M},this.displaySectionBox=function(e){S&&((S.visible=e)?I.attach(S):(I.detach(I.object),w.detach())),E.viewer.render()},this.getSectionBoxVisible=function(){return!!S&&S.visible},this.initClipDataManager=function(){if(this.clipDataManagerWrapper){this.clipDataManagerWrapper.enableBoxClip();var t=[],i=[];for(let e=0;e<x.length;++e)t.push(x[e].plane),i.push(x[e].position);this.clipDataManagerWrapper.setClipPlanes(t,i)}},this.clearClipDataManager=function(){this.clipDataManagerWrapper&&this.clipDataManagerWrapper.disableBoxClip()}}init(e){e.canvas2D?this._domElement=e.canvas2D:this._domElement=e.canvas3D}}function R(e,t,i=0){NDSWebViewer.NdsModel.call(this,e,t,{modelId:-999}),this.brepManager=new NDSWebViewer.NdsBrepManager(e,null,this),this.brepManager.refCount=1,this.brepManager.version=2,this.state=4,this.bodyNodeIdSuffix=0,this.lineSegmentGeomUUIDList=[],this.meshSegementGeomUUIDList=[],this.meshMaterials=[],this.geomManager.dispose=()=>{for(let e=0,t=this.geomManager.geoms.length;e<t;++e)this.geomManager.geoms[e].dispose(),this.geomManager.geoms[e]=null;this.geomManager.geoms=[],this.geomManager.uuidToIdMap={}},this.isClipModel=!0,this.isModelIntersected=!1}(R.prototype=Object.create(NDSWebViewer.NdsModel.prototype)).initClipModel=function(){var e=new NDSWebViewer.NdsBodyNode;e.fileUnit="millimeter",e.id=-1,e.name="ClipModelRootNode",e.ndsModel=this,e.needOutlinePassRender=!1,e.objectid="o_0",e.type="Model",e.uuid="clip_model_node_root",e.worldMatrix=new THREE.Matrix4,this.bodyUuid2NodeMap[e.uuid]=e,this.rootBodyNode=e},R.prototype.setIsClipModelIntersected=function(e){this.isModelIntersected=e},R.prototype.getIsClipModelIntersected=function(){return this.isModelIntersected},R.prototype.createNewLeafBodyNode=function(t){var i=new NDSWebViewer.NdsBodyNode;i.id=this.bodyNodeIdSuffix,i.ndsModel=this,i.parent=this.rootBodyNode,i.objectid="b_"+this.bodyNodeIdSuffix,i.type="Body",i.uuid="clip_model_node_"+this.bodyNodeIdSuffix,i.worldMatrix=new THREE.Matrix4,i.matrix=[];for(let e=0;e<16;++e)i.matrix[e]=t.elements[e];return i.leafBodyAttri=new NDSWebViewer.NdsLeafBodyAttri(i),this.wholeLeafBodyNodes.push(i),this.rootBodyNode.children.push(i),this.bodyUuid2NodeMap[i.uuid]=i,this.bodyNodeIdSuffix++,i},R.prototype.addClipMeshToModel=function(e,t=!1){var i,n=e.geometry,o=(this.geomManager.addGeom(n),new THREE.Box3),r=(e.fakeMesh||(i=n.boundingBox,r=new THREE.Vector3(i.min.x,i.min.y,i.min.z),i=new THREE.Vector3(i.max.x,i.max.y,i.max.z),r=r.applyMatrix4(e.matrix),i=i.applyMatrix4(e.matrix),o.expandByPoint(r),o.expandByPoint(i)),0===this.wholeLeafBodyNodes.length&&this.createNewLeafBodyNode(new THREE.Matrix4),this.wholeLeafBodyNodes[this.wholeLeafBodyNodes.length-1]);t?(r.leafBodyAttri.bodyLineSegIds.push(this.lineSegmentGeomUUIDList.length),this.lineSegmentGeomUUIDList.push(n.uuid)):(r.leafBodyAttri.bodyMeshIds.push(this.meshSegementGeomUUIDList.length),this.meshSegementGeomUUIDList.push(n.uuid),this.meshMaterials.push(e.material)),e.fakeMesh||(r.leafBodyAttri.bodyBbox=[o.min.x,o.min.y,o.min.z,o.max.x,o.max.y,o.max.z])},R.prototype.initMeshManager=function(){var t=this.lineSegmentGeomUUIDList.length;this.meshManager.setNumLineSegments(t);for(let e=0;e<t;++e){var i=e,n=this.lineSegmentGeomUUIDList[e],o=this.wholeLeafBodyNodes[e].uuid;this.meshManager.setLineSegmentsFromGeomUuid(i,n,o),this.meshManager.lineSegBodyNodes[e]=this.wholeLeafBodyNodes[e],this.meshManager.lineSegGeomId[e]=this.geomManager.getGeomIdFromUuid(n,0)}var r=this.meshSegementGeomUUIDList.length;this.meshManager.setNumMeshes(r);for(let e=0;e<r;++e){var s=e,l=this.meshSegementGeomUUIDList[e],a=this.wholeLeafBodyNodes[e].uuid,p=this.geomManager.geoms[e].boundingBox.clone(),p=(p.applyMatrix4(this.wholeLeafBodyNodes[e].worldMatrix),[p.min.x,p.min.y,p.min.z,p.max.x,p.max.y,p.max.z]);this.meshManager.bodyNodes[e]=this.wholeLeafBodyNodes[e],this.meshManager.mats.push(this.meshMaterials[e]),this.meshManager.geomId[e]=this.geomManager.getGeomIdFromUuid(l,0),this.meshManager.setMeshFromGeomUuid(s,p,l,0,e,a)}this.meshManager.reCalculateMeshBBox()},R.prototype.clearMeshData=function(){this.geomManager.dispose(),this.rootBodyNode&&0<this.rootBodyNode.children.length&&(this.rootBodyNode.children=[]),this.bodyUuid2NodeMap={},this.bodyUuid2NodeMap[this.rootBodyNode.uuid]=this.rootBodyNode,this.wholeLeafBodyNodes=[],this.bodyNodeIdSuffix=0,this.lineSegmentGeomUUIDList=[],this.meshSegementGeomUUIDList=[],this.meshMaterials=[],this.brepManager.clearBrepInfo(),this.meshManager.mats=[],this.meshManager.lineSegGeomId=void 0,this.meshManager.geomId=void 0};class le{constructor(s,e,t){this.viewer=s,this.sceneWrapper=new n(s),this.clipDataManagerWrapper=new o(s.clipDataManager);let l=new U(this.sceneWrapper,this);this.clipModel=new R(s,null,{}),this.clipModel.initClipModel(),this.enableClipPlaneMeasure=!0,this.__showSupplementClip=!1,this.__inClipMode=!!NDSWebViewer.COMMON.isMobileDevice();var a=null,p=null,d=[],h=null,c=null,u=null,f=null,m=null,g=null,_=null,C=this;function P(){this.run=function(){C.clipTransRotControl&&(C.clipTransRotControl.update(),C.clipTransRotControl.updateMatrixWorld(!0))}}function y(){c&&l.updateCapMeshs(C.selectedClipPlaneArr,c)}function E(){var e;function t(e){var t,i,n,o,r=new THREE.Vector3(0,0,1),s=h.quaternion;r.applyQuaternion(s);t=r,i=e,n=Math.abs(t.x-i.x)<.001,o=Math.abs(t.y-i.y)<.001,t=Math.abs(t.z-i.z)<.001,n&&o&&t||((i=new THREE.Quaternion).setFromUnitVectors(r,e),s.multiplyQuaternions(i,s),h.setRotationFromQuaternion(s),h.updateMatrixWorld(!0))}0==C.selectedClipPlaneArr.length||0==d.length||C.clipActiveId<0||(a=C.selectedClipPlaneArr[C.clipActiveId],p=d[C.clipActiveId],h=p.children[0],(e=C.clipTransRotControls[C.clipActiveId]).isDragging()&&"translate"===e.pickType&&("X"===e.axis?t(new THREE.Vector3(1,0,0)):"Y"===e.axis?t(new THREE.Vector3(0,1,0)):"Z"===e.axis&&t(new THREE.Vector3(0,0,1))),C.__showSupplementClip?a.normal.set(0,0,1):a.normal.set(0,0,-1),a.normal.applyQuaternion(h.getWorldQuaternion(C.tempQuat)),a.constant=-1*p.getWorldPosition(C.tempVector3).dot(a.normal))}this.tempVector3=new THREE.Vector3,this.clipModeState="both",this.clipTransRotControl=null,this.clipTransRotControls=[],this.clipActiveId=0,this.planeNameToId={},this.showSectionImage=!1,this._showSectionPlane=null,this._clipPlaneShaderVersion=null,this._clipGlobalPlaneObjects=d,this._domElement=null,this.clippingObjectsUuids=[],this.allClippingObjectsUuids=[],this.unClippingObjectsUuids=[],this.partClipObjects=!1,this.isSelectedClip=null,this.uuid2MaterialMap=new Map,this.selectedClipPlaneArr=[],this.flag=!1,this.onCustomClipPlaneStatus=!1,this.mousemoveClickStatus=!1,this.boxCenter=new THREE.Vector3,this.meshColor=new THREE.Color,this.lineColor=new THREE.Color,this.useMeshColor=!1,this.useLineColor=!1,this.showClipLineVisible=!0,this.showClipMeshVisible=!0,this.randomClipMeshColor=!1,this.instanceMeshSet=new Set,this.reverseStateMap=new Map,this.isHideShow=!0,this.clipIntersect=null,this.updateSectionImage=!1,this.init(s,e,t),this.hasClipCapScene=function(){return!g},l.isObjectExcludeFromClipping=e=>C.partClipObjects&&!this.clipDataManagerWrapper.isObjectIncludeInClipping(e),l.preprocessPlaneBeforeClipping=e=>{C.__showSupplementClip&&(e.normal.negate(),e.constant=-1*e.constant)},l.needsShowClipImage=e=>C.clipActiveId==e&&C.showSectionImage&&!C.clipTransRotControl.isDragging(),l.onBeforeUpdateCapMeshes=()=>{C.clipModel.clearMeshData()},l.onAfterUpdateCapMeshes=()=>{C.clipModel.initMeshManager(),C.clipModel.rootBodyNode.applyTransform()},l.onAfterCapLineCreated=(e,t,i)=>{t=C.clipModel.createNewLeafBodyNode(t);i.bodyNodeUUID=t.uuid,C.clipModel.addClipMeshToModel(e,!0)},l.onAfterCapMeshCreated=e=>{C.clipModel.addClipMeshToModel(e)},l.onAfterCapMeshAndLineGenerated=(e,t)=>{C.clipModel.brepManager.addEdgeFaceGroupInfo(e,t.edgeGroup,t.faceGroup)},l.onAfterClipImageCreated=()=>{C.updateSectionImage=!1},l.prepareCapMeshMaterial=(e,t)=>{e&&(e.uniforms.color.value=(C.useMeshColor?C.meshColor:t.color).clone(),C.randomClipMeshColor&&(e.uniforms.color.value=C.getRandomColor()),C.useLineColor&&(e.uniforms.hatchLineColor.value=C.lineColor.clone()),e.uniforms.showLine.value=C.showClipLineVisible?1:0,C.showClipMeshVisible||(e.uniforms.showMesh.value=0,e.transparent=!0,e.blending=THREE.NormalBlending))},this.setActiveSectionPlane=function(e){if(C.clipActiveId=C.planeNameToId[e],!(C.clipActiveId<0||C.clipActiveId>C.clipTransRotControls.length-1)){for(var t,i=0;i<C.clipTransRotControls.length;++i)C.clipTransRotControls[i].visible=!1,d[i].children[0].material.opacity=.2,NDSWebViewer.COMMON.isMobileDevice()||(d[i].visible=!1);this.__inClipMode&&(C.clipTransRotControls[C.clipActiveId].visible=!0),d[C.clipActiveId].visible=C.isHideShow,NDSWebViewer.COMMON.isMobileDevice()||this.sceneWrapper.isECAD3DView()||C.reverseStateMap.has(e)&&(t=C.reverseStateMap.get(e),C.reverseClipDirection(e,t,!1)),NDSWebViewer.COMMON.isMobileDevice()&&(d[C.clipActiveId].children[0].material.opacity=.4),C.clipTransRotControl=C.clipTransRotControls[C.clipActiveId],3===C._clipPlaneShaderVersion&&y(),C.clipTransRotControl.getDeltaRotation(!0,C.clipTransRotControl.RDelta),C.clipTransRotControl.getDeltaPosition(!0),C.viewer.renderAllViews()}},this.deleteSectionPlane=function(e,t=!0){if(c&&-1!=C.planeNameToId[e]){for(var i in C.clipActiveId=C.planeNameToId[e],C.planeNameToId[e]=-1,C.planeNameToId)C.planeNameToId[i]>C.clipActiveId&&C.planeNameToId[i]--;C.clipTransRotControls[C.clipActiveId].visible=!1,C.clipTransRotControls[C.clipActiveId].dispose(),c.remove(C.clipTransRotControls[C.clipActiveId]),c.remove(d[C.clipActiveId]),C.clipTransRotControls.splice(C.clipActiveId,1),d.splice(C.clipActiveId,1),C.selectedClipPlaneArr.splice(C.clipActiveId,1),3===C._clipPlaneShaderVersion&&t&&y(),this.updateClipData(),C.viewer.renderAllViews()}},this.clearReverseState=function(){C.reverseStateMap.clear()},this.renderClipScene=function(e,t){c&&(e?C.viewer.renderer.render(c,C.viewer.camera,e,t):C.viewer.renderer.render(c,C.viewer.camera),C.renderPoints)&&C.renderPoints()},this.renderClipPlane=function(e,t){var i,n;g&&(i=C.viewer.scene.overrideMaterial,C.viewer.renderer.state.buffers.stencil.setTest(!0),n=C.viewer.renderer.context,C.viewer.renderer.state.buffers.stencil.setFunc(n.ALWAYS,1,255),C.viewer.renderer.state.buffers.stencil.setOp(n.KEEP,n.KEEP,n.INCR),C.viewer.scene.overrideMaterial=f,e?C.viewer.renderer.render(C.viewer.scene,C.viewer.camera,e,t):C.viewer.renderer.render(C.viewer.scene,C.viewer.camera),C.viewer.renderer.state.buffers.stencil.setFunc(n.ALWAYS,1,255),C.viewer.renderer.state.buffers.stencil.setOp(n.KEEP,n.KEEP,n.DECR),C.viewer.scene.overrideMaterial=m,e?C.viewer.renderer.render(C.viewer.scene,C.viewer.camera,e,!1):C.viewer.renderer.render(C.viewer.scene,C.viewer.camera),C.viewer.scene.overrideMaterial=i,C.viewer.renderer.state.buffers.stencil.setFunc(n.EQUAL,1,255),C.viewer.renderer.state.buffers.stencil.setOp(n.KEEP,n.KEEP,n.KEEP),e?C.viewer.renderer.render(g,C.viewer.camera,e,!1):C.viewer.renderer.render(g,C.viewer.camera),C.viewer.renderer.state.buffers.stencil.setTest(!1))},this.isClipTransformControlSelected=function(){return!!C.clipTransRotControl&&C.clipTransRotControl.isSelected()},this.isSelectedPlaneFacingCamera=function(){for(var e=this.viewer.camera.target.clone().sub(this.viewer.camera.position).normalize(),t=0;t<C.selectedClipPlaneArr.length;t++)if(C.selectedClipPlaneArr[t].normal.clone().negate().dot(e)<=0)return!0;return!1},this.isPointBeforeClipPlane=function(t){if(!this.supportMeasureClip())return!1;let i=!1;if(this.__showSupplementClip){i=!0;for(var n=0;n<C.selectedClipPlaneArr.length;n++){var o=d[n].position,o=t.clone().sub(o).normalize();let e=C.selectedClipPlaneArr[n].normal.clone();o=(e=e.normalize().negate()).dot(o);i=i&&1e-4<o}}else for(n=0;n<C.selectedClipPlaneArr.length;n++){var r=d[n].position,r=t.clone().sub(r).normalize();let e=C.selectedClipPlaneArr[n].normal.clone();r=(e=e.normalize()).dot(r);i=i||r<=-1e-4}return i},this.enableLogPerformance=()=>{l.enableLogPerformance()},this.toggleShowDebugIntersectionPoint=()=>{l.toggleShowDebugIntersectionPoint()},this.setEnableGenerateCapMeshes=function(e){l.setEnableGenerateCapMeshes(e)},this.setClipTransControlMode=function(e){C.clipModeState=e=void 0===e||"translate"!==e&&"rotate"!==e?"both":e;for(var t=0;t<C.clipTransRotControls.length;t++)C.clipTransRotControls[t].setMode(e),"translate"===e?"YZ"===C.clipTransRotControls[t].name?(C.clipTransRotControls[t].children[0].showAxis("y",!1),C.clipTransRotControls[t].children[0].showAxis("z",!1)):"XZ"===C.clipTransRotControls[t].name?(C.clipTransRotControls[t].children[0].showAxis("z",!1),C.clipTransRotControls[t].children[0].showAxis("x",!1)):"XY"===C.clipTransRotControls[t].name&&(C.clipTransRotControls[t].children[0].showAxis("x",!1),C.clipTransRotControls[t].children[0].showAxis("y",!1)):"rotate"===e?"YZ"===C.clipTransRotControls[t].name?(C.clipTransRotControls[t].children[1].showAxis("x",!1),C.clipTransRotControls[t].children[1].showAxis("y",!0),C.clipTransRotControls[t].children[1].showAxis("z",!0)):"XZ"===C.clipTransRotControls[t].name?(C.clipTransRotControls[t].children[1].showAxis("y",!1),C.clipTransRotControls[t].children[1].showAxis("x",!0),C.clipTransRotControls[t].children[1].showAxis("z",!0)):"XY"===C.clipTransRotControls[t].name&&(C.clipTransRotControls[t].children[1].showAxis("z",!1),C.clipTransRotControls[t].children[1].showAxis("x",!0),C.clipTransRotControls[t].children[1].showAxis("y",!0)):"both"===e&&("YZ"===C.clipTransRotControls[t].name?(C.clipTransRotControls[t].children[2].children[0].showAxis("y",!1),C.clipTransRotControls[t].children[2].children[0].showAxis("z",!1)):"XZ"===C.clipTransRotControls[t].name?(C.clipTransRotControls[t].children[2].children[0].showAxis("z",!1),C.clipTransRotControls[t].children[2].children[0].showAxis("x",!1)):"XY"===C.clipTransRotControls[t].name?(C.clipTransRotControls[t].children[2].children[0].showAxis("x",!1),C.clipTransRotControls[t].children[2].children[0].showAxis("y",!1)):"R"===C.clipTransRotControls[t].name&&(C.clipTransRotControls[t].children[2].children[0].showAxis("y",!1),C.clipTransRotControls[t].children[2].children[0].showAxis("z",!1),C.clipTransRotControls[t].children[2].children[0].showText("r",!1),C.clipTransRotControls[t].children[2].children[0].changeColor("r",{x:.72,y:0,z:.8})),"YZ"===C.clipTransRotControls[t].name?(C.clipTransRotControls[t].children[2].children[1].showAxis("x",!1),C.clipTransRotControls[t].children[2].children[1].showAxis("y",!0),C.clipTransRotControls[t].children[2].children[1].showAxis("z",!0)):"XZ"===C.clipTransRotControls[t].name?(C.clipTransRotControls[t].children[2].children[1].showAxis("y",!1),C.clipTransRotControls[t].children[2].children[1].showAxis("x",!0),C.clipTransRotControls[t].children[2].children[1].showAxis("z",!0)):"XY"===C.clipTransRotControls[t].name?(C.clipTransRotControls[t].children[2].children[1].showAxis("z",!1),C.clipTransRotControls[t].children[2].children[1].showAxis("x",!0),C.clipTransRotControls[t].children[2].children[1].showAxis("y",!0)):"R"===C.clipTransRotControls[t].name&&(C.clipTransRotControls[t].children[2].children[1].showAxis("x",!1),C.clipTransRotControls[t].children[2].children[1].showAxis("y",!0),C.clipTransRotControls[t].children[2].children[1].showAxis("z",!0)))},this._setSelectedObjectsClipping=function(e){let{body:t,mesh:i,isInstance:n,lineSegments:o,lineSegments2:r}=e;if(i){e=l.getClippingObjectUUID(t);if(C.clippingObjectsUuids.includes(e)){let e=null;C.uuid2MaterialMap.has(i.material.uuid)?(e=C.uuid2MaterialMap.get(i.material.uuid)).copy(i.material):(e=i.material.clone(),C.uuid2MaterialMap.set(i.material.uuid,e)),i.material=e,n&&(t.partClipObjects=!0,C.instanceMeshSet.add(t.uuid)),i.material.clippingPlanes=[],C.selectedClipPlaneArr.forEach(e=>{i.material.clippingPlanes.push(e)})}else Array.isArray(i.material.clippingPlanes)&&(i.material.clippingPlanes=null)}if(o){e=l.getClippingObjectUUID(t);if(C.clippingObjectsUuids.includes(e)){let e=null;C.uuid2MaterialMap.has(o.material.uuid)?(e=C.uuid2MaterialMap.get(o.material.uuid)).copy(o.material):(e=o.material.clone(),C.uuid2MaterialMap.set(o.material.uuid,e)),o.material=e,o.material.clippingPlanes=[],C.selectedClipPlaneArr.forEach(e=>{o.material.clippingPlanes.push(e)})}else Array.isArray(o.material.clippingPlanes)&&(o.material.clippingPlanes=null)}if(r){e=l.getClippingObjectUUID(t);if(C.clippingObjectsUuids.includes(e)){let e=null;C.uuid2MaterialMap.has(r.material.uuid)?(e=C.uuid2MaterialMap.get(r.material.uuid)).copy(r.material):(e=r.material.clone(),C.uuid2MaterialMap.set(r.material.uuid,e)),r.material=e,r.material.clippingPlanes=[],C.selectedClipPlaneArr.forEach(e=>{r.material.clippingPlanes.push(e)})}else Array.isArray(r.material.clippingPlanes)&&(r.material.clippingPlanes=null)}this.updateClipData()};let v=e=>{e=new THREE.Mesh(e,new THREE.MeshBasicMaterial({side:THREE.DoubleSide,opacity:.2,depthTest:!0,depthWrite:!1}));return 3===C._clipPlaneShaderVersion&&C._showSectionPlane&&(e.material.polygonOffset=!0,e.material.polygonOffsetFactor=-2,e.material.polygonOffsetUnits=1),e},x=(e,t)=>{var i;NDSWebViewer.COMMON.isMobileDevice()&&(i=[],12===(e=e.attributes.position.array).length?(i.push(new THREE.Vector3(e[0],e[1],e[2])),i.push(new THREE.Vector3(e[3],e[4],e[5])),i.push(new THREE.Vector3(e[3],e[4],e[5])),i.push(new THREE.Vector3(e[9],e[10],e[11])),i.push(new THREE.Vector3(e[9],e[10],e[11])),i.push(new THREE.Vector3(e[6],e[7],e[8])),i.push(new THREE.Vector3(e[6],e[7],e[8])),i.push(new THREE.Vector3(e[0],e[1],e[2])),e=(new THREE.BufferGeometry).setFromPoints(i),i=new THREE.LineSegments(e,new THREE.LineBasicMaterial({color:1118481})),t.add(i)):console.error("Plane mesh has vertex number greater than 4."))};this.addSectionPlane=function(t,i=!0){if(c&&-1==C.planeNameToId[t]){for(var n=0;n<C.clipTransRotControls.length;++n)C.clipTransRotControls[n].visible=!1,d[n].children[0].material.opacity=.2,NDSWebViewer.COMMON.isMobileDevice()?d[n].visible=!0:d[n].visible=!1;let e=void 0;C.__showSupplementClip&&(e=C.__showSupplementClip,C.showSupplementClip(!1,!1));var o=new THREE.Vector3,r=C.viewer.controls.getBoundingBox().getCenter(C.boxCenter),o=C.viewer.controls.getBoundingBox().getSize(o),o=Math.max(o.x,o.y,o.z),o=(o*=1.3,new THREE.PlaneGeometry(o,o,1,1)),s=null,l=new THREE.Color,a=("XZ"==t?(s=new THREE.Plane(new THREE.Vector3(0,-1,0),0),NDSWebViewer.COMMON.isMobileDevice()?l.set(7514614):l.setRGB(.298,.8,.4)):"YZ"==t?(s=new THREE.Plane(new THREE.Vector3(-1,0,0),0),NDSWebViewer.COMMON.isMobileDevice()?l.set(7514614):l.setRGB(.8,.4,.298)):"XY"==t?(s=new THREE.Plane(new THREE.Vector3(0,0,-1),0),NDSWebViewer.COMMON.isMobileDevice()?l.set(7514614):l.setRGB(.4,.298,.8)):"R"==t&&(s=new THREE.Plane(new THREE.Vector3(-1,0,0),0),NDSWebViewer.COMMON.isMobileDevice()?l.set(7514614):l.setRGB(.72,0,.8)),s.setFromNormalAndCoplanarPoint(s.normal,r),s.clone()),p=(C.selectedClipPlaneArr.push(a),new THREE.Object3D),r=(p.position.copy(r),p.oriPosition=r.clone(),p.visible=C.isHideShow,p.reverse=!1,p.updateMatrixWorld(),d.push(p),NDSWebViewer.COMMON.isMobileDevice()||this.sceneWrapper.isECAD3DView()||(C.reverseStateMap.has(t)?(a=C.reverseStateMap.get(t),C.reverseClipDirection(t,a,!1)):C.reverseStateMap.set(t,p.reverse)),v(o)),h=(r.material.color.copy(l),r.material.transparent=!0,p.add(r),x(o,p),new THREE.Quaternion);h.setFromUnitVectors(new THREE.Vector3(0,0,-1),s.normal);for(let e=0;e<p.children.length;++e)p.children[e].setRotationFromQuaternion(h),p.children[e].updateMatrixWorld(!0);a=new NDSWebViewer.TransformControls(C.viewer,C._domElement);c.add(a),c.add(p),NDSWebViewer.COMMON.isMobileDevice()?a.setSize(1):a.setSize(.7),a.setSpace("local"),a.attach(p),a.name=t,a.addEventListener("change",function(e){C.objectChangeEvent(e.axis),C.viewer.render()}),a.addEventListener("objectChange",function(e){var t=Date.now();E(),3===C._clipPlaneShaderVersion&&(e.mouseUp&&(C.updateSectionImage=!0),y()),NDSWebViewer.SETTING.enableBroadcast&&!NDSWebViewer.SETTING.broadcastMajor||(e.mouseUp?C.viewer.renderAllViews():C.viewer.render()),NDSWebViewer.SETTING.enableBroadcast&&NDSWebViewer.SETTING.broadcastMajor&&e.mouseUp&&NDSWebViewer.ExtensionManager.updateBroadcastInfo("ClipExtension"),C.viewer.logOperatorTime&&C.viewer.logOperatorTimeShow("[][]",t)}),C.clipTransRotControls.push(a),C.setClipTransControlMode(C.clipModeState),C.clipActiveId=C.clipTransRotControls.length-1,C.planeNameToId[t]=C.clipActiveId,C.clipTransRotControl=C.clipTransRotControls[C.clipActiveId],C.__inClipMode||(C.clipTransRotControl.visible=!1),NDSWebViewer.COMMON.isMobileDevice()&&(d[C.clipActiveId].children[0].material.opacity=.4),e&&C.showSupplementClip(e,!1),3===C._clipPlaneShaderVersion&&i&&(C.updateSectionImage=!0,y()),C.clipTransRotControl.getDeltaRotation(!0,C.clipTransRotControl.RDelta),C.clipTransRotControl.getDeltaPosition(!0),this.updateClipData(),C.viewer.renderAllViews()}},this.onSectionView=function(e,t,i=!0){if(this.allClippingObjectsUuids.length||C.getAllBodyUuid(),!s.hasBrepInfo()&&s.hasBrepFile()&&s.loadBrepInfo(!1),this.flag=e){if(null==_&&(_=new P),C.viewer.addFrameListener(_),C.viewer.toggleAutoRotation(!1),C.viewer.controls){var e=new THREE.Vector3,n=new THREE.Vector3;if(C.viewer.controls.SetBoundingBoxUpdated(!1),C.viewer.computeBoundingBox(C.viewer.scene,e,n,{flag:!0},!0),e.x>n.x||e.y>n.y||e.z>n.z)return;C.viewer.controls.setBoundingBox(e,n)}C.viewer.viewManager?(C.viewer.zoomExtents(!1),C.viewer.viewManager.notifyConnectCameraMove()):C.viewer.zoomExtents(),2==C._clipPlaneShaderVersion&&(u=new THREE.ShaderMaterial({uniforms:NDSWebViewer.ClippingShader.ClippingPlanesShader2.uniforms.caps,vertexShader:NDSWebViewer.ClippingShader.ClippingPlanesShader2.vertex,fragmentShader:NDSWebViewer.ClippingShader.ClippingPlanesShader2.fragment}),f=new THREE.ShaderMaterial({defines:NDSWebViewer.ClippingShader.ClippingPlanesShader2.defines,uniforms:NDSWebViewer.ClippingShader.ClippingPlanesShader2.uniforms.clipping,vertexShader:NDSWebViewer.ClippingShader.ClippingPlanesShader2.vertexClipping,fragmentShader:NDSWebViewer.ClippingShader.ClippingPlanesShader2.fragmentClippingFront,colorWrite:!1,depthWrite:!1,side:THREE.BackSide}),m=new THREE.ShaderMaterial({defines:NDSWebViewer.ClippingShader.ClippingPlanesShader2.defines,uniforms:NDSWebViewer.ClippingShader.ClippingPlanesShader2.uniforms.clipping,vertexShader:NDSWebViewer.ClippingShader.ClippingPlanesShader2.vertexClipping,fragmentShader:NDSWebViewer.ClippingShader.ClippingPlanesShader2.fragmentClippingFront,colorWrite:!1,depthWrite:!1}),NDSWebViewer.ClippingShader.ClippingPlanesShader2.uniforms.clipping.clippingPlaneNDS.value=[-1,0,0,0],(g=new THREE.Scene).add(new THREE.Mesh(new THREE.PlaneGeometry(2*C.viewer.camera.far,2*C.viewer.camera.far,1,1),u))),C.sceneWrapper.enableLocalClipping(),C.planeNameToId.YZ=-1,C.planeNameToId.XY=-1,C.planeNameToId.XZ=-1,C.planeNameToId.R=-1,c=new THREE.Scene,C._clipScene=c,C.addSectionPlane("YZ"),this.initClipDataManager()}else{if(C.onCloseClip(),C.clipTransRotControl){if(u&&u.dispose(),u=null,f&&f.dispose(),f=null,m&&m.dispose(),m=null,g)for(var o=0;o<g.children.length;o++)g.children[o].geometry&&g.children[o].geometry.dispose(),g.remove(g.children[o]),o--;g=null;for(var r=0;r<C.selectedClipPlaneArr.length;++r)a=C.selectedClipPlaneArr[r],a=null;for(r=0;r<C.clipTransRotControls.length;++r)C.clipTransRotControls[r].dispose();C.clipTransRotControls=[],p=null;for(o=0;o<d.length;o++)NDSWebViewer.COMMON.disposeObject(d[o]);if(d.length=0,c)for(o=0;o<c.children.length;o++)l.disposeCapMesh(c.children[o]),c.remove(c.children[o]),o--;i&&(c=null),this.clearClipDataManager(),C.selectedClipPlaneArr=[],this.clippingObjectsUuids=[],this.unClippingObjectsUuids=[],this.partClipObjects=!1,this.isSelectedClip=!1,this.clearShowSupplement()}C.sceneWrapper.disableLocalClipping(),NDSWebViewer.COMMON.isMobileDevice()?C.clipModeState="translate":C.clipModeState="both",this.planeNameToId={},C.clipActiveId=0,C.viewer.removeFrameListener(_),_=null}0!=t&&C.viewer.renderAllViews()},this.onCloseViewSection=function(){C.fromView&&(this.onSectionView(!1,!0),C.fromView=!1)},this.onCloseClipControl=function(){C.clipTransRotControl&&(C.clipTransRotControl.visible=!1,C.viewer.renderAllViews())},this.getClipControlVisible=function(){return!!C.clipTransRotControl&&C.clipTransRotControl.visible},this.onOpenClipControl=function(){C.clipTransRotControl&&(!NDSWebViewer.SETTING.enableBroadcast||NDSWebViewer.SETTING.enableBroadcast&&NDSWebViewer.SETTING.broadcastMajor)&&(C.clipTransRotControl.visible=!0,C.viewer.renderAllViews())},this.isSectionViewEnabled=function(){return!!c},this.supportMeasureClip=function(){var e=NDSWebViewer.ExtensionManager.getExtension("MeasureExtension");return void 0!==e&&C.isSectionViewEnabled()&&e.isInMeasureOp()&&("Distance"==e.getMeasureClass()||"Edge"==e.getMeasureClass()||"Face"==e.getMeasureClass())},this.getClipPlaneInfor=function(i){if(!c||!d.length||!i&&C.onCustomClipPlaneStatus)return null;{let e={clipGlobalPlaneObjects:[]},t=C.__showSupplementClip;C.__showSupplementClip&&(t=C.__showSupplementClip,C.showSupplementClip(!1,!1));for(var n=0;n<d.length;++n){var o={position:d[n].position.clone(),quaternion:d[n].quaternion.clone(),meshquaternion:d[n].children[0].quaternion.clone(),isReverse:d[n].reverse};d[n].clickNormal&&(o.clickNormal=d[n].clickNormal.clone()),e.clipGlobalPlaneObjects.push(o)}e.clippingPlanes=[];for(n=0;n<C.selectedClipPlaneArr.length;++n){var r=C.selectedClipPlaneArr[n].clone();e.clippingPlanes.push(r)}return e.planeNameToId={R:C.planeNameToId.R,XY:C.planeNameToId.XY,XZ:C.planeNameToId.XZ,YZ:C.planeNameToId.YZ},e.clipActiveId=C.clipActiveId,p=d[C.clipActiveId],e.planeVisible=p.visible,e.clipModeState=C.clipModeState,e.clippingObjectsUuids=C.clippingObjectsUuids.slice(),e.partClipObjects=C.partClipObjects,e.isSelectedClip=C.isSelectedClip,i&&(e.controlVisible=C.clipTransRotControl.visible,e.fromView=!!C.fromView,e.meshColor=C.meshColor.toArray(),e.lineColor=C.lineColor.toArray(),e.useMeshColor=C.useMeshColor,e.useLineColor=C.useLineColor,e.showClipLineVisible=C.showClipLineVisible,e.showClipMeshVisible=C.showClipMeshVisible,e.randomClipMeshColor=C.randomClipMeshColor,e.isHideShow=C.isHideShow,e.onCustomClipPlaneStatus=C.onCustomClipPlaneStatus,e.clipIntersect=C._cloneClipIntersect(),e.deletedPlaneName=C.deletedPlaneName.slice(),e.clickOriPosition=p.clickOriPosition?p.clickOriPosition.toArray():null,e.showSupplementClip=t),t&&C.showSupplementClip(t,!1),e}},this.setClipMeshVisible=function(e){if(c){for(var t=0,i=c.children.length;t<i;t++)c.children[t].name==U.SECTION_ROOT_NAME&&(c.children[t].visible=e);3===C._clipPlaneShaderVersion&&e?(this.updateSectionImage=!0,y()):C.viewer.dispatchEvent({type:"ActiveSectionViewChangeEvent",base64Img:""})}NDSWebViewer.SETTING.enableBroadcast&&NDSWebViewer.SETTING.broadcastMajor&&setTimeout(()=>{NDSWebViewer.ExtensionManager.updateBroadcastInfo("ClipExtension")},800)},this.getClipMeshVisible=function(){if(c)for(var e=0,t=c.children.length;e<t;e++)if(c.children[e].name==U.SECTION_ROOT_NAME){var i=c.children[e],n=i[0],i=i[1];if(n&&0<n.children.length||i&&0<i.children.length)return c.children[e].visible}return!1},this._clipIntersectInfor=function(e){var t,i,n;e.clipIntersect&&C.onCustomClipPlaneStatus&&C.viewer.hasBrepInfo()&&({bodyUuid:t,ndsModelId:i,point:n}=e.clipIntersect,i=C.viewer.ndsModel.getModelById(i).bodyUuid2NodeMap[t],C.clipIntersect={bodyNode:i,...e.clipIntersect,object:i,point:(new THREE.Vector3).fromArray(n)},C.mousemoveClickStatus=!0,C.sceneWrapper.setIgnoreModelSelection(!0),C.setSelInfoByIntersect&&C.setSelInfoByIntersect(C.clipIntersect,!0),e.clickOriPosition&&Array.isArray(e.clickOriPosition)&&(C.clipTransRotControl.object.clickOriPosition=(new THREE.Vector3).fromArray(e.clickOriPosition)),C.onPauseCustomPick&&C.onPauseCustomPick(!0),"R"==C.clipTransRotControl.name&&(t=new THREE.Vector3(1,0,0),(i=new THREE.Quaternion).setFromUnitVectors(t,C.clipTransRotControl.object.clickNormal),(n=new THREE.Euler(0,0,0,"YZX")).setFromQuaternion(i),C.clipTransRotControl.RDelta=new THREE.Vector3(n.x,n.y,n.z)),C.clipTransRotControl.getDeltaRotation(!0,C.clipTransRotControl.RDelta),C.clipTransRotControl.getDeltaPosition(!0))},this.setClipPlaneInfor=function(e){C.clearReverseState(),C.planeNameToId={R:e.planeNameToId.R,XY:e.planeNameToId.XY,XZ:e.planeNameToId.XZ,YZ:e.planeNameToId.YZ},C.selectedClipPlaneArr=[];for(var t=d.length=0;t<C.clipTransRotControls.length;++t)C.clipTransRotControls[t].dispose();if(C.clipTransRotControls=[],this.useMeshColor=!1,this.useLineColor=!1,this.showClipLineVisible=!0,this.showClipMeshVisible=!0,this.randomClipMeshColor=!1,c)for(var i=0;i<c.children.length;i++)c.remove(c.children[i]),i--;else c=new THREE.Scene,C._clipScene=c;for(var n=null,t=0;t<e.clipGlobalPlaneObjects.length;++t){for(var o in C.planeNameToId)if(C.planeNameToId[o]==t){n=o;break}"R"===n&&NDSWebViewer.COMMON.isMobileDevice()&&(n="YZ");var r=new THREE.Vector3,r=C.viewer.controls.getBoundingBox().getSize(r),r=Math.max(r.x,r.y,r.z),r=(r*=1.3,new THREE.PlaneGeometry(r,r,1,1)),s=e.clippingPlanes[t].normal,s=new THREE.Plane(new THREE.Vector3(s.x,s.y,s.z),e.clippingPlanes[t].constant),l=new THREE.Color,s=("XZ"==n?NDSWebViewer.COMMON.isMobileDevice()?l.set(7514614):l.setRGB(.298,.8,.4):"YZ"==n?NDSWebViewer.COMMON.isMobileDevice()?l.set(7514614):l.setRGB(.8,.4,.298):"XY"==n?NDSWebViewer.COMMON.isMobileDevice()?l.set(7514614):l.setRGB(.4,.298,.8):"R"==n&&(NDSWebViewer.COMMON.isMobileDevice()?l.set(7514614):l.setRGB(.72,0,.8)),s.clone()),a=(C.selectedClipPlaneArr.push(s),new THREE.Object3D),s=e.clipGlobalPlaneObjects[t].position,s=(a.position.set(s.x,s.y,s.z),C.viewer.controls.getBoundingBox().getCenter(C.boxCenter)),s=(a.oriPosition=s.clone(),e.clipGlobalPlaneObjects[t].quaternion),s=(Array.isArray(s)?a.quaternion.set(s[0],s[1],s[2],s[3]):a.quaternion.set(s._x,s._y,s._z,s._w),a.updateMatrixWorld(),null!=e.isHideShow&&(C.isHideShow=e.isHideShow),a.visible=C.isHideShow,a.reverse=e.clipGlobalPlaneObjects[t].isReverse,C.reverseStateMap.set(n,a.reverse),d.push(a),v(r)),p=(s.material.color.copy(l),s.material.transparent=!0,a.add(s),x(r,a),new THREE.Quaternion),l=e.clipGlobalPlaneObjects[t].meshquaternion;Array.isArray(l)?p.set(l[0],l[1],l[2],l[3]):p.set(l._x,l._y,l._z,l._w);for(let e=0;e<a.children.length;++e)a.children[e].setRotationFromQuaternion(p),a.children[e].updateMatrixWorld(!0);s=new NDSWebViewer.TransformControls(C.viewer,C._domElement);c.add(s),c.add(a),NDSWebViewer.COMMON.isMobileDevice()?s.setSize(1.1):s.setSize(.7),s.setMode(C.clipModeState),s.setSpace("local"),s.attach(a),s.name=n,e.clipGlobalPlaneObjects[t].clickNormal&&(r=e.clipGlobalPlaneObjects[t].clickNormal,s.object.clickNormal=new THREE.Vector3,s.object.clickNormal.set(r.x,r.y,r.z)),s.update(),t!=e.clipActiveId&&(a.visible=!1,s.visible=!1),s.addEventListener("change",function(e){C.objectChangeEvent(e.axis),C.viewer.render()}),s.addEventListener("objectChange",function(e){E(),3===C._clipPlaneShaderVersion&&y(),NDSWebViewer.SETTING.enableBroadcast&&!NDSWebViewer.SETTING.broadcastMajor||(e.mouseUp?C.viewer.renderAllViews():C.viewer.render()),NDSWebViewer.SETTING.enableBroadcast&&NDSWebViewer.SETTING.broadcastMajor&&e.mouseUp&&NDSWebViewer.ExtensionManager.updateBroadcastInfo("ClipExtension")}),C.clipTransRotControls.push(s)}for(o in n=null,C.planeNameToId)if(C.planeNameToId[o]==e.clipActiveId){n=o;break}C.setActiveSectionPlane(n);var h=null!=e.controlVisible?!!e.controlVisible:C.getClipControlVisible();C.clipTransRotControl=C.clipTransRotControls[C.clipActiveId],C.clipTransRotControl.visible=h,3===C._clipPlaneShaderVersion&&y(),C.hideShowClipPlane(e.planeVisible),e.fromView?C.fromView=!0:C.fromView=!1,C.setClipTransControlMode(e.clipModeState),e.clippingObjectsUuids&&(C.clippingObjectsUuids=e.clippingObjectsUuids.slice()),e.meshColor&&(C.meshColor=(new THREE.Vector3).fromArray(e.meshColor)),e.lineColor&&(C.lineColor=(new THREE.Vector3).fromArray(e.lineColor)),null!=e.useMeshColor&&(C.useMeshColor=e.useMeshColor),null!=e.useLineColor&&(C.useLineColor=e.useLineColor),null!=e.showClipLineVisible&&(C.showClipLineVisible=e.showClipLineVisible),null!=e.showClipMeshVisible&&(C.showClipMeshVisible=e.showClipMeshVisible),null!=e.randomClipMeshColor&&(C.randomClipMeshColor=e.randomClipMeshColor),null!=e.isSelectedClip&&(C.isSelectedClip=e.isSelectedClip),null!=e.onCustomClipPlaneStatus&&(C.onCustomClipPlaneStatus=e.onCustomClipPlaneStatus,C.onCustomClipPlaneStatus)&&C.onCustomClipPlane(C.onCustomClipPlaneStatus),C._clipIntersectInfor(e),null!=e.partClipObjects&&(C.partClipObjects=e.partClipObjects,C.partClipObjects)&&(C.unClippingObjectsUuids=C.allClippingObjectsUuids.filter(e=>!C.clippingObjectsUuids.includes(e))),e.deletedPlaneName&&(C.deletedPlaneName=e.deletedPlaneName.slice()),!0===e.showSupplementClip&&C.showSupplementClip(e.showSupplementClip,!1),C.clipTransRotControl.getDeltaRotation(!0,C.clipTransRotControl.RDelta),C.clipTransRotControl.getDeltaPosition(!0),this.updateClipData(),this.updatePartClipData(this.partClipObjects),C.viewer.renderAllViews()},this.hideShowClipPlane=function(e,t=!0){var i=Date.now();if(NDSWebViewer.COMMON.isMobileDevice())for(var n=0;n<C.clipTransRotControls.length;++n)d[n]&&(d[n].visible=e);else(p=d[C.clipActiveId])&&(p.visible=e);t&&C.viewer.renderAllViews(),C.viewer.logOperatorTime&&C.viewer.logOperatorTimeShow("[][/ ]",i)},this.getClipPlaneVisible=function(){return!!(p=d[C.clipActiveId])&&p.visible},this.reverseClipDirection=function(t,i,n=!0){if(!(C.viewer.GeomEmpty||C.clipActiveId<0)&&(p=d[C.clipActiveId],a=C.selectedClipPlaneArr[C.clipActiveId],h=p.children[0],p.reverse!==i)){let e=void 0;C.__showSupplementClip&&(e=C.__showSupplementClip,C.showSupplementClip(!1,!1)),a.normal.negate(),"XY"==t?p.quaternion.setFromUnitVectors(new THREE.Vector3(0,0,-1),a.normal):"XZ"==t?p.quaternion.setFromUnitVectors(new THREE.Vector3(0,-1,0),a.normal):"YZ"!=t&&"R"!=t||p.quaternion.setFromUnitVectors(new THREE.Vector3(-1,0,0),a.normal),C.reverseStateMap.set(t,i),a.setFromNormalAndCoplanarPoint(a.normal,p.position),p.reverse=i,e&&C.showSupplementClip(e,!1),n&&(3===C._clipPlaneShaderVersion&&y(),C.viewer.renderAllViews()),C.clipTransRotControl.getDeltaRotation(!0,C.clipTransRotControl.RDelta),C.clipTransRotControl.getDeltaPosition(!0)}},this.reverseClipDirectionApp=function(e,t=!0){var i;C.viewer.GeomEmpty||C.clipActiveId<0||(i=null,C.planeNameToId.XY==C.clipActiveId?i="XY":C.planeNameToId.XZ==C.clipActiveId?i="XZ":C.planeNameToId.YZ==C.clipActiveId?i="YZ":C.planeNameToId.R==C.clipActiveId&&(i="R"),C.reverseClipDirection(i,e,t))},this.showSupplementClip=function(t,e=!0){if(!C.viewer.GeomEmpty){this.__showSupplementClip=t;for(let e=0;e<d.length;++e)(p=d[e]).__showSupplementClip!==t&&((a=C.selectedClipPlaneArr[e]).normal.negate(),a.setFromNormalAndCoplanarPoint(a.normal,p.position),p.__showSupplementClip=t);E(),e&&(3===C._clipPlaneShaderVersion&&y(),this.updateClipData(),this.sceneWrapper.renderAllViews())}},this.clearShowSupplement=function(){C.__showSupplementClip=!1},this.updateClipPlane=function(){3===C._clipPlaneShaderVersion&&y(),C.sceneWrapper.renderAllViews()},this._cloneClipIntersect=function(){if(C.clipIntersect)return{bodyUuid:C.clipIntersect.bodyUuid,distance:C.clipIntersect.distance,faceIndex:C.clipIntersect.faceIndex,geomId:C.clipIntersect.geomId,geomUuid:C.clipIntersect.geomUuid,lineSegId:C.clipIntersect.lineSegId,meshId:C.clipIntersect.meshId,point:C.clipIntersect.point.toArray(),ndsModelId:C.clipIntersect.object.ndsModel.id,index:C.clipIntersect.index}},this.initClipDataManager=function(){this.clipDataManagerWrapper&&(this.clipDataManagerWrapper.enablePlaneClip(),this.updateClipData(),this.clipDataManagerWrapper.updateClippingObjects(this.allClippingObjectsUuids))},this.updateClipData=function(){var t=[];for(let e=0;e<d.length;++e)t.push(d[e].position);this.clipDataManagerWrapper.setClipPlanes(this.selectedClipPlaneArr,t),this.clipDataManagerWrapper.showSupplementClip(this.__showSupplementClip)},this.updatePartClipData=function(e){this.clipDataManagerWrapper.updatePartClip(e,this.clippingObjectsUuids,this.unClippingObjectsUuids),e||this.clipDataManagerWrapper.updateClippingObjects(this.allClippingObjectsUuids)},this.clearClipDataManager=function(){this.clipDataManagerWrapper&&this.clipDataManagerWrapper.disablePlaneClip()},this.setInClipMode=function(e){(this.__inClipMode=e)?this.onOpenClipControl():this.onCloseClipControl()}}init(e,t,i){this._showSectionPlane=i,e.canvas2D?this._domElement=e.canvas2D:this._domElement=e.canvas3D,this.tempQuat=new THREE.Quaternion,this._clipPlaneShaderVersion=void 0===t?1:t,1===this._clipPlaneShaderVersion&&(THREE.ShaderChunk.clipping_planes_fragment=NDSWebViewer.ClippingShader.ClippingPlanesShader_fragment1,THREE.ShaderChunk.clipping_planes_pars_fragment=NDSWebViewer.ClippingShader.ClippingPlanesShader_pars_fragment1,THREE.ShaderChunk.meshphong_frag=NDSWebViewer.ClippingShader.ClippingPlanesShader1_MeshPhong,THREE.ShaderLib.phong.fragmentShader=NDSWebViewer.ClippingShader.ClippingPlanesShader1_MeshPhong,THREE.ShaderChunk.meshphysical_frag=NDSWebViewer.ClippingShader.ClippingPlanesShader1_MeshPhysical,THREE.ShaderLib.physical.fragmentShader=NDSWebViewer.ClippingShader.ClippingPlanesShader1_MeshPhysical),this.Popup=null,this.prompt=document.createElement("div"),NDSWebViewer.COMMON.isMobileDevice()?this.prompt.className="app-alert":this.prompt.className="pc-alert",e.container.appendChild(this.prompt)}}function ae(e){let y=e.coreView,l=e.sceneWrapper,E=e.__clipPlaneManager,r=!1,p=(E.moveMesh=null,[]),i=(E.deletedPlaneName=[],{x:0,y:0}),n={x:0,y:0},o=!1,v=new THREE.Vector3,x=new THREE.Vector3,T=new THREE.Vector3,S=[],h=new THREE.Vector3,P=new THREE.Vector3,M=new THREE.Vector3,I=new THREE.Vector3,d=new THREE.Vector3,V=new THREE.Quaternion;var c=new THREE.Vector3(1,0,0),u=new THREE.Vector3(0,1,0),f=new THREE.Vector3(0,0,1);let s=!1,w,b,N,O,R,A;function a(){r=!1;var e=E._clipScene&&E._clipScene.getObjectByName("clipSelectedMesh");e&&E._clipScene.remove(e)}function m(e){NDSWebViewer.COMMON.isMobileDevice()?e.removeEventListener("touchmove",L):e.removeEventListener("mousemove",L),e.removeEventListener("click",C),e.removeEventListener("mousedown",g,!1),e.removeEventListener("mouseup",_,!1)}function g(e){i.x=e.offsetX,i.x=e.offsetY}function _(e){n.x=e.offsetX,n.x=e.offsetY}function C(e){if(Math.abs(i.x-n.x)<3&&Math.abs(i.y-n.y)<3&&!E._lineMeshPick&&!o){e=D(e.changedTouches?e.changedTouches[0]:e),e=H(e.x,e.y,!0);if(Array.isArray(e)){if(0==e.length)return;var t=null;(t=0<=e[0].lineSegId||0<=e[0].meshId?e[0]:t)&&E.setSelInfoByIntersect(t)}else e&&("lineSphereUp"==e.object.name?d.copy(T):"lineSphereDown"==e.object.name?d.copy(x):"lineSphereCenter"==e.object.name&&d.copy(v),B());y.render()}}function L(e){if(E._lineMeshPick||o)E.mousemoveClickStatus=!1,l.setIgnoreModelSelection(!1);else{var e=e.changedTouches?e.changedTouches[0]:e,t=D(e),i=t.x,t=t.y,e=(E.moveMesh&&(E._clipScene.remove(E.moveMesh),E.moveMesh=null,E.mousemoveClickStatus=!1,l.setIgnoreModelSelection(!1)),E.prompt&&!NDSWebViewer.COMMON.isMobileDevice()&&(r?(E.prompt.style.display="none",E.prompt.style.zIndex=-99):(E.prompt.style.display="block",E.prompt.style.zIndex=5),e=D(e,!0),E.prompt.style.left=e.x+16+"px",E.prompt.style.top=e.y+18+"px"),H(i,t,!0));if(Array.isArray(e)){if(0<e.length){i=null;if(i=0<=e[0].lineSegId||0<=e[0].meshId?e[0]:i){let e=null,t=W(i);!t||"line"!=t.type&&"plane"!=t.type||("line"==t.type?e=X(t,!0):"plane"==t.type&&(e=Y(t,!0)),E.mousemoveClickStatus=!0,l.setIgnoreModelSelection(!0),E.moveMesh=e,E._clipScene.add(e))}}}else e&&(E.mousemoveClickStatus=!0,l.setIgnoreModelSelection(!0));y.render()}}function B(){var e,t,i,n,o,r,s,l,a;-1==E.planeNameToId.R&&(E.addSectionPlane("R"),E.partClipObjects)&&p.length&&(E.clippingObjectsUuids=p.slice()),(e=E._clipScene.getObjectByName("clipSelectedMesh"))&&(t=new THREE.Vector3(1,0,0),i=new THREE.Vector3,n=new THREE.Quaternion,o=new THREE.Vector3,r=new THREE.Vector3,a=new THREE.Vector3,s=new THREE.Vector3,l=E.clipTransRotControl.object,("Face"==e.objectType?(r.subVectors(P,M),a.subVectors(P,I),r.cross(a)):r.subVectors(T,x)).normalize(),n.setFromUnitVectors(t,r),l.quaternion.copy(n),o.subVectors(l.oriPosition,"Face"==e.objectType?h:d),a=o.dot(r),i.addScaledVector(r,a),l.position.copy(s.subVectors(l.oriPosition,i)),l.clickOriPosition=l.position.clone(),l.clickNormal=r.clone(),E.clipTransRotControl.update(),E.clipTransRotControl.dispatchEvent({type:"change"}),E.clipTransRotControl.dispatchEvent({type:"objectChange"}),"R"==E.clipTransRotControl.name&&(E.clipTransRotControl.RDelta=E.clipTransRotControl.getDeltaRotation(!1).clone()),E.clipTransRotControl.getDeltaRotation(!0,E.clipTransRotControl.RDelta),E.clipTransRotControl.getDeltaPosition(!0),l.visible!=E.isHideShow)&&E.hideShowClipPlane(E.isHideShow),E.updateClipData(),E.updatePartClipData(E.partClipObjects)}function D(e,t=!1){var i=e.offsetX||e.clientX-y.container.getBoundingClientRect().left,n=e.offsetY||e.clientY-y.container.getBoundingClientRect().top;return t?new THREE.Vector2(e.clientX,e.clientY):(y.viewManager&&(i=(t=y.viewManager.remapViewCoordinateToFullView(i,n))[0],n=t[1]),new THREE.Vector2(i,n))}function X(i,n,o){if(i&&i.parentObj instanceof THREE.Line){var r=new THREE.Group,s=i.geometry;let t,e=i.indexRange.concat();if(y.ndsModel&&(e[0]+=s.drawRange.start/2,e[1]+=s.drawRange.start/2),s.isBufferGeometry){var l=e[1]-e[0]+1,a=s.index,p=s.attributes.position.array,h=new Float32Array(6*l),l=e[0],d=e[1];if(null!=a){for(var c=a.array,u=0,f=l,m=d;f<=m;f++,u+=1){var g=c[2*f],_=c[2*f+1],C=new THREE.Vector3,P=new THREE.Vector3;C.fromArray(p,3*g),P.fromArray(p,3*_),h[6*u]=C.x,h[6*u+1]=C.y,h[6*u+2]=C.z,h[6*u+3]=P.x,h[6*u+4]=P.y,h[6*u+5]=P.z,P=C=null}t=t||(0==n?NDSWebViewer.SETTING.SelectedEdgeMaterial1:NDSWebViewer.SETTING.preSelectedEdgeMaterial);var a=new NDSWebViewer.LineSegmentsGeometry,l=(a.setPositions(h),new NDSWebViewer.LineMaterial({linewidth:t.linewidth,opacity:t.opacity,color:t.color,depthTest:t.depthTest,depthWrite:t.depthWrite,side:THREE.DoubleSide})),d=y.renderer.getPixelRatio(),n=y.renderer.domElement.width/d,d=y.renderer.domElement.height/d,d=(l.resolution.set(n,d),(n=new NDSWebViewer.LineSegments2(a,l)).applyMatrix4(i.matrixWorld),n.matrixWorldNeedsUpdate=!0,new THREE.MeshBasicMaterial({color:t.color,opacity:t.opacity,depthTest:t.depthTest,depthWrite:t.depthWrite,side:THREE.DoubleSide}));let e=new THREE.SphereGeometry(5,32,16);(w=new THREE.Mesh(e,d)).name="lineSphereUp",w.position.fromArray(h,0),(b=new THREE.Mesh(e,d)).name="lineSphereDown",b.position.fromArray(h,h.length-3),(N=new THREE.Mesh(e,d)).name="lineSphereCenter",N.position.set((w.position.x+b.position.x)/2,(w.position.y+b.position.y)/2,(w.position.z+b.position.z)/2),w.applyMatrix4(i.matrixWorld),w.scale.set(1,1,1),r.add(w),b.applyMatrix4(i.matrixWorld),b.scale.set(1,1,1),r.add(b),N.applyMatrix4(i.matrixWorld),N.scale.set(1,1,1),r.add(N),r.add(n),o&&(S=[],T.copy(w.position),x.copy(b.position),v.copy(N.position),S.push(w,b,N),O=w,R=b,A=N)}}return E.renderPoints(),r}}function Y(e,t,i){if(e&&e.parentObj instanceof THREE.Mesh){var n,o=e.geometry,r=e.indexRange.concat();if(y.ndsModel&&(r[0]+=o.drawRange.start/3,r[1]+=o.drawRange.start/3),o.isBufferGeometry){for(var s=o.index,l=o.attributes.position,o=r[1]-r[0]+1,a=new Float32Array(9*o),p=0,h=new THREE.Vector3,d=r[0],c=r[1];d<=c;d++,p+=1){var u=3*d,f=s.getX(u),m=s.getX(1+u),u=s.getX(2+u),g=new THREE.Vector3,_=new THREE.Vector3,C=new THREE.Vector3,f=(g.fromBufferAttribute(l,f),_.fromBufferAttribute(l,m),C.fromBufferAttribute(l,u),(new THREE.Vector3).subVectors(_,g)),m=(new THREE.Vector3).subVectors(C,g);f.cross(m).normalize(),h.add(f),a[9*p]=g.x,a[9*p+1]=g.y,a[9*p+2]=g.z,a[9*p+3]=_.x,a[9*p+4]=_.y,a[9*p+5]=_.z,a[9*p+6]=C.x,a[9*p+7]=C.y,a[9*p+8]=C.z,C=_=g=null}o=new THREE.BufferGeometry;o.addAttribute("position",new THREE.BufferAttribute(a,3)),(n=new THREE.Mesh(o,0==t?NDSWebViewer.SETTING.selectedFaceMaterial:NDSWebViewer.SETTING.preSelectedFaceMaterial)).objectType="Face",n.applyMatrix(e.matrixWorld),n.matrixWorldNeedsUpdate=!0,i&&(P.fromArray(a,0),M.fromArray(a,3),P.applyMatrix4(e.matrixWorld),M.applyMatrix4(e.matrixWorld),I.fromArray(a,6),I.applyMatrix4(e.matrixWorld))}return n}}function W(e){if(e&&y.hasBrepInfo()){var t,i,n,o,r,s=e.object;if(s)return t=s.uuid,n=e.object.uuid,s=l.getModelById(s.ndsModel.id),y.ndsModel&&s&&(0<=e.meshId?(e.mesh=s.meshManager.getSingleMesh(e.meshId),e.mesh&&(o=e.faceIndex-e.mesh.geometry.drawRange.start/3,i="face")):0<=e.lineSegId&&(e.mesh=s.meshManager.getLineSegments(e.lineSegId),e.mesh)&&(o=.5*(e.index-e.mesh.geometry.drawRange.start),i="edge"),n=e.geomUuid),0<=o&&(r=s.brepManager.GetBrepInfoByUUidAndTopolIndex(t,n,o,i))&&(r.parentObj=e.mesh,r.geometry=e.mesh.geometry,r.matrixWorld=e.mesh.matrixWorld.clone(),r.intersect=e.point.clone(),r.bodyId=e.bodyId,r.bodyUuid=e.bodyUuid,r.meshId=e.meshId,r.topolIndex=o,r.topolType=i,r.lineSegId=e.lineSegId,r.ndsModelId=s.id,"face"==i&&(r.edgeInfos=s.brepManager.GetEdgeInfoFromFace(t,r.edgeIDS)),r.normal&&null==r.worldNormal&&(n=new THREE.Vector3,o=new THREE.Quaternion,e=new THREE.Vector3,r.parentObj.matrixWorld.decompose(n,o,e),r.worldNormal=new THREE.Vector3(r.normal[0],r.normal[1],r.normal[2]),r.worldNormal.applyQuaternion(o)),r.origin)&&null==r.worldOrigin&&(r.worldOrigin=new THREE.Vector3(r.origin[0],r.origin[1],r.origin[2]),r.worldOrigin.applyMatrix4(r.matrixWorld)),r}}function H(e,t,i){var n=y.renderer.domElement,o=y.renderer.getPixelRatio(),e=e*o/n.width*2-1,t=2*-(t*o/n.height)+1,o=new THREE.Raycaster;y.camera.setCastRay(o,e,t),i&&(o.linePrecision=(n=y.clientCoordToModelCoord([0,0]),n=new THREE.Vector3(n[0],n[1],n[2]),e=y.clientCoordToModelCoord([4,0]),e=new THREE.Vector3(e[0],e[1],e[2]),n.distanceTo(e)));let r=null;var s=o.intersectObjects(S,!0);for(let e=0;e<s.length;e++)if("lineSphereUp"==s[e].object.name||"lineSphereDown"==s[e].object.name||"lineSphereCenter"==s[e].object.name)return s[e];return r=y.ndsModel?i?y.ndsModel.intersect(o.ray,o.linePrecision):y.ndsModel.intersect(o.ray):r}function t(e,t){var i=5,t=(null!=t&&(i=t),y.camera.getCameraTarget()),n=y.camera.position,o=new THREE.Vector3,t=(o.subVectors(t,n),e.position.clone()),e=y.camera.isPerspective?t.sub(n).dot(o.normalize()):o.length(),t=y.camera.fov,n=2*e*Math.tan(THREE.Math.degToRad(.5*t)),o=y.renderer.domElement.height;return i*n*y.renderer.getPixelRatio()/o}E.setSelectedClipRadio=(e=!1,t=!0)=>{(s||e!=E.isSelectedClip)&&(s&&(E.clippingObjectsUuids=[],E.unClippingObjectsUuids=[],s=!1),(E.isSelectedClip=e)?(E.clippingObjectsUuids=E.unClippingObjectsUuids.slice(),E.unClippingObjectsUuids=E.allClippingObjectsUuids.filter(e=>!E.clippingObjectsUuids.includes(e))):(E.unClippingObjectsUuids=E.clippingObjectsUuids.slice(),E.clippingObjectsUuids=E.allClippingObjectsUuids.filter(e=>!E.unClippingObjectsUuids.includes(e))),E.updatePartClipData(E.partClipObjects),t)&&(E.updateClipPlane(),y.render())},E.setSelectedClipObjects=(e,i)=>{Array.isArray(e)&&(E.isSelectedClip?e.forEach((e,t)=>{t=i[t],t=l.getModelById(t),e=t.getBodyNodeFromUuid(e),t=t.getLeafBodies(e);t&&t.forEach(e=>{e=e.uuid+"-"+e.ndsModel.id;E.clippingObjectsUuids.includes(e)||E.clippingObjectsUuids.push(e)})}):(e.forEach((e,t)=>{t=i[t],t=l.getModelById(t),e=t.getBodyNodeFromUuid(e),t=t.getLeafBodies(e);t&&t.forEach(e=>{e=e.uuid+"-"+e.ndsModel.id;E.unClippingObjectsUuids.includes(e)||E.unClippingObjectsUuids.push(e)})}),E.unClippingObjectsUuids.length&&(E.clippingObjectsUuids=E.allClippingObjectsUuids.filter(e=>!E.unClippingObjectsUuids.includes(e)))),E.updateClipPlane(),E.updatePartClipData(E.partClipObjects),y.render())},E.removeSelectedClipObjects=(e,t=[],i=[],n=[])=>{let o=[];t.forEach((e,t)=>{t=l.getModelById(n[t]),e=t.getBodyNodeFromUuid(e),t=t.getLeafBodies(e);t&&t.forEach(e=>{e=e.uuid+"-"+e.ndsModel.id;o.push(e)})}),Array.isArray(e)&&(E.isSelectedClip?e.forEach((e,t)=>{t=l.getModelById(i[t]),e=t.getBodyNodeFromUuid(e),t=t.getLeafBodies(e);t&&t.forEach(e=>{let t=e.uuid+"-"+e.ndsModel.id;e=E.clippingObjectsUuids.findIndex(e=>e==t);-1<e&&(o.includes(t)||E.clippingObjectsUuids.splice(e,1))})}):(e.forEach((e,t)=>{t=l.getModelById(i[t]),e=t.getBodyNodeFromUuid(e),t=t.getLeafBodies(e);t&&t.forEach(e=>{let t=e.uuid+"-"+e.ndsModel.id;e=E.unClippingObjectsUuids.findIndex(e=>e==t);-1<e&&(o.includes(t)||E.unClippingObjectsUuids.splice(e,1))})}),E.clippingObjectsUuids=E.allClippingObjectsUuids.filter(e=>!E.unClippingObjectsUuids.includes(e))),E.updateClipPlane(),E.updatePartClipData(E.partClipObjects),y.render())},E.clearSelectedClipObjects=(e=!0)=>{E.partClipObjects&&(E.isSelectedClip?E.clippingObjectsUuids=[]:(E.unClippingObjectsUuids=[],E.clippingObjectsUuids=E.allClippingObjectsUuids.slice()),E.updatePartClipData(E.partClipObjects),e)&&(E.updateClipPlane(),y.render())},E.switchPartClipObjects=(e=!0,t=!0)=>{E.partClipObjects=e,s=e,E.updatePartClipData(E.partClipObjects),t&&(E.updateClipPlane(),y.render())},E.getAllBodyUuid=()=>{var t=(()=>{var t=[],i=l.getModelCount();for(let e=0;e<i;++e){var n=l.getModelByIndex(e);n.isSketchModel||t.push(n)}return t})();for(let e=0;e<t.length;e++){var i=t[e],n=y&&y.ndsModel&&i&&i.bodyUuid2NodeMap;if(n)for(var[o,r]of Object.entries(n))"Body"!=r.type&&"Model"!=r.type||(r=o+"-"+i.id,E.allClippingObjectsUuids.push(r))}},E.onCloseClip=()=>{if(y){if(a(),E.mousemoveClickStatus=!1,l.setIgnoreModelSelection(!1),m(E._domElement),E.prompt.style.zIndex=-99,E.instanceMeshSet.size){if(y.ndsModel)for(var e of E.instanceMeshSet){var t=getNonSketchActiveModel();t&&t.bodyUuid2NodeMap[e].partClipObjects&&(t.bodyUuid2NodeMap[e].partClipObjects=!1)}E.instanceMeshSet.clear()}E.isHideShow=!0,E.updateClipData()}},E.onCustomClipPlane=(e=!1,t,i=!0)=>{var n,o;(E.onCustomClipPlaneStatus=e)?([n=!0]=[i],E.deletedPlaneName=[],Object.keys(E.planeNameToId).forEach(e=>{"R"!=e&&-1<E.planeNameToId[e]&&E.deletedPlaneName.push(e)}),E.deletedPlaneName.forEach(e=>{E.deleteSectionPlane(e,n)}),E.deletedPlaneName=[],E.clearReverseState(),E.clearShowSupplement(),(e=E._clipScene.getObjectByName("sectionRoot"))&&(NDSWebViewer.COMMON.disposeObject(e),E._clipScene.remove(e)),E.partClipObjects&&(p=E.clippingObjectsUuids.slice(),E.clippingObjectsUuids=[]),E.updateClipData(),E.updatePartClipData(E.partClipObjects),e=NDSWebViewer.COMMON.translateString("CLIP_Msg"),E.Popup&&(clearTimeout(E.Popup),E.Popup=null),E.prompt.innerHTML=e,E.prompt.style.display="none",E.prompt.style.zIndex=-99,NDSWebViewer.COMMON.isMobileDevice()&&(e=y.renderer.getSize().height/2-21+"px",E.prompt.style.top=e,E.prompt.style.color="rgba(27,27,27,1)",E.Popup=setTimeout(function(){E.prompt.style.display="none"},2e3)),e=E._domElement,NDSWebViewer.COMMON.isMobileDevice()?e.addEventListener("touchmove",L,!1):e.addEventListener("mousemove",L,!1),e.addEventListener("click",C,!1),e.addEventListener("mousedown",g,!1),e.addEventListener("mouseup",_,!1)):([e,o=!0]=[t,i],e?(Object.keys(E.planeNameToId).forEach(e=>{-1!=E.planeNameToId[e]&&E.deleteSectionPlane(e,o)}),E.clearReverseState(),E.clearShowSupplement(),E.flag&&E.addSectionPlane("YZ",o)):(E.deleteSectionPlane("R",o),E.clearReverseState(),E.clearShowSupplement(),E.flag&&E.addSectionPlane("YZ",o),E.partClipObjects&&p.length&&0==E.clippingObjectsUuids.length&&(E.clippingObjectsUuids=p.slice())),E.clipTransRotControl&&E.clipTransRotControl.object.visible!=E.isHideShow&&E.hideShowClipPlane(E.isHideShow),E.updateClipData(),E.updatePartClipData(E.partClipObjects),m(E._domElement),a(),E.prompt.style.zIndex=-99)},E.objectChangeEvent=e=>{e?(o=!0,E.moveMesh&&(E._clipScene.remove(E.moveMesh),E.moveMesh=null)):o=!1},E.lineMeshPick=e=>{E._lineMeshPick=!!e},E.getMaxDistance=()=>{var e=new THREE.Vector3,e=y.controls.getBoundingBox().getSize(e),e=Math.max(e.x,e.y,e.z);return e*=1.3},E.onPauseCustomPick=e=>{E.onCustomClipPlaneStatus&&(e?(E.prompt.style.display="none",E.prompt.style.zIndex=-99,E._lineMeshPick=!0,E.moveMesh&&(E._clipScene.remove(E.moveMesh),E.moveMesh=null,E.mousemoveClickStatus=!1,l.setIgnoreModelSelection(!1),y.render())):(r||(E.prompt.style.display="block",E.prompt.style.zIndex=5),E._lineMeshPick=!1))},E.setClipDeltaPosition=e=>{e=parseFloat(e);var t,i=new THREE.Vector3,n=E.clipTransRotControl.object,o=new THREE.Vector3(0,0,1);o.applyQuaternion(n.children[0].getWorldQuaternion(V)).normalize(),"R"==E.clipTransRotControl.name?(i.subVectors(n.position,n.clickOriPosition).normalize(),0==i.x&&0==i.y&&0==i.z&&i.copy(o),t=i.dot(n.clickNormal),i.multiplyScalar(e=t<0?-e:e),n.position.addVectors(n.clickOriPosition,i)):(i.subVectors(n.position,n.oriPosition).normalize(),0==i.x&&0==i.y&&0==i.z&&i.copy(o),"YZ"==E.clipTransRotControl.name?i.dot(c)<0&&(e=-e):"XZ"==E.clipTransRotControl.name?i.dot(u)<0&&(e=-e):"XY"==E.clipTransRotControl.name&&i.dot(f)<0&&(e=-e),i.multiplyScalar(e),n.position.addVectors(n.oriPosition,i)),E.clipTransRotControl.update(),E.clipTransRotControl.dispatchEvent({type:"change"}),E.clipTransRotControl.dispatchEvent({type:"objectChange"})},E.setClipDeltaRotation=e=>{var{x:e,y:t,z:i}=e,n=new THREE.Quaternion,o=new THREE.Quaternion,r=new THREE.Quaternion,s=new THREE.Quaternion,l=E.clipTransRotControl.object,a=E.clipTransRotControl.getDeltaRotation(!1);"YZ"==E.clipTransRotControl.name?null!=t&&null!=i&&(0==t&&0==i&&(a.x=0),r.setFromAxisAngle(u,t*Math.PI/180),s.setFromAxisAngle(f,i*Math.PI/180),o.setFromAxisAngle(c,a.x),n.multiplyQuaternions(n,r),n.multiplyQuaternions(n,s),n.multiplyQuaternions(n,o)):"XZ"==E.clipTransRotControl.name?null!=e&&null!=i&&(0==e&&0==i&&(a.y=0),o.setFromAxisAngle(c,e*Math.PI/180),s.setFromAxisAngle(f,i*Math.PI/180),r.setFromAxisAngle(u,a.y),n.multiplyQuaternions(n,o),n.multiplyQuaternions(n,s),n.multiplyQuaternions(n,r)):"XY"==E.clipTransRotControl.name?null!=e&&null!=t&&(0==e&&0==t&&(a.z=0),o.setFromAxisAngle(c,e*Math.PI/180),r.setFromAxisAngle(u,t*Math.PI/180),s.setFromAxisAngle(f,a.z),n.multiplyQuaternions(n,o),n.multiplyQuaternions(n,r),n.multiplyQuaternions(n,s)):"R"==E.clipTransRotControl.name&&null!=t&&null!=i&&(r.setFromAxisAngle(u,t*Math.PI/180+E.clipTransRotControl.RDelta.y),s.setFromAxisAngle(f,i*Math.PI/180+E.clipTransRotControl.RDelta.z),o.setFromAxisAngle(c,a.x),n.multiplyQuaternions(n,r),n.multiplyQuaternions(n,s),n.multiplyQuaternions(n,o)),l.quaternion.copy(n),E.clipTransRotControl.update(),E.clipTransRotControl.dispatchEvent({type:"change"}),E.clipTransRotControl.dispatchEvent({type:"objectChange"})},E.showClipLine=(e,t=!0)=>{E.clipTransRotControl&&(E.showClipLineVisible=!!e,t)&&E.clipTransRotControl.dispatchEvent({type:"objectChange"})},E.showClipMesh=(e,t=!0)=>{E.clipTransRotControl&&(E.showClipMeshVisible=!!e,t)&&E.clipTransRotControl.dispatchEvent({type:"objectChange"})},E.setClipLineColor=(e,t=!0)=>{E.clipTransRotControl&&(e?(E.lineColor.set(e.r/255,e.g/255,e.b/255),E.useLineColor=!0):E.useLineColor=!1,t)&&E.clipTransRotControl.dispatchEvent({type:"objectChange"})},E.setClipMeshColor=(e,t=!0)=>{E.clipTransRotControl&&(e?(E.meshColor.set(e.r/255,e.g/255,e.b/255),E.useMeshColor=!0):E.useMeshColor=!1,E.randomClipMeshColor=!1,t)&&E.clipTransRotControl.dispatchEvent({type:"objectChange"})},E.setHideShowStatus=e=>{E.isHideShow=!e},E.setReserveStatus=e=>{E.isReverse=e},E.setClipMeshRandom=()=>{E.clipTransRotControl&&(E.randomClipMeshColor=!0,E.clipTransRotControl.dispatchEvent({type:"objectChange"}))},E.getRandomColor=()=>{var e=1e-4*Math.floor(1e4*Math.random()),t=1e-4*Math.floor(1e4*Math.random()),i=1e-4*Math.floor(1e4*Math.random());return new THREE.Color(e,t,i)},E.renderPoints=()=>{var e;w&&b&&N&&(e=t(w,1),w.scale.set(e,e,e),w.updateMatrixWorld(!0),b.scale.set(e,e,e),b.updateMatrixWorld(!0),N.scale.set(e,e,e),N.updateMatrixWorld(!0)),O&&R&&A&&(e=t(O,1),O.scale.set(e,e,e),O.updateMatrixWorld(!0),R.scale.set(e,e,e),R.updateMatrixWorld(!0),A.scale.set(e,e,e),A.updateMatrixWorld(!0))},E.setSelInfoByIntersect=(e,t)=>{let i=null;h.copy(e.point);var n,o=W(e);E.clipIntersect=e,o&&("line"==o.type||"plane"==o.type)&&E.mousemoveClickStatus&&(E.moveMesh&&(E._clipScene.remove(E.moveMesh),E.moveMesh=null),(e=E._clipScene.getObjectByName("clipSelectedMesh"))&&e._id==o.id||("line"==o.type?i=X(o,!0,!0):"plane"==o.type&&(i=Y(o,!0,!0)),a(),i.name="clipSelectedMesh",i._id=o.id,E._clipScene.add(i),d.copy(v),t?(e=i,o=new THREE.Vector3,t=new THREE.Vector3,n=E.clipTransRotControl.object,("Face"==e.objectType?(o.subVectors(P,M),t.subVectors(P,I),o.cross(t)):o.subVectors(T,x)).normalize(),n.clickNormal=o.clone()):B(),y.dispatchEvent({type:"clipStatus",status:!0})),r=!0),NDSWebViewer.SETTING.enableBroadcast&&NDSWebViewer.SETTING.broadcastMajor&&NDSWebViewer.ExtensionManager.updateBroadcastInfo("ClipExtension")}}e=new class extends L{constructor(){super(),this.setFlags(i.FLAG_ENABLE_NODE_STOREVIEW|i.FLAG_ENABLE_NODE_BROADCAST),this.name="ClipExtension",console.log("ClipExtension version 1.1.3"),this.coreView=null,this.needsRedraw=!1,this.redererSide=null}onLoad(e){this.sceneWrapper=new n(e),this.coreView=e,this.__clipDataManagerWrapper=new o(e.clipDataManager),this.__clipPlaneManager,this.__clipBoxManager,this.attach2View()}initClipExtension(e,t){this.__clipPlaneManager=new le(this.coreView,e,t),this.__clipBoxManager=new se(this.coreView),ae(this);let i=this;this.__clipDataManagerWrapper.registerClipExtensionCallback((e,t)=>{if(e===i.__clipDataManagerWrapper.getEventType().supportMeasureClip)return i.__clipPlaneManager.supportMeasureClip()}),this.coreView.addEventListener("reverseBodyVisibility",()=>{var e=i.__clipPlaneManager.getClipMeshVisible();i.__clipPlaneManager.setClipMeshVisible(!e),i.sceneWrapper.renderAllViews()})}onInitLights(e){}onNdsModelPrepareForRendering(e){}onAfterAllNdsModelSetRender(e,t){var i;this.sceneWrapper.isLoadedNdsModelEmpty()||(i=t.stopRenderingEarly,e&&(this.renderClipBox(t.colorTarget),this.renderClipScene(t.colorTarget),this.needsRedraw=!0),e=this.__clipPlaneManager.getClipPlaneVisible(),!i&&this.needsRedraw&&(this.needsRedraw=!1,e&&this.__clipPlaneManager.hideShowClipPlane(!1,!1),this.renderClipScene(t.colorTarget),e)&&this.__clipPlaneManager.hideShowClipPlane(!0,!1),t.stopRenderingEarly=i)}onBeforeScreenCapture(e){var t=!!e.bFullScreenCapture,e=!!e.bShowClipPlane;t||e||!this.isSectionViewEnabled()||(this.__clipPlaneManager.getClipPlaneVisible()&&(this.hideShowClipPlane(!1),this.showClipPlane=!0),this.__clipPlaneManager.getClipControlVisible()&&(this.__clipPlaneManager.onCloseClipControl(),this.showClipControl=!0)),!t&&this.isSectionBoxEnabled()&&this.__clipBoxManager.getSectionBoxVisible()&&this.__clipBoxManager.displaySectionBox(!1)}onAfterScreenCapture(){this.isSectionViewEnabled()&&(this.showClipPlane&&this.hideShowClipPlane(!0),this.showClipControl&&this.__clipPlaneManager.onOpenClipControl(),this.showClipPlane=void 0,this.showClipControl=void 0),this.isSectionBoxEnabled()&&this.__clipBoxManager.displaySectionBox(!0)}onAfterNdsModelUpdate(e,t){e&&e.state===NDSWebViewer.NdsModel.StateType.ALL_GEOM_LOADED&&(e=e.viewer.clipPlaneInfo)&&(this.isSectionViewEnabled()||this.onSectionView(!0,!1),this.__clipPlaneManager.setClipPlaneInfor(e))}onAfterGetBroadcastInfo(e){e.clipInfo={},this.getStoreInfo(e.clipInfo),e.clipInfo.BoxClipInfo=this.getBoxClipInfo()}onAfterSetBroadcastInfo(t){if(void 0!==t.clipInfo){if(null!=t.clipInfo.clipPlaneInfo)this.isClipBoxActive()&&this.onBoxSectionView(!1),this.setStoreInfo(t.clipInfo);else if(t.clipInfo.BoxClipInfo){this.isSectionViewEnabled()&&this.onSectionView(!1,!1);var i,t=t.clipInfo.BoxClipInfo;if(!0===t.clipBoxActive){let e=null;t.clipbox&&(i=new THREE.Vector3(t.clipbox.min.x,t.clipbox.min.y,t.clipbox.min.z),t=new THREE.Vector3(t.clipbox.max.x,t.clipbox.max.y,t.clipbox.max.z),(e=new THREE.Box3).set(i,t)),this.onBoxSectionView(!1),this.onBoxSectionView(!0,e)}else this.isClipBoxActive()&&this.onBoxSectionView(!1)}this.onCloseClipControl()}}onSetCaptureView(e,t){e?(this.isSectionViewEnabled()||this.onSectionView(!0,!1),this.__clipPlaneManager.setClipPlaneInfor(t),this.__clipPlaneManager.onCloseClipControl()):this.onSectionView(!1,!1),this.updateBroadcastClipInfo()}getStoreInfo(e){this.isSectionViewEnabled()&&(e.clipPlaneInfo=this.__clipPlaneManager.getClipPlaneInfor(!0))}setStoreInfo(e){null!=e.clipPlaneInfo?(this.onSectionView(!1,!1),this.onSectionView(!0,!1),this.__clipPlaneManager.setClipPlaneInfor(e.clipPlaneInfo,!0),this.updateClipPlane()):this.isSectionViewEnabled()&&this.onSectionView(!1,!1)}setInClipMode(e){this.__clipPlaneManager&&this.__clipPlaneManager.setInClipMode(e)}resetToDefault(){this.onSectionView(!1)}clear(){console.log("Clear clip extension!"),this.onBoxSectionView(!1),this.onSectionView(!1),this.__clipPlaneManager.allClippingObjectsUuids=[],this.__clipPlaneManager.clearSelectedClipObjects()}needDisableInputEvent(){return this.isClipTransformControlSelected()}isSectionViewEnabled(){return this.__clipPlaneManager.isSectionViewEnabled()}setSectionImageFlag(e){this.__clipPlaneManager&&((this.__clipPlaneManager.showSectionImage=e)&&this.__clipPlaneManager.updateClipPlane(),this.updateBroadcastClipInfo())}updateClipPlane(){this.__clipPlaneManager&&this.isSectionViewEnabled()&&(this.__clipPlaneManager.updateClipPlane(),this.updateBroadcastClipInfo())}onBoxSectionView(e,t){var i=Date.now();this.__clipBoxManager&&(this.__clipBoxManager.onBoxSectionView(e,t),NDSWebViewer.SETTING.enableSelect=!e),e?(this.redererSide=this.coreView.renderer.getNdsModelRenderSide(),this.redererSide!=THREE.DoubleSide?this.coreView.renderer.setNdsModelRenderSide(THREE.DoubleSide):this.redererSide=null,this.sceneWrapper.logOperatorTimeShow("[][]",i)):(null!=this.redererSide&&(this.coreView.renderer.setNdsModelRenderSide(this.redererSide),this.redererSide=null),this.sceneWrapper.logOperatorTimeShow("[][]",i)),this.updateBroadcastClipInfo()}onSectionView(e,t){var i;this.__clipPlaneManager.flag!=e&&(i=Date.now(),this.__clipPlaneManager.onSectionView(e,t),e?(this.redererSide=this.coreView.renderer.getNdsModelRenderSide(),this.redererSide!=THREE.DoubleSide?this.coreView.renderer.setNdsModelRenderSide(THREE.DoubleSide):this.redererSide=null,this.sceneWrapper.logOperatorTimeShow("[][]",i)):(null!=this.redererSide&&(this.coreView.renderer.setNdsModelRenderSide(this.redererSide),this.redererSide=null),this.sceneWrapper.logOperatorTimeShow("[][]",i)),this.updateBroadcastClipInfo())}onCloseClipControl(){this.__clipPlaneManager&&(this.__clipPlaneManager.onCloseClipControl(),this.__clipBoxManager.SetRenderBox(!1),this.sceneWrapper.renderAllViews())}onOpenClipControl(){this.__clipPlaneManager&&this.__clipPlaneManager&&(this.__clipPlaneManager.isSectionViewEnabled()&&this.__clipPlaneManager.onOpenClipControl(),this.__clipBoxManager.SetRenderBox(!0),this.sceneWrapper.renderAllViews())}setClipTransControlMode(e){this.__clipPlaneManager.setClipTransControlMode(e)}setActiveSectionPlane(e){var t=Date.now();this.__clipPlaneManager&&this.__clipPlaneManager.setActiveSectionPlane(e.toUpperCase()),this.sceneWrapper.logOperatorTimeShow("[]["+e+"]",t),this.updateBroadcastClipInfo()}deleteSectionPlane(e){var t=Date.now();this.__clipPlaneManager&&this.__clipPlaneManager.deleteSectionPlane(e.toUpperCase()),this.sceneWrapper.logOperatorTimeShow("[]["+e+"]",t),this.updateBroadcastClipInfo()}addSectionPlane(e){var t=Date.now();this.__clipPlaneManager&&this.__clipPlaneManager.addSectionPlane(e.toUpperCase()),this.sceneWrapper.logOperatorTimeShow("[]["+e+"]",t),this.updateBroadcastClipInfo()}hideShowClipPlane(e){this.__clipPlaneManager.hideShowClipPlane(e),this.updateBroadcastClipInfo()}reverseClipDirection(e,t){this.__clipPlaneManager.reverseClipDirection(e,t),this.updateBroadcastClipInfo()}reverseClipDirectionApp(e){this.__clipPlaneManager.reverseClipDirectionApp(e),this.updateBroadcastClipInfo()}showSupplementClip(e){this.__clipPlaneManager.showSupplementClip(e)}switchPartClipObjects(e=!0,t=!0){this.__clipPlaneManager.switchPartClipObjects&&this.__clipPlaneManager.switchPartClipObjects(e,t),this.updateBroadcastClipInfo()}setSelectedClipRadio(e=!1,t=!0){this.__clipPlaneManager.setSelectedClipRadio&&this.__clipPlaneManager.setSelectedClipRadio(e,t),this.updateBroadcastClipInfo()}setSelectedClipObjects(e,t){this.__clipPlaneManager.setSelectedClipObjects&&this.__clipPlaneManager.setSelectedClipObjects(e,t),this.updateBroadcastClipInfo()}removeSelectedClipObjects(e,t=[],i=[],n=[]){this.__clipPlaneManager.removeSelectedClipObjects&&this.__clipPlaneManager.removeSelectedClipObjects(e,t,i,n),this.updateBroadcastClipInfo()}clearSelectedClipObjects(){this.__clipPlaneManager.clearSelectedClipObjects&&this.__clipPlaneManager.clearSelectedClipObjects(),this.updateBroadcastClipInfo()}showClipLine(e){this.__clipPlaneManager.showClipLine&&this.__clipPlaneManager.showClipLine(e),this.updateBroadcastClipInfo()}setClipLineColor(e){this.__clipPlaneManager.setClipLineColor&&this.__clipPlaneManager.setClipLineColor(e),this.updateBroadcastClipInfo()}showClipMesh(e){this.__clipPlaneManager.showClipMesh&&this.__clipPlaneManager.showClipMesh(e),this.updateBroadcastClipInfo()}setClipMeshColor(e){this.__clipPlaneManager.setClipMeshColor&&this.__clipPlaneManager.setClipMeshColor(e),this.updateBroadcastClipInfo()}setClipMeshRandom(){this.__clipPlaneManager.setClipMeshRandom&&this.__clipPlaneManager.setClipMeshRandom(),this.updateBroadcastClipInfo()}onCustomClipPlane(e=!1,t){this.__clipPlaneManager.onCustomClipPlane&&this.__clipPlaneManager.onCustomClipPlane(e,t),this.updateBroadcastClipInfo()}setClipDeltaPosition(e){this.__clipPlaneManager.setClipDeltaPosition&&this.__clipPlaneManager.setClipDeltaPosition(e),this.updateBroadcastClipInfo()}setClipDeltaRotation(e){this.__clipPlaneManager.setClipDeltaRotation&&this.__clipPlaneManager.setClipDeltaRotation(e),this.updateBroadcastClipInfo()}resetClipStatus(e={isCustom:!1,isCustomReset:!0,showClipLine:!0,clipLineColor:void 0,showClipMesh:!0,clipMeshColor:void 0,hideShowStatus:!1,hideShowClipPlane:!0,reverseClipPlaneStatus:{planeName:"YZ",reverseSate:!1}},t=!1){this.__clipPlaneManager&&(this.__clipPlaneManager.clearSelectedClipObjects(!1),void 0!==e.isCustom&&void 0!==e.isCustomReset&&this.__clipPlaneManager.onCustomClipPlane(e.isCustom,e.isCustomReset,!1),void 0!==e.showClipLine&&this.__clipPlaneManager.showClipLine(e.showClipLine,!1),void 0!==e.clipLineColor&&this.__clipPlaneManager.setClipLineColor(e.clipLineColor,!1),void 0!==e.showClipMesh&&this.__clipPlaneManager.showClipMesh(e.showClipMesh),void 0!==e.clipMeshColor&&this.__clipPlaneManager.setClipMeshColor(e.clipMeshColor,!1),void 0!==e.hideShowStatus&&this.__clipPlaneManager.setHideShowStatus(e.hideShowStatus),void 0!==e.hideShowClipPlane&&this.__clipPlaneManager.hideShowClipPlane(e.hideShowClipPlane),void 0!==e.reverseClipPlaneStatus&&this.__clipPlaneManager.reverseClipDirection(e.reverseClipPlaneStatus.planeName,e.reverseClipPlaneStatus.reverseSate,!1),void 0!==e.reverseCoutNew&&this.__clipPlaneManager.showSupplementClip(e.reverseCoutNew,!1),t&&this.__clipPlaneManager.clipTransRotControl&&this.__clipPlaneManager.clipTransRotControl.dispatchEvent({type:"objectChange"}),this.updateBroadcastClipInfo())}lineMeshPick(e){this.__clipPlaneManager.lineMeshPick&&this.__clipPlaneManager.lineMeshPick(e),this.updateBroadcastClipInfo()}onPauseCustomPick(e){this.__clipPlaneManager.onPauseCustomPick&&this.__clipPlaneManager.onPauseCustomPick(e),this.updateBroadcastClipInfo()}getMaxDistance(){var e;return!this.__clipPlaneManager.getMaxDistance||(e=this.__clipPlaneManager.getMaxDistance())<1?1:e}setReserveStatus(e){this.__clipPlaneManager.setReserveStatus&&this.__clipPlaneManager.setReserveStatus(e),this.updateBroadcastClipInfo()}setHideShowStatus(e){this.__clipPlaneManager.setHideShowStatus&&this.__clipPlaneManager.setHideShowStatus(e),this.updateBroadcastClipInfo()}getClipPlaneInfo(e=!1){return this.__clipPlaneManager.getClipPlaneInfor(e)}setClipPlaneInfo(t){if(null!=t){let e=!0;this.coreView.addEventListener("BrepInfoEvent",()=>{e&&(this.__clipPlaneManager._clipIntersectInfor(t),this.sceneWrapper.renderAllViews(),e=!1)}),this.onSectionView(!1,!1),this.onSectionView(!0,!1),this.__clipPlaneManager.setClipPlaneInfor(t,!0),this.__clipPlaneManager.clipTransRotControl&&this.__clipPlaneManager.clipTransRotControl.dispatchEvent({type:"objectChange"})}}getBoxClipInfo(){return this.__clipBoxManager.getBoxClipInfo()}onCloseViewSection(){this.__clipPlaneManager.onCloseViewSection()}isClipTransformControlSelected(){var e,t;if(this.__clipPlaneManager&&this.__clipBoxManager)return e=this.__clipPlaneManager.isClipTransformControlSelected(),t=this.__clipBoxManager.isClipTransformControlSelected(),e||t}setClipModelAsActiveModel(e){var t=this.getNdsClipModel();return!(!t||e.id!==t.id||(this.sceneWrapper.setActiveModelByModel(e),0))}getNdsClipModel(){return this.__clipPlaneManager.supportMeasureClip()?this.__clipPlaneManager.clipModel:null}getInternalNdsClipModel(){return this.__clipPlaneManager.clipModel}isClipBoxActive(){return this.__clipBoxManager.active}isSectionBoxEnabled(){return this.__clipBoxManager.isSectionBoxEnabled()}renderClipPlane(e,t){this.__clipPlaneManager.renderClipPlane(e,t)}renderClipScene(e,t){this.__clipPlaneManager.renderClipScene(e,t)}renderClipBox(e,t){this.__clipBoxManager.renderClipBox(e,t)}hasClipCapScene(){return this.__clipPlaneManager.hasClipCapScene()}getPlaneEditControls(){return this.__clipBoxManager.getPlaneEditControls()}getTransformControls(){return this.__clipBoxManager.getTransformControls()}getNdsModelForMeasure(){return this.__clipPlaneManager&&this.__clipPlaneManager.isSectionViewEnabled()&&this.__clipPlaneManager.enableClipPlaneMeasure&&this.getNdsClipModel()&&this.getNdsClipModel().getIsClipModelIntersected()?this.__clipPlaneManager.clipModel:this.coreView.ndsModel}isPointBeforeClipPlane(e){return this.__clipPlaneManager.isPointBeforeClipPlane(e)}isClipPlanesFacingCamera(){return this.__clipPlaneManager.isSelectedPlaneFacingCamera()}reverseClipObjectVisibility(){var e;this.__clipPlaneManager&&1==this.__clipPlaneManager.flag&&(e=this.__clipPlaneManager.getClipMeshVisible(),this.__clipPlaneManager.setClipMeshVisible(!e)),this.updateBroadcastClipInfo()}updateBroadcastClipInfo(){NDSWebViewer.SETTING.enableBroadcast&&NDSWebViewer.SETTING.broadcastMajor&&NDSWebViewer.ExtensionManager.updateBroadcastInfo("ClipExtension")}attach2View(){}};NDSWebViewer.ExtensionManager.addExtension(e)}],n={},o.m=i,o.c=n,o.d=function(e,t,i){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(o.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)o.d(i,n,function(e){return t[e]}.bind(null,n));return i},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o(o.s=3);function o(e){var t;return(n[e]||(t=n[e]={i:e,l:!1,exports:{}},i[e].call(t.exports,t,t.exports,o),t.l=!0,t)).exports}var i,n});