!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.NDSMeasure=t():e.NDSMeasure=t()}(window,function(){return n=[function(e,t,n){n.r(t),n.d(t,"NDSMeasureExtension",function(){return E});function i(e){this.viewer=e.viewer,this.OpMeasure=e,this.measureType="",this.measureClass="Base",this.InfoType=0,this.snappingTool=new NDSWebViewer.SnappingTool(this.viewer),this.snappedPoint=null,this.textLines=[],this.POINTSIZE=3,this.LINEWIDTH=2,this.ARCWIDTH=2,this.CYLINDERWIDTH=14,this.cylinderRadiusBottom=.4,this.cylinderHeight=1.2,this.edgeInfo={startPos:null,endPos:null,selLineInfo:null,selLineObj:null,preSelLineInfo:null,preSelLineObj:null,startToClndLine:null,endToClndLine:null,clndToClndLine:null,lineType:"",boxToClndLine:null,centerToClndLine:null,fstClnd:null,sndClnd:null,fstClndPos:null,sndClndPos:null,selLineCenterPos:null,dimString:"",unit:"",textBox:null,textPos:null},this.holeInfo={firstHoleInfo:null,secondHoleInfo:null,preSelHoleInfo:null,preSelHoleObj:null,firstSelHoleObj:null,secondSelHoleObj:null,fstToClndLine:null,sndToClndLine:null,clndToClndLine:null,boxToClndLine:null,centerToClndLine:null,centerToClndLine2:null,fstClnd:null,sndClnd:null,fstClndPos:null,sndClndPos:null,selLineCenterPos:null,textBox:null,textPos:null,dimString:"",unit:""},this.distanceInfo={firstSelObj:null,firstSelInfo:null,secondSelObj:null,secondSelInfo:null,axisLineObj:null,secaxisLineObj:null,projectPlaneObj:null,projectPlaneInfo:null,projectPlane:null,projectFstPos:null,projectSecPos:null,projectFstClnd:null,projectSecClnd:null,firstPoint:null,secondPoint:null,preSelInfo:null,preSelObj:null,preSelInfoOld:null,fstToSndLine:null,FstToFstPointLine:null,SndToSndPointLine:null,fstToClndLine:null,sndToClndLine:null,clndToClndLine:null,boxToClndLine:null,fstClnd:null,sndClnd:null,fstClndPos:null,sndClndPos:null,dimStringPrefix:"",dimString:"",unit:"",textBox:null,textPos:null,XorY:0,mousePos:null,snapPreSelInfo:null,start:null,mid:null,end:null,center:null,snapPointType:"",limitCircleCentersSize:10,circleCenters:[],intersects:[],preSelIntersect:null},this.faceInfo={fstIntersect:null,sndIntersect:null,firstFaceInfo:null,secondFaceInfo:null,preSelFaceInfo:null,preSelFaceObj:null,fstSelFaceObj:null,sndSelFaceObj:null,fstToClndLine:null,sndToClndLine:null,clndToClndLine:null,boxToClndLine:null,fstClnd:null,sndClnd:null,fstToMidLine:null,midToClndLine:null,arcMeshes:[],arcCenter:null,midLineEndPt:null,fstClndPos:null,sndClndPos:null,dimString:"",unit:"",textBox:null,textPos:null,selFaceObjs:[],selFaceInfors:[]},this.lineAngleInfo={firstLineObj:null,firstLineInfo:null,secondLineObj:null,secondLineInfo:null,preSelLineInfo:null,preSelLineObj:null,fstClnd:null,sndClnd:null,fstClndPos:null,sndClndPos:null,arcMeshes:[],arcCenter:null,auxLine1:null,auxLine2:null,dimString:"",unit:"",textBox:null,textPos:null,twoPlane:!1,firstHelpPointobj:null,firstHelpPointInfo:null,secHelpPointobj:null,secHelpPointInfo:null,thrHelpPointobj:null,thrHelpPointInfo:null},this.lineContoursInfo={preSelLineInfo:null,preSelLineObj:null,prestart:new THREE.Vector2,preend:new THREE.Vector2,unit:"",divPos:null,divBox:null,perimeter:0,Contours:[],start:new THREE.Vector2,end:new THREE.Vector2},this.perimeterInfos=[],this.preSelectBody=null,this.preSelectBodyMat=null,this.contourdiv=null,this.coordinatediv=null,this.coordinatedivtextPos=null,this.coordinatedivdims=null,this.lineargaugediv=null,this.shadowdiv=null,this.materialLine=new THREE.MeshBasicMaterial({color:8190976,opacity:.8,transparent:!0,depthTest:!1,depthWrite:!1,side:THREE.DoubleSide}),this.appmaterialLine=new THREE.MeshBasicMaterial({color:16743724,opacity:.8,transparent:!0,depthTest:!1,depthWrite:!1,side:THREE.DoubleSide}),this.materialPoint=NDSWebViewer.SETTING.selectedVertexMaterial,this.materialProjectPoint=new THREE.MeshBasicMaterial({color:65535,opacity:.8,transparent:!0,depthTest:!1,depthWrite:!1}),this.axisLine=new THREE.LineBasicMaterial({opacity:1,color:16711680,side:THREE.DoubleSide,depthTest:!1,depthWrite:!1,transparent:!1}),this.materialBoxLine=new THREE.LineBasicMaterial({opacity:.8,color:8190976,side:THREE.DoubleSide,depthTest:!1,depthWrite:!1,transparent:!0}),this.materialPreSelectMeshopacity=new THREE.MeshBasicMaterial({color:65535,side:THREE.DoubleSide,depthTest:!0,depthWrite:!0,transparent:!1});var l=this;this.touchstart=function(e){if(this.parentElement){switch(l.OpMeasure.unsteady=!0,l.measureType){case"PointToLine":case"PointToFace":case"AxisToPoint":case"LineToLine":case"LineToFace":case"faceDist":case"AxisToLine":case"AxisToFace":case"holeDist":case"pt2pt":case"pt2ptbim":l.OpMeasure.unsteadyType="Distance";break;case"radius":l.OpMeasure.unsteadyType="Radius";break;case"measureEdges":l.OpMeasure.unsteadyType="measureEdges";break;case"LineAngle":case"LineFaceAngle":case"faceAngle":case"angle":l.OpMeasure.unsteadyType="Angle";break;case"bodyAngle":case"bodyEdgeLength":case"bodyDistance":l.OpMeasure.unsteadyType=l.measureType;break;case"LmPt2Pt":case"LmPt2Line":case"LmLine2Line":case"LmHole2Hole":case"LmAxis2Pt":case"LmAxis2Line":l.OpMeasure.unsteadyType="Lineargauge3D";break;case"WallThickness":l.OpMeasure.unsteadyType="WallThickness";break;default:l.OpMeasure.unsteadyType=l.OpMeasure.unsteadyData[this.getAttribute("group")].measureType}l.OpMeasure.unsteadyuuid=this.getAttribute("group"),l.OpMeasure.unsteadyTextBox=this,l.OpMeasure.unsteadyMoving=!1,l.OpMeasure.startPoint=e.touches?[e.touches[0].clientX,e.touches[0].clientY]:[e.clientX,e.clientY],e.preventDefault()}},this.touchend=function(e){l.OpMeasure.unsteady=!1,l.OpMeasure.unsteadyuuid=null,l.OpMeasure.unsteadyMoving=!1,l.OpMeasure.startPoint=null,l.OpMeasure.unsteadyType="",e.preventDefault()},this.touchmove=function(e){var t=e.touches?[e.touches[0].clientX,e.touches[0].clientY]:[e.clientX,e.clientY],n=l.OpMeasure.startPoint,i=1.1*window.devicePixelRatio;t&&n&&(Math.abs(t[0]-n[0])>i||Math.abs(t[1]-n[1])>i)?(l.OpMeasure.startPoint=t,l.OpMeasure.unsteadyTextBox=this,l.OpMeasure.unsteadyMoving=!0,n=document.createEvent("HTMLEvents"),NDSWebViewer.COMMON.isMobileDevice()?(n.initEvent("touchmove",!0,!0),n.touches=e.touches,n.force=!0,1==e.touches.length&&(l.OpMeasure.state=NDSWebViewer.NDS.TOUCH.TOUCH_SINGLE)):(n.initEvent("mousemove",!0,!0),0===e.button&&(l.OpMeasure.state=NDSWebViewer.NDS.MOUSE.NONE),n.offsetX=e.offsetX,n.clientX=e.clientX,n.offsetY=e.offsetY,n.clientY=e.clientY),(l.viewer.canvas2D||l.viewer.canvas3D).dispatchEvent(n),e.preventDefault()):NDSWebViewer.COMMON.isMobileDevice()||l.OpMeasure.InfoType!=NDSWebViewer.NDS.INFOTYPE.MOUSEENTER&&l.OpMeasure.InfoType!=NDSWebViewer.NDS.INFOTYPE.CROSSENTER&&l.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.MOUSEENTER)},this.mouseenter=function(){l.OpMeasure.InfoType!=NDSWebViewer.NDS.INFOTYPE.MOUSEENTER&&l.OpMeasure.InfoType!=NDSWebViewer.NDS.INFOTYPE.CROSSENTER&&l.OpMeasure.InfoType!=NDSWebViewer.NDS.INFOTYPE.MEASURENOTICEBEGIN&&(l.InfoType=l.OpMeasure.InfoType),l.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.MOUSEENTER),l.clearPreInfo()},this.mouseleave=function(e){l.OpMeasure.unsteady||l.OpMeasure.PostInfo(l.InfoType)},this.sectionCrossend=function(e){if(e&&e.preventDefault(),!l.OpMeasure.unsteadyMoving){l.OpMeasure.unsteadyuuid=this.parentElement.getAttribute("group");var t=l.OpMeasure.rootObject.getObjectByProperty("uuid",l.OpMeasure.unsteadyuuid);if("ellipse"==t.measureType){var n=this.parentElement.getAttribute("radiusType"),e=t.getObjectByProperty("objectType","radius"+n);t.children[0].remove(e);for(let e=t.children.length-1;-1<e;e--){var i=t.children[e];i.radiusType==n&&t.remove(i)}l.viewer.container.removeChild(this.parentElement);for(var s=999,o=0;o<l.OpMeasure.boxInfos.length;++o){var r=l.OpMeasure.boxInfos[o],a=Number(r.textBox.getAttribute("lineInfo"));r.textBox.getAttribute("group")==l.OpMeasure.unsteadyuuid&&r.textBox.getAttribute("radiusType")==n&&(l.OpMeasure.boxInfos.splice(o,1),s=a,o--),s<a&&r.textBox.setAttribute("lineInfo",a-1)}for(o=0;o<l.OpMeasure.textLines.length;++o)if((r=l.OpMeasure.textLines[o]).uuid==l.OpMeasure.unsteadyuuid+n){l.OpMeasure.textLines.splice(o,1);break}t.subnum++,2==t.subnum&&(delete l.OpMeasure.unsteadyData[l.OpMeasure.unsteadyuuid],l.OpMeasure.rootObject.remove(t),l.OpMeasure.viewer.dispatchEvent({type:"measureChangeEvent",measureType:"delete",data:{measureId:l.OpMeasure.unsteadyuuid}}),l.OpMeasure.submeasureTimes())}else{delete l.OpMeasure.unsteadyData[l.OpMeasure.unsteadyuuid],l.OpMeasure.rootObject.remove(t),l.viewer.container.removeChild(this.parentElement);for(s=999,o=0;o<l.OpMeasure.boxInfos.length;++o){r=l.OpMeasure.boxInfos[o],a=Number(r.textBox.getAttribute("lineInfo"));r.textBox.getAttribute("group")==l.OpMeasure.unsteadyuuid&&(l.OpMeasure.boxInfos.splice(o,1),s=a,o--),s<a&&r.textBox.setAttribute("lineInfo",a-1)}for(o=0;o<l.OpMeasure.textLines.length;++o)if((r=l.OpMeasure.textLines[o]).uuid==l.OpMeasure.unsteadyuuid){l.OpMeasure.textLines.splice(o,1);break}l.OpMeasure.viewer.dispatchEvent({type:"measureChangeEvent",measureType:"delete",data:{measureId:l.OpMeasure.unsteadyuuid}}),l.OpMeasure.submeasureTimes()}l.OpMeasure.unsteady=!1,l.OpMeasure.PostInfo(l.InfoType),l.OpMeasure.viewer.render()}},this.crossenter=function(e){e.preventDefault(),l.OpMeasure.InfoType!=NDSWebViewer.NDS.INFOTYPE.MOUSEENTER&&l.OpMeasure.InfoType!=NDSWebViewer.NDS.INFOTYPE.CROSSENTER&&l.OpMeasure.InfoType!=NDSWebViewer.NDS.INFOTYPE.MEASURENOTICEBEGIN&&(l.InfoType=l.OpMeasure.InfoType),l.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.CROSSENTER)},this.crossleave=function(e){e.preventDefault(),l.OpMeasure.PostInfo(l.InfoType)}}function o(e){i.call(this,e),this.measureClass="Distance"}function r(e){i.call(this,e),this.measureClass="Hole"}function a(e){i.call(this,e),this.measureClass="Edge"}function s(e){i.call(this,e),this.measureClass="Face"}function l(e){i.call(this,e),this.measureClass="Angle"}function d(e){i.call(this,e),this.measureClass="BodyAndTotal"}function c(e){i.call(this,e),this.measureClass="Coordinate"}function h(e){i.call(this,e),this.measureClass="Lineargauge"}n=48;NDSWebViewer.NDS.INFOTYPE={POINT:1,SECONDPOINT:2,POINTLINE:3,LINE:4,POINTPLANE:5,PLANE:6,SECONDLINE:7,LINEPLANE:8,PARALLELLINE:9,PARALLELPLANE:10,CIRCLE:11,SECONDCIRCLE:12,SECONDPLANE:13,AXISLINE:14,AXISPOINT:15,AXIS:16,AXISPLANE:17,FACE:18,CIRCLEANDLINE:19,FIRSTPOINT:20,BODY:21,LINEPOSITION:22,FIRMEASUREBODY:23,SECMEASUREBODY:24,MEASUREBODY:25,THIRDPOINT:26,ENDMEASURE:27,CANCELLINE:28,FIRSTLINE:29,MOUSEENTER:30,CROSSENTER:31,FIRSTPLANE:32,COORDINATEPOINT:33,CIRCLEA:34,LINEANDCIRCLE:35,FIRSTPARALLELPLANE:36,CLICKFIRSTPOINT:37,CLICKSECONDPOINT:38,PROJECTPLANE:39,SELECTPROJECTPLANE:40,PLACELINELOCATION:41,SELECTPLACELINELOCATION:42,FIRSTMESH:43,SECONDMESH:44,CIRCLEBEGIN:45,CIRCLECYLINDER:46,CIRCLECENTER:47,MEASURENOTICEBEGIN:n,AXISNOPARALLEL:49,NOPARALLEL:50,INTERSECT:51,LINEPARALLEL:52,PLANEPARALLELLINE:53,LINEPARALLELPLANE:54,PLANEPARALLEL:55,TWOAXISNOPARALLEL:56,NOBREP:57,NOCONJOINT:58,NOCLOSE:59,PLANENOPARALLEL:60,LINENOPARALLEL:61,NOTFACE:62,LOADDATE:63,TWOBODYPARALLEL:64,TWOBODYNOTPARALLEL:65,NOTFACEPARALLEL:66,NOTFACESECOND:67,MESHVERTICAL:68,AXISNOPARALLELLINE:69,NOBREPNOPLNE:70,BREPDATAERROR:71},NDSWebViewer.NDS.MEASUREFLAG={pt2pt:1,pointtoline:2,pointtoface:4,axistopoint:8,linetoline:16,linetoface:32,facedist:64,axistoline:128,axistoface:256,holedist:512,Edge:512,perimeter:1024,LineAngle:2048,LineFaceAngle:4096,faceAngle:8192,radius:16384,contour:32768,contourarea:65536,Lineargauge:131072,coordinate:262144,bodyAngle:524288,bodyDistance:1048576,bodyEdgeLength:2097152,angle:4194304,pt2ptbim:8388608,LmPt2Pt:16777216,LmPt2Line:33554432,LmLine2Line:67108864,LmHole2Hole:134217728,LmAxis2Pt:268435456,LmAxis2Line:536870912,WallThickness:1073741824},i.prototype.OperatorClear=function(e){},i.prototype.OperatorStart=function(e){this.measureType=e,this.snappedPoint=null,this.distanceInfo.snapPreSelInfo=null,this.OpMeasure.PostInfo()},i.prototype.OperatorEnd=function(){this.OpMeasure.PostInfo(),this.clearDistanceInfo(),this.clearHoleInfo(),this.clearEdgeInfo(),this.clearPerimetrBox(),this.clearFaceInfo(),this.clearLineAngleInfo(),this.ClearmeasureBodyVolumeAndAreaPre(),this.measureBoundingBox(!1),this.clearCoordinate(),this.clearContoursInfo()},i.prototype.preSelClear=function(){this.distanceInfo.preSelObj&&(this.OpMeasure.rootObject.remove(this.distanceInfo.preSelObj),this.distanceInfo.preSelObj=null,this.distanceInfo.preSelInfo=null)},i.prototype.onNMouseMove=function(e,t){},i.prototype.onLMouseClick=function(e,t,n){},i.prototype.renderMeasureScene=function(){this.update2DScene()},i.prototype.Bline=function(e){var t=e.geometry,e=e.indexRange.concat();if(e[1]==e[0])return!0;if(this.viewer.ndsModel&&(e[0]+=t.drawRange.start/2,e[1]+=t.drawRange.start/2),t.isBufferGeometry){var n=t.index,t=t.attributes.position.array;if(null!=n){var n=n.array,i=new THREE.Vector3,s=new THREE.Vector3,o=new THREE.Vector3,r=e[0],e=e[1],a=Math.round(.5*(r+e));if(i.fromArray(t,3*n[2*r]),s.fromArray(t,3*n[2*e+1]),s.distanceTo(i)<1e-7)return!1;o.fromArray(t,3*n[2*a]);r=i.clone().sub(o).normalize();return o.clone().sub(s).normalize().distanceTo(r)<2*Math.sin(2*Math.PI/180)}}},i.prototype.FindParentElement=function(e){if(null==e)return null;if(e instanceof THREE.Object3D||e instanceof NDSWebViewer.NdsBodyNode){var t=e.type.toLowerCase();if(this.viewer.isObjectTypeOfElement(e)){if("object"==t)for(var n=e.parent;null!=n;)"instanceobject"==n.type.toLowerCase()&&(e=n),n=n.parent;return e}}return this.FindParentElement(e.parent)},i.prototype.getFilterDistByBody=function(e){var t,n;return e?(e.boxDiagonalLength||(t=new THREE.Vector3,n=new THREE.Vector3,this.viewer.computeBoundingBox(e,t,n,{flag:!0}),e.boxDiagonalLength=n.distanceTo(t)),.015*e.boxDiagonalLength):.5},i.prototype.getSnappingPntEx=function(e){if(e){var t;if(this.viewer.hasBrepInfo()){var n=this.viewer.ndsModel?e.object:this.FindParentElement(e.object);if(!n)return;var i=n.uuid,s=this.viewer.brepManager.GetEdgesExtremePointsByBodyUUID(i);if(!s||s.length<=0)return;for(var o,i=this.getFilterDistByBody(n),r=i*i,a=e.point.clone(),n=this.viewer.modelCoordToClientCoord([a.x,a.y,a.z]),l=new THREE.Vector3(n[0],n[1],0),d=new THREE.Vector3,c=64,h=0;h<s.length;h++)a.distanceToSquared(s[h])<r&&(o=this.viewer.modelCoordToClientCoord([s[h].x,s[h].y,s[h].z]),d.set(o[0],o[1],0),(o=l.distanceToSquared(d))<c)&&(t=s[h],c=o)}else NDSWebViewer.SETTING.inBIMContext||(this.snappingTool.doSnapping(e),this.snappingTool.isSnapped()&&this.snappingTool.getSnappedType()==NDSWebViewer.SNAP_VERTEX&&(t=this.snappingTool.getSnappedVertex()));return t}},i.prototype.doRaycasterPick=function(e,t,n){var i=this.viewer,s=i.renderer.domElement,o=i.renderer.getPixelRatio(),e=e*o/s.width*2-1,t=2*-(t*o/s.height)+1,o=new THREE.Raycaster,s=(i.camera.setCastRay(o,e,t),n&&(o.linePrecision=this.getLinePrecision()),i.getNdsModelForMeasure());return s?n?s.intersect(o.ray,o.linePrecision):s.intersect(o.ray):n?o.intersectObjects(i.selectionManager.getTargetIncludeLineList()):o.intersectObjects(i.selectionManager.getTargetList())},i.prototype.getSelectInfoFromIntersect=function(e){if(e){var t=this.viewer.getNdsModelForMeasure(),n=t.brepManager||this.viewer.brepManager;if(this.viewer.hasBrepInfo()&&n.hasBrepInfo()){var i,s,o,r,a=t?e.object:this.FindParentElement(e.object);if(a)return a=a.uuid,s=e.object.uuid,t&&(0<=e.meshId?(e.mesh=t.meshManager.getSingleMesh(e.meshId),e.mesh&&(o=e.faceIndex-e.mesh.geometry.drawRange.start/3,i="face")):0<=e.lineSegId&&(e.mesh=t.meshManager.getLineSegments(e.lineSegId),e.mesh)&&(o=.5*(e.index-e.mesh.geometry.drawRange.start),i="edge"),s=e.geomUuid),0<=o&&(r=n.GetBrepInfoByUUidAndTopolIndex(a,s,o,i))&&(r.parentObj=e.mesh,r.geometry=e.mesh.geometry,r.matrixWorld=e.mesh.matrixWorld.clone(),r.intersect=e.point.clone(),r.bodyId=e.bodyId,r.bodyUuid=e.bodyUuid,r.meshId=e.meshId,r.topolIndex=o,r.topolType=i,r.lineSegId=e.lineSegId,"face"==i&&(r.edgeInfos=n.GetEdgeInfoFromFace(a,r.edgeIDS)),r.normal&&null==r.worldNormal&&(t=new THREE.Vector3,s=new THREE.Quaternion,o=new THREE.Vector3,r.parentObj.matrixWorld.decompose(t,s,o),r.worldNormal=new THREE.Vector3(r.normal[0],r.normal[1],r.normal[2]),r.worldNormal.applyQuaternion(s)),r.origin)&&null==r.worldOrigin&&(r.worldOrigin=new THREE.Vector3(r.origin[0],r.origin[1],r.origin[2]),r.worldOrigin.applyMatrix4(r.matrixWorld)),r}}},i.prototype.previewSnappedPoint=function(e,t,n){var i=!1,e=(null!=this.snappedPoint&&(i=!0),this.snappedPoint=null,this.doRaycasterPick(e,t,!0));e&&0<e.length&&(t=this.getSnappingPntEx(e[0]))&&(this.snappedPoint=t,i=!0),!this.snappedPoint&&e&&0<e.length&&(t=this.getSelectInfoFromIntersect(e[0]))&&"circle"==t.type&&n&&((e=new THREE.Vector3(t.center[0],t.center[1],t.center[2])).applyMatrix4(t.matrixWorld),this.snappedPoint=e,i=!0),i&&this.update2DScene()},i.prototype.previewSnappedPoint2=function(e,t){var n,i=!1;null!=this.snappedPoint&&(i=!0),this.snappedPoint=null,e&&0<e.length&&(n=this.getSnappingPntEx(e[0]))&&(this.snappedPoint=n,i=!0),!this.snappedPoint&&e&&0<e.length&&(n=this.getSelectInfoFromIntersect(e[0]))&&"circle"==n.type&&t&&((e=new THREE.Vector3(n.center[0],n.center[1],n.center[2])).applyMatrix4(n.matrixWorld),this.snappedPoint=e,i=!0),i&&this.update2DScene()},i.prototype.getSnappingPntIdxInPoints=function(e,t){let n=-1;if(e&&this.viewer.hasBrepInfo()){var i=this.viewer.ndsModel?e.object:this.FindParentElement(e.object);if(!i)return n;i.uuid;if(!t||t.length<=0)return n;for(var s,i=this.getFilterDistByBody(i),o=i*i,r=e.point.clone(),i=this.viewer.modelCoordToClientCoord([r.x,r.y,r.z]),a=new THREE.Vector3(i[0],i[1],0),l=new THREE.Vector3,d=64,c=0;c<t.length;c++)r.distanceToSquared(t[c])<o&&(s=this.viewer.modelCoordToClientCoord([t[c].x,t[c].y,t[c].z]),l.set(s[0],s[1],0),(s=a.distanceToSquared(l))<=d)&&(t[c],d=s,n=c)}return n},i.prototype.previewSnappedPoint3=function(t,n=!1,a=0,l=0){var i=!1;if(null!=this.snappedPoint&&(i=!0),this.snappedPoint=null,this.distanceInfo.snapPreSelInfo=null,this.distanceInfo.start=null,this.distanceInfo.mid=null,this.distanceInfo.end=null,this.distanceInfo.center=null,this.distanceInfo.snapPointType="",t&&0<t.length){let e=this.getSelectInfoFromIntersect(t[0]),o=[];n&&(s=this.getLineStartMidEndPoints(e))&&(this.distanceInfo.snapPreSelInfo=e,o=[s.start,s.mid,s.end],this.distanceInfo.start=s.start,this.distanceInfo.mid=s.mid,this.distanceInfo.end=s.end),e&&"circle"==e.type&&(this.distanceInfo.center=(new THREE.Vector3).fromArray(e.center).applyMatrix4(e.matrixWorld),this.distanceInfo.snapPreSelInfo=e);var s=o.length;let r=this.getCircleCenters(t[0]);if(r)for(let e=0,t=r.length;e<t;++e)o.push(r[e].point);else r=[];var d=this.getSnappingPntIdxInPoints(t[0],o);{let n=null,i=null,s=64;var c=this.distanceInfo.circleCenters;for(let e=0,t=c.length;e<t;++e){var h=this.viewer.modelCoordToClientCoord([c[e].Point.x,c[e].Point.y,c[e].Point.z]),h=Math.pow(h[0]-a,2)+Math.pow(h[1]-l,2);h<s&&(s=h,n=this.distanceInfo.intersects[e],i=c[e].Point.clone())}n&&(d=o.length,r.push(n),o.push(i))}if(0<=d)if(n&&(this.snappedPoint=o[d],i=!0),d<s)switch(d){case 0:this.distanceInfo.snapPointType="start";break;case 1:this.distanceInfo.snapPointType="mid";break;case 2:this.distanceInfo.snapPointType="end"}else this.distanceInfo.center=o[d],d-=s,e=this.getSelectInfoFromIntersect(r[d]),this.distanceInfo.snapPreSelInfo=e,this.distanceInfo.snapPointType="center",n||(t=[r[d]]),n&&(this.distanceInfo.start=null,this.distanceInfo.mid=null,this.distanceInfo.end=null)}if(this.distanceInfo.preSelIntersect){var s=(new Date).getTime();if(250<Math.abs(s-this.distanceInfo.preSelIntersect.createTime)){var o=this.distanceInfo.preSelIntersect.point.clone();for(let e=0;e<this.distanceInfo.circleCenters.length;++e)o.distanceTo(this.distanceInfo.circleCenters[e].Point)<1e-4&&(this.OpMeasure.rootObject.remove(this.distanceInfo.circleCenters[e]),this.distanceInfo.circleCenters.splice(e,1),this.distanceInfo.intersects.splice(e,1),--e);this.distanceInfo.circleCenters.length==this.distanceInfo.limitCircleCentersSize&&(this.OpMeasure.rootObject.remove(this.distanceInfo.circleCenters[0]),this.distanceInfo.circleCenters.shift(),this.distanceInfo.intersects.shift());d=this.createCrossHairMesh(o,this.POINTSIZE);this.OpMeasure.rootObject.add(d),this.distanceInfo.circleCenters.push(d),this.distanceInfo.intersects.push(this.distanceInfo.preSelIntersect),this.distanceInfo.preSelIntersect=null}}this.distanceInfo.center?(n=this.distanceInfo.preSelIntersect,s=t[0],n&&n.index===s.index&&n.lineSegId===s.lineSegId&&n.geomUuid===s.geomUuid&&n.point.distanceTo(this.distanceInfo.center)<1e-4||(this.distanceInfo.preSelIntersect=t[0],this.distanceInfo.preSelIntersect.point=this.distanceInfo.center.clone(),this.distanceInfo.preSelIntersect.createTime=(new Date).getTime())):this.distanceInfo.preSelIntersect=null;for(let e=0;e<this.distanceInfo.circleCenters.length;++e)this.distanceInfo.circleCenters[e].visible=!0,this.distanceInfo.center&&this.distanceInfo.center.distanceTo(this.distanceInfo.circleCenters[e].Point)<1e-4&&(this.distanceInfo.circleCenters[e].visible=!1);return i&&this.update2DScene(),t},i.prototype.get2dPoint=function(e){e.project(this.viewer.camera);var t=this.viewer.renderer.domElement.width/2,n=this.viewer.renderer.domElement.height/2,t=e.x*t+t,e=-e.y*n+n,n=this.viewer.renderer.getPixelRatio(),t=this.OpMeasure.remapCoordnidateToViewPort(t/n,e/n);return{x:Math.round(t[0]*n),y:Math.round(t[1]*n)}},i.prototype.addAnnotationTip=function(e,t,n){var i,s,o=this.viewer.renderer.getPixelRatio();t/=o,n/=o;var o=this.viewer.renderer.domElement.width*this.viewer.renderer.domElement.height/(o*o)/445440,o=1<=o?(i=13,s=35,14):((s=Math.round(35*o))<22&&(o=(s=22)/35),i=Math.round(13*o),Math.round(.35*s)),r=document.createElement("div");return r.className="perimeterLogo",r.style.width=2*i+"px",r.style.height=s+"px",r.style.top=n-s+"px",r.style.left=t-i+"px",r.style.fontSize=o+"px",r.style.paddingTop=Math.round(.3*(s-o))+"px",r.style.opacity=1,r.innerHTML=e.toString(),r.innerText=e.toString(),r},i.prototype.updateTip=function(e,t,n){var i,s,o=this.viewer.renderer.getPixelRatio();t/=o,n/=o;o=this.viewer.renderer.domElement.width*this.viewer.renderer.domElement.height/(o*o)/445440,o=1<=o?(i=13,s=35,14):((s=Math.round(35*o))<22&&(o=(s=22)/35),i=Math.round(13*o),Math.round(.35*s));e.style.width=2*i+"px",e.style.height=s+"px",e.style.top=n-s+"px",e.style.left=t-i+"px",e.style.fontSize=o+"px",e.style.paddingTop=Math.round(.3*(s-o))+"px",e.style.opacity=1},i.prototype.getAndShowTextBox=function(e,t,n){var i,s,o;n&&(e=this.get2dPoint(e),null!=n.screenX&&Math.abs(n.screenX-e.x)<=2&&null!=n.screenY&&Math.abs(n.screenY-e.y)<=2||(i=this.viewer.renderer.getPixelRatio(),s=n.clientWidth,o=n.clientHeight,n.screenX=e.x,n.screenY=e.y,"up"==n.getAttribute("mobile")?(n.style.left=Math.round(e.x/i-s/2)+"px",n.style.top=Math.round(e.y/i-o)+"px",null!=t&&(n.childNodes[0].data=t)):"right"==n.getAttribute("mobile")?(n.style.left=Math.round(e.x/i-s)+"px",n.style.top=Math.round(e.y/i-o/2)+"px",null!=t&&(n.childNodes[0].data=t)):"down"==n.getAttribute("mobile")?(n.style.left=Math.round(e.x/i-s/2)+"px",n.style.top=Math.round(e.y/i+0)+"px",null!=t&&(n.childNodes[0].data=t)):"left"==n.getAttribute("mobile")?(n.style.left=Math.round(e.x/i+0)+"px",n.style.top=Math.round(e.y/i-o/2)+"px",null!=t&&(n.childNodes[0].data=t)):(n.style.left=Math.round(e.x/i)+"px",n.style.top=Math.round(e.y/i)+"px",null!=t&&(n.innerHTML=t)),"true"==n.getAttribute("needDown")&&(n.style.top=Math.round(e.y/i)+20+"px")))},i.prototype.update2DScene=function(){var e,t=this.viewer.canvas2D.getContext("2d"),n=this.viewer.renderer.getPixelRatio();if(this.snappedPoint&&!this.distanceInfo.snapPreSelInfo&&(e=this.get2dPoint(this.snappedPoint.clone()),t.fillStyle="#00FFFF",t.beginPath(),t.arc(e.x,e.y,4,0,2*Math.PI),t.closePath(),t.fill()),this.distanceInfo.snapPreSelInfo&&(this.draw2dLineByLineInfo(this.distanceInfo.snapPreSelInfo,t),this.draw2dPoints(t)),"radius"!=this.measureType&&"diameter"!=this.measureType||!this.OpMeasure.rootObject.visible||this.holeInfo.textPos&&this.holeInfo.fstClndPos&&(i=this.get2dPoint(this.holeInfo.textPos.clone()),s=this.get2dPoint(this.holeInfo.fstClndPos.clone()),t.strokeStyle="#00FF00",t.lineWidth=n,t.beginPath(),t.moveTo(i.x,i.y),t.lineTo(s.x,s.y),t.stroke()),0<this.OpMeasure.textLines.length&&this.OpMeasure.rootObject.visible){this.viewer.is2DModel?t.strokeStyle="#00FF00":t.strokeStyle="#FF7D2C",t.lineWidth=n,t.beginPath();for(var i,s,o=0;o<this.OpMeasure.textLines.length;o++)0!=this.OpMeasure.textLines[o].visible&&(i=this.get2dPoint(this.OpMeasure.textLines[o].start.clone()),s=this.get2dPoint(this.OpMeasure.textLines[o].end.clone()),t.moveTo(i.x,i.y),t.lineTo(s.x,s.y));t.stroke()}},i.prototype.clearPreSelect=function(){this.holeInfo.preSelHoleObj&&this.OpMeasure.rootObject.remove(this.holeInfo.preSelHoleObj),this.distanceInfo.preSelObj&&this.OpMeasure.rootObject.remove(this.distanceInfo.preSelObj),this.lineContoursInfo.preSelLineObj&&this.OpMeasure.rootObject.remove(this.lineContoursInfo.preSelLineObj),this.edgeInfo.preSelLineObj&&this.OpMeasure.rootObject.remove(this.edgeInfo.preSelLineObj),this.lineAngleInfo.preSelLineObj&&this.OpMeasure.rootObject.remove(this.lineAngleInfo.preSelLineObj),this.faceInfo.preSelFaceObj&&this.OpMeasure.rootObject.remove(this.faceInfo.preSelFaceObj),this.ClearmeasureBodyVolumeAndAreaPre(),this.snappedPoint=null,this.distanceInfo.snapPreSelInfo=null,this.clearCoordinate()},i.prototype.clearHoleInfo=function(e){this.holeInfo.preSelHoleObj&&this.OpMeasure.rootObject.remove(this.holeInfo.preSelHoleObj),1!=e&&(this.holeInfo.firstSelHoleObj&&this.OpMeasure.rootObject.remove(this.holeInfo.firstSelHoleObj),this.holeInfo.secondSelHoleObj&&this.OpMeasure.rootObject.remove(this.holeInfo.secondSelHoleObj),this.holeInfo.textBox&&this.viewer.container.removeChild(this.holeInfo.textBox),this.holeInfo.fstToClndLine&&this.OpMeasure.rootObject.remove(this.holeInfo.fstToClndLine),this.holeInfo.sndToClndLine&&this.OpMeasure.rootObject.remove(this.holeInfo.sndToClndLine),this.holeInfo.clndToClndLine&&this.OpMeasure.rootObject.remove(this.holeInfo.clndToClndLine),this.holeInfo.centerToClndLine2&&this.OpMeasure.rootObject.remove(this.holeInfo.centerToClndLine2),this.holeInfo.centerToClndLine&&this.OpMeasure.rootObject.remove(this.holeInfo.centerToClndLine),this.holeInfo.boxToClndLine&&this.OpMeasure.rootObject.remove(this.holeInfo.boxToClndLine),this.holeInfo.fstClnd&&this.OpMeasure.rootObject.remove(this.holeInfo.fstClnd),this.holeInfo.sndClnd)&&this.OpMeasure.rootObject.remove(this.holeInfo.sndClnd),this.holeInfo.preSelHoleObj=null,this.holeInfo.preSelHoleInfo=null,this.holeInfo.firstSelHoleObj=null,this.holeInfo.firstHoleInfo=null,this.holeInfo.secondSelHoleObj=null,this.holeInfo.secondHoleInfo=null,this.holeInfo.fstToClndLine=null,this.holeInfo.sndToClndLine=null,this.holeInfo.clndToClndLine=null,this.holeInfo.boxToClndLine=null,this.holeInfo.centerToClndLine=null,this.holeInfo.centerToClndLine2=null,this.holeInfo.selLineCenterPos=null,this.holeInfo.fstClnd=null,this.holeInfo.sndClnd=null,this.holeInfo.fstClndPos=null,this.holeInfo.sndClndPos=null,this.holeInfo.textBox=null,this.holeInfo.textPos=null,this.holeInfo.dimString="",this.holeInfo.unit=""},i.prototype.clearPreInfo=function(){this.distanceInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.distanceInfo.preSelLineObj),this.distanceInfo.preSelLineObj=null,this.distanceInfo.preSelLineInfo=null),this.distanceInfo.preSelObj&&(this.OpMeasure.rootObject.remove(this.distanceInfo.preSelObj),this.distanceInfo.preSelObj=null,this.distanceInfo.preSelInfo=null),this.holeInfo.preSelHoleObj&&(this.OpMeasure.rootObject.remove(this.holeInfo.preSelHoleObj),this.holeInfo.preSelLineObj=null,this.holeInfo.preSelLineInfo=null),this.edgeInfo.preSelHoleObj&&(this.OpMeasure.rootObject.remove(this.edgeInfo.preSelHoleObj),this.edgeInfo.preSelLineObj=null,this.edgeInfo.preSelLineInfo=null),this.faceInfo.preSelFaceObj&&(this.OpMeasure.rootObject.remove(this.faceInfo.preSelFaceObj),this.faceInfo.preSelFaceObj=null,this.faceInfo.preSelFaceInfo=null),this.lineAngleInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.lineAngleInfo.preSelLineObj),this.lineAngleInfo.preSelLineObj=null,this.lineAngleInfo.preSelLineInfo=null),this.ClearmeasureBodyVolumeAndAreaPre(),this.lineContoursInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.lineContoursInfo.preSelLineObj),this.lineContoursInfo.preSelLineObj=null,this.lineContoursInfo.preSelLineInfo=null)},i.prototype.clearDistanceInfo=function(e){if(this.distanceInfo.preSelLineObj&&this.OpMeasure.rootObject.remove(this.distanceInfo.preSelLineObj),this.distanceInfo.preSelObj&&(this.OpMeasure.rootObject.remove(this.distanceInfo.preSelObj),this.distanceInfo.preSelInfo=null),1!=e){if(this.distanceInfo.firstSelObj&&this.OpMeasure.rootObject.remove(this.distanceInfo.firstSelObj),0<this.distanceInfo.circleCenters.length){for(let e=0,t=this.distanceInfo.circleCenters.length;e<t;++e)this.OpMeasure.rootObject.remove(this.distanceInfo.circleCenters[e]);this.distanceInfo.circleCenters=[]}this.distanceInfo.intersects=[],this.distanceInfo.secondSelObj&&this.OpMeasure.rootObject.remove(this.distanceInfo.secondSelObj),this.distanceInfo.axisLineObj&&this.OpMeasure.rootObject.remove(this.distanceInfo.axisLineObj),this.distanceInfo.secaxisLineObj&&this.OpMeasure.rootObject.remove(this.distanceInfo.secaxisLineObj),this.distanceInfo.fstToSndLine&&this.OpMeasure.rootObject.remove(this.distanceInfo.fstToSndLine),this.distanceInfo.FstToFstPointLine&&this.OpMeasure.rootObject.remove(this.distanceInfo.FstToFstPointLine),this.distanceInfo.SndToSndPointLine&&this.OpMeasure.rootObject.remove(this.distanceInfo.SndToSndPointLine),this.distanceInfo.textBox&&this.viewer.container.removeChild(this.distanceInfo.textBox),this.distanceInfo.fstToClndLine&&this.OpMeasure.rootObject.remove(this.distanceInfo.fstToClndLine),this.distanceInfo.sndToClndLine&&this.OpMeasure.rootObject.remove(this.distanceInfo.sndToClndLine),this.distanceInfo.clndToClndLine&&this.OpMeasure.rootObject.remove(this.distanceInfo.clndToClndLine),this.distanceInfo.boxToClndLine&&this.OpMeasure.rootObject.remove(this.distanceInfo.boxToClndLine),this.distanceInfo.fstClnd&&this.OpMeasure.rootObject.remove(this.distanceInfo.fstClnd),this.distanceInfo.sndClnd&&this.OpMeasure.rootObject.remove(this.distanceInfo.sndClnd),this.distanceInfo.projectPlaneObj&&this.OpMeasure.rootObject.remove(this.distanceInfo.projectPlaneObj),this.distanceInfo.projectFstClnd&&this.OpMeasure.rootObject.remove(this.distanceInfo.projectFstClnd),this.distanceInfo.projectSecClnd&&this.OpMeasure.rootObject.remove(this.distanceInfo.projectSecClnd),this.distanceInfo.projectPlaneInfo=null,this.distanceInfo.projectPlane=null}this.distanceInfo.preSelLineObj=null,this.distanceInfo.preSelLineInfo=null,this.distanceInfo.firstSelObj=null,this.distanceInfo.firstSelInfo=null,this.distanceInfo.secondSelObj=null,this.distanceInfo.axisLineObj=null,this.distanceInfo.secaxisLineObj=null,this.distanceInfo.secondSelInfo=null,this.distanceInfo.firstPoint=null,this.distanceInfo.secondPoint=null,this.distanceInfo.fstToSndLine=null,this.distanceInfo.FstToFstPointLine=null,this.distanceInfo.SndToSndPointLine=null,this.distanceInfo.fstToClndLine=null,this.distanceInfo.sndToClndLine=null,this.distanceInfo.clndToClndLine=null,this.distanceInfo.boxToClndLine=null,this.distanceInfo.fstClnd=null,this.distanceInfo.sndClnd=null,this.distanceInfo.fstClndPos=null,this.distanceInfo.sndClndPos=null,this.distanceInfo.dimStringPrefix="",this.distanceInfo.dimString="",this.distanceInfo.unit="",this.distanceInfo.textBox=null,this.distanceInfo.textPos=null,this.distanceInfo.mousePos=null,this.distanceInfo.XorY=0,this.distanceInfo.projectPlaneObj=null,this.distanceInfo.projectPlaneInfo=null,this.distanceInfo.projectPlane=null,this.distanceInfo.projectFstPos=null,this.distanceInfo.projectSecPos=null,this.distanceInfo.projectFstClnd=null,this.distanceInfo.projectSecClnd=null,this.lineargaugediv&&"none"!=this.lineargaugediv.style.display&&(this.lineargaugediv.style.display="none"),this.shadowdiv&&"none"!=this.shadowdiv.style.display&&(this.shadowdiv.style.display="none")},i.prototype.clearContoursInfo=function(e){if(this.lineContoursInfo.preSelLineObj&&this.OpMeasure.rootObject.remove(this.lineContoursInfo.preSelLineObj),1!=e)for(var t=0;t<this.lineContoursInfo.Contours.length;++t){var n=this.lineContoursInfo.Contours[t];this.OpMeasure.rootObject.remove(n.lineobj)}this.lineContoursInfo.Contours=[],this.lineContoursInfo.preSelLineInfo=null,this.lineContoursInfo.preSelLineObj=null,this.lineContoursInfo.prestart=new THREE.Vector2,this.lineContoursInfo.preend=new THREE.Vector2,this.lineContoursInfo.unit="",this.lineContoursInfo.divPos=null,this.lineContoursInfo.divBox=null,this.lineContoursInfo.perimeter=0,this.lineContoursInfo.start=new THREE.Vector2,this.lineContoursInfo.end=new THREE.Vector2,this.contourdiv&&1!=e&&(this.viewer.container.removeChild(this.contourdiv),this.contourdiv=null)},i.prototype.clearEdgeInfo=function(e){1!=e&&(this.edgeInfo.selLineObj&&this.OpMeasure.rootObject.remove(this.edgeInfo.selLineObj),this.edgeInfo.preSelLineObj&&this.OpMeasure.rootObject.remove(this.edgeInfo.preSelLineObj),this.edgeInfo.startToClndLine&&this.OpMeasure.rootObject.remove(this.edgeInfo.startToClndLine),this.edgeInfo.endToClndLine&&this.OpMeasure.rootObject.remove(this.edgeInfo.endToClndLine),this.edgeInfo.textBox&&this.OpMeasure.viewer.container.removeChild(this.edgeInfo.textBox),this.edgeInfo.clndToClndLine&&this.OpMeasure.rootObject.remove(this.edgeInfo.clndToClndLine),this.edgeInfo.boxToClndLine&&this.OpMeasure.rootObject.remove(this.edgeInfo.boxToClndLine),this.edgeInfo.centerToClndLine&&this.OpMeasure.rootObject.remove(this.edgeInfo.centerToClndLine),this.edgeInfo.boxToClndLine&&this.OpMeasure.rootObject.remove(this.edgeInfo.boxToClndLine),this.edgeInfo.fstClnd&&this.OpMeasure.rootObject.remove(this.edgeInfo.fstClnd),this.edgeInfo.sndClnd)&&this.OpMeasure.rootObject.remove(this.edgeInfo.sndClnd),this.edgeInfo.startPos=null,this.edgeInfo.endPos=null,this.edgeInfo.selLineInfo=null,this.edgeInfo.selLineObj=null,this.edgeInfo.preSelLineInfo=null,this.edgeInfo.preSelLineObj=null,this.edgeInfo.startToClndLine=null,this.edgeInfo.startToClndLine1=null,this.edgeInfo.endToClndLine=null,this.edgeInfo.endToClndLine1=null,this.edgeInfo.clndToClndLine=null,this.edgeInfo.clndToClndLine1=null,this.edgeInfo.lineType="",this.edgeInfo.clndToClndLine=null,this.edgeInfo.boxToClndLine=null,this.edgeInfo.centerToClndLine=null,this.edgeInfo.fstClnd=null,this.edgeInfo.sndClnd=null,this.edgeInfo.fstClnd1=null,this.edgeInfo.sndClnd1=null,this.edgeInfo.fstClndPos=null,this.edgeInfo.sndClndPos=null,this.edgeInfo.selLineCenterPos=null,this.edgeInfo.dimString="",this.edgeInfo.unit="",this.edgeInfo.textBox=null,this.edgeInfo.textPos=null},i.prototype.clearPerimetrBox=function(){for(var e=0,t=this.perimeterInfos.length;e<t;e++){var n=this.perimeterInfos[e];this.viewer.container.removeChild(n.textimg),n.textPos=null,n.textimg=null}this.perimeterInfos.splice(0,this.perimeterInfos.length)},i.prototype.measureBoundingBox=function(e){for(var t,n,i,s,o,r,a,l,d,c=0,h=this.OpMeasure.boundingboxInfos.length;c<h;c++){var f=this.OpMeasure.boundingboxInfos[c];this.viewer.container.removeChild(f.textBox),f.textPos=null,f.textBox=null}this.OpMeasure.boundingboxInfos.splice(0,this.OpMeasure.boundingboxInfos.length),e?(e=this.viewer.modelRootObject.boundingBox.clone(),this.OpMeasure.boundingboxmesh&&(this.OpMeasure.rootObject.remove(this.OpMeasure.boundingboxmesh),this.OpMeasure.boundingboxmesh=null),NDSWebViewer.SETTING.inBIMContext&&0<this.viewer.ndsModel.ModelUpMatrix4.length&&((l=new THREE.Matrix4).fromArray(this.viewer.ndsModel.ModelUpMatrix4),e.applyMatrix4(l)),this.OpMeasure.boundingboxmesh=this.createBoundingBox(e),this.distanceInfo.unit=this.getUnitString(),this.OpMeasure.rootObject.add(this.OpMeasure.boundingboxmesh),l=e.max.x-e.min.x,t=e.max.y-e.min.y,n=e.max.z-e.min.z,l*=(i=this.viewer.getDispalyModelUnit(l)).scale,t*=i.scale,n*=i.scale,i=this.getUnitStringmap(i.unit),l=l.toFixed(this.viewer.Decimal)+i,t=t.toFixed(this.viewer.Decimal)+i,n=n.toFixed(this.viewer.Decimal)+i,(i=document.createElement("div")).style.position="absolute",i.style.color="white",i.style.zIndex=3,i.style.backgroundColor="rgba(115,0,230,0.75)",i.style.userSelect="none",i.style.pointerEvents="none",this.viewer.container.appendChild(i),(s=document.createElement("div")).style.position="absolute",s.style.color="white",s.style.zIndex=3,s.style.backgroundColor="rgba(115,0,230,0.75)",s.style.userSelect="none",s.style.pointerEvents="none",this.viewer.container.appendChild(s),(o=document.createElement("div")).style.position="absolute",o.style.color="white",o.style.zIndex=3,o.style.backgroundColor="rgba(115,0,230,0.75)",o.style.userSelect="none",o.style.pointerEvents="none",this.viewer.container.appendChild(o),d=e.max.clone().sub(new THREE.Vector3((e.max.x-e.min.x)/2,0,0)),r=e.max.clone().sub(new THREE.Vector3(0,(e.max.y-e.min.y)/2,0)),e=e.max.clone().sub(new THREE.Vector3(0,0,(e.max.z-e.min.z)/2)),this.getAndShowTextBox(d.clone(),l,i),this.getAndShowTextBox(r.clone(),t,s),this.getAndShowTextBox(e.clone(),n,o),(a={}).dimString=l,a.textPos=d.clone(),a.textBox=i,this.OpMeasure.boundingboxInfos.push(a),(l={}).dimString=t,l.textPos=r.clone(),l.textBox=s,this.OpMeasure.boundingboxInfos.push(l),(d={}).dimString=n,d.textPos=e.clone(),d.textBox=o,this.OpMeasure.boundingboxInfos.push(d)):this.OpMeasure.boundingboxmesh&&(this.OpMeasure.rootObject.remove(this.OpMeasure.boundingboxmesh),this.OpMeasure.boundingboxmesh=null)},i.prototype.clearFaceInfo=function(e){if(this.faceInfo.preSelFaceObj&&this.OpMeasure.rootObject.remove(this.faceInfo.preSelFaceObj),this.faceInfo.fstSelFaceObj&&this.OpMeasure.rootObject.remove(this.faceInfo.fstSelFaceObj),this.faceInfo.sndSelFaceObj&&this.OpMeasure.rootObject.remove(this.faceInfo.sndSelFaceObj),1!=e){this.faceInfo.textBox&&this.viewer.container.removeChild(this.faceInfo.textBox),this.faceInfo.fstToMidLine&&this.OpMeasure.rootObject.remove(this.faceInfo.fstToMidLine),this.faceInfo.fstToClndLine&&this.OpMeasure.rootObject.remove(this.faceInfo.fstToClndLine),this.faceInfo.sndToClndLine&&this.OpMeasure.rootObject.remove(this.faceInfo.sndToClndLine),this.faceInfo.clndToClndLine&&this.OpMeasure.rootObject.remove(this.faceInfo.clndToClndLine),this.faceInfo.boxToClndLine&&this.OpMeasure.rootObject.remove(this.faceInfo.boxToClndLine),this.faceInfo.fstClnd&&this.OpMeasure.rootObject.remove(this.faceInfo.fstClnd),this.faceInfo.sndClnd&&this.OpMeasure.rootObject.remove(this.faceInfo.sndClnd);for(var t=0;t<this.faceInfo.arcMeshes.length;t++)this.OpMeasure.rootObject.remove(this.faceInfo.arcMeshes[t])}this.faceInfo.arcMeshes=[],this.faceInfo.fstIntersect=null,this.faceInfo.sndIntersect=null,this.faceInfo.firstFaceInfo=null,this.faceInfo.secondFaceInfo=null,this.faceInfo.preSelFaceInfo=null,this.faceInfo.preSelFaceObj=null,this.faceInfo.fstSelFaceObj=null,this.faceInfo.sndSelFaceObj=null,this.faceInfo.fstToMidLine=null,this.faceInfo.fstToClndLine=null,this.faceInfo.sndToClndLine=null,this.faceInfo.clndToClndLine=null,this.faceInfo.boxToClndLine=null,this.faceInfo.fstClnd=null,this.faceInfo.sndClnd=null,this.faceInfo.fstClndPos=null,this.faceInfo.sndClndPos=null,this.faceInfo.dimString="",this.faceInfo.unit="",this.faceInfo.textBox=null,this.faceInfo.textPos=null,this.faceInfo.arcCenter=null,this.faceInfo.midLineEndPt=null;for(var n=this.faceInfo.selFaceInfors.length=0,i=this.faceInfo.selFaceObjs.length;n<i;n++)this.OpMeasure.rootObject.remove(this.faceInfo.selFaceObjs[n]);this.faceInfo.selFaceObjs.length=0},i.prototype.clearLineAngleInfo=function(e){if(this.lineAngleInfo.preSelLineObj&&this.OpMeasure.rootObject.remove(this.lineAngleInfo.preSelLineObj),1!=e){this.lineAngleInfo.firstLineObj&&this.OpMeasure.rootObject.remove(this.lineAngleInfo.firstLineObj),this.lineAngleInfo.secondLineObj&&this.OpMeasure.rootObject.remove(this.lineAngleInfo.secondLineObj),this.lineAngleInfo.textBox&&this.viewer.container.removeChild(this.lineAngleInfo.textBox),this.lineAngleInfo.fstClnd&&this.OpMeasure.rootObject.remove(this.lineAngleInfo.fstClnd),this.lineAngleInfo.sndClnd&&this.OpMeasure.rootObject.remove(this.lineAngleInfo.sndClnd),this.lineAngleInfo.auxLine1&&this.OpMeasure.rootObject.remove(this.lineAngleInfo.auxLine1),this.lineAngleInfo.auxLine2&&this.OpMeasure.rootObject.remove(this.lineAngleInfo.auxLine2);for(var t=0;t<this.lineAngleInfo.arcMeshes.length;t++)this.OpMeasure.rootObject.remove(this.lineAngleInfo.arcMeshes[t]);this.lineAngleInfo.firstHelpPointobj&&this.OpMeasure.rootObject.remove(this.lineAngleInfo.firstHelpPointobj),this.lineAngleInfo.secHelpPointobj&&this.OpMeasure.rootObject.remove(this.lineAngleInfo.secHelpPointobj),this.lineAngleInfo.thrHelpPointobj&&this.OpMeasure.rootObject.remove(this.lineAngleInfo.thrHelpPointobj)}this.lineAngleInfo.preSelLineObj=null,this.lineAngleInfo.preSelLineInfo=null,this.lineAngleInfo.firstLineObj=null,this.lineAngleInfo.firstLineInfo=null,this.lineAngleInfo.secondLineObj=null,this.lineAngleInfo.secondLineInfo=null,this.lineAngleInfo.firstHelpPointobj=null,this.lineAngleInfo.firstHelpPointInfo=null,this.lineAngleInfo.thrHelpPointobj=null,this.lineAngleInfo.thrHelpPointInfo=null,this.lineAngleInfo.secHelpPointInfo=null,this.lineAngleInfo.secHelpPointobj=null,this.lineAngleInfo.fstClnd=null,this.lineAngleInfo.sndClnd=null,this.lineAngleInfo.fstClndPos=null,this.lineAngleInfo.sndClndPos=null,this.lineAngleInfo.auxLine1=null,this.lineAngleInfo.auxLine2=null,this.lineAngleInfo.arcCenter=null;for(t=0;t<this.lineAngleInfo.arcMeshes.length;t++)this.lineAngleInfo.arcMeshes[t]=null;this.lineAngleInfo.arcMeshes.length=0,this.lineAngleInfo.dimString="",this.lineAngleInfo.unit="",this.lineAngleInfo.textBox=null,this.lineAngleInfo.textPos=null,this.lineAngleInfo.twoPlane=!1},i.prototype.clearCoordinate=function(){this.coordinatediv&&(this.viewer.container.removeChild(this.coordinatediv),this.coordinatediv=null,this.coordinatedivtextPos=null,this.coordinatedivdims=null)},i.prototype.getSelectedFaceArea=function(){for(var e=0,t=0,n=this.faceInfo.selFaceInfors.length;t<n;t++)e+=parseFloat(this.faceInfo.selFaceInfors[t].area);return e},i.prototype.getFaceTriangles=function(n){var i=[];if(n&&n.parentObj instanceof THREE.Mesh){var e=n.geometry,s=n.indexRange.concat();if(this.viewer.ndsModel&&(s[0]+=e.drawRange.start/3,s[1]+=e.drawRange.start/3),e.isBufferGeometry){var o=e.index,r=e.attributes.position;for(let e=s[0],t=s[1];e<=t;e++,0){var a=3*e,l=o.getX(a),d=o.getX(1+a),a=o.getX(2+a),c=new THREE.Vector3,h=new THREE.Vector3,f=new THREE.Vector3,l=(c.fromBufferAttribute(r,l),h.fromBufferAttribute(r,d),f.fromBufferAttribute(r,a),c.applyMatrix4(n.matrixWorld),h.applyMatrix4(n.matrixWorld),f.applyMatrix4(n.matrixWorld),new THREE.Triangle(c,h,f));i.push(l)}}}return i},i.prototype.getLinesByLineInfo=function(n){var e=n.geometry,i=n.indexRange.concat(),s=(this.viewer.ndsModel&&(i[0]+=e.drawRange.start/2,i[1]+=e.drawRange.start/2),[]);if(e.isBufferGeometry){var t=e.index,o=e.attributes.position.array;if(null!=t){var r=t.array;for(let e=i[0],t=i[1];e<=t;++e){var a=r[2*e],l=r[2*e+1],d=new THREE.Vector3,c=new THREE.Vector3,a=(d.fromArray(o,3*a),c.fromArray(o,3*l),new THREE.Line3(d,c));a.applyMatrix4(n.matrixWorld),s.push(a)}}}return s},i.prototype.doCircleCentersRayPick=function(e,t){var n=this.viewer,i=n.renderer.domElement,s=n.renderer.getPixelRatio(),e=e*s/i.width*2-1,t=2*-(t*s/i.height)+1,o=new THREE.Raycaster,s=(n.camera.setCastRay(o,e,t),n.getNdsModelForMeasure());let r=s.activeModel;if(r&&r.sketchFileUrl&&(r=s.models[0]),!(s.activeModel=r))return null;for(var a=r.sptIndex.intersect(o.ray),l=[],d=0,d=0,j=a.length;d<j;++d){var F=a[d];r.meshSets[F].intersect(o.ray,l)}var B=r.getMeshManager(),c=[],h=new THREE.Vector3,f=new THREE.Vector3;if(this.viewer.hasBrepInfo()){for(let e=0,t=l.length;e<t;++e){var I=B.getBodyNode(l[e]);if(I){var u=I.uuid,p=this.viewer.brepManager.brepInfos,S=(this.viewer.camera.position.clone(),this.viewer.ndsModel.activeModel);if(2==this.viewer.brepManager.type){var g=p.bodies.get(u);if(void 0!==g){var E=p.breps[g].edgeGroups;for(let e=0,t=E.length;e<t;++e){var m=p.edgeGroups[E[e]],H=S.NeedsMergeBodyNode;if(S.NeedsMergeBodyNode=!1,N=this.viewer.ndsModel.meshManager.getBodyLineSegmentsFromGeomUUid(I,m.geomUUID)){S.NeedsMergeBodyNode=H;var O=N.geometry;let n=null;var W=this.viewer.ndsModel.meshManager.lineSegGeomUuid;if(I.leafBodyAttri)for(var b=0,P=I.leafBodyAttri.bodyLineSegIds.length;b<P;++b)if(W[w=I.leafBodyAttri.bodyLineSegIds[b]]==O.uuid){n=w;break}if(null===n)break;var k=N.matrixWorld;if(m.circles){var M=m.circles;for(let e=0,t=M.radiuses.length;e<t;++e){var Y=M.radiuses[e],T=new THREE.Vector3(M.centers[3*e],M.centers[3*e+1],M.centers[3*e+2]),x=(T.applyMatrix4(k),new THREE.Vector3),y=(o.ray.closestPointToPoint(T,x),this.viewer.modelCoordToClientCoord([x.x,x.y,x.z])),C=(h.set(y[0],y[1],0),this.viewer.modelCoordToClientCoord([T.x,T.y,T.z]));f.set(C[0],C[1],0),64<h.distanceToSquared(f)||(x=o.ray.origin.distanceTo(x),(R={}).distance=x,R.point=T.clone(),R.index=O.drawRange.start+2*M.indexRanges[2*e],R.face=null,R.faceIndex=-1,R.meshId=-1,R.lineSegId=n,R.geomId=this.viewer.ndsModel.meshManager.lineSegGeomId[n],R.geomUuid=O.uuid,R.bodyNode=I,R.bodyUuid=I.uuid,R.object=I,R.radius=Y,c.push(R))}}}}}}else{let n=p[u];if(void 0!==(n=n&&n.referenceBodyUuid?p[n.referenceBodyUuid]:n))for(let e=0,t=n.edgeGroups.length;e<t;++e){var U=n.edgeGroups[e],z=S.NeedsMergeBodyNode,_=this.viewer.ndsModel.meshUuid2GeomUuidMap[U.meshID],N=(S.NeedsMergeBodyNode=!1,this.viewer.ndsModel.meshManager.getBodyLineSegmentsFromGeomUUid(I,_));if(N&&(S.NeedsMergeBodyNode=z,N)){var L=N.geometry;let n=null;var G=this.viewer.ndsModel.meshManager.lineSegGeomUuid;if(I.leafBodyAttri)for(var w,b=0,P=I.leafBodyAttri.bodyLineSegIds.length;b<P;++b)if(G[w=I.leafBodyAttri.bodyLineSegIds[b]]==L.uuid){n=w;break}if(null===n)break;var X=N.matrixWorld,A=U.edges;if(A)for(let e=0,t=A.length;e<t;++e){var Z,v,D,R,V=A[e];"circle"!=V.type||(Z=V.radius,(v=new THREE.Vector3(V.center[0],V.center[1],V.center[2])).applyMatrix4(X),D=new THREE.Vector3,o.ray.closestPointToPoint(v,D),y=this.viewer.modelCoordToClientCoord([D.x,D.y,D.z]),h.set(y[0],y[1],0),C=this.viewer.modelCoordToClientCoord([v.x,v.y,v.z]),f.set(C[0],C[1],0),64<h.distanceToSquared(f))||(D=o.ray.origin.distanceTo(D),(R={}).distance=D,R.point=v.clone(),R.index=L.drawRange.start+2*V.indexRange[0],R.face=null,R.faceIndex=-1,R.meshId=-1,R.lineSegId=n,R.geomId=this.viewer.ndsModel.meshManager.lineSegGeomId[n],R.geomUuid=L.uuid,R.bodyNode=I,R.bodyUuid=I.uuid,R.object=I,R.radius=Z,c.push(R))}}}}}}0<c.length&&c.sort((e,t)=>e.distance==t.distance?t.radius-e.radius:e.distance-t.distance)}return 0==c.length?null:c},i.prototype.getCircleCenters=function(e){if(!e)return null;var i=[];if(this.viewer.hasBrepInfo()){var s=this.viewer.ndsModel?e.object:this.FindParentElement(e.object);if(!s)return null;var e=s.uuid,o=this.viewer.brepManager.brepInfos,r=this.viewer.camera.position.clone(),a=this.viewer.ndsModel.activeModel;if(2==this.viewer.brepManager.type){var t=o.bodies.get(e);if(void 0!==t){var l=o.breps[t].edgeGroups;for(let e=0,t=l.length;e<t;++e){var d=o.edgeGroups[l[e]],c=a.NeedsMergeBodyNode,h=(a.NeedsMergeBodyNode=!1,this.viewer.ndsModel.meshManager.getBodyLineSegmentsFromGeomUUid(s,d.geomUUID)),f=(a.NeedsMergeBodyNode=c,h.geometry);let n=null;var I=this.viewer.ndsModel.meshManager.lineSegGeomUuid;if(s.leafBodyAttri)for(var u=0,p=s.leafBodyAttri.bodyLineSegIds.length;u<p;++u)if(I[y=s.leafBodyAttri.bodyLineSegIds[u]]==f.uuid){n=y;break}if(null===n)break;var S=h.matrixWorld;if(d.circles){var g=d.circles;for(let e=0,t=g.radiuses.length;e<t;++e){var E=g.radiuses[e],m=new THREE.Vector3(g.centers[3*e],g.centers[3*e+1],g.centers[3*e+2]),O=(m.applyMatrix4(S),m.distanceTo(r));(A={}).distance=O,A.point=m.clone(),A.index=f.drawRange.start+2*g.indexRanges[2*e],A.face=null,A.faceIndex=-1,A.meshId=-1,A.lineSegId=n,A.geomId=this.viewer.ndsModel.meshManager.lineSegGeomId[n],A.geomUuid=f.uuid,A.bodyNode=s,A.bodyUuid=s.uuid,A.object=s,A.radius=E,i.push(A)}}}}}else{let n=o[e];if(void 0!==(n=n&&n.referenceBodyUuid?o[n.referenceBodyUuid]:n))for(let e=0,t=n.edgeGroups.length;e<t;++e){var b=n.edgeGroups[e],P=a.NeedsMergeBodyNode,M=this.viewer.ndsModel.meshUuid2GeomUuidMap[b.meshID],h=(a.NeedsMergeBodyNode=!1,this.viewer.ndsModel.meshManager.getBodyLineSegmentsFromGeomUUid(s,M));if(a.NeedsMergeBodyNode=P,h){var T=h.geometry;let n=null;var x=this.viewer.ndsModel.meshManager.lineSegGeomUuid;if(s.leafBodyAttri)for(var y,u=0,p=s.leafBodyAttri.bodyLineSegIds.length;u<p;++u)if(x[y=s.leafBodyAttri.bodyLineSegIds[u]]==T.uuid){n=y;break}if(null===n)break;var C=h.matrixWorld,N=b.edges;if(N)for(let e=0,t=N.length;e<t;++e){var L,w,A,v=N[e];"circle"==v.type&&(L=v.radius,(w=new THREE.Vector3(v.center[0],v.center[1],v.center[2])).applyMatrix4(C),O=w.distanceTo(r),(A={}).distance=O,A.point=w.clone(),A.index=T.drawRange.start+2*v.indexRange[0],A.face=null,A.faceIndex=-1,A.meshId=-1,A.lineSegId=n,A.geomId=this.viewer.ndsModel.meshManager.lineSegGeomId[n],A.geomUuid=T.uuid,A.bodyNode=s,A.bodyUuid=s.uuid,A.object=s,A.radius=L,i.push(A))}}}}0<i.length&&i.sort((e,t)=>e.distance==t.distance?t.radius-e.radius:e.distance-t.distance)}return 0==i.length?null:i},i.prototype.getLineStartMidEndPoints=function(t){if(t&&t.parentObj instanceof THREE.Line){var n=new THREE.Vector3,i=new THREE.Vector3;let e=new THREE.Vector3;new THREE.Vector3;var s=t.geometry,o=t.indexRange.concat();if(o[1]-o[0]>s.drawRange.count)this.OpMeasure.InfoType!=NDS.INFOTYPE.BREPDATAERROR&&0!=this.OpMeasure.InfoType&&(this.InfoType=this.OpMeasure.InfoType),this.OpMeasure.PostInfo(NDS.INFOTYPE.BREPDATAERROR);else if(this.viewer.ndsModel&&(o[0]+=s.drawRange.start/2,o[1]+=s.drawRange.start/2),s.isBufferGeometry){var r=o[1]-o[0]+1,a=s.index,l=s.attributes.position.array,d=new Float32Array(6*r);if(null!=a){var c=a.array,h=0,s=o[0],f=o[1];Math.round(.5*(s+f));if(n.fromArray(l,3*c[2*s]),i.fromArray(l,3*c[2*f+1]),!n.equals(i)){for(var I=0,u=s,p=f;u<=p;u++,h+=1){var S=c[2*u],g=c[2*u+1],E=new THREE.Vector3,m=new THREE.Vector3;E.fromArray(l,3*S),m.fromArray(l,3*g),d[6*h]=E.x,d[6*h+1]=E.y,d[6*h+2]=E.z,d[6*h+3]=m.x,d[6*h+4]=m.y,d[6*h+5]=m.z,I+=E.clone().distanceTo(m),m=E=null}for(var O=0,u=s;u<=f;u++){var S=c[2*u],g=c[2*u+1],E=new THREE.Vector3,m=new THREE.Vector3,b=(E.fromArray(l,3*S),m.fromArray(l,3*g),O);if(.5*I<(O+=E.clone().distanceTo(m))){var b=.5*I-b,P=m.clone().sub(E);P.normalize(),e=E.clone().addScaledVector(P,b);break}}return n.applyMatrix4(t.matrixWorld),i.applyMatrix4(t.matrixWorld),e.applyMatrix4(t.matrixWorld),{start:n,mid:e,end:i}}}}}},i.prototype.draw2dLineByLineInfo=function(n,t){if(n&&n.parentObj instanceof THREE.Line){var e=n.geometry,i=n.indexRange.concat(),s=(this.viewer.ndsModel&&(i[0]+=e.drawRange.start/2,i[1]+=e.drawRange.start/2),[]);if(e.isBufferGeometry){var o=e.index,r=e.attributes.position.array;if(null!=o){var a=o.array,l=i[0];for(let e=l,t=i[1];e<=t;++e){e==l&&(d=a[2*e],(c=new THREE.Vector3).fromArray(r,3*d).applyMatrix4(n.matrixWorld),s.push(this.get2dPoint(c)));var d=a[2*e+1],c=new THREE.Vector3;c.fromArray(r,3*d).applyMatrix4(n.matrixWorld),s.push(this.get2dPoint(c))}}}var h=s.length;if(0<h){t.strokeStyle="#00FFFF",t.beginPath(),t.moveTo(s[0].x,s[0].y);for(let e=1;e<h;e++)t.lineTo(s[e].x,s[e].y);t.stroke()}}},i.prototype.draw2dPoints=function(e){var t,n,i,s=e.lineWidth;this.distanceInfo.mid&&(t=this.get2dPoint(this.distanceInfo.mid.clone()),e.strokeStyle="mid"==this.distanceInfo.snapPointType?"#00FFFF":"#1780E3",e.lineWidth=2,n=Math.sqrt(3)/2*7,e.beginPath(),e.moveTo(t.x,t.y-n/2),e.lineTo(t.x-3.5,t.y+n/2),e.lineTo(t.x+3.5,t.y+n/2),e.closePath(),e.stroke()),this.distanceInfo.start&&(i=this.get2dPoint(this.distanceInfo.start.clone()),e.strokeStyle="start"==this.distanceInfo.snapPointType?"#00FFFF":"#1780E3",e.lineWidth=2,e.beginPath(),e.moveTo(i.x-4,i.y-4),e.lineTo(i.x+4,i.y-4),e.lineTo(i.x+4,i.y+4),e.lineTo(i.x-4,i.y+4),e.closePath(),e.stroke()),this.distanceInfo.end&&(i=this.get2dPoint(this.distanceInfo.end.clone()),e.strokeStyle="end"==this.distanceInfo.snapPointType?"#00FFFF":"#1780E3",e.lineWidth=2,e.beginPath(),e.moveTo(i.x-4,i.y-4),e.lineTo(i.x+4,i.y-4),e.lineTo(i.x+4,i.y+4),e.lineTo(i.x-4,i.y+4),e.closePath(),e.stroke()),this.distanceInfo.center&&(i=this.get2dPoint(this.distanceInfo.center.clone()),e.fillStyle="center"==this.distanceInfo.snapPointType?"#00FFFF":"#1780E3",e.strokeStyle=e.fillStyle,e.lineWidth=2,e.beginPath(),e.arc(i.x,i.y,2,0,2*Math.PI),e.closePath(),e.fill(),e.beginPath(),e.arc(i.x,i.y,5,0,2*Math.PI),e.closePath(),e.stroke()),e.lineWidth=s},i.prototype.getLineStartEndPoints=function(e){if(("cylinder"==e.type||"cone"==e.type)&&e.origin&&e.axis){var t=e.geometry,n=e.indexRange.concat();if(this.viewer.ndsModel&&(n[0]+=t.drawRange.start/3,n[1]+=t.drawRange.start/3),t.isBufferGeometry){var i=t.index,s=t.attributes.position,o=new THREE.Vector3,r=new THREE.Vector3,a=(o.fromArray(e.origin),r.fromArray(e.axis),new THREE.Quaternion),l=new THREE.Vector3,d=new THREE.Vector3,c=(e.matrixWorld.decompose(l,a,d),r.applyQuaternion(a),r.normalize(),-1/0),h=1/0;o.applyMatrix4(e.matrixWorld);for(var f=n[0],I=n[1];f<=I;f++){var u=3*f,p=i.getX(u),S=i.getX(1+u),u=i.getX(2+u),g=new THREE.Vector3,E=new THREE.Vector3,m=new THREE.Vector3,p=(g.fromBufferAttribute(s,p),E.fromBufferAttribute(s,S),m.fromBufferAttribute(s,u),g.applyMatrix4(e.matrixWorld),E.applyMatrix4(e.matrixWorld),m.applyMatrix4(e.matrixWorld),g.clone().sub(o).dot(r));c<p&&(c=p),p<h&&(h=p),(p=E.clone().sub(o).dot(r))<h&&(h=p),(c=c<p?p:c)<(p=m.clone().sub(o).dot(r))&&(c=p),p<h&&(h=p),m=E=g=null}return 0==Math.abs(c-h)?null:(P=o.clone().add(r.clone().multiplyScalar(c)),{start:o.clone().add(r.clone().multiplyScalar(h)),end:P})}}if("circle"==e.type&&e.center){t=e.geometry,n=e.indexRange.concat();if(this.viewer.ndsModel&&(n[0]+=t.drawRange.start/2,n[1]+=t.drawRange.start/2),t.isBufferGeometry){var i=t.index,O=t.attributes.position.array;if(null!=i)return b=i.array,o=new THREE.Vector3,P=new THREE.Vector3,o.fromArray(O,3*b[2*n[0]]),P.fromArray(O,3*b[2*n[0]+1]),this.viewer.is2DModel&&o.z==P.z&&(e.center[2]=o.z),g=(l=new THREE.Vector3(e.center[0],e.center[1],e.center[2])).clone().sub(o).normalize(),E=P.clone().sub(o).normalize(),o.applyMatrix4(e.matrixWorld),P.applyMatrix4(e.matrixWorld),l.applyMatrix4(e.matrixWorld),o.sub(l),P.sub(l),(r=o.clone().cross(P)).normalize(),o.set(e.center[0],e.center[1],e.center[2]),o.applyMatrix4(e.matrixWorld),P=o.clone().add(r),{start:o,end:P}}}t=e.geometry,n=e.indexRange.concat();if(this.viewer.ndsModel&&(n[0]+=t.drawRange.start/2,n[1]+=t.drawRange.start/2),t.isBufferGeometry){var b,P,i=t.index,O=t.attributes.position.array;if(null!=i)return b=i.array,o=new THREE.Vector3,P=new THREE.Vector3,o.fromArray(O,3*b[2*n[0]]),P.fromArray(O,3*b[2*n[1]+1]),o.applyMatrix4(e.matrixWorld),P.applyMatrix4(e.matrixWorld),{start:o,end:P}}return null},i.prototype.ClearmeasureBodyVolumeAndAreaPre=function(){this.preSelectBody&&(this.preSelectBodyMat?this.preSelectBody.setUserMaterial(this.preSelectBodyMat):this.preSelectBody.setUserMaterial(null)),this.preSelectBody=null,this.preSelectBodyMat=null},i.prototype.createFace=function(e,t){if(e&&e.parentObj instanceof THREE.Mesh){var n,i=e.geometry,s=e.indexRange.concat();if(this.viewer.ndsModel&&(s[0]+=i.drawRange.start/3,s[1]+=i.drawRange.start/3),i.isBufferGeometry){for(var o=i.index,r=i.attributes.position,i=s[1]-s[0]+1,a=new Float32Array(9*i),l=0,d=new THREE.Vector3,c=s[0],h=s[1];c<=h;c++,l+=1){var f=3*c,I=o.getX(f),u=o.getX(1+f),f=o.getX(2+f),p=new THREE.Vector3,S=new THREE.Vector3,g=new THREE.Vector3,I=(p.fromBufferAttribute(r,I),S.fromBufferAttribute(r,u),g.fromBufferAttribute(r,f),(new THREE.Vector3).subVectors(S,p)),u=(new THREE.Vector3).subVectors(g,p);I.cross(u).normalize(),d.add(I),a[9*l]=p.x,a[9*l+1]=p.y,a[9*l+2]=p.z,a[9*l+3]=S.x,a[9*l+4]=S.y,a[9*l+5]=S.z,a[9*l+6]=g.x,a[9*l+7]=g.y,a[9*l+8]=g.z,g=S=p=null}i=new THREE.BufferGeometry,s=(i.addAttribute("position",new THREE.BufferAttribute(a,3)),(n=new THREE.Mesh(i,0==t?NDSWebViewer.SETTING.selectedFaceMaterial:NDSWebViewer.SETTING.preSelectedFaceMaterial)).objectType="Face",n.FaceInfo=[],this.viewer.getNdsModelForMeasure()),i=s.geomManager.uuidToIdMap[e.geometry.uuid][0],s=(n.FaceInfo.push(s.bodyUuid2NodeMap[e.bodyUuid].id),n.FaceInfo.push(i),n.FaceInfo.push(e.topolIndex),n.FaceInfo.push(e.meshId),t?1:0);n.FaceInfo.push(s),n.applyMatrix(e.matrixWorld),n.matrixWorldNeedsUpdate=!0,d.normalize(),e.averagenormal=d}return n}},i.prototype.createAxisLine=function(e){if(e&&e.parentObj instanceof THREE.Mesh){var t=e.geometry,n=e.indexRange.concat();if(this.viewer.ndsModel&&(n[0]+=t.drawRange.start/3,n[1]+=t.drawRange.start/3),t.isBufferGeometry){var i=t.index,s=t.attributes.position,o=new THREE.Vector3,r=new THREE.Vector3,t=(o.fromArray(e.origin),r.fromArray(e.axis),new THREE.Quaternion),a=new THREE.Vector3,l=new THREE.Vector3,d=(e.matrixWorld.decompose(a,t,l),r.applyQuaternion(t),r.normalize(),-1/0),c=1/0;o.applyMatrix4(e.matrixWorld);for(var h=n[0],f=n[1];h<=f;h++){var I=3*h,u=i.getX(I),p=i.getX(1+I),I=i.getX(2+I),S=new THREE.Vector3,g=new THREE.Vector3,E=new THREE.Vector3,u=(S.fromBufferAttribute(s,u),g.fromBufferAttribute(s,p),E.fromBufferAttribute(s,I),S.applyMatrix4(e.matrixWorld),g.applyMatrix4(e.matrixWorld),E.applyMatrix4(e.matrixWorld),S.clone().sub(o).dot(r));d<u&&(d=u),u<c&&(c=u),(u=g.clone().sub(o).dot(r))<c&&(c=u),(d=d<u?u:d)<(u=E.clone().sub(o).dot(r))&&(d=u),u<c&&(c=u),E=g=S=null}var m=Math.abs(d-c);if(0==m)return null;for(var O=o.clone().add(r.clone().multiplyScalar(d)),b=o.clone().add(r.clone().multiplyScalar(c)),P=(r.subVectors(O,b).normalize(),Math.ceil(Math.abs(m/6))),M=new Float32Array(6*P),T=0;T<P;++T){var x=new THREE.Vector3,y=new THREE.Vector3,x=b.clone().add(r.clone().multiplyScalar(6*T));6*T+4<Math.abs(m)?y=x.clone().add(r.clone().multiplyScalar(4)):y.set(O.x,O.y,O.z),M[6*T]=x.x,M[6*T+1]=x.y,M[6*T+2]=x.z,M[6*T+3]=y.x,M[6*T+4]=y.y,M[6*T+5]=y.z}a=new THREE.BufferGeometry;a.addAttribute("position",new THREE.BufferAttribute(M,3)),(l=new THREE.LineSegments(a,this.axisLine)).objectType="AxisLine",l.Start=b,l.End=O,l.matrixWorldNeedsUpdate=!0}return l}},i.prototype.createLine=function(e,t,n){if(e&&e.parentObj instanceof THREE.Line){var i=e.geometry,s=e.indexRange.concat();if(!(s[1]-s[0]>i.drawRange.count)){if(this.viewer.ndsModel&&(s[0]+=i.drawRange.start/2,s[1]+=i.drawRange.start/2),i.isBufferGeometry){var o=s[1]-s[0]+1,r=i.index,a=i.attributes.position.array,l=new Float32Array(6*o);if(null!=r){for(var d=r.array,c=0,i=(this.edgeInfo.startPos=new THREE.Vector3,this.edgeInfo.endPos=new THREE.Vector3,this.edgeInfo.midPos=new THREE.Vector3,s[0]),h=s[1],f=(Math.round(.5*(i+h)),this.edgeInfo.thirdPos=null,this.edgeInfo.startPos.fromArray(a,3*d[2*i]),this.edgeInfo.endPos.fromArray(a,3*d[2*h+1]),this.edgeInfo.endPos.distanceTo(this.edgeInfo.startPos)<1e-7&&(this.edgeInfo.thirdPos=new THREE.Vector3,this.edgeInfo.thirdPos.fromArray(a,3*d[2*(h-1)])),0),I=i,u=h;I<=u;I++,c+=1){var p=d[2*I],S=d[2*I+1],g=new THREE.Vector3,E=new THREE.Vector3;g.fromArray(a,3*p),E.fromArray(a,3*S),l[6*c]=g.x,l[6*c+1]=g.y,l[6*c+2]=g.z,l[6*c+3]=E.x,l[6*c+4]=E.y,l[6*c+5]=E.z,f+=g.clone().distanceTo(E),E=g=null}for(var m=0,I=i;I<=h;I++){var p=d[2*I],S=d[2*I+1],g=new THREE.Vector3,E=new THREE.Vector3,O=(g.fromArray(a,3*p),E.fromArray(a,3*S),m);if(.5*f<(m+=g.clone().distanceTo(E))){var O=.5*f-O,b=E.clone().sub(g);b.normalize(),this.edgeInfo.midPos=g.clone().addScaledVector(b,O);break}}n=n||(0==t?NDSWebViewer.SETTING.SelectedEdgeMaterial1:NDSWebViewer.SETTING.preSelectedEdgeMaterial);var P,o=new NDSWebViewer.LineSegmentsGeometry,r=(o.setPositions(l),new NDSWebViewer.LineMaterial({linewidth:n.linewidth,opacity:n.opacity,color:n.color,depthTest:n.depthTest,depthWrite:n.depthWrite,side:THREE.DoubleSide})),s=this.viewer.renderer.getPixelRatio(),i=this.viewer.renderer.domElement.width/s,n=this.viewer.renderer.domElement.height/s,s=(r.resolution.set(i,n),this.viewer.getNdsModelForMeasure()),i=((P=new NDSWebViewer.LineSegments2(o,r)).objectType="SelLine",P.LineInfo=[],P.LineInfo.push(s.bodyUuid2NodeMap[e.bodyUuid].id),s.geomManager.uuidToIdMap[e.geometry.uuid][0]),n=(P.LineInfo.push(i),P.LineInfo.push(e.topolIndex),P.LineInfo.push(e.lineSegId),t?1:0);P.LineInfo.push(n),P.applyMatrix(e.matrixWorld),P.matrixWorldNeedsUpdate=!0,this.edgeInfo.startPos.applyMatrix4(e.matrixWorld),this.edgeInfo.endPos.applyMatrix4(e.matrixWorld),this.edgeInfo.midPos.applyMatrix4(e.matrixWorld),this.edgeInfo.thirdPos&&this.edgeInfo.thirdPos.applyMatrix4(e.matrixWorld)}}return P}this.OpMeasure.InfoType!=NDS.INFOTYPE.BREPDATAERROR&&0!=this.OpMeasure.InfoType&&(this.InfoType=this.OpMeasure.InfoType),this.OpMeasure.PostInfo(NDS.INFOTYPE.BREPDATAERROR)}},i.prototype.createEllipse=function(e,t,n){if(e&&e.parentObj instanceof THREE.Line){var i,s=new THREE.Group,o=e.geometry,r=e.indexRange.concat(),a=(r[0]+=o.drawRange.start/2,r[1]+=o.drawRange.start/2,new THREE.Vector3),l=new THREE.Quaternion,d=new THREE.Vector3,a=(e.matrixWorld.decompose(a,l,d),Math.PI*(3*(e.radiusX+e.radiusY)-Math.sqrt((3*e.radiusX+e.radiusY)*(e.radiusX+3*e.radiusY))));if(o.isBufferGeometry){var l=r[1]-r[0]+1,c=o.index,h=o.attributes.position.array,f=new Float32Array(6*l);if(null!=c){for(var I=c.array,u=0,o=(this.edgeInfo.startPos=new THREE.Vector3,this.edgeInfo.endPos=new THREE.Vector3,this.edgeInfo.midPos=new THREE.Vector3,r[0]),p=r[1],S=(Math.round(.5*(o+p)),this.edgeInfo.thirdPos=null,this.edgeInfo.startPos.fromArray(h,3*I[2*o]),this.edgeInfo.endPos.fromArray(h,3*I[2*p+1]),this.edgeInfo.endPos.distanceTo(this.edgeInfo.startPos)<1e-7&&(this.edgeInfo.thirdPos=new THREE.Vector3,this.edgeInfo.thirdPos.fromArray(h,3*I[2*(p-1)])),0),g=o,E=p;g<=E;g++,u+=1){var m=I[2*g],O=I[2*g+1],b=new THREE.Vector3,P=new THREE.Vector3;b.fromArray(h,3*m),P.fromArray(h,3*O),f[6*u]=b.x,f[6*u+1]=b.y,f[6*u+2]=b.z,f[6*u+3]=P.x,f[6*u+4]=P.y,f[6*u+5]=P.z,S+=b.clone().distanceTo(P),P=b=null}for(var M=0,g=o;g<=p;g++){var m=I[2*g],O=I[2*g+1],b=new THREE.Vector3,P=new THREE.Vector3,T=(b.fromArray(h,3*m),P.fromArray(h,3*O),M);if(.5*S<(M+=b.clone().distanceTo(P))){var T=.5*S-T,x=P.clone().sub(b);x.normalize(),this.edgeInfo.midPos=b.clone().addScaledVector(x,T);break}}N=(new THREE.Plane).setFromCoplanarPoints(this.edgeInfo.startPos,this.edgeInfo.thirdPos||this.edgeInfo.endPos,this.edgeInfo.midPos),n=n||(0==t?NDSWebViewer.SETTING.SelectedEdgeMaterial1:NDSWebViewer.SETTING.preSelectedEdgeMaterial);var l=new NDSWebViewer.LineSegmentsGeometry,c=(l.setPositions(f),new NDSWebViewer.LineMaterialOrigin({linewidth:n.linewidth,opacity:n.opacity,color:n.color,depthTest:n.depthTest,depthWrite:n.depthWrite,side:THREE.DoubleSide})),r=this.viewer.renderer.getPixelRatio(),o=this.viewer.renderer.domElement.width/r,r=this.viewer.renderer.domElement.height/r,y=(c.resolution.set(o,r),(i=new NDSWebViewer.LineSegments2(l,c)).objectType="EllipseCurve",i.computeLineDistances(),i.LineInfo=[],i.LineInfo.push(this.viewer.ndsModel.bodyUuid2NodeMap[e.bodyUuid].id),this.viewer.ndsModel.geomManager.uuidToIdMap[e.geometry.uuid][0]),C=(i.LineInfo.push(y),i.LineInfo.push(e.topolIndex),i.LineInfo.push(e.lineSegId),t?1:0);i.LineInfo.push(C),this.edgeInfo.startPos.applyMatrix4(e.matrixWorld),this.edgeInfo.endPos.applyMatrix4(e.matrixWorld),this.edgeInfo.midPos.applyMatrix4(e.matrixWorld),this.edgeInfo.thirdPos&&this.edgeInfo.thirdPos.applyMatrix4(e.matrixWorld),i.applyMatrix(e.matrixWorld),i.matrixWorldNeedsUpdate=!0}}if(!t){var o=new Float32Array(6),r=new Float32Array(6),l=new THREE.Vector3(e.center[0],e.center[1],e.center[2]),l=N.projectPoint(l),c=new THREE.Vector3(e.axisX[0],e.axisX[1],e.axisX[2]).normalize(),N=new THREE.Vector3(e.normal[0],e.normal[1],e.normal[2]).cross(c).normalize(),L=l.clone().addScaledVector(c,e.radiusX/d.x),c=l.clone().addScaledVector(c,-e.radiusX/d.x),L=(o[0]=L.x,o[1]=L.y,o[2]=L.z,o[3]=c.x,o[4]=c.y,o[5]=c.z,l.clone().addScaledVector(N,e.radiusY/d.y)),c=l.clone().addScaledVector(N,-e.radiusY/d.y),l=(r[0]=L.x,r[1]=L.y,r[2]=L.z,r[3]=c.x,r[4]=c.y,r[5]=c.z,n=n||(0==t?NDSWebViewer.SETTING.SelectedEdgeMaterial1:NDSWebViewer.SETTING.preSelectedEdgeMaterial),new NDSWebViewer.LineSegmentsGeometry),N=(l.setPositions(o),new NDSWebViewer.LineSegmentsGeometry),L=(N.setPositions(r),new NDSWebViewer.LineMaterialOrigin({linewidth:n.linewidth,opacity:n.opacity,color:new THREE.Color(16743724),depthTest:n.depthTest,depthWrite:n.depthWrite,side:THREE.DoubleSide,dashed:!0,dashSize:1/d.x,gapSize:2/d.x})),c=this.viewer.renderer.getPixelRatio(),o=this.viewer.renderer.domElement.width/c,r=this.viewer.renderer.domElement.height/c,c=(L.resolution.set(o,r),new NDSWebViewer.LineSegments2(l,L)),o=(c.objectType="radiusX",c.computeLineDistances(),c.applyMatrix(e.matrixWorld),c.matrixWorldNeedsUpdate=!0,new NDSWebViewer.LineSegments2(N,L)),y=(o.objectType="radiusY",o.computeLineDistances(),o.applyMatrix(e.matrixWorld),o.matrixWorldNeedsUpdate=!0,s.add(i),s.add(c),s.add(o),s.objectType="EllipseLine",s.LineInfo=[],s.LineInfo.push(this.viewer.ndsModel.bodyUuid2NodeMap[e.bodyUuid].id),this.viewer.ndsModel.geomManager.uuidToIdMap[e.geometry.uuid][0]),C=(s.LineInfo.push(y),s.LineInfo.push(e.topolIndex),s.LineInfo.push(e.lineSegId),t?1:0);if(s.LineInfo.push(C),.01<Math.abs(a-e.length)/e.length){var w=new THREE.EllipseCurve(0,0,e.radiusX/d.x,e.radiusY/d.y,0,2*Math.PI,!1,0).getPoints(100),r=new THREE.Quaternion,A=new THREE.Matrix4,l=new THREE.Matrix4,N=new THREE.Vector3(e.axisX[0],e.axisX[1],e.axisX[2]).normalize(),L=new THREE.Vector3(e.center[0],e.center[1],e.center[2]),c=(r.setFromUnitVectors(new THREE.Vector3(1,0,0),N),A.makeRotationFromQuaternion(r),new THREE.Vector3(0,0,1)),v=(c.applyMatrix4(A),r.setFromUnitVectors(c.normalize(),new THREE.Vector3(e.normal[0],e.normal[1],e.normal[2]).normalize()),l.makeRotationFromQuaternion(r),A.premultiply(l),A.setPosition(L),[]),f=new Float32Array(3*(w.length+1));for(let e=0;e<w.length;e++)v[e]=new THREE.Vector3(w[e].x,w[e].y,0),v[e].applyMatrix4(A),f[3*e]=v[e].x,f[3*e+1]=v[e].y,f[3*e+2]=v[e].z;f[3*w.length]=v[0].x,f[3*w.length+1]=v[0].y,f[3*w.length+2]=v[0].z,n=n||NDSWebViewer.SETTING.SelectedEdgeMaterial1;o=new NDSWebViewer.LineSegmentsGeometry,y=(o.setPositions(f),new NDSWebViewer.LineMaterialOrigin({linewidth:n.linewidth,opacity:n.opacity,color:n.color,depthTest:n.depthTest,depthWrite:n.depthWrite,side:THREE.DoubleSide,dashed:!0,dashSize:1/d.x,gapSize:2/d.x})),C=this.viewer.renderer.getPixelRatio(),a=this.viewer.renderer.domElement.width/C,N=this.viewer.renderer.domElement.height/C,c=(y.resolution.set(a,N),new NDSWebViewer.LineSegments2(o,y));c.objectType="EllipseCurveDash",c.applyMatrix(e.matrixWorld),c.matrixWorldNeedsUpdate=!0,s.add(c)}}return t?i:s}},i.prototype.isBetweenTwoVectors=function(e,t,n){var i,s;return!(!e.equals(t)&&!e.equals(n))||(i=(new THREE.Vector3).crossVectors(e,t),s=(new THREE.Vector3).crossVectors(e,n),i.dot(s)<0&&e.angleTo(t)+e.angleTo(n)<Math.PI)},i.prototype.createLineMesh=function(e,t,n){var i=(new THREE.Vector3).subVectors(t,e),s=new THREE.Matrix4,i=(s.lookAt(e,t,(new THREE.Object3D).up),s.multiply((new THREE.Matrix4).set(1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1)),new THREE.CylinderGeometry(.5,.5,i.length(),8,1,!1)),i=new THREE.Mesh(i,n);return i.applyMatrix(s),i.position.addVectors(e,t),i.position.multiplyScalar(.5),i},i.prototype.createLineMesh2=function(e,t,n){var i=new THREE.Geometry,i=(i.vertices.push(t),i.vertices.push(e),new THREE.Line(i,n));return i.updateMatrixWorld(!0),i.objectType="Line",i.Start=e.clone(),i.End=t.clone(),i},i.prototype.createLineMesh3=function(e,t,n){for(var i=t.clone().sub(e).normalize(),s=e.distanceTo(t),o=Math.ceil(Math.abs(s/6)),r=0<s?1:-1,a=new Float32Array(6*o),l=0;l<o;++l){var d=new THREE.Vector3,c=new THREE.Vector3,d=e.clone().add(i.clone().multiplyScalar(6*l*r));6*l+4<Math.abs(s)?c=d.clone().add(i.clone().multiplyScalar(3*r)):c.set(t.x,t.y,t.z),a[6*l]=d.x,a[6*l+1]=d.y,a[6*l+2]=d.z,a[6*l+3]=c.x,a[6*l+4]=c.y,a[6*l+5]=c.z}var h=new THREE.BufferGeometry,h=(h.addAttribute("position",new THREE.BufferAttribute(a,3)),new THREE.LineSegments(h,n));return h.objectType="Edge",h.Start=e.clone(),h.End=t.clone(),h.matrixWorldNeedsUpdate=!0,h},i.prototype.createLineMesh4=function(e,t,n,i){for(var s=t.clone().sub(e).normalize(),o=e.distanceTo(t),r=Math.ceil(Math.abs(o/6)),a=Math.ceil(n.distanceTo(t)/6),l=new Float32Array(6*(r+a)),d=0;d<r;++d){var c=new THREE.Vector3,h=new THREE.Vector3;c=e.clone().add(s.clone().multiplyScalar(6*d)),6*d+4<o?h=c.clone().add(s.clone().multiplyScalar(3)):h.set(t.x,t.y,t.z),l[6*d]=c.x,l[6*d+1]=c.y,l[6*d+2]=c.z,l[6*d+3]=h.x,l[6*d+4]=h.y,l[6*d+5]=h.z}for(s=n.clone().sub(t).normalize(),o=n.distanceTo(t),d=0;d<a;++d){c=new THREE.Vector3,h=new THREE.Vector3;c=t.clone().add(s.clone().multiplyScalar(6*d)),6*d+4<o?h=c.clone().add(s.clone().multiplyScalar(3)):h.set(n.x,n.y,n.z),l[6*(d+r)]=c.x,l[6*(d+r)+1]=c.y,l[6*(d+r)+2]=c.z,l[6*(d+r)+3]=h.x,l[6*(d+r)+4]=h.y,l[6*(d+r)+5]=h.z}var f=new THREE.BufferGeometry,f=(f.addAttribute("position",new THREE.BufferAttribute(l,3)),new THREE.LineSegments(f,i));return f.objectType="CircleLine",f.Start=e.clone(),f.Mid=t.clone(),f.End=n.clone(),f.matrixWorldNeedsUpdate=!0,f},i.prototype.createCylinderMesh=function(e,t,n){var i=new THREE.Matrix4,s=(i.lookAt(e,t,(new THREE.Object3D).up),i.multiply((new THREE.Matrix4).set(1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1)),new THREE.CylinderGeometry(0,this.cylinderRadiusBottom,this.cylinderHeight,8,1,!1)),s=new THREE.Mesh(s,n);return s.applyMatrix(i),s.position.copy(e),s.objectType="Cylinder",s.Start=e.clone(),s.End=t.clone(),s},i.prototype.createAngleArcMeshes2=function(e,t,n,i,s,o,r){var a=new THREE.Vector3,l=new THREE.Vector3,e=(a.subVectors(e,t),l.subVectors(n,t),a.dot(l)),n=a.length(),d=l.length(),e=(e=Math.acos(e/(n*d)))/Math.PI*180,c=(this.dimString=e.toFixed(8),this.dimString+="",new THREE.Vector3),c=(c.crossVectors(a,l),c.normalize(),o&&c.copy(o),Math.min(n,d));return this.createAngleArcMeshesWithAngle(t,a,l,c,e,i,s)},i.prototype.createAngleArcMeshesWithAngle=function(s,e,t,o,n,i,r){this.dimString=n.toFixed(8),this.dimString+="",e.normalize(),t.normalize();var a=new THREE.Vector3,a=(a.crossVectors(e,t),a.normalize(),new THREE.CircleGeometry(o,18,0,n*Math.PI/180));if(new THREE.Mesh(a,this.materialLine).geometry.attributes.position.count<2)return[];var l=[];!function e(t,n){var i=(new THREE.Vector3).addVectors(t,n);i.normalize(),i.angleTo(t)/Math.PI*180<=2?(l.push(s.clone().addScaledVector(t,o)),l.push(s.clone().addScaledVector(i,o)),l.push(s.clone().addScaledVector(n,o))):(e(t.clone(),i.clone()),e(i.clone(),n.clone()))}(e,t);var d=[];r=r||this.materialLine;for(var c=0;c<l.length-1;c++){var h=this.createLineMesh2(l[c],l[c+1],r,i);d.push(h)}return d},i.prototype.createContour=function(e){var t=new Float32Array(e),n=new THREE.BufferGeometry,t=(n.addAttribute("position",new THREE.BufferAttribute(t,3)),new THREE.LineSegments(n,NDSWebViewer.SETTING.selectedVertexMaterial));return t.objectType="Contour",t.Vertices=e,t.matrixWorldNeedsUpdate=!0,t},i.prototype.getCameraScale=function(e,t){var n,i,s;return e?(t=null!=t?t:5,n=this.viewer.camera.getCameraTarget(),i=this.viewer.camera.position,(s=new THREE.Vector3).subVectors(n,i),n=e.clone(),e=this.viewer.camera.isPerspective?n.sub(i).dot(s.normalize()):1.2*s.length(),n=this.viewer.camera.fov,i=2*e*Math.tan(THREE.Math.degToRad(.5*n)),s=this.viewer.renderer.domElement.height,t*i*this.viewer.renderer.getPixelRatio()/s):1},i.prototype.setPointScale=function(e,t){t=this.OpMeasure.getScale(e,t);e.scale.x=t,e.scale.y=t,e.scale.z=t,e.updateMatrixWorld()},i.prototype.setCylinderScale=function(e,t){t=this.OpMeasure.getScale(e,t);e.scale.x=t,e.scale.y=t,e.scale.z=t,e.oldPosition&&e.offsetPos&&e.position.addVectors(e.oldPosition,e.offsetPos.clone().multiplyScalar(t)),e.updateMatrixWorld()},i.prototype.createCrossHairMesh=function(e,t){var n=new THREE.PlaneGeometry(6,6),i=this.viewer.renderer.domElement,i=new THREE.ShaderMaterial({uniforms:{color:{value:new THREE.Color(1540323)},width:{value:1},iResolution:{value:new THREE.Vector2(i.width,i.height)}},opacity:.8,transparent:!0,depthTest:!1,depthWrite:!1,vertexShader:`
    uniform vec2 iResolution; 
    out vec2 center; // 
    out vec2 screenPos; // 

    void main() {
    vec3 toCamera = normalize(cameraPosition);
    vec3 up = vec3(0.0, 1.0, 0.0);
    vec3 right = cross(toCamera, up);

        //  right  toCamera 
        right = normalize(right);
        toCamera = normalize(toCamera);
        //  up  toCamera 
        up = cross(toCamera, right);

    // 
    mat4 rotationMatrix = mat4(
            vec4(right.x, right.y, right.z, 0.0),
            vec4(up.x, up.y, up.z, 0.0),
            vec4(toCamera.x, toCamera.y, toCamera.z, 0.0),
            vec4(0.0, 0.0, 0.0, 1.0)
        );
    
    vec4 pos = projectionMatrix * modelViewMatrix * rotationMatrix * vec4(position, 1.0);
    vec4 center3 = projectionMatrix * modelViewMatrix * vec4(0.0,0.0,0.0, 1.0);

        // 
        screenPos = vec2((pos.x + 1.0) * 0.5 * iResolution.x, (1.0 - pos.y) * 0.5 * iResolution.y);

        center = vec2((center3.x + 1.0) * 0.5 * iResolution.x, (1.0 - center3.y) * 0.5 * iResolution.y);

        gl_Position = pos;
    }
    `,fragmentShader:`
    uniform vec3 color;
    uniform float width;
    in vec2 screenPos;
    in vec2 center; 
    void main() {

        if (abs(screenPos.x-center.x)>width && abs(screenPos.y-center.y)>width
        || length(center - screenPos) < 2.0) discard;

        gl_FragColor = vec4(color, 1.0);
    }
    `}),n=new THREE.Mesh(n,i);return n.position.set(e.x,e.y,e.z),this.setPointScale(n,t),n.objectType="Point",n.Point=e.clone(),n},i.prototype.createPointMesh=function(e,t,n){t=new THREE.Mesh(new THREE.SphereGeometry(1),t);return t.position.set(e.x,e.y,e.z),this.setPointScale(t,n),t.objectType="Point",t.Point=e.clone(),t},i.prototype.isTwoTopolInfoTheSame=function(e,t){return!(e&&!t||!e&&t||!e&&!t||this.viewer.ndsModel&&(e.bodyId!=t.bodyId||e.meshId!=t.meshId||e.lineSegId!=t.lineSegId)||e.parentObj!=t.parentObj||e.id!=t.id||e.indexRange[0]!==t.indexRange[0]||e.indexRange[1]!==t.indexRange[1])},i.prototype.isTwoPointTheSame=function(e,t){return Math.abs(e.x-t.x)<1e-6&&Math.abs(e.y-t.y)<1e-6&&Math.abs(e.z-t.z)<1e-6},i.prototype.getIntersectsByPriorityOfLine=function(e,t,n){var i=this.viewer,s=i.renderer.domElement,o=i.renderer.getPixelRatio(),r=new THREE.Raycaster,a=(i.camera.setCastRay(r,e*o/s.width*2-1,2*-(t*o/s.height)+1),r.linePrecision=this.getLinePrecision(),n&&(r.linePrecision=n),null),a=i.ndsModel?i.ndsModel.intersect(r.ray,r.linePrecision):r.intersectObjects(i.selectionManager.getTargetIncludeLineList());if(a&&0<a.length&&!i.ndsModel&&1<a.length&&!(a[0].object instanceof THREE.Line)){a[0].object;for(var l=a[0].distance,d=1;d<a.length;d++){var c=a[d].object,h=a[d].distance;if(!(l+2*r.linePrecision>=h))break;if(c instanceof THREE.Line){h=a[d];a[d]=a[0],a[0]=h;break}}}return a},i.prototype.createAndShowDistanceDimension=function(e,t){var n,i,s,o,r,a,l,d,c,h,f,I,u,p,S,g,E,m,O,b,P,M,T,x,y;this.distanceInfo.firstSelObj&&this.distanceInfo.secondSelObj&&(n=!1,s=((n=this.distanceInfo.firstSelInfo&&"plane"==this.distanceInfo.firstSelInfo.type&&this.distanceInfo.secondSelInfo&&"plane"==this.distanceInfo.secondSelInfo.type?!0:n)?(i=this.distanceInfo.firstSelInfo.intersect.clone(),this.distanceInfo.secondSelInfo.intersect):(i=this.distanceInfo.firstPoint.clone(),this.distanceInfo.secondPoint)).clone(),this.distanceInfo.fstClndPos||(this.distanceInfo.fstClndPos=this.distanceInfo.firstPoint.clone()),this.distanceInfo.sndClndPos||(this.distanceInfo.sndClndPos=this.distanceInfo.secondPoint.clone()),this.distanceInfo.textPos&&e&&((y=new THREE.Plane).setFromCoplanarPoints(i,this.distanceInfo.fstClndPos,this.distanceInfo.sndClndPos),y.normal.length()<1e-8&&y.setFromCoplanarPoints(i.clone().add(new THREE.Vector3(1,-1,1)),this.distanceInfo.fstClndPos,this.distanceInfo.sndClndPos),P=this.clientCoordToModelCoordOnPlane(e.x,e.y,y))&&(this.viewer.is2DModel&&(P.z=0),this.distanceInfo.textPos.copy(P)),this.distanceInfo.fstClnd&&this.distanceInfo.sndClnd?!n&&this.distanceInfo.textPos?(l=(new THREE.Vector3).subVectors(this.distanceInfo.sndClndPos,this.distanceInfo.fstClndPos),(o=this.getProjectPntToLine(s,this.distanceInfo.sndClndPos,this.distanceInfo.textPos.clone()))&&(1e-5<(P=o.clone().sub(s)).length()?(this.distanceInfo.sndClndPos.addVectors(s,P),this.distanceInfo.fstClndPos.subVectors(this.distanceInfo.sndClndPos,l)):(r=this.viewer.camera.position,a=(new THREE.Vector3).subVectors(r,this.distanceInfo.fstClndPos),(d=(l=(new THREE.Vector3).subVectors(this.distanceInfo.secondPoint,this.distanceInfo.firstPoint)).length())<1e-8?(d=(l=new THREE.Vector3(100,100,100)).length(),(c=(new THREE.Vector3).crossVectors(l,a)).normalize().multiplyScalar(Math.max(.001*d,1e-4)),this.distanceInfo.fstClndPos.add(c),this.distanceInfo.sndClndPos.sub(c)):((c=(new THREE.Vector3).crossVectors(l,a)).normalize().multiplyScalar(Math.max(.001*d,1e-4)),this.distanceInfo.fstClndPos.add(c),this.distanceInfo.sndClndPos.add(c))))):n&&(P=(new THREE.Vector3).subVectors(this.distanceInfo.sndClndPos,this.distanceInfo.fstClndPos),M=(new THREE.Vector3).subVectors(this.distanceInfo.textPos,this.distanceInfo.fstClndPos),(y=new THREE.Plane).setFromCoplanarPoints(i,s,this.distanceInfo.sndClndPos),(e=this.clientCoordToModelCoordOnPlane(e.x,e.y,y))&&(o=this.getProjectPntToLine(this.distanceInfo.secondSelInfo.intersect,this.distanceInfo.sndClndPos,e))&&this.distanceInfo.sndClndPos.copy(o),this.distanceInfo.fstClndPos=this.distanceInfo.sndClndPos.clone().sub(P),this.distanceInfo.textPos.copy(this.distanceInfo.fstClndPos.clone().add(M))):n?(y=(new THREE.Vector3).subVectors(s,i),(e=this.distanceInfo.firstSelInfo.worldNormal.clone()).normalize(),this.distanceInfo.fstClndPos=i.clone(),this.distanceInfo.sndClndPos=new THREE.Vector3,o=this.distanceInfo.dimString,o*=T=this.viewer.getUnitScale(this.distanceInfo.unit),o=Math.max(o,1e-4),0<y.dot(e)?this.distanceInfo.sndClndPos.addVectors(this.distanceInfo.fstClndPos,e.multiplyScalar(o)):this.distanceInfo.sndClndPos.addVectors(this.distanceInfo.fstClndPos,e.multiplyScalar(-1*o))):(r=this.viewer.camera.position,a=(new THREE.Vector3).subVectors(r,this.distanceInfo.fstClndPos),(d=(l=(new THREE.Vector3).subVectors(this.distanceInfo.secondPoint,this.distanceInfo.firstPoint)).length())<1e-8?(d=(l=new THREE.Vector3(100,100,100)).length(),(c=(new THREE.Vector3).crossVectors(l,a)).normalize().multiplyScalar(Math.max(.001*d,1e-4)),this.viewer.is2DModel&&(c.z=0),this.distanceInfo.fstClndPos.add(c),this.distanceInfo.sndClndPos.sub(c)):((c=(new THREE.Vector3).crossVectors(l,a)).normalize().multiplyScalar(Math.max(.001*d,1e-4)),this.viewer.is2DModel&&(c.z=0),this.distanceInfo.fstClndPos.add(c),this.distanceInfo.sndClndPos.add(c))),this.distanceInfo.textPos||(this.distanceInfo.textPos=this.distanceInfo.sndClndPos.clone()),n||this.distanceInfo.fstToSndLine||(this.distanceInfo.fstToSndLine=this.createLineMesh2(this.distanceInfo.firstPoint,this.distanceInfo.secondPoint,this.materialLine,1),this.OpMeasure.rootObject.add(this.distanceInfo.fstToSndLine),this.distanceInfo.firstSelInfo&&"plane"==this.distanceInfo.firstSelInfo.type&&(h=this.getClosePoint(this.distanceInfo.firstSelInfo,this.distanceInfo.firstPoint),this.distanceInfo.FstToFstPointLine=this.createLineMesh3(this.distanceInfo.firstPoint,h,this.materialLine,1),this.OpMeasure.rootObject.add(this.distanceInfo.FstToFstPointLine)),this.distanceInfo.secondSelInfo&&"plane"==this.distanceInfo.secondSelInfo.type&&(h=this.getClosePoint(this.distanceInfo.secondSelInfo,this.distanceInfo.secondPoint),this.distanceInfo.SndToSndPointLine=this.createLineMesh3(this.distanceInfo.secondPoint,h,this.materialLine,1),this.OpMeasure.rootObject.add(this.distanceInfo.SndToSndPointLine)),this.distanceInfo.firstSelInfo&&"circle"==this.distanceInfo.firstSelInfo.type&&((f=new THREE.Vector3(this.distanceInfo.firstSelInfo.center[0],this.distanceInfo.firstSelInfo.center[1],this.distanceInfo.firstSelInfo.center[2])).applyMatrix4(this.distanceInfo.firstSelInfo.matrixWorld),I=this.distanceInfo.firstSelInfo.geometry,u=new THREE.Vector3,p=this.distanceInfo.firstSelInfo.indexRange.concat(),this.viewer.ndsModel&&(p[0]+=I.drawRange.start/2,p[1]+=I.drawRange.start/2),I.isBufferGeometry&&(S=I.index,g=I.attributes.position.array,null!=S)&&(E=S.array,m=p[0],u.fromArray(g,3*E[2*m]),u.applyMatrix4(this.distanceInfo.firstSelInfo.matrixWorld)),this.distanceInfo.FstToFstPointLine=this.createLineMesh4(this.distanceInfo.firstPoint,f,u,this.materialLine),this.OpMeasure.rootObject.add(this.distanceInfo.FstToFstPointLine)),this.distanceInfo.secondSelInfo&&"circle"==this.distanceInfo.secondSelInfo.type&&((f=new THREE.Vector3(this.distanceInfo.secondSelInfo.center[0],this.distanceInfo.secondSelInfo.center[1],this.distanceInfo.secondSelInfo.center[2])).applyMatrix4(this.distanceInfo.secondSelInfo.matrixWorld),I=this.distanceInfo.secondSelInfo.geometry,u=new THREE.Vector3,p=this.distanceInfo.secondSelInfo.indexRange.concat(),this.viewer.ndsModel&&(p[0]+=I.drawRange.start/2,p[1]+=I.drawRange.start/2),I.isBufferGeometry&&(S=I.index,g=I.attributes.position.array,null!=S)&&(E=S.array,m=p[0],u.fromArray(g,3*E[2*m]),u.applyMatrix4(this.distanceInfo.secondSelInfo.matrixWorld)),this.distanceInfo.SndToSndPointLine=this.createLineMesh4(this.distanceInfo.secondPoint,f,u,this.materialLine),this.OpMeasure.rootObject.add(this.distanceInfo.SndToSndPointLine)),!this.distanceInfo.firstSelInfo||"line"!=this.distanceInfo.firstSelInfo.type&&"cylinder"!=this.distanceInfo.firstSelInfo.type&&"cone"!=this.distanceInfo.firstSelInfo.type||(O=this.getLineStartEndPoints(this.distanceInfo.firstSelInfo))&&1e-5<(b=new THREE.Line3(O.start,O.end).closestPointToPoint(this.distanceInfo.firstPoint,!0)).distanceTo(this.distanceInfo.firstPoint)&&(this.distanceInfo.FstToFstPointLine=this.createLineMesh3(this.distanceInfo.firstPoint,b,this.materialLine,1),this.OpMeasure.rootObject.add(this.distanceInfo.FstToFstPointLine)),!this.distanceInfo.secondSelInfo)||"line"!=this.distanceInfo.secondSelInfo.type&&"cylinder"!=this.distanceInfo.secondSelInfo.type&&"cone"!=this.distanceInfo.secondSelInfo.type||(O=this.getLineStartEndPoints(this.distanceInfo.secondSelInfo))&&1e-5<(b=new THREE.Line3(O.start,O.end).closestPointToPoint(this.distanceInfo.secondPoint,!0)).distanceTo(this.distanceInfo.secondPoint)&&(this.distanceInfo.SndToSndPointLine=this.createLineMesh3(this.distanceInfo.secondPoint,b,this.materialLine,1),this.OpMeasure.rootObject.add(this.distanceInfo.SndToSndPointLine)),P=this.isPointBetweenIn(this.distanceInfo.textPos,this.distanceInfo.fstClndPos,this.distanceInfo.sndClndPos),this.distanceInfo.fstClnd&&this.OpMeasure.rootObject.remove(this.distanceInfo.fstClnd),(M=(new THREE.Vector3).subVectors(this.distanceInfo.sndClndPos,this.distanceInfo.fstClndPos)).normalize(),P?(this.distanceInfo.fstClnd=this.createCylinderMesh(this.distanceInfo.sndClndPos,this.distanceInfo.fstClndPos,this.materialLine),T=this.OpMeasure.getScale(this.distanceInfo.fstClnd,this.CYLINDERWIDTH),M.multiplyScalar(.5*this.distanceInfo.fstClnd.geometry.parameters.height),this.distanceInfo.fstClnd.oldPosition=this.distanceInfo.fstClndPos.clone(),this.distanceInfo.fstClnd.offsetPos=M.clone(),this.distanceInfo.fstClnd.position.addVectors(this.distanceInfo.fstClndPos,M.clone().multiplyScalar(T))):(this.distanceInfo.fstClnd=this.createCylinderMesh(this.distanceInfo.fstClndPos,this.distanceInfo.sndClndPos,this.materialLine,!1),T=this.OpMeasure.getScale(this.distanceInfo.fstClnd,this.CYLINDERWIDTH),M.multiplyScalar(.5*this.distanceInfo.fstClnd.geometry.parameters.height),this.distanceInfo.fstClnd.oldPosition=this.distanceInfo.fstClndPos.clone(),this.distanceInfo.fstClnd.offsetPos=M.clone().multiplyScalar(-1),this.distanceInfo.fstClnd.position.subVectors(this.distanceInfo.fstClndPos,M.clone().multiplyScalar(T))),this.distanceInfo.fstClnd.updateMatrixWorld(),this.OpMeasure.rootObject.add(this.distanceInfo.fstClnd),this.distanceInfo.sndClnd&&this.OpMeasure.rootObject.remove(this.distanceInfo.sndClnd),P?(this.distanceInfo.sndClnd=this.createCylinderMesh(this.distanceInfo.fstClndPos,this.distanceInfo.sndClndPos,this.materialLine),this.distanceInfo.sndClnd.oldPosition=this.distanceInfo.sndClndPos.clone(),this.distanceInfo.sndClnd.offsetPos=M.clone().multiplyScalar(-1),this.distanceInfo.sndClnd.position.subVectors(this.distanceInfo.sndClndPos,M.clone().multiplyScalar(T))):(this.distanceInfo.sndClnd=this.createCylinderMesh(this.distanceInfo.sndClndPos,this.distanceInfo.fstClndPos,this.materialLine,!1),this.distanceInfo.sndClnd.oldPosition=this.distanceInfo.sndClndPos.clone(),this.distanceInfo.sndClnd.offsetPos=M.clone(),this.distanceInfo.sndClnd.position.addVectors(this.distanceInfo.sndClndPos,M.clone().multiplyScalar(T))),this.distanceInfo.sndClnd.updateMatrixWorld(),this.OpMeasure.rootObject.add(this.distanceInfo.sndClnd),this.distanceInfo.clndToClndLine&&this.OpMeasure.rootObject.remove(this.distanceInfo.clndToClndLine),this.distanceInfo.clndToClndLine=this.createLineMesh2(this.distanceInfo.fstClndPos,this.distanceInfo.sndClndPos,this.materialLine,1),this.OpMeasure.rootObject.add(this.distanceInfo.clndToClndLine),this.distanceInfo.fstToClndLine&&this.OpMeasure.rootObject.remove(this.distanceInfo.fstToClndLine),this.distanceInfo.fstToClndLine=this.createLineMesh2(i,this.distanceInfo.fstClndPos,this.materialLine,1),this.OpMeasure.rootObject.add(this.distanceInfo.fstToClndLine),this.distanceInfo.sndToClndLine&&this.OpMeasure.rootObject.remove(this.distanceInfo.sndToClndLine),this.distanceInfo.sndToClndLine=this.createLineMesh2(s,this.distanceInfo.sndClndPos,this.materialLine,1),this.OpMeasure.rootObject.add(this.distanceInfo.sndToClndLine),this.distanceInfo.boxToClndLine&&this.OpMeasure.rootObject.remove(this.distanceInfo.boxToClndLine),this.distanceInfo.boxToClndLine=this.createLineMesh2(this.distanceInfo.fstClndPos,this.distanceInfo.textPos,this.materialLine,1),this.OpMeasure.rootObject.add(this.distanceInfo.boxToClndLine),""==this.distanceInfo.dimString?(this.distanceInfo.dimString=this.distanceInfo.firstPoint.distanceTo(this.distanceInfo.secondPoint),this.distanceInfo.dimString<1&&.999999<this.distanceInfo.dimString&&(this.distanceInfo.dimString=1),x=this.viewer.getDispalyModelUnit(this.distanceInfo.dimString),this.distanceInfo.dimString*=x.scale,this.distanceInfo.dimString=this.distanceInfo.dimString.toFixed(8),this.distanceInfo.unit=this.getUnitStringmap(x.unit)):(d=parseFloat(this.distanceInfo.dimString))<1&&""==this.distanceInfo.unit&&(.999999<d&&(d=1),d*=(x=this.viewer.getDispalyModelUnit(this.distanceInfo.dimString)).scale,this.distanceInfo.dimString=d.toFixed(8),this.distanceInfo.unit=this.getUnitStringmap(x.unit)),y=(this.distanceInfo.dimString*this.viewer.measuringScale).toFixed(8)+this.distanceInfo.unit,this.distanceInfo.textBox||(this.distanceInfo.textBox=document.createElement("div"),this.distanceInfo.textBox.className="mearesult",this.viewer.container.appendChild(this.distanceInfo.textBox)),this.getAndShowTextBox(this.distanceInfo.textPos.clone(),y,this.distanceInfo.textBox),1==t)&&((e={}).dimString=y,e.textPos=this.distanceInfo.textPos.clone(),e.textBox=this.distanceInfo.textBox,e.textBox.setAttribute("type","length"),e.textBox.setAttribute("dimString",this.distanceInfo.dimString),e.textBox.setAttribute("dimStringPrefix",""),e.textBox.setAttribute("unit",this.distanceInfo.unit),this.OpMeasure.boxInfos.push(e),this.clearDistanceInfo(!0),NDSWebViewer.COMMON.isMobileDevice())&&this.ChangeMeasureFlag()},i.prototype.DeepCopy=function(e,t){var n={};switch(n.textPos=e.textPos,n.fstClndPos=e.fstClndPos,n.sndClndPos=e.sndClndPos,n.unit=e.unit,t){case"Distance":n.firstPoint=e.firstPoint,n.secondPoint=e.secondPoint;break;case"Angle":n.arcCenter=e.arcCenter,e.firstLineInfo&&e.secondLineInfo&&(n.firstLineInfo={},n.secondLineInfo={},n.firstLineInfo.start=e.firstLineInfo.start,n.secondLineInfo.start=e.secondLineInfo.start,n.firstLineInfo.end=e.firstLineInfo.end,n.secondLineInfo.end=e.secondLineInfo.end);break;case"measureEdges":n.thirdPos=e.thirdPos,n.endPos=e.endPos,n.startPos=e.startPos,n.midPos=e.midPos,n.fstClnd=!!e.fstClnd,n.sndClnd=!!e.sndClnd;break;case"Radius":n.selLineCenterPos=e.selLineCenterPos,n.firstHoleInfo={},e.firstHoleInfo&&(n.firstHoleInfo.center=e.firstHoleInfo.center,n.firstHoleInfo.intersect=e.firstHoleInfo.intersect,n.firstHoleInfo.radius=e.firstHoleInfo.radius,n.firstHoleInfo.worldAxis=e.firstHoleInfo.worldAxis,n.firstHoleInfo.worldCenter=e.firstHoleInfo.worldCenter);break;case"Lineargauge3D":n.firstPoint=e.firstPoint,n.secondPoint=e.secondPoint;break;default:console.log("ERROR: unknow measure type")}return n.measureType=t,n},i.prototype.ChangeMeasureFlag=function(){switch(this.measureType){case"pt2pt":this.OpMeasure.measureFlag|=NDSWebViewer.NDS.MEASUREFLAG.pt2pt;break;case"pt2ptbim":this.OpMeasure.measureFlag|=NDSWebViewer.NDS.MEASUREFLAG.pt2ptbim;break;case"PointToLine":this.OpMeasure.measureFlag|=NDSWebViewer.NDS.MEASUREFLAG.pointtoline;break;case"PointToFace":this.OpMeasure.measureFlag|=NDSWebViewer.NDS.MEASUREFLAG.pointtoface;break;case"AxisToPoint":this.OpMeasure.measureFlag|=NDSWebViewer.NDS.MEASUREFLAG.axistopoint;break;case"LineToLine":this.OpMeasure.measureFlag|=NDSWebViewer.NDS.MEASUREFLAG.linetoline;break;case"LineToFace":this.OpMeasure.measureFlag|=NDSWebViewer.NDS.MEASUREFLAG.linetoface;break;case"faceDist":this.OpMeasure.measureFlag|=NDSWebViewer.NDS.MEASUREFLAG.facedist;break;case"AxisToLine":this.OpMeasure.measureFlag|=NDSWebViewer.NDS.MEASUREFLAG.axistoline;break;case"AxisToFace":this.OpMeasure.measureFlag|=NDSWebViewer.NDS.MEASUREFLAG.axistoface;break;case"holeDist":this.OpMeasure.measureFlag|=NDSWebViewer.NDS.MEASUREFLAG.holedist;break;case"measureEdges":this.OpMeasure.measureFlag|=NDSWebViewer.NDS.MEASUREFLAG.Edge;break;case"perimeter":this.OpMeasure.measureFlag|=NDSWebViewer.NDS.MEASUREFLAG.perimeter;break;case"LineAngle":this.OpMeasure.measureFlag|=NDSWebViewer.NDS.MEASUREFLAG.LineAngle;break;case"LineFaceAngle":this.OpMeasure.measureFlag|=NDSWebViewer.NDS.MEASUREFLAG.LineFaceAngle;break;case"faceAngle":this.OpMeasure.measureFlag|=NDSWebViewer.NDS.MEASUREFLAG.faceAngle;break;case"contour":this.OpMeasure.measureFlag|=NDSWebViewer.NDS.MEASUREFLAG.contour;break;case"contourarea":this.OpMeasure.measureFlag|=NDSWebViewer.NDS.MEASUREFLAG.contourarea;break;case"Lineargauge":this.OpMeasure.measureFlag|=NDSWebViewer.NDS.MEASUREFLAG.Lineargauge;break;case"coordinate":this.OpMeasure.measureFlag|=NDSWebViewer.NDS.MEASUREFLAG.coordinate;break;case"bodyAngle":this.OpMeasure.measureFlag|=NDSWebViewer.NDS.MEASUREFLAG.bodyAngle;break;case"bodyDistance":this.OpMeasure.measureFlag|=NDSWebViewer.NDS.MEASUREFLAG.bodyDistance;break;case"bodyEdgeLength":this.OpMeasure.measureFlag|=NDSWebViewer.NDS.MEASUREFLAG.bodyEdgeLength;break;case"angle":this.OpMeasure.measureFlag|=NDSWebViewer.NDS.MEASUREFLAG.angle;break;case"WallThickness":this.OpMeasure.measureFlag|=NDSWebViewer.NDS.MEASUREFLAG.WallThickness}this.OpMeasure.PostInfo()},i.prototype.hasMeasured=function(){switch(this.measureType){case"pt2pt":return this.OpMeasure.measureFlag&NDSWebViewer.NDS.MEASUREFLAG.pt2pt;case"PointToLine":return this.OpMeasure.measureFlag&NDSWebViewer.NDS.MEASUREFLAG.pointtoline;case"PointToFace":return this.OpMeasure.measureFlag&NDSWebViewer.NDS.MEASUREFLAG.pointtoface;case"AxisToPoint":return this.OpMeasure.measureFlag&NDSWebViewer.NDS.MEASUREFLAG.axistopoint;case"LineToLine":return this.OpMeasure.measureFlag&NDSWebViewer.NDS.MEASUREFLAG.linetoline;case"LineToFace":return this.OpMeasure.measureFlag&NDSWebViewer.NDS.MEASUREFLAG.linetoface;case"faceDist":return this.OpMeasure.measureFlag&NDSWebViewer.NDS.MEASUREFLAG.facedist;case"AxisToLine":return this.OpMeasure.measureFlag&NDSWebViewer.NDS.MEASUREFLAG.axistoline;case"AxisToFace":return this.OpMeasure.measureFlag&NDSWebViewer.NDS.MEASUREFLAG.axistoface;case"holeDist":return this.OpMeasure.measureFlag&NDSWebViewer.NDS.MEASUREFLAG.holedist;case"measureEdges":return this.OpMeasure.measureFlag&NDSWebViewer.NDS.MEASUREFLAG.Edge;case"perimeter":return this.OpMeasure.measureFlag&NDSWebViewer.NDS.MEASUREFLAG.perimeter;case"LineAngle":return this.OpMeasure.measureFlag&NDSWebViewer.NDS.MEASUREFLAG.LineAngle;case"LineFaceAngle":return this.OpMeasure.measureFlag&NDSWebViewer.NDS.MEASUREFLAG.LineFaceAngle;case"faceAngle":return this.OpMeasure.measureFlag&NDSWebViewer.NDS.MEASUREFLAG.faceAngle;case"contour":return this.OpMeasure.measureFlag&NDSWebViewer.NDS.MEASUREFLAG.contour;case"contourarea":return this.OpMeasure.measureFlag&NDSWebViewer.NDS.MEASUREFLAG.contourarea;case"Lineargauge":return this.OpMeasure.measureFlag&NDSWebViewer.NDS.MEASUREFLAG.Lineargauge;case"coordinate":return this.OpMeasure.measureFlag&NDSWebViewer.NDS.MEASUREFLAG.coordinate;case"bodyAngle":return this.OpMeasure.measureFlag&NDSWebViewer.NDS.MEASUREFLAG.bodyAngle;case"bodyDistance":return this.OpMeasure.measureFlag&NDSWebViewer.NDS.MEASUREFLAG.bodyDistance;case"bodyEdgeLength":return this.OpMeasure.measureFlag&NDSWebViewer.NDS.MEASUREFLAG.bodyEdgeLength;case"angle":return this.OpMeasure.measureFlag&NDSWebViewer.NDS.MEASUREFLAG.angle;case"pt2ptbim":return this.OpMeasure.measureFlag&NDSWebViewer.NDS.MEASUREFLAG.pt2ptbim;case"WallThickness":return this.OpMeasure.measureFlag&NDSWebViewer.NDS.MEASUREFLAG.WallThickness}},i.prototype.createAndShow3DDistanceDimension=function(e,t){var n,i,s,o,r,a,l,d,c,h,f,I,u,p,S,g,E,m,O,b,P,M,T,x,y;this.distanceInfo.firstSelObj&&this.distanceInfo.secondSelObj&&(f=!1,i=((f=this.distanceInfo.firstSelInfo&&"plane"==this.distanceInfo.firstSelInfo.type&&this.distanceInfo.secondSelInfo&&"plane"==this.distanceInfo.secondSelInfo.type?!0:f)?(n=this.distanceInfo.firstSelInfo.intersect.clone(),this.distanceInfo.secondSelInfo.intersect):(n=this.distanceInfo.firstPoint.clone(),this.distanceInfo.secondPoint)).clone(),this.distanceInfo.fstClndPos||(this.distanceInfo.fstClndPos=this.distanceInfo.firstPoint.clone()),this.distanceInfo.sndClndPos||(this.distanceInfo.sndClndPos=this.distanceInfo.secondPoint.clone()),this.distanceInfo.textPos&&e&&((I=new THREE.Plane).setFromCoplanarPoints(n,this.distanceInfo.fstClndPos,this.distanceInfo.sndClndPos),I.normal.length()<1e-8&&I.setFromCoplanarPoints(n.clone().add(new THREE.Vector3(1,-1,1)),this.distanceInfo.fstClndPos,this.distanceInfo.sndClndPos),c=this.clientCoordToModelCoordOnPlane(e.x,e.y,I))&&this.distanceInfo.textPos.copy(c),this.distanceInfo.fstClnd&&this.distanceInfo.sndClnd?!f&&this.distanceInfo.textPos?(S=(new THREE.Vector3).subVectors(this.distanceInfo.sndClndPos,this.distanceInfo.fstClndPos),(u=this.getProjectPntToLine(i,this.distanceInfo.sndClndPos,this.distanceInfo.textPos.clone()))&&(1e-5<(c=u.clone().sub(i)).length()?(this.distanceInfo.sndClndPos.addVectors(i,c),this.distanceInfo.fstClndPos.subVectors(this.distanceInfo.sndClndPos,S)):(p=this.viewer.camera.position,g=(new THREE.Vector3).subVectors(p,this.distanceInfo.fstClndPos),(s=(S=(new THREE.Vector3).subVectors(this.distanceInfo.secondPoint,this.distanceInfo.firstPoint)).length())<1e-8?(s=(S=new THREE.Vector3(100,100,100)).length(),(E=(new THREE.Vector3).crossVectors(S,g)).normalize().multiplyScalar(Math.max(.001*s,1e-4)),this.distanceInfo.fstClndPos.add(E),this.distanceInfo.sndClndPos.sub(E)):((E=(new THREE.Vector3).crossVectors(S,g)).normalize().multiplyScalar(Math.max(.001*s,1e-4)),this.distanceInfo.fstClndPos.add(E),this.distanceInfo.sndClndPos.add(E))))):f&&(c=(new THREE.Vector3).subVectors(this.distanceInfo.sndClndPos,this.distanceInfo.fstClndPos),h=(new THREE.Vector3).subVectors(this.distanceInfo.textPos,this.distanceInfo.fstClndPos),(I=new THREE.Plane).setFromCoplanarPoints(n,i,this.distanceInfo.sndClndPos),(e=this.clientCoordToModelCoordOnPlane(e.x,e.y,I))&&(u=this.getProjectPntToLine(this.distanceInfo.secondSelInfo.intersect,this.distanceInfo.sndClndPos,e))&&this.distanceInfo.sndClndPos.copy(u),this.distanceInfo.fstClndPos=this.distanceInfo.sndClndPos.clone().sub(c),this.distanceInfo.textPos.copy(this.distanceInfo.fstClndPos.clone().add(h))):f?(I=(new THREE.Vector3).subVectors(i,n),(e=this.distanceInfo.firstSelInfo.worldNormal.clone()).normalize(),this.distanceInfo.fstClndPos=n.clone(),this.distanceInfo.sndClndPos=new THREE.Vector3,u=this.distanceInfo.dimString,u*=this.viewer.getUnitScale(this.distanceInfo.unit),u=Math.max(u,1e-4),0<I.dot(e)?this.distanceInfo.sndClndPos.addVectors(this.distanceInfo.fstClndPos,e.multiplyScalar(u)):this.distanceInfo.sndClndPos.addVectors(this.distanceInfo.fstClndPos,e.multiplyScalar(-1*u))):(p=this.viewer.camera.position,g=(new THREE.Vector3).subVectors(p,this.distanceInfo.fstClndPos),(s=(S=(new THREE.Vector3).subVectors(this.distanceInfo.secondPoint,this.distanceInfo.firstPoint)).length())<1e-8?(s=(S=new THREE.Vector3(100,100,100)).length(),(E=(new THREE.Vector3).crossVectors(S,g)).normalize().multiplyScalar(Math.max(.001*s,1e-4)),this.distanceInfo.fstClndPos.add(E),this.distanceInfo.sndClndPos.sub(E)):((E=(new THREE.Vector3).crossVectors(S,g)).normalize().multiplyScalar(Math.max(.001*s,1e-4)),this.distanceInfo.fstClndPos.add(E),this.distanceInfo.sndClndPos.add(E))),this.distanceInfo.textPos||(this.distanceInfo.textPos=this.distanceInfo.firstPoint.clone().add(this.distanceInfo.secondPoint).divideScalar(2)),this.distanceInfo.fstToSndLine||(this.distanceInfo.fstToSndLine=this.createLineMesh2(this.distanceInfo.firstPoint,this.distanceInfo.secondPoint,this.appmaterialLine,1),this.OpMeasure.rootObject.add(this.distanceInfo.fstToSndLine)),this.distanceInfo.firstSelInfo&&"plane"==this.distanceInfo.firstSelInfo.type&&(O=this.getClosePoint(this.distanceInfo.firstSelInfo,this.distanceInfo.firstPoint),this.distanceInfo.FstToFstPointLine=this.createLineMesh3(this.distanceInfo.firstPoint,O,this.appmaterialLine,1),this.OpMeasure.rootObject.add(this.distanceInfo.FstToFstPointLine)),this.distanceInfo.secondSelInfo&&"plane"==this.distanceInfo.secondSelInfo.type&&(O=this.getClosePoint(this.distanceInfo.secondSelInfo,this.distanceInfo.secondPoint),this.distanceInfo.SndToSndPointLine=this.createLineMesh3(this.distanceInfo.secondPoint,O,this.appmaterialLine,1),this.OpMeasure.rootObject.add(this.distanceInfo.SndToSndPointLine)),this.distanceInfo.firstSelInfo&&"circle"==this.distanceInfo.firstSelInfo.type&&((o=new THREE.Vector3(this.distanceInfo.firstSelInfo.center[0],this.distanceInfo.firstSelInfo.center[1],this.distanceInfo.firstSelInfo.center[2])).applyMatrix4(this.distanceInfo.firstSelInfo.matrixWorld),b=this.distanceInfo.firstSelInfo.geometry,r=new THREE.Vector3,M=this.distanceInfo.firstSelInfo.indexRange.concat(),this.viewer.ndsModel&&(M[0]+=b.drawRange.start/2,M[1]+=b.drawRange.start/2),b.isBufferGeometry&&(P=b.index,T=b.attributes.position.array,null!=P)&&(x=P.array,y=M[0],r.fromArray(T,3*x[2*y]),r.applyMatrix4(this.distanceInfo.firstSelInfo.matrixWorld)),this.distanceInfo.FstToFstPointLine=this.createLineMesh4(this.distanceInfo.firstPoint,o,r,this.materialLine),this.OpMeasure.rootObject.add(this.distanceInfo.FstToFstPointLine)),this.distanceInfo.secondSelInfo&&"circle"==this.distanceInfo.secondSelInfo.type&&"PointToLine"!==this.measureType&&((o=new THREE.Vector3(this.distanceInfo.secondSelInfo.center[0],this.distanceInfo.secondSelInfo.center[1],this.distanceInfo.secondSelInfo.center[2])).applyMatrix4(this.distanceInfo.secondSelInfo.matrixWorld),b=this.distanceInfo.secondSelInfo.geometry,r=new THREE.Vector3,M=this.distanceInfo.secondSelInfo.indexRange.concat(),this.viewer.ndsModel&&(M[0]+=b.drawRange.start/2,M[1]+=b.drawRange.start/2),b.isBufferGeometry&&(P=b.index,T=b.attributes.position.array,null!=P)&&(x=P.array,y=M[0],r.fromArray(T,3*x[2*y]),r.applyMatrix4(this.distanceInfo.secondSelInfo.matrixWorld)),this.distanceInfo.SndToSndPointLine=this.createLineMesh4(this.distanceInfo.secondPoint,o,r,this.appmaterialLine),this.OpMeasure.rootObject.add(this.distanceInfo.SndToSndPointLine)),!this.distanceInfo.firstSelInfo||"line"!=this.distanceInfo.firstSelInfo.type&&"cylinder"!=this.distanceInfo.firstSelInfo.type&&"cone"!=this.distanceInfo.firstSelInfo.type||(a=this.getLineStartEndPoints(this.distanceInfo.firstSelInfo))&&1e-5<(l=new THREE.Line3(a.start,a.end).closestPointToPoint(this.distanceInfo.firstPoint,!0)).distanceTo(this.distanceInfo.firstPoint)&&(this.distanceInfo.FstToFstPointLine=this.createLineMesh3(this.distanceInfo.firstPoint,l,this.appmaterialLine,1),this.OpMeasure.rootObject.add(this.distanceInfo.FstToFstPointLine)),!this.distanceInfo.secondSelInfo||"line"!=this.distanceInfo.secondSelInfo.type&&("cylinder"!=this.distanceInfo.secondSelInfo.type&&"cone"!=this.distanceInfo.secondSelInfo.type||"PointToFace"===this.measureType)||(a=this.getLineStartEndPoints(this.distanceInfo.secondSelInfo))&&1e-5<(l=new THREE.Line3(a.start,a.end).closestPointToPoint(this.distanceInfo.secondPoint,!0)).distanceTo(this.distanceInfo.secondPoint)&&(this.distanceInfo.SndToSndPointLine=this.createLineMesh3(this.distanceInfo.secondPoint,l,this.appmaterialLine,1),this.OpMeasure.rootObject.add(this.distanceInfo.SndToSndPointLine)),""==this.distanceInfo.dimString?(this.distanceInfo.dimString=this.distanceInfo.firstPoint.distanceTo(this.distanceInfo.secondPoint),this.distanceInfo.dimString<1&&.999999<this.distanceInfo.dimString&&(this.distanceInfo.dimString=1),d=this.viewer.getDispalyModelUnit(this.distanceInfo.dimString),this.distanceInfo.dimString*=d.scale,this.distanceInfo.dimString=this.distanceInfo.dimString.toFixed(8),this.distanceInfo.unit=this.getUnitStringmap(d.unit)):(s=parseFloat(this.distanceInfo.dimString))<1&&""==this.distanceInfo.unit&&(.999999<s&&(s=1),s*=(d=this.viewer.getDispalyModelUnit(this.distanceInfo.dimString)).scale,this.distanceInfo.dimString=s.toFixed(8),this.distanceInfo.unit=this.getUnitStringmap(d.unit)),c=(this.distanceInfo.dimString*this.viewer.measuringScale).toFixed(8)+this.distanceInfo.unit,""==!this.distanceInfo.dimStringPrefix&&(c=this.distanceInfo.dimStringPrefix+c),h=null,this.distanceInfo.textBox||("pt2ptbim"==this.measureType?(this.distanceInfo.textBox=document.createElement("div"),this.distanceInfo.textBox.className="measure-tc",(h=document.createElement("div")).className="sectionCross",this.distanceInfo.textBox.appendChild(h),(m=document.createElement("div")).className="sectionPoint",m.style.left="calc(50% - 6px)",m.style.top="calc(100% - 5.5px)",this.distanceInfo.textBox.appendChild(m),f=document.createElement("p"),I="en"==NDSWebViewer.COMMON.getLanguage(),f.innerHTML=I?"<span>dis</span>"+c:"<span></span>"+c,this.distanceInfo.textBox.appendChild(f),e=document.createElement("p"),u=Math.abs(this.distanceInfo.firstPoint.x-this.distanceInfo.secondPoint.x),d=this.viewer.getDispalyModelUnit(u),e.innerHTML="<span>X</span>"+(u*this.viewer.measuringScale*d.scale).toFixed(8)+this.getUnitStringmap(d.unit),this.distanceInfo.textBox.appendChild(e),p=document.createElement("p"),S=Math.abs(this.distanceInfo.firstPoint.z-this.distanceInfo.secondPoint.z),d=this.viewer.getDispalyModelUnit(S),p.innerHTML="<span>Y</span>"+(S*this.viewer.measuringScale*d.scale).toFixed(8)+this.getUnitStringmap(d.unit),this.distanceInfo.textBox.appendChild(p),g=document.createElement("p"),E=Math.abs(this.distanceInfo.firstPoint.y-this.distanceInfo.secondPoint.y),d=this.viewer.getDispalyModelUnit(E),g.innerHTML="<span>Z</span>"+(E*this.viewer.measuringScale*d.scale).toFixed(8)+this.getUnitStringmap(d.unit),this.distanceInfo.textBox.appendChild(g)):(this.distanceInfo.textBox=document.createElement("div"),this.distanceInfo.textBox.className="section10",this.distanceInfo.textBox.innerHTML=c,(m=document.createElement("div")).className="sectionPoint",this.distanceInfo.textBox.appendChild(m),(h=document.createElement("div")).className="sectionCross",this.distanceInfo.textBox.appendChild(h)),this.viewer.container.appendChild(this.distanceInfo.textBox)),this.distanceInfo.boxToClndLine&&(this.OpMeasure.rootObject.remove(this.distanceInfo.boxToClndLine),this.distanceInfo.boxToClndLine=null),O=this.distanceInfo.firstPoint.clone().add(this.distanceInfo.secondPoint).divideScalar(2),this.distanceInfo.boxToClndLine||(this.distanceInfo.boxToClndLine=this.createLineMesh2(O,this.distanceInfo.textPos,this.appmaterialLine,1),this.distanceInfo.boxToClndLine.name="unsteady",this.OpMeasure.rootObject.add(this.distanceInfo.boxToClndLine)),b=this.get2dPoint(this.distanceInfo.textPos.clone()),P=this.viewer.renderer.getPixelRatio(),this.distanceInfo.textBox.style.left=Math.round(b.x/P-49)+"px",this.distanceInfo.textBox.style.top=Math.round(b.y/P-26)+"px",1==t)&&((M={}).dimString=c,M.textPos=this.distanceInfo.textPos.clone(),M.textBox=this.distanceInfo.textBox,T=this,(x=new THREE.Group).objectType="Group",T.OpMeasure.rootObject.remove(T.distanceInfo.boxToClndLine),T.OpMeasure.rootObject.remove(T.distanceInfo.fstToSndLine),T.OpMeasure.rootObject.remove(T.distanceInfo.firstSelObj),T.OpMeasure.rootObject.remove(T.distanceInfo.secondSelObj),T.distanceInfo.FstToFstPointLine&&(T.OpMeasure.rootObject.remove(T.distanceInfo.FstToFstPointLine),x.add(T.distanceInfo.FstToFstPointLine)),T.distanceInfo.SndToSndPointLine&&(T.OpMeasure.rootObject.remove(T.distanceInfo.SndToSndPointLine),x.add(T.distanceInfo.SndToSndPointLine)),T.distanceInfo.axisLineObj&&(T.OpMeasure.rootObject.remove(T.distanceInfo.axisLineObj),x.add(T.distanceInfo.axisLineObj)),T.distanceInfo.secaxisLineObj&&(T.OpMeasure.rootObject.remove(T.distanceInfo.secaxisLineObj),x.add(T.distanceInfo.secaxisLineObj)),x.add(T.distanceInfo.fstToSndLine),x.add(T.distanceInfo.firstSelObj),x.add(T.distanceInfo.secondSelObj),T.OpMeasure.rootObject.add(x),NDSWebViewer.COMMON.isMobileDevice()?(M.textBox.addEventListener("touchstart",this.touchstart,!1),M.textBox.addEventListener("touchend",this.touchend,!1),M.textBox.addEventListener("touchmove",this.touchmove,!1)):(M.textBox.addEventListener("mousedown",this.touchstart,!1),M.textBox.addEventListener("mouseup",this.touchend,!1),M.textBox.addEventListener("mousemove",this.touchmove,!1),M.textBox.addEventListener("mouseleave",this.mouseleave,!1),M.textBox.addEventListener("mouseenter",this.mouseenter,!1)),NDSWebViewer.COMMON.isMobileDevice()?h.addEventListener("touchend",this.sectionCrossend,!1):(h.addEventListener("mousedown",this.sectionCrossend,!1),h.addEventListener("mouseleave",this.crossleave,!1),h.addEventListener("mouseenter",this.crossenter,!1)),(y={}).start=this.distanceInfo.textPos.clone(),y.end=O.clone(),y.uuid=x.uuid,this.OpMeasure.textLines.push(y),M.textBox.setAttribute("mobile","up"),M.textBox.setAttribute("group",x.uuid),this.OpMeasure.currentUuid=x.uuid,M.textBox.setAttribute("type","length"),M.textBox.setAttribute("dimString",this.distanceInfo.dimString),M.textBox.setAttribute("dimStringPrefix",this.distanceInfo.dimStringPrefix),M.textBox.setAttribute("unit",this.distanceInfo.unit),M.textBox.setAttribute("lineInfo",this.OpMeasure.textLines.length-1),this.OpMeasure.boxInfos.push(M),this.OpMeasure.unsteadyData[x.uuid]=this.DeepCopy(this.distanceInfo,"Distance"),this.OpMeasure.unsteadyData[x.uuid].p1=n,this.OpMeasure.unsteadyData[x.uuid].p2=i,this.clearDistanceInfo(!0),NDSWebViewer.COMMON.isMobileDevice())&&this.ChangeMeasureFlag()},i.prototype.changeMeasureDistance=function(e){var t=this.OpMeasure.unsteadyData[this.OpMeasure.unsteadyuuid],n=(t.textPos&&e&&((i=new THREE.Plane).setFromCoplanarPoints(t.p1,t.fstClndPos,t.sndClndPos),i.normal.length()<1e-8&&i.setFromCoplanarPoints(t.p2,t.fstClndPos,t.sndClndPos),i.normal.length()<1e-8&&i.setFromCoplanarPoints(t.p1.clone().add(new THREE.Vector3(1,-1,1)),t.fstClndPos,t.sndClndPos),i.normal.length()<1e-8&&i.setFromCoplanarPoints(t.p1,t.fstClndPos.clone().add(new THREE.Vector3(1,-1,1)),t.sndClndPos),i.normal.length()<1e-8&&i.setFromCoplanarPoints(t.p1,t.fstClndPos,t.sndClndPos.clone().add(new THREE.Vector3(1,-1,1))),e=this.clientCoordToModelCoordOnPlane(e.x,e.y,i))&&t.textPos.copy(e),null),n=("Lineargauge3D"==this.measureClass?t.fstClndPos.clone().add(t.sndClndPos):t.firstPoint.clone().add(t.secondPoint)).divideScalar(2),i=this.get2dPoint(t.textPos.clone()),e=this.get2dPoint(n.clone()),i=new THREE.Vector2(i.x-e.x,i.y-e.y);i.normalize(),i.y>=i.x/2&&i.y>=-i.x/2?(this.OpMeasure.unsteadyTextBox.childNodes[1].style.left="calc(50% - 6px)",this.OpMeasure.unsteadyTextBox.childNodes[1].style.top="-5.5px",this.OpMeasure.unsteadyTextBox.setAttribute("mobile","down")):i.y>i.x/2&&i.y<-i.x/2?(this.OpMeasure.unsteadyTextBox.childNodes[1].style.left="calc(100% - 4px)",this.OpMeasure.unsteadyTextBox.childNodes[1].style.top="calc(50% - 5.5px)",this.OpMeasure.unsteadyTextBox.setAttribute("mobile","right")):i.y<i.x/2&&i.y<-i.x/2?(this.OpMeasure.unsteadyTextBox.childNodes[1].style.left="calc(50% - 6px)",this.OpMeasure.unsteadyTextBox.childNodes[1].style.top="calc(100% - 5.5px)",this.OpMeasure.unsteadyTextBox.setAttribute("mobile","up")):i.y<i.x/2&&i.y>-i.x/2&&(this.OpMeasure.unsteadyTextBox.childNodes[1].style.left="-5.5px",this.OpMeasure.unsteadyTextBox.childNodes[1].style.top="calc(50% - 5.5px)",this.OpMeasure.unsteadyTextBox.setAttribute("mobile","left"));for(var s=0;s<this.OpMeasure.boxInfos.length;s++){var o=this.OpMeasure.boxInfos[s];if(o.textBox.getAttribute("group")==this.OpMeasure.unsteadyuuid){o.textPos=t.textPos;break}}for(s=0;s<this.OpMeasure.textLines.length;s++){var r=this.OpMeasure.textLines[s];if(r.uuid==this.OpMeasure.unsteadyuuid){r.start=t.textPos.clone(),r.end=n.clone();break}}this.OpMeasure.viewer.render()},i.prototype.getClosePoint=function(e,t){if(e&&e.parentObj instanceof THREE.Mesh){var n=e.geometry,i=e.indexRange.concat();if(this.viewer.ndsModel&&(i[0]+=n.drawRange.start/3,i[1]+=n.drawRange.start/3),n.isBufferGeometry)for(var s=n.index,o=n.attributes.position,r=new THREE.Vector3,a=1/0,l=i[0],d=i[1];l<=d;l++){var c=3*l,h=s.getX(c),f=s.getX(1+c),c=s.getX(2+c),I=new THREE.Vector3,u=new THREE.Vector3,p=new THREE.Vector3,h=(I.fromBufferAttribute(o,h),u.fromBufferAttribute(o,f),p.fromBufferAttribute(o,c),I.applyMatrix4(e.matrixWorld),u.applyMatrix4(e.matrixWorld),p.applyMatrix4(e.matrixWorld),new THREE.Triangle(I,u,p));if(h.containsPoint(t))return t;f=new THREE.Vector3;h.closestPointToPoint(t,f),t.distanceTo(f)<a&&(a=t.distanceTo(f),r=f.clone()),f=p=u=I=null}return r}},i.prototype.getLinePrecision=function(){var e=this.viewer.clientCoordToModelCoord([0,0]),e=new THREE.Vector3(e[0],e[1],e[2]),t=this.viewer.clientCoordToModelCoord([4,0]),t=new THREE.Vector3(t[0],t[1],t[2]);return e.distanceTo(t)},i.prototype.getUnitString=function(){var e="mm";if(this.viewer.modelUnit)switch(this.viewer.modelUnit.toLowerCase()){case"meter":e="m";break;case"centimeter":e="cm";break;case"millimeter":e="mm";break;case"um":e="um";break;case"inch":e="in";break;case"feet":e="ft"}return e},i.prototype.getUnitStringmap=function(e){var t="mm";if(e)switch(e.toLowerCase()){case"meter":t="m";break;case"centimeter":t="cm";break;case"millimeter":t="mm";break;case"inch":t="in";break;case"um":t="um";break;case"feet":t="ft"}return t},i.prototype.OperatorRelease=function(){this.OperatorEnd(),this.measureType="",this.OpMeasure.prompt&&(this.viewer.container.removeChild(this.OpMeasure.prompt),this.OpMeasure.prompt=null)},i.prototype.getViewClientCoords=function(e){var t=e.offsetX||e.clientX-this.viewer.container.getBoundingClientRect().left,n=e.offsetY||e.clientY-this.viewer.container.getBoundingClientRect().top;return e.srcElement&&e.srcElement!==this.viewer.renderer.domElement&&(t=e.clientX-this.viewer.container.getBoundingClientRect().left,n=e.clientY-this.viewer.container.getBoundingClientRect().top),null==e.srcElement&&e.target&&e.target!==this.viewer.renderer.domElement&&(t=e.clientX-this.viewer.container.getBoundingClientRect().left,n=e.clientY-this.viewer.container.getBoundingClientRect().top),new THREE.Vector2(t,n)},i.prototype.isZero=function(e){return Math.abs(e)<1e-6},i.prototype.isPointBetweenIn=function(e,t,n){var i;return!!(e&&t&&n)&&(i=t.distanceTo(n),t=e.distanceTo(t),e=e.distanceTo(n),this.isZero(i-t-e))},i.prototype.getAngle=function(e,t,n){return e&&t&&n?(e=(new THREE.Vector3).subVectors(e,t),n=(new THREE.Vector3).subVectors(n,t),e.angleTo(n)):0},i.prototype.getBaceFaceDir=function(e){var t,n,i,s,o,r,a,l,d,c,h,f;return e?(t=new THREE.Vector3(0,0,1),n=new THREE.Vector3(0,0,-1),i=new THREE.Vector3(1,0,0),s=new THREE.Vector3(-1,0,0),o=new THREE.Vector3(0,1,0),r=new THREE.Vector3(0,-1,0),a=e.angleTo(t),l=e.angleTo(n),d=e.angleTo(i),c=e.angleTo(s),h=e.angleTo(o),e=e.angleTo(r),f=Math.min(a,l),f=Math.min(f,d),f=Math.min(f,c),f=Math.min(f,h),f=Math.min(f,e),Math.abs(a-f)<1e-6?t:Math.abs(l-f)<1e-6?n:Math.abs(d-f)<1e-6?i:Math.abs(c-f)<1e-6?s:Math.abs(h-f)<1e-6?o:r):new THREE.Vector3(0,0,1)},i.prototype.getProjectPntToPlane=function(e,t,n,i){t=(new THREE.Vector3).subVectors(t,e),n=(new THREE.Vector3).subVectors(n,e),t=(new THREE.Vector3).crossVectors(t,n);t.normalize();n=(new THREE.Vector3).subVectors(i,e).dot(t);return i.clone().sub(t.multiplyScalar(n))},i.prototype.getProjectPntToLine=function(e,t,n){return e.equals(t)?e.clone():((t=(new THREE.Vector3).subVectors(t,e)).normalize(),n=(new THREE.Vector3).subVectors(n,e),n=t.dot(n),e.clone().add(t.multiplyScalar(n)))},i.prototype.clientCoordToModelCoordOnPlane=function(e,t,n){e=[e,t,.99],t=this.viewer.clientCoordToModelCoord(e),t=new THREE.Vector3(t[0],t[1],t[2]),e[2]=-.99,e=this.viewer.clientCoordToModelCoord(e),e=new THREE.Vector3(e[0],e[1],e[2]);return this.intersectLine(t,e,n)},i.prototype.intersectLine=function(e,t,n){var i,s;return!(e&&t&&n)||(i=e.clone(),(e=(new THREE.Vector3).subVectors(t,e)).normalize(),s=e.dot(n.normal),Math.abs(s)<=1e-8)?null:(t=n.coplanarPoint(t.clone()),t=(new THREE.Vector3).subVectors(t,i).dot(n.normal)/s,i.add(e.multiplyScalar(t)))},i.prototype.createBoundingBox=function(e,t){var n=new Float32Array(24),e=(n[0]=e.max.x,n[1]=e.max.y,n[2]=e.max.z,n[3]=e.max.x,n[4]=e.max.y,n[5]=e.min.z,n[6]=e.min.x,n[7]=e.max.y,n[8]=e.min.z,n[9]=e.min.x,n[10]=e.max.y,n[11]=e.max.z,n[12]=e.max.x,n[13]=e.min.y,n[14]=e.max.z,n[15]=e.max.x,n[16]=e.min.y,n[17]=e.min.z,n[18]=e.min.x,n[19]=e.min.y,n[20]=e.min.z,n[21]=e.min.x,n[22]=e.min.y,n[23]=e.max.z,new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7])),i=new THREE.BufferGeometry;return i.setIndex(new THREE.BufferAttribute(e,1)),i.addAttribute("position",new THREE.BufferAttribute(n,3)),(e=new THREE.LineSegments(i,t||this.materialBoxLine)).objectType="BoundingBox",e},i.prototype.createBoundingBoxModel=function(e){var t=new Float32Array(24),n=(t[0]=e.max.x,t[1]=e.max.y,t[2]=e.max.z,t[3]=e.max.x,t[4]=e.max.y,t[5]=e.min.z,t[6]=e.min.x,t[7]=e.max.y,t[8]=e.min.z,t[9]=e.min.x,t[10]=e.max.y,t[11]=e.max.z,t[12]=e.max.x,t[13]=e.min.y,t[14]=e.max.z,t[15]=e.max.x,t[16]=e.min.y,t[17]=e.min.z,t[18]=e.min.x,t[19]=e.min.y,t[20]=e.min.z,t[21]=e.min.x,t[22]=e.min.y,t[23]=e.max.z,[0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]),i=new Float32Array(72);for(let e=0;e<n.length;e++){var s=n[e];i[3*e]=t[3*s],i[3*e+1]=t[3*s+1],i[3*e+2]=t[3*s+2]}var e=new NDSWebViewer.LineSegmentsGeometry,o=(e.setPositions(i),new NDSWebViewer.LineMaterial({linewidth:2,opacity:1,color:new THREE.Color("rgb(237, 255, 105)"),side:THREE.DoubleSide,depthTest:!1,depthWrite:!0})),r=this.renderer.getPixelRatio(),a=this.renderer.domElement.width/r,r=this.renderer.domElement.height/r;return o.resolution.set(a,r),new NDSWebViewer.LineSegments2(e,o)},(o.prototype=Object.create(i.prototype)).OperatorStart=function(e){switch(this.measureType=e,this.measureType){case"pt2pt":this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.FIRSTPOINT);break;case"PointToLine":case"PointToFace":case"AxisToPoint":this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.POINT);break;case"pt2ptbim":this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.FIRSTPOINT);break;case"LineToLine":this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.FIRSTLINE);break;case"LineToFace":this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.LINEPLANE);break;case"faceDist":this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.PLANE);break;case"AxisToLine":this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.AXISLINE);break;case"AxisToFace":this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.AXISPLANE);break;case"holeDist":this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.CIRCLEBEGIN);break;case"bodyDistance":this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.FIRMEASUREBODY)}},o.prototype.onNMouseMove=function(e,t){var n=new THREE.Vector3(e,t,0);if(this.OpMeasure.unsteady)this.changeMeasureDistance(n);else if(this.distanceInfo.firstSelObj&&this.distanceInfo.secondSelObj&&!NDSWebViewer.COMMON.isMobileDevice())this.createAndShowDistanceDimension(n);else{var i=[];switch(this.measureType){case"bodyDistance":i=4<this.viewer.brepManager.version?["point","line","plane","circle","cylinder","cone"]:["point","line","plane","circle","cylinder"];break;case"PointToLine":this.distanceInfo.firstSelInfo||this.distanceInfo.secondSelInfo?"point"==this.distanceInfo.firstSelInfo.type&&(i=["line","edge"]):i=["point"];break;case"PointToFace":this.distanceInfo.firstSelInfo||this.distanceInfo.secondSelInfo?"point"==this.distanceInfo.firstSelInfo.type&&(i=["plane","face"]):i=["point"];break;case"holeDist":this.distanceInfo.firstSelInfo||this.distanceInfo.secondSelInfo?"circle"==this.distanceInfo.firstSelInfo.type?i=["circle"]:"cylinder"!=this.distanceInfo.firstSelInfo.type&&"cone"!=this.distanceInfo.firstSelInfo.type||(i=["cylinder","cone"]):i=["circle","cylinder","cone"];break;case"AxisToPoint":this.distanceInfo.firstSelInfo||this.distanceInfo.secondSelInfo?"point"==this.distanceInfo.firstSelInfo.type&&(i=["circle","cylinder"]):i=["point"];break;case"LineToLine":i=["line"];break;case"LineToFace":this.distanceInfo.firstSelInfo||this.distanceInfo.secondSelInfo?"line"==this.distanceInfo.firstSelInfo.type?i=["plane"]:"plane"==this.distanceInfo.firstSelInfo.type&&(i=["line"]):i=["line","plane"];break;case"faceDist":i=["plane"];break;case"AxisToLine":this.distanceInfo.firstSelInfo||this.distanceInfo.secondSelInfo?"line"==this.distanceInfo.firstSelInfo.type?i=["circle","cylinder"]:"circle"!=this.distanceInfo.firstSelInfo.type&&"cylinder"!=this.distanceInfo.firstSelInfo.type||(i=["line"]):i=["line","circle","cylinder"];break;case"AxisToFace":this.distanceInfo.firstSelInfo||this.distanceInfo.secondSelInfo?"plane"==this.distanceInfo.firstSelInfo.type?i=["circle","cylinder"]:"circle"!=this.distanceInfo.firstSelInfo.type&&"cylinder"!=this.distanceInfo.firstSelInfo.type||(i=["plane"]):i=["plane","circle","cylinder"];break;case"pt2pt":case"pt2ptbim":i=["point"];break;default:return}this.measureDistance(e,t,!0,i),this.updateMeasureDistanceScene("true")}},o.prototype.onLMouseClick=function(e,t,n){var i=new THREE.Vector3(e,t,0);if(this.OpMeasure.PostInfo(),this.distanceInfo.firstSelObj&&this.distanceInfo.secondSelObj)this.viewer.is2DModel?this.createAndShowDistanceDimension(i,!0):this.createAndShow3DDistanceDimension(i,!0),this.OperatorStart(this.measureType);else{var s=[];switch(this.measureType){case"bodyDistance":s=4<this.viewer.brepManager.version?["point","line","plane","circle","cylinder","cone"]:["point","line","plane","circle","cylinder"];break;case"PointToLine":this.distanceInfo.firstSelInfo||this.distanceInfo.secondSelInfo?"point"==this.distanceInfo.firstSelInfo.type&&(s=["line","edge"]):s=["point"];break;case"holeDist":this.distanceInfo.firstSelInfo||this.distanceInfo.secondSelInfo?"circle"==this.distanceInfo.firstSelInfo.type?s=["circle"]:"cylinder"!=this.distanceInfo.firstSelInfo.type&&"cone"!=this.distanceInfo.firstSelInfo.type||(s=["cylinder","cone"]):s=["circle","cylinder","cone"];break;case"PointToFace":this.distanceInfo.firstSelInfo||this.distanceInfo.secondSelInfo?"point"==this.distanceInfo.firstSelInfo.type&&(s=["plane","face"]):s=["point"];break;case"AxisToPoint":this.distanceInfo.firstSelInfo||this.distanceInfo.secondSelInfo?"point"==this.distanceInfo.firstSelInfo.type&&(s=["circle","cylinder"]):s=["point"];break;case"LineToLine":s=["line"];break;case"LineToFace":this.distanceInfo.firstSelInfo||this.distanceInfo.secondSelInfo?"line"==this.distanceInfo.firstSelInfo.type?s=["plane"]:"plane"==this.distanceInfo.firstSelInfo.type&&(s=["line"]):s=["line","plane"];break;case"faceDist":s=["plane"];break;case"AxisToLine":this.distanceInfo.firstSelInfo||this.distanceInfo.secondSelInfo?"line"==this.distanceInfo.firstSelInfo.type?s=["circle","cylinder"]:"circle"!=this.distanceInfo.firstSelInfo.type&&"cylinder"!=this.distanceInfo.firstSelInfo.type||(s=["line"]):s=["line","circle","cylinder"];break;case"AxisToFace":this.distanceInfo.firstSelInfo||this.distanceInfo.secondSelInfo?"plane"==this.distanceInfo.firstSelInfo.type?s=["circle","cylinder"]:"circle"!=this.distanceInfo.firstSelInfo.type&&"cylinder"!=this.distanceInfo.firstSelInfo.type||(s=["plane"]):s=["plane","circle","cylinder"];break;case"pt2pt":case"pt2ptbim":s=["point"]}switch(this.measureDistance(e,t,!1,s),this.updateMeasureDistanceScene("false"),this.measureType){case"pt2pt":case"pt2ptbim":this.distanceInfo.firstSelInfo&&"point"==this.distanceInfo.firstSelInfo.type&&!this.distanceInfo.secondSelInfo?this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.SECONDPOINT):this.distanceInfo.firstSelInfo&&this.distanceInfo.secondSelInfo?this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.ENDMEASURE):this.distanceInfo.firstSelInfo||this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.FIRSTPOINT);break;case"PointToLine":this.distanceInfo.firstSelInfo&&"point"==this.distanceInfo.firstSelInfo.type&&!this.distanceInfo.secondSelInfo?this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.LINEANDCIRCLE):this.distanceInfo.firstSelInfo&&this.distanceInfo.secondSelInfo?this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.ENDMEASURE):this.distanceInfo.firstSelInfo||this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.POINT);break;case"PointToFace":this.distanceInfo.firstSelInfo&&"point"==this.distanceInfo.firstSelInfo.type&&!this.distanceInfo.secondSelInfo&&this.OpMeasure.InfoType<=NDSWebViewer.NDS.INFOTYPE.MEASURENOTICEBEGIN?this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.FACE):this.distanceInfo.firstSelInfo&&this.distanceInfo.secondSelInfo?this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.ENDMEASURE):this.distanceInfo.firstSelInfo||this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.POINT);break;case"AxisToPoint":this.distanceInfo.firstSelInfo&&"point"==this.distanceInfo.firstSelInfo.type&&!this.distanceInfo.secondSelInfo?this.viewer.is2DModel?this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.CIRCLEA):this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.AXIS):!this.distanceInfo.firstSelInfo||"circle"!=this.distanceInfo.firstSelInfo.type&&"cylinder"!=this.distanceInfo.firstSelInfo.type||this.distanceInfo.secondSelInfo?this.distanceInfo.firstSelInfo&&this.distanceInfo.secondSelInfo?this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.ENDMEASURE):this.distanceInfo.firstSelInfo||this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.POINT):this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.POINT);break;case"LineToLine":this.distanceInfo.firstSelInfo&&!this.distanceInfo.secondSelInfo&&this.OpMeasure.InfoType!=NDSWebViewer.NDS.INFOTYPE.INTERSECT?this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.SECONDLINE):this.distanceInfo.firstSelInfo&&this.distanceInfo.secondSelInfo?this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.ENDMEASURE):this.distanceInfo.firstSelInfo||this.distanceInfo.secondSelInfo||this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.FIRSTLINE);break;case"LineToFace":this.distanceInfo.firstSelInfo&&"plane"==this.distanceInfo.firstSelInfo.type&&!this.distanceInfo.secondSelInfo&&this.OpMeasure.InfoType!=NDSWebViewer.NDS.INFOTYPE.LINENOPARALLEL?this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.PARALLELLINE):this.distanceInfo.firstSelInfo&&"line"==this.distanceInfo.firstSelInfo.type&&!this.distanceInfo.secondSelInfo&&NDSWebViewer.NDS.INFOTYPE.PLANENOPARALLEL!=this.OpMeasure.InfoType&&this.OpMeasure.InfoType!=NDSWebViewer.NDS.INFOTYPE.NOTFACEPARALLEL?this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.FIRSTPARALLELPLANE):this.distanceInfo.firstSelInfo&&this.distanceInfo.secondSelInfo?this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.ENDMEASURE):this.distanceInfo.firstSelInfo||this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.LINEPLANE);break;case"faceDist":this.distanceInfo.firstSelInfo&&!this.distanceInfo.secondSelInfo&&this.OpMeasure.InfoType!=NDSWebViewer.NDS.INFOTYPE.PLANENOPARALLEL&&this.OpMeasure.InfoType!=NDSWebViewer.NDS.INFOTYPE.NOTFACEPARALLEL?this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.PARALLELPLANE):this.distanceInfo.firstSelInfo?this.distanceInfo.firstSelInfo&&this.distanceInfo.secondSelInfo&&this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.ENDMEASURE):this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.PLANE);break;case"AxisToLine":this.distanceInfo.firstSelInfo&&"line"==this.distanceInfo.firstSelInfo.type&&!this.distanceInfo.secondSelInfo?this.viewer.is2DModel?this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.CIRCLEA):this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.AXIS):!this.distanceInfo.firstSelInfo||"circle"!=this.distanceInfo.firstSelInfo.type&&"cylinder"!=this.distanceInfo.firstSelInfo.type||this.distanceInfo.secondSelInfo?this.distanceInfo.firstSelInfo&&this.distanceInfo.secondSelInfo?this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.ENDMEASURE):this.distanceInfo.firstSelInfo||this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.AXISLINE):this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.LINE);break;case"AxisToFace":this.distanceInfo.firstSelInfo&&"plane"==this.distanceInfo.firstSelInfo.type&&!this.distanceInfo.secondSelInfo&&NDSWebViewer.NDS.INFOTYPE.AXISNOPARALLEL!=this.OpMeasure.InfoType?this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.AXIS):this.distanceInfo.firstSelInfo&&this.distanceInfo.secondSelInfo?this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.ENDMEASURE):this.distanceInfo.firstSelInfo||this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.AXISPLANE),this.distanceInfo.firstSelInfo&&("circle"==this.distanceInfo.firstSelInfo.type||"cylinder"==this.distanceInfo.firstSelInfo.type)&&!this.distanceInfo.secondSelInfo&&this.OpMeasure.InfoType<=NDSWebViewer.NDS.INFOTYPE.MEASURENOTICEBEGIN&&this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.PARALLELPLANE);break;case"holeDist":this.distanceInfo.firstSelInfo&&!this.distanceInfo.secondSelInfo&&this.OpMeasure.InfoType<=NDSWebViewer.NDS.INFOTYPE.MEASURENOTICEBEGIN?"circle"==this.distanceInfo.firstSelInfo.type?this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.CIRCLECENTER):"cylinder"!=this.distanceInfo.firstSelInfo.type&&"cone"!=this.distanceInfo.firstSelInfo.type||this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.CIRCLECYLINDER):this.distanceInfo.firstSelInfo&&this.distanceInfo.secondSelInfo?this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.ENDMEASURE):this.distanceInfo.firstSelInfo||this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.CIRCLEBEGIN);break;case"bodyDistance":this.distanceInfo.firstSelInfo&&!this.distanceInfo.secondSelInfo&&this.OpMeasure.InfoType<=NDSWebViewer.NDS.INFOTYPE.MEASURENOTICEBEGIN?this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.SECMEASUREBODY):this.distanceInfo.firstSelInfo&&this.distanceInfo.secondSelInfo?this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.ENDMEASURE):this.distanceInfo.firstSelInfo||this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.FIRMEASUREBODY)}}},o.prototype.calculateDistanceFromPoint=function(e){var t,n=0;if("point"==e.firstSelInfo.type){if((n=e.firstSelInfo.point.distanceTo(e.secondSelInfo.point))<1e-10)return void(e.secondSelInfo=null);e.dimString=n.toFixed(8)}else"line"==e.firstSelInfo.type?(i=this.getLineStartEndPoints(e.firstSelInfo))&&(n=(t=new THREE.Line3(i.start,i.end).closestPointToPoint(e.secondSelInfo.point,!1)).distanceTo(e.secondSelInfo.point),e.dimString=n.toFixed(8),e.firstPoint=t):"circle"==e.firstSelInfo.type||"cylinder"==e.firstSelInfo.type||"cone"==e.firstSelInfo.type?"bodyDistance"==this.measureType&&"circle"==e.firstSelInfo.type?(i=this.getLineStartEndPoints(e.firstSelInfo))&&(n=e.secondSelInfo.point.distanceTo(i.start),e.dimString=n.toFixed(8),e.firstPoint=i.start):(i=this.getLineStartEndPoints(e.firstSelInfo))&&(n=(t=new THREE.Line3(i.start,i.end).closestPointToPoint(e.secondSelInfo.point,!1)).distanceTo(e.secondSelInfo.point),e.dimString=n.toFixed(8),e.firstPoint=t):"plane"==e.firstSelInfo.type&&((i=new THREE.Plane).setFromNormalAndCoplanarPoint(e.firstSelInfo.worldNormal,e.firstSelInfo.worldOrigin),t=new THREE.Vector3,i.projectPoint(e.secondSelInfo.point,t),n=t.distanceTo(e.secondSelInfo.point),e.dimString=n.toFixed(8),e.firstPoint=t);var i=this.viewer.getDispalyModelUnit(n=n<1&&.999999<n?1:n);n*=i.scale,e.unit=this.getUnitStringmap(i.unit),e.dimString=n.toFixed(8)},o.prototype.measureDistance=function(e,t,n,i){""==this.distanceInfo.unit&&(this.distanceInfo.unit=this.getUnitString()),i=i||(this.viewer.is2DModel?["line","circle","point"]:["line","circle","cylinder","plane","point","cone"]);var s=null,s=this.doRaycasterPick(e,t,!0);if(-1!=i.indexOf("circle")&&(n||"holeDist"==this.measureType)&&((o=this.doCircleCentersRayPick(e,t))&&(s=s&&0!=s.length&&o[0].distance>s[0].distance?s:o),o=this.previewSnappedPoint3(s,!1,e,t))&&(s=o),-1!=i.indexOf("point")&&n&&((o=this.doCircleCentersRayPick(e,t))&&(s=s&&0!=s.length&&o[0].distance>s[0].distance?s:o),this.previewSnappedPoint3(s,!0,e,t)),null!=this.snappedPoint)this.preSelClear(),n||(null==this.distanceInfo.firstSelInfo?(this.distanceInfo.firstSelInfo={type:"point",point:this.snappedPoint.clone()},this.distanceInfo.firstPoint=this.distanceInfo.firstSelInfo.point):"bodyDistance"==this.measureType&&"point"==this.distanceInfo.firstSelInfo.type&&this.isTwoPointTheSame(this.distanceInfo.firstSelInfo.point,this.snappedPoint)?(this.distanceInfo.firstSelObj&&(this.OpMeasure.rootObject.remove(this.distanceInfo.firstSelObj),this.distanceInfo.firstSelObj=null,this.distanceInfo.firstSelInfo=null),this.distanceInfo.axisLineObj&&(this.OpMeasure.rootObject.remove(this.distanceInfo.axisLineObj),this.distanceInfo.axisLineObj=null)):(this.distanceInfo.secondSelInfo={type:"point",point:this.snappedPoint.clone()},this.distanceInfo.secondPoint=this.distanceInfo.secondSelInfo.point,this.calculateDistanceFromPoint(this.distanceInfo)),this.snappedPoint=null,this.distanceInfo.snapPreSelInfo=null);else{var o=this.viewer;if(s&&0!=s.length){e=null;if(e=!o.ndsModel&&!(s[0].object instanceof THREE.Line||s[0].object instanceof THREE.LineSegments)&&1<s.length&&(s[1].object instanceof THREE.Line||s[1].object instanceof THREE.LineSegments)&&(g=Math.abs(s[1].distance-s[0].distance))<linePrecision?s[1]:s[0]){var r,t=this.getSelectInfoFromIntersect(e);if(t)if("bodyDistance"==this.measureType&&-1==i.indexOf(t.type))this.distanceInfo.preSelInfo=null,this.preSelClear();else if("line"!=t.type||this.Bline(t))if(1==n)-1==i.indexOf(t.type)&&-1==i.indexOf(t.topolType)?this.preSelClear():this.isTwoTopolInfoTheSame(this.distanceInfo.preSelInfo,t)||(this.preSelClear(),this.distanceInfo.preSelInfo=t);else if(-1!=i.indexOf(t.topolType)||-1!=i.indexOf(t.type)||-1==i.indexOf("plane")||"cylinder"!==t.type&&"other"!==t.type&&"nurbs"!==t.type)if(this.OpMeasure.InfoType>NDSWebViewer.NDS.INFOTYPE.MEASURENOTICEBEGIN&&(this.OpMeasure.InfoType=NDSWebViewer.NDS.INFOTYPE.MEASURENOTICEBEGIN),this.distanceInfo.preSelInfo=null,this.distanceInfo.snapPreSelInfo=null,this.preSelClear(),-1!=i.indexOf("point")&&-1==i.indexOf(t.type))r=t.intersect.clone(),null==this.distanceInfo.firstSelInfo?(this.distanceInfo.firstPoint=r,this.distanceInfo.firstSelInfo={type:"point",point:r}):(this.distanceInfo.secondSelInfo={type:"point",point:r},this.distanceInfo.secondPoint=this.distanceInfo.secondSelInfo.point,this.calculateDistanceFromPoint(this.distanceInfo));else if(this.distanceInfo.firstSelInfo)if(this.isTwoTopolInfoTheSame(this.distanceInfo.firstSelInfo,t))this.distanceInfo.firstSelObj&&(this.OpMeasure.rootObject.remove(this.distanceInfo.firstSelObj),this.distanceInfo.firstSelObj=null,this.distanceInfo.firstSelInfo=null),this.distanceInfo.axisLineObj&&(this.OpMeasure.rootObject.remove(this.distanceInfo.axisLineObj),this.distanceInfo.axisLineObj=null);else{if(this.distanceInfo.firstSelInfo&&"circle"==this.distanceInfo.firstSelInfo.type&&"circle"==t.type){var o=this.distanceInfo.firstSelInfo.center,s=t.center,o=new THREE.Vector3(o[0],o[1],o[2]).applyMatrix4(this.distanceInfo.firstSelInfo.matrixWorld),s=new THREE.Vector3(s[0],s[1],s[2]).applyMatrix4(t.matrixWorld);if(o.distanceTo(s)<1e-4)return}if(-1!=i.indexOf(t.type)||-1!=i.indexOf("point")||-1!=i.indexOf(t.topolType)){if("line"==this.distanceInfo.firstSelInfo.type){var a=this.getLineStartEndPoints(this.distanceInfo.firstSelInfo);if("line"==t.type){var l=this.getLineStartEndPoints(t);if(a&&l){(P=(new THREE.Vector3).subVectors(a.end,a.start)).normalize();(T=(new THREE.Vector3).subVectors(l.end,l.start)).normalize();var d=P.dot(T);if(1-Math.abs(d)<1e-4){if((g=(x=new THREE.Line3(a.start,a.end).closestPointToPoint(l.start,!1)).distanceTo(l.start))<1e-5)return void this.OpMeasure.PostInfo("bodyDistance"==this.measureType?NDSWebViewer.NDS.INFOTYPE.TWOBODYNOTPARALLEL:NDSWebViewer.NDS.INFOTYPE.INTERSECT);this.distanceInfo.dimString=g.toFixed(8),this.distanceInfo.secondSelInfo=t,this.distanceInfo.firstPoint=x,this.distanceInfo.secondPoint=l.start.clone()}else{var c=l.start.clone().sub(a.start),h=Math.pow(P.clone().cross(T).length(),2),f=c.clone().cross(T).dot(P.clone().cross(T))/h,I=c.clone().cross(P).dot(P.clone().cross(T))/h,u=P.clone().multiplyScalar(f).add(a.start),p=T.clone().multiplyScalar(I).add(l.start);if((g=u.distanceTo(p))<1e-5)return void this.OpMeasure.PostInfo("bodyDistance"==this.measureType?NDSWebViewer.NDS.INFOTYPE.TWOBODYNOTPARALLEL:NDSWebViewer.NDS.INFOTYPE.INTERSECT);this.distanceInfo.secondSelInfo=t,this.distanceInfo.dimString=g.toFixed(8),this.distanceInfo.firstPoint=u,this.distanceInfo.secondPoint=p}}}else"plane"==t.type?((P=(new THREE.Vector3).subVectors(a.end,a.start)).normalize(),Math.abs(t.worldNormal.dot(P))<1e-5?(this.distanceInfo.secondSelInfo=t,(M=new THREE.Plane).setFromNormalAndCoplanarPoint(t.worldNormal,t.worldOrigin),S=new THREE.Vector3,M.projectPoint(a.start,S),g=S.distanceTo(a.start),this.distanceInfo.dimString=g.toFixed(8),this.distanceInfo.firstPoint=a.start.clone(),this.distanceInfo.secondPoint=S):this.OpMeasure.PostInfo("bodyDistance"==this.measureType?NDSWebViewer.NDS.INFOTYPE.TWOBODYNOTPARALLEL:NDSWebViewer.NDS.INFOTYPE.PLANENOPARALLEL)):"circle"!=t.type&&"cylinder"!=t.type&&"cone"!=t.type||(l=this.getLineStartEndPoints(t),"bodyDistance"==this.measureType&&"circle"==t.type?a&&l&&(g=(x=new THREE.Line3(a.start,a.end).closestPointToPoint(l.start,!1)).distanceTo(l.start),this.distanceInfo.dimString=g.toFixed(8),this.distanceInfo.firstPoint=x,this.distanceInfo.secondPoint=l.start.clone(),this.distanceInfo.secondSelInfo=t):a&&l&&((P=(new THREE.Vector3).subVectors(a.end,a.start)).normalize(),(T=(new THREE.Vector3).subVectors(l.end,l.start)).normalize(),d=P.dot(T),1-Math.abs(d)<1e-4?(this.distanceInfo.secondSelInfo=t,g=(x=new THREE.Line3(a.start,a.end).closestPointToPoint(l.start,!1)).distanceTo(l.start),this.distanceInfo.dimString=g.toFixed(8),this.distanceInfo.firstPoint=x,this.distanceInfo.secondPoint=l.start.clone()):(c=l.start.clone().sub(a.start),h=Math.pow(P.clone().cross(T).length(),2),f=c.clone().cross(T).dot(P.clone().cross(T))/h,I=c.clone().cross(P).dot(P.clone().cross(T))/h,u=P.clone().multiplyScalar(f).add(a.start),p=T.clone().multiplyScalar(I).add(l.start),g=u.distanceTo(p),this.distanceInfo.secondSelInfo=t,this.distanceInfo.dimString=g.toFixed(8),this.distanceInfo.firstPoint=u,this.distanceInfo.secondPoint=p)))}else if("point"==this.distanceInfo.firstSelInfo.type||"bodyDistance"==this.measureType&&"circle"==this.distanceInfo.firstSelInfo.type){if("bodyDistance"==this.measureType&&"circle"==this.distanceInfo.firstSelInfo.type?(a=this.getLineStartEndPoints(this.distanceInfo.firstSelInfo),this.distanceInfo.firstPoint=a.start.clone()):this.distanceInfo.firstPoint=this.distanceInfo.firstSelInfo.point,"line"==(this.distanceInfo.secondSelInfo=t).type)(a=this.getLineStartEndPoints(t))&&(g=(x=new THREE.Line3(a.start,a.end).closestPointToPoint(this.distanceInfo.firstPoint,!1)).distanceTo(this.distanceInfo.firstPoint),this.distanceInfo.dimString=g.toFixed(8),this.distanceInfo.secondPoint=x);else if("plane"==t.type){(M=new THREE.Plane).setFromNormalAndCoplanarPoint(t.worldNormal,t.worldOrigin);var S=new THREE.Vector3,g=(M.projectPoint(this.distanceInfo.firstPoint,S),S.distanceTo(this.distanceInfo.firstPoint));this.distanceInfo.dimString=g.toFixed(8),this.distanceInfo.secondPoint=S}else if("circle"==t.type||"cylinder"==t.type||"cone"==t.type||"edge"==t.topolType||"face"==t.topolType)if("bodyDistance"==this.measureType&&"circle"==t.type)(a=this.getLineStartEndPoints(t))&&(g=a.start.distanceTo(this.distanceInfo.firstPoint),this.distanceInfo.dimString=g.toFixed(8),this.distanceInfo.secondPoint=a.start.clone());else if("PointToLine"==this.measureType&&"edge"==t.topolType){var E=this.getLinesByLineInfo(t);let n=1/0;for(let e=0,t=E.length;e<t;++e){var m=new THREE.Vector3;E[e].closestPointToPoint(this.distanceInfo.firstPoint,!0,m),(g=m.distanceTo(this.distanceInfo.firstPoint))<n&&(n=g,this.distanceInfo.dimString=n.toFixed(8),this.distanceInfo.secondPoint=m)}E.length&&(g=n);o=NDSWebViewer.COMMON.translateString("MINIMUM");this.distanceInfo.dimStringPrefix=(o||"")+":"}else if("PointToFace"==this.measureType&&"face"==t.topolType){var O=this.getFaceTriangles(t);let n=1/0;for(let e=0,t=O.length;e<t;++e){var b=new THREE.Vector3;O[e].closestPointToPoint(this.distanceInfo.firstPoint,b),(g=b.distanceTo(this.distanceInfo.firstPoint))<n&&(n=g,this.distanceInfo.dimString=n.toFixed(8),this.distanceInfo.secondPoint=b)}O.length&&(g=n);s=NDSWebViewer.COMMON.translateString("MINIMUM");this.distanceInfo.dimStringPrefix=(s||"")+":"}else(a=this.getLineStartEndPoints(t))&&(g=(x=new THREE.Line3(a.start,a.end).closestPointToPoint(this.distanceInfo.firstPoint,!1)).distanceTo(this.distanceInfo.firstPoint),this.distanceInfo.dimString=g.toFixed(8),this.distanceInfo.secondPoint=x)}else if("plane"==this.distanceInfo.firstSelInfo.type)"line"==t.type?(a=this.getLineStartEndPoints(t))&&((P=(new THREE.Vector3).subVectors(a.end,a.start)).normalize(),Math.abs(this.distanceInfo.firstSelInfo.worldNormal.dot(P))<1e-5?((M=new THREE.Plane).setFromNormalAndCoplanarPoint(this.distanceInfo.firstSelInfo.worldNormal,this.distanceInfo.firstSelInfo.worldOrigin),S=new THREE.Vector3,M.projectPoint(a.start,S),g=S.distanceTo(a.start),this.distanceInfo.dimString=g.toFixed(8),this.distanceInfo.secondSelInfo=t,this.distanceInfo.firstPoint=S,this.distanceInfo.secondPoint=a.start.clone()):this.OpMeasure.PostInfo("bodyDistance"==this.measureType?NDSWebViewer.NDS.INFOTYPE.TWOBODYNOTPARALLEL:NDSWebViewer.NDS.INFOTYPE.LINENOPARALLEL)):"plane"==t.type?(o=this.distanceInfo.firstSelInfo.worldNormal,s=t.worldNormal.clone(),o.normalize(),s.normalize(),o=Math.abs(o.dot(s)),Math.abs(o-1)<1e-5?(this.distanceInfo.secondSelInfo=t,this.distanceInfo.firstPoint=this.distanceInfo.firstSelInfo.intersect,(M=new THREE.Plane).setFromNormalAndCoplanarPoint(t.worldNormal,t.worldOrigin),S=new THREE.Vector3,M.projectPoint(this.distanceInfo.firstPoint,S),g=S.distanceTo(this.distanceInfo.firstPoint),this.distanceInfo.dimString=g.toFixed(8),this.distanceInfo.secondPoint=S):this.OpMeasure.PostInfo("bodyDistance"==this.measureType?NDSWebViewer.NDS.INFOTYPE.TWOBODYNOTPARALLEL:NDSWebViewer.NDS.INFOTYPE.PLANENOPARALLEL)):"circle"!=t.type&&"cylinder"!=t.type&&"cone"!=t.type||(a=this.getLineStartEndPoints(t),"bodyDistance"==this.measureType&&"circle"==t.type?a&&((M=new THREE.Plane).setFromNormalAndCoplanarPoint(this.distanceInfo.firstSelInfo.worldNormal,this.distanceInfo.firstSelInfo.worldOrigin),S=new THREE.Vector3,M.projectPoint(a.start,S),g=S.distanceTo(a.start),this.distanceInfo.dimString=g.toFixed(8),this.distanceInfo.firstPoint=S,this.distanceInfo.secondPoint=a.start.clone(),this.distanceInfo.secondSelInfo=t):a&&((P=(new THREE.Vector3).subVectors(a.end,a.start)).normalize(),Math.abs(this.distanceInfo.firstSelInfo.worldNormal.dot(P))<1e-5?(this.distanceInfo.secondSelInfo=t,(M=new THREE.Plane).setFromNormalAndCoplanarPoint(this.distanceInfo.firstSelInfo.worldNormal,this.distanceInfo.firstSelInfo.worldOrigin),S=new THREE.Vector3,M.projectPoint(a.start,S),g=S.distanceTo(a.start),this.distanceInfo.dimString=g.toFixed(8),this.distanceInfo.firstPoint=S,this.distanceInfo.secondPoint=a.start.clone()):this.OpMeasure.PostInfo("bodyDistance"==this.measureType?NDSWebViewer.NDS.INFOTYPE.TWOBODYNOTPARALLEL:NDSWebViewer.NDS.INFOTYPE.AXISNOPARALLEL)));else if("circle"==this.distanceInfo.firstSelInfo.type||"cylinder"==this.distanceInfo.firstSelInfo.type||"cone"==this.distanceInfo.firstSelInfo.type){var P,M,a=this.getLineStartEndPoints(this.distanceInfo.firstSelInfo),l=this.getLineStartEndPoints(t);if("line"==t.type||"circle"==t.type||"cylinder"==t.type||"cone"==t.type){if("bodyDistance"==this.measureType&&"circle"==t.type)a&&l&&(g=(x=new THREE.Line3(a.start,a.end).closestPointToPoint(l.start,!1)).distanceTo(l.start),this.distanceInfo.dimString=g.toFixed(8),this.distanceInfo.secondSelInfo=t,this.distanceInfo.firstPoint=x,this.distanceInfo.secondPoint=l.start.clone());else if(a&&l){(P=(new THREE.Vector3).subVectors(a.end,a.start)).normalize();(T=(new THREE.Vector3).subVectors(l.end,l.start)).normalize();var T,d=P.dot(T);if("circle"==this.distanceInfo.firstSelInfo.type&&"circle"==t.type){this.distanceInfo.secondSelInfo=t;var g=a.start.distanceTo(l.start);this.distanceInfo.dimString=g.toFixed(8),this.distanceInfo.firstPoint=a.start.clone(),this.distanceInfo.secondPoint=l.start.clone()}else if(1-Math.abs(d)<1e-4){this.distanceInfo.secondSelInfo=t;var x,g=(x=new THREE.Line3(a.start,a.end).closestPointToPoint(l.start,!1)).distanceTo(l.start);this.distanceInfo.dimString=g.toFixed(8),this.distanceInfo.firstPoint=x,this.distanceInfo.secondPoint=l.start.clone()}else{if("bodyDistance"==this.measureType&&("line"==t.type||"cylinder"==t.type||"cone"==t.type)){c=l.start.clone().sub(a.start),h=Math.pow(P.clone().cross(T).length(),2),f=c.clone().cross(T).dot(P.clone().cross(T))/h,I=c.clone().cross(P).dot(P.clone().cross(T))/h,u=P.clone().multiplyScalar(f).add(a.start),p=T.clone().multiplyScalar(I).add(l.start);if((g=u.distanceTo(p))<1e-5)return void this.OpMeasure.PostInfo("bodyDistance"==this.measureType?NDSWebViewer.NDS.INFOTYPE.TWOBODYNOTPARALLEL:NDSWebViewer.NDS.INFOTYPE.INTERSECT);this.distanceInfo.secondSelInfo=t,this.distanceInfo.dimString=g.toFixed(8),this.distanceInfo.firstPoint=u,this.distanceInfo.secondPoint=p}if("circle"==t.type||"cylinder"==t.type||"cone"==t.type)return void this.OpMeasure.PostInfo("bodyDistance"==this.measureType?NDSWebViewer.NDS.INFOTYPE.TWOBODYNOTPARALLEL:NDSWebViewer.NDS.INFOTYPE.TWOAXISNOPARALLEL);c=l.start.clone().sub(a.start),h=Math.pow(P.clone().cross(T).length(),2),f=c.clone().cross(T).dot(P.clone().cross(T))/h,I=c.clone().cross(P).dot(P.clone().cross(T))/h,u=P.clone().multiplyScalar(f).add(a.start),p=T.clone().multiplyScalar(I).add(l.start);g=u.distanceTo(p),this.distanceInfo.secondSelInfo=t,this.distanceInfo.dimString=g.toFixed(8),this.distanceInfo.firstPoint=u,this.distanceInfo.secondPoint=p}}}else"plane"==t.type&&((P=(new THREE.Vector3).subVectors(a.end,a.start)).normalize(),Math.abs(t.worldNormal.dot(P))<1e-4?((M=new THREE.Plane).setFromNormalAndCoplanarPoint(t.worldNormal,t.worldOrigin),S=new THREE.Vector3,M.projectPoint(a.start,S),g=S.distanceTo(a.start),this.distanceInfo.dimString=g.toFixed(8),this.distanceInfo.secondSelInfo=t,this.distanceInfo.firstPoint=a.start.clone(),this.distanceInfo.secondPoint=S):this.OpMeasure.PostInfo("bodyDistance"==this.measureType?NDSWebViewer.NDS.INFOTYPE.TWOBODYNOTPARALLEL:NDSWebViewer.NDS.INFOTYPE.PLANENOPARALLEL))}s=this.viewer.getDispalyModelUnit(g=g<1&&.999999<g?1:g);g*=s.scale,this.distanceInfo.unit=this.getUnitStringmap(s.unit),this.distanceInfo.dimString=g.toFixed(8)}}else-1==i.indexOf(t.type)&&-1==i.indexOf("point")||(this.distanceInfo.firstSelInfo=t);else this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.NOTFACEPARALLEL),this.distanceInfo.firstSelInfo&&this.isTwoTopolInfoTheSame(this.distanceInfo.firstSelInfo,t)&&(this.distanceInfo.firstSelObj&&(this.OpMeasure.rootObject.remove(this.distanceInfo.firstSelObj),this.distanceInfo.firstSelObj=null,this.distanceInfo.firstSelInfo=null),this.distanceInfo.axisLineObj)&&(this.OpMeasure.rootObject.remove(this.distanceInfo.axisLineObj),this.distanceInfo.axisLineObj=null);else this.preSelClear();else n||-1!=i.indexOf("point")&&(r=e.point,null==this.distanceInfo.firstSelInfo?(this.distanceInfo.firstPoint=r,this.distanceInfo.firstSelInfo={type:"point",point:r}):(this.distanceInfo.secondSelInfo={type:"point",point:r},this.distanceInfo.secondPoint=this.distanceInfo.secondSelInfo.point,this.calculateDistanceFromPoint(this.distanceInfo)))}}else this.preSelClear()}},o.prototype.updateMeasureDistanceScene=function(e){var t;this.distanceInfo.firstSelObj&&this.distanceInfo.secondSelObj?this.preSelClear():!(!e||"true"!==e.toLowerCase())?this.distanceInfo.preSelInfo&&!this.distanceInfo.preSelObj&&("line"==this.distanceInfo.preSelInfo.type||"circle"==this.distanceInfo.preSelInfo.type||"edge"==this.distanceInfo.preSelInfo.topolType?(this.viewer.is2DModel,(t=this.createLine(this.distanceInfo.preSelInfo,!(t=null)))&&(this.OpMeasure.rootObject.add(t),this.distanceInfo.preSelObj=t)):"plane"!=this.distanceInfo.preSelInfo.type&&"cylinder"!=this.distanceInfo.preSelInfo.type&&"cone"!=this.distanceInfo.preSelInfo.type&&"face"!=this.distanceInfo.preSelInfo.topolType||(t=this.createFace(this.distanceInfo.preSelInfo,!0))&&((e=[]).push(t),this.viewer.outlinePass&&this.viewer.outlinePass.enabled&&(this.viewer.outlinePass.tempSelectedObjects=e),this.OpMeasure.rootObject.add(t),this.distanceInfo.preSelObj=t)):(this.distanceInfo.firstSelInfo&&!this.distanceInfo.firstSelObj&&(this.preSelClear(),t=null,"point"==this.distanceInfo.firstSelInfo.type?t=this.createPointMesh(this.distanceInfo.firstSelInfo.point,this.materialPoint,this.POINTSIZE):"line"==this.distanceInfo.firstSelInfo.type||"circle"==this.distanceInfo.firstSelInfo.type?t=this.createLine(this.distanceInfo.firstSelInfo,!1):"plane"!=this.distanceInfo.firstSelInfo.type&&"cylinder"!=this.distanceInfo.firstSelInfo.type&&"cone"!=this.distanceInfo.firstSelInfo.type||(t=this.createFace(this.distanceInfo.firstSelInfo,!1),"cylinder"!=this.distanceInfo.firstSelInfo.type&&"cone"!=this.distanceInfo.firstSelInfo.type)||(this.distanceInfo.axisLineObj=this.createAxisLine(this.distanceInfo.firstSelInfo),this.OpMeasure.rootObject.add(this.distanceInfo.axisLineObj)),t)&&(this.OpMeasure.rootObject.add(t),this.distanceInfo.firstSelObj=t),this.distanceInfo.secondSelInfo&&!this.distanceInfo.secondSelObj&&(this.preSelClear(),t=null,"point"==this.distanceInfo.secondSelInfo.type?t=this.createPointMesh(this.distanceInfo.secondSelInfo.point,this.materialPoint,this.POINTSIZE):"line"==this.distanceInfo.secondSelInfo.type||"circle"==this.distanceInfo.secondSelInfo.type||"edge"==this.distanceInfo.secondSelInfo.topolType?t=this.createLine(this.distanceInfo.secondSelInfo,!1):"plane"!=this.distanceInfo.secondSelInfo.type&&"cylinder"!=this.distanceInfo.secondSelInfo.type&&"cone"!=this.distanceInfo.secondSelInfo.type&&"face"!=this.distanceInfo.secondSelInfo.topolType||(t=this.createFace(this.distanceInfo.secondSelInfo,!1),"PointToFace"==this.measureType)||"cylinder"!=this.distanceInfo.secondSelInfo.type&&"cone"!=this.distanceInfo.secondSelInfo.type||(this.distanceInfo.secaxisLineObj=this.createAxisLine(this.distanceInfo.secondSelInfo),this.OpMeasure.rootObject.add(this.distanceInfo.secaxisLineObj)),t)&&(this.OpMeasure.rootObject.add(t),this.distanceInfo.secondSelObj=t),this.distanceInfo.firstSelObj&&this.distanceInfo.secondSelObj&&(NDSWebViewer.SETTING.enableBroadcast&&NDSWebViewer.SETTING.broadcastMajor&&this.OpMeasure.addmeasureTimes(),this.viewer.is2DModel?this.createAndShowDistanceDimension():(this.createAndShow3DDistanceDimension(null,!0),this.OpMeasure.rootObject.remove(this.distanceInfo.firstSelObj),this.OpMeasure.rootObject.remove(this.distanceInfo.secondSelObj),this.distanceInfo.firstSelObj=null,this.distanceInfo.firstSelObj=null,this.distanceInfo.firstSelInfo=null,this.distanceInfo.secondSelInfo=null),this.OpMeasure.measureEnd()))},(r.prototype=Object.create(i.prototype)).OperatorStart=function(e){this.measureType=e,"radius"!==this.measureType||NDSWebViewer.COMMON.isMobileDevice()||this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.MEASUREBODY)},r.prototype.onNMouseMove=function(e,t){var n=new THREE.Vector3(e,t,0);this.OpMeasure.unsteady?this.changeRadius(n):"radius"==this.measureType&&(this.holeInfo.firstSelHoleObj&&!NDSWebViewer.COMMON.isMobileDevice()?this.createAndShowMeasureRadiusAndDiameterDimension(n):(this.measureRadiusAndDiameter(e,t,!0),this.updateMeasureRadiusAndDiameterScene("true",n)))},r.prototype.onLMouseClick=function(e,t,n){var i=new THREE.Vector3(e,t,0);"radius"==this.measureType&&(this.holeInfo.firstSelHoleObj?(this.viewer.is2DModel?this.createAndShowMeasureRadiusAndDiameterDimension(i,!0):this.createAndShowMeasure3DRadiusAndDiameterDimension(i,!0),this.holeInfo.firstSelHoleObj||NDSWebViewer.COMMON.isMobileDevice()||this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.MEASUREBODY)):(this.measureRadiusAndDiameter(e,t,!1),this.updateMeasureRadiusAndDiameterScene("false",i),this.holeInfo.firstSelHoleObj&&!NDSWebViewer.COMMON.isMobileDevice()&&this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.ENDMEASURE)))},r.prototype.getCylinderOrigin=function(e){var t=e.geometry,n=e.indexRange.concat(),i=(this.viewer.ndsModel&&(n[0]+=t.drawRange.start/3,n[1]+=t.drawRange.start/3),t.index),t=t.attributes.position,s=i.getX(3*n[0]),o=i.getX(3*n[0]+1),i=i.getX(3*n[0]+2),n=new THREE.Vector3,r=new THREE.Vector3,a=new THREE.Vector3,s=(n.fromBufferAttribute(t,s),r.fromBufferAttribute(t,o),a.fromBufferAttribute(t,i),new THREE.Vector3(e.origin[0],e.origin[1],e.origin[2])),o=new THREE.Vector3(e.axis[0],e.axis[1],e.axis[2]),t=(new THREE.Vector3).addVectors(s,o),i=this.getProjectPntToLine(s,t,n),e=i.distanceTo(s),o=this.getProjectPntToLine(s,t,r),n=o.distanceTo(s),r=this.getProjectPntToLine(s,t,a),t=r.distanceTo(s);return e<=n&&e<=t?i:n<=e&&n<=t?o:r},r.prototype.getHoleAxisAndCenter=function(e){var t=new THREE.Vector3,n=new THREE.Quaternion,i=new THREE.Vector3;if(e.matrixWorld.decompose(t,n,i),"cylinder"==e.type)return(t=this.getCylinderOrigin(e)).applyMatrix4(e.matrixWorld),(r=new THREE.Vector3(e.axis[0],e.axis[1],e.axis[2])).applyQuaternion(n),r.normalize(),{center:t,axis:r};if("circle"==e.type){var s,o,r,i=new THREE.Vector3(e.center[0],e.center[1],e.center[2]),t=e.geometry,a=e.indexRange.concat(),l=(this.viewer.ndsModel&&(a[0]+=t.drawRange.start/2,a[1]+=t.drawRange.start/2),(a[0]+a[1])/2),d=(l-1>a[0]&&l--,t.index),t=t.attributes.position.array;if(null!=d)return d=d.array,s=new THREE.Vector3,o=new THREE.Vector3,s.fromArray(t,3*d[2*a[0]]),o.fromArray(t,3*d[2*l]),a=(new THREE.Vector3).subVectors(s,i),t=(new THREE.Vector3).subVectors(o,i),r=(new THREE.Vector3).crossVectors(a,t),i.applyMatrix4(e.matrixWorld),r.applyQuaternion(n),r.normalize(),{center:i,axis:r}}return null},r.prototype.measureRadiusAndDiameter=function(e,t,n){if(""==this.holeInfo.unit&&(this.holeInfo.unit=this.getUnitString()),this.holeInfo.firstSelHoleObj)this.holeInfo.preSelHoleObj&&(this.OpMeasure.rootObject.remove(this.holeInfo.preSelHoleObj),this.holeInfo.preSelHoleObj=null,this.holeInfo.preSelHoleInfo=null);else{var i=this.viewer,e=this.doRaycasterPick(e,t,!0);if(e&&0!=e.length){if(0<e.length){t=null;if(i.ndsModel||e[0].object instanceof THREE.Line||e[0].object instanceof THREE.LineSegments?t=e[0]:1<e.length&&(e[1].object instanceof THREE.Line||e[1].object instanceof THREE.LineSegments)&&Math.abs(e[1].distance-e[0].distance)<(i=this.viewer.controls.getBoundingBox()).min.distanceTo(i.max)/1e3&&(t=e[1]),t){i=this.getSelectInfoFromIntersect(t);if(!i||"cylinder"!=i.type&&"circle"!=i.type)return this.holeInfo.preSelHoleInfo=i,void(this.holeInfo.preSelHoleObj&&(this.OpMeasure.rootObject.remove(this.holeInfo.preSelHoleObj),this.holeInfo.preSelHoleObj=null));if(i)return void(1==n?this.isTwoTopolInfoTheSame(this.holeInfo.preSelHoleInfo,i)||(this.holeInfo.preSelHoleInfo=i,this.holeInfo.preSelHoleObj&&(this.OpMeasure.rootObject.remove(this.holeInfo.preSelHoleObj),this.holeInfo.preSelHoleObj=null)):(this.holeInfo.firstHoleInfo=i,e=this.getHoleAxisAndCenter(i),this.holeInfo.firstHoleInfo.worldCenter=e.center,this.holeInfo.firstHoleInfo.worldAxis=e.axis,t="radius"==this.measureType?i.radius:2*i.radius,e=this.viewer.getDispalyModelUnit(t=t<1&&.999999<t?1:t),t*=e.scale,this.holeInfo.dimString=(parseInt(t*Math.pow(10,2)+.5)/Math.pow(10,2)).toFixed(8),this.holeInfo.unit=this.getUnitStringmap(e.unit),"radius"==this.measureType?this.holeInfo.dimString="R "+this.holeInfo.dimString:this.holeInfo.dimString=" "+this.holeInfo.dimString))}}1==n&&this.holeInfo.preSelHoleInfo&&(this.holeInfo.preSelHoleInfo=null,this.holeInfo.preSelHoleObj)&&(this.OpMeasure.rootObject.remove(this.holeInfo.preSelHoleObj),this.holeInfo.preSelHoleObj=null)}else this.holeInfo.preSelHoleObj&&(this.OpMeasure.rootObject.remove(this.holeInfo.preSelHoleObj),this.holeInfo.preSelHoleObj=null,this.holeInfo.preSelHoleInfo=null)}},r.prototype.updateMeasureRadiusAndDiameterScene=function(e,t){var n;"radius"!==this.measureType&&"diameter"!=this.measureType||(this.holeInfo.firstSelHoleObj?this.holeInfo.preSelHoleObj&&(this.OpMeasure.rootObject.remove(this.holeInfo.preSelHoleObj),this.holeInfo.preSelHoleObj=null,this.holeInfo.preSelHoleInfo=null):!(!e||"true"!==e.toLowerCase())?this.holeInfo.preSelHoleInfo&&!this.holeInfo.preSelHoleObj&&("cylinder"==this.holeInfo.preSelHoleInfo.type?(n=this.createFace(this.holeInfo.preSelHoleInfo,!0))&&((e=[]).push(n),this.viewer.outlinePass&&this.viewer.outlinePass.enabled&&(this.viewer.outlinePass.tempSelectedObjects=e),this.OpMeasure.rootObject.add(n),this.holeInfo.preSelHoleObj=n):"circle"==this.holeInfo.preSelHoleInfo.type&&(n=this.createLine(this.holeInfo.preSelHoleInfo,!0))&&(this.OpMeasure.rootObject.add(n),this.holeInfo.preSelHoleObj=n)):(this.holeInfo.firstHoleInfo&&!this.holeInfo.firstSelHoleObj&&(n=null,"cylinder"==this.holeInfo.firstHoleInfo.type?n=this.createFace(this.holeInfo.firstHoleInfo,!1):"circle"==this.holeInfo.firstHoleInfo.type&&(n=this.createLine(this.holeInfo.firstHoleInfo,!1)),n)&&(this.OpMeasure.rootObject.add(n),this.holeInfo.firstSelHoleObj=n),this.holeInfo.firstSelHoleObj&&(NDSWebViewer.SETTING.enableBroadcast&&NDSWebViewer.SETTING.broadcastMajor&&this.OpMeasure.addmeasureTimes(),this.viewer.is2DModel?this.createAndShowMeasureRadiusAndDiameterDimension(t):this.createAndShowMeasure3DRadiusAndDiameterDimension(t,!0),this.OpMeasure.measureEnd())))},r.prototype.createAndShowMeasureRadiusAndDiameterDimension=function(e,t){var n,i,s,o;"radius"!=this.measureType&&"diameter"!=this.measureType||this.holeInfo.firstHoleInfo&&this.holeInfo.firstSelHoleObj&&(this.holeInfo.selLineCenterPos||(this.holeInfo.selLineCenterPos=this.holeInfo.firstHoleInfo.worldCenter.clone()),this.holeInfo.textPos?e&&((o=new THREE.Plane).setFromNormalAndCoplanarPoint(this.holeInfo.firstHoleInfo.worldAxis,this.holeInfo.firstHoleInfo.worldCenter),s=this.clientCoordToModelCoordOnPlane(e.x,e.y,o))&&this.holeInfo.textPos.copy(s):((o=new THREE.Plane).setFromNormalAndCoplanarPoint(this.holeInfo.firstHoleInfo.worldAxis,this.holeInfo.firstHoleInfo.worldCenter),(s=this.clientCoordToModelCoordOnPlane(e.x,e.y,o))?this.holeInfo.textPos=s:((e=(new THREE.Vector3).subVectors(this.holeInfo.firstHoleInfo.intersect,this.holeInfo.firstHoleInfo.worldCenter)).projectOnPlane(this.holeInfo.firstHoleInfo.worldAxis),this.holeInfo.textPos=(new THREE.Vector3).addVectors(this.holeInfo.firstHoleInfo.worldCenter,e))),(o=(new THREE.Vector3).subVectors(this.holeInfo.textPos,this.holeInfo.selLineCenterPos)).normalize(),this.holeInfo.fstClnd?(this.OpMeasure.rootObject.remove(this.holeInfo.fstClnd),this.holeInfo.fstClndPos=this.holeInfo.selLineCenterPos.clone().add(o.clone().multiplyScalar(this.holeInfo.firstHoleInfo.radius)),this.holeInfo.sndClndPos=this.holeInfo.selLineCenterPos.clone().add(o.clone().multiplyScalar(-this.holeInfo.firstHoleInfo.radius)),s=this.isPointBetweenIn(this.holeInfo.textPos,this.holeInfo.selLineCenterPos,this.holeInfo.fstClndPos),this.holeInfo.fstClnd&&this.OpMeasure.rootObject.remove(this.holeInfo.fstClnd),this.holeInfo.sndClnd&&this.OpMeasure.rootObject.remove(this.holeInfo.sndClnd),s?(this.holeInfo.fstClnd=this.createCylinderMesh(this.holeInfo.selLineCenterPos,this.holeInfo.fstClndPos,this.materialLine),i=this.OpMeasure.getScale(this.holeInfo.fstClnd,this.CYLINDERWIDTH),(n=o.clone()).multiplyScalar(.5*this.holeInfo.fstClnd.geometry.parameters.height),this.holeInfo.fstClnd.oldPosition=this.holeInfo.fstClndPos.clone(),this.holeInfo.fstClnd.offsetPos=n.clone().multiplyScalar(-1),this.holeInfo.fstClnd.position.subVectors(this.holeInfo.fstClndPos,n.clone().multiplyScalar(i)),"diameter"==this.measureType&&(this.holeInfo.sndClnd=this.createCylinderMesh(this.holeInfo.selLineCenterPos,this.holeInfo.sndClndPos,this.materialLine),i=this.OpMeasure.getScale(this.holeInfo.sndClnd,this.CYLINDERWIDTH),this.holeInfo.sndClnd.oldPosition=this.holeInfo.sndClndPos.clone(),this.holeInfo.sndClnd.offsetPos=n.clone(),this.holeInfo.sndClnd.position.addVectors(this.holeInfo.sndClndPos,n.clone().multiplyScalar(i)))):(this.holeInfo.fstClnd=this.createCylinderMesh(this.holeInfo.fstClndPos,this.holeInfo.selLineCenterPos,this.materialLine),i=this.OpMeasure.getScale(this.holeInfo.fstClnd,this.CYLINDERWIDTH),(n=o.clone()).multiplyScalar(.5*this.holeInfo.fstClnd.geometry.parameters.height),this.holeInfo.fstClnd.oldPosition=this.holeInfo.fstClndPos.clone(),this.holeInfo.fstClnd.offsetPos=n.clone(),this.holeInfo.fstClnd.position.addVectors(this.holeInfo.fstClndPos,n.clone().multiplyScalar(i)),"diameter"==this.measureType&&(this.holeInfo.sndClnd=this.createCylinderMesh(this.holeInfo.sndClndPos,this.holeInfo.selLineCenterPos,this.materialLine),i=this.OpMeasure.getScale(this.holeInfo.sndClnd,this.CYLINDERWIDTH),this.holeInfo.sndClnd.oldPosition=this.holeInfo.sndClndPos.clone(),this.holeInfo.sndClnd.offsetPos=n.clone().multiplyScalar(-1),this.holeInfo.sndClnd.position.subVectors(this.holeInfo.sndClndPos,n.clone().multiplyScalar(i)))),this.OpMeasure.rootObject.add(this.holeInfo.fstClnd),"diameter"==this.measureType&&this.holeInfo.sndClnd&&this.OpMeasure.rootObject.add(this.holeInfo.sndClnd)):(this.holeInfo.fstClndPos=this.holeInfo.selLineCenterPos.clone().add(o.clone().multiplyScalar(this.holeInfo.firstHoleInfo.radius)),this.holeInfo.sndClndPos=this.holeInfo.selLineCenterPos.clone().add(o.clone().multiplyScalar(-this.holeInfo.firstHoleInfo.radius)),this.holeInfo.fstClnd=this.createCylinderMesh(this.holeInfo.selLineCenterPos,this.holeInfo.fstClndPos,this.materialLine),i=this.OpMeasure.getScale(this.holeInfo.fstClnd,this.CYLINDERWIDTH),(n=o.clone()).multiplyScalar(.5*this.holeInfo.fstClnd.geometry.parameters.height),this.holeInfo.fstClnd.oldPosition=this.holeInfo.fstClndPos.clone(),this.holeInfo.fstClnd.offsetPos=n.clone().multiplyScalar(-1),this.holeInfo.fstClnd.position.subVectors(this.holeInfo.fstClndPos,n.clone().multiplyScalar(i)),this.OpMeasure.rootObject.add(this.holeInfo.fstClnd),"diameter"==this.measureType&&(this.holeInfo.sndClnd=this.createCylinderMesh(this.holeInfo.selLineCenterPos,this.holeInfo.sndClndPos,this.materialLine),i=this.OpMeasure.getScale(this.holeInfo.sndClnd,NDSWebViewer.NDS.INFOTYPE.CYLINDERWIDTH),this.holeInfo.sndClnd.oldPosition=this.holeInfo.sndClndPos.clone(),this.holeInfo.sndClnd.offsetPos=n.clone(),this.holeInfo.sndClnd.position.addVectors(this.holeInfo.sndClndPos,n.clone().multiplyScalar(i)),this.OpMeasure.rootObject.add(this.holeInfo.sndClnd))),this.holeInfo.centerToClndLine&&this.OpMeasure.rootObject.remove(this.holeInfo.centerToClndLine),this.holeInfo.centerToClndLine=this.createLineMesh2(this.holeInfo.selLineCenterPos,this.holeInfo.fstClndPos,this.materialLine,1),this.OpMeasure.rootObject.add(this.holeInfo.centerToClndLine),this.holeInfo.centerToClndLine2&&this.OpMeasure.rootObject.remove(this.holeInfo.centerToClndLine2),"diameter"==this.measureType&&(this.holeInfo.centerToClndLine2=this.createLineMesh2(this.holeInfo.selLineCenterPos,this.holeInfo.sndClndPos,this.materialLine,1),this.OpMeasure.rootObject.add(this.holeInfo.centerToClndLine2)),e=this.holeInfo.dimString.slice(0,2)+(this.holeInfo.dimString.slice(2)*this.viewer.measuringScale).toFixed(8)+this.holeInfo.unit,this.holeInfo.textBox||(this.holeInfo.textBox=document.createElement("div"),this.holeInfo.textBox.className="mearesult",this.viewer.container.appendChild(this.holeInfo.textBox)),this.getAndShowTextBox(this.holeInfo.textPos.clone(),e,this.holeInfo.textBox),1==t)&&((s={}).start=this.holeInfo.textPos.clone(),s.end=this.holeInfo.fstClndPos.clone(),this.OpMeasure.textLines.push(s),(o={}).dimString=e,o.textPos=this.holeInfo.textPos.clone(),o.textBox=this.holeInfo.textBox,o.textBox.setAttribute("type","radius"),o.textBox.setAttribute("dimString",this.holeInfo.dimString),o.textBox.setAttribute("unit",this.holeInfo.unit),o.textBox.setAttribute("lineInfo",this.OpMeasure.textLines.length-1),this.OpMeasure.boxInfos.push(o),this.clearHoleInfo(!0),NDSWebViewer.COMMON.isMobileDevice())&&this.ChangeMeasureFlag()},r.prototype.createAndShowMeasure3DRadiusAndDiameterDimension=function(e,t){var n,i,s,o;"radius"!=this.measureType&&"diameter"!=this.measureType||this.holeInfo.firstHoleInfo&&this.holeInfo.firstSelHoleObj&&(this.holeInfo.selLineCenterPos||(this.holeInfo.selLineCenterPos=this.holeInfo.firstHoleInfo.worldCenter.clone()),this.holeInfo.textPos?e&&((o=new THREE.Plane).setFromNormalAndCoplanarPoint(this.holeInfo.firstHoleInfo.worldAxis,this.holeInfo.firstHoleInfo.worldCenter),n=this.clientCoordToModelCoordOnPlane(e.x,e.y,o))&&this.holeInfo.textPos.copy(n):((o=new THREE.Plane).setFromNormalAndCoplanarPoint(this.holeInfo.firstHoleInfo.worldAxis,this.holeInfo.firstHoleInfo.worldCenter),(n=this.clientCoordToModelCoordOnPlane(e.x,e.y,o))?this.holeInfo.textPos=n:((e=(new THREE.Vector3).subVectors(this.holeInfo.firstHoleInfo.intersect,this.holeInfo.firstHoleInfo.worldCenter)).projectOnPlane(this.holeInfo.firstHoleInfo.worldAxis),this.holeInfo.textPos=(new THREE.Vector3).addVectors(this.holeInfo.firstHoleInfo.worldCenter,e))),(o=(new THREE.Vector3).subVectors(this.holeInfo.textPos,this.holeInfo.selLineCenterPos)).normalize(),this.holeInfo.fstClnd?(this.holeInfo.fstClndPos=this.holeInfo.selLineCenterPos.clone().add(o.clone().multiplyScalar(this.holeInfo.firstHoleInfo.radius)),this.holeInfo.sndClndPos=this.holeInfo.selLineCenterPos.clone().add(o.clone().multiplyScalar(-this.holeInfo.firstHoleInfo.radius)),this.isPointBetweenIn(this.holeInfo.textPos,this.holeInfo.selLineCenterPos,this.holeInfo.fstClndPos)?(this.holeInfo.fstClnd=this.createCylinderMesh(this.holeInfo.selLineCenterPos,this.holeInfo.fstClndPos,this.appmaterialLine),s=this.OpMeasure.getScale(this.holeInfo.fstClnd,this.CYLINDERWIDTH),(i=o.clone()).multiplyScalar(.5*this.holeInfo.fstClnd.geometry.parameters.height),this.holeInfo.fstClnd.oldPosition=this.holeInfo.fstClndPos.clone(),this.holeInfo.fstClnd.offsetPos=i.clone().multiplyScalar(-1),this.holeInfo.fstClnd.position.subVectors(this.holeInfo.fstClndPos,i.clone().multiplyScalar(s))):(this.holeInfo.fstClnd=this.createCylinderMesh(this.holeInfo.fstClndPos,this.holeInfo.selLineCenterPos,this.appmaterialLine),s=this.OpMeasure.getScale(this.holeInfo.fstClnd,this.CYLINDERWIDTH),(i=o.clone()).multiplyScalar(.5*this.holeInfo.fstClnd.geometry.parameters.height),this.holeInfo.fstClnd.oldPosition=this.holeInfo.fstClndPos.clone(),this.holeInfo.fstClnd.offsetPos=i.clone(),this.holeInfo.fstClnd.position.addVectors(this.holeInfo.fstClndPos,i.clone().multiplyScalar(s)))):(this.holeInfo.fstClndPos=this.holeInfo.selLineCenterPos.clone().add(o.clone().multiplyScalar(this.holeInfo.firstHoleInfo.radius)),this.holeInfo.sndClndPos=this.holeInfo.selLineCenterPos.clone().add(o.clone().multiplyScalar(-this.holeInfo.firstHoleInfo.radius)),this.holeInfo.fstClnd=this.createCylinderMesh(this.holeInfo.selLineCenterPos,this.holeInfo.fstClndPos,this.appmaterialLine),s=this.OpMeasure.getScale(this.holeInfo.fstClnd,this.CYLINDERWIDTH),(i=o.clone()).multiplyScalar(.5*this.holeInfo.fstClnd.geometry.parameters.height),this.holeInfo.fstClnd.oldPosition=this.holeInfo.fstClndPos.clone(),this.holeInfo.fstClnd.offsetPos=i.clone().multiplyScalar(-1),this.holeInfo.fstClnd.position.subVectors(this.holeInfo.fstClndPos,i.clone().multiplyScalar(s)),"diameter"==this.measureType&&(this.holeInfo.sndClnd=this.createCylinderMesh(this.holeInfo.selLineCenterPos,this.holeInfo.sndClndPos,this.appmaterialLine),s=this.OpMeasure.getScale(this.holeInfo.sndClnd,NDSWebViewer.NDS.INFOTYPE.CYLINDERWIDTH),this.holeInfo.sndClnd.oldPosition=this.holeInfo.sndClndPos.clone(),this.holeInfo.sndClnd.offsetPos=i.clone(),this.holeInfo.sndClnd.position.addVectors(this.holeInfo.sndClndPos,i.clone().multiplyScalar(s)))),this.holeInfo.centerToClndLine=this.createLineMesh2(this.holeInfo.selLineCenterPos,this.holeInfo.fstClndPos,this.appmaterialLine,1),n=this.holeInfo.dimString.slice(0,2)+(this.holeInfo.dimString.slice(2)*this.viewer.measuringScale).toFixed(8)+this.holeInfo.unit,e=null,this.holeInfo.textBox||(this.holeInfo.textBox=document.createElement("div"),this.holeInfo.textBox.className="section10",this.holeInfo.textBox.innerHTML=n,(o=document.createElement("div")).className="sectionPoint",this.holeInfo.textBox.appendChild(o),(e=document.createElement("div")).className="sectionCross",this.holeInfo.textBox.appendChild(e),this.viewer.container.appendChild(this.holeInfo.textBox)),1==t)&&((i={}).dimString=n,i.textPos=this.holeInfo.textPos.clone(),i.textBox=this.holeInfo.textBox,s=new THREE.Group,o=new THREE.Group,s.objectType="Group",o.objectType="Group",o.name="unsteady",o.add(this.holeInfo.fstClnd),o.add(this.holeInfo.centerToClndLine),this.OpMeasure.rootObject.remove(this.holeInfo.firstSelHoleObj),s.add(this.holeInfo.firstSelHoleObj),s.add(o),this.OpMeasure.rootObject.add(s),NDSWebViewer.COMMON.isMobileDevice()?(i.textBox.addEventListener("touchstart",this.touchstart,!1),i.textBox.addEventListener("touchend",this.touchend,!1),i.textBox.addEventListener("touchmove",this.touchmove,!1)):(i.textBox.addEventListener("mousedown",this.touchstart,!1),i.textBox.addEventListener("mouseup",this.touchend,!1),i.textBox.addEventListener("mousemove",this.touchmove,!1),i.textBox.addEventListener("mouseleave",this.mouseleave,!1),i.textBox.addEventListener("mouseenter",this.mouseenter,!1)),NDSWebViewer.COMMON.isMobileDevice()?e.addEventListener("touchend",this.sectionCrossend,!1):(e.addEventListener("mousedown",this.sectionCrossend,!1),e.addEventListener("mouseleave",this.crossleave,!1),e.addEventListener("mouseenter",this.crossenter,!1)),(t={}).start=this.holeInfo.textPos.clone(),t.end=this.holeInfo.fstClndPos.clone(),t.uuid=s.uuid,this.OpMeasure.textLines.push(t),i.textBox.setAttribute("mobile","up"),i.textBox.setAttribute("group",s.uuid),this.OpMeasure.currentUuid=s.uuid,i.textBox.setAttribute("type","radius"),i.textBox.setAttribute("dimString",this.holeInfo.dimString),i.textBox.setAttribute("unit",this.holeInfo.unit),i.textBox.setAttribute("lineInfo",this.OpMeasure.textLines.length-1),this.OpMeasure.unsteadyData[s.uuid]=this.DeepCopy(this.holeInfo,"Radius"),this.OpMeasure.boxInfos.push(i),this.getAndShowTextBox(this.holeInfo.textPos.clone(),n,this.holeInfo.textBox),this.clearHoleInfo(!0),NDSWebViewer.COMMON.isMobileDevice())&&this.ChangeMeasureFlag()},r.prototype.changeRadius=function(e){var t=this.OpMeasure.rootObject.getObjectByProperty("uuid",this.OpMeasure.unsteadyuuid),n=t.getObjectByName("unsteady");n&&t.remove(n);(n=new THREE.Group).name="unsteady",n.objectType="Group",t.add(n);var i=this.OpMeasure.unsteadyData[this.OpMeasure.unsteadyuuid],t=(i.selLineCenterPos||(i.selLineCenterPos=i.firstHoleInfo.worldCenter.clone()),i.textPos?e&&((s=new THREE.Plane).setFromNormalAndCoplanarPoint(i.firstHoleInfo.worldAxis,i.firstHoleInfo.worldCenter),(o=this.clientCoordToModelCoordOnPlane(e.x,e.y,s))?i.textPos.copy(o):((r=(new THREE.Vector3).subVectors(i.firstHoleInfo.intersect,i.firstHoleInfo.worldCenter)).projectOnPlane(i.firstHoleInfo.worldAxis),i.textPos=(new THREE.Vector3).addVectors(i.firstHoleInfo.worldCenter,r))):((s=new THREE.Plane).setFromNormalAndCoplanarPoint(i.firstHoleInfo.worldAxis,i.firstHoleInfo.worldCenter),(o=this.clientCoordToModelCoordOnPlane(e.x,e.y,s))?i.textPos=o:((r=(new THREE.Vector3).subVectors(i.firstHoleInfo.intersect,i.firstHoleInfo.worldCenter)).projectOnPlane(i.firstHoleInfo.worldAxis),i.textPos=(new THREE.Vector3).addVectors(i.firstHoleInfo.worldCenter,r))),(new THREE.Vector3).subVectors(i.textPos,i.selLineCenterPos)),s=(t.normalize(),i.fstClndPos=i.selLineCenterPos.clone().add(t.clone().multiplyScalar(i.firstHoleInfo.radius)),i.sndClndPos=i.selLineCenterPos.clone().add(t.clone().multiplyScalar(-i.firstHoleInfo.radius)),e=this.createCylinderMesh(i.selLineCenterPos,i.fstClndPos,this.appmaterialLine),this.OpMeasure.getScale(e,this.CYLINDERWIDTH)),o=t.clone(),r=(o.multiplyScalar(.5*e.geometry.parameters.height),e.oldPosition=i.fstClndPos.clone(),e.offsetPos=o.clone().multiplyScalar(-1),e.position.subVectors(i.fstClndPos,o.clone().multiplyScalar(s)),"diameter"==this.measureType&&(i.sndClnd=this.createCylinderMesh(i.selLineCenterPos,i.sndClndPos,this.materialLine),s=this.OpMeasure.getScale(i.sndClnd,NDSWebViewer.NDS.INFOTYPE.CYLINDERWIDTH),i.sndClnd.oldPosition=i.sndClndPos.clone(),i.sndClnd.offsetPos=o.clone(),i.sndClnd.position.addVectors(i.sndClndPos,o.clone().multiplyScalar(s))),this.createLineMesh2(i.selLineCenterPos,i.fstClndPos,this.appmaterialLine,1));n.add(e),n.add(r);for(var a=0;a<this.OpMeasure.boxInfos.length;a++){var l=this.OpMeasure.boxInfos[a];if(l.textBox.getAttribute("group")==this.OpMeasure.unsteadyuuid){l.textPos=i.textPos;break}}for(a=0;a<this.OpMeasure.textLines.length;a++){var d=this.OpMeasure.textLines[a];if(d.uuid==this.OpMeasure.unsteadyuuid){d.start=i.textPos.clone(),d.end=i.fstClndPos.clone();break}}t=this.get2dPoint(i.textPos.clone()),o=this.get2dPoint(i.fstClndPos.clone()),this.viewer.renderer.getPixelRatio(),s=new THREE.Vector2(t.x-o.x,t.y-o.y);s.normalize(),s.y>=s.x/2&&s.y>=-s.x/2?(this.OpMeasure.unsteadyTextBox.childNodes[1].style.left="calc(50% - 6px)",this.OpMeasure.unsteadyTextBox.childNodes[1].style.top="-5.5px",this.OpMeasure.unsteadyTextBox.setAttribute("mobile","down")):s.y>s.x/2&&s.y<-s.x/2?(this.OpMeasure.unsteadyTextBox.childNodes[1].style.left="calc(100% - 4px)",this.OpMeasure.unsteadyTextBox.childNodes[1].style.top="calc(50% - 5.5px)",this.OpMeasure.unsteadyTextBox.setAttribute("mobile","right")):s.y<s.x/2&&s.y<-s.x/2?(this.OpMeasure.unsteadyTextBox.childNodes[1].style.left="calc(50% - 6px)",this.OpMeasure.unsteadyTextBox.childNodes[1].style.top="calc(100% - 5.5px)",this.OpMeasure.unsteadyTextBox.setAttribute("mobile","up")):s.y<s.x/2&&s.y>-s.x/2&&(this.OpMeasure.unsteadyTextBox.childNodes[1].style.left="-5.5px",this.OpMeasure.unsteadyTextBox.childNodes[1].style.top="calc(50% - 5.5px)",this.OpMeasure.unsteadyTextBox.setAttribute("mobile","left")),this.OpMeasure.viewer.render()},(a.prototype=Object.create(i.prototype)).OperatorStart=function(e){switch(this.measureType=e,this.measureType){case"bodyEdgeLength":this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.MEASUREBODY);break;case"measureEdges":this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.LINEANDCIRCLE)}},a.prototype.onNMouseMove=function(e,t){var n=new THREE.Vector3(e,t,0);this.OpMeasure.unsteady?this.changeMeasureEdge(n):this.edgeInfo.selLineObj&&!NDSWebViewer.COMMON.isMobileDevice()?this.createAndShowMeasureEdgesDimension(n):(this.measureEdges(e,t,!0),this.viewer.is2DModel?this.updateMeasureEdgesScene("true",n):this.update3DMeasureEdgesScene("true",n))},a.prototype.onLMouseClick=function(e,t,n){var i=new THREE.Vector3(e,t,0);this.edgeInfo.selLineObj?this.viewer.is2DModel?(this.createAndShowMeasureEdgesDimension(i,!0),this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.LINEANDCIRCLE)):this.createAndShow3DMeasureEdgesDimension(i,!0):(this.measureEdges(e,t,!1),this.viewer.is2DModel?(this.updateMeasureEdgesScene("false",i),this.edgeInfo.selLineObj&&this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.ENDMEASURE)):this.update3DMeasureEdgesScene("false",i))},a.prototype.createAndShowMeasureEdgesDimension=function(e,t){var n,i,s,o,r,a,l,d;"measureEdges"!=this.measureType&&"bodyEdgeLength"!=this.measureType||this.edgeInfo.selLineInfo&&this.edgeInfo.selLineObj&&(n=!1,(n=this.edgeInfo.thirdPos?!0:n)?((i=new THREE.Plane).setFromCoplanarPoints(this.edgeInfo.startPos,this.edgeInfo.midPos,this.edgeInfo.thirdPos),this.edgeInfo.textPos||(this.edgeInfo.textPos=this.edgeInfo.startPos.clone()),e&&((n=this.clientCoordToModelCoordOnPlane(e.x,e.y,i))&&(this.edgeInfo.textPos=n),this.edgeInfo.boxToClndLine&&this.OpMeasure.rootObject.remove(this.edgeInfo.boxToClndLine),this.edgeInfo.boxToClndLine=this.createLineMesh2(this.edgeInfo.startPos,this.edgeInfo.textPos,this.materialLine,1),this.OpMeasure.rootObject.add(this.edgeInfo.boxToClndLine))):(this.edgeInfo.fstClndPos||(this.edgeInfo.fstClndPos=this.edgeInfo.startPos.clone()),this.edgeInfo.sndClndPos||(this.edgeInfo.sndClndPos=this.edgeInfo.endPos.clone()),n=(new THREE.Vector3).subVectors(this.edgeInfo.endPos,this.edgeInfo.startPos),this.edgeInfo.fstClnd&&this.edgeInfo.sndClnd?e&&((i=new THREE.Plane).setFromCoplanarPoints(this.edgeInfo.startPos,this.edgeInfo.endPos,this.edgeInfo.fstClndPos),s=this.clientCoordToModelCoordOnPlane(e.x,e.y,i))&&(o=this.getProjectPntToLine(this.edgeInfo.startPos,this.edgeInfo.fstClndPos,s))&&(r=o.clone().sub(this.edgeInfo.startPos),this.edgeInfo.fstClndPos.addVectors(this.edgeInfo.startPos,r),this.edgeInfo.sndClndPos=this.edgeInfo.fstClndPos.clone().add(n)):"line"==this.edgeInfo.selLineInfo.type?(d=this.viewer.camera.getWorldDirection(),l=(new THREE.Vector3).crossVectors(n,d),l=this.getBaceFaceDir(l),a=(a=n.length())<1?.01:.5,l.normalize().multiplyScalar(a),this.edgeInfo.fstClndPos.add(l),this.edgeInfo.sndClndPos.add(l)):(r=(new THREE.Vector3).subVectors(this.edgeInfo.midPos,this.edgeInfo.startPos),1e-7<(r=(new THREE.Vector3).crossVectors(n,r)).lengthSq()?((r=(new THREE.Vector3).crossVectors(r,n)).normalize().multiplyScalar(.5),this.edgeInfo.fstClndPos.add(r),this.edgeInfo.sndClndPos.add(r)):(d=this.viewer.camera.getWorldDirection(),l=(new THREE.Vector3).crossVectors(n,d),(l=this.getBaceFaceDir(l)).normalize().multiplyScalar(.5),this.edgeInfo.fstClndPos.add(l),this.edgeInfo.sndClndPos.add(l))),this.edgeInfo.textPos?e&&((i=new THREE.Plane).setFromCoplanarPoints(this.edgeInfo.startPos,this.edgeInfo.endPos,this.edgeInfo.fstClndPos),s=this.clientCoordToModelCoordOnPlane(e.x,e.y,i))&&(o=this.getProjectPntToLine(this.edgeInfo.fstClndPos,this.edgeInfo.sndClndPos,s))&&this.edgeInfo.textPos.copy(o):this.edgeInfo.textPos=this.edgeInfo.sndClndPos.clone(),this.edgeInfo.startToClndLine&&this.OpMeasure.rootObject.remove(this.edgeInfo.startToClndLine),this.edgeInfo.startToClndLine=this.createLineMesh2(this.edgeInfo.startPos,this.edgeInfo.fstClndPos,this.materialLine,1),this.OpMeasure.rootObject.add(this.edgeInfo.startToClndLine),this.edgeInfo.endToClndLine&&this.OpMeasure.rootObject.remove(this.edgeInfo.endToClndLine),this.edgeInfo.endToClndLine=this.createLineMesh2(this.edgeInfo.endPos,this.edgeInfo.sndClndPos,this.materialLine,1),this.OpMeasure.rootObject.add(this.edgeInfo.endToClndLine),r=this.isPointBetweenIn(this.edgeInfo.textPos,this.edgeInfo.fstClndPos,this.edgeInfo.sndClndPos),this.edgeInfo.fstClnd&&this.OpMeasure.rootObject.remove(this.edgeInfo.fstClnd),n.normalize(),r?(this.edgeInfo.fstClnd=this.createCylinderMesh(this.edgeInfo.sndClndPos,this.edgeInfo.fstClndPos,this.materialLine),a=this.OpMeasure.getScale(this.edgeInfo.fstClnd,this.CYLINDERWIDTH),n.multiplyScalar(.5*this.edgeInfo.fstClnd.geometry.parameters.height),this.edgeInfo.fstClnd.oldPosition=this.edgeInfo.fstClndPos.clone(),this.edgeInfo.fstClnd.offsetPos=n.clone(),this.edgeInfo.fstClnd.position.addVectors(this.edgeInfo.fstClndPos,n.clone().multiplyScalar(a))):(this.edgeInfo.fstClnd=this.createCylinderMesh(this.edgeInfo.fstClndPos,this.edgeInfo.sndClndPos,this.materialLine),a=this.OpMeasure.getScale(this.edgeInfo.fstClnd,this.CYLINDERWIDTH),n.multiplyScalar(.5*this.edgeInfo.fstClnd.geometry.parameters.height),this.edgeInfo.fstClnd.oldPosition=this.edgeInfo.fstClndPos.clone(),this.edgeInfo.fstClnd.offsetPos=n.clone().multiplyScalar(-1),this.edgeInfo.fstClnd.position.subVectors(this.edgeInfo.fstClndPos,n.clone().multiplyScalar(a))),this.OpMeasure.rootObject.add(this.edgeInfo.fstClnd),this.edgeInfo.sndClnd&&this.OpMeasure.rootObject.remove(this.edgeInfo.sndClnd),r?(this.edgeInfo.sndClnd=this.createCylinderMesh(this.edgeInfo.fstClndPos,this.edgeInfo.sndClndPos,this.materialLine),this.edgeInfo.sndClnd.oldPosition=this.edgeInfo.sndClndPos.clone(),this.edgeInfo.sndClnd.offsetPos=n.clone().multiplyScalar(-1),this.edgeInfo.sndClnd.position.subVectors(this.edgeInfo.sndClndPos,n.clone().multiplyScalar(a))):(this.edgeInfo.sndClnd=this.createCylinderMesh(this.edgeInfo.sndClndPos,this.edgeInfo.fstClndPos,this.materialLine),this.edgeInfo.sndClnd.oldPosition=this.edgeInfo.sndClndPos.clone(),this.edgeInfo.sndClnd.offsetPos=n.clone(),this.edgeInfo.sndClnd.position.addVectors(this.edgeInfo.sndClndPos,n.clone().multiplyScalar(a))),this.OpMeasure.rootObject.add(this.edgeInfo.sndClnd),this.edgeInfo.clndToClndLine&&this.OpMeasure.rootObject.remove(this.edgeInfo.clndToClndLine),this.edgeInfo.clndToClndLine=this.createLineMesh2(this.edgeInfo.fstClndPos,this.edgeInfo.sndClndPos,this.materialLine,1),this.OpMeasure.rootObject.add(this.edgeInfo.clndToClndLine),this.edgeInfo.boxToClndLine&&this.OpMeasure.rootObject.remove(this.edgeInfo.boxToClndLine),this.edgeInfo.boxToClndLine=this.createLineMesh2(this.edgeInfo.fstClndPos,this.edgeInfo.textPos,this.materialLine,1),this.OpMeasure.rootObject.add(this.edgeInfo.boxToClndLine)),d="",d=""==this.edgeInfo.dimString[0]?" "+(this.edgeInfo.dimString.slice(2)*this.viewer.measuringScale).toFixed(8)+this.edgeInfo.unit:(this.edgeInfo.dimString*this.viewer.measuringScale).toFixed(8)+this.edgeInfo.unit,this.edgeInfo.textBox||(this.edgeInfo.textBox=document.createElement("div"),this.edgeInfo.textBox.className="mearesult",this.viewer.container.appendChild(this.edgeInfo.textBox)),this.getAndShowTextBox(this.edgeInfo.textPos.clone(),d,this.edgeInfo.textBox),1==t)&&((l={}).dimString=d,l.textPos=this.edgeInfo.textPos.clone(),l.textBox=this.edgeInfo.textBox,l.textBox.setAttribute("type","length"),l.textBox.setAttribute("dimString",this.edgeInfo.dimString),l.textBox.setAttribute("dimStringPrefix",""),l.textBox.setAttribute("unit",this.edgeInfo.unit),this.OpMeasure.boxInfos.push(l),this.clearEdgeInfo(!0),NDSWebViewer.COMMON.isMobileDevice()&&this.ChangeMeasureFlag(),NDSWebViewer.SETTING.enableBroadcast&&NDSWebViewer.SETTING.broadcastMajor&&this.OpMeasure.addmeasureTimes(),this.OpMeasure.measureEnd())},a.prototype.measureEdges=function(e,t,n){if(""==this.edgeInfo.unit&&(this.edgeInfo.unit=this.getUnitString()),this.edgeInfo.selLineObj)this.edgeInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.edgeInfo.preSelLineObj),this.edgeInfo.preSelLineObj=null,this.edgeInfo.preSelLineInfo=null);else{this.viewer;e=this.doRaycasterPick(e,t,!0);if(e&&0!=e.length){if(0<e.length){t=null;if(this.viewer.getNdsModelForMeasure()?0<=e[0].lineSegId&&(t=e[0]):e[0].object instanceof THREE.Line||e[0].object instanceof THREE.LineSegments?t=e[0]:1<e.length&&(e[1].object instanceof THREE.Line||e[1].object instanceof THREE.LineSegments)&&Math.abs(e[1].distance-e[0].distance)<(i=this.viewer.controls.getBoundingBox()).min.distanceTo(i.max)/1e3&&(t=e[1]),t){var i=this.getSelectInfoFromIntersect(t);if(i)return void(1==n?this.isTwoTopolInfoTheSame(this.edgeInfo.preSelLineInfo,i)||(this.edgeInfo.preSelLineInfo=i,this.edgeInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.edgeInfo.preSelLineObj),this.edgeInfo.preSelLineObj=null)):(this.edgeInfo.selLineInfo=i,this.edgeInfo.dimString=parseFloat(i.length),this.edgeInfo.dimString<1&&.999999<this.edgeInfo.dimString&&(this.edgeInfo.dimString=1),e=this.viewer.getDispalyModelUnit(this.edgeInfo.dimString),this.edgeInfo.dimString*=e.scale,this.edgeInfo.dimString=this.edgeInfo.dimString.toFixed(8),this.edgeInfo.unit=this.getUnitStringmap(e.unit),"line"!=i.type&&(this.edgeInfo.dimString=" "+this.edgeInfo.dimString)))}}1==n&&this.edgeInfo.preSelLineInfo&&(this.edgeInfo.preSelLineInfo=null,this.edgeInfo.preSelLineObj)&&(this.OpMeasure.rootObject.remove(this.edgeInfo.preSelLineObj),this.edgeInfo.preSelLineObj=null)}else this.edgeInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.edgeInfo.preSelLineObj),this.edgeInfo.preSelLineObj=null,this.edgeInfo.preSelLineInfo=null)}},a.prototype.updateMeasureEdgesScene=function(e,t){var n;"measureEdges"!==this.measureType&&"radius"!==this.measureType&&"bodyEdgeLength"!=this.measureType||(this.edgeInfo.selLineObj?this.edgeInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.edgeInfo.preSelLineObj),this.edgeInfo.preSelLineObj=null,this.edgeInfo.preSelLineInfo=null):!(!e||"true"!==e.toLowerCase())?this.edgeInfo.preSelLineInfo&&!this.edgeInfo.preSelLineObj&&(n=this.createLine(this.edgeInfo.preSelLineInfo,!0))&&(this.OpMeasure.rootObject.add(n),this.edgeInfo.preSelLineObj=n):(this.edgeInfo.selLineInfo&&!this.edgeInfo.selLineObj&&(this.edgeInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.edgeInfo.preSelLineObj),this.edgeInfo.preSelLineObj=null,this.edgeInfo.preSelLineInfo=null),n=this.createLine(this.edgeInfo.selLineInfo,!1))&&(this.OpMeasure.rootObject.add(n),this.edgeInfo.selLineObj=n),this.edgeInfo.selLineObj&&this.createAndShowMeasureEdgesDimension(t)))},a.prototype.update3DMeasureEdgesScene=function(e,t){var n;"measureEdges"!==this.measureType&&"radius"!==this.measureType&&"bodyEdgeLength"!=this.measureType||(this.edgeInfo.selLineObj?this.edgeInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.edgeInfo.preSelLineObj),this.edgeInfo.preSelLineObj=null,this.edgeInfo.preSelLineInfo=null):!(!e||"true"!==e.toLowerCase())?this.edgeInfo.preSelLineInfo&&!this.edgeInfo.preSelLineObj&&(n=this.createLine(this.edgeInfo.preSelLineInfo,!0))&&(this.OpMeasure.rootObject.add(n),this.edgeInfo.preSelLineObj=n):(this.edgeInfo.selLineInfo&&!this.edgeInfo.selLineObj&&(this.edgeInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.edgeInfo.preSelLineObj),this.edgeInfo.preSelLineObj=null,this.edgeInfo.preSelLineInfo=null),n=this.createLine(this.edgeInfo.selLineInfo,!1))&&(this.edgeInfo.selLineObj=n),this.edgeInfo.selLineObj&&(NDSWebViewer.SETTING.enableBroadcast&&NDSWebViewer.SETTING.broadcastMajor&&this.OpMeasure.addmeasureTimes(),this.createAndShow3DMeasureEdgesDimension(t,!0),this.OpMeasure.measureEnd())))},a.prototype.createAndShow3DMeasureEdgesDimension=function(e,t){var n,i,s,o,r,a,l,d;"measureEdges"!=this.measureType&&"bodyEdgeLength"!=this.measureType||this.edgeInfo.selLineInfo&&this.edgeInfo.selLineObj&&(n=!1,(n=this.edgeInfo.thirdPos?!0:n)?((a=new THREE.Plane).setFromCoplanarPoints(this.edgeInfo.startPos,this.edgeInfo.midPos,this.edgeInfo.thirdPos),this.edgeInfo.textPos||(this.edgeInfo.textPos=this.edgeInfo.startPos.clone()),e&&(n=this.clientCoordToModelCoordOnPlane(e.x,e.y,a))&&(this.edgeInfo.textPos=n)):(this.edgeInfo.fstClndPos||(this.edgeInfo.fstClndPos=this.edgeInfo.startPos.clone()),this.edgeInfo.sndClndPos||(this.edgeInfo.sndClndPos=this.edgeInfo.endPos.clone()),n=(new THREE.Vector3).subVectors(this.edgeInfo.endPos,this.edgeInfo.startPos),this.edgeInfo.fstClnd&&this.edgeInfo.sndClnd?e&&((a=new THREE.Plane).setFromCoplanarPoints(this.edgeInfo.startPos,this.edgeInfo.endPos,this.edgeInfo.fstClndPos),l=this.clientCoordToModelCoordOnPlane(e.x,e.y,a))&&(d=this.getProjectPntToLine(this.edgeInfo.startPos,this.edgeInfo.fstClndPos,l))&&(i=d.clone().sub(this.edgeInfo.startPos),this.edgeInfo.fstClndPos.addVectors(this.edgeInfo.startPos,i),this.edgeInfo.sndClndPos=this.edgeInfo.fstClndPos.clone().add(n)):"line"==this.edgeInfo.selLineInfo.type?(o=this.viewer.camera.getWorldDirection(),r=(new THREE.Vector3).crossVectors(n,o),r=this.getBaceFaceDir(r),s=(s=n.length())<1?.01:.5,r.normalize().multiplyScalar(s),this.edgeInfo.fstClndPos.add(r),this.edgeInfo.sndClndPos.add(r)):(i=(new THREE.Vector3).subVectors(this.edgeInfo.midPos,this.edgeInfo.startPos),1e-7<(i=(new THREE.Vector3).crossVectors(n,i)).lengthSq()?((i=(new THREE.Vector3).crossVectors(i,n)).normalize().multiplyScalar(.5),this.edgeInfo.fstClndPos.add(i),this.edgeInfo.sndClndPos.add(i)):(o=this.viewer.camera.getWorldDirection(),r=(new THREE.Vector3).crossVectors(n,o),(r=this.getBaceFaceDir(r)).normalize().multiplyScalar(.5),this.edgeInfo.fstClndPos.add(r),this.edgeInfo.sndClndPos.add(r))),this.edgeInfo.textPos?e&&((a=new THREE.Plane).setFromCoplanarPoints(this.edgeInfo.startPos,this.edgeInfo.endPos,this.edgeInfo.fstClndPos),l=this.clientCoordToModelCoordOnPlane(e.x,e.y,a))&&(d=this.getProjectPntToLine(this.edgeInfo.fstClndPos,this.edgeInfo.sndClndPos,l))&&this.edgeInfo.textPos.copy(d):this.edgeInfo.textPos=this.edgeInfo.sndClndPos.clone(),this.edgeInfo.startToClndLine=this.createLineMesh2(this.edgeInfo.startPos,this.edgeInfo.fstClndPos,this.materialLine,1),this.edgeInfo.endToClndLine=this.createLineMesh2(this.edgeInfo.endPos,this.edgeInfo.sndClndPos,this.materialLine,1),i=this.isPointBetweenIn(this.edgeInfo.textPos,this.edgeInfo.fstClndPos,this.edgeInfo.sndClndPos),n.normalize(),i?(this.edgeInfo.fstClnd=this.createCylinderMesh(this.edgeInfo.sndClndPos,this.edgeInfo.fstClndPos,this.materialLine),s=this.OpMeasure.getScale(this.edgeInfo.fstClnd,this.CYLINDERWIDTH),n.multiplyScalar(.5*this.edgeInfo.fstClnd.geometry.parameters.height),this.edgeInfo.fstClnd.oldPosition=this.edgeInfo.fstClndPos.clone(),this.edgeInfo.fstClnd.offsetPos=n.clone(),this.edgeInfo.fstClnd.position.addVectors(this.edgeInfo.fstClndPos,n.clone().multiplyScalar(s))):(this.edgeInfo.fstClnd=this.createCylinderMesh(this.edgeInfo.fstClndPos,this.edgeInfo.sndClndPos,this.materialLine),s=this.OpMeasure.getScale(this.edgeInfo.fstClnd,this.CYLINDERWIDTH),n.multiplyScalar(.5*this.edgeInfo.fstClnd.geometry.parameters.height),this.edgeInfo.fstClnd.oldPosition=this.edgeInfo.fstClndPos.clone(),this.edgeInfo.fstClnd.offsetPos=n.clone().multiplyScalar(-1),this.edgeInfo.fstClnd.position.subVectors(this.edgeInfo.fstClndPos,n.clone().multiplyScalar(s))),i?(this.edgeInfo.sndClnd=this.createCylinderMesh(this.edgeInfo.fstClndPos,this.edgeInfo.sndClndPos,this.materialLine),this.edgeInfo.sndClnd.oldPosition=this.edgeInfo.sndClndPos.clone(),this.edgeInfo.sndClnd.offsetPos=n.clone().multiplyScalar(-1),this.edgeInfo.sndClnd.position.subVectors(this.edgeInfo.sndClndPos,n.clone().multiplyScalar(s))):(this.edgeInfo.sndClnd=this.createCylinderMesh(this.edgeInfo.sndClndPos,this.edgeInfo.fstClndPos,this.materialLine),this.edgeInfo.sndClnd.oldPosition=this.edgeInfo.sndClndPos.clone(),this.edgeInfo.sndClnd.offsetPos=n.clone(),this.edgeInfo.sndClnd.position.addVectors(this.edgeInfo.sndClndPos,n.clone().multiplyScalar(s)))),o="",o=""==this.edgeInfo.dimString[0]?" "+(this.edgeInfo.dimString.slice(2)*this.viewer.measuringScale).toFixed(8)+this.edgeInfo.unit:(this.edgeInfo.dimString*this.viewer.measuringScale).toFixed(8)+this.edgeInfo.unit,r=null,this.edgeInfo.textBox||(this.edgeInfo.textBox=document.createElement("div"),this.edgeInfo.textBox.className="section10",this.edgeInfo.textBox.innerHTML=o,(e=document.createElement("div")).className="sectionPoint",this.edgeInfo.textBox.appendChild(e),(r=document.createElement("div")).className="sectionCross",this.edgeInfo.textBox.appendChild(r),this.viewer.container.appendChild(this.edgeInfo.textBox)),1==t)&&(a={},"line"==this.edgeInfo.selLineInfo.type&&(this.edgeInfo.midPos=this.edgeInfo.startPos.clone().add(this.edgeInfo.endPos).divideScalar(2)),this.edgeInfo.textPos=this.edgeInfo.midPos.clone(),a.dimString=o,a.textPos=this.edgeInfo.textPos.clone(),a.textBox=this.edgeInfo.textBox,(l=new THREE.Group).objectType="Group",l.add(this.edgeInfo.selLineObj),this.OpMeasure.rootObject.add(l),NDSWebViewer.COMMON.isMobileDevice()?(a.textBox.addEventListener("touchstart",this.touchstart,!1),a.textBox.addEventListener("touchend",this.touchend,!1),a.textBox.addEventListener("touchmove",this.touchmove,!1)):(a.textBox.addEventListener("mousedown",this.touchstart,!1),a.textBox.addEventListener("mouseup",this.touchend,!1),a.textBox.addEventListener("mousemove",this.touchmove,!1),a.textBox.addEventListener("mouseleave",this.mouseleave,!1),a.textBox.addEventListener("mouseenter",this.mouseenter,!1)),NDSWebViewer.COMMON.isMobileDevice()?r.addEventListener("touchend",this.sectionCrossend,!1):(r.addEventListener("mousedown",this.sectionCrossend,!1),r.addEventListener("mouseleave",this.crossleave,!1),r.addEventListener("mouseenter",this.crossenter,!1)),(d={}).start=this.edgeInfo.textPos.clone(),d.end=this.edgeInfo.midPos.clone(),d.uuid=l.uuid,this.OpMeasure.textLines.push(d),a.textBox.setAttribute("mobile","up"),a.textBox.setAttribute("group",l.uuid),this.OpMeasure.currentUuid=l.uuid,a.textBox.setAttribute("type","length"),a.textBox.setAttribute("dimString",this.edgeInfo.dimString),a.textBox.setAttribute("dimStringPrefix",""),a.textBox.setAttribute("unit",this.edgeInfo.unit),a.textBox.setAttribute("lineInfo",this.OpMeasure.textLines.length-1),this.OpMeasure.boxInfos.push(a),this.OpMeasure.unsteadyData[l.uuid]=this.DeepCopy(this.edgeInfo,"measureEdges"),this.getAndShowTextBox(this.edgeInfo.textPos.clone(),o,this.edgeInfo.textBox),this.clearEdgeInfo(!0),NDSWebViewer.COMMON.isMobileDevice())&&this.ChangeMeasureFlag()},a.prototype.changeMeasureEdge=function(e){var t,n,i=this.OpMeasure.unsteadyData[this.OpMeasure.unsteadyuuid],s=!1,o=((s=i.thirdPos?!0:s)?((t=new THREE.Plane).setFromCoplanarPoints(i.startPos,i.midPos,i.thirdPos),e&&(s=this.clientCoordToModelCoordOnPlane(e.x,e.y,t))&&i.textPos.copy(s)):(s=(new THREE.Vector3).subVectors(i.endPos,i.startPos),i.fstClnd&&i.sndClnd&&e&&(t=new THREE.Plane,Math.abs(i.startPos.x-i.endPos.x)<1e-6&&Math.abs(i.startPos.x-i.fstClndPos.x)<1e-6&&(i.fstClndPos.x+=10),Math.abs(i.startPos.y-i.endPos.y)<1e-6&&Math.abs(i.startPos.y-i.fstClndPos.y)<1e-6&&(i.fstClndPos.y+=10),t.setFromCoplanarPoints(i.startPos,i.endPos,i.fstClndPos),n=this.clientCoordToModelCoordOnPlane(e.x,e.y,t))&&(o=this.getProjectPntToLine(i.startPos,i.fstClndPos,n))&&(o=o.clone().sub(i.startPos),i.fstClndPos.addVectors(i.startPos,o),i.sndClndPos=i.fstClndPos.clone().add(s)),e&&((t=new THREE.Plane).setFromCoplanarPoints(i.startPos,i.endPos,i.fstClndPos),n=this.clientCoordToModelCoordOnPlane(e.x,e.y,t))&&i.textPos.copy(n)),this.get2dPoint(i.textPos.clone())),s=this.get2dPoint(i.midPos.clone()),e=(this.viewer.renderer.getPixelRatio(),new THREE.Vector2(o.x-s.x,o.y-s.y));e.normalize(),e.y>=e.x/2&&e.y>=-e.x/2?(this.OpMeasure.unsteadyTextBox.childNodes[1].style.left="calc(50% - 6px)",this.OpMeasure.unsteadyTextBox.childNodes[1].style.top="-5.5px",this.OpMeasure.unsteadyTextBox.setAttribute("mobile","down")):e.y>e.x/2&&e.y<-e.x/2?(this.OpMeasure.unsteadyTextBox.childNodes[1].style.left="calc(100% - 4px)",this.OpMeasure.unsteadyTextBox.childNodes[1].style.top="calc(50% - 5.5px)",this.OpMeasure.unsteadyTextBox.setAttribute("mobile","right")):e.y<e.x/2&&e.y<-e.x/2?(this.OpMeasure.unsteadyTextBox.childNodes[1].style.left="calc(50% - 6px)",this.OpMeasure.unsteadyTextBox.childNodes[1].style.top="calc(100% - 5.5px)",this.OpMeasure.unsteadyTextBox.setAttribute("mobile","up")):e.y<e.x/2&&e.y>-e.x/2&&(this.OpMeasure.unsteadyTextBox.childNodes[1].style.left="-5.5px",this.OpMeasure.unsteadyTextBox.childNodes[1].style.top="calc(50% - 5.5px)",this.OpMeasure.unsteadyTextBox.setAttribute("mobile","left"));for(var r=0;r<this.OpMeasure.boxInfos.length;r++){var a=this.OpMeasure.boxInfos[r];if(a.textBox.getAttribute("group")==this.OpMeasure.unsteadyuuid){a.textPos=i.textPos;break}}for(r=0;r<this.OpMeasure.textLines.length;r++){var l=this.OpMeasure.textLines[r];if(l.uuid==this.OpMeasure.unsteadyuuid){l.start=i.textPos.clone(),l.end=i.midPos.clone();break}}this.OpMeasure.viewer.render()},(s.prototype=Object.create(i.prototype)).OperatorStart=function(e){switch(this.measureType=e,this.measureType){case"faceArea":NDSWebViewer.COMMON.isMobileDevice()||this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.FACE);break;case"facePerimeter":this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.FACE)}},s.prototype.onNMouseMove=function(e,t){switch(this.measureType){case"faceArea":this.measurefaceAreaAndPerimeter(e,t,!0);break;case"facePerimeter":this.measurefaceAreaAndPerimeter(e,t,!0,!1,!0)}},s.prototype.onLMouseClick=function(e,t,n){switch(this.measureType){case"faceArea":this.measurefaceAreaAndPerimeter(e,t,!1,n);break;case"facePerimeter":this.measurefaceAreaAndPerimeter(e,t,!1,n,!0)}},s.prototype.renderMeasureScene=function(){this.update2DScene();for(var e=0,t=this.perimeterInfos.length;e<t;e++){var n=this.perimeterInfos[e],i=this.get2dPoint(n.textPos.clone());this.updateTip(n.textimg,i.x,i.y)}},s.prototype.measurefaceAreaAndPerimeter=function(e,t,n,i,s){var o=this.viewer;o.renderer.domElement,o.renderer.getPixelRatio();if(!(s&&null!=i&&1==i||this.viewer.brepManager.version<2&&s)){var r=this.doRaycasterPick(e,t,!1);if(r&&0!=r.length){for(var a=0;a<r.length;){var l,d=this.getSelectInfoFromIntersect(r[a]);if(d&&null!=d.area){if(1==n)this.isTwoTopolInfoTheSame(this.faceInfo.preSelFaceInfo,d)||(this.faceInfo.preSelFaceInfo=d,this.faceInfo.preSelFaceObj&&(this.OpMeasure.rootObject.remove(this.faceInfo.preSelFaceObj),this.faceInfo.preSelFaceObj=null),this.faceInfo.preSelFaceObj=this.createFace(this.faceInfo.preSelFaceInfo,!0),this.faceInfo.preSelFaceObj&&(this.OpMeasure.rootObject.add(this.faceInfo.preSelFaceObj),this.viewer.outlinePass)&&this.viewer.outlinePass.enabled&&((l=[]).push(this.faceInfo.preSelFaceObj),this.viewer.outlinePass.tempSelectedObjects=l));else{for(var c=!1,h=-1,f=0,I=this.faceInfo.selFaceInfors.length;f<I;f++)if(this.isTwoTopolInfoTheSame(this.faceInfo.selFaceInfors[f],d)){c=!0,h=f;break}if(null!=i&&1==i)c?(this.faceInfo.selFaceInfors.splice(h,1),this.OpMeasure.rootObject.remove(this.faceInfo.selFaceObjs[h]),this.faceInfo.selFaceObjs[h]=null,this.faceInfo.selFaceObjs.splice(h,1)):(this.faceInfo.selFaceInfors.push(d),(u=this.createFace(d,!1))&&(this.OpMeasure.rootObject.add(u),this.faceInfo.selFaceObjs.push(u))),s||(this.clearPerimetrBox(),S=(S=(S=this.getSelectedFaceArea())<1&&.999999<S?1:S)*(g=this.viewer.getDispalyModelUnit(S)).scale*g.scale,o.dispatchEvent({type:"FaceSelectionChangeEvent",faceArea:S,modelUnit:g.unit}));else{for(var u,f=this.faceInfo.selFaceInfors.length=0,I=this.faceInfo.selFaceObjs.length;f<I;f++)this.OpMeasure.rootObject.remove(this.faceInfo.selFaceObjs[f]);this.faceInfo.selFaceObjs.length=0,!c&&(this.faceInfo.selFaceInfors.push(d),u=this.createFace(d,!1))&&(this.OpMeasure.rootObject.add(u),this.faceInfo.selFaceObjs.push(u)),s?(this.clearPerimetrBox(),d.edgeInfos&&0<d.edgeInfos.array.length?this.createPerimetrBox(this.getLinePoint(d.edgeInfos.array,d.bodyUuid,d.matrixWorld)):this.createPerimetrBox(this.getedgePoint(d.edgeIDS,d.bodyUuid,d.matrixWorld))):(this.clearPerimetrBox(),S=(S=(S=this.getSelectedFaceArea())<1&&.999999<S?1:S)*(g=this.viewer.getDispalyModelUnit(S)).scale*g.scale,o.dispatchEvent({type:"FaceSelectionChangeEvent",faceArea:S,modelUnit:g.unit}))}}return}a++}if(1==n&&this.faceInfo.preSelFaceInfo&&(this.faceInfo.preSelFaceInfo=null,this.faceInfo.preSelFaceObj)&&(this.OpMeasure.rootObject.remove(this.faceInfo.preSelFaceObj),this.faceInfo.preSelFaceObj=null),!n&&(null==i||0==i)){p=!1;0<this.faceInfo.selFaceInfors.length&&(p=!0);for(f=this.faceInfo.selFaceInfors.length=0,I=this.faceInfo.selFaceObjs.length;f<I;f++)this.OpMeasure.rootObject.remove(this.faceInfo.selFaceObjs[f]);this.faceInfo.selFaceObjs.length=0,p&&(s?(o.dispatchEvent({type:"FaceSelectionPerimeterEvent",perimeters:[]}),this.clearPerimetrBox()):(this.clearPerimetrBox(),S=this.getSelectedFaceArea(),g=this.viewer.getDispalyModelUnit(S=S<1&&.999999<S?1:S),S=S*g.scale*g.scale,o.dispatchEvent({type:"FaceSelectionChangeEvent",faceArea:S,modelUnit:g.unit})))}}else if(this.faceInfo.preSelFaceObj&&(this.OpMeasure.rootObject.remove(this.faceInfo.preSelFaceObj),this.faceInfo.preSelFaceObj=null,this.faceInfo.preSelFaceInfo=null),this.viewer.outlinePass&&this.viewer.outlinePass.enabled&&(this.viewer.outlinePass.tempSelectedObjects.length=0),!n&&(null==i||0==i)){var p=!1;0<this.faceInfo.selFaceInfors.length&&(p=!0);for(var S,g,f=this.faceInfo.selFaceInfors.length=0,I=this.faceInfo.selFaceObjs.length;f<I;f++)this.OpMeasure.rootObject.remove(this.faceInfo.selFaceObjs[f]);this.faceInfo.selFaceObjs.length=0,p&&(s?(o.dispatchEvent({type:"FaceSelectionPerimeterEvent",perimeters:[]}),this.clearPerimetrBox()):(this.clearPerimetrBox(),S=this.getSelectedFaceArea(),g=this.viewer.getDispalyModelUnit(S=S<1&&.999999<S?1:S),S=S*g.scale*g.scale,o.dispatchEvent({type:"FaceSelectionChangeEvent",faceArea:S,modelUnit:g.unit})))}}},s.prototype.getSelectedFacePerimeter=function(){for(var e=0,t=0,n=this.faceInfo.selFaceInfors.length;t<n;t++)e+=parseFloat(this.faceInfo.selFaceInfors[t].perimeter);return e},s.prototype.createPerimetrBox=function(e){var t=[];if(0!=e.length){for(var n=this.viewer.getDispalyModelUnit(e[0].perimeter),i=0;i<e.length;i++){var s,o,r,a=e[i].perimeter,l=e[i].startPos;a&&l&&(this.distanceInfo.unit=this.getUnitString(),s=i+1,o={},r=this.get2dPoint(l.clone()),(r=this.addAnnotationTip(i+1,r.x,r.y))&&this.viewer.container.appendChild(r),o.dimString=s,o.textPos=l.clone(),o.textimg=r,this.perimeterInfos.push(o),a*=n.scale,t[i]=a.toFixed(this.viewer.Decimal))}this.viewer.dispatchEvent({type:"FaceSelectionPerimeterEvent",perimeters:t,modelUnit:n.unit}),NDSWebViewer.COMMON.isMobileDevice()&&this.ChangeMeasureFlag(),this.OpMeasure.perimeterunit=n.unit,this.OpMeasure.perimeterBroadcast=t}},s.prototype.getLinePoint=function(e,t,n){for(var i,s=[],o=null,r=0;r<e.length;++r){var a,l,d,c,h=e[r],f=this.viewer.brepManager.GetEdegMeshIDfromID(t,h.id),f=this.viewer.ndsModel.geomManager.getGeomFromUuid(this.viewer.ndsModel.meshUuid2GeomUuidMap[f],0),I=h.indexRange.concat();this.viewer.ndsModel&&(I[0]+=f.drawRange.start/2,I[1]+=f.drawRange.start/2),f.isBufferGeometry&&(a=f.index,f=f.attributes.position.array,null!=a)&&(a=a.array,l=new THREE.Vector3,d=new THREE.Vector3,c=I[0],I=I[1],l.fromArray(f,3*a[2*c]),d.fromArray(f,3*a[2*I+1]),d.distanceTo(l)<1e-7&&(new THREE.Vector3).fromArray(f,3*a[2*(I-1)]),l.applyMatrix4(n),d.applyMatrix4(n),c={startPos:l,endPos:d,perimeter:h.length},s.push(c))}for(var u=[],p=0;p<s.length;++p){for(var S=(o=s.shift()).perimeter,g=0;g<s.length;++g)o.startPos.distanceTo((i=s[g]).endPos)<1e-7?(o.startPos.copy(i.startPos),s.splice(g,1),g=-1,S+=i.perimeter):o.endPos.distanceTo(i.startPos)<1e-7?(o.endPos.copy(i.endPos),s.splice(g,1),g=-1,S+=i.perimeter):o.endPos.distanceTo(i.endPos)<1e-7?(o.endPos.copy(i.startPos),s.splice(g,1),g=-1,S+=i.perimeter):o.startPos.distanceTo(i.startPos)<1e-7&&(o.startPos.copy(i.endPos),s.splice(g,1),g=-1,S+=i.perimeter);o.perimeter=S,u.push(o),p=-1}return u},s.prototype.getedgePoint=function(e,t,n){for(var i,s,o,r,a,l,d=0;d<e.length;++d)e[d].perimeter<1e-10||(i=(l=(i=(s=this.viewer.getNdsModelForMeasure()).brepManager||this.viewer.brepManager).GetEdgeInfoFromFace(t,e[d].startID).array[0]).geomUUID?s.geomManager.getGeomFromUuid(l.geomUUID,0):(i=i.GetEdegMeshIDfromID(t,e[d].startID),s.geomManager.getGeomFromUuid(s.meshUuid2GeomUuidMap[i],0)),l=l.indexRange.concat(),s&&(l[0]+=i.drawRange.start/2,l[1]+=i.drawRange.start/2),i.isBufferGeometry&&(s=i.index,i=i.attributes.position.array,null!=s)&&(s=s.array,o=new THREE.Vector3,r=new THREE.Vector3,a=l[0],l=l[1],o.fromArray(i,3*s[2*a]),r.fromArray(i,3*s[2*l+1]),r.distanceTo(o)<1e-7&&(new THREE.Vector3).fromArray(i,3*s[2*(l-1)]),o.applyMatrix4(n),r.applyMatrix4(n),e[d].startPos=o));return e},(l.prototype=Object.create(i.prototype)).OperatorStart=function(e){switch(this.measureType=e,this.measureType){case"bodyAngle":this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.FIRMEASUREBODY);break;case"LineAngle":this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.FIRSTLINE);break;case"LineFaceAngle":this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.LINEPLANE);break;case"faceAngle":this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.FIRSTPLANE);break;case"angle":this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.FIRSTPOINT)}},l.prototype.onNMouseMove=function(e,t){var n,i,s=new THREE.Vector3(e,t,0);if(this.OpMeasure.unsteady)this.changeLineAngle(s);else switch(this.measureType){case"bodyAngle":this.lineAngleInfo.firstLineObj&&this.lineAngleInfo.secondLineObj&&!NDSWebViewer.COMMON.isMobileDevice()?this.lineAngleInfo.twoPlane?(i=this.viewer.clientCoordToModelCoord([e,t]),s.set(i[0],i[1],i[2]),this.createAndShowFaceAngleDimension(s)):this.createAndShowLineAngleDimension(s):(n=4<this.viewer.brepManager.version?["line","plane","cylinder","cone"]:["line","plane","cylinder"],this.measureBodyAngle(e,t,!0,n),this.updateBodyAngleScene("true"));break;case"LineAngle":this.lineAngleInfo.firstLineObj&&this.lineAngleInfo.secondLineObj&&!NDSWebViewer.COMMON.isMobileDevice()?this.createAndShowLineAngleDimension(s):(this.measureLineAngle(e,t,!0,n=["line"]),this.updateLineAngleScene("true"));break;case"LineFaceAngle":this.lineAngleInfo.firstLineObj&&this.lineAngleInfo.secondLineObj&&!NDSWebViewer.COMMON.isMobileDevice()?this.createAndShowLineAngleDimension(s):(n=[],this.lineAngleInfo.firstLineInfo||this.lineAngleInfo.secondLineInfo?"plane"==this.lineAngleInfo.firstLineInfo.type?n=["line"]:"line"==this.lineAngleInfo.firstLineInfo.type&&(n=["plane"]):n=["plane","line"],this.measureLineAngle(e,t,!0,n),this.updateLineAngleScene("true"));break;case"faceAngle":this.faceInfo.fstSelFaceObj&&this.faceInfo.sndSelFaceObj&&!NDSWebViewer.COMMON.isMobileDevice()?(i=this.viewer.clientCoordToModelCoord([e,t]),s.set(i[0],i[1],i[2]),this.createAndShowFaceAngleDimension(s)):(this.measurefaceAngle(e,t,!0),this.updateFaceAngleScene("true"));break;case"angle":this.lineAngleInfo.firstLineObj&&this.lineAngleInfo.secondLineObj&&!NDSWebViewer.COMMON.isMobileDevice()?this.createAndShowLineAngleDimension(s):this.previewSnappedPoint(e,t,!0)}},l.prototype.onLMouseClick=function(e,t,n){var i,s,o=new THREE.Vector3(e,t,0);switch(this.measureType){case"bodyAngle":this.lineAngleInfo.firstLineObj&&this.lineAngleInfo.secondLineObj?(this.viewer.is2DModel?this.lineAngleInfo.twoPlane?(i=this.viewer.clientCoordToModelCoord([e,t]),o.set(i[0],i[1],i[2]),this.createAndShowFaceAngleDimension(o,!0)):this.createAndShowLineAngleDimension(o,!0):this.lineAngleInfo.twoPlane?(i=this.viewer.clientCoordToModelCoord([e,t]),o.set(i[0],i[1],i[2]),this.createAndShow3DFaceAngleDimension(o,!0)):this.createAndShow3DLineAngleDimension(o,!0),this.OperatorStart(this.measureType)):(s=4<this.viewer.brepManager.version?["line","plane","cylinder","cone"]:["line","plane","cylinder"],this.measureBodyAngle(e,t,!1,s),this.updateBodyAngleScene("false"),this.viewer.is2DModel?this.lineAngleInfo.twoPlane?(i=this.viewer.clientCoordToModelCoord([e,t]),o.set(i[0],i[1],i[2]),this.createAndShowFaceAngleDimension(o,!1)):this.createAndShowLineAngleDimension(o,!1):this.createAndShow3DLineAngleDimension(o,!0),this.lineAngleInfo.firstLineObj&&!this.lineAngleInfo.secondLineObj&&this.OpMeasure.InfoType<=NDSWebViewer.NDS.INFOTYPE.MEASURENOTICEBEGIN?this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.SECMEASUREBODY):this.lineAngleInfo.firstLineObj&&this.lineAngleInfo.secondLineObj?this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.ENDMEASURE):this.lineAngleInfo.firstLineObj||this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.FIRMEASUREBODY));break;case"LineAngle":this.lineAngleInfo.firstLineObj&&this.lineAngleInfo.secondLineObj?(this.viewer.is2DModel?this.createAndShowLineAngleDimension(o,!0):this.createAndShow3DLineAngleDimension(o,!0),this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.FIRSTLINE)):(this.measureLineAngle(e,t,!(s=["line"]),s),this.updateLineAngleScene("false"),this.viewer.is2DModel?this.createAndShowLineAngleDimension(o,!1):this.createAndShow3DLineAngleDimension(o,!0),this.lineAngleInfo.firstLineObj&&!this.lineAngleInfo.secondLineObj&&this.OpMeasure.InfoType!=NDSWebViewer.NDS.INFOTYPE.LINEPARALLEL&&this.OpMeasure.InfoType!=NDSWebViewer.NDS.INFOTYPE.PLANEPARALLELLINE&&this.OpMeasure.InfoType!=NDSWebViewer.NDS.INFOTYPE.LINEPARALLELPLANE?this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.SECONDLINE):this.lineAngleInfo.firstLineObj&&this.lineAngleInfo.secondLineObj?this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.ENDMEASURE):this.lineAngleInfo.firstLineObj||this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.FIRSTLINE));break;case"LineFaceAngle":this.lineAngleInfo.firstLineObj&&this.lineAngleInfo.secondLineObj?(this.createAndShowLineAngleDimension(o,!0),this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.LINEPLANE)):(s=[],this.lineAngleInfo.firstLineInfo||this.lineAngleInfo.secondLineInfo?"plane"==this.lineAngleInfo.firstLineInfo.type?s=["line"]:"line"==this.lineAngleInfo.firstLineInfo.type&&(s=["plane"]):s=["plane","line"],this.measureLineAngle(e,t,!1,s),this.updateLineAngleScene("false"),this.viewer.is2DModel?this.createAndShowLineAngleDimension(o,!1):this.createAndShow3DLineAngleDimension(o,!0),this.lineAngleInfo.firstLineInfo&&"plane"==this.lineAngleInfo.firstLineInfo.type&&!this.lineAngleInfo.secondLineInfo&&this.OpMeasure.InfoType<=NDSWebViewer.NDS.INFOTYPE.MEASURENOTICEBEGIN?this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.LINE):this.lineAngleInfo.firstLineInfo&&"line"==this.lineAngleInfo.firstLineInfo.type&&!this.lineAngleInfo.secondLineInfo&&this.OpMeasure.InfoType<=NDSWebViewer.NDS.INFOTYPE.MEASURENOTICEBEGIN?this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.PLANE):this.lineAngleInfo.firstLineInfo&&this.lineAngleInfo.secondLineInfo?this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.ENDMEASURE):!this.lineAngleInfo.firstLineInfo&&this.OpMeasure.InfoType<=NDSWebViewer.NDS.INFOTYPE.MEASURENOTICEBEGIN&&this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.LINEPLANE));break;case"faceAngle":this.faceInfo.fstSelFaceObj&&this.faceInfo.sndSelFaceObj?(i=this.viewer.clientCoordToModelCoord([e,t]),o.set(i[0],i[1],i[2]),this.createAndShowFaceAngleDimension(o,!0),this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.FIRSTPLANE)):(this.measurefaceAngle(e,t,!1),this.updateFaceAngleScene("false"),this.viewer.is2DModel?this.createAndShowLineAngleDimension(o,!1):this.createAndShow3DLineAngleDimension(o,!0),this.faceInfo.fstSelFaceObj&&!this.faceInfo.sndSelFaceObj&&this.OpMeasure.InfoType<=NDSWebViewer.NDS.INFOTYPE.MEASURENOTICEBEGIN?this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.SECONDPLANE):this.faceInfo.fstSelFaceObj&&this.faceInfo.sndSelFaceObj?this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.ENDMEASURE):!this.faceInfo.fstSelFaceObj&&this.OpMeasure.InfoType<=NDSWebViewer.NDS.INFOTYPE.MEASURENOTICEBEGIN&&this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.FIRSTPLANE));break;case"angle":this.lineAngleInfo.firstLineObj&&this.lineAngleInfo.secondLineObj?(this.viewer.is2DModel?this.createAndShowLineAngleDimension(o,!0):this.createAndShow3DLineAngleDimension(o,!0),this.lineAngleInfo.firstHelpPointInfo||this.lineAngleInfo.secHelpPointInfo||this.lineAngleInfo.thrHelpPointInfo||this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.FIRSTPOINT)):(this.AngleMeasure(e,t),this.lineAngleInfo.thrHelpPointInfo&&this.lineAngleInfo.firstHelpPointInfo&&this.lineAngleInfo.secHelpPointInfo&&(s=new THREE.Vector2(this.lineAngleInfo.firstHelpPointInfo.x-this.lineAngleInfo.secHelpPointInfo.x,this.lineAngleInfo.firstHelpPointInfo.y-this.lineAngleInfo.secHelpPointInfo.y),i=new THREE.Vector2(this.lineAngleInfo.thrHelpPointInfo.x-this.lineAngleInfo.secHelpPointInfo.x,this.lineAngleInfo.thrHelpPointInfo.y-this.lineAngleInfo.secHelpPointInfo.y),s=s.add(i).divideScalar(2),o.setX(this.lineAngleInfo.secHelpPointInfo.x+s.x),o.setY(this.lineAngleInfo.secHelpPointInfo.y+s.y)),this.updateLineAngleScene("false"),this.viewer.is2DModel?this.createAndShowLineAngleDimension(o,!1):this.createAndShow3DLineAngleDimension(o,!0),this.lineAngleInfo.firstHelpPointInfo||this.lineAngleInfo.secHelpPointInfo||this.lineAngleInfo.thrHelpPointInfo?!this.lineAngleInfo.firstHelpPointInfo||this.lineAngleInfo.secHelpPointInfo||this.lineAngleInfo.thrHelpPointInfo?this.lineAngleInfo.firstHelpPointInfo&&this.lineAngleInfo.secHelpPointInfo&&!this.lineAngleInfo.thrHelpPointInfo&&this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.THIRDPOINT):this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.SECONDPOINT):this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.FIRSTPOINT))}},l.prototype.createAndShowLineAngleDimension=function(e,t){if(this.lineAngleInfo.firstLineObj&&this.lineAngleInfo.secondLineObj){var n=this.lineAngleInfo.firstLineInfo.start,i=(new THREE.Vector3).subVectors(this.lineAngleInfo.firstLineInfo.end,this.lineAngleInfo.firstLineInfo.start),s=(i.normalize(),i.clone().negate()),o=this.lineAngleInfo.secondLineInfo.start,r=(new THREE.Vector3).subVectors(this.lineAngleInfo.secondLineInfo.end,this.lineAngleInfo.secondLineInfo.start),a=(r.normalize(),r.clone().negate()),n=(this.lineAngleInfo.arcCenter||(this.lineAngleInfo.arcCenter=this.getIntersectPointOfTwoLine(n,i,o,r),this.lineAngleInfo.fstClndPos=new THREE.Vector3,this.lineAngleInfo.sndClndPos=new THREE.Vector3),(new THREE.Vector3).addVectors(this.lineAngleInfo.arcCenter,i)),o=(new THREE.Vector3).addVectors(this.lineAngleInfo.arcCenter,r),l=new THREE.Plane,n=(l.setFromCoplanarPoints(this.lineAngleInfo.arcCenter,n,o),this.clientCoordToModelCoordOnPlane(e.x,e.y,l));if(n){this.lineAngleInfo.textPos=n;o=(new THREE.Vector3).subVectors(this.lineAngleInfo.textPos,this.lineAngleInfo.arcCenter),e=o.length(),l=(o.normalize(),i),n=r;this.isBetweenTwoVectors(o,i,r)?(l=i,n=r):this.isBetweenTwoVectors(o,i,a)?(l=i,n=a):this.isBetweenTwoVectors(o,s,r)?(l=s,n=r):this.isBetweenTwoVectors(o,s,a)&&(l=s,n=a);o=(o=l.angleTo(n))/Math.PI*180;this.lineAngleInfo.dimString=o.toFixed(8),this.lineAngleInfo.fstClndPos.addVectors(this.lineAngleInfo.arcCenter,l.clone().multiplyScalar(e)),this.lineAngleInfo.sndClndPos.addVectors(this.lineAngleInfo.arcCenter,n.clone().multiplyScalar(e));for(var d=0;d<this.lineAngleInfo.arcMeshes.length;d++)this.OpMeasure.rootObject.remove(this.lineAngleInfo.arcMeshes[d]),this.lineAngleInfo.arcMeshes[d]=null;if(this.lineAngleInfo.arcMeshes=this.createAngleArcMeshes2(this.lineAngleInfo.fstClndPos,this.lineAngleInfo.arcCenter,this.lineAngleInfo.sndClndPos,this.ARCWIDTH),0!=this.lineAngleInfo.arcMeshes.length){for(d=0;d<this.lineAngleInfo.arcMeshes.length;d++)this.OpMeasure.rootObject.add(this.lineAngleInfo.arcMeshes[d]);this.lineAngleInfo.fstClnd&&this.OpMeasure.rootObject.remove(this.lineAngleInfo.fstClnd),this.lineAngleInfo.fstClnd=this.createCylinderMesh(this.lineAngleInfo.arcMeshes[1].geometry.vertices[0],this.lineAngleInfo.fstClndPos,this.materialLine);var c,h,o=(new THREE.Vector3).subVectors(this.lineAngleInfo.fstClndPos,this.lineAngleInfo.arcMeshes[1].geometry.vertices[0]),l=(o.normalize(),this.OpMeasure.getScale(this.lineAngleInfo.fstClnd,this.CYLINDERWIDTH)),n=(o.multiplyScalar(.5*this.lineAngleInfo.fstClnd.geometry.parameters.height),this.lineAngleInfo.fstClnd.oldPosition=this.lineAngleInfo.fstClndPos.clone(),this.lineAngleInfo.fstClnd.offsetPos=o.clone().multiplyScalar(-1),this.lineAngleInfo.fstClnd.position.subVectors(this.lineAngleInfo.fstClndPos,o.clone().multiplyScalar(l)),this.OpMeasure.rootObject.add(this.lineAngleInfo.fstClnd),this.lineAngleInfo.sndClnd&&this.OpMeasure.rootObject.remove(this.lineAngleInfo.sndClnd),this.lineAngleInfo.sndClnd=this.createCylinderMesh(this.lineAngleInfo.arcMeshes[this.lineAngleInfo.arcMeshes.length-2].geometry.vertices[0],this.lineAngleInfo.sndClndPos,this.materialLine),(new THREE.Vector3).subVectors(this.lineAngleInfo.sndClndPos,this.lineAngleInfo.arcMeshes[this.lineAngleInfo.arcMeshes.length-2].geometry.vertices[0])),l=(n.normalize(),this.OpMeasure.getScale(this.lineAngleInfo.sndClnd,this.CYLINDERWIDTH)),e=(n.multiplyScalar(.5*this.lineAngleInfo.sndClnd.geometry.parameters.height),this.lineAngleInfo.sndClnd.oldPosition=this.lineAngleInfo.sndClndPos.clone(),this.lineAngleInfo.sndClnd.offsetPos=n.clone().multiplyScalar(-1),this.lineAngleInfo.sndClnd.position.subVectors(this.lineAngleInfo.sndClndPos,n.clone().multiplyScalar(l)),this.OpMeasure.rootObject.add(this.lineAngleInfo.sndClnd),this.lineAngleInfo.auxLine1&&(this.OpMeasure.rootObject.remove(this.lineAngleInfo.auxLine1),this.lineAngleInfo.auxLine1=null),this.lineAngleInfo.firstLineInfo.start.distanceTo(this.lineAngleInfo.firstLineInfo.end)),o=this.lineAngleInfo.fstClndPos.distanceTo(this.lineAngleInfo.firstLineInfo.start),n=this.lineAngleInfo.fstClndPos.distanceTo(this.lineAngleInfo.firstLineInfo.end),l=(this.isZero(o+n-e)||(h=n<o?(c=this.lineAngleInfo.firstLineInfo.end,(new THREE.Vector3).addVectors(c,i.clone().multiplyScalar(1.3*n))):(c=this.lineAngleInfo.firstLineInfo.start,(new THREE.Vector3).addVectors(c,s.clone().multiplyScalar(1.3*o))),this.lineAngleInfo.auxLine1=this.createLineMesh2(c,h,this.materialLine,1),this.OpMeasure.rootObject.add(this.lineAngleInfo.auxLine1)),this.lineAngleInfo.auxLine2&&(this.OpMeasure.rootObject.remove(this.lineAngleInfo.auxLine2),this.lineAngleInfo.auxLine2=null),e=this.lineAngleInfo.secondLineInfo.start.distanceTo(this.lineAngleInfo.secondLineInfo.end),o=this.lineAngleInfo.sndClndPos.distanceTo(this.lineAngleInfo.secondLineInfo.start),n=this.lineAngleInfo.sndClndPos.distanceTo(this.lineAngleInfo.secondLineInfo.end),this.isZero(o+n-e)||(h=n<o?(c=this.lineAngleInfo.secondLineInfo.end,(new THREE.Vector3).addVectors(c,r.clone().multiplyScalar(1.3*n))):(c=this.lineAngleInfo.secondLineInfo.start,(new THREE.Vector3).addVectors(c,a.clone().multiplyScalar(1.3*o))),this.lineAngleInfo.auxLine2=this.createLineMesh2(c,h,this.materialLine,1),this.OpMeasure.rootObject.add(this.lineAngleInfo.auxLine2)),this.lineAngleInfo.dimString+this.lineAngleInfo.unit);this.lineAngleInfo.textBox||(this.lineAngleInfo.textBox=document.createElement("div"),this.lineAngleInfo.textBox.className="mearesult",this.viewer.container.appendChild(this.lineAngleInfo.textBox)),this.getAndShowTextBox(this.lineAngleInfo.textPos.clone(),l,this.lineAngleInfo.textBox),t&&((i={}).dimString=l,i.textPos=this.lineAngleInfo.textPos.clone(),i.textBox=this.lineAngleInfo.textBox,i.textBox.setAttribute("type","angle"),i.textBox.setAttribute("dimString",this.lineAngleInfo.dimString),i.textBox.setAttribute("unit",this.lineAngleInfo.unit),this.OpMeasure.boxInfos.push(i),this.clearLineAngleInfo(!0),NDSWebViewer.COMMON.isMobileDevice()&&this.ChangeMeasureFlag(),this.OpMeasure.measureEnd(),NDSWebViewer.SETTING.enableBroadcast)&&NDSWebViewer.SETTING.broadcastMajor&&this.OpMeasure.addmeasureTimes()}}}},l.prototype.createAndShow3DLineAngleDimension=function(e,t){if(this.lineAngleInfo.firstLineObj&&this.lineAngleInfo.secondLineObj||this.faceInfo.fstIntersect&&this.faceInfo.sndIntersect){var n=this.lineAngleInfo.firstLineInfo.start,i=(new THREE.Vector3).subVectors(this.lineAngleInfo.firstLineInfo.end,this.lineAngleInfo.firstLineInfo.start),s=(i.normalize(),i.clone().negate()),o=this.lineAngleInfo.secondLineInfo.start,r=(new THREE.Vector3).subVectors(this.lineAngleInfo.secondLineInfo.end,this.lineAngleInfo.secondLineInfo.start),a=(r.normalize(),r.clone().negate()),n=(this.lineAngleInfo.arcCenter||(this.lineAngleInfo.arcCenter=this.getIntersectPointOfTwoLine(n,i,o,r),this.lineAngleInfo.fstClndPos=new THREE.Vector3,this.lineAngleInfo.sndClndPos=new THREE.Vector3),(new THREE.Vector3).subVectors(this.lineAngleInfo.firstLineInfo.end,this.lineAngleInfo.firstLineInfo.start)),o=(new THREE.Vector3).subVectors(this.lineAngleInfo.secondLineInfo.end,this.lineAngleInfo.secondLineInfo.start),n=.8*Math.max(Math.min(n.length(),o.length()),.1),o=(new THREE.Vector3).addVectors(i,r),l=(o.normalize(),this.lineAngleInfo.textPos=(new THREE.Vector3).addVectors(this.lineAngleInfo.arcCenter,o.clone().multiplyScalar(n)),(new THREE.Vector3).addVectors(this.lineAngleInfo.arcCenter,i)),d=(new THREE.Vector3).addVectors(this.lineAngleInfo.arcCenter,r),c=new THREE.Plane,l=(c.setFromCoplanarPoints(this.lineAngleInfo.arcCenter,l,d),c.normal.length()<1e-8&&c.setFromCoplanarPoints(this.lineAngleInfo.arcCenter.clone().add(new THREE.Vector3(1,-1,1)),l,d),this.clientCoordToModelCoordOnPlane(e.x,e.y,c)),d=(l&&(this.lineAngleInfo.textPos=l),this.lineAngleInfo.arcCenter.distanceTo(l)),e=i,c=r,c=r,l=(e=i).angleTo(c),l=(90<(l=l/Math.PI*180)&&(l=(l=(e=i).angleTo(c=a))/Math.PI*180),this.lineAngleInfo.dimString=l.toFixed(8),(o=(new THREE.Vector3).addVectors(e,e)).normalize(),(new THREE.Vector3).subVectors(this.lineAngleInfo.textPos,this.lineAngleInfo.arcCenter)),h=this.viewer.clientCoordToModelCoord([0,0]),h=new THREE.Vector3(h[0],h[1],h[2]),f=this.viewer.clientCoordToModelCoord([40,0]),f=new THREE.Vector3(f[0],f[1],f[2]),n=h.distanceTo(f);n=Math.max(n,d),l.normalize(),90<l.angleTo(o)/Math.PI*180&&(o.negate(),e.negate(),c.negate()),this.lineAngleInfo.textPos=(new THREE.Vector3).addVectors(this.lineAngleInfo.arcCenter,o.clone().multiplyScalar(n));h=(new THREE.Vector3).subVectors(this.lineAngleInfo.textPos,this.lineAngleInfo.arcCenter).length();if(this.lineAngleInfo.fstClndPos.addVectors(this.lineAngleInfo.arcCenter,e.clone().multiplyScalar(h)),this.lineAngleInfo.sndClndPos.addVectors(this.lineAngleInfo.arcCenter,c.clone().multiplyScalar(h)),this.lineAngleInfo.arcMeshes=this.createAngleArcMeshes2(this.lineAngleInfo.fstClndPos,this.lineAngleInfo.arcCenter,this.lineAngleInfo.sndClndPos,this.ARCWIDTH,this.appmaterialLine),0!=this.lineAngleInfo.arcMeshes.length){this.lineAngleInfo.fstClnd&&this.OpMeasure.rootObject.remove(this.lineAngleInfo.fstClnd),this.lineAngleInfo.fstClnd=this.createCylinderMesh(this.lineAngleInfo.arcMeshes[1].geometry.vertices[0],this.lineAngleInfo.fstClndPos,this.appmaterialLine);var I,u,f=(new THREE.Vector3).subVectors(this.lineAngleInfo.fstClndPos,this.lineAngleInfo.arcMeshes[1].geometry.vertices[0]),d=(f.normalize(),this.OpMeasure.getScale(this.lineAngleInfo.fstClnd,this.CYLINDERWIDTH)),l=(f.multiplyScalar(.5*this.lineAngleInfo.fstClnd.geometry.parameters.height),this.lineAngleInfo.fstClnd.oldPosition=this.lineAngleInfo.fstClndPos.clone(),this.lineAngleInfo.fstClnd.offsetPos=f.clone().multiplyScalar(-1),this.lineAngleInfo.fstClnd.position.subVectors(this.lineAngleInfo.fstClndPos,f.clone().multiplyScalar(d)),this.lineAngleInfo.sndClnd=this.createCylinderMesh(this.lineAngleInfo.arcMeshes[this.lineAngleInfo.arcMeshes.length-2].geometry.vertices[0],this.lineAngleInfo.sndClndPos,this.appmaterialLine),(new THREE.Vector3).subVectors(this.lineAngleInfo.sndClndPos,this.lineAngleInfo.arcMeshes[this.lineAngleInfo.arcMeshes.length-2].geometry.vertices[0])),d=(l.normalize(),this.OpMeasure.getScale(this.lineAngleInfo.sndClnd,this.CYLINDERWIDTH)),o=(l.multiplyScalar(.5*this.lineAngleInfo.sndClnd.geometry.parameters.height),this.lineAngleInfo.sndClnd.oldPosition=this.lineAngleInfo.sndClndPos.clone(),this.lineAngleInfo.sndClnd.offsetPos=l.clone().multiplyScalar(-1),this.lineAngleInfo.sndClnd.position.subVectors(this.lineAngleInfo.sndClndPos,l.clone().multiplyScalar(d)),this.lineAngleInfo.firstLineInfo.start.distanceTo(this.lineAngleInfo.firstLineInfo.end)),n=this.lineAngleInfo.fstClndPos.distanceTo(this.lineAngleInfo.firstLineInfo.start),e=this.lineAngleInfo.fstClndPos.distanceTo(this.lineAngleInfo.firstLineInfo.end),c=(this.isZero(n+e-o)||(u=e<n?(I=this.lineAngleInfo.firstLineInfo.end,(new THREE.Vector3).addVectors(I,i.clone().multiplyScalar(1.3*e))):(I=this.lineAngleInfo.firstLineInfo.start,(new THREE.Vector3).addVectors(I,s.clone().multiplyScalar(1.3*n))),this.lineAngleInfo.auxLine1=this.createLineMesh2(I,u,this.appmaterialLine,1)),o=this.lineAngleInfo.secondLineInfo.start.distanceTo(this.lineAngleInfo.secondLineInfo.end),n=this.lineAngleInfo.sndClndPos.distanceTo(this.lineAngleInfo.secondLineInfo.start),e=this.lineAngleInfo.sndClndPos.distanceTo(this.lineAngleInfo.secondLineInfo.end),this.isZero(n+e-o)||(u=e<n?(I=this.lineAngleInfo.secondLineInfo.end,(new THREE.Vector3).addVectors(I,r.clone().multiplyScalar(1.3*e))):(I=this.lineAngleInfo.secondLineInfo.start,(new THREE.Vector3).addVectors(I,a.clone().multiplyScalar(1.3*n))),this.lineAngleInfo.auxLine2=this.createLineMesh2(I,u,this.appmaterialLine,1)),this.lineAngleInfo.dimString+this.lineAngleInfo.unit),h=null;if(this.lineAngleInfo.textBox||(this.lineAngleInfo.textBox=document.createElement("div"),this.lineAngleInfo.textBox.className="section10",this.lineAngleInfo.textBox.innerHTML=c,(f=document.createElement("div")).className="sectionPoint",this.lineAngleInfo.textBox.appendChild(f),(h=document.createElement("div")).className="sectionCross",this.lineAngleInfo.textBox.appendChild(h),this.viewer.container.appendChild(this.lineAngleInfo.textBox)),t){var l={},d=(l.dimString=c,l.textPos=this.lineAngleInfo.textPos.clone(),l.textBox=this.lineAngleInfo.textBox,new THREE.Group),p=new THREE.Group;d.objectType="Group",p.objectType="Group",p.name="unsteady";for(var S=0;S<this.lineAngleInfo.arcMeshes.length;S++)p.add(this.lineAngleInfo.arcMeshes[S]);p.add(this.lineAngleInfo.fstClnd),p.add(this.lineAngleInfo.sndClnd),this.lineAngleInfo.auxLine1&&p.add(this.lineAngleInfo.auxLine1),this.lineAngleInfo.auxLine2&&p.add(this.lineAngleInfo.auxLine2),this.lineAngleInfo.firstLineObj&&this.lineAngleInfo.secondLineObj&&(this.OpMeasure.rootObject.remove(this.lineAngleInfo.firstLineObj),this.OpMeasure.rootObject.remove(this.lineAngleInfo.secondLineObj),d.add(this.lineAngleInfo.firstLineObj),d.add(this.lineAngleInfo.secondLineObj)),this.faceInfo.fstSelFaceObj&&this.faceInfo.sndSelFaceObj&&(this.OpMeasure.rootObject.remove(this.faceInfo.sndSelFaceObj),this.OpMeasure.rootObject.remove(this.faceInfo.fstSelFaceObj),d.add(this.faceInfo.sndSelFaceObj),d.add(this.faceInfo.fstSelFaceObj)),d.add(p),this.OpMeasure.rootObject.add(d),NDSWebViewer.COMMON.isMobileDevice()?(l.textBox.addEventListener("touchstart",this.touchstart,!1),l.textBox.addEventListener("touchend",this.touchend,!1),l.textBox.addEventListener("touchmove",this.touchmove,!1)):(l.textBox.addEventListener("mousedown",this.touchstart,!1),l.textBox.addEventListener("mouseup",this.touchend,!1),l.textBox.addEventListener("mousemove",this.touchmove,!1),l.textBox.addEventListener("mouseleave",this.mouseleave,!1),l.textBox.addEventListener("mouseenter",this.mouseenter,!1)),NDSWebViewer.COMMON.isMobileDevice()?h.addEventListener("touchend",this.sectionCrossend,!1):(h.addEventListener("mousedown",this.sectionCrossend,!1),h.addEventListener("mouseleave",this.crossleave,!1),h.addEventListener("mouseenter",this.crossenter,!1)),l.textBox.setAttribute("mobile","up"),l.textBox.setAttribute("group",d.uuid),this.OpMeasure.currentUuid=d.uuid,l.textBox.setAttribute("type","angle"),l.textBox.setAttribute("dimString",this.lineAngleInfo.dimString),l.textBox.setAttribute("unit",this.lineAngleInfo.unit),this.OpMeasure.unsteadyData[d.uuid]=this.DeepCopy(this.lineAngleInfo,"Angle"),this.getAndShowTextBox(this.lineAngleInfo.textPos.clone(),c,this.lineAngleInfo.textBox),this.OpMeasure.boxInfos.push(l),this.clearLineAngleInfo(!0),this.faceInfo.fstIntersect&&this.faceInfo.sndIntersect&&this.clearFaceInfo(!0),NDSWebViewer.COMMON.isMobileDevice()&&this.ChangeMeasureFlag(),this.OpMeasure.measureEnd(),NDSWebViewer.SETTING.enableBroadcast&&NDSWebViewer.SETTING.broadcastMajor&&this.OpMeasure.addmeasureTimes()}}}},l.prototype.createMeasureScene=function(){if(null!=this.dimensionObject&&(this.scene.remove(this.dimensionObject),this.dimensionObject=null),"angle"==this.measureType){if(this.firstSprite&&(null==this.dimensionObject&&(this.dimensionObject=new THREE.Object3D),(e=this.createPointMesh(this.firstSprite,this.materialPoint,this.POINTSIZE)).objectType="Point",this.dimensionObject.add(e)),this.secondSprite&&(null==this.dimensionObject&&(this.dimensionObject=new THREE.Object3D),(e=this.createPointMesh(this.secondSprite,this.materialPoint,this.POINTSIZE)).objectType="Point",this.dimensionObject.add(e)),this.lastMeasure&&(null==this.dimensionObject&&(this.dimensionObject=new THREE.Object3D),"angle"==this.measureType)){for(var e=this.createLineMesh2(this.lastMeasure.first,this.lastMeasure.second,this.materialLine,this.LINEWIDTH),e=(e.objectType="Line",this.dimensionObject.add(e),this.createLineMesh2(this.lastMeasure.third,this.lastMeasure.second,this.materialLine,this.LINEWIDTH)),t=(e.objectType="Line",this.dimensionObject.add(e),this.createAngleArcMeshes(this.lastMeasure.first,this.lastMeasure.second,this.lastMeasure.third,this.ARCWIDTH,this.midPoint)),n=0;n<t.length;n++)t[n].objectType="Arc",this.dimensionObject.add(t[n]);e=this.createPointMesh(this.lastMeasure.first,this.materialPoint,this.POINTSIZE),e=(e.objectType="Point",this.dimensionObject.add(e),this.createPointMesh(this.lastMeasure.second,this.materialPoint,this.POINTSIZE)),e=(e.objectType="Point",this.dimensionObject.add(e),this.createPointMesh(this.lastMeasure.third,this.materialPoint,this.POINTSIZE));e.objectType="Point",this.dimensionObject.add(e)}null!=this.dimensionObject&&this.scene.add(this.dimensionObject)}},l.prototype.AngleMeasure=function(e,t){var n;if(""==this.lineAngleInfo.unit&&(this.lineAngleInfo.unit=""),null!=this.snappedPoint)n=this.snappedPoint;else{var i=this.getIntersectsByPriorityOfLine(e,t);if(i&&0<i.length)for(var s=0;s<i.length;){if(null!=(this.viewer.ndsModel?i[s].object:this.FindParentElement(i[s].object))){n=i[s].point.clone();break}s++}}n&&(null==this.lineAngleInfo.firstHelpPointInfo?this.lineAngleInfo.firstHelpPointInfo={type:"point",point:n.clone(),x:e,y:t}:null==this.lineAngleInfo.secHelpPointInfo?(this.lineAngleInfo.secHelpPointInfo={type:"point",point:n.clone(),x:e,y:t},this.lineAngleInfo.firstLineInfo={type:"helpline",start:this.lineAngleInfo.secHelpPointInfo.point.clone(),end:this.lineAngleInfo.firstHelpPointInfo.point.clone()}):null==this.lineAngleInfo.thrHelpPointInfo&&(this.lineAngleInfo.thrHelpPointInfo={type:"point",point:n.clone(),x:e,y:t},this.lineAngleInfo.secondLineInfo={type:"helpline",start:this.lineAngleInfo.secHelpPointInfo.point.clone(),end:this.lineAngleInfo.thrHelpPointInfo.point.clone()}))},l.prototype.changeLineAngle=function(e){var t=this.OpMeasure.rootObject.getObjectByProperty("uuid",this.OpMeasure.unsteadyuuid),n=t.getObjectByName("unsteady");n&&t.remove(n);(n=new THREE.Group).name="unsteady",n.objectType="Group",t.add(n);var i=this.OpMeasure.unsteadyData[this.OpMeasure.unsteadyuuid],t=i.firstLineInfo.start,s=(new THREE.Vector3).subVectors(i.firstLineInfo.end,i.firstLineInfo.start),o=(s.normalize(),s.clone().negate()),r=i.secondLineInfo.start,a=(new THREE.Vector3).subVectors(i.secondLineInfo.end,i.secondLineInfo.start),l=(a.normalize(),a.clone().negate()),t=(i.arcCenter||(i.arcCenter=this.getIntersectPointOfTwoLine(t,s,r,a),i.fstClndPos=new THREE.Vector3,i.sndClndPos=new THREE.Vector3),(new THREE.Vector3).addVectors(i.arcCenter,s)),r=(new THREE.Vector3).addVectors(i.arcCenter,a),d=new THREE.Plane,c=null,h=null,t=(d.setFromCoplanarPoints(i.arcCenter,t,r),d.normal.length()<1e-8&&(d.setFromCoplanarPoints(i.arcCenter.clone().add(new THREE.Vector3(1,-1,1)),t,r),c=new THREE.Vector3,h=new THREE.Vector3),this.clientCoordToModelCoordOnPlane(e.x,e.y,d));if(t){i.textPos=t;var r=(new THREE.Vector3).subVectors(i.textPos,i.arcCenter),e=r.length(),d=(r.normalize(),s),f=a;this.isBetweenTwoVectors(r,s,a)?(d=s,f=a):this.isBetweenTwoVectors(r,s,l)?(d=s,f=l):this.isBetweenTwoVectors(r,o,a)?(d=o,f=a):this.isBetweenTwoVectors(r,o,l)&&(d=o,f=l);var r=(r=d.angleTo(f))/Math.PI*180,I=(i.dimString=r.toFixed(8),i.fstClndPos.addVectors(i.arcCenter,d.clone().multiplyScalar(e)),i.sndClndPos.addVectors(i.arcCenter,f.clone().multiplyScalar(e)),null!=c&&(g=new THREE.Vector3,E=new THREE.Vector3,g.subVectors(i.fstClndPos,i.arcCenter),E.subVectors(t,i.arcCenter),c.crossVectors(g,E),c.normalize(),h.subVectors(t,i.arcCenter),h.normalize().negate()),(h=(new THREE.Vector3).addVectors(s,a)).normalize(),this.createAngleArcMeshesWithAngle(i.arcCenter,d,f,e,r,this.ARCWIDTH,this.appmaterialLine));if(0!=I.length){for(var u=0;u<I.length;u++)n.add(I[u]);for(var p,S,g=I[1].geometry.vertices[0],E=I[I.length-2].geometry.vertices[0],c=this.createCylinderMesh(g,i.fstClndPos,this.appmaterialLine),t=(new THREE.Vector3).subVectors(i.fstClndPos,g),h=(t.normalize(),this.OpMeasure.getScale(c,this.CYLINDERWIDTH)),d=(t.multiplyScalar(.5*c.geometry.parameters.height),c.oldPosition=i.fstClndPos.clone(),c.offsetPos=t.clone().multiplyScalar(-1),c.position.subVectors(i.fstClndPos,t.clone().multiplyScalar(h)),n.add(c),this.createCylinderMesh(E,i.sndClndPos,this.appmaterialLine)),f=(new THREE.Vector3).subVectors(i.sndClndPos,E),h=(f.normalize(),this.OpMeasure.getScale(d,this.CYLINDERWIDTH)),e=(f.multiplyScalar(.5*d.geometry.parameters.height),d.oldPosition=i.sndClndPos.clone(),d.offsetPos=f.clone().multiplyScalar(-1),d.position.subVectors(i.sndClndPos,f.clone().multiplyScalar(h)),n.add(d),i.firstLineInfo.start.distanceTo(i.firstLineInfo.end)),r=i.fstClndPos.distanceTo(i.firstLineInfo.start),g=i.fstClndPos.distanceTo(i.firstLineInfo.end),m=(this.isZero(r+g-e)||(S=g<r?(p=i.firstLineInfo.end,(new THREE.Vector3).addVectors(p,s.clone().multiplyScalar(1.3*g))):(p=i.firstLineInfo.start,(new THREE.Vector3).addVectors(p,o.clone().multiplyScalar(1.3*r))),t=this.createLineMesh2(p,S,this.appmaterialLine,1),n.add(t)),e=i.secondLineInfo.start.distanceTo(i.secondLineInfo.end),r=i.sndClndPos.distanceTo(i.secondLineInfo.start),g=i.sndClndPos.distanceTo(i.secondLineInfo.end),this.isZero(r+g-e)||(S=g<r?(p=i.secondLineInfo.end,(new THREE.Vector3).addVectors(p,a.clone().multiplyScalar(1.3*g))):(p=i.secondLineInfo.start,(new THREE.Vector3).addVectors(p,l.clone().multiplyScalar(1.3*r))),c=this.createLineMesh2(p,S,this.appmaterialLine,1),n.add(c)),i.dimString+i.unit),O=0;O<this.OpMeasure.boxInfos.length;O++){var b=this.OpMeasure.boxInfos[O];if(b.textBox.getAttribute("group")==this.OpMeasure.unsteadyuuid){b.textPos=i.textPos,b.dimString=m,b.textBox.setAttribute("dimString",b.dimString);break}}this.OpMeasure.setMeasureDisplayUnit(),this.OpMeasure.viewer.render()}}},l.prototype.createAndShowFaceAngleDimension=function(e,t){if(this.faceInfo.fstSelFaceObj&&this.faceInfo.sndSelFaceObj&&("faceAngle"===this.measureType||"bodyAngle"===this.measureType)){var n=this.faceInfo.fstIntersect,i=this.faceInfo.sndIntersect;if(this.faceInfo.arcCenter){if(!this.faceInfo.fstClnd||!this.faceInfo.sndClnd)return}else{var s=(new THREE.Vector3).subVectors(i,n),o=this.faceInfo.firstFaceInfo.worldNormal.clone(),r=this.faceInfo.secondFaceInfo.worldNormal.clone(),a=(o.normalize(),r.normalize(),new THREE.Vector3),l=new THREE.Vector3;if(!this.getIntersectLineOfTwoPlane(n,o,i,r,a,l))return;var l=a.clone().add(l.clone().multiplyScalar(10)),a=(this.faceInfo.arcCenter=this.getProjectPntToLine(a,l,i),s.dot(o)),l=(new THREE.Vector3).subVectors(i,o.clone().multiplyScalar(a)),a=(new THREE.Vector3).crossVectors(o,r),r=n.clone().add(a.multiplyScalar(2)),a=(this.faceInfo.midLineEndPt=this.getProjectPntToLine(n,r,l),this.faceInfo.arcCenter.distanceTo(l)),r=i.distanceTo(l),l=Math.min(a,r),a=(this.isZero(l)&&(l=.001),(new THREE.Vector3).subVectors(this.faceInfo.midLineEndPt,this.faceInfo.arcCenter)),r=(new THREE.Vector3).subVectors(i,this.faceInfo.arcCenter),r=(a.normalize(),r.normalize(),this.faceInfo.sndClndPos=(new THREE.Vector3).addVectors(i,r.multiplyScalar(l)),this.faceInfo.arcCenter.distanceTo(this.faceInfo.sndClndPos));this.faceInfo.fstClndPos=(new THREE.Vector3).addVectors(this.faceInfo.arcCenter,a.multiplyScalar(r));l=(l=this.getAngle(this.faceInfo.fstClndPos,this.faceInfo.arcCenter,this.faceInfo.sndClndPos))/Math.PI*180;this.faceInfo.dimString=l.toFixed(8)}this.faceInfo.textPos?(e&&(a=this.getProjectPntToPlane(this.faceInfo.arcCenter,this.faceInfo.fstClndPos,this.faceInfo.sndClndPos,e))&&this.faceInfo.textPos.copy(a),s=(new THREE.Vector3).subVectors(this.faceInfo.midLineEndPt,this.faceInfo.arcCenter),o=(new THREE.Vector3).subVectors(i,this.faceInfo.arcCenter),s.normalize(),o.normalize(),r=this.faceInfo.arcCenter.distanceTo(this.faceInfo.textPos),this.faceInfo.fstClndPos.addVectors(this.faceInfo.arcCenter,s.multiplyScalar(r)),this.faceInfo.sndClndPos.addVectors(this.faceInfo.arcCenter,o.multiplyScalar(r))):this.faceInfo.textPos=this.faceInfo.sndClndPos.clone(),this.faceInfo.fstToMidLine||(this.faceInfo.fstToMidLine=this.createLineMesh2(n,this.faceInfo.midLineEndPt,this.materialLine,1),this.OpMeasure.rootObject.add(this.faceInfo.fstToMidLine)),this.faceInfo.fstToClndLine&&this.OpMeasure.rootObject.remove(this.faceInfo.fstToClndLine),this.faceInfo.fstToClndLine=this.createLineMesh2(this.faceInfo.midLineEndPt,this.faceInfo.fstClndPos,this.materialLine,1),this.OpMeasure.rootObject.add(this.faceInfo.fstToClndLine),this.faceInfo.sndToClndLine&&this.OpMeasure.rootObject.remove(this.faceInfo.sndToClndLine),this.faceInfo.sndToClndLine=this.createLineMesh2(i,this.faceInfo.sndClndPos,this.materialLine,1),this.OpMeasure.rootObject.add(this.faceInfo.sndToClndLine);for(var d=0;d<this.faceInfo.arcMeshes.length;d++)this.OpMeasure.rootObject.remove(this.faceInfo.arcMeshes[d]),this.faceInfo.arcMeshes[d]=null;this.faceInfo.arcMeshes=this.createAngleArcMeshes2(this.faceInfo.fstClndPos,this.faceInfo.arcCenter,this.faceInfo.sndClndPos,this.ARCWIDTH);for(d=0;d<this.faceInfo.arcMeshes.length;d++)this.OpMeasure.rootObject.add(this.faceInfo.arcMeshes[d]);this.faceInfo.fstClnd&&this.OpMeasure.rootObject.remove(this.faceInfo.fstClnd),this.faceInfo.fstClnd=this.createCylinderMesh(this.faceInfo.arcMeshes[1].geometry.vertices[0],this.faceInfo.fstClndPos,this.materialLine);l=(new THREE.Vector3).subVectors(this.faceInfo.fstClndPos,this.faceInfo.arcMeshes[1].geometry.vertices[0]),e=(l.normalize(),this.OpMeasure.getScale(this.faceInfo.fstClnd,this.CYLINDERWIDTH)),a=(l.multiplyScalar(.5*this.faceInfo.fstClnd.geometry.parameters.height),this.faceInfo.fstClnd.oldPosition=this.faceInfo.fstClndPos.clone(),this.faceInfo.fstClnd.offsetPos=l.clone().multiplyScalar(-1),this.faceInfo.fstClnd.position.subVectors(this.faceInfo.fstClndPos,l.clone().multiplyScalar(e)),this.OpMeasure.rootObject.add(this.faceInfo.fstClnd),this.faceInfo.sndClnd&&this.OpMeasure.rootObject.remove(this.faceInfo.sndClnd),this.faceInfo.sndClnd=this.createCylinderMesh(this.faceInfo.arcMeshes[this.faceInfo.arcMeshes.length-2].geometry.vertices[0],this.faceInfo.sndClndPos,this.materialLine),(new THREE.Vector3).subVectors(this.faceInfo.sndClndPos,this.faceInfo.arcMeshes[this.faceInfo.arcMeshes.length-2].geometry.vertices[0])),e=(a.normalize(),this.OpMeasure.getScale(this.faceInfo.sndClnd,this.CYLINDERWIDTH)),s=(a.multiplyScalar(.5*this.faceInfo.sndClnd.geometry.parameters.height),this.faceInfo.sndClnd.oldPosition=this.faceInfo.sndClndPos.clone(),this.faceInfo.sndClnd.offsetPos=a.clone().multiplyScalar(-1),this.faceInfo.sndClnd.position.subVectors(this.faceInfo.sndClndPos,a.clone().multiplyScalar(e)),this.OpMeasure.rootObject.add(this.faceInfo.sndClnd),this.getAngle(this.faceInfo.fstClndPos,this.faceInfo.arcCenter,this.faceInfo.textPos)),o=this.getAngle(this.faceInfo.textPos,this.faceInfo.arcCenter,this.faceInfo.sndClndPos),r=this.getAngle(this.faceInfo.fstClndPos,this.faceInfo.arcCenter,this.faceInfo.sndClndPos),n=Math.abs(s+o-r)<.01,i=this.faceInfo.dimString+this.faceInfo.unit;this.faceInfo.textBox||(this.faceInfo.textBox=document.createElement("div"),this.faceInfo.textBox.className="mearesult",this.viewer.container.appendChild(this.faceInfo.textBox)),this.getAndShowTextBox(this.faceInfo.textPos.clone(),i,this.faceInfo.textBox),this.faceInfo.boxToClndLine&&this.OpMeasure.rootObject.remove(this.faceInfo.boxToClndLine),n||(l=this.faceInfo.sndClndPos,this.faceInfo.textPos.distanceToSquared(this.faceInfo.fstClndPos)<this.faceInfo.textPos.distanceToSquared(this.faceInfo.sndClndPos)&&(l=this.faceInfo.fstClndPos),this.faceInfo.boxToClndLine=this.createLineMesh2(l,this.faceInfo.textPos,this.materialLine,1),this.OpMeasure.rootObject.add(this.faceInfo.boxToClndLine)),t&&((a={}).dimString=i,a.textPos=this.faceInfo.textPos.clone(),a.textBox=this.faceInfo.textBox,this.OpMeasure.boxInfos.push(a),this.clearFaceInfo(!0),this.lineAngleInfo.twoPlane&&this.clearLineAngleInfo(!0),this.ChangeMeasureFlag())}},l.prototype.createAndShow3DFaceAngleDimension=function(e,t){if(this.faceInfo.fstSelFaceObj&&this.faceInfo.sndSelFaceObj&&("faceAngle"===this.measureType||"bodyAngle"===this.measureType)){var n=this.faceInfo.fstIntersect,i=this.faceInfo.sndIntersect;if(this.faceInfo.arcCenter){if(!this.faceInfo.fstClnd||!this.faceInfo.sndClnd)return}else{var s=(new THREE.Vector3).subVectors(i,n),o=this.faceInfo.firstFaceInfo.worldNormal.clone(),r=this.faceInfo.secondFaceInfo.worldNormal.clone(),a=(o.normalize(),r.normalize(),new THREE.Vector3),l=new THREE.Vector3;if(!this.getIntersectLineOfTwoPlane(n,o,i,r,a,l))return;var l=a.clone().add(l.clone().multiplyScalar(10)),a=(this.faceInfo.arcCenter=this.getProjectPntToLine(a,l,i),s.dot(o)),l=(new THREE.Vector3).subVectors(i,o.clone().multiplyScalar(a)),a=(new THREE.Vector3).crossVectors(o,r),r=n.clone().add(a.multiplyScalar(2)),a=(this.faceInfo.midLineEndPt=this.getProjectPntToLine(n,r,l),this.faceInfo.arcCenter.distanceTo(l)),r=i.distanceTo(l),l=Math.min(a,r),a=(this.isZero(l)&&(l=.001),(new THREE.Vector3).subVectors(this.faceInfo.midLineEndPt,this.faceInfo.arcCenter)),r=(new THREE.Vector3).subVectors(i,this.faceInfo.arcCenter),r=(a.normalize(),r.normalize(),this.faceInfo.sndClndPos=(new THREE.Vector3).addVectors(i,r.multiplyScalar(l)),this.faceInfo.arcCenter.distanceTo(this.faceInfo.sndClndPos));this.faceInfo.fstClndPos=(new THREE.Vector3).addVectors(this.faceInfo.arcCenter,a.multiplyScalar(r));l=(l=this.getAngle(this.faceInfo.fstClndPos,this.faceInfo.arcCenter,this.faceInfo.sndClndPos))/Math.PI*180;this.faceInfo.dimString=l.toFixed(8)}this.faceInfo.textPos?(e&&(a=this.getProjectPntToPlane(this.faceInfo.arcCenter,this.faceInfo.fstClndPos,this.faceInfo.sndClndPos,e))&&this.faceInfo.textPos.copy(a),s=(new THREE.Vector3).subVectors(this.faceInfo.midLineEndPt,this.faceInfo.arcCenter),o=(new THREE.Vector3).subVectors(i,this.faceInfo.arcCenter),s.normalize(),o.normalize(),r=this.faceInfo.arcCenter.distanceTo(this.faceInfo.textPos),this.faceInfo.fstClndPos.addVectors(this.faceInfo.arcCenter,s.multiplyScalar(r)),this.faceInfo.sndClndPos.addVectors(this.faceInfo.arcCenter,o.multiplyScalar(r))):this.faceInfo.textPos=this.faceInfo.sndClndPos.clone(),this.faceInfo.fstToMidLine=this.createLineMesh2(n,this.faceInfo.midLineEndPt,this.appmaterialLine,1),this.faceInfo.fstToClndLine=this.createLineMesh2(this.faceInfo.midLineEndPt,this.faceInfo.fstClndPos,this.appmaterialLine,1),this.faceInfo.sndToClndLine=this.createLineMesh2(i,this.faceInfo.sndClndPos,this.appmaterialLine,1),this.faceInfo.arcMeshes=this.createAngleArcMeshes2(this.faceInfo.fstClndPos,this.faceInfo.arcCenter,this.faceInfo.sndClndPos,this.ARCWIDTH,this.appmaterialLine),this.faceInfo.fstClnd=this.createCylinderMesh(this.faceInfo.arcMeshes[1].geometry.vertices[0],this.faceInfo.fstClndPos,this.appmaterialLine);var l=(new THREE.Vector3).subVectors(this.faceInfo.fstClndPos,this.faceInfo.arcMeshes[1].geometry.vertices[0]),e=(l.normalize(),this.OpMeasure.getScale(this.faceInfo.fstClnd,this.CYLINDERWIDTH)),a=(l.multiplyScalar(.5*this.faceInfo.fstClnd.geometry.parameters.height),this.faceInfo.fstClnd.oldPosition=this.faceInfo.fstClndPos.clone(),this.faceInfo.fstClnd.offsetPos=l.clone().multiplyScalar(-1),this.faceInfo.fstClnd.position.subVectors(this.faceInfo.fstClndPos,l.clone().multiplyScalar(e)),this.faceInfo.sndClnd=this.createCylinderMesh(this.faceInfo.arcMeshes[this.faceInfo.arcMeshes.length-2].geometry.vertices[0],this.faceInfo.sndClndPos,this.appmaterialLine),(new THREE.Vector3).subVectors(this.faceInfo.sndClndPos,this.faceInfo.arcMeshes[this.faceInfo.arcMeshes.length-2].geometry.vertices[0])),e=(a.normalize(),this.OpMeasure.getScale(this.faceInfo.sndClnd,this.CYLINDERWIDTH)),s=(a.multiplyScalar(.5*this.faceInfo.sndClnd.geometry.parameters.height),this.faceInfo.sndClnd.oldPosition=this.faceInfo.sndClndPos.clone(),this.faceInfo.sndClnd.offsetPos=a.clone().multiplyScalar(-1),this.faceInfo.sndClnd.position.subVectors(this.faceInfo.sndClndPos,a.clone().multiplyScalar(e)),this.getAngle(this.faceInfo.fstClndPos,this.faceInfo.arcCenter,this.faceInfo.textPos)),o=this.getAngle(this.faceInfo.textPos,this.faceInfo.arcCenter,this.faceInfo.sndClndPos),r=this.getAngle(this.faceInfo.fstClndPos,this.faceInfo.arcCenter,this.faceInfo.sndClndPos),n=Math.abs(s+o-r)<.01,i=this.faceInfo.dimString+this.faceInfo.unit,l=(this.faceInfo.textBox=document.createElement("div"),this.faceInfo.textBox.className="section10",this.faceInfo.textBox.innerHTML=i,document.createElement("div")),a=(l.className="sectionPoint",this.faceInfo.textBox.appendChild(l),document.createElement("div"));if(a.className="sectionCross",this.faceInfo.textBox.appendChild(a),this.viewer.container.appendChild(this.faceInfo.textBox),n||(e=this.faceInfo.sndClndPos,this.faceInfo.textPos.distanceToSquared(this.faceInfo.fstClndPos)<this.faceInfo.textPos.distanceToSquared(this.faceInfo.sndClndPos)&&(e=this.faceInfo.fstClndPos),this.faceInfo.boxToClndLine=this.createLineMesh2(e,this.faceInfo.textPos,this.appmaterialLine,1)),t){var s={},o=(s.dimString=i,s.textPos=this.faceInfo.textPos.clone(),s.textBox=this.faceInfo.textBox,new THREE.Group),d=new THREE.Group;o.objectType="Group",d.objectType="Group",d.name="unsteady",d.add(this.faceInfo.fstToMidLine),d.add(this.faceInfo.fstToClndLine),d.add(this.faceInfo.sndToClndLine);for(var c=0;c<this.faceInfo.arcMeshes.length;c++)d.add(this.faceInfo.arcMeshes[c]);d.add(this.faceInfo.fstClnd),d.add(this.faceInfo.sndClnd),this.faceInfo.boxToClndLine&&d.add(this.faceInfo.boxToClndLine),this.OpMeasure.rootObject.remove(this.faceInfo.fstSelFaceObj),this.OpMeasure.rootObject.remove(this.faceInfo.sndSelFaceObj),o.add(this.faceInfo.fstSelFaceObj),o.add(this.faceInfo.sndSelFaceObj),o.add(d),this.OpMeasure.rootObject.add(o),NDSWebViewer.COMMON.isMobileDevice()?(s.textBox.addEventListener("touchstart",this.touchstart,!1),s.textBox.addEventListener("touchend",this.touchend,!1),s.textBox.addEventListener("touchmove",this.touchmove,!1)):(s.textBox.addEventListener("mousedown",this.touchstart,!1),s.textBox.addEventListener("mouseup",this.touchend,!1),s.textBox.addEventListener("mousemove",this.touchmove,!1),s.textBox.addEventListener("mouseleave",this.mouseleave,!1),s.textBox.addEventListener("mouseenter",this.mouseenter,!1)),NDSWebViewer.COMMON.isMobileDevice()?a.addEventListener("touchend",this.sectionCrossend,!1):(a.addEventListener("mousedown",this.sectionCrossend,!1),a.addEventListener("mouseleave",this.crossleave,!1),a.addEventListener("mouseenter",this.crossenter,!1)),s.textBox.setAttribute("mobile","up"),s.textBox.setAttribute("group",o.uuid),this.OpMeasure.currentUuid=o.uuid,this.OpMeasure.unsteadyData[o.uuid]=this.DeepCopy(this.faceInfo,"Angle"),this.OpMeasure.boxInfos.push(s),this.clearFaceInfo(!0),this.lineAngleInfo.twoPlane&&this.clearLineAngleInfo(!0),NDSWebViewer.COMMON.isMobileDevice()&&this.ChangeMeasureFlag()}}},l.prototype.changeFaceAngle=function(e){var t=this.OpMeasure.rootObject.getObjectByProperty("uuid",this.OpMeasure.unsteadyuuid),n=t.getObjectByName("unsteady");n&&t.remove(n);(n=new THREE.Group).name="unsteady",n.objectType="Group",t.add(n);var i=this.OpMeasure.unsteadyData[this.OpMeasure.unsteadyuuid],t=i.fstIntersect,s=i.sndIntersect;if(i.arcCenter){if(!i.fstClnd||!i.sndClnd)return}else{var o=(new THREE.Vector3).subVectors(s,t),r=i.firstFaceInfo.worldNormal.clone(),a=i.secondFaceInfo.worldNormal.clone(),l=(r.normalize(),a.normalize(),new THREE.Vector3),d=new THREE.Vector3;if(!this.getIntersectLineOfTwoPlane(t,r,s,a,l,d))return;var d=l.clone().add(d.clone().multiplyScalar(10)),l=(i.arcCenter=this.getProjectPntToLine(l,d,s),o.dot(r)),d=(new THREE.Vector3).subVectors(s,r.clone().multiplyScalar(l)),l=(new THREE.Vector3).crossVectors(r,a),a=t.clone().add(l.multiplyScalar(2)),l=(i.midLineEndPt=this.getProjectPntToLine(t,a,d),i.arcCenter.distanceTo(d)),a=s.distanceTo(d),d=Math.min(l,a),l=(this.isZero(d)&&(d=.001),(new THREE.Vector3).subVectors(i.midLineEndPt,i.arcCenter)),a=(new THREE.Vector3).subVectors(s,i.arcCenter),a=(l.normalize(),a.normalize(),i.sndClndPos=(new THREE.Vector3).addVectors(s,a.multiplyScalar(d)),i.arcCenter.distanceTo(i.sndClndPos));i.fstClndPos=(new THREE.Vector3).addVectors(i.arcCenter,l.multiplyScalar(a));d=(d=this.getAngle(i.fstClndPos,i.arcCenter,i.sndClndPos))/Math.PI*180;i.dimString=d.toFixed(8)}i.textPos?(e&&(l=this.getProjectPntToPlane(i.arcCenter,i.fstClndPos,i.sndClndPos,e))&&i.textPos.copy(l),o=(new THREE.Vector3).subVectors(i.midLineEndPt,i.arcCenter),r=(new THREE.Vector3).subVectors(s,i.arcCenter),o.normalize(),r.normalize(),a=i.arcCenter.distanceTo(i.textPos),i.fstClndPos.addVectors(i.arcCenter,o.multiplyScalar(a)),i.sndClndPos.addVectors(i.arcCenter,r.multiplyScalar(a))):i.textPos=i.sndClndPos.clone(),i.fstToMidLine||(i.fstToMidLine=this.createLineMesh2(t,i.midLineEndPt,this.appmaterialLine,1)),i.fstToClndLine=this.createLineMesh2(i.midLineEndPt,i.fstClndPos,this.appmaterialLine,1),i.sndToClndLine=this.createLineMesh2(s,i.sndClndPos,this.appmaterialLine,1),i.arcMeshes=this.createAngleArcMeshes2(i.fstClndPos,i.arcCenter,i.sndClndPos,this.ARCWIDTH,this.appmaterialLine),i.fstClnd=this.createCylinderMesh(i.arcMeshes[1].geometry.vertices[0],i.fstClndPos,this.appmaterialLine);d=(new THREE.Vector3).subVectors(i.fstClndPos,i.arcMeshes[1].geometry.vertices[0]),d.normalize(),e=this.OpMeasure.getScale(i.fstClnd,this.CYLINDERWIDTH),d.multiplyScalar(.5*i.fstClnd.geometry.parameters.height),i.fstClnd.oldPosition=i.fstClndPos.clone(),i.fstClnd.offsetPos=d.clone().multiplyScalar(-1),i.fstClnd.position.subVectors(i.fstClndPos,d.clone().multiplyScalar(e)),i.sndClnd=this.createCylinderMesh(i.arcMeshes[i.arcMeshes.length-2].geometry.vertices[0],i.sndClndPos,this.appmaterialLine),l=(new THREE.Vector3).subVectors(i.sndClndPos,i.arcMeshes[i.arcMeshes.length-2].geometry.vertices[0]),l.normalize(),e=this.OpMeasure.getScale(i.sndClnd,this.CYLINDERWIDTH),l.multiplyScalar(.5*i.sndClnd.geometry.parameters.height),i.sndClnd.oldPosition=i.sndClndPos.clone(),i.sndClnd.offsetPos=l.clone().multiplyScalar(-1),i.sndClnd.position.subVectors(i.sndClndPos,l.clone().multiplyScalar(e)),o=this.getAngle(i.fstClndPos,i.arcCenter,i.textPos),r=this.getAngle(i.textPos,i.arcCenter,i.sndClndPos),a=this.getAngle(i.fstClndPos,i.arcCenter,i.sndClndPos);Math.abs(o+r-a)<.01||(t=i.sndClndPos,i.textPos.distanceToSquared(i.fstClndPos)<i.textPos.distanceToSquared(i.sndClndPos)&&(t=i.fstClndPos),i.boxToClndLine=this.createLineMesh2(t,i.textPos,this.appmaterialLine,1)),n.add(i.fstToMidLine),n.add(i.fstToClndLine),n.add(i.sndToClndLine);for(var c=0;c<i.arcMeshes.length;c++)n.add(i.arcMeshes[c]);n.add(i.fstClnd),n.add(i.sndClnd),i.boxToClndLine&&n.add(i.boxToClndLine);for(var h=0;h<this.OpMeasure.boxInfos.length;h++){var f=this.OpMeasure.boxInfos[h];if(f.textBox.getAttribute("group")==this.OpMeasure.unsteadyuuid){f.textPos=i.textPos;break}}this.OpMeasure.viewer.render()},l.prototype.getIntersectLineOfTwoPlane=function(e,t,n,i,s,o){if(!s||!o)return!1;t.normalize(),i.normalize();var r=Math.abs(t.dot(i));if(Math.abs(r-1)<1e-6)return!1;o.crossVectors(t,i);r=t.clone().cross(o),t=(new THREE.Vector3).subVectors(n,e).dot(i),o=r.dot(i),n=t/(o=this.isZero(o)?1e-6:o);return s.addVectors(e,r.clone().multiplyScalar(n)),!0},l.prototype.getIntersectPointOfTwoLine=function(e,t,n,i){var s;return e.distanceToSquared(n)<1e-8?n.clone():(s=(new THREE.Vector3).crossVectors(t,i),(new THREE.Vector3).crossVectors(s,t),s=(new THREE.Vector3).crossVectors(s,i),i=(new THREE.Vector3).subVectors(n,e).dot(s)/s.dot(t),(n=new THREE.Vector3).addVectors(e,t.clone().multiplyScalar(i)),n)},l.prototype.measureLineAngle=function(e,t,n,i){if(""==this.lineAngleInfo.unit&&(this.lineAngleInfo.unit=""),this.lineAngleInfo.firstLineObj&&this.lineAngleInfo.secondLineObj)this.lineAngleInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.lineAngleInfo.preSelLineObj),this.lineAngleInfo.preSelLineObj=null,this.lineAngleInfo.preSelLineInfo=null);else{var s=this.viewer,e=this.doRaycasterPick(e,t,!0);if(e&&0!=e.length){t=null;if(t=s.ndsModel||e[0].object instanceof THREE.Line||e[0].object instanceof THREE.LineSegments?e[0]:t){s=this.getSelectInfoFromIntersect(t);if(s)if("line"!=s.type||this.Bline(s))if(1==n)this.isTwoTopolInfoTheSame(this.lineAngleInfo.preSelLineInfo,s)||-1!=i.indexOf(s.type)&&(this.lineAngleInfo.preSelLineInfo=s,this.lineAngleInfo.preSelLineObj)&&(this.OpMeasure.rootObject.remove(this.lineAngleInfo.preSelLineObj),this.lineAngleInfo.preSelLineObj=null);else if(this.lineAngleInfo.preSelLineInfo=null,this.lineAngleInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.lineAngleInfo.preSelLineObj),this.lineAngleInfo.preSelLineObj=null),this.lineAngleInfo.firstLineInfo)if(this.isTwoTopolInfoTheSame(this.lineAngleInfo.firstLineInfo,s))this.lineAngleInfo.firstLineObj&&(this.OpMeasure.rootObject.remove(this.lineAngleInfo.firstLineObj),this.lineAngleInfo.firstLineObj=null,this.lineAngleInfo.firstLineInfo=null);else if(-1!=i.indexOf(s.type)||-1==i.indexOf("plane")||"cylinder"!==s.type&&"other"!==s.type){if(-1!=i.indexOf(s.type)){this.OpMeasure.InfoType>NDSWebViewer.NDS.INFOTYPE.MEASURENOTICEBEGIN&&(this.OpMeasure.InfoType=NDSWebViewer.NDS.INFOTYPE.MEASURENOTICEBEGIN);var o,r,e=new THREE.Plane;if(this.lineAngleInfo.firstLineInfo.type==s.type)a=this.getLineStartEndPoints(this.lineAngleInfo.firstLineInfo),o=this.getLineStartEndPoints(s);else{"line"==this.lineAngleInfo.firstLineInfo.type?(a=this.getLineStartEndPoints(this.lineAngleInfo.firstLineInfo),(e=new THREE.Plane).setFromNormalAndCoplanarPoint(s.worldNormal,s.worldOrigin),r=s.intersect):"plane"==this.lineAngleInfo.firstLineInfo.type&&(a=this.getLineStartEndPoints(s),e.setFromNormalAndCoplanarPoint(this.lineAngleInfo.firstLineInfo.worldNormal,this.lineAngleInfo.firstLineInfo.worldOrigin),r=this.lineAngleInfo.firstLineInfo.intersect);var a,t=this.intersectLine(a.start,a.end,e);if(!t)return void("line"==s.type?this.OpMeasure.PostInfo("bodyAngle"==this.measureType?NDSWebViewer.NDS.INFOTYPE.TWOBODYPARALLEL:NDSWebViewer.NDS.INFOTYPE.LINEPARALLELPLANE):"plane"==s.type&&this.OpMeasure.PostInfo("bodyAngle"==this.measureType?NDSWebViewer.NDS.INFOTYPE.TWOBODYPARALLEL:NDSWebViewer.NDS.INFOTYPE.PLANEPARALLELLINE));var n=new THREE.Vector3,l=(e.projectPoint(a.start,n),new THREE.Vector3);e.projectPoint(a.end,l),o=n.distanceTo(l)<1e-5?{start:t,end:r}:n.distanceTo(t)<1e-4?{start:t,end:l}:{start:t,end:n}}a&&o&&((e=(new THREE.Vector3).subVectors(a.end,a.start)).normalize(),(r=(new THREE.Vector3).subVectors(o.end,o.start)).normalize(),l=e.dot(r),1-Math.abs(l)<1e-6?(this.lineAngleInfo.preSelLineInfo=null,this.lineAngleInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.lineAngleInfo.preSelLineObj),this.lineAngleInfo.preSelLineObj=null),this.OpMeasure.PostInfo("bodyAngle"==this.measureType?NDSWebViewer.NDS.INFOTYPE.TWOBODYPARALLEL:NDSWebViewer.NDS.INFOTYPE.LINEPARALLEL)):(this.lineAngleInfo.secondLineInfo=s,this.lineAngleInfo.firstLineInfo.start=a.start.clone(),this.lineAngleInfo.firstLineInfo.end=a.end.clone(),this.lineAngleInfo.secondLineInfo.start=o.start.clone(),this.lineAngleInfo.secondLineInfo.end=o.end.clone(),this.lineAngleInfo.preSelLineInfo=null,this.lineAngleInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.lineAngleInfo.preSelLineObj),this.lineAngleInfo.preSelLineObj=null)))}}else this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.NOTFACE);else-1!=i.indexOf(s.type)||-1==i.indexOf("plane")||"cylinder"!==s.type&&"other"!==s.type?-1!=i.indexOf(s.type)&&(this.lineAngleInfo.firstLineInfo=s,this.OpMeasure.InfoType>NDSWebViewer.NDS.INFOTYPE.MEASURENOTICEBEGIN)&&(this.OpMeasure.InfoType=NDSWebViewer.NDS.INFOTYPE.MEASURENOTICEBEGIN):this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.NOTFACE);else this.lineAngleInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.lineAngleInfo.preSelLineObj),this.lineAngleInfo.preSelLineObj=null,this.lineAngleInfo.preSelLineInfo=null)}}else this.lineAngleInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.lineAngleInfo.preSelLineObj),this.lineAngleInfo.preSelLineObj=null,this.lineAngleInfo.preSelLineInfo=null)}},l.prototype.updateLineAngleScene=function(e){var t;"LineAngle"!==this.measureType&&"LineFaceAngle"!==this.measureType&&"angle"!==this.measureType||(this.lineAngleInfo.firstLineObj&&this.lineAngleInfo.secondLineObj?this.lineAngleInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.lineAngleInfo.preSelLineObj),this.lineAngleInfo.preSelLineObj=null,this.lineAngleInfo.preSelLineInfo=null):!(!e||"true"!==e.toLowerCase())?this.lineAngleInfo.preSelLineInfo&&!this.lineAngleInfo.preSelLineObj&&("line"==this.lineAngleInfo.preSelLineInfo.type&&(t=this.createLine(this.lineAngleInfo.preSelLineInfo,!0)),t="plane"==this.lineAngleInfo.preSelLineInfo.type?this.createFace(this.lineAngleInfo.preSelLineInfo,!0):t)&&(this.OpMeasure.rootObject.add(t),this.lineAngleInfo.preSelLineObj=t):(this.lineAngleInfo.firstLineInfo&&!this.lineAngleInfo.firstLineObj&&("line"==this.lineAngleInfo.firstLineInfo.type&&(t=this.createLine(this.lineAngleInfo.firstLineInfo,!1)),"plane"==this.lineAngleInfo.firstLineInfo.type&&(t=this.createFace(this.lineAngleInfo.firstLineInfo,!1)),t="helpline"==this.lineAngleInfo.firstLineInfo.type?this.createLineMesh2(this.lineAngleInfo.firstLineInfo.start,this.lineAngleInfo.firstLineInfo.end,this.materialLine,1):t)&&(this.OpMeasure.rootObject.add(t),this.lineAngleInfo.firstLineObj=t),this.lineAngleInfo.secondLineInfo&&!this.lineAngleInfo.secondLineObj&&("line"==this.lineAngleInfo.secondLineInfo.type&&(t=this.createLine(this.lineAngleInfo.secondLineInfo,!1)),"plane"==this.lineAngleInfo.secondLineInfo.type&&(t=this.createFace(this.lineAngleInfo.secondLineInfo,!1)),t="helpline"==this.lineAngleInfo.secondLineInfo.type?this.createLineMesh2(this.lineAngleInfo.secondLineInfo.start,this.lineAngleInfo.secondLineInfo.end,this.materialLine,1):t)&&(this.OpMeasure.rootObject.add(t),this.lineAngleInfo.secondLineObj=t),this.lineAngleInfo.firstHelpPointInfo&&!this.lineAngleInfo.firstHelpPointobj&&(t=this.createPointMesh(this.lineAngleInfo.firstHelpPointInfo.point,this.materialPoint,this.POINTSIZE))&&(this.OpMeasure.rootObject.add(t),this.lineAngleInfo.firstHelpPointobj=t),this.lineAngleInfo.secHelpPointInfo&&!this.lineAngleInfo.secHelpPointobj&&(t=this.createPointMesh(this.lineAngleInfo.secHelpPointInfo.point,this.materialPoint,this.POINTSIZE))&&(this.OpMeasure.rootObject.add(t),this.lineAngleInfo.secHelpPointobj=t),this.lineAngleInfo.thrHelpPointInfo&&!this.lineAngleInfo.thrHelpPointobj&&(this.lineAngleInfo.secHelpPointobj&&(this.OpMeasure.rootObject.remove(this.lineAngleInfo.secHelpPointobj),this.lineAngleInfo.secHelpPointInfo=null),this.lineAngleInfo.firstHelpPointobj)&&(this.OpMeasure.rootObject.remove(this.lineAngleInfo.firstHelpPointobj),this.lineAngleInfo.firstHelpPointInfo=null)))},l.prototype.measurefaceAngle=function(e,t,n){if(""==this.lineAngleInfo.unit&&(this.lineAngleInfo.unit=""),this.faceInfo.fstSelFaceObj&&this.faceInfo.sndSelFaceObj)this.faceInfo.preSelFaceObj&&(this.OpMeasure.rootObject.remove(this.faceInfo.preSelFaceObj),this.faceInfo.preSelFaceObj=null,this.faceInfo.preSelFaceInfo=null);else{this.viewer;var i=this.doRaycasterPick(e,t,!1);if(i){for(var s=0;s<i.length;){var o=this.getSelectInfoFromIntersect(i[s]);if(o){if("plane"!=o.type){n||(null!=this.faceInfo.firstFaceInfo?this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.NOTFACESECOND):this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.NOTFACE));break}if(1==n)this.isTwoTopolInfoTheSame(this.faceInfo.preSelFaceInfo,o)||(this.faceInfo.preSelFaceInfo=o,this.faceInfo.preSelFaceObj&&(this.OpMeasure.rootObject.remove(this.faceInfo.preSelFaceObj),this.faceInfo.preSelFaceObj=null));else if(this.OpMeasure.InfoType>NDSWebViewer.NDS.INFOTYPE.MEASURENOTICEBEGIN&&(this.OpMeasure.InfoType=NDSWebViewer.NDS.INFOTYPE.MEASURENOTICEBEGIN),this.faceInfo.firstFaceInfo)if(this.isTwoTopolInfoTheSame(this.faceInfo.firstFaceInfo,o))this.faceInfo.fstSelFaceObj&&(this.OpMeasure.rootObject.remove(this.faceInfo.fstSelFaceObj),this.faceInfo.fstSelFaceObj=null,this.faceInfo.firstFaceInfo=null);else{var r=this.faceInfo.firstFaceInfo.worldNormal.clone(),a=o.worldNormal.clone(),l=(r.normalize(),a.normalize(),r.dot(a)),r=null,a=null;if(Math.abs(Math.abs(l)-1)<1e-5)return this.OpMeasure.PostInfo("bodyAngle"==this.measureType?NDSWebViewer.NDS.INFOTYPE.TWOBODYPARALLEL:NDSWebViewer.NDS.INFOTYPE.PLANEPARALLEL),this.faceInfo.preSelFaceInfo=null,void(this.faceInfo.preSelFaceObj&&(this.OpMeasure.rootObject.remove(this.faceInfo.preSelFaceObj),this.faceInfo.preSelFaceObj=null));this.faceInfo.secondFaceInfo=o,this.faceInfo.sndIntersect=o.intersect,this.faceInfo.preSelFaceInfo=null,this.faceInfo.preSelFaceObj&&(this.OpMeasure.rootObject.remove(this.faceInfo.preSelFaceObj),this.faceInfo.preSelFaceObj=null)}else this.faceInfo.firstFaceInfo=o,this.faceInfo.fstIntersect=o.intersect,this.faceInfo.preSelFaceInfo=null,this.faceInfo.preSelFaceObj&&(this.OpMeasure.rootObject.remove(this.faceInfo.preSelFaceObj),this.faceInfo.preSelFaceObj=null);return}s++}1==n&&this.faceInfo.preSelFaceInfo&&(this.faceInfo.preSelFaceInfo=null,this.faceInfo.preSelFaceObj)&&(this.OpMeasure.rootObject.remove(this.faceInfo.preSelFaceObj),this.faceInfo.preSelFaceObj=null)}else this.faceInfo.preSelFaceObj&&(this.OpMeasure.rootObject.remove(this.faceInfo.preSelFaceObj),this.faceInfo.preSelFaceObj=null,this.faceInfo.preSelFaceInfo=null),this.viewer.outlinePass&&this.viewer.outlinePass.enabled&&(this.viewer.outlinePass.tempSelectedObjects.length=0)}},l.prototype.updateFaceAngleScene=function(e){var t,n,i,s,o;"faceAngle"===this.measureType&&(this.faceInfo.fstSelFaceObj&&this.faceInfo.sndSelFaceObj?this.faceInfo.preSelFaceObj&&(this.OpMeasure.rootObject.remove(this.faceInfo.preSelFaceObj),this.faceInfo.preSelFaceObj=null,this.faceInfo.preSelFaceInfo=null):(!(!e||"true"!==e.toLowerCase())?this.faceInfo.preSelFaceInfo&&!this.faceInfo.preSelFaceObj&&(t=this.createFace(this.faceInfo.preSelFaceInfo,!0))&&((e=[]).push(t),this.viewer.outlinePass&&this.viewer.outlinePass.enabled&&(this.viewer.outlinePass.tempSelectedObjects=e),this.OpMeasure.rootObject.add(t),this.faceInfo.preSelFaceObj=t):(this.faceInfo.firstFaceInfo&&!this.faceInfo.fstSelFaceObj&&(t=this.createFace(this.faceInfo.firstFaceInfo,!1))&&(this.OpMeasure.rootObject.add(t),this.faceInfo.fstSelFaceObj=t),this.faceInfo.secondFaceInfo&&!this.faceInfo.sndSelFaceObj&&(t=this.createFace(this.faceInfo.secondFaceInfo,!1))&&(this.OpMeasure.rootObject.add(t),this.faceInfo.sndSelFaceObj=t)),this.faceInfo.fstIntersect&&this.faceInfo.sndIntersect&&(e=this.faceInfo.fstIntersect,t=this.faceInfo.sndIntersect,this.lineAngleInfo.firstLineInfo=this.faceInfo.firstFaceInfo,this.lineAngleInfo.secondLineInfo=this.faceInfo.secondFaceInfo,n=this.faceInfo.firstFaceInfo.worldNormal.clone(),i=this.faceInfo.secondFaceInfo.worldNormal.clone(),n.normalize(),i.normalize(),s=new THREE.Vector3,o=new THREE.Vector3,this.getIntersectLineOfTwoPlane(e,n,t,i,s,o),this.lineAngleInfo.firstLineInfo.start=e.clone(),this.lineAngleInfo.firstLineInfo.end=s.clone(),this.getIntersectLineOfTwoPlane(t,i,e,n,s,o),this.lineAngleInfo.secondLineInfo.start=t.clone(),this.lineAngleInfo.secondLineInfo.end=s.clone())))},l.prototype.measureBodyAngle=function(e,t,n,i){if(""==this.lineAngleInfo.unit&&(this.lineAngleInfo.unit=""),""==this.faceInfo.unit&&(this.faceInfo.unit=""),this.lineAngleInfo.firstLineObj&&this.lineAngleInfo.secondLineObj)this.lineAngleInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.lineAngleInfo.preSelLineObj),this.lineAngleInfo.preSelLineObj=null,this.lineAngleInfo.preSelLineInfo=null);else{var s=this.viewer,e=this.doRaycasterPick(e,t,!0);if(e&&0!=e.length){t=null;if(t=s.ndsModel||e[0].object instanceof THREE.Line||e[0].object instanceof THREE.LineSegments?e[0]:t){s=this.getSelectInfoFromIntersect(t);if(s)if("bodyAngle"==this.measureType&&-1==i.indexOf(s.type))this.lineAngleInfo.preSelLineInfo=null,this.lineAngleInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.lineAngleInfo.preSelLineObj),this.lineAngleInfo.preSelLineObj=null);else if("line"!=s.type||this.Bline(s))if(1==n)this.isTwoTopolInfoTheSame(this.lineAngleInfo.preSelLineInfo,s)||-1!=i.indexOf(s.type)&&(this.lineAngleInfo.preSelLineInfo=s,this.lineAngleInfo.preSelLineObj)&&(this.OpMeasure.rootObject.remove(this.lineAngleInfo.preSelLineObj),this.lineAngleInfo.preSelLineObj=null);else if(this.lineAngleInfo.preSelLineInfo=null,this.lineAngleInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.lineAngleInfo.preSelLineObj),this.lineAngleInfo.preSelLineObj=null),this.lineAngleInfo.firstLineInfo){if(this.isTwoTopolInfoTheSame(this.lineAngleInfo.firstLineInfo,s))this.lineAngleInfo.firstLineObj&&(this.OpMeasure.rootObject.remove(this.lineAngleInfo.firstLineObj),this.lineAngleInfo.firstLineObj=null,this.lineAngleInfo.firstLineInfo=null);else if(-1==i.indexOf(s.type)&&-1!=i.indexOf("plane")&&"other"===s.type)this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.NOTFACE);else if(-1!=i.indexOf(s.type)){this.OpMeasure.InfoType>NDSWebViewer.NDS.INFOTYPE.MEASURENOTICEBEGIN&&(this.OpMeasure.InfoType=NDSWebViewer.NDS.INFOTYPE.MEASURENOTICEBEGIN);var o,e=new THREE.Plane;if("line"!=this.lineAngleInfo.firstLineInfo.type&&"cylinder"!=this.lineAngleInfo.firstLineInfo.type&&"cone"!=this.lineAngleInfo.firstLineInfo.type||"line"!=s.type&&"cylinder"!=s.type&&"cone"!=s.type){if("plane"==this.lineAngleInfo.firstLineInfo.type&&"plane"==s.type)return this.lineAngleInfo.twoPlane=!0,t=this.lineAngleInfo.firstLineInfo.worldNormal.clone(),n=s.worldNormal.clone(),t.normalize(),n.normalize(),t=t.dot(n),Math.abs(Math.abs(t)-1)<1e-5?(this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.TWOBODYPARALLEL),void(this.lineAngleInfo.twoPlane=!1)):(this.faceInfo.firstFaceInfo=this.lineAngleInfo.firstLineInfo,this.faceInfo.fstIntersect=this.lineAngleInfo.firstLineInfo.intersect,this.faceInfo.secondFaceInfo=s,this.faceInfo.sndIntersect=s.intersect,void(this.lineAngleInfo.secondLineInfo=s));"line"!=this.lineAngleInfo.firstLineInfo.type&&"cylinder"!=this.lineAngleInfo.firstLineInfo.type&&"cone"!=this.lineAngleInfo.firstLineInfo.type||"plane"!=s.type?"plane"!=this.lineAngleInfo.firstLineInfo.type||"line"!=s.type&&"cylinder"!=s.type&&"cone"!=s.type||(r=this.getLineStartEndPoints(s),e.setFromNormalAndCoplanarPoint(this.lineAngleInfo.firstLineInfo.worldNormal,this.lineAngleInfo.firstLineInfo.worldOrigin),o=this.lineAngleInfo.firstLineInfo.intersect):(r=this.getLineStartEndPoints(this.lineAngleInfo.firstLineInfo),(e=new THREE.Plane).setFromNormalAndCoplanarPoint(s.worldNormal,s.worldOrigin),o=s.intersect);var r,n=this.intersectLine(r.start,r.end,e);if(!n)return void("line"==s.type||"cylinder"==s.type||"cone"==s.type?this.OpMeasure.PostInfo("bodyAngle"==this.measureType?NDSWebViewer.NDS.INFOTYPE.TWOBODYPARALLEL:NDSWebViewer.NDS.INFOTYPE.LINEPARALLELPLANE):"plane"==s.type&&this.OpMeasure.PostInfo("bodyAngle"==this.measureType?NDSWebViewer.NDS.INFOTYPE.TWOBODYPARALLEL:NDSWebViewer.NDS.INFOTYPE.PLANEPARALLELLINE));var t=new THREE.Vector3,a=(e.projectPoint(r.start,t),new THREE.Vector3);e.projectPoint(r.end,a),o=t.distanceTo(a)<1e-5?{start:n,end:o}:t.distanceTo(n)<1e-4?{start:n,end:a}:{start:n,end:t}}else r=this.getLineStartEndPoints(this.lineAngleInfo.firstLineInfo),o=this.getLineStartEndPoints(s);r&&o&&((e=(new THREE.Vector3).subVectors(r.end,r.start)).normalize(),(a=(new THREE.Vector3).subVectors(o.end,o.start)).normalize(),n=e.dot(a),1-Math.abs(n)<1e-6?(this.lineAngleInfo.preSelLineInfo=null,this.lineAngleInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.lineAngleInfo.preSelLineObj),this.lineAngleInfo.preSelLineObj=null),"line"==this.lineAngleInfo.firstLineInfo.type&&"line"==s.type||"line"==this.lineAngleInfo.firstLineInfo.type&&"line"==s.type||"cylinder"!=this.lineAngleInfo.firstLineInfo.type&&"cone"!=this.lineAngleInfo.firstLineInfo.type||"cylinder"!=s.type&&"cone"!=s.type?this.OpMeasure.PostInfo("bodyAngle"==this.measureType?NDSWebViewer.NDS.INFOTYPE.TWOBODYPARALLEL:NDSWebViewer.NDS.INFOTYPE.LINEPARALLEL):this.OpMeasure.PostInfo("bodyAngle"==this.measureType?NDSWebViewer.NDS.INFOTYPE.TWOBODYPARALLEL:NDSWebViewer.NDS.INFOTYPE.AXISNOPARALLEL)):(this.lineAngleInfo.secondLineInfo=s,this.lineAngleInfo.firstLineInfo.start=r.start.clone(),this.lineAngleInfo.firstLineInfo.end=r.end.clone(),this.lineAngleInfo.secondLineInfo.start=o.start.clone(),this.lineAngleInfo.secondLineInfo.end=o.end.clone(),this.lineAngleInfo.preSelLineInfo=null,this.lineAngleInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.lineAngleInfo.preSelLineObj),this.lineAngleInfo.preSelLineObj=null)))}}else-1==i.indexOf(s.type)&&-1!=i.indexOf("plane")&&"other"===s.type?this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.NOTFACE):-1!=i.indexOf(s.type)&&(this.lineAngleInfo.firstLineInfo=s,this.OpMeasure.InfoType>NDSWebViewer.NDS.INFOTYPE.MEASURENOTICEBEGIN)&&(this.OpMeasure.InfoType=NDSWebViewer.NDS.INFOTYPE.MEASURENOTICEBEGIN);else this.lineAngleInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.lineAngleInfo.preSelLineObj),this.lineAngleInfo.preSelLineObj=null,this.lineAngleInfo.preSelLineInfo=null)}}else this.lineAngleInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.lineAngleInfo.preSelLineObj),this.lineAngleInfo.preSelLineObj=null,this.lineAngleInfo.preSelLineInfo=null)}},l.prototype.updateBodyAngleScene=function(e){var t,n,i,s,o;"bodyAngle"===this.measureType&&(this.lineAngleInfo.firstLineObj&&this.lineAngleInfo.secondLineObj?this.lineAngleInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.lineAngleInfo.preSelLineObj),this.lineAngleInfo.preSelLineObj=null,this.lineAngleInfo.preSelLineInfo=null):(!(!e||"true"!==e.toLowerCase())?this.lineAngleInfo.preSelLineInfo&&!this.lineAngleInfo.preSelLineObj&&("line"==this.lineAngleInfo.preSelLineInfo.type&&(t=this.createLine(this.lineAngleInfo.preSelLineInfo,!0)),"plane"==this.lineAngleInfo.preSelLineInfo.type&&(t=this.createFace(this.lineAngleInfo.preSelLineInfo,!0)),"cylinder"==this.lineAngleInfo.preSelLineInfo.type&&(t=this.createFace(this.lineAngleInfo.preSelLineInfo,!0)),t="cone"==this.lineAngleInfo.preSelLineInfo.type?this.createFace(this.lineAngleInfo.preSelLineInfo,!0):t)&&(this.OpMeasure.rootObject.add(t),this.lineAngleInfo.preSelLineObj=t):(this.lineAngleInfo.firstLineInfo&&!this.lineAngleInfo.firstLineObj&&("line"==this.lineAngleInfo.firstLineInfo.type&&(t=this.createLine(this.lineAngleInfo.firstLineInfo,!1)),"plane"==this.lineAngleInfo.firstLineInfo.type&&(t=this.createFace(this.lineAngleInfo.firstLineInfo,!1)),"cylinder"==this.lineAngleInfo.firstLineInfo.type&&(t=this.createFace(this.lineAngleInfo.firstLineInfo,!0)),t="cone"==this.lineAngleInfo.firstLineInfo.type?this.createFace(this.lineAngleInfo.firstLineInfo,!0):t)&&(this.OpMeasure.rootObject.add(t),this.lineAngleInfo.firstLineObj=t),this.lineAngleInfo.secondLineInfo&&!this.lineAngleInfo.secondLineObj&&("line"==this.lineAngleInfo.secondLineInfo.type&&(t=this.createLine(this.lineAngleInfo.secondLineInfo,!1)),"plane"==this.lineAngleInfo.secondLineInfo.type&&(t=this.createFace(this.lineAngleInfo.secondLineInfo,!1),this.faceInfo.fstSelFaceObj=this.lineAngleInfo.firstLineObj,this.faceInfo.sndSelFaceObj=t),"cylinder"==this.lineAngleInfo.secondLineInfo.type&&(t=this.createFace(this.lineAngleInfo.secondLineInfo,!0)),t="cone"==this.lineAngleInfo.secondLineInfo.type?this.createFace(this.lineAngleInfo.secondLineInfo,!0):t)&&(this.OpMeasure.rootObject.add(t),this.lineAngleInfo.secondLineObj=t)),this.faceInfo.fstIntersect&&this.faceInfo.sndIntersect&&(e=this.faceInfo.fstIntersect,t=this.faceInfo.sndIntersect,this.lineAngleInfo.firstLineInfo=this.faceInfo.firstFaceInfo,this.lineAngleInfo.secondLineInfo=this.faceInfo.secondFaceInfo,n=this.faceInfo.firstFaceInfo.worldNormal.clone(),i=this.faceInfo.secondFaceInfo.worldNormal.clone(),n.normalize(),i.normalize(),s=new THREE.Vector3,o=new THREE.Vector3,this.getIntersectLineOfTwoPlane(e,n,t,i,s,o),this.lineAngleInfo.firstLineInfo.start=e.clone(),this.lineAngleInfo.firstLineInfo.end=s.clone(),this.getIntersectLineOfTwoPlane(t,i,e,n,s,o),this.lineAngleInfo.secondLineInfo.start=t.clone(),this.lineAngleInfo.secondLineInfo.end=s.clone())))},(d.prototype=Object.create(i.prototype)).OperatorStart=function(e){if(this.measureType=e,!this.viewer.GeomEmpty)switch(this.measureType){case"TotalArea":for(var t=0;t<this.viewer.ndsModel.models.length;t++)if(!this.viewer.ndsModel.models[t].sketchFileUrl){this.viewer.ndsModel.setActiveModel(t);break}var n=this.viewer.getObjectProperty(this.viewer.ndsModel.rootBodyNode);this.viewer.dispatchAsyncEvent({type:"BodyTotalAreaEvent",totalArea:n.area,modelUnit:n.unit});break;case"TotalVolume":for(t=0;t<this.viewer.ndsModel.models.length;t++)if(!this.viewer.ndsModel.models[t].sketchFileUrl){this.viewer.ndsModel.setActiveModel(t);break}n=this.viewer.getObjectProperty(this.viewer.ndsModel.rootBodyNode);this.viewer.dispatchAsyncEvent({type:"BodyTotalVolumeEvent",totalVolume:n.volume,modelUnit:n.unit});break;case"BoundingBox":this.measureBoundingBox(!0),NDSWebViewer.SETTING.enableBroadcast&&NDSWebViewer.SETTING.broadcastMajor&&this.viewer.dispatchEvent({type:"broadcastEvent"});break;case"BodyArea":case"BodyVolume":this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.BODY);break;case"bodyBoundingBox":NDSWebViewer.COMMON.isMobileDevice()||this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.BODY)}},d.prototype.onNMouseMove=function(e,t){switch(this.measureType){case"BodyArea":case"BodyVolume":case"bodyBoundingBox":this.measureBodyVolumeAndAreaPre(e,t,this.measureType)}},d.prototype.onLMouseClick=function(e,t,n){switch(this.ClearmeasureBodyVolumeAndAreaPre(),this.measureType){case"BodyArea":this.measureBodyVolumeAndArea(e,t,"FaceMeasure",n);break;case"BodyVolume":this.measureBodyVolumeAndArea(e,t,"VolumeMeasure",n);break;case"bodyBoundingBox":this.measureBodyBoundingBox(e,t)}},d.prototype.measureBodyVolumeAndAreaPre=function(e,t,n){var i=this.getIntersectsByPriorityOfLine(e,t),e=!1;if(this.preSelectBodyMat&&this.preSelectBody?(this.preSelectBody.setUserMaterial(this.preSelectBodyMat),e=!0,this.preSelectBodyMat=null):this.preSelectBody&&(this.preSelectBody.setUserMaterial(null),e=!0),i&&0<i.length){for(var s=0;s<i.length;){var o=this.viewer.ndsModel?i[s].object:this.FindParentElement(i[s].object);if(null!=o){NDSWebViewer.SETTING.HideLeafBody&&(r=o.parent.FirstVisibleNode||0,o.parent.children[r].uuid!=o.uuid)&&(o=o.parent.children[r]),this.preSelectBody=o;var r=this.preSelectBody.getUserMaterial();this.preSelectBodyMat=r||null,this.preSelectBody.setUserMaterial(this.materialPreSelectMeshopacity);break}s++}this.OpMeasure.render()}else this.preSelectBody=null,e&&this.OpMeasure.render()},d.prototype.measureBodyBoundingBox=function(e,t){var n=this.getIntersectsByPriorityOfLine(e,t);if(n&&0<n.length){for(var i=0;i<n.length;){var s=this.viewer.ndsModel?n[i].object:this.FindParentElement(n[i].object);if(null!=s)break;i++}if(null!=s){NDSWebViewer.SETTING.HideLeafBody?(s=s.parent,(e=this.viewer.ndsModel.getBodyBoundingBox(s))&&((p=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3])[0].set(e.min.x,e.min.y,e.min.z),p[1].set(e.min.x,e.min.y,e.max.z),p[2].set(e.min.x,e.max.y,e.min.z),p[3].set(e.min.x,e.max.y,e.max.z),p[4].set(e.max.x,e.min.y,e.min.z),p[5].set(e.max.x,e.min.y,e.max.z),p[6].set(e.max.x,e.max.y,e.min.z),p[7].set(e.max.x,e.max.y,e.max.z))):p=this.viewer.ndsModel.getBodyBoundingBoxTrue(s),this.OpMeasure.boundingboxmesh&&(this.OpMeasure.rootObject.remove(this.OpMeasure.boundingboxmesh),this.OpMeasure.boundingboxmesh=null);for(var o=0,r=this.OpMeasure.boundingboxInfos.length;o<r;o++){var a=this.OpMeasure.boundingboxInfos[o];this.viewer.container.removeChild(a.textBox),a.textPos=null,a.textBox=null}this.OpMeasure.boundingboxInfos.splice(0,this.OpMeasure.boundingboxInfos.length),this.OpMeasure.boundingboxmesh=this.createBodyBoundingBox(p),this.distanceInfo.unit=this.getUnitString(),this.OpMeasure.rootObject.add(this.OpMeasure.boundingboxmesh);var t=new THREE.Vector3,e=t.subVectors(p[7],p[3]).length(),l=t.subVectors(p[7],p[5]).length(),d=t.subVectors(p[7],p[6]).length(),c=this.viewer.getDispalyModelUnit(e),c=(e*=c.scale,l*=c.scale,d*=c.scale,this.getUnitStringmap(c.unit)),e=e.toFixed(this.viewer.Decimal)+c,l=l.toFixed(this.viewer.Decimal)+c,d=d.toFixed(this.viewer.Decimal)+c,c=document.createElement("div"),h=(c.style.position="absolute",c.style.color="white",c.style.zIndex=3,c.style.backgroundColor="rgba(115,0,230,0.75)",c.style.userSelect="none",c.style.pointerEvents="none",this.viewer.container.appendChild(c),document.createElement("div")),f=(h.style.position="absolute",h.style.color="white",h.style.zIndex=3,h.style.backgroundColor="rgba(115,0,230,0.75)",h.style.userSelect="none",h.style.pointerEvents="none",this.viewer.container.appendChild(h),document.createElement("div")),I=(f.style.position="absolute",f.style.color="white",f.style.zIndex=3,f.style.backgroundColor="rgba(115,0,230,0.75)",f.style.userSelect="none",f.style.pointerEvents="none",this.viewer.container.appendChild(f),t.clone().addVectors(p[7],p[3]).divideScalar(2)),u=t.clone().addVectors(p[7],p[5]).divideScalar(2),t=t.clone().addVectors(p[7],p[6]).divideScalar(2),p=(this.getAndShowTextBox(I.clone(),e,c),this.getAndShowTextBox(u.clone(),l,h),this.getAndShowTextBox(t.clone(),d,f),{}),e=(p.dimString=e,p.textPos=I.clone(),p.textBox=c,this.OpMeasure.boundingboxInfos.push(p),{}),I=(e.dimString=l,e.textPos=u.clone(),e.textBox=h,this.OpMeasure.boundingboxInfos.push(e),{});I.dimString=d,I.textPos=t.clone(),I.textBox=f,this.OpMeasure.boundingboxInfos.push(I)}}else this.measureBoundingBox(!1)},d.prototype.createBodyBoundingBox=function(e){var t=new Float32Array(24),n=(t[0]=e[0].x,t[1]=e[0].y,t[2]=e[0].z,t[3]=e[1].x,t[4]=e[1].y,t[5]=e[1].z,t[6]=e[2].x,t[7]=e[2].y,t[8]=e[2].z,t[9]=e[3].x,t[10]=e[3].y,t[11]=e[3].z,t[12]=e[4].x,t[13]=e[4].y,t[14]=e[4].z,t[15]=e[5].x,t[16]=e[5].y,t[17]=e[5].z,t[18]=e[6].x,t[19]=e[6].y,t[20]=e[6].z,t[21]=e[7].x,t[22]=e[7].y,t[23]=e[7].z,new Uint16Array([0,1,1,3,3,2,2,0,4,5,5,7,7,6,6,4,0,4,1,5,2,6,3,7])),i=new THREE.BufferGeometry;return i.setIndex(new THREE.BufferAttribute(n,1)),i.addAttribute("position",new THREE.BufferAttribute(t,3)),(n=new THREE.LineSegments(i,this.materialBoxLine)).objectType="BodyBoundingBox",n.box=e,n},d.prototype.measureBodyVolumeAndArea=function(e,t,n,i){var s=this.getIntersectsByPriorityOfLine(e,t);if(s&&0<s.length)for(var o=0;o<s.length;){if(null!=(this.viewer.ndsModel?s[o].object:this.FindParentElement(s[o].object)))break;o++}NDSWebViewer.COMMON.isMobileDevice()&&this.ChangeMeasureFlag(),this.viewer.selectionManager.selectByClick(e,t,i)},(c.prototype=Object.create(i.prototype)).OperatorStart=function(e){this.measureType=e,this.viewer.onOpChanged({id:"coordinate"}),this.coordinatediv||(this.coordinatediv=document.createElement("div"),this.coordinatediv.className="ActiveCoordinate",this.coordinatediv.style.position="absolute",this.coordinatediv.style.color="white",this.coordinatediv.style.zIndex=3,this.coordinatediv.style.backgroundColor="rgba(115,0,230,0.75)",this.coordinatediv.style.userSelect="none",this.coordinatediv.style.pointerEvents="none",this.viewer.container.appendChild(this.coordinatediv)),NDSWebViewer.COMMON.isMobileDevice()&&this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.COORDINATEPOINT)},c.prototype.onNMouseMove=function(e,t){this.coordinatediv||(this.coordinatediv=document.createElement("div"),this.coordinatediv.className="ActiveCoordinate",this.coordinatediv.style.position="absolute",this.coordinatediv.style.color="white",this.coordinatediv.style.zIndex=3,this.coordinatediv.style.backgroundColor="rgba(115,0,230,0.75)",this.coordinatediv.style.userSelect="none",this.coordinatediv.style.pointerEvents="none",this.viewer.container.appendChild(this.coordinatediv));var n,i,s,o,r,a,l=48;NDSWebViewer.COMMON.isMobileDevice()&&this.viewer.is2DModel&&(l=0),this.previewSnappedPoint(e+l,t+l,!0),this.snappedPoint?(n="X:"+parseFloat(this.snappedPoint.x.toFixed(4).toString())+"<br>Y:"+parseFloat(this.snappedPoint.y.toFixed(4).toString()),i=this.snappedPoint.clone(),this.getAndShowTextBox(i.clone(),n,this.coordinatediv),this.coordinatedivtextPos=i,this.coordinatedivdims=n):(s=(a=this.viewer).renderer.domElement,o=a.renderer.getPixelRatio(),r=new THREE.Raycaster,a.camera.setCastRay(r,(e+l)*o/s.width*2-1,2*-((t+l)*o/s.height)+1),a=new THREE.Plane(new THREE.Vector3(0,0,-1),0),e=new THREE.Vector3,r.ray.intersectPlane(a,e),e&&(n="X:"+parseFloat(e.x.toFixed(4).toString())+"<br>Y:"+parseFloat(e.y.toFixed(4).toString()),i=e.clone(),this.getAndShowTextBox(i.clone(),n,this.coordinatediv),this.coordinatedivtextPos=i,this.coordinatedivdims=n))},c.prototype.onLMouseClick=function(e,t,n){var i,s,o,r,a,l,d=document.createElement("div"),c=(d.className="mearesult",this.viewer.container.appendChild(d),48),h=(NDSWebViewer.COMMON.isMobileDevice()&&this.viewer.is2DModel&&(c=0),new THREE.Vector3),t=(this.snappedPoint?(i="X:"+parseFloat(this.snappedPoint.x.toFixed(4).toString())+"<br>Y:"+parseFloat(this.snappedPoint.y.toFixed(4).toString()),s=this.snappedPoint.clone(),this.getAndShowTextBox(s.clone(),i,d),h.copy(this.snappedPoint),this.snappedPoint=null):(o=(l=this.viewer).renderer.domElement,r=l.renderer.getPixelRatio(),a=new THREE.Raycaster,l.camera.setCastRay(a,(e+c)*r/o.width*2-1,2*-((t+c)*r/o.height)+1),l=new THREE.Plane(new THREE.Vector3(0,0,-1),0),a.ray.intersectPlane(l,h),h&&(i="X:"+parseFloat(h.x.toFixed(4).toString())+"<br>Y:"+parseFloat(h.y.toFixed(4).toString()),s=h.clone(),this.getAndShowTextBox(s.clone(),i,d))),h&&(e=this.createPointMesh(h,this.materialPoint,10*this.POINTSIZE))&&this.OpMeasure.rootObject.add(e),{});t.dimString=i,t.textPos=s,t.textBox=d,t.textBox.setAttribute("type","coordinate"),t.textBox.setAttribute("dimString",i),this.OpMeasure.boxInfos.push(t),NDSWebViewer.COMMON.isMobileDevice()&&this.ChangeMeasureFlag(),NDSWebViewer.SETTING.enableBroadcast&&NDSWebViewer.SETTING.broadcastMajor&&this.OpMeasure.addmeasureTimes(),this.OpMeasure.measureEnd()};function U(){this.start=new THREE.Vector2,this.end=new THREE.Vector2,this.p1=-1,this.p2=-1}function z(){this.edgeIndex=-1,this.Pos=-1}function _(){this.dimString="",this.textBox=null,this.textPos=null,this.lineobj=null,this.start=new THREE.Vector2,this.end=new THREE.Vector2,this.lineInfo=null,this.LineSegments=[],this.intersectMouse=null,this.intersectPos=[]}(h.prototype=Object.create(i.prototype)).OperatorStart=function(e){var t,n,i,s;this.measureType=e,NDSWebViewer.COMMON.isMobileDevice()&&this.viewer.is2DModel&&(t=this,NDSWebViewer.COMMON.getLanguage(),this.lineargaugediv||(this.lineargaugediv=document.createElement("div"),this.lineargaugediv.className="tc-box ts-tc",(e=document.createElement("p")).innerHTML=NDSWebViewer.COMMON.translateString("MEASURE_SELECTDIR"),(n=document.createElement("div")).className="ts-tcCnt",n.appendChild(e),(e=document.createElement("span")).innerHTML=NDSWebViewer.COMMON.translateString("MEASURE_Horizontal"),e.onclick=function(){t.distanceInfo.XorY=0,t.lineargaugediv.style.display="none",t.shadowdiv.style.display="none",t.ShowLineargaugeDimension(null,!0,t.distanceInfo.XorY),t.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.FIRSTPOINT),NDSWebViewer.SETTING.enableBroadcast&&NDSWebViewer.SETTING.broadcastMajor&&t.viewer.dispatchEvent({type:"broadcastEvent"})},(i=document.createElement("span")).innerHTML=NDSWebViewer.COMMON.translateString("MEASURE_Vertical"),i.onclick=function(){t.distanceInfo.XorY=1,t.lineargaugediv.style.display="none",t.shadowdiv.style.display="none",t.ShowLineargaugeDimension(null,!0,t.distanceInfo.XorY),t.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.FIRSTPOINT),NDSWebViewer.SETTING.enableBroadcast&&NDSWebViewer.SETTING.broadcastMajor&&t.viewer.dispatchEvent({type:"broadcastEvent"})},(s=document.createElement("div")).className="clearfix ts-tcBtn ts-tcBtn02",s.appendChild(e),s.appendChild(i),this.lineargaugediv.appendChild(n),this.lineargaugediv.appendChild(s),this.lineargaugediv.style.display="none",this.lineargaugediv.style.zIndex=10,this.viewer.container.appendChild(this.lineargaugediv),this.shadowdiv=document.createElement("div"),this.shadowdiv.className="shadowvtc",this.shadowdiv.style.display="none",this.viewer.container.appendChild(this.shadowdiv))),this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.FIRSTPOINT)},h.prototype.onNMouseMove=function(e,t){var n,i,s,o,r,a=new THREE.Vector3(e,t,0);this.distanceInfo.firstSelObj&&this.distanceInfo.secondSelObj&&!NDSWebViewer.COMMON.isMobileDevice()?(n=this.distanceInfo.firstPoint.clone(),i=this.distanceInfo.secondPoint.clone(),a&&(s=new THREE.Plane(new THREE.Vector3(0,0,-1),0),s=this.clientCoordToModelCoordOnPlane(a.x,a.y,s))&&(this.distanceInfo.mousePos||(this.distanceInfo.mousePos=s.clone()),r=o=!1,(o=this.distanceInfo.mousePos.y<Math.max(n.y,i.y)&&this.distanceInfo.mousePos.y>Math.min(n.y,i.y)&&this.distanceInfo.mousePos.x<Math.max(n.x,i.x)&&this.distanceInfo.mousePos.x>Math.min(n.x,i.x)?!0:o)!=(r=s.y<Math.max(n.y,i.y)&&s.y>Math.min(n.y,i.y)&&s.x<Math.max(n.x,i.x)&&s.x>Math.min(n.x,i.x)?!0:r)&&(n.y<Math.max(this.distanceInfo.mousePos.y,s.y)&&n.y>Math.min(this.distanceInfo.mousePos.y,s.y)||i.y<Math.max(this.distanceInfo.mousePos.y,s.y)&&i.y>Math.min(this.distanceInfo.mousePos.y,s.y)?this.distanceInfo.XorY=0:(n.x<Math.max(this.distanceInfo.mousePos.x,s.x)&&n.x>Math.min(this.distanceInfo.mousePos.x,s.x)||i.x<Math.max(this.distanceInfo.mousePos.x,s.x)&&i.x>Math.min(this.distanceInfo.mousePos.x,s.x))&&(this.distanceInfo.XorY=1)),this.distanceInfo.mousePos.set(s.x,s.y,0)),this.ShowLineargaugeDimension(a,!1,this.distanceInfo.XorY)):this.previewSnappedPoint(e,t,!0)},h.prototype.onLMouseClick=function(e,t,n){var i=new THREE.Vector3(e,t,0);this.distanceInfo.firstSelObj&&this.distanceInfo.secondSelObj?(this.ShowLineargaugeDimension(i,!0,this.distanceInfo.XorY),this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.FIRSTPOINT)):(this.PtToPtMeasure(e,t,!1),this.updatePtToPtScene(),this.distanceInfo.firstSelObj&&this.distanceInfo.secondSelObj&&NDSWebViewer.COMMON.isMobileDevice()&&(this.lineargaugediv.style.display="block",this.shadowdiv.style.display="block"))},h.prototype.PtToPtMeasure=function(e,t,n){if(null!=this.snappedPoint)null==this.distanceInfo.firstPoint?this.distanceInfo.firstPoint=this.snappedPoint.clone():this.distanceInfo.secondPoint=this.snappedPoint.clone(),this.snappedPoint=null;else{var i=this.getIntersectsByPriorityOfLine(e,t);if(i&&0<i.length)for(var s=0;s<i.length;){if(null!=(this.viewer.ndsModel?i[s].object:this.FindParentElement(i[s].object))){var o,r=i[s].point.clone();n&&(o=this.getSnappingPntEx(i[s]))&&r.copy(o),null==this.distanceInfo.firstPoint?this.distanceInfo.firstPoint=r:this.distanceInfo.secondPoint=r;break}s++}}this.distanceInfo.firstPoint&&!this.distanceInfo.secondPoint&&this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.SECONDPOINT),this.distanceInfo.firstPoint&&this.distanceInfo.secondPoint&&!NDSWebViewer.COMMON.isMobileDevice()&&this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.LINEPOSITION)},h.prototype.ShowLineargaugeDimension=function(e,t,n){var i,s,o;this.distanceInfo.firstSelObj&&this.distanceInfo.secondSelObj&&this.viewer.is2DModel&&(o=this.distanceInfo.firstPoint.clone(),i=this.distanceInfo.secondPoint.clone(),null==n&&(n=0),Math.abs(o.x-i.x)<1e-6&&!NDSWebViewer.COMMON.isMobileDevice()?n=1:Math.abs(o.y-i.y)<1e-6&&!NDSWebViewer.COMMON.isMobileDevice()&&(n=0),this.distanceInfo.fstClndPos?this.distanceInfo.fstClndPos.set(this.distanceInfo.firstPoint.x,this.distanceInfo.firstPoint.y,0):(this.distanceInfo.fstClndPos=this.distanceInfo.firstPoint.clone(),this.distanceInfo.fstClndPos.z=0),this.distanceInfo.sndClndPos?this.distanceInfo.sndClndPos.set(this.distanceInfo.secondPoint.x,this.distanceInfo.secondPoint.y,0):(this.distanceInfo.sndClndPos=this.distanceInfo.secondPoint.clone(),this.distanceInfo.sndClndPos.z=0),e?(s=new THREE.Plane(new THREE.Vector3(0,0,-1),0),(e=this.clientCoordToModelCoordOnPlane(e.x,e.y,s))&&0==n?(this.distanceInfo.fstClndPos.y=e.y,this.distanceInfo.sndClndPos.y=e.y):e&&1==n&&(this.distanceInfo.fstClndPos.x=e.x,this.distanceInfo.sndClndPos.x=e.x)):0==n?(s=(this.distanceInfo.fstClndPos.y+this.distanceInfo.sndClndPos.y)/2,this.distanceInfo.fstClndPos.y=s,this.distanceInfo.sndClndPos.y=s):1==n&&(e=(this.distanceInfo.fstClndPos.x+this.distanceInfo.sndClndPos.x)/2,this.distanceInfo.fstClndPos.x=e,this.distanceInfo.sndClndPos.x=e),this.distanceInfo.textPos?(this.distanceInfo.textPos.x=(this.distanceInfo.fstClndPos.x+this.distanceInfo.sndClndPos.x)/2,this.distanceInfo.textPos.y=(this.distanceInfo.fstClndPos.y+this.distanceInfo.sndClndPos.y)/2):this.distanceInfo.textPos=new THREE.Vector3((this.distanceInfo.fstClndPos.x+this.distanceInfo.sndClndPos.x)/2,(this.distanceInfo.fstClndPos.y+this.distanceInfo.sndClndPos.y)/2,0),this.distanceInfo.fstClnd&&this.OpMeasure.rootObject.remove(this.distanceInfo.fstClnd),(s=(new THREE.Vector3).subVectors(this.distanceInfo.sndClndPos,this.distanceInfo.fstClndPos)).normalize(),this.distanceInfo.fstClnd=this.createCylinderMesh(this.distanceInfo.sndClndPos,this.distanceInfo.fstClndPos,this.materialLine),e=this.OpMeasure.getScale(this.distanceInfo.fstClnd,this.CYLINDERWIDTH),s.multiplyScalar(.5*this.distanceInfo.fstClnd.geometry.parameters.height),this.distanceInfo.fstClnd.oldPosition=this.distanceInfo.fstClndPos.clone(),this.distanceInfo.fstClnd.offsetPos=s.clone(),this.distanceInfo.fstClnd.position.addVectors(this.distanceInfo.fstClndPos,s.clone().multiplyScalar(e)),this.distanceInfo.fstClnd.updateMatrixWorld(),this.OpMeasure.rootObject.add(this.distanceInfo.fstClnd),this.distanceInfo.sndClnd&&this.OpMeasure.rootObject.remove(this.distanceInfo.sndClnd),this.distanceInfo.sndClnd=this.createCylinderMesh(this.distanceInfo.fstClndPos,this.distanceInfo.sndClndPos,this.materialLine),this.distanceInfo.sndClnd.oldPosition=this.distanceInfo.sndClndPos.clone(),this.distanceInfo.sndClnd.offsetPos=s.clone().multiplyScalar(-1),this.distanceInfo.sndClnd.position.subVectors(this.distanceInfo.sndClndPos,s.clone().multiplyScalar(e)),this.distanceInfo.sndClnd.updateMatrixWorld(),this.OpMeasure.rootObject.add(this.distanceInfo.sndClnd),this.distanceInfo.clndToClndLine&&this.OpMeasure.rootObject.remove(this.distanceInfo.clndToClndLine),this.distanceInfo.clndToClndLine=this.createLineMesh2(this.distanceInfo.fstClndPos,this.distanceInfo.sndClndPos,this.materialLine,1),this.OpMeasure.rootObject.add(this.distanceInfo.clndToClndLine),this.distanceInfo.fstToClndLine&&this.OpMeasure.rootObject.remove(this.distanceInfo.fstToClndLine),this.distanceInfo.fstToClndLine=this.createLineMesh2(o,this.distanceInfo.fstClndPos,this.materialLine,1),this.OpMeasure.rootObject.add(this.distanceInfo.fstToClndLine),this.distanceInfo.sndToClndLine&&this.OpMeasure.rootObject.remove(this.distanceInfo.sndToClndLine),this.distanceInfo.sndToClndLine=this.createLineMesh2(i,this.distanceInfo.sndClndPos,this.materialLine,1),this.OpMeasure.rootObject.add(this.distanceInfo.sndToClndLine),this.distanceInfo.dimString=this.distanceInfo.firstPoint.distanceTo(this.distanceInfo.secondPoint),0==n?this.distanceInfo.dimString=Math.abs(this.distanceInfo.firstPoint.x-this.distanceInfo.secondPoint.x):1==n&&(this.distanceInfo.dimString=Math.abs(this.distanceInfo.firstPoint.y-this.distanceInfo.secondPoint.y)),this.distanceInfo.dimString<1&&.999999<this.distanceInfo.dimString&&(this.distanceInfo.dimString=1),s=this.viewer.getDispalyModelUnit(this.distanceInfo.dimString),this.distanceInfo.dimString*=s.scale,this.distanceInfo.dimString=this.distanceInfo.dimString.toFixed(8),this.distanceInfo.unit=this.getUnitStringmap(s.unit),e=(this.distanceInfo.dimString*this.viewer.measuringScale).toFixed(8)+this.distanceInfo.unit,this.distanceInfo.textBox||(this.distanceInfo.textBox=document.createElement("div"),this.distanceInfo.textBox.className="mearesult",this.viewer.container.appendChild(this.distanceInfo.textBox)),this.getAndShowTextBox(this.distanceInfo.textPos.clone(),e,this.distanceInfo.textBox),1==t)&&((o={}).dimString=e,o.textPos=this.distanceInfo.textPos.clone(),o.textBox=this.distanceInfo.textBox,o.textBox.setAttribute("type","length"),o.textBox.setAttribute("dimString",this.distanceInfo.dimString),o.textBox.setAttribute("dimStringPrefix",""),o.textBox.setAttribute("unit",this.distanceInfo.unit),this.OpMeasure.boxInfos.push(o),this.clearDistanceInfo(!0),NDSWebViewer.COMMON.isMobileDevice())&&this.ChangeMeasureFlag()},h.prototype.updatePtToPtScene=function(){var e;this.distanceInfo.firstPoint&&!this.distanceInfo.firstSelObj&&(e=this.createPointMesh(this.distanceInfo.firstPoint,this.materialPoint,this.POINTSIZE))&&(this.OpMeasure.rootObject.add(e),this.distanceInfo.firstSelObj=e),this.distanceInfo.secondPoint&&!this.distanceInfo.secondSelObj&&(e=this.createPointMesh(this.distanceInfo.secondPoint,this.materialPoint,this.POINTSIZE))&&(this.OpMeasure.rootObject.add(e),this.distanceInfo.secondSelObj=e),this.distanceInfo.firstSelObj&&this.distanceInfo.secondSelObj&&!NDSWebViewer.COMMON.isMobileDevice()&&this.ShowLineargaugeDimension()};function f(e){i.call(this,e),this.measureClass="Contour"}function I(e){i.call(this,e),this.measureClass="Lineargauge3D";var t=this;this.clickBoxInfo=function(e){!NDSWebViewer.COMMON.isMobileDevice()&&"Lineargauge3D"==t.measureClass&&t.isBoxMoving&&(t.getViewClientCoords(e),t.ShowLineargaugeDimension(null,!0,t.distanceInfo.XorY,!0),t.allowType=t.MeasurePostInfo(t.measureType,!0,!0),t.OpMeasure.measureEnd())}}function u(e){i.call(this,e),this.measureClass="WallThickness",this.tmpDimStringPrefix=NDSWebViewer.COMMON.translateString("MINIMUM")}function p(e){i.call(this,e),this.measureClass="Ellipse"}function S(e){NDSWebViewer.OpBase.call(this,e);var a=this;this.MeasureOper=new i(this),!this.viewer.hasBrepInfo()&&this.viewer.hasBrepFile()?this.viewer.loadBrepInfo(!1):this.viewer.dispatchEvent({type:"BrepInfoEvent"}),this.scene=new THREE.Scene,this.type="OpMeasure",this.dimString="",this.unit="",this.measureType="pt2pt",this.boxInfos=[],this.textLines=[],this.click=!1,this.measureRelease=!0,this.clientHeightRatio=0,this.clientWidthRatio=0,this.hasZoomArea=!1,this.longClick=0,this.totalArea=0,this.totalVolume=0,this.pixWidth=120,this.hasMouseZoomArea=!0,this.showMouseZoomArea=!1,this.dpr=Math.floor(window.devicePixelRatio),1!=this.dpr&&2!=this.dpr&&3!=this.dpr&&(this.dpr=1),this.textBoxBroadcast=null,this.textPosBroadcast=null,this.perimeterInfos=[],this.perimeterBroadcast=null,this.perimeterunit=null,this.measureTimes=0,this.measureShowResult=!1,this.currentUuid=null,this.unsteady=!1,this.unsteadyType="",this.unsteadyuuid=null,this.unsteadyData={},this.unsteadyTextBox=null,this.unsteadyMoving=!1,this.startPoint=null,this.measureFlag=0,this.Popup=null,this.lineargauge3DProcessedLineSet=new Set,this.prompt=document.createElement("div"),NDSWebViewer.COMMON.isMobileDevice()?this.prompt.className="app-alert":this.prompt.className="pc-alert",this.viewer.container.appendChild(this.prompt),this.debounceTouchSinglemove=function(t,n){let i,s=a;return function(){let e=arguments;i&&clearTimeout(i),i=setTimeout(()=>{t.apply(s,e)},n)}}(function(){var e,t;this.debounceStop||(e=this.pointer.x,t=this.pointer.y,this.hasMouseZoomArea&&(t-=this.pixWidth/2),this.MeasureOper.onNMouseMove(e,t),this.MeasureOper.isTwoTopolInfoTheSame(this.MeasureOper.distanceInfo.preSelInfoOld,this.MeasureOper.distanceInfo.preSelInfo))||(this.imageData=null,this.MeasureOper.distanceInfo.preSelInfoOld=function(e){var t,n={};for(t in e)n[t]=e[t];return n}(this.MeasureOper.distanceInfo.preSelInfo),this.hasMouseZoomArea?this.changeMouseZoomArea():this.changeZoomArea())},80),this.debounceTouchSinglemove2=function(t,n,i){let s=!0,o=!0,r=a;return function(){var e=arguments;if(n.apply(r,e),s&&(s=!1,setTimeout(function(){s=!0},i),o)){o=!1;try{t.apply(r,e)}catch(e){o=!0,console.error(e)}o=!0}}}(function(){var e,t;this.debounceStop||(e=this.pointer.x,t=this.pointer.y,this.hasMouseZoomArea&&1==this.longClick&&(t-=this.pixWidth/2),this.MeasureOper.onNMouseMove(e,t))},function(){this.render(),this.MeasureOper.isTwoTopolInfoTheSame(this.MeasureOper.distanceInfo.preSelInfoOld,this.MeasureOper.distanceInfo.preSelInfo)||(this.imageData=null,this.MeasureOper.distanceInfo.preSelInfoOld=function(e){var t,n={};for(t in e)n[t]=e[t];return n}(this.MeasureOper.distanceInfo.preSelInfo),this.hasMouseZoomArea?this.changeMouseZoomArea():this.changeZoomArea())},80),this.debounceStop=!1,this.imageData=null,this.boundingboxmesh=null,this.boundingboxInfos=[],this.preSelectBody=null,this.preSelectBodyMat=null,this.rootObject=new THREE.Object3D,this.measureData=new THREE.Group,this.measureData.objectType="Group",this.scene.add(this.rootObject),this.viewer.canvas2D&&(this.viewer.canvas2D.style.display=""),this.render()}(f.prototype=Object.create(i.prototype)).OperatorStart=function(e){var A,t,n,i;"contour"==(this.measureType=e)?(this.contourdiv||((A=this).contourdiv=document.createElement("div"),NDSWebViewer.COMMON.isMobileDevice()?(this.contourdiv.className="continuityLength-arrow",(n=document.createElement("span")).className="arrow-prev no",(t=document.createElement("a")).className="continuityLength-btn no",t.innerHTML=NDSWebViewer.COMMON.translateString("CONTOUR_CONFIRM"),this.contourdiv.appendChild(n),this.contourdiv.appendChild(t)):(this.contourdiv.id="contour",this.contourdiv.style.position="absolute",this.contourdiv.style.zIndex=3,(t=document.createElement("img")).style.height="36px",t.style.width="36px",(n=document.createElement("img")).style.height="36px",n.style.width="36px",(i=document.createElement("img")).style.height="36px",i.style.width="36px"),t.onclick=function(){if(0!=A.lineContoursInfo.Contours.length){A.contourdiv.style.display="none";for(var e=null,t=A.lineContoursInfo.perimeter=0;t<A.lineContoursInfo.Contours.length;++t){var n=A.lineContoursInfo.Contours[t];if(A.OpMeasure.rootObject.remove(n.lineobj),1==n.LineSegments.length){for(var i=0,s=1,o=0;o<n.intersectPos.length;++o){if(n.intersectMouse.Pos>=i&&n.intersectMouse.Pos<=n.intersectPos[o].Pos){s=n.intersectPos[o].Pos;break}i=n.intersectPos[o].Pos}var r=n.LineSegments[0].start.distanceTo(n.LineSegments[0].end),a=n.LineSegments[0].end.clone().sub(n.LineSegments[0].start).normalize(),l=((I=[])[0]=n.LineSegments[0].start.x+i*r*a.x,I[1]=n.LineSegments[0].start.y+i*r*a.y,I[2]=0,I[3]=n.LineSegments[0].start.x+s*r*a.x,I[4]=n.LineSegments[0].start.y+s*r*a.y,I[5]=0,t==A.lineContoursInfo.Contours.length-1&&(e=new THREE.Vector3(I[3],I[4],I[5])),A.createContour(I));A.OpMeasure.rootObject.add(l),n.lineobj=l,n.textPos=new THREE.Vector3((I[0]+I[3])/2,(I[1]+I[4])/2,0),n.dimString=(s-i)*r}else{for(var i=0,d=0,s=n.LineSegments.length-1,c=1,o=0;o<n.intersectPos.length;++o){if((n.intersectMouse.edgeIndex>i||n.intersectMouse.edgeIndex==i&&n.intersectMouse.Pos>d)&&(n.intersectMouse.edgeIndex<n.intersectPos[o].edgeIndex||n.intersectMouse.edgeIndex==n.intersectPos[o].edgeIndex&&n.intersectMouse.Pos<n.intersectPos[o].Pos)){s=n.intersectPos[o].edgeIndex,c=n.intersectPos[o].Pos;break}(n.intersectPos[o].edgeIndex<s||n.intersectPos[o].Pos<1)&&(i=n.intersectPos[o].edgeIndex,d=n.intersectPos[o].Pos)}for(var h=0,f=n.intersectPos.length-1,I=(n.start.distanceTo(n.end)<1e-6&&0==i&&0==d&&-1<f?h=n.LineSegments.length-n.intersectPos[f].edgeIndex:n.start.distanceTo(n.end)<1e-6&&s==n.LineSegments.length-1&&1==c&&-1<f&&(h=n.intersectPos[0].edgeIndex+1),[]),u=0,p=0,o=i;o<=s;++o,++u){var S=n.LineSegments[o].start.clone(),a=(g=n.LineSegments[o].end.clone()).clone().sub(S).normalize();o==i&&(r=S.distanceTo(g),S.x+=d*r*a.x,S.y+=d*r*a.y),o==s&&(r=S.distanceTo(g),g.x=S.x+c*r*a.x,g.y=S.y+c*r*a.y),o==parseInt((i+s)/2)&&(n.textPos=new THREE.Vector3((S.x+g.x)/2,(S.y+g.y)/2,0)),I[6*u+0]=S.x,I[6*u+1]=S.y,I[6*u+2]=0,I[6*u+3]=g.x,I[6*u+4]=g.y,I[6*u+5]=0,p+=S.distanceTo(g)}if(0<h)if(0==i&&0==d)for(o=n.intersectPos[f].edgeIndex;o<n.LineSegments.length;++o,++u){S=n.LineSegments[o].start.clone(),a=(g=n.LineSegments[o].end.clone()).clone().sub(S).normalize();o==n.intersectPos[f].edgeIndex&&(r=S.distanceTo(g),S.x+=n.intersectPos[f].Pos*r*a.x,S.y+=n.intersectPos[f].Pos*r*a.y),I[6*u+0]=S.x,I[6*u+1]=S.y,I[6*u+2]=0,I[6*u+3]=g.x,I[6*u+4]=g.y,I[6*u+5]=0,p+=S.distanceTo(g)}else for(o=0;o<=n.intersectPos[0].edgeIndex;++o,++u){var g,S=n.LineSegments[o].start.clone(),a=(g=n.LineSegments[o].end.clone()).clone().sub(S).normalize();o==n.intersectPos[0].edgeIndex&&(r=S.distanceTo(g),g.x=S.x+n.intersectPos[0].Pos*r*a.x,g.y=S.y+n.intersectPos[0].Pos*r*a.y),I[6*u+0]=S.x,I[6*u+1]=S.y,I[6*u+2]=0,I[6*u+3]=g.x,I[6*u+4]=g.y,I[6*u+5]=0,p+=S.distanceTo(g)}t==A.lineContoursInfo.Contours.length-1&&(e=new THREE.Vector3(I[6*(u-1)+3],I[6*(u-1)+4],I[6*(u-1)+5]));l=A.createContour(I);A.OpMeasure.rootObject.add(l),n.lineobj=l,n.dimString=p}var h=parseFloat(n.dimString),E=A.viewer.getDispalyModelUnit(h),m=(h*=E.scale,A.lineContoursInfo.unit=A.getUnitStringmap(E.unit),A.lineContoursInfo.perimeter+=h,(parseFloat(h)*A.viewer.measuringScale).toFixed(2));m+=A.lineContoursInfo.unit,n.textBox.style.display="inline",A.getAndShowTextBox(n.textPos.clone(),m,n.textBox),(b={}).dimString=m,b.textPos=n.textPos.clone(),b.textBox=n.textBox,b.textBox.setAttribute("type","length"),b.textBox.setAttribute("dimString",n.dimString),b.textBox.setAttribute("dimStringPrefix",""),b.textBox.setAttribute("unit",A.lineContoursInfo.unit);for(var O=0;O<A.OpMeasure.boxInfos.length;O++)A.OpMeasure.boxInfos[O].textPos.distanceTo(b.textPos)<1e-4&&(b.textPos.y+=3);A.OpMeasure.boxInfos.push(b)}var b,P=document.createElement("div"),m=(P.className="mearesult",A.viewer.container.appendChild(P),(A.lineContoursInfo.perimeter*A.viewer.measuringScale).toFixed(2));m+=A.lineContoursInfo.unit,m=NDSWebViewer.COMMON.translateString("MEASURE_OVERLENGTH")+":"+m,A.getAndShowTextBox(e.clone(),m,P),(b={}).dimString=m,b.textPos=e.clone(),b.textBox=P,b.textBox.setAttribute("type","perimeter"),b.textBox.setAttribute("dimString",A.lineContoursInfo.perimeter),b.textBox.setAttribute("unit",A.lineContoursInfo.unit);for(O=0;O<A.OpMeasure.boxInfos.length;O++)A.OpMeasure.boxInfos[O].textPos.distanceTo(b.textPos)<1e-4&&(b.textPos.y+=3);A.OpMeasure.boxInfos.push(b),A.clearContoursInfo(!0),A.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.CIRCLEANDLINE),NDSWebViewer.COMMON.isMobileDevice()&&A.ChangeMeasureFlag(),NDSWebViewer.SETTING.enableBroadcast&&NDSWebViewer.SETTING.broadcastMajor&&A.viewer.dispatchEvent({type:"broadcastEvent"})}},n.onclick=function(){if(0!=A.lineContoursInfo.Contours.length){var e=null,t=A.lineContoursInfo.Contours.length-1,e=A.lineContoursInfo.Contours.pop();if(0<t)if(A.lineContoursInfo.divPos=A.lineContoursInfo.Contours[t-1].textPos,e.start.equals(A.lineContoursInfo.start))for(var n=0;n<A.lineContoursInfo.Contours.length;++n)(i=A.lineContoursInfo.Contours[n]).start.distanceTo(e.end)&&A.lineContoursInfo.start.copy(i.start);else for(var i,n=0;n<A.lineContoursInfo.Contours.length;++n)(i=A.lineContoursInfo.Contours[n]).end.distanceTo(e.start)&&A.lineContoursInfo.end.copy(i.end);0==A.lineContoursInfo.Contours.length?(NDSWebViewer.COMMON.isMobileDevice()?(A.contourdiv.children[0].className="arrow-prev no",A.contourdiv.children[1].className="continuityLength-btn no"):A.contourdiv.style.display="none",A.lineContoursInfo.preSelLineInfo=null,A.lineContoursInfo.preSelLineObj=null,A.lineContoursInfo.prestart=new THREE.Vector2,A.lineContoursInfo.preend=new THREE.Vector2,A.lineContoursInfo.divPos=null,A.lineContoursInfo.start=new THREE.Vector2,A.lineContoursInfo.end=new THREE.Vector2):1==A.lineContoursInfo.Contours.length&&(A.lineContoursInfo.start.copy(A.lineContoursInfo.Contours[0].start),A.lineContoursInfo.end.copy(A.lineContoursInfo.Contours[0].end)),A.OpMeasure.rootObject.remove(e.lineobj),A.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.CIRCLEANDLINE),A.viewer.render()}},NDSWebViewer.COMMON.isMobileDevice()||(i.onclick=function(){A.contourdiv.style.display="none",A.lineContoursInfo.preSelLineInfo=null,A.lineContoursInfo.preSelLineObj=null,A.lineContoursInfo.prestart=new THREE.Vector2,A.lineContoursInfo.preend=new THREE.Vector2,A.lineContoursInfo.divPos=null;for(var e=0;e<A.lineContoursInfo.Contours.length;++e)A.OpMeasure.rootObject.remove(A.lineContoursInfo.Contours[e].lineobj);A.lineContoursInfo.Contours=[],A.lineContoursInfo.start=new THREE.Vector2,A.lineContoursInfo.end=new THREE.Vector2,A.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.CIRCLEANDLINE)},this.contourdiv.style.display="none"),this.contourdiv.onmousemove=function(e){e.preventDefault(),e.stopPropagation(),A.lineContoursInfo.preSelLineObj&&(A.OpMeasure.rootObject.remove(A.lineContoursInfo.preSelLineObj),A.lineContoursInfo.preSelLineObj=null,A.lineContoursInfo.preSelLineInfo=null)},this.viewer.container.appendChild(this.contourdiv)),this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.CIRCLEANDLINE)):"contourarea"==e&&(this.contourdiv||((A=this).contourdiv=document.createElement("div"),NDSWebViewer.COMMON.isMobileDevice()?(this.contourdiv.className="continuityLength-arrow",(n=document.createElement("span")).className="arrow-prev no",(t=document.createElement("a")).className="continuityLength-btn no",t.innerHTML=NDSWebViewer.COMMON.translateString("CONTOUR_CONFIRM"),this.contourdiv.appendChild(n),this.contourdiv.appendChild(t)):(this.contourdiv.id="contour",this.contourdiv.style.position="absolute",this.contourdiv.style.zIndex=3,(t=document.createElement("img")).style.height="36px",t.style.width="36px",(n=document.createElement("img")).style.height="36px",n.style.width="36px",(i=document.createElement("img")).style.height="36px",i.style.width="36px"),t.onclick=function(){if(0!=A.lineContoursInfo.Contours.length){NDSWebViewer.COMMON.isMobileDevice()&&A.ChangeMeasureFlag();var e=[],o=[],r=[],t=[];A.contourdiv.style.display="none";for(var n=0;n<A.lineContoursInfo.Contours.length;++n)if("circle"==(L=A.lineContoursInfo.Contours[n]).lineInfo.type&&L.LineSegments[0].start.distanceTo(L.LineSegments[L.LineSegments.length-1].end)<.002){var i=new THREE.Vector3(L.lineInfo.center[0],L.lineInfo.center[1],L.lineInfo.center[2]),i=(i.applyMatrix4(L.lineInfo.matrixWorld),{radius:L.lineInfo.radius,pos:i.toArray()});t.push(i)}else{A.OpMeasure.rootObject.remove(L.lineobj),L.lineobj=null;for(var s=0;s<L.LineSegments.length;++s){for(var a=L.LineSegments[s],l={},d=0;d<r.length;++d){var c=new THREE.Vector3;A.lineIntersection2D(a.start,a.end,r[d].start,r[d].end,c)&&((l[c.z]=c).z=d)}if(Object.keys(l).length<1)a.p1=o.length,o.push(a.start),a.p2=o.length,o.push(a.end),r.push(a);else{var h=[];h.push(a.start),Object.keys(l).sort(function(e,t){return e-t}).forEach(function(e){var t,n,i,s;0!=l[e].s&&1!=l[e].s&&(t=r[l[e].z],(s=new THREE.Vector2).set(l[e].x,l[e].y),(i=new w).start.set(t.start.x,t.start.y),i.end.set(l[e].x,l[e].y),i.p1=t.p1,-1<(n=A.getIndexFromPoints(s,o))?i.p2=n:(i.p2=o.length,n=i.p2,o.push(s)),r.push(i),(i=new w).start.set(l[e].x,l[e].y),i.end.set(t.end.x,t.end.y),i.p1=n,i.p2=t.p2,r.push(i),r[l[e].z]=null),0!=e&&1!=e&&((s=new THREE.Vector2).set(l[e].x,l[e].y),h.push(s))}),h.push(a.end);for(d=0;d<h.length-1;++d){var f=new w,I=(f.start.set(h[d].x,h[d].y),f.end.set(h[d+1].x,h[d+1].y),A.getIndexFromPoints(h[d],o));-1<I?f.p1=I:(f.p1=o.length,o.push(h[d])),-1<(I=A.getIndexFromPoints(h[d+1],o))?f.p2=I:(f.p2=o.length,o.push(h[d+1])),r.push(f)}}for(d=0;d<r.length;++d)r[d]||(r.splice(d,1),--d)}}var u=new THREE.Box2(o[0],o[1]),p=new NDSWebViewer.NDS.Triangulator.ContourSet(r,u);p.sanitizeEdges(),p.stitchContoursCheng();for(var S=0;S<p.contours.length;S++){var g=p.contours[S];if(g[0]==g[g.length-1]){for(var E=0,m=new THREE.Vector2,O=[],b=1;b<g.length;b++){var P=o[g[b-1]],M=o[g[b]];O[6*(b-1)+0]=P.x,O[6*(b-1)+1]=P.y,O[6*(b-1)+2]=0,O[6*(b-1)+3]=M.x,O[6*(b-1)+4]=M.y,O[6*(b-1)+5]=0,E+=(P.x*M.y-P.y*M.x)/2,m.add(P)}var T=A.createContour(O);A.OpMeasure.rootObject.add(T),m.divideScalar(g.length-1),E=Math.abs(E),(y=document.createElement("div")).className="mearesult",A.viewer.container.appendChild(y);var E=E*(C=A.viewer.getDispalyModelUnit(E)).scale*C.scale,x=(A.lineContoursInfo.unit=A.getUnitStringmap(C.unit),(E*Math.pow(A.viewer.measuringScale,2)).toFixed(2));x=NDSWebViewer.COMMON.translateString("MEASURE_AREA")+":"+x+A.lineContoursInfo.unit+"",(N={}).dimString=x,N.textPos=new THREE.Vector3(m.x,m.y,0),N.textBox=y,N.textBox.setAttribute("type","area"),N.textBox.setAttribute("dimString",E),N.textBox.setAttribute("unit",A.lineContoursInfo.unit+"");for(d=0;d<A.OpMeasure.boxInfos.length;d++)A.OpMeasure.boxInfos[d].textPos.distanceTo(N.textPos)<1e-4&&N.textBox.setAttribute("needDown","true");for(d=0;d<e.length;d++)e[d].textPos.distanceTo(N.textPos)<1e-4&&N.textBox.setAttribute("needDown","true");e.push(N)}}for(var y,S=0;S<t.length;++S){E=Math.pow(t[S].radius,2)*Math.PI,(y=document.createElement("div")).className="mearesult",A.viewer.container.appendChild(y);E=E*(C=A.viewer.getDispalyModelUnit(E)).scale*C.scale,A.lineContoursInfo.unit=A.getUnitStringmap(C.unit);var C,N,x=(E*Math.pow(A.viewer.measuringScale,2)).toFixed(2);x=NDSWebViewer.COMMON.translateString("MEASURE_AREA")+":"+x+A.lineContoursInfo.unit+"",(N={}).dimString=x,N.textPos=new THREE.Vector3(t[S].pos[0],t[S].pos[1],0),N.textBox=y,N.textBox.setAttribute("type","area"),N.textBox.setAttribute("dimString",E),N.textBox.setAttribute("unit",A.lineContoursInfo.unit+"");for(d=0;d<A.OpMeasure.boxInfos.length;d++)A.OpMeasure.boxInfos[d].textPos.distanceTo(N.textPos)<1e-4&&N.textBox.setAttribute("needDown","true");for(d=0;d<e.length;d++)e[d].textPos.distanceTo(N.textPos)<1e-4&&N.textBox.setAttribute("needDown","true");e.push(N)}if(0<e.length)A.OpMeasure.boxInfos=A.OpMeasure.boxInfos.concat(e);else{A.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.NOCLOSE);for(n=0;n<A.lineContoursInfo.Contours.length;++n){var L=A.lineContoursInfo.Contours[n];A.OpMeasure.rootObject.remove(L.lineobj)}}A.clearContoursInfo(!0),NDSWebViewer.SETTING.enableBroadcast&&NDSWebViewer.SETTING.broadcastMajor&&A.viewer.dispatchEvent({type:"broadcastEvent"})}function w(){this.start=new THREE.Vector2,this.end=new THREE.Vector2,this.p1=-1,this.p2=-1}},n.onclick=function(){var e,t;0!=A.lineContoursInfo.Contours.length&&(t=null,e=A.lineContoursInfo.Contours.length-1,t=A.lineContoursInfo.Contours.pop(),0<e&&(A.lineContoursInfo.divPos=A.lineContoursInfo.Contours[e-1].textPos),0==A.lineContoursInfo.Contours.length&&(NDSWebViewer.COMMON.isMobileDevice()?(A.contourdiv.children[0].className="arrow-prev no",A.contourdiv.children[1].className="continuityLength-btn no"):A.contourdiv.style.display="none",A.lineContoursInfo.preSelLineInfo=null,A.lineContoursInfo.preSelLineObj=null,A.lineContoursInfo.prestart=new THREE.Vector2,A.lineContoursInfo.preend=new THREE.Vector2,A.lineContoursInfo.divPos=null,A.lineContoursInfo.start=new THREE.Vector2,A.lineContoursInfo.end=new THREE.Vector2),A.OpMeasure.rootObject.remove(t.lineobj),A.viewer.render())},NDSWebViewer.COMMON.isMobileDevice()||(i.onclick=function(){A.contourdiv.style.display="none",A.lineContoursInfo.preSelLineInfo=null,A.lineContoursInfo.preSelLineObj=null,A.lineContoursInfo.prestart=new THREE.Vector2,A.lineContoursInfo.preend=new THREE.Vector2,A.lineContoursInfo.divPos=null;for(var e=0;e<A.lineContoursInfo.Contours.length;++e)A.OpMeasure.rootObject.remove(A.lineContoursInfo.Contours[e].lineobj);A.lineContoursInfo.Contours=[],A.lineContoursInfo.start=new THREE.Vector2,A.lineContoursInfo.end=new THREE.Vector2},this.contourdiv.style.display="none"),this.contourdiv.onmousemove=function(e){e.preventDefault(),e.stopPropagation(),A.lineContoursInfo.preSelLineObj&&(A.OpMeasure.rootObject.remove(A.lineContoursInfo.preSelLineObj),A.lineContoursInfo.preSelLineObj=null,A.lineContoursInfo.preSelLineInfo=null)},this.viewer.container.appendChild(this.contourdiv)),this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.CIRCLEANDLINE))},f.prototype.measureEnd=function(){if("contour"==this.measureType){if(0==this.lineContoursInfo.Contours.length)return;this.contourdiv.style.display="none";for(var e=null,t=this.lineContoursInfo.perimeter=0;t<this.lineContoursInfo.Contours.length;++t){var n=this.lineContoursInfo.Contours[t];if(this.OpMeasure.rootObject.remove(n.lineobj),1==n.LineSegments.length){for(var i=0,s=1,o=0;o<n.intersectPos.length;++o){if(n.intersectMouse.Pos>=i&&n.intersectMouse.Pos<=n.intersectPos[o].Pos){s=n.intersectPos[o].Pos;break}i=n.intersectPos[o].Pos}var r=n.LineSegments[0].start.distanceTo(n.LineSegments[0].end),a=n.LineSegments[0].end.clone().sub(n.LineSegments[0].start).normalize(),l=((I=[])[0]=n.LineSegments[0].start.x+i*r*a.x,I[1]=n.LineSegments[0].start.y+i*r*a.y,I[2]=0,I[3]=n.LineSegments[0].start.x+s*r*a.x,I[4]=n.LineSegments[0].start.y+s*r*a.y,I[5]=0,t==this.lineContoursInfo.Contours.length-1&&(e=new THREE.Vector3(I[3],I[4],I[5])),this.createContour(I));this.OpMeasure.rootObject.add(l),n.lineobj=l,n.textPos=new THREE.Vector3((I[0]+I[3])/2,(I[1]+I[4])/2,0),n.dimString=(s-i)*r}else{for(var i=0,d=0,s=n.LineSegments.length-1,c=1,o=0;o<n.intersectPos.length;++o){if((n.intersectMouse.edgeIndex>i||n.intersectMouse.edgeIndex==i&&n.intersectMouse.Pos>d)&&(n.intersectMouse.edgeIndex<n.intersectPos[o].edgeIndex||n.intersectMouse.edgeIndex==n.intersectPos[o].edgeIndex&&n.intersectMouse.Pos<n.intersectPos[o].Pos)){s=n.intersectPos[o].edgeIndex,c=n.intersectPos[o].Pos;break}(n.intersectPos[o].edgeIndex<s||n.intersectPos[o].Pos<1)&&(i=n.intersectPos[o].edgeIndex,d=n.intersectPos[o].Pos)}for(var h=0,f=n.intersectPos.length-1,I=(n.start.distanceTo(n.end)<1e-6&&0==i&&0==d&&-1<f?h=n.LineSegments.length-n.intersectPos[f].edgeIndex:n.start.distanceTo(n.end)<1e-6&&s==n.LineSegments.length-1&&1==c&&-1<f&&(h=n.intersectPos[0].edgeIndex+1),[]),u=0,p=0,o=i;o<=s;++o,++u){var S=n.LineSegments[o].start.clone(),a=(g=n.LineSegments[o].end.clone()).clone().sub(S).normalize();o==i&&(r=S.distanceTo(g),S.x+=d*r*a.x,S.y+=d*r*a.y),o==s&&(r=S.distanceTo(g),g.x=S.x+c*r*a.x,g.y=S.y+c*r*a.y),o==parseInt((i+s)/2)&&(n.textPos=new THREE.Vector3((S.x+g.x)/2,(S.y+g.y)/2,0)),I[6*u+0]=S.x,I[6*u+1]=S.y,I[6*u+2]=0,I[6*u+3]=g.x,I[6*u+4]=g.y,I[6*u+5]=0,p+=S.distanceTo(g)}if(0<h)if(0==i&&0==d)for(o=n.intersectPos[f].edgeIndex;o<n.LineSegments.length;++o,++u){S=n.LineSegments[o].start.clone(),a=(g=n.LineSegments[o].end.clone()).clone().sub(S).normalize();o==n.intersectPos[f].edgeIndex&&(r=S.distanceTo(g),S.x+=n.intersectPos[f].Pos*r*a.x,S.y+=n.intersectPos[f].Pos*r*a.y),I[6*u+0]=S.x,I[6*u+1]=S.y,I[6*u+2]=0,I[6*u+3]=g.x,I[6*u+4]=g.y,I[6*u+5]=0,p+=S.distanceTo(g)}else for(o=0;o<=n.intersectPos[0].edgeIndex;++o,++u){var g,S=n.LineSegments[o].start.clone(),a=(g=n.LineSegments[o].end.clone()).clone().sub(S).normalize();o==n.intersectPos[0].edgeIndex&&(r=S.distanceTo(g),g.x=S.x+n.intersectPos[0].Pos*r*a.x,g.y=S.y+n.intersectPos[0].Pos*r*a.y),I[6*u+0]=S.x,I[6*u+1]=S.y,I[6*u+2]=0,I[6*u+3]=g.x,I[6*u+4]=g.y,I[6*u+5]=0,p+=S.distanceTo(g)}t==this.lineContoursInfo.Contours.length-1&&(e=new THREE.Vector3(I[6*(u-1)+3],I[6*(u-1)+4],I[6*(u-1)+5]));l=this.createContour(I);this.OpMeasure.rootObject.add(l),n.lineobj=l,n.dimString=p}var h=parseFloat(n.dimString),E=(h*=(R=this.viewer.getDispalyModelUnit(h)).scale,this.lineContoursInfo.unit=this.getUnitStringmap(R.unit),this.lineContoursInfo.perimeter+=h,(h*this.viewer.measuringScale).toFixed(2));E+=this.lineContoursInfo.unit,n.textBox.style.display="inline",this.getAndShowTextBox(n.textPos.clone(),E,n.textBox),(V={}).dimString=E,V.textPos=n.textPos.clone(),V.textBox=n.textBox,V.textBox.setAttribute("type","length"),V.textBox.setAttribute("dimString",h),V.textBox.setAttribute("dimStringPrefix",""),V.textBox.setAttribute("unit",this.lineContoursInfo.unit);for(var m=0;m<this.OpMeasure.boxInfos.length;m++)this.OpMeasure.boxInfos[m].textPos.distanceTo(V.textPos)<1e-4&&V.textBox.setAttribute("needDown","true");this.OpMeasure.boxInfos.push(V)}E=((D=document.createElement("div")).className="mearesult",this.viewer.container.appendChild(D),(this.lineContoursInfo.perimeter*this.viewer.measuringScale).toFixed(2));E+=this.lineContoursInfo.unit,E=NDSWebViewer.COMMON.translateString("MEASURE_OVERLENGTH")+":"+E,this.getAndShowTextBox(e.clone(),E,D),(V={}).dimString=E,V.textPos=e.clone(),V.textBox=D,V.textBox.setAttribute("type","perimeter"),V.textBox.setAttribute("dimString",this.lineContoursInfo.perimeter),V.textBox.setAttribute("unit",this.lineContoursInfo.unit);for(m=0;m<this.OpMeasure.boxInfos.length;m++)this.OpMeasure.boxInfos[m].textPos.distanceTo(V.textPos)<1e-4&&V.textBox.setAttribute("needDown","true");this.OpMeasure.boxInfos.push(V),this.clearContoursInfo(!0),this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.CIRCLEANDLINE),NDSWebViewer.COMMON.isMobileDevice()&&this.ChangeMeasureFlag(),NDSWebViewer.SETTING.enableBroadcast&&NDSWebViewer.SETTING.broadcastMajor&&this.viewer.dispatchEvent({type:"broadcastEvent"})}else if("contourarea"==this.measureType){if(0==this.lineContoursInfo.Contours.length)return;function j(){this.start=new THREE.Vector2,this.end=new THREE.Vector2,this.p1=-1,this.p2=-1}NDSWebViewer.COMMON.isMobileDevice()&&this.ChangeMeasureFlag();var O=[],b=[],P=[],M=[];this.contourdiv.style.display="none";for(t=0;t<this.lineContoursInfo.Contours.length;++t)if("circle"==(n=this.lineContoursInfo.Contours[t]).lineInfo.type&&n.LineSegments[0].start.distanceTo(n.LineSegments[n.LineSegments.length-1].end)<.002){var F=new THREE.Vector3(n.lineInfo.center[0],n.lineInfo.center[1],n.lineInfo.center[2]),F=(F.applyMatrix4(n.lineInfo.matrixWorld),{radius:n.lineInfo.radius,pos:F.toArray()});M.push(F)}else{this.OpMeasure.rootObject.remove(n.lineobj),n.lineobj=null;for(o=0;o<n.LineSegments.length;++o){for(var T=n.LineSegments[o],x={},m=0;m<P.length;++m){var B=new THREE.Vector3;this.lineIntersection2D(T.start,T.end,P[m].start,P[m].end,B)&&((x[B.z]=B).z=m)}if(Object.keys(x).length<1)T.p1=b.length,b.push(T.start),T.p2=b.length,b.push(T.end),P.push(T);else{var y=[],H=(y.push(T.start),this);Object.keys(x).sort(function(e,t){return e-t}).forEach(function(e){var t,n,i,s;0!=x[e].s&&1!=x[e].s&&(t=P[x[e].z],(s=new THREE.Vector2).set(x[e].x,x[e].y),(i=new j).start.set(t.start.x,t.start.y),i.end.set(x[e].x,x[e].y),i.p1=t.p1,-1<(n=H.getIndexFromPoints(s,b))?i.p2=n:(i.p2=b.length,n=i.p2,b.push(s)),P.push(i),(i=new j).start.set(x[e].x,x[e].y),i.end.set(t.end.x,t.end.y),i.p1=n,i.p2=t.p2,P.push(i),P[x[e].z]=null),0!=e&&1!=e&&((s=new THREE.Vector2).set(x[e].x,x[e].y),y.push(s))}),y.push(T.end);for(m=0;m<y.length-1;++m){var C=new j,W=(C.start.set(y[m].x,y[m].y),C.end.set(y[m+1].x,y[m+1].y),this.getIndexFromPoints(y[m],b));-1<W?C.p1=W:(C.p1=b.length,b.push(y[m])),-1<(W=this.getIndexFromPoints(y[m+1],b))?C.p2=W:(C.p2=b.length,b.push(y[m+1])),P.push(C)}}for(m=0;m<P.length;++m)P[m]||(P.splice(m,1),--m)}}var k=new THREE.Box2(b[0],b[1]),Y=new NDSWebViewer.NDS.Triangulator.ContourSet(P,k);Y.sanitizeEdges(),Y.stitchContoursCheng();for(var N=0;N<Y.contours.length;N++){var L=Y.contours[N];if(L[0]==L[L.length-1]){for(var w=0,U=new THREE.Vector2,I=[],A=1;A<L.length;A++){var v=b[L[A-1]],z=b[L[A]];I[6*(A-1)+0]=v.x,I[6*(A-1)+1]=v.y,I[6*(A-1)+2]=0,I[6*(A-1)+3]=z.x,I[6*(A-1)+4]=z.y,I[6*(A-1)+5]=0,w+=(v.x*z.y-v.y*z.x)/2,U.add(v)}l=this.createContour(I);this.OpMeasure.rootObject.add(l),U.divideScalar(L.length-1),w=Math.abs(w),(D=document.createElement("div")).className="mearesult",this.viewer.container.appendChild(D);w=w*(R=this.viewer.getDispalyModelUnit(w)).scale*R.scale,E=(this.lineContoursInfo.unit=this.getUnitStringmap(R.unit),(w*Math.pow(this.viewer.measuringScale,2)).toFixed(2));E=NDSWebViewer.COMMON.translateString("MEASURE_AREA")+": "+E+this.lineContoursInfo.unit+"",(V={}).dimString=E,V.textPos=new THREE.Vector3(U.x,U.y,0),V.textBox=D,V.textBox.setAttribute("type","area"),V.textBox.setAttribute("dimString",w),V.textBox.setAttribute("unit",this.lineContoursInfo.unit+"");for(m=0;m<this.OpMeasure.boxInfos.length;m++)this.OpMeasure.boxInfos[m].textPos.distanceTo(V.textPos)<1e-4&&V.textBox.setAttribute("needDown","true");for(m=0;m<O.length;m++)O[m].textPos.distanceTo(V.textPos)<1e-4&&V.textBox.setAttribute("needDown","true");O.push(V)}}for(var D,N=0;N<M.length;++N){w=Math.pow(M[N].radius,2)*Math.PI,(D=document.createElement("div")).className="mearesult",this.viewer.container.appendChild(D);w=w*(R=this.viewer.getDispalyModelUnit(w)).scale*R.scale,this.lineContoursInfo.unit=this.getUnitStringmap(R.unit);var R,V,E=(w*Math.pow(this.viewer.measuringScale,2)).toFixed(2);E=NDSWebViewer.COMMON.translateString("MEASURE_AREA")+": "+E+this.lineContoursInfo.unit+"",(V={}).dimString=E,V.textPos=new THREE.Vector3(M[N].pos[0],M[N].pos[1],0),V.textBox=D,V.textBox.setAttribute("type","area"),V.textBox.setAttribute("dimString",w),V.textBox.setAttribute("unit",this.lineContoursInfo.unit+"");for(m=0;m<this.OpMeasure.boxInfos.length;m++)this.OpMeasure.boxInfos[m].textPos.distanceTo(V.textPos)<1e-4&&V.textBox.setAttribute("needDown","true");for(m=0;m<O.length;m++)O[m].textPos.distanceTo(V.textPos)<1e-4&&V.textBox.setAttribute("needDown","true");O.push(V)}if(0<O.length)this.OpMeasure.boxInfos=this.OpMeasure.boxInfos.concat(O);else{this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.NOCLOSE);for(t=0;t<this.lineContoursInfo.Contours.length;++t){n=this.lineContoursInfo.Contours[t];this.OpMeasure.rootObject.remove(n.lineobj)}}this.clearContoursInfo(!0),NDSWebViewer.SETTING.enableBroadcast&&NDSWebViewer.SETTING.broadcastMajor&&this.viewer.dispatchEvent({type:"broadcastEvent"})}NDSWebViewer.SETTING.enableBroadcast&&NDSWebViewer.SETTING.broadcastMajor&&this.OpMeasure.addmeasureTimes(),this.OpMeasure.measureEnd()},f.prototype.onNMouseMove=function(e,t){this.measureContour(e,t,!0)},f.prototype.onLMouseClick=function(e,t,n){this.measureContour(e,t,!1)},f.prototype.lineIntersection2D=function(e,t,n,i,s){var o;return e.distanceTo(n)<.002?(null!=s&&(s.x=e.x,s.y=e.y,s.z=0,s.s=0),!0):t.distanceTo(n)<.002?(null!=s&&(s.x=t.x,s.y=t.y,s.z=1,s.s=0),!0):e.distanceTo(i)<.002?(null!=s&&(s.x=e.x,s.y=e.y,s.z=0,s.s=1),!0):t.distanceTo(i)<.002?(null!=s&&(s.x=t.x,s.y=t.y,s.z=1,s.s=1),!0):!(Math.abs((t.x-e.x)*(i.y-n.y)-(t.y-e.y)*(i.x-n.x))<.002)&&(o=((e.y-n.y)*(i.x-n.x)-(e.x-n.x)*(i.y-n.y))/((t.x-e.x)*(i.y-n.y)-(t.y-e.y)*(i.x-n.x)),i=((e.y-n.y)*(t.x-e.x)-(e.x-n.x)*(t.y-e.y))/((t.x-e.x)*(i.y-n.y)-(t.y-e.y)*(i.x-n.x)),0<=o)&&o<=1&&0<=i&&i<=1&&(null!=s&&(s.x=e.x+o*(t.x-e.x),s.y=e.y+o*(t.y-e.y),s.z=o,s.s=i),!0)},f.prototype.getIndexFromPoints=function(e,t){for(var n=0;n<t.length;++n){var i=t[n];if(e.distanceTo(i)<.002)return n}return-1},f.prototype.measureContour=function(e,t,n){""==this.lineContoursInfo.unit&&(this.lineContoursInfo.unit=this.getUnitString());var i=this.viewer,s=this.doRaycasterPick(e,t,!0);if(s&&0!=s.length){s=s[0];if(s){s=this.getSelectInfoFromIntersect(s);if(s){if("line"==s.type&&!this.Bline(s))return void(this.lineContoursInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.lineContoursInfo.preSelLineObj),this.lineContoursInfo.preSelLineObj=null,this.lineContoursInfo.preSelLineInfo=null));this.isTwoTopolInfoTheSame(this.lineContoursInfo.preSelLineInfo,s)||(this.lineContoursInfo.preSelLineInfo=s,this.lineContoursInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.lineContoursInfo.preSelLineObj),this.lineContoursInfo.preSelLineObj=null),c=s.geometry,(R=s.indexRange.concat())[0]+=c.drawRange.start/2,R[1]+=c.drawRange.start/2,c.isBufferGeometry&&(h=c.index,f=c.attributes.position.array,null!=h)&&(I=h.array,b=R[0],P=R[1],this.lineContoursInfo.prestart.fromArray(f,3*I[2*b]),this.lineContoursInfo.preend.fromArray(f,3*I[2*P+1])),n&&(d=this.createLine(this.lineContoursInfo.preSelLineInfo,!0))&&(this.OpMeasure.rootObject.add(d),this.lineContoursInfo.preSelLineObj=d))}}if(this.lineContoursInfo.preSelLineInfo&&n){for(var o=0;o<this.lineContoursInfo.Contours.length;++o){var r=this.lineContoursInfo.Contours[o];if(this.isTwoTopolInfoTheSame(this.lineContoursInfo.preSelLineInfo,r.lineInfo)&&"contourarea"===this.measureType)return void this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.CANCELLINE)}if("contour"===this.measureType&&0<this.lineContoursInfo.Contours.length){r=this.lineContoursInfo.Contours[this.lineContoursInfo.Contours.length-1];if(this.isTwoTopolInfoTheSame(this.lineContoursInfo.preSelLineInfo,r.lineInfo))return void this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.CANCELLINE)}}if(this.lineContoursInfo.preSelLineInfo&&!n){this.lineContoursInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.lineContoursInfo.preSelLineObj),this.lineContoursInfo.preSelLineObj=null);var s=this.lineContoursInfo.Contours.length-1,a=null;if("contour"===this.measureType&&0<=s){r=this.lineContoursInfo.Contours[s];if(this.isTwoTopolInfoTheSame(this.lineContoursInfo.preSelLineInfo,r.lineInfo)){if(a=this.lineContoursInfo.Contours.pop(),0<s)if(this.lineContoursInfo.divPos=this.lineContoursInfo.Contours[s-1].textPos,a.start.equals(this.lineContoursInfo.start))for(var l=0;l<this.lineContoursInfo.Contours.length;++l)(r=this.lineContoursInfo.Contours[l]).start.equals(a.end)&&this.lineContoursInfo.start.copy(r.start);else for(l=0;l<this.lineContoursInfo.Contours.length;++l)(r=this.lineContoursInfo.Contours[l]).end.equals(a.start)&&this.lineContoursInfo.end.copy(r.end);return 0==this.lineContoursInfo.Contours.length?(this.contourdiv.style.display="none",this.lineContoursInfo.preSelLineInfo=null,this.lineContoursInfo.preSelLineObj=null,this.lineContoursInfo.prestart=new THREE.Vector2,this.lineContoursInfo.preend=new THREE.Vector2,this.lineContoursInfo.divPos=null,this.lineContoursInfo.start=new THREE.Vector2,this.lineContoursInfo.end=new THREE.Vector2):1==this.lineContoursInfo.Contours.length&&(this.lineContoursInfo.start.copy(this.lineContoursInfo.Contours[0].start),this.lineContoursInfo.end.copy(this.lineContoursInfo.Contours[0].end)),this.OpMeasure.rootObject.remove(a.lineobj),void(this.lineContoursInfo.preSelLineInfo=null)}}for(o=0;o<this.lineContoursInfo.Contours.length;++o){r=this.lineContoursInfo.Contours[o];if(this.isTwoTopolInfoTheSame(this.lineContoursInfo.preSelLineInfo,r.lineInfo)){if("contourarea"===this.measureType)return a=this.lineContoursInfo.Contours.splice(o,1)[0],this.OpMeasure.rootObject.remove(a.lineobj),void(this.lineContoursInfo.preSelLineInfo=null);if("contour"===this.measureType)return void(this.lineContoursInfo.preSelLineInfo=null)}}n=this.viewer.renderer.getPixelRatio();NDSWebViewer.COMMON.isMobileDevice()?(this.contourdiv.children[0].className="arrow-prev",this.contourdiv.children[1].className="continuityLength-btn"):(this.contourdiv.style.left=Math.round(e/n)+"px",this.contourdiv.style.top=Math.round(t/n)+"px"),this.contourdiv.style.display="inline";var s=(i=this.viewer).renderer.domElement,j=new THREE.Raycaster,i=(i.camera.setCastRay(j,e*n/s.width*2-1,2*-(t*n/s.height)+1),new THREE.Plane(new THREE.Vector3(0,0,-1),0)),e=new THREE.Vector3;if(j.ray.intersectPlane(i,e),"contourarea"===this.measureType){e&&(this.lineContoursInfo.divPos=e);var d=this.createLine(this.lineContoursInfo.preSelLineInfo,!1);this.OpMeasure.rootObject.add(d);(M=new _).dimString=this.lineContoursInfo.preSelLineInfo.length,M.lineobj=d,M.lineInfo=this.lineContoursInfo.preSelLineInfo;var c=M.lineInfo.geometry;if((R=M.lineInfo.indexRange.concat())[0]+=c.drawRange.start/2,R[1]+=c.drawRange.start/2,c.isBufferGeometry){var h=c.index,f=c.attributes.position.array;if(null!=h)for(var I=h.array,u=0,p=b=R[0],S=P=R[1];p<=S;p++,u+=1){var g=I[2*p],E=I[2*p+1],m=new THREE.Vector3,O=new THREE.Vector3;m.fromArray(f,3*g),O.fromArray(f,3*E),m.applyMatrix4(M.lineInfo.matrixWorld),O.applyMatrix4(M.lineInfo.matrixWorld),(V=new U).start.set(m.x,m.y),V.end.set(O.x,O.y),M.LineSegments.push(V),O=m=null}}M.start.set(this.edgeInfo.startPos.x,this.edgeInfo.startPos.y),M.end.set(this.edgeInfo.endPos.x,this.edgeInfo.endPos.y),M.textPos=new THREE.Vector3((M.start.x+M.end.x)/2,(M.start.y+M.end.y)/2,0),this.lineContoursInfo.Contours.push(M),this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.CIRCLEANDLINE)}else if("contour"===this.measureType)if(0==this.lineContoursInfo.Contours.length){e&&(this.lineContoursInfo.divPos=e);d=this.createLine(this.lineContoursInfo.preSelLineInfo,!1);this.OpMeasure.rootObject.add(d),(M=new _).dimString=this.lineContoursInfo.preSelLineInfo.length,M.lineobj=d,M.lineInfo=this.lineContoursInfo.preSelLineInfo;c=((D=document.createElement("div")).className="mearesult",this.viewer.container.appendChild(D),M.textBox=D,M.lineInfo.geometry);if((R=M.lineInfo.indexRange.concat())[0]+=c.drawRange.start/2,R[1]+=c.drawRange.start/2,c.isBufferGeometry){h=c.index,f=c.attributes.position.array;if(null!=h)for(I=h.array,u=0,p=b=R[0],S=P=R[1];p<=S;p++,u+=1){g=I[2*p],E=I[2*p+1],m=new THREE.Vector3,O=new THREE.Vector3;m.fromArray(f,3*g),O.fromArray(f,3*E),m.x==O.x&&m.y==O.y?(u--,O=m=null):(m.applyMatrix4(M.lineInfo.matrixWorld),O.applyMatrix4(M.lineInfo.matrixWorld),C=M.lineInfo.intersect.clone().sub(m).normalize(),B=O.clone().sub(m).normalize(),C.distanceTo(B)<1e-6&&null==M.intersectMouse&&0<=(x=new THREE.Line3(m,O).closestPointToPointParameter(M.lineInfo.intersect,!1))&&x<=1&&((L=new z).edgeIndex=u,L.Pos=x,M.intersectMouse=L),(V=new U).start.set(m.x,m.y),V.end.set(O.x,O.y),M.LineSegments.push(V),O=m=null)}}M.start.set(this.edgeInfo.startPos.x,this.edgeInfo.startPos.y),M.end.set(this.edgeInfo.endPos.x,this.edgeInfo.endPos.y),M.textPos=new THREE.Vector3((M.start.x+M.end.x)/2,(M.start.y+M.end.y)/2,0),this.lineContoursInfo.Contours.push(M),this.lineContoursInfo.start.copy(M.start),this.lineContoursInfo.end.copy(M.end),this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.CIRCLEANDLINE)}else{var c=this.lineContoursInfo.preSelLineInfo.geometry,F=((R=this.lineContoursInfo.preSelLineInfo.indexRange.concat())[0]+=c.drawRange.start/2,R[1]+=c.drawRange.start/2,!1);if(c.isBufferGeometry){h=c.index,f=c.attributes.position.array;if(null!=h){for(var I=h.array,u=0,b=R[0],P=R[1],M=new _,T=null,p=b,S=P;p<=S;p++,u+=1){g=I[2*p],E=I[2*p+1],m=new THREE.Vector3,O=new THREE.Vector3;if(m.fromArray(f,3*g),O.fromArray(f,3*E),m.x==O.x&&m.y==O.y)u--;else{m.applyMatrix4(this.lineContoursInfo.preSelLineInfo.matrixWorld),O.applyMatrix4(this.lineContoursInfo.preSelLineInfo.matrixWorld);var x,y,C=this.lineContoursInfo.preSelLineInfo.intersect.clone().sub(m).normalize(),B=O.clone().sub(m).normalize();C.distanceTo(B)<1e-6&&null==T&&0<=(x=new THREE.Line3(m,O).closestPointToPointParameter(this.lineContoursInfo.preSelLineInfo.intersect,!1))&&x<=1&&((y=new z).edgeIndex=u,y.Pos=x,T=y);for(var H=0;H<this.lineContoursInfo.Contours.length;++H)for(var N=this.lineContoursInfo.Contours[H],l=0;l<N.LineSegments.length;++l){var a=N.LineSegments[l],W=new THREE.Vector2(m.x,m.y),k=new THREE.Vector2(O.x,O.y),Y=new THREE.Vector3;if(this.lineIntersection2D(W,k,a.start,a.end,Y)){(L=new z).edgeIndex=u,L.Pos=Y.z;for(var L,w=!1,A=0;A<M.intersectPos.length;++A){if(M.intersectPos[A].edgeIndex>L.edgeIndex){M.intersectPos.splice(A,0,L),w=!0;break}if(M.intersectPos[A].edgeIndex==L.edgeIndex&&M.intersectPos[A].Pos>L.Pos){M.intersectPos.splice(A,0,L),w=!0;break}}w||M.intersectPos.push(L);var v=new z;v.edgeIndex=l,v.Pos=Y.s;for(w=!1,A=0;A<N.intersectPos.length;++A){if(N.intersectPos[A].edgeIndex>v.edgeIndex){N.intersectPos.splice(A,0,v),w=!0;break}if(N.intersectPos[A].edgeIndex==v.edgeIndex&&N.intersectPos[A].Pos>v.Pos){N.intersectPos.splice(A,0,v),w=!0;break}}w||N.intersectPos.push(v),F=!0}}}O=m=null}if(F){e&&(this.lineContoursInfo.divPos=e);d=this.createLine(this.lineContoursInfo.preSelLineInfo,!1);this.OpMeasure.rootObject.add(d),M.intersectMouse=T,M.dimString=this.lineContoursInfo.preSelLineInfo.length,M.lineobj=d,M.lineInfo=this.lineContoursInfo.preSelLineInfo;(D=document.createElement("div")).className="mearesult",this.viewer.container.appendChild(D),M.textBox=D;var D,R,c=M.lineInfo.geometry;if((R=M.lineInfo.indexRange.concat())[0]+=c.drawRange.start/2,R[1]+=c.drawRange.start/2,c.isBufferGeometry){h=c.index,f=c.attributes.position.array;if(null!=h)for(I=h.array,u=0,p=b=R[0],S=P=R[1];p<=S;p++,u+=1){var V,g=I[2*p],E=I[2*p+1],m=new THREE.Vector3,O=new THREE.Vector3;m.fromArray(f,3*g),O.fromArray(f,3*E),m.x==O.x&&m.y==O.y?(u--,O=m=null):(m.applyMatrix4(M.lineInfo.matrixWorld),O.applyMatrix4(M.lineInfo.matrixWorld),(V=new U).start.set(m.x,m.y),V.end.set(O.x,O.y),M.LineSegments.push(V),O=m=null)}}M.start.set(this.edgeInfo.startPos.x,this.edgeInfo.startPos.y),M.end.set(this.edgeInfo.endPos.x,this.edgeInfo.endPos.y),M.textPos=new THREE.Vector3((M.start.x+M.end.x)/2,(M.start.y+M.end.y)/2,0),this.lineContoursInfo.Contours.push(M),this.lineContoursInfo.start.copy(M.start),this.lineContoursInfo.end.copy(M.end),this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.CIRCLEANDLINE)}else this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.NOCONJOINT)}}}this.lineContoursInfo.preSelLineInfo=null}}else this.lineContoursInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.lineContoursInfo.preSelLineObj),this.lineContoursInfo.preSelLineObj=null,this.lineContoursInfo.preSelLineInfo=null),this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.CIRCLEANDLINE)},(I.prototype=Object.create(i.prototype)).OperatorClear=function(e){this.allowType=[],this.selectProjectPlane=!1,this.matrxTrans=null,this.sectionCross=null,this.projectDirectionXorY=null,this.isBoxMoving=!1},I.prototype.OperatorStart=function(e){this.measureType=e,this.allowType=this.MeasurePostInfo(e,!0,!0),this.selectProjectPlane=!1,this.distanceInfo.projectPlane=null,this.matrxTrans=null,this.sectionCross=null,this.projectDirectionXorY=null,this.isBoxMoving=!1},I.prototype.MeasurePostInfo=function(e,t,n){let i=[];switch(e){case"LmPt2Pt":this.OpMeasure.PostInfo(t?NDSWebViewer.NDS.INFOTYPE.CLICKFIRSTPOINT:NDSWebViewer.NDS.INFOTYPE.CLICKSECONDPOINT),n&&(i=["point"]);break;case"LmPt2Line":this.OpMeasure.PostInfo(t?NDSWebViewer.NDS.INFOTYPE.POINT:NDSWebViewer.NDS.INFOTYPE.LINE),n&&(i=t?["point"]:["line"]);break;case"LmLine2Line":this.OpMeasure.PostInfo(t?NDSWebViewer.NDS.INFOTYPE.FIRSTLINE:NDSWebViewer.NDS.INFOTYPE.SECONDLINE),n&&(i=["line"]);break;case"LmHole2Hole":t&&this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.CIRCLEBEGIN),n&&(this.distanceInfo.firstSelInfo||this.distanceInfo.secondSelInfo?"circle"==this.distanceInfo.firstSelInfo.type?(i=["circle"],this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.CIRCLECENTER)):"cylinder"!=this.distanceInfo.firstSelInfo.type&&"cone"!=this.distanceInfo.firstSelInfo.type||(i=["cylinder","cone"],this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.CIRCLECYLINDER)):i=["circle","cylinder","cone"]);break;case"LmAxis2Pt":this.OpMeasure.PostInfo(t?NDSWebViewer.NDS.INFOTYPE.POINT:NDSWebViewer.NDS.INFOTYPE.AXIS),n&&(i=t?["point"]:["circle","cone","cylinder"]);break;case"LmAxis2Line":this.OpMeasure.PostInfo(t?NDSWebViewer.NDS.INFOTYPE.AXIS:NDSWebViewer.NDS.INFOTYPE.LINE),n&&(i=t?["circle","cone","cylinder"]:["line"])}return i},I.prototype.onNMouseMove=function(e,t){var n,i,s,o,r,a=new THREE.Vector3(e,t,0);this.OpMeasure.unsteady?this.changeMeasureDistance(a):this.distanceInfo.firstSelObj&&this.distanceInfo.secondSelObj||this.selectProjectPlane?null==this.distanceInfo.projectPlane?this.selectProjectPlane&&(this.LineargaugeMeasure(e,t,!0,["plane"]),this.updateLineargaugeMeasure(!0,!0)):NDSWebViewer.COMMON.isMobileDevice()||(this.distanceInfo.projectFstPos&&this.distanceInfo.projectSecPos||(this.distanceInfo.projectFstPos=new THREE.Vector3,this.distanceInfo.projectSecPos=new THREE.Vector3,this.distanceInfo.projectPlane.projectPoint(this.distanceInfo.firstPoint,this.distanceInfo.projectFstPos),this.distanceInfo.projectPlane.projectPoint(this.distanceInfo.secondPoint,this.distanceInfo.projectSecPos),this.distanceInfo.projectFstClnd&&this.OpMeasure.rootObject.remove(this.distanceInfo.projectFstClnd),this.distanceInfo.projectFstClnd=this.createPointMesh(this.distanceInfo.projectFstPos,this.materialProjectPoint,this.POINTSIZE),this.OpMeasure.rootObject.add(this.distanceInfo.projectFstClnd),this.distanceInfo.projectSecClnd&&this.OpMeasure.rootObject.remove(this.distanceInfo.projectSecClnd),this.distanceInfo.projectSecClnd=this.createPointMesh(this.distanceInfo.projectSecPos,this.materialProjectPoint,this.POINTSIZE),this.OpMeasure.rootObject.add(this.distanceInfo.projectSecClnd)),this.matrxTrans||this.lineargaugeRotateOnly(this.distanceInfo.projectPlane),n=this.distanceInfo.projectFstPos.clone(),i=this.distanceInfo.projectSecPos.clone(),this.lineargaugeModelCoord2PlaneCoord(n),this.lineargaugeModelCoord2PlaneCoord(i),a&&(s=this.distanceInfo.projectPlane,s=this.clientCoordToModelCoordOnPlane(a.x,a.y,s),this.lineargaugeModelCoord2PlaneCoord(s),s)&&(this.distanceInfo.mousePos||(this.distanceInfo.mousePos=s.clone()),r=o=!1,(o=this.distanceInfo.mousePos.y<Math.max(n.y,i.y)+0&&this.distanceInfo.mousePos.y>+Math.min(n.y,i.y)&&this.distanceInfo.mousePos.x<Math.max(n.x,i.x)+0&&this.distanceInfo.mousePos.x>+Math.min(n.x,i.x)?!0:o)!=(r=s.y<Math.max(n.y,i.y)+0&&s.y>+Math.min(n.y,i.y)&&s.x<Math.max(n.x,i.x)+0&&s.x>+Math.min(n.x,i.x)?!0:r)&&(n.y<Math.max(this.distanceInfo.mousePos.y,s.y)&&n.y>Math.min(this.distanceInfo.mousePos.y,s.y)||i.y<Math.max(this.distanceInfo.mousePos.y,s.y)&&i.y>Math.min(this.distanceInfo.mousePos.y,s.y)?this.distanceInfo.XorY=0:(n.x<Math.max(this.distanceInfo.mousePos.x,s.x)&&n.x>Math.min(this.distanceInfo.mousePos.x,s.x)||i.x<Math.max(this.distanceInfo.mousePos.x,s.x)&&i.x>Math.min(this.distanceInfo.mousePos.x,s.x))&&(this.distanceInfo.XorY=1)),this.distanceInfo.mousePos.set(s.x,s.y,0)),this.ShowLineargaugeDimension(a,!1,this.distanceInfo.XorY)):(this.LineargaugeMeasure(e,t,!0,this.allowType),this.updateLineargaugeMeasure(!0,!1))},I.prototype.onLMouseClick=function(e,t,n){var i=new THREE.Vector3(e,t,0);this.distanceInfo.firstSelObj&&this.distanceInfo.secondSelObj||this.selectProjectPlane?null==this.distanceInfo.projectPlane?this.selectProjectPlane&&(this.LineargaugeMeasure(e,t,!1,["plane"]),this.updateLineargaugeMeasure(!1,!0),this.distanceInfo.projectPlane)&&this.LineargaugePostNotify():(this.matrxTrans||this.lineargaugeRotateOnly(this.distanceInfo.projectPlane),NDSWebViewer.COMMON.isMobileDevice()||(this.ShowLineargaugeDimension(i,!0,this.distanceInfo.XorY),this.allowType=this.MeasurePostInfo(this.measureType,!0,!0),this.OpMeasure.measureEnd())):(this.LineargaugeMeasure(e,t,!1,this.allowType),this.updateLineargaugeMeasure(!1,!1))},I.prototype.LineargaugeMeasure=function(t,e,n,i){let s=null;if(s=this.doRaycasterPick(t,e,!0),-1!=i.indexOf("circle")&&(n||"LmHole2Hole"==this.measureType)&&((o=this.doCircleCentersRayPick(t,e))&&(s=s&&0!=s.length&&o[0].distance>s[0].distance?s:o),o=this.previewSnappedPoint3(s,!1,t,e))&&(s=o),-1!=i.indexOf("point")&&n&&((o=this.doCircleCentersRayPick(t,e))&&(s=s&&0!=s.length&&o[0].distance>s[0].distance?s:o),this.previewSnappedPoint3(s,!0,t,e)),n)-1!=i.indexOf("point")&&null!=this.snappedPoint?this.LineargaugeClearPreSelect():(o=s[0])&&(t=this.getSelectInfoFromIntersect(o))&&(-1==i.indexOf(t.type)||"line"==t.type&&!this.Bline(t)?this.LineargaugeClearPreSelect():null!=this.distanceInfo.preSelInfo&&this.isTwoTopolInfoTheSame(this.distanceInfo.preSelInfo,t)||(this.LineargaugeClearPreSelect(),this.distanceInfo.preSelInfo=t));else if(null!=this.snappedPoint&&-1!=i.indexOf("point"))null==this.distanceInfo.firstSelInfo?(this.distanceInfo.firstPoint=this.snappedPoint.clone(),this.distanceInfo.firstSelInfo={type:"point",point:this.snappedPoint},this.LineargaugePostNotify()):"point"==this.distanceInfo.firstSelInfo.type&&this.distanceInfo.firstSelObj&&this.isTwoPointTheSame(this.distanceInfo.firstSelInfo.point,this.snappedPoint)?(this.LineargaugeClearFirstSelect(),this.LineargaugePostNotify()):(this.distanceInfo.secondPoint=this.snappedPoint.clone(),this.distanceInfo.secondSelInfo={type:"point",point:this.snappedPoint},this.LineargaugePostSelectPorjectPlane()),this.snappedPoint=null,this.distanceInfo.snapPreSelInfo=null;else{this.distanceInfo.snapPreSelInfo=null;e=s[0];if(e){n=this.getSelectInfoFromIntersect(e);if(n){if(-1!=i.indexOf("line")&&"line"==n.type&&!this.Bline(n))return void this.LineargaugeClearPreSelect();if(-1==i.indexOf(n.type)&&-1!=i.indexOf("point")){var o=n.intersect.clone();null==this.distanceInfo.firstSelInfo?(this.distanceInfo.firstPoint=o,this.distanceInfo.firstSelInfo={type:"point",point:o},this.LineargaugePostNotify()):(this.distanceInfo.secondSelInfo={type:"point",point:o},this.distanceInfo.secondPoint=o,this.LineargaugePostSelectPorjectPlane())}else if(-1!=i.indexOf(n.type)){if("plane"==n.type&&this.selectProjectPlane&&null==this.distanceInfo.projectPlane)return t=(new THREE.Plane).setFromNormalAndCoplanarPoint(n.worldNormal,n.worldOrigin),this.distanceInfo.projectPlaneInfo=n,this.LineargaugePostSelectPorjectPlane(t),void this.LineargaugeClearPreSelect();if(null==this.distanceInfo.firstSelInfo)this.distanceInfo.firstSelInfo=n,this.LineargaugePostNotify();else if(this.distanceInfo.firstSelInfo)if(this.isTwoTopolInfoTheSame(this.distanceInfo.firstSelInfo,n))this.LineargaugeClearFirstSelect(),this.LineargaugePostNotify();else{if(this.distanceInfo.firstSelInfo&&"circle"==this.distanceInfo.firstSelInfo.type&&"circle"==n.type){o=this.distanceInfo.firstSelInfo.center,t=n.center,o=new THREE.Vector3(o[0],o[1],o[2]).applyMatrix4(this.distanceInfo.firstSelInfo.matrixWorld),t=new THREE.Vector3(t[0],t[1],t[2]).applyMatrix4(n.matrixWorld);if(o.distanceTo(t)<1e-4)return}let e=null;var r,a,l,d,c,o=this.distanceInfo.firstSelInfo;"point"==o.type&&"line"==n.type?(t=this.getLineStartEndPoints(n))&&(c=new THREE.Line3(t.start,t.end).closestPointToPoint(this.distanceInfo.firstPoint,!1),this.distanceInfo.secondPoint=c,this.distanceInfo.secondSelInfo=n,t=(new THREE.Vector3).subVectors(t.start,t.end),e=(new THREE.Plane).setFromNormalAndCoplanarPoint(t,c).normalize()):"line"==o.type&&"line"==n.type?(t=this.getLineStartEndPoints(o),c=this.getLineStartEndPoints(n),t&&c&&((a=(new THREE.Vector3).subVectors(t.end,t.start)).normalize(),(r=(new THREE.Vector3).subVectors(c.end,c.start)).normalize(),l=a.dot(r),d=new THREE.Line3(t.start,t.end).closestPointToPoint(c.start,!1),1-Math.abs(l)<1e-7?(this.distanceInfo.secondSelInfo=n,this.distanceInfo.firstPoint=d,this.distanceInfo.secondPoint=c.start.clone(),e=(new THREE.Plane).setFromNormalAndCoplanarPoint(r,this.distanceInfo.secondPoint).normalize()):this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.LINENOPARALLEL))):"circle"!=o.type&&"cylinder"!=o.type||"circle"!=n.type&&"cylinder"!=n.type?"point"!=o.type||"circle"!=n.type&&"cylinder"!=n.type&&"cone"!=n.type?"circle"!=o.type&&"cylinder"!=o.type&&"cone"!=o.type||"line"!=n.type||(t=this.getLineStartEndPoints(o),c=this.getLineStartEndPoints(n),t&&c&&((a=(new THREE.Vector3).subVectors(t.end,t.start)).normalize(),(r=(new THREE.Vector3).subVectors(c.end,c.start)).normalize(),l=a.dot(r),d=new THREE.Line3(t.start,t.end).closestPointToPoint(c.start,!1),1-Math.abs(l)<1e-7?(this.distanceInfo.secondSelInfo=n,this.distanceInfo.firstPoint=d,this.distanceInfo.secondPoint=c.start.clone(),e=(new THREE.Plane).setFromNormalAndCoplanarPoint(r,this.distanceInfo.secondPoint).normalize()):this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.AXISNOPARALLELLINE))):(a=this.getLineStartEndPoints(n))&&(t=new THREE.Line3(a.start,a.end).closestPointToPoint(this.distanceInfo.firstPoint,!1),this.distanceInfo.secondPoint=t.clone(),this.distanceInfo.secondSelInfo=n,l=(new THREE.Vector3).subVectors(a.start,a.end),e=(new THREE.Plane).setFromNormalAndCoplanarPoint(l,t).normalize()):(d=this.getLineStartEndPoints(o),this.distanceInfo.firstPoint=d.start,c=this.getLineStartEndPoints(n),this.distanceInfo.secondPoint=c.start.clone(),this.distanceInfo.secondSelInfo=n,this.LineargaugePostSelectPorjectPlane()),e&&this.LineargaugePostSelectPorjectPlane(e)}}}else-1!=i.indexOf("point")&&(r=e.point,null==this.distanceInfo.firstSelInfo?(this.distanceInfo.firstPoint=r,this.distanceInfo.firstSelInfo={type:"point",point:r},this.LineargaugePostNotify()):(this.distanceInfo.secondSelInfo={type:"point",point:r},this.distanceInfo.secondPoint=r,this.LineargaugePostSelectPorjectPlane()))}this.LineargaugeClearPreSelect()}},I.prototype.updateLineargaugeMeasure=function(e,t){var n;this.distanceInfo.firstSelObj&&this.distanceInfo.secondSelObj&&!t?this.LineargaugeClearPreSelect():e?this.distanceInfo.preSelInfo&&!this.distanceInfo.preSelObj&&("line"==this.distanceInfo.preSelInfo.type||"circle"==this.distanceInfo.preSelInfo.type?(n=this.createLine(this.distanceInfo.preSelInfo,!(n=null)))&&(this.OpMeasure.rootObject.add(n),this.distanceInfo.preSelObj=n):"plane"!=this.distanceInfo.preSelInfo.type&&"cylinder"!=this.distanceInfo.preSelInfo.type&&"cone"!=this.distanceInfo.preSelInfo.type||(n=this.createFace(this.distanceInfo.preSelInfo,!0))&&(this.OpMeasure.rootObject.add(n),this.distanceInfo.preSelObj=n)):(this.distanceInfo.firstSelInfo&&!this.distanceInfo.firstSelObj&&(this.LineargaugeClearPreSelect(),n=null,"point"==this.distanceInfo.firstSelInfo.type?n=this.createPointMesh(this.distanceInfo.firstSelInfo.point,this.materialPoint,this.POINTSIZE):"line"==this.distanceInfo.firstSelInfo.type||"circle"==this.distanceInfo.firstSelInfo.type?n=this.createLine(this.distanceInfo.firstSelInfo,!1):"plane"!=this.distanceInfo.firstSelInfo.type&&"cylinder"!=this.distanceInfo.firstSelInfo.type&&"cone"!=this.distanceInfo.firstSelInfo.type||(n=this.createFace(this.distanceInfo.firstSelInfo,!1),"cylinder"!=this.distanceInfo.firstSelInfo.type&&"cone"!=this.distanceInfo.firstSelInfo.type)||(this.distanceInfo.axisLineObj=this.createAxisLine(this.distanceInfo.firstSelInfo),this.OpMeasure.rootObject.add(this.distanceInfo.axisLineObj)),n)&&(this.OpMeasure.rootObject.add(n),this.distanceInfo.firstSelObj=n),this.distanceInfo.secondSelInfo&&!this.distanceInfo.secondSelObj&&(this.LineargaugeClearPreSelect(),n=null,"point"==this.distanceInfo.secondSelInfo.type?n=this.createPointMesh(this.distanceInfo.secondSelInfo.point,this.materialPoint,this.POINTSIZE):"line"==this.distanceInfo.secondSelInfo.type||"circle"==this.distanceInfo.secondSelInfo.type?n=this.createLine(this.distanceInfo.secondSelInfo,!1):"plane"!=this.distanceInfo.secondSelInfo.type&&"cylinder"!=this.distanceInfo.secondSelInfo.type&&"cone"!=this.distanceInfo.secondSelInfo.type||(n=this.createFace(this.distanceInfo.secondSelInfo,!1),"cylinder"!=this.distanceInfo.secondSelInfo.type&&"cone"!=this.distanceInfo.secondSelInfo.type)||(this.distanceInfo.secaxisLineObj=this.createAxisLine(this.distanceInfo.secondSelInfo),this.OpMeasure.rootObject.add(this.distanceInfo.secaxisLineObj)),n)&&(this.OpMeasure.rootObject.add(n),this.distanceInfo.secondSelObj=n),this.distanceInfo.projectPlaneInfo&&!this.distanceInfo.projectPlaneObj&&(this.LineargaugeClearPreSelect(),n=null,(n="plane"==this.distanceInfo.projectPlaneInfo.type?this.createFace(this.distanceInfo.projectPlaneInfo,!1):n)&&(this.OpMeasure.rootObject.add(n),this.distanceInfo.projectPlaneObj=n),this.lineargaugeRotateOnly(this.distanceInfo.projectPlane)),this.distanceInfo.firstSelObj&&this.distanceInfo.secondSelObj&&this.distanceInfo.projectPlane&&(this.LineargaugeClearPreSelect(),this.matrxTrans||this.lineargaugeRotateOnly(this.distanceInfo.projectPlane),NDSWebViewer.COMMON.isMobileDevice()?null!=this.projectDirectionXorY?(this.ShowLineargaugeDimension(null,!0,this.projectDirectionXorY),this.LineargaugePostNotify()):this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.SELECTPLACELINELOCATION):(this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.PLACELINELOCATION),this.ShowLineargaugeDimension())))},I.prototype.ShowLineargaugeDimension=function(e,t,n,i){if(this.distanceInfo.firstSelObj&&this.distanceInfo.secondSelObj){this.distanceInfo.projectFstPos&&this.distanceInfo.projectSecPos||(this.distanceInfo.projectFstPos=new THREE.Vector3,this.distanceInfo.projectSecPos=new THREE.Vector3,this.distanceInfo.projectPlane.projectPoint(this.distanceInfo.firstPoint,this.distanceInfo.projectFstPos),this.distanceInfo.projectPlane.projectPoint(this.distanceInfo.secondPoint,this.distanceInfo.projectSecPos),this.distanceInfo.projectFstClnd&&this.OpMeasure.rootObject.remove(this.distanceInfo.projectFstClnd),this.distanceInfo.projectFstClnd=this.createPointMesh(this.distanceInfo.projectFstPos,this.materialProjectPoint,this.POINTSIZE),this.OpMeasure.rootObject.add(this.distanceInfo.projectFstClnd),this.distanceInfo.projectSecClnd&&this.OpMeasure.rootObject.remove(this.distanceInfo.projectSecClnd),this.distanceInfo.projectSecClnd=this.createPointMesh(this.distanceInfo.projectSecPos,this.materialProjectPoint,this.POINTSIZE),this.OpMeasure.rootObject.add(this.distanceInfo.projectSecClnd)),null==n&&(n=0),i||(this.distanceInfo.fstClndPos?this.distanceInfo.fstClndPos.set(this.distanceInfo.projectFstPos.x,this.distanceInfo.projectFstPos.y,this.distanceInfo.projectFstPos.z):this.distanceInfo.fstClndPos=this.distanceInfo.projectFstPos.clone(),this.distanceInfo.sndClndPos?this.distanceInfo.sndClndPos.set(this.distanceInfo.projectSecPos.x,this.distanceInfo.projectSecPos.y,this.distanceInfo.projectSecPos.z):this.distanceInfo.sndClndPos=this.distanceInfo.projectSecPos.clone()),this.lineargaugeModelCoord2PlaneCoord(this.distanceInfo.fstClndPos),this.lineargaugeModelCoord2PlaneCoord(this.distanceInfo.sndClndPos),e?(i=this.distanceInfo.projectPlane,e=this.clientCoordToModelCoordOnPlane(e.x,e.y,i),this.lineargaugeModelCoord2PlaneCoord(e),e&&0==n?(this.distanceInfo.fstClndPos.y=e.y,this.distanceInfo.sndClndPos.y=e.y,this.distanceInfo.fstClndPos.z=0,this.distanceInfo.sndClndPos.z=0):e&&1==n&&(this.distanceInfo.fstClndPos.x=e.x,this.distanceInfo.sndClndPos.x=e.x,this.distanceInfo.fstClndPos.z=0,this.distanceInfo.sndClndPos.z=0)):0==n?(i=(this.distanceInfo.fstClndPos.y+this.distanceInfo.sndClndPos.y)/2,this.distanceInfo.fstClndPos.y=i,this.distanceInfo.sndClndPos.y=i,this.distanceInfo.fstClndPos.z=0,this.distanceInfo.sndClndPos.z=0):1==n&&(e=(this.distanceInfo.fstClndPos.x+this.distanceInfo.sndClndPos.x)/2,this.distanceInfo.fstClndPos.x=e,this.distanceInfo.sndClndPos.x=e,this.distanceInfo.fstClndPos.z=0,this.distanceInfo.sndClndPos.z=0);var i=this.distanceInfo.fstClndPos.clone(),e=this.distanceInfo.sndClndPos.clone(),s=(i.distanceTo(e)<1e-6&&(0==n?(i.x+=.5,e.x-=.5):(i.y+=.5,e.y-=.5)),this.lineargaugePlaneCoord2ModelCoord(this.distanceInfo.fstClndPos),this.lineargaugePlaneCoord2ModelCoord(this.distanceInfo.sndClndPos),this.lineargaugePlaneCoord2ModelCoord(i),this.lineargaugePlaneCoord2ModelCoord(e),this.distanceInfo.textPos?(this.distanceInfo.textPos.x=(this.distanceInfo.fstClndPos.x+this.distanceInfo.sndClndPos.x)/2,this.distanceInfo.textPos.y=(this.distanceInfo.fstClndPos.y+this.distanceInfo.sndClndPos.y)/2,this.distanceInfo.textPos.z=(this.distanceInfo.fstClndPos.z+this.distanceInfo.sndClndPos.z)/2):this.distanceInfo.textPos=new THREE.Vector3((this.distanceInfo.fstClndPos.x+this.distanceInfo.sndClndPos.x)/2,(this.distanceInfo.fstClndPos.y+this.distanceInfo.sndClndPos.y)/2,(this.distanceInfo.fstClndPos.z+this.distanceInfo.sndClndPos.z)/2),(new THREE.Vector3).subVectors(e,i)),o=(s.normalize(),this.distanceInfo.fstClnd&&this.OpMeasure.rootObject.remove(this.distanceInfo.fstClnd),this.distanceInfo.fstClnd=this.createCylinderMesh(e,this.distanceInfo.fstClndPos,this.appmaterialLine),this.OpMeasure.getScale(this.distanceInfo.fstClnd,this.CYLINDERWIDTH)),s=(s.multiplyScalar(.5*this.distanceInfo.fstClnd.geometry.parameters.height),this.distanceInfo.fstClnd.oldPosition=this.distanceInfo.fstClndPos.clone(),this.distanceInfo.fstClnd.offsetPos=s.clone(),this.distanceInfo.fstClnd.position.addVectors(this.distanceInfo.fstClndPos,s.clone().multiplyScalar(o)),this.distanceInfo.fstClnd.updateMatrixWorld(),this.OpMeasure.rootObject.add(this.distanceInfo.fstClnd),this.distanceInfo.sndClnd&&this.OpMeasure.rootObject.remove(this.distanceInfo.sndClnd),this.distanceInfo.sndClnd=this.createCylinderMesh(i,this.distanceInfo.sndClndPos,this.appmaterialLine),this.distanceInfo.sndClnd.oldPosition=this.distanceInfo.sndClndPos.clone(),this.distanceInfo.sndClnd.offsetPos=s.clone().multiplyScalar(-1),this.distanceInfo.sndClnd.position.subVectors(this.distanceInfo.sndClndPos,s.clone().multiplyScalar(o)),this.distanceInfo.sndClnd.updateMatrixWorld(),this.OpMeasure.rootObject.add(this.distanceInfo.sndClnd),this.distanceInfo.clndToClndLine&&this.OpMeasure.rootObject.remove(this.distanceInfo.clndToClndLine),this.distanceInfo.clndToClndLine=this.createLineMesh2(this.distanceInfo.fstClndPos,this.distanceInfo.sndClndPos,this.appmaterialLine,1),this.OpMeasure.rootObject.add(this.distanceInfo.clndToClndLine),this.distanceInfo.fstToClndLine&&this.OpMeasure.rootObject.remove(this.distanceInfo.fstToClndLine),this.distanceInfo.fstToClndLine=this.createLineMesh2(this.distanceInfo.projectFstPos,this.distanceInfo.fstClndPos,this.appmaterialLine,1),this.OpMeasure.rootObject.add(this.distanceInfo.fstToClndLine),this.distanceInfo.sndToClndLine&&this.OpMeasure.rootObject.remove(this.distanceInfo.sndToClndLine),this.distanceInfo.sndToClndLine=this.createLineMesh2(this.distanceInfo.projectSecPos,this.distanceInfo.sndClndPos,this.appmaterialLine,1),this.OpMeasure.rootObject.add(this.distanceInfo.sndToClndLine),this.distanceInfo.FstToFstPointLine&&this.OpMeasure.rootObject.remove(this.distanceInfo.FstToFstPointLine),this.distanceInfo.FstToFstPointLine=this.createLineMesh2(this.distanceInfo.projectFstPos,this.distanceInfo.firstPoint,this.appmaterialLine,1),this.OpMeasure.rootObject.add(this.distanceInfo.FstToFstPointLine),this.distanceInfo.SndToSndPointLine&&this.OpMeasure.rootObject.remove(this.distanceInfo.SndToSndPointLine),this.distanceInfo.SndToSndPointLine=this.createLineMesh2(this.distanceInfo.projectSecPos,this.distanceInfo.secondPoint,this.appmaterialLine,1),this.OpMeasure.rootObject.add(this.distanceInfo.SndToSndPointLine),this.distanceInfo.projectFstPos.clone()),o=this.distanceInfo.projectSecPos.clone(),n=(this.lineargaugeModelCoord2PlaneCoord(s),this.lineargaugeModelCoord2PlaneCoord(o),this.distanceInfo.dimString=s.distanceTo(o),0==n?this.distanceInfo.dimString=Math.abs(s.x-o.x):1==n&&(this.distanceInfo.dimString=Math.abs(s.y-o.y)),this.distanceInfo.dimString<1&&.999999<this.distanceInfo.dimString&&(this.distanceInfo.dimString=1),this.viewer.getDispalyModelUnit(this.distanceInfo.dimString)),s=(this.distanceInfo.dimString*=n.scale,this.distanceInfo.dimString=this.distanceInfo.dimString.toFixed(8),this.distanceInfo.unit=this.getUnitStringmap(n.unit),(this.distanceInfo.dimString*this.viewer.measuringScale).toFixed(this.viewer.Decimal)+this.distanceInfo.unit);if(this.isBoxMoving=!0,!this.distanceInfo.textBox){if("pt2ptbim"==this.measureType){this.distanceInfo.textBox=document.createElement("div"),this.distanceInfo.textBox.className="measure-tc",this.sectionCross=document.createElement("div"),this.sectionCross.className="sectionCross",this.distanceInfo.textBox.appendChild(this.sectionCross);(r=document.createElement("div")).className="sectionPoint",r.style.left="calc(50% - 6px)",r.style.top="calc(100% - 5.5px)",this.distanceInfo.textBox.appendChild(r);var r,o=document.createElement("p"),a="en"==NDSWebViewer.COMMON.getLanguage(),a=(o.innerHTML=a?"<span>dis</span>"+s:"<span></span>"+s,this.distanceInfo.textBox.appendChild(o),document.createElement("p")),o=Math.abs(this.distanceInfo.firstPoint.x-this.distanceInfo.secondPoint.x),n=this.viewer.getDispalyModelUnit(o),o=(a.innerHTML="<span>X</span>"+(o*this.viewer.measuringScale*n.scale).toFixed(8)+this.getUnitStringmap(n.unit),this.distanceInfo.textBox.appendChild(a),document.createElement("p")),a=Math.abs(this.distanceInfo.firstPoint.z-this.distanceInfo.secondPoint.z),a=(n=this.viewer.getDispalyModelUnit(a),o.innerHTML="<span>Y</span>"+(a*this.viewer.measuringScale*n.scale).toFixed(8)+this.getUnitStringmap(n.unit),this.distanceInfo.textBox.appendChild(o),document.createElement("p")),o=Math.abs(this.distanceInfo.firstPoint.y-this.distanceInfo.secondPoint.y);n=this.viewer.getDispalyModelUnit(o),a.innerHTML="<span>Z</span>"+(o*this.viewer.measuringScale*n.scale).toFixed(8)+this.getUnitStringmap(n.unit),this.distanceInfo.textBox.appendChild(a)}else if(this.distanceInfo.textBox=document.createElement("div"),this.distanceInfo.textBox.className="section10",this.distanceInfo.textBox.innerHTML=s,this.distanceInfo.textBox.setAttribute("mobile","up"),(r=document.createElement("div")).className="sectionPoint",this.distanceInfo.textBox.appendChild(r),this.sectionCross=document.createElement("div"),this.sectionCross.className="sectionCross",this.distanceInfo.textBox.appendChild(this.sectionCross),!NDSWebViewer.COMMON.isMobileDevice()){this.distanceInfo.textBox.addEventListener("mousedown",this.clickBoxInfo,!1);let n=this;this.distanceInfo.textBox.addEventListener("click",function e(t){0===t.button&&NDSWebViewer.SETTING.enableBroadcast&&NDSWebViewer.SETTING.broadcastMajor&&n.viewer.dispatchEvent({type:"broadcastEvent"}),this.removeEventListener("click",e)},!1)}this.viewer.container.appendChild(this.distanceInfo.textBox)}this.getAndShowTextBox(this.distanceInfo.textPos.clone(),s,this.distanceInfo.textBox),null!=s&&(this.distanceInfo.textBox.childNodes[0].data=s),1==t&&(NDSWebViewer.COMMON.isMobileDevice()||this.distanceInfo.textBox.removeEventListener("mousedown",this.clickBoxInfo,!1),(o={}).dimString=s,o.textPos=this.distanceInfo.textPos.clone(),o.textBox=this.distanceInfo.textBox,n=this,(a=new THREE.Group).objectType="Group",n.distanceInfo.firstSelObj&&(n.OpMeasure.rootObject.remove(n.distanceInfo.firstSelObj),a.add(n.distanceInfo.firstSelObj)),n.distanceInfo.secondSelObj&&(n.OpMeasure.rootObject.remove(n.distanceInfo.secondSelObj),a.add(n.distanceInfo.secondSelObj)),n.distanceInfo.projectPlaneObj&&(n.OpMeasure.rootObject.remove(n.distanceInfo.projectPlaneObj),a.add(n.distanceInfo.projectPlaneObj)),n.distanceInfo.boxToClndLine&&(n.OpMeasure.rootObject.remove(n.distanceInfo.boxToClndLine),a.add(n.distanceInfo.boxToClndLine)),n.distanceInfo.axisLineObj&&(n.OpMeasure.rootObject.remove(n.distanceInfo.axisLineObj),a.add(n.distanceInfo.axisLineObj)),n.distanceInfo.secaxisLineObj&&(n.OpMeasure.rootObject.remove(n.distanceInfo.secaxisLineObj),a.add(n.distanceInfo.secaxisLineObj)),n.distanceInfo.projectFstClnd&&(n.OpMeasure.rootObject.remove(n.distanceInfo.projectFstClnd),a.add(n.distanceInfo.projectFstClnd)),n.distanceInfo.projectSecClnd&&(n.OpMeasure.rootObject.remove(n.distanceInfo.projectSecClnd),a.add(n.distanceInfo.projectSecClnd)),n.distanceInfo.fstClnd&&(n.OpMeasure.rootObject.remove(n.distanceInfo.fstClnd),a.add(n.distanceInfo.fstClnd)),n.distanceInfo.sndClnd&&(n.OpMeasure.rootObject.remove(n.distanceInfo.sndClnd),a.add(n.distanceInfo.sndClnd)),n.distanceInfo.clndToClndLine&&(n.OpMeasure.rootObject.remove(n.distanceInfo.clndToClndLine),a.add(n.distanceInfo.clndToClndLine)),n.distanceInfo.fstToClndLine&&(n.OpMeasure.rootObject.remove(n.distanceInfo.fstToClndLine),a.add(n.distanceInfo.fstToClndLine)),n.distanceInfo.sndToClndLine&&(n.OpMeasure.rootObject.remove(n.distanceInfo.sndToClndLine),a.add(n.distanceInfo.sndToClndLine)),n.distanceInfo.FstToFstPointLine&&(n.OpMeasure.rootObject.remove(n.distanceInfo.FstToFstPointLine),a.add(n.distanceInfo.FstToFstPointLine)),n.distanceInfo.SndToSndPointLine&&(n.OpMeasure.rootObject.remove(n.distanceInfo.SndToSndPointLine),a.add(n.distanceInfo.SndToSndPointLine)),n.OpMeasure.rootObject.add(a),NDSWebViewer.COMMON.isMobileDevice()?(o.textBox.addEventListener("touchstart",this.touchstart,!1),o.textBox.addEventListener("touchend",this.touchend,!1),o.textBox.addEventListener("touchmove",this.touchmove,!1)):(o.textBox.addEventListener("mousedown",this.touchstart,!1),o.textBox.addEventListener("mouseup",this.touchend,!1),o.textBox.addEventListener("mousemove",this.touchmove,!1),o.textBox.addEventListener("mouseleave",this.mouseleave,!1),o.textBox.addEventListener("mouseenter",this.mouseenter,!1)),NDSWebViewer.COMMON.isMobileDevice()?this.sectionCross.addEventListener("touchend",this.sectionCrossend,!1):(this.sectionCross.addEventListener("mousedown",this.sectionCrossend,!1),this.sectionCross.addEventListener("mouseleave",this.crossleave,!1),this.sectionCross.addEventListener("mouseenter",this.crossenter,!1)),(r={}).start=this.distanceInfo.textPos.clone(),r.end=this.distanceInfo.textPos.clone(),r.uuid=a.uuid,this.OpMeasure.textLines.push(r),o.textBox.setAttribute("mobile","up"),o.textBox.setAttribute("group",a.uuid),this.OpMeasure.currentUuid=a.uuid,o.textBox.setAttribute("type","length"),o.textBox.setAttribute("dimString",this.distanceInfo.dimString),o.textBox.setAttribute("dimStringPrefix",""),o.textBox.setAttribute("unit",this.distanceInfo.unit),o.textBox.setAttribute("lineInfo",this.OpMeasure.textLines.length-1),this.OpMeasure.boxInfos.push(o),this.OpMeasure.unsteadyData[a.uuid]=this.DeepCopy(this.distanceInfo,"Lineargauge3D"),this.OpMeasure.unsteadyData[a.uuid].p1=i,this.OpMeasure.unsteadyData[a.uuid].p2=e,this.sectionCross=null,this.matrxTrans=null,this.selectProjectPlane=!1,this.projectDirectionXorY=null,this.isBoxMoving=!1,!NDSWebViewer.COMMON.isMobileDevice()&&"LmPt2Pt"!=this.measureType&&"LmHole2Hole"!=this.measureType||this.viewer.dispatchEvent({type:"Lineargauge3DMeasureEndEvent"}),this.clearDistanceInfo(!0),NDSWebViewer.COMMON.isMobileDevice())&&(this.ChangeMeasureFlag(),this.OpMeasure.measureEnd())}},I.prototype.LineargaugeClearPreSelect=function(){this.preSelClear()},I.prototype.LineargaugeClearProjectPlaneSelect=function(){this.distanceInfo.projectPlaneObj&&(this.OpMeasure.rootObject.remove(this.distanceInfo.projectPlaneObj),this.distanceInfo.projectPlaneObj=null,this.distanceInfo.projectPlaneInfo=null)},I.prototype.LineargaugeClearFirstSelect=function(){this.distanceInfo.firstSelObj&&(this.OpMeasure.rootObject.remove(this.distanceInfo.firstSelObj),this.distanceInfo.firstSelObj=null,this.distanceInfo.firstSelInfo=null),this.distanceInfo.axisLineObj&&(this.OpMeasure.rootObject.remove(this.distanceInfo.axisLineObj),this.distanceInfo.axisLineObj=null)},I.prototype.LineargaugePostSelectPorjectPlane=function(e){switch(this.measureType){case"LmPt2Pt":case"LmHole2Hole":this.distanceInfo.projectPlane?this.selectProjectPlane=!1:e?(this.distanceInfo.projectPlane=e,this.selectProjectPlane=!1,this.lineargaugeRotate(this.distanceInfo.projectPlane)):(this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.SELECTPROJECTPLANE),this.selectProjectPlane=!1);break;default:this.selectProjectPlane=!1,this.distanceInfo.projectPlane=e}},I.prototype.LineargaugePostNotify=function(){this.distanceInfo.firstSelInfo?this.distanceInfo.firstSelInfo&&!this.distanceInfo.secondSelInfo&&(this.allowType=this.MeasurePostInfo(this.measureType,!1,!0)):this.allowType=this.MeasurePostInfo(this.measureType,!0,!0)},I.prototype.lineargaugeRotate=function(e,t){e=this.viewer.cameraControl.rotateToPlane(e);this.distanceInfo.projectFstPos=null,this.distanceInfo.projectSecPos=null,this.matrxTrans=e,this.viewer.render(),this.LineargaugePostNotify(),this.distanceInfo.firstSelInfo&&this.distanceInfo.secondSelInfo&&(NDSWebViewer.COMMON.isMobileDevice()?null!=this.projectDirectionXorY?this.lineargaugeSelectPlaceLine(this.projectDirectionXorY):this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.SELECTPLACELINELOCATION):(t&&this.ShowLineargaugeDimension(null,!1,this.distanceInfo.XorY),this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.PLACELINELOCATION)))},I.prototype.lineargaugeRotateOnly=function(e){e&&(e=this.viewer.cameraControl.rotateToPlane(e),this.distanceInfo.projectFstPos=null,this.distanceInfo.projectSecPos=null,this.viewer.render(),this.matrxTrans=e)},I.prototype.lineargaugeModelCoord2PlaneCoord=function(e){e.sub(this.matrxTrans.origin),e.applyMatrix3(this.matrxTrans.matrixInvert)},I.prototype.lineargaugePlaneCoord2ModelCoord=function(e){e.applyMatrix3(this.matrxTrans.matrix),e.add(this.matrxTrans.origin)},I.prototype.lineargaugeSelectPlaceLine=function(e){this.projectDirectionXorY=e,this.distanceInfo.firstSelInfo&&this.distanceInfo.secondSelInfo&&this.distanceInfo.projectPlane&&(this.matrxTrans||this.lineargaugeRotateOnly(this.distanceInfo.projectPlane),this.ShowLineargaugeDimension(null,!0,this.projectDirectionXorY),this.LineargaugePostNotify())},(u.prototype=Object.create(i.prototype)).OperatorStart=function(e){this.measureType=e,this.allowType=["face"],this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.FIRSTMESH)},u.prototype.onNMouseMove=function(e,t){var n=new THREE.Vector3(e,t,0);this.OpMeasure.unsteady?this.changeMeasureDistance(n):this.distanceInfo.firstSelObj&&this.distanceInfo.secondSelObj||(this.WallThicknessMeasure(e,t,!0,this.allowType),this.updateWallThicknessMeasure(!0))},u.prototype.onLMouseClick=function(e,t,n){new THREE.Vector3(e,t,0);this.distanceInfo.firstSelObj&&this.distanceInfo.secondSelObj||(this.WallThicknessMeasure(e,t,!1,this.allowType),this.updateWallThicknessMeasure(!1))},u.prototype.WallThicknessMeasure=function(e,t,n,i){(e=this.doRaycasterPick(e,t,!1))&&0!=e.length?(t=e[0])&&(n?(e=this.getSelectInfoFromIntersect(t))&&(-1==i.indexOf(e.topolType)?this.WallThicknessClearPreSelect():null!=this.distanceInfo.preSelInfo&&this.isTwoTopolInfoTheSame(this.distanceInfo.preSelInfo,e)||(this.distanceInfo.preSelInfo=e,this.distanceInfo.preSelObj&&(this.OpMeasure.rootObject.remove(this.distanceInfo.preSelObj),this.distanceInfo.preSelObj=null))):((n=this.getSelectInfoFromIntersect(t))&&-1!=i.indexOf(n.topolType)&&(null==this.distanceInfo.firstSelInfo?this.distanceInfo.firstSelInfo=n:this.distanceInfo.firstSelInfo&&(this.isTwoTopolInfoTheSame(this.distanceInfo.firstSelInfo,n)?(this.distanceInfo.firstSelObj&&(this.OpMeasure.rootObject.remove(this.distanceInfo.firstSelObj),this.distanceInfo.firstSelObj=null,this.distanceInfo.firstSelInfo=null),this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.FIRSTMESH),this.WallThicknessClearPreSelect()):"cylinder"==this.distanceInfo.firstSelInfo.type&&"cylinder"==n.type?(this.CalcCircleWallThickness(this.distanceInfo.firstSelInfo,n)||this.CalcWallThickness(this.distanceInfo.firstSelInfo,n))&&(this.distanceInfo.secondSelInfo=n,this.distanceInfo.firstSelInfo.type="wallFace",this.distanceInfo.secondSelInfo.type="wallFace"):"plane"==this.distanceInfo.firstSelInfo.type&&"plane"==n.type?(this.CalcPlaneWallThickness(this.distanceInfo.firstSelInfo,n)||this.CalcWallThickness(this.distanceInfo.firstSelInfo,n))&&(this.distanceInfo.secondSelInfo=n,this.distanceInfo.firstSelInfo.type="wallFace",this.distanceInfo.secondSelInfo.type="wallFace"):this.CalcWallThickness(this.distanceInfo.firstSelInfo,n)&&(this.distanceInfo.secondSelInfo=n,this.distanceInfo.firstSelInfo.type="wallFace",this.distanceInfo.secondSelInfo.type="wallFace"))),this.WallThicknessClearPreSelect())):this.WallThicknessClearPreSelect()},u.prototype.updateWallThicknessMeasure=function(e){var t;this.distanceInfo.firstSelObj&&this.distanceInfo.secondSelObj?this.WallThicknessClearPreSelect():e?this.distanceInfo.preSelInfo&&!this.distanceInfo.preSelObj&&"face"==this.distanceInfo.preSelInfo.topolType&&(t=this.createFace(this.distanceInfo.preSelInfo,!0))&&(this.OpMeasure.rootObject.add(t),this.distanceInfo.preSelObj=t):(this.distanceInfo.firstSelInfo&&!this.distanceInfo.firstSelObj&&(this.WallThicknessClearPreSelect(),t=null,(t="face"==this.distanceInfo.firstSelInfo.topolType?this.createFace(this.distanceInfo.firstSelInfo,!1):t)&&(this.OpMeasure.rootObject.add(t),this.distanceInfo.firstSelObj=t),this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.SECONDMESH)),this.distanceInfo.secondSelInfo&&!this.distanceInfo.secondSelObj&&(this.WallThicknessClearPreSelect(),t=null,t="face"==this.distanceInfo.secondSelInfo.topolType?this.createFace(this.distanceInfo.secondSelInfo,!1):t)&&(this.OpMeasure.rootObject.add(t),this.distanceInfo.secondSelObj=t),this.distanceInfo.firstSelObj&&this.distanceInfo.secondSelObj&&(NDSWebViewer.SETTING.enableBroadcast&&NDSWebViewer.SETTING.broadcastMajor&&this.OpMeasure.addmeasureTimes(),this.createAndShow3DDistanceDimension(null,!0),this.OpMeasure.rootObject.remove(this.distanceInfo.firstSelObj),this.OpMeasure.rootObject.remove(this.distanceInfo.secondSelObj),this.distanceInfo.firstSelObj=null,this.distanceInfo.secondSelObj=null,this.distanceInfo.firstSelInfo=null,this.distanceInfo.secondSelInfo=null,this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.FIRSTMESH),this.OpMeasure.measureEnd()))},u.prototype.IntersectCylinderPoints=function(e,t,n,i){for(var s=e.geometry,o=n.geometry,r=s.index,a=o.index,l=e.indexRange.concat(),d=(l[0]+=s.drawRange.start/3,l[1]+=s.drawRange.start/3,n.indexRange.concat()),c=(d[0]+=o.drawRange.start/3,d[1]+=o.drawRange.start/3,new THREE.Vector3),h=new THREE.Vector3,f=new THREE.Vector3,I=new THREE.Vector3,u=new THREE.Vector3,p=new THREE.Vector3,S=new THREE.Vector3,g=new THREE.Vector3,E=new THREE.Vector3,m=(new THREE.Triangle,new THREE.Triangle),O=(new THREE.Vector3,new THREE.Vector3),b=l[0];b<=l[1];b++){var P=r.getX(y=3*b),M=r.getX(1+y),T=r.getX(2+y);c.fromBufferAttribute(s.attributes.position,P),h.fromBufferAttribute(s.attributes.position,M),f.fromBufferAttribute(s.attributes.position,T),c.applyMatrix4(e.matrixWorld),h.applyMatrix4(e.matrixWorld),f.applyMatrix4(e.matrixWorld),t.closestPointToPoint(c,!1,S),t.closestPointToPoint(h,!1,g),t.closestPointToPoint(f,!1,E);for(var x=d[0];x<=d[1];x++){var y,C,N,P=a.getX(y=3*x),M=a.getX(1+y),T=a.getX(2+y);if(I.fromBufferAttribute(o.attributes.position,P),u.fromBufferAttribute(o.attributes.position,M),p.fromBufferAttribute(o.attributes.position,T),I.applyMatrix4(n.matrixWorld),u.applyMatrix4(n.matrixWorld),p.applyMatrix4(n.matrixWorld),m.set(I,u,p),m.getNormal(O),this.IntersectLineToTriangle(S,c,m))return C=(new THREE.Vector3).subVectors(c,S).normalize(),{pt1:c,pt2:(new THREE.Vector3).copy(S).addScaledVector(C,n.radius)};if(this.IntersectLineToTriangle(g,h,m))return C=(new THREE.Vector3).subVectors(h,g).normalize(),{pt1:h,pt2:(new THREE.Vector3).copy(g).addScaledVector(C,n.radius)};if(this.IntersectLineToTriangle(E,f,m))return N=(new THREE.Vector3).subVectors(f,E).normalize(),{pt1:f,pt2:(new THREE.Vector3).copy(E).addScaledVector(N,n.radius)}}}return null},u.prototype.IntersectLineToTriangle=function(e,t,n){var t={origin:e,direction:(new THREE.Vector3).subVectors(t,e)},e=(new THREE.Vector3).subVectors(t.origin,n.a),i=(new THREE.Vector3).subVectors(n.b,n.a),n=(new THREE.Vector3).subVectors(n.c,n.a),s=(new THREE.Vector3).crossVectors(i,n);let o=t.direction.dot(s),r;if(0<o)r=1;else{if(!(o<0))return!1;r=-1,o=-o}n=r*t.direction.dot((new THREE.Vector3).crossVectors(e,n));if(0<=n){t=r*t.direction.dot((new THREE.Vector3).crossVectors(i,e));if(0<=t)if(n+t<=o)if(0<=-r*e.dot(s))return!0}return!1},u.prototype.CalcCircleWallThickness=function(e,t){var n=this.getLineStartEndPoints(e),i=this.getLineStartEndPoints(t),s=(new THREE.Vector3).subVectors(n.end,n.start).normalize(),o=(new THREE.Vector3).subVectors(i.end,i.start).normalize(),s=s.dot(o);if(1-Math.abs(s)<1e-7){var o=new THREE.Line3(n.start,n.end),s=new THREE.Line3(i.start,i.end),r=n.start.distanceTo(n.end),a=i.start.distanceTo(n.start)+i.start.distanceTo(n.end),l=i.end.distanceTo(n.start)+i.end.distanceTo(n.end),d=i.start.distanceTo(i.end),c=n.start.distanceTo(i.start)+n.start.distanceTo(i.end),n=n.end.distanceTo(i.start)+n.end.distanceTo(i.end);if(Math.abs(a-r)<1e-6||Math.abs(l-r)<1e-6||Math.abs(c-d)<1e-6||Math.abs(n-d)<1e-6){i=this.IntersectCylinderPoints(e,o,t,s);if(i)return this.distanceInfo.firstPoint=i.pt1,this.distanceInfo.secondPoint=i.pt2,!0}}return!1},u.prototype.CalcPlaneWallThickness=function(e,t){var n=e.worldNormal.clone(),i=t.worldNormal.clone(),n=(n.normalize(),i.normalize(),Math.abs(n.dot(i)));return Math.abs(n-1)<1e-5&&((i=new THREE.Plane).setFromNormalAndCoplanarPoint(t.worldNormal,t.worldOrigin),n=new THREE.Vector3,i.projectPoint(e.intersect,n),i=n.distanceTo(e.intersect),this.CalcWallThickness(e,t)&&(n=this.distanceInfo.firstPoint.distanceTo(this.distanceInfo.secondPoint),Math.abs(i-n)<1e-5)&&(this.distanceInfo.dimStringPrefix=""),!0)},u.prototype.CalcWallThickness=function(e,t){let n=e.geometry,i=t.geometry,s=n.index,o=i.index,r=e.indexRange.concat(),a=(r[0]+=n.drawRange.start/3,r[1]+=n.drawRange.start/3,t.indexRange.concat()),l=(a[0]+=i.drawRange.start/3,a[1]+=i.drawRange.start/3,new THREE.Vector3),d=new THREE.Vector3,c=new THREE.Vector3,h=new THREE.Vector3,f=new THREE.Vector3,I=new THREE.Vector3,u=new THREE.Triangle,p=new THREE.Triangle,S=new THREE.Vector3,g=new THREE.Vector3,E=1/0,m=null,O=null;for(var b=r[0];b<=r[1];b++){var P=s.getX(y=3*b),M=s.getX(1+y),T=s.getX(2+y);l.fromBufferAttribute(n.attributes.position,P),d.fromBufferAttribute(n.attributes.position,M),c.fromBufferAttribute(n.attributes.position,T),l.applyMatrix4(e.matrixWorld),d.applyMatrix4(e.matrixWorld),c.applyMatrix4(e.matrixWorld),u.set(l,d,c),u.getNormal(S);for(var x=a[0];x<=a[1];x++){var y,P=o.getX(y=3*x),M=o.getX(1+y),T=o.getX(2+y),C=(h.fromBufferAttribute(i.attributes.position,P),f.fromBufferAttribute(i.attributes.position,M),I.fromBufferAttribute(i.attributes.position,T),h.applyMatrix4(t.matrixWorld),f.applyMatrix4(t.matrixWorld),I.applyMatrix4(t.matrixWorld),p.set(h,f,I),p.getNormal(g),this.CalcTriangleToTriangleMinDist(u,p));C&&C.dist<E&&(m=C.pt1,O=C.pt2,E=C.dist)}}return E!=1/0&&(this.distanceInfo.firstPoint=m,this.distanceInfo.secondPoint=O,this.distanceInfo.dimStringPrefix=this.tmpDimStringPrefix,!0)},u.prototype.CalcTriangleDistance=function(e,t,n,i){if(Math.abs(t.dot(i))<1e-7)return null;let s=new THREE.Vector3,o=null,r=null,a=1/0,l;return(l=this.CalcNearestPointToTriangle(e,n.a,s))<a&&(a=l,o=n.a,r=s),(l=this.CalcNearestPointToTriangle(e,n.b,s))<a&&(a=l,o=n.b,r=s),(l=this.CalcNearestPointToTriangle(e,n.c,s))<a&&(a=l,o=n.c,r=s),(l=this.CalcNearestPointToTriangle(n,e.a,s))<a&&(a=l,o=e.a,r=s),(l=this.CalcNearestPointToTriangle(n,e.b,s))<a&&(a=l,o=e.b,r=s),(l=this.CalcNearestPointToTriangle(n,e.c,s))<a&&(a=l,o=e.c,r=s),{dist:a,pt1:o.clone(),pt2:r.clone()}},u.prototype.CalcNearestPointToTriangle=function(e,t,n){return e.closestPointToPoint(t,n),t.distanceTo(n)},u.prototype.CalcTriangleToTriangleMinDist=function(e,t){let n=1/0,i=0,s,o=null,r=null;return(s=this.CalcSegmentToTriangleMinDist(e.a,e.b,t)).distance<n&&(n=s.distance,i=s.sqrDistance,o=s.closest[0],r=s.closest[1]),(s=this.CalcSegmentToTriangleMinDist(e.b,e.c,t)).distance<n&&(n=s.distance,i=s.sqrDistance,o=s.closest[0],r=s.closest[1]),(s=this.CalcSegmentToTriangleMinDist(e.c,e.a,t)).distance<n&&(n=s.distance,i=s.sqrDistance,o=s.closest[0],r=s.closest[1]),(s=this.CalcSegmentToTriangleMinDist(t.a,t.b,e)).distance<n&&(n=s.distance,i=s.sqrDistance,o=s.closest[1],r=s.closest[0]),(s=this.CalcSegmentToTriangleMinDist(t.b,t.c,e)).distance<n&&(n=s.distance,i=s.sqrDistance,o=s.closest[1],r=s.closest[0]),(s=this.CalcSegmentToTriangleMinDist(t.c,t.a,e)).distance<n&&(n=s.distance,i=s.sqrDistance,o=s.closest[1],r=s.closest[0]),{dist:n,sqrDist:i,pt1:o,pt2:r}},u.prototype.CalcSegmentToTriangleMinDist=function(e,t,n){var i={origin:e,direction:(new THREE.Vector3).subVectors(t,e)};let s={sqrDistance:-1,distance:-1,parameter:-1,closest:[2]};var o,i=this.CalcLineToTriangleMinDist(i,n);return 0<=i.parameter?i.parameter<=1?s=i:(i=new THREE.Vector3,n.closestPointToPoint(t,i),o=t.distanceTo(i),s.sqrDistance=o,s.distance=o,s.parameter=1,s.closest[0]=t.clone(),s.closest[1]=i):(o=new THREE.Vector3,n.closestPointToPoint(e,o),t=e.distanceTo(o),s.sqrDistance=t,s.distance=t,s.parameter=0,s.closest[0]=e.clone(),s.closest[1]=o),s},u.prototype.CalcLineToTriangleMinDist=function(e,t){var n={sqrDistance:-1,distance:-1,parameter:-1,barycentric:[3],closest:[2]},i=(new THREE.Vector3).subVectors(t.b,t.a),s=(new THREE.Vector3).subVectors(t.c,t.a),o=(new THREE.Vector3).crossVectors(i,s),r=o.dot(e.direction);if(0<Math.abs(r)){var a=(new THREE.Vector3).subVectors(e.origin,t.a),o=-o.dot(a)/r,a=(new THREE.Vector3).copy(e.origin).addScaledVector(e.direction,o),r=(new THREE.Vector3).subVectors(a,t.a),l=i.dot(i),d=i.dot(s),c=s.dot(s),i=i.dot(r),s=s.dot(r),r=l*c-d*d,c=(c*i-d*s)/r,l=(l*s-d*i)/r;if(0<=1-c-l&&0<=c&&0<=l)return n.sqrDistance=0,n.distance=0,n.parameter=o,n.closest[0]=a,n.closest[1]=a,n}n.distance=-1,n.sqrDistance=-1;s=this.CalcLineToSegmentMinDist(e,t.a,t.b);return(-1==n.sqrDistance||s.sqrDistance<n.sqrDistance)&&(n.sqrDistance=s.sqrDistance,n.distance=s.distance,n.closest=s.closest,n.parameter=s.parameter[0]),s=this.CalcLineToSegmentMinDist(e,t.b,t.c),(-1==n.sqrDistance||s.sqrDistance<n.sqrDistance)&&(n.sqrDistance=s.sqrDistance,n.distance=s.distance,n.closest=s.closest,n.parameter=s.parameter[0]),s=this.CalcLineToSegmentMinDist(e,t.c,t.a),(-1==n.sqrDistance||s.sqrDistance<n.sqrDistance)&&(n.sqrDistance=s.sqrDistance,n.distance=s.distance,n.closest=s.closest,n.parameter=s.parameter[0]),n},u.prototype.CalcLineToSegmentMinDist=function(e,t,n){var i,s={sqrDistance:-1,distance:-1,parameter:[2],closest:[2]},n=(new THREE.Vector3).subVectors(n,t),o=(new THREE.Vector3).subVectors(e.origin,t),r=e.direction.dot(e.direction),a=-e.direction.dot(n),l=n.dot(n),d=e.direction.dot(o),c=Math.max(r*l-a*a,0);let h,f;return 0<c&&(i=-n.dot(o),0<=(f=a*d-r*i))?f<=c?(h=(a*i-l*d)/c,f/=c):(h=-(a+d)/r,f=1):(h=-d/r,f=0),s.parameter[0]=h,s.parameter[1]=f,s.closest[0]=(new THREE.Vector3).copy(e.origin).addScaledVector(e.direction,h),s.closest[1]=(new THREE.Vector3).copy(t).addScaledVector(n,f),o=(new THREE.Vector3).subVectors(s.closest[0],s.closest[1]),s.sqrDistance=o.dot(o),s.distance=Math.sqrt(s.sqrDistance),s},u.prototype.WallThicknessClearPreSelect=function(){this.distanceInfo.preSelObj&&(this.OpMeasure.rootObject.remove(this.distanceInfo.preSelObj),this.distanceInfo.preSelObj=null,this.distanceInfo.preSelInfo=null)},u.prototype.WallThicknessClearFirstSelect=function(){this.distanceInfo.firstSelObj&&(this.OpMeasure.rootObject.remove(this.distanceInfo.firstSelObj),this.distanceInfo.firstSelObj=null,this.distanceInfo.firstSelInfo=null)},(p.prototype=Object.create(i.prototype)).OperatorStart=function(e){this.measureType=e,"ellipse"===this.measureType&&this.OpMeasure.PostInfo(NDSWebViewer.NDS.INFOTYPE.MEASUREBODY)},p.prototype.measureEllipse=function(e,t,n){if(""==this.edgeInfo.unit&&(this.edgeInfo.unit=this.getUnitString()),this.edgeInfo.selLineObj)this.edgeInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.edgeInfo.preSelLineObj),this.edgeInfo.preSelLineObj=null,this.edgeInfo.preSelLineInfo=null);else{var i=this.viewer,e=this.doRaycasterPick(e,t,!0);if(e&&0!=e.length){if(0<e.length){t=null;if(i.ndsModel?0<=e[0].lineSegId&&(t=e[0]):e[0].object instanceof THREE.Line||e[0].object instanceof THREE.LineSegments?t=e[0]:1<e.length&&(e[1].object instanceof THREE.Line||e[1].object instanceof THREE.LineSegments)&&Math.abs(e[1].distance-e[0].distance)<(i=this.viewer.controls.getBoundingBox()).min.distanceTo(i.max)/1e3&&(t=e[1]),t){i=this.getSelectInfoFromIntersect(t);if(i&&"ellipse"==i.type&&i.radiusX&&i.radiusX<3e30)return void(1==n?this.isTwoTopolInfoTheSame(this.edgeInfo.preSelLineInfo,i)||(this.edgeInfo.preSelLineInfo=i,this.edgeInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.edgeInfo.preSelLineObj),this.edgeInfo.preSelLineObj=null)):(this.edgeInfo.selLineInfo=i,this.edgeInfo.dimString=parseFloat(i.length),this.edgeInfo.dimString<1&&.999999<this.edgeInfo.dimString&&(this.edgeInfo.dimString=1),e=this.viewer.getDispalyModelUnit(this.edgeInfo.dimString),this.edgeInfo.dimString*=e.scale,this.edgeInfo.dimString=this.edgeInfo.dimString.toFixed(8),this.edgeInfo.unit=this.getUnitStringmap(e.unit),"line"!=i.type&&(this.edgeInfo.dimString=" "+this.edgeInfo.dimString)))}}1==n&&this.edgeInfo.preSelLineInfo&&(this.edgeInfo.preSelLineInfo=null,this.edgeInfo.preSelLineObj)&&(this.OpMeasure.rootObject.remove(this.edgeInfo.preSelLineObj),this.edgeInfo.preSelLineObj=null)}else this.edgeInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.edgeInfo.preSelLineObj),this.edgeInfo.preSelLineObj=null,this.edgeInfo.preSelLineInfo=null)}},p.prototype.onNMouseMove=function(e,t){var n=new THREE.Vector3(e,t,0);this.OpMeasure.unsteady?this.changeMeasureEllipse(n):this.edgeInfo.selLineObj&&!NDSWebViewer.COMMON.isMobileDevice()?this.createAndShowMeasureEdgesDimension(n):(this.measureEllipse(e,t,!0),this.viewer.is2DModel||this.update3DMeasureEllipseScene("true",n))},p.prototype.update3DMeasureEllipseScene=function(e,t){var n;"ellipse"===this.measureType&&(this.edgeInfo.selLineObj?this.edgeInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.edgeInfo.preSelLineObj),this.edgeInfo.preSelLineObj=null,this.edgeInfo.preSelLineInfo=null):!(!e||"true"!==e.toLowerCase())?this.edgeInfo.preSelLineInfo&&!this.edgeInfo.preSelLineObj&&(n=this.createEllipse(this.edgeInfo.preSelLineInfo,!0))&&(this.OpMeasure.rootObject.add(n),this.edgeInfo.preSelLineObj=n):(this.edgeInfo.selLineInfo&&!this.edgeInfo.selLineObj&&(this.edgeInfo.preSelLineObj&&(this.OpMeasure.rootObject.remove(this.edgeInfo.preSelLineObj),this.edgeInfo.preSelLineObj=null,this.edgeInfo.preSelLineInfo=null),n=this.createEllipse(this.edgeInfo.selLineInfo,!1))&&(this.edgeInfo.selLineObj=n),this.edgeInfo.selLineObj&&(NDSWebViewer.SETTING.enableBroadcast&&NDSWebViewer.SETTING.broadcastMajor&&this.OpMeasure.addmeasureTimes(),this.createAndShow3DMeasureEllipseDimension(t,!0),this.OpMeasure.measureEnd())))},p.prototype.createAndShow3DMeasureEllipseDimension=function(e,t){var n,i,s,o,r,a,l,d,c,h,f;"ellipse"==this.measureType&&this.edgeInfo.selLineInfo&&this.edgeInfo.selLineObj&&(this.edgeInfo.thirdPos,d=new THREE.Vector3,f=new THREE.Quaternion,r=new THREE.Vector3,this.edgeInfo.selLineInfo.matrixWorld.decompose(d,f,r),d=new THREE.Vector3(this.edgeInfo.selLineInfo.center[0],this.edgeInfo.selLineInfo.center[1],this.edgeInfo.selLineInfo.center[2]),f=new THREE.Vector3(this.edgeInfo.selLineInfo.axisX[0],this.edgeInfo.selLineInfo.axisX[1],this.edgeInfo.selLineInfo.axisX[2]).normalize(),i=new THREE.Vector3(this.edgeInfo.selLineInfo.normal[0],this.edgeInfo.selLineInfo.normal[1],this.edgeInfo.selLineInfo.normal[2]).cross(f).normalize(),c=d.clone().addScaledVector(f,this.edgeInfo.selLineInfo.radiusX/r.x),o=d.clone().addScaledVector(f,-this.edgeInfo.selLineInfo.radiusX/r.x),a=d.clone().addScaledVector(i,this.edgeInfo.selLineInfo.radiusY/r.y),d=d.clone().addScaledVector(i,-this.edgeInfo.selLineInfo.radiusY/r.y),n=c.clone().addScaledVector(i,this.edgeInfo.selLineInfo.radiusY/r.y*1.5),i=o.clone().addScaledVector(i,this.edgeInfo.selLineInfo.radiusY/r.y*1.5),s=a.clone().addScaledVector(f,this.edgeInfo.selLineInfo.radiusX/r.x*1.5),f=d.clone().addScaledVector(f,this.edgeInfo.selLineInfo.radiusX/r.x*1.5),c.applyMatrix4(this.edgeInfo.selLineInfo.matrixWorld),o.applyMatrix4(this.edgeInfo.selLineInfo.matrixWorld),a.applyMatrix4(this.edgeInfo.selLineInfo.matrixWorld),d.applyMatrix4(this.edgeInfo.selLineInfo.matrixWorld),n.applyMatrix4(this.edgeInfo.selLineInfo.matrixWorld),i.applyMatrix4(this.edgeInfo.selLineInfo.matrixWorld),s.applyMatrix4(this.edgeInfo.selLineInfo.matrixWorld),f.applyMatrix4(this.edgeInfo.selLineInfo.matrixWorld),(r=(new THREE.Vector3).subVectors(n,i)).normalize(),(h=(new THREE.Vector3).subVectors(s,f)).normalize(),this.edgeInfo.startToClndLine&&(this.OpMeasure.rootObject.remove(this.edgeInfo.startToClndLine),this.OpMeasure.rootObject.remove(this.edgeInfo.endToClndLine),this.OpMeasure.rootObject.remove(this.edgeInfo.fstClnd),this.OpMeasure.rootObject.remove(this.edgeInfo.sndClnd),this.OpMeasure.rootObject.remove(this.edgeInfo.clndToClndLine),this.OpMeasure.rootObject.remove(this.edgeInfo.startToClndLine1),this.OpMeasure.rootObject.remove(this.edgeInfo.endToClndLine1),this.OpMeasure.rootObject.remove(this.edgeInfo.fstClnd1),this.OpMeasure.rootObject.remove(this.edgeInfo.sndClnd1),this.OpMeasure.rootObject.remove(this.edgeInfo.clndToClndLine1)),this.edgeInfo.startToClndLine=this.createLineMesh2(c,n,this.appmaterialLine,1),this.edgeInfo.endToClndLine=this.createLineMesh2(o,i,this.appmaterialLine,1),this.edgeInfo.fstClnd=this.createCylinderMesh(n,i,this.appmaterialLine),c=this.OpMeasure.getScale(this.edgeInfo.fstClnd,this.CYLINDERWIDTH),r.multiplyScalar(.5*this.edgeInfo.fstClnd.geometry.parameters.height),this.edgeInfo.fstClnd.oldPosition=i.clone(),this.edgeInfo.fstClnd.offsetPos=r.clone(),this.edgeInfo.fstClnd.position.addVectors(i,r.clone().multiplyScalar(c)),this.edgeInfo.sndClnd=this.createCylinderMesh(i,n,this.appmaterialLine),this.edgeInfo.sndClnd.oldPosition=n.clone(),this.edgeInfo.sndClnd.offsetPos=r.clone().multiplyScalar(-1),this.edgeInfo.sndClnd.position.subVectors(n,r.clone().multiplyScalar(c)),this.edgeInfo.clndToClndLine=this.createLineMesh2(n,i,this.appmaterialLine,1),this.edgeInfo.startToClndLine1=this.createLineMesh2(a,s,this.appmaterialLine,1),this.edgeInfo.endToClndLine1=this.createLineMesh2(d,f,this.appmaterialLine,1),this.edgeInfo.fstClnd1=this.createCylinderMesh(s,f,this.appmaterialLine),h.multiplyScalar(.5*this.edgeInfo.fstClnd1.geometry.parameters.height),this.edgeInfo.fstClnd1.oldPosition=f.clone(),this.edgeInfo.fstClnd1.offsetPos=h.clone(),this.edgeInfo.fstClnd1.position.addVectors(f,h.clone().multiplyScalar(c)),this.edgeInfo.sndClnd1=this.createCylinderMesh(f,s,this.appmaterialLine),this.edgeInfo.sndClnd1.oldPosition=s.clone(),this.edgeInfo.sndClnd1.offsetPos=h.clone().multiplyScalar(-1),this.edgeInfo.sndClnd1.position.subVectors(s,h.clone().multiplyScalar(c)),this.edgeInfo.clndToClndLine1=this.createLineMesh2(s,f,this.appmaterialLine,1),o=(2*this.edgeInfo.selLineInfo.radiusX*this.viewer.measuringScale).toFixed(8)+this.edgeInfo.unit,r=(2*this.edgeInfo.selLineInfo.radiusY*this.viewer.measuringScale).toFixed(8)+this.edgeInfo.unit,a=null,this.edgeInfo.textBox||(this.edgeInfo.textBox=document.createElement("div"),this.edgeInfo.textBox.className="section10",this.edgeInfo.textBox.innerHTML=o,(d=document.createElement("div")).className="sectionPoint",this.edgeInfo.textBox.appendChild(d),(a=document.createElement("div")).className="sectionCross",this.edgeInfo.textBox.appendChild(a),this.viewer.container.appendChild(this.edgeInfo.textBox),this.edgeInfo.textBox1=document.createElement("div"),this.edgeInfo.textBox1.className="section10",this.edgeInfo.textBox1.innerHTML=r,(h=document.createElement("div")).className="sectionPoint",this.edgeInfo.textBox1.appendChild(h),(l=document.createElement("div")).className="sectionCross",this.edgeInfo.textBox1.appendChild(l),this.viewer.container.appendChild(this.edgeInfo.textBox1)),1==t)&&(c={},(d={}).dimString=o,c.dimString=r,d.textPos=(new THREE.Vector3).addVectors(n,i).divideScalar(2),c.textPos=(new THREE.Vector3).addVectors(s,f).divideScalar(2),d.textBox=this.edgeInfo.textBox,c.textBox=this.edgeInfo.textBox1,(h=new THREE.Group).objectType="Group",h.subnum=0,h.add(this.edgeInfo.selLineObj),h.add(this.edgeInfo.startToClndLine),h.add(this.edgeInfo.endToClndLine),h.add(this.edgeInfo.fstClnd),h.add(this.edgeInfo.sndClnd),h.add(this.edgeInfo.clndToClndLine),this.edgeInfo.startToClndLine.radiusType="X",this.edgeInfo.endToClndLine.radiusType="X",this.edgeInfo.fstClnd.radiusType="X",this.edgeInfo.sndClnd.radiusType="X",this.edgeInfo.clndToClndLine.radiusType="X",h.add(this.edgeInfo.startToClndLine1),h.add(this.edgeInfo.endToClndLine1),h.add(this.edgeInfo.fstClnd1),h.add(this.edgeInfo.sndClnd1),h.add(this.edgeInfo.clndToClndLine1),this.edgeInfo.startToClndLine1.radiusType="Y",this.edgeInfo.endToClndLine1.radiusType="Y",this.edgeInfo.fstClnd1.radiusType="Y",this.edgeInfo.sndClnd1.radiusType="Y",this.edgeInfo.clndToClndLine1.radiusType="Y",this.OpMeasure.rootObject.add(h),NDSWebViewer.COMMON.isMobileDevice()?(d.textBox.addEventListener("touchstart",this.touchstart,!1),d.textBox.addEventListener("touchend",this.touchend,!1),d.textBox.addEventListener("touchmove",this.touchmove,!1),c.textBox.addEventListener("touchstart",this.touchstart,!1),c.textBox.addEventListener("touchend",this.touchend,!1),c.textBox.addEventListener("touchmove",this.touchmove,!1)):(d.textBox.addEventListener("mousedown",this.touchstart,!1),d.textBox.addEventListener("mouseup",this.touchend,!1),d.textBox.addEventListener("mousemove",this.touchmove,!1),d.textBox.addEventListener("mouseleave",this.mouseleave,!1),d.textBox.addEventListener("mouseenter",this.mouseenter,!1),c.textBox.addEventListener("mousedown",this.touchstart,!1),c.textBox.addEventListener("mouseup",this.touchend,!1),c.textBox.addEventListener("mousemove",this.touchmove,!1),c.textBox.addEventListener("mouseleave",this.mouseleave,!1),c.textBox.addEventListener("mouseenter",this.mouseenter,!1)),NDSWebViewer.COMMON.isMobileDevice()?(a.addEventListener("touchend",this.sectionCrossend,!1),l.addEventListener("touchend",this.sectionCrossend,!1)):(a.addEventListener("mousedown",this.sectionCrossend,!1),a.addEventListener("mouseleave",this.crossleave,!1),a.addEventListener("mouseenter",this.crossenter,!1),l.addEventListener("mousedown",this.sectionCrossend,!1),l.addEventListener("mouseleave",this.crossleave,!1),l.addEventListener("mouseenter",this.crossenter,!1)),(t={}).start=d.textPos.clone(),t.end=d.textPos.clone(),t.uuid=h.uuid+"X",(f={}).start=c.textPos.clone(),f.end=c.textPos.clone(),f.uuid=h.uuid+"Y",this.OpMeasure.textLines.push(t),d.textBox.setAttribute("mobile","up"),d.textBox.setAttribute("group",h.uuid),this.OpMeasure.currentUuid=h.uuid,d.textBox.setAttribute("type","length"),d.textBox.setAttribute("radiusType","X"),d.textBox.setAttribute("dimString",2*this.edgeInfo.selLineInfo.radiusX),d.textBox.setAttribute("dimStringPrefix",""),d.textBox.setAttribute("unit",this.getUnitString()),d.textBox.setAttribute("lineInfo",this.OpMeasure.textLines.length-1),this.OpMeasure.boxInfos.push(d),this.OpMeasure.textLines.push(f),c.textBox.setAttribute("mobile","up"),c.textBox.setAttribute("group",h.uuid),this.OpMeasure.currentUuid=h.uuid,c.textBox.setAttribute("type","length"),c.textBox.setAttribute("radiusType","Y"),c.textBox.setAttribute("dimString",2*this.edgeInfo.selLineInfo.radiusY),c.textBox.setAttribute("dimStringPrefix",""),c.textBox.setAttribute("unit",this.getUnitString()),c.textBox.setAttribute("lineInfo",this.OpMeasure.textLines.length-1),this.OpMeasure.boxInfos.push(c),this.OpMeasure.unsteadyData[h.uuid]=this.DeepCopy(this.edgeInfo,"ellipse"),this.OpMeasure.unsteadyData[h.uuid].startPos=s,this.OpMeasure.unsteadyData[h.uuid].fstClndPos=n,this.OpMeasure.unsteadyData[h.uuid].sndClndPos=i,this.OpMeasure.unsteadyData[h.uuid].midPosX=d.textPos.clone(),this.OpMeasure.unsteadyData[h.uuid].midPosY=c.textPos.clone(),this.getAndShowTextBox(d.textPos.clone(),o,this.edgeInfo.textBox),this.getAndShowTextBox(c.textPos.clone(),r,this.edgeInfo.textBox1),this.clearEdgeInfo(!0))},p.prototype.onLMouseClick=function(e,t,n){var i=new THREE.Vector3(e,t,0);this.measureEllipse(e,t,!1),this.update3DMeasureEllipseScene("false",i)},p.prototype.changeMeasureEllipse=function(e){let t=this.OpMeasure.unsteadyData[this.OpMeasure.unsteadyuuid],n=new THREE.Plane,i,s=(n.setFromCoplanarPoints(t.startPos,t.fstClndPos,t.sndClndPos),e&&(i=this.clientCoordToModelCoordOnPlane(e.x,e.y,n))&&(t.textPos=i),this.get2dPoint(t.textPos.clone())),o=void this.viewer.renderer.getPixelRatio();"Y"==this.OpMeasure.unsteadyTextBox.getAttribute("radiusType")?(r=this.get2dPoint(t.midPosY.clone()),o="Y"):"X"==this.OpMeasure.unsteadyTextBox.getAttribute("radiusType")&&(r=this.get2dPoint(t.midPosX.clone()),o="X");var r,e=new THREE.Vector2(s.x-r.x,s.y-r.y);e.normalize(),e.y>=e.x/2&&e.y>=-e.x/2?(this.OpMeasure.unsteadyTextBox.childNodes[1].style.left="calc(50% - 6px)",this.OpMeasure.unsteadyTextBox.childNodes[1].style.top="-5.5px",this.OpMeasure.unsteadyTextBox.setAttribute("mobile","down")):e.y>e.x/2&&e.y<-e.x/2?(this.OpMeasure.unsteadyTextBox.childNodes[1].style.left="calc(100% - 4px)",this.OpMeasure.unsteadyTextBox.childNodes[1].style.top="calc(50% - 5.5px)",this.OpMeasure.unsteadyTextBox.setAttribute("mobile","right")):e.y<e.x/2&&e.y<-e.x/2?(this.OpMeasure.unsteadyTextBox.childNodes[1].style.left="calc(50% - 6px)",this.OpMeasure.unsteadyTextBox.childNodes[1].style.top="calc(100% - 5.5px)",this.OpMeasure.unsteadyTextBox.setAttribute("mobile","up")):e.y<e.x/2&&e.y>-e.x/2&&(this.OpMeasure.unsteadyTextBox.childNodes[1].style.left="-5.5px",this.OpMeasure.unsteadyTextBox.childNodes[1].style.top="calc(50% - 5.5px)",this.OpMeasure.unsteadyTextBox.setAttribute("mobile","left"));for(var a=0;a<this.OpMeasure.boxInfos.length;a++){var l=this.OpMeasure.boxInfos[a];if(l.textBox.getAttribute("group")==this.OpMeasure.unsteadyuuid&&l.textBox.getAttribute("radiusType")==o){l.textPos=t.textPos;break}}for(a=0;a<this.OpMeasure.textLines.length;a++){var d=this.OpMeasure.textLines[a];if(d.uuid==this.OpMeasure.unsteadyuuid+o){d.start=t.textPos.clone(),"X"==o?d.end=t.midPosX.clone():d.end=t.midPosY.clone();break}}this.OpMeasure.viewer.render()};(S.prototype=Object.create(NDSWebViewer.OpBase.prototype)).getMeasureVisible=function(){return!!this.rootObject&&this.rootObject.visible},S.prototype.restrictMeasuretime=function(){var e=this.viewer.is2DModel?20:10;if(!this.viewer.is2DModel)for(;this.boxInfos.length>e;){var t=this.boxInfos[0].textBox.children[1];"sectionCross"==t.className&&this.MeasureOper.sectionCrossend.apply(t,[])}},S.prototype.setMeasureVisible=function(e){this.rootObject&&(this.rootObject.visible=e);let t=e?"block":"none";for(var n=0,i=this.boxInfos.length;n<i;n++){var s=this.boxInfos[n],o=s.textBox.getAttribute("group"),o=this.rootObject.getObjectByProperty("uuid",o);o&&(t=o.visible&&e?"block":"none"),s.textBox.style.display=t}},S.prototype.setMeasureVisibilityByUuid=function(t,n){if(this.rootObject&&0!=this.boxInfos.length){this.rootObject.getObjectByProperty("uuid",n).visible=t;for(let e=0;e<this.textLines.length;++e){var i=this.textLines[e];i.uuid!==n&&i.uuid!==n+"X"&&i.uuid!==n+"Y"||(i.visible=t)}for(var e=0;e<this.boxInfos.length;++e){var s=this.boxInfos[e];s.textBox.getAttribute("group")==n&&(s.textBox.style.display=this.rootObject.visible&&t?"block":"none")}}},S.prototype.release=function(){this.showMouseZoomArea=!1;for(var e=0;e<this.perimeterInfos.length;e++)this.viewer.removeIconFromContainer(this.perimeterInfos[e].textimg);this.perimeterInfos=[],this.MeasureOper.OperatorRelease(),this.clearZoomArea(),this.MeasureOper.update2DScene();var t=this.viewer.renderer.getPixelRatio();this.viewer.canvas2D.getContext("2d").clearRect(0,0,window.innerWidth*t,window.innerHeight*t),this.measureTimes=0,this.measureShowResult=!1,this.lineargauge3DProcessedLineSet=new Set,NDSWebViewer.SETTING.enableBroadcast&&!NDSWebViewer.SETTING.broadcastMajor&&this.viewer.dispatchEvent({type:"FaceSelectionChangeEvent"}),this.boundingboxmesh&&(this.rootObject.remove(this.boundingboxmesh),this.boundingboxmesh=null),this.textBoxBroadcast&&(this.viewer.container.removeChild(this.textBoxBroadcast),this.textBoxBroadcast=null,this.textPosBroadcast=null),this.viewer.outlinePass&&this.viewer.outlinePass.enabled&&(this.viewer.outlinePass.tempSelectedObjects.length=0),this.scene.remove(this.rootObject),this.rootObject=null;for(var n=0,i=this.boxInfos.length;n<i;n++){var s=this.boxInfos[n];this.viewer.container.removeChild(s.textBox),s.textPos=null,s.textBox=null}this.boxInfos.splice(0,this.boxInfos.length);for(n=0,i=this.boundingboxInfos.length;n<i;n++){s=this.boundingboxInfos[n];this.viewer.container.removeChild(s.textBox),s.textPos=null,s.textBox=null}this.boundingboxInfos.splice(0,this.boundingboxInfos.length),this.viewer.selectionManager.clearSelection(),this.textLines.length=0,this.update(),this.render(!1,!1),NDSWebViewer.OpBase.prototype.release.call(this)},S.prototype.clearFlag=function(){this.measureFlag=0},S.prototype.update=function(){NDSWebViewer.OpBase.prototype.update.call(this)},S.prototype.addmeasureTimes=function(){this.viewer.dispatchEvent({type:"measureTimes",times:this.measureTimes}),this.measureTimes++},S.prototype.getMeasureContentFromUuid=function(e){this.viewer.ndsModel.setActiveModel(0);for(var t={},n=null,i=e.length,s=0;s<this.textLines.length;++s)(m=this.textLines[s]).uuid.substring(0,i)==e.substring(0,i)&&(t.start?((n={}).start=m.start.clone(),n.end=m.end.clone(),n.uuid=m.uuid):(t.start=m.start.clone(),t.end=m.end.clone(),t.uuid=m.uuid));var o=this.unsteadyData[e],r=this.rootObject.getObjectByProperty("uuid",e);r.measureType=o.measureType;let a,l,d,c,h,f,I,u,p,S,g,E;for(var m,O,b,P,M,s=0;s<this.boxInfos.length;++s)(m=this.boxInfos[s]).textBox.getAttribute("group")==e&&(l=m.textBox.getAttribute("unit"),d=m.textBox.getAttribute("dimStringPrefix"),c=m.textBox.getAttribute("type"),h=m.textBox.getAttribute("group"),"ellipse"==r.measureType&&"Y"==m.textBox.getAttribute("radiusType")?(E=m.dimString,p=m.textBox.getAttribute("dimString"),S=m.textBox.getAttribute("lineInfo"),g=m.textPos,(P=this.viewer.modelUnit)!=l&&(M=this.viewer.getUnitTransfrom(P,l),p*=M)):(u=m.dimString,a=m.textBox.getAttribute("dimString"),f=m.textBox.getAttribute("lineInfo"),I=m.textPos,"length"==c?(P=this.viewer.modelUnit)!=l&&(M=this.viewer.getUnitTransfrom(P,l),""==a[0]?a=" "+a.slice(2)*M:a*=M,l=this.MeasureOper.getUnitStringmap(P)):"radius"==c&&(O=a.slice(0,2),b=a.slice(2),(P=this.viewer.modelUnit)!=l)&&(M=this.viewer.getUnitTransfrom(P,l),a=O+b*M,l=this.MeasureOper.getUnitStringmap(P))));var T=(r=this.rootObject.getObjectByProperty("uuid",e)).visible,x=[],y=this,C=t=>{switch(t.objectType){case"Line":"X"==t.radiusType?x.push(12):"Y"==t.radiusType?x.push(13):x.push(0),x.push(t.Start),x.push(t.End);break;case"Edge":x.push(1),x.push(t.Start),x.push(t.End);break;case"CircleLine":x.push(2),x.push(t.Start),x.push(t.Mid),x.push(t.End);break;case"Cylinder":"X"==t.radiusType?x.push(14):"Y"==t.radiusType?x.push(15):x.push(3),x.push(t.Start),x.push(t.End),x.push(t.position),x.push(t.oldPosition),x.push(t.offsetPos),x.push(new THREE.Vector3(t.material.color.r,t.material.color.g,t.material.color.b));break;case"Point":x.push(4);let e=0;t.material.color.equals(y.MeasureOper.materialProjectPoint.color)&&(e=1),x.push(e),x.push(t.Point);break;case"Face":x.push(5);var n=t.FaceInfo.concat(),i=y.viewer.ndsModel.getBodyNode(n[0]);i&&(n[0]=i.uuid,n[1]=y.viewer.ndsModel.geomManager.geoms[n[1]].uuid,x=x.concat(n));break;case"AxisLine":x.push(6),x.push(t.Start),x.push(t.End);break;case"SelLine":x.push(7);i=t.LineInfo.concat(),n=y.viewer.ndsModel.getBodyNode(i[0]);n&&(i[0]=n.uuid,i[1]=y.viewer.ndsModel.geomManager.geoms[i[1]].uuid,x=x.concat(i));break;case"Group":x.push(10),x.push(t.uuid),"Group"==t.parent.objectType&&"unsteady"==t.name?x.push(1):x.push(0);for(var s=0;s<t.children.length;++s)C(t.children[s]);break;case"EllipseLine":x.push(11);for(s=0;s<t.LineInfo.length;++s)x.push(t.LineInfo[s])}},T=(C(r),{measureId:e,measureType:this.measureType,visible:T,measureNumResult:void 0===a?NaN:Number(""==a[0]||"R"==a[0]?a.slice(2):a).toFixed(8),defaultUnit:l,configNum:this.viewer.ConfigNum,configName:this.viewer.ConfigName,measureContent:{measureObject:x,unsteadyData:o,lineInfo:t,dimString:a,unit:l,dimStringPrefix:d,type:c,groupUuid:h,lineInfoIndex:f,textPos:I,textBoxInnerHTML:u}});return"ellipse"==r.measureType&&(T.measureContent.lineInfo1=n,T.measureContent.dimString1=p,T.measureContent.lineInfoIndex1=S,T.measureContent.textPos1=g,T.measureContent.textBoxInnerHTML1=E,T.measureNumResult1=Number(p).toFixed(8)),T},S.prototype.measureEnd=function(){this.setMeasureDisplayUnit(),this.viewer.is2DModel||this.viewer.dispatchEvent({type:"measureChangeEvent",measureType:"add",data:this.getMeasureContentFromUuid(this.currentUuid)})},S.prototype.setMeasuringDecimal=function(){this.setMeasureDisplayUnit(),this.render(!0)},S.prototype.submeasureTimes=function(){this.viewer.dispatchEvent({type:"measureTimes",times:this.measureTimes}),this.measureTimes--},S.prototype.onNMouseMove=function(e){var t=this.MeasureOper.getViewClientCoords(e),n=t.x,t=t.y,i=this.remapCoordnidateToFullView(n,t);if(n=i[0],t=i[1],this.prompt&&!NDSWebViewer.COMMON.isMobileDevice()&&(0<this.InfoType?this.prompt.style.display="block":this.prompt.style.display="none",this.viewer.renderer.getPixelRatio(),this.prompt.style.left=e.clientX+16+"px",this.prompt.style.top=e.clientY+18+"px"),this.unsteady){var s,n=this.pointer.x,t=this.pointer.y;switch(this.unsteadyType){case"bodyDistance":(s=new o(this)).measureType="bodyDistance";break;case"Distance":s=new o(this);break;case"Radius":(s=new r(this)).measureType="radius";break;case"bodyEdgeLength":(s=new a(this)).measureType="bodyEdgeLength";break;case"measureEdges":(s=new a(this)).measureType="measureEdges";break;case"bodyAngle":(s=new l(this)).measureType="bodyAngle";break;case"Angle":(s=new l(this)).measureType="LineAngle";break;case"FaceAngle":(s=new l(this)).measureType="faceAngle";break;case"Lineargauge3D":(s=new I(this)).measureType="Lineargauge3D";break;case"WallThickness":(s=new u(this)).measureType="WallThickness";break;case"ellipse":(s=new p(this)).measureType="ellipse"}s.onNMouseMove(n,t),this.render(!0)}else this.MeasureOper.InfoType&&this.InfoType==NDS.INFOTYPE.BREPDATAERROR&&this.PostInfo(this.MeasureOper.InfoType),this.MeasureOper.onNMouseMove(n,t),this.dispatchEvent({type:"render",forceRenderAll:!0,needBroadcast:!1})},S.prototype.onLMouseClick=function(e){if(10==this.measureTimes&&NDSWebViewer.SETTING.enableBroadcast&&!this.viewer.is2DModel&&"faceArea"!=this.measureType&&"BodyArea"!=this.measureType&&"BodyVolume"!=this.measureType)this.viewer.dispatchEvent({type:"measureTimes",times:this.measureTimes});else{if(20==this.measureTimes&&NDSWebViewer.SETTING.enableBroadcast&&this.viewer.is2DModel&&"faceArea"!=this.measureType&&"BodyArea"!=this.measureType&&"BodyVolume"!=this.measureType){if(this.viewer.dispatchEvent({type:"measureTimes",times:this.measureTimes}),"coordinate"==this.measureType||this.measureShowResult)return;this.measureShowResult=!0}else this.measureShowResult=!1;var t,n;e.preventDefault(),!this.viewer.hasBrepInfo()&&this.measureType&&"pt2pt"!=this.measureType&&"angle"!=this.measureType&&"LmPt2Pt"!=this.measureType&&"pt2ptbim"!=this.measureType&&"BoundingBox"!=this.measureType&&"bodyBoundingBox"!=this.measureType?(this.PostInfo(NDSWebViewer.NDS.INFOTYPE.NOBREP),this.render(!0,!1)):(t=this.MeasureOper.getViewClientCoords(e),n=this.remapCoordnidateToFullView(t.x,t.y),t.x=n[0],t.y=n[1],this.click=!0,this.MeasureOper.onLMouseClick(t.x,t.y,e.ctrlKey),this.isInMeasure()&&"coordinate"!=this.measureType?this.dispatchEvent({type:"render",forceRenderAll:!0,onlyUpdateActiveView:!1,needBroadcast:!0}):this.render(!0,!1))}},S.prototype.onLMouseDbClick=function(){"contour"!=this.MeasureOper.measureType&&"contourarea"!=this.MeasureOper.measureType||this.MeasureOper.d()},S.prototype.onLMouseUp=function(e){this.state=-1,NDSWebViewer.SETTING.enableDirectMove&&!this.viewer.isExploded()&&this.onTransformFinish()},S.prototype.onTouchDoubleEnd=function(e){e.preventDefault(),NDSWebViewer.OpBase.prototype.onTouchDoubleEnd.call(this,e),this.getZoomAreaVisible()&&(this.invisible(),this.MeasureOper)&&this.MeasureOper.clearPreSelect(),clearTimeout(this.timeOutEvent),this.timeOutEvent=0,this.longClick=0},S.prototype.onTouchSingleEnd=function(e){var t,n;this.hideRotateCenterHelper(),e.preventDefault(),this.lineargaugediv&&"block"==this.lineargaugediv.style.display||(10==this.measureTimes&&NDSWebViewer.SETTING.enableBroadcast?this.viewer.dispatchEvent({type:"measureTimes",times:this.measureTimes}):(e=this.singleTouchEndPos.x,t=this.singleTouchEndPos.y,n=Date.now()-this.touchStartTime,!this.viewer.hasBrepInfo()&&this.measureType&&"pt2pt"!=this.measureType&&"pt2ptbim"!=this.measureType&&"LmPt2Pt"!=this.measureType&&"angle"!=this.measureType&&"BoundingBox"!=this.measureType?(this.PostInfo(NDSWebViewer.NDS.INFOTYPE.NOBREP),clearTimeout(this.timeOutEvent),this.timeOutEvent=0,this.longClick=0):((1==this.longClick||n<500&&Math.abs(this.singleTouchStartPos.x-this.singleTouchEndPos.x)<3&&Math.abs(this.singleTouchStartPos.y-this.singleTouchEndPos.y)<3)&&(this.hasMouseZoomArea&&1==this.longClick&&(t-=this.pixWidth/2),this.MeasureOper.onLMouseClick(e,t,!1),this.render(),this.invisible(),this.MeasureOper.clearCoordinate()),clearTimeout(this.timeOutEvent),this.timeOutEvent=0,this.longClick=0,this.debounceStop=!0)))},S.prototype.onTouchDoubleStart=function(e){e.preventDefault(),NDSWebViewer.OpBase.prototype.onTouchDoubleStart.call(this,e),clearTimeout(this.timeOutEvent),this.timeOutEvent=0,this.longClick=0},S.prototype.onTouchSingleStart=function(e){var t;this.lineargaugediv&&"block"==this.lineargaugediv.style.display||(NDSWebViewer.OpBase.prototype.onTouchSingleStart.call(this,e),(t=this).longClick=0,this.hasMouseZoomArea?this.createMouseZoomArea():t.createZoomArea(),NDSWebViewer.SETTING.inBIMContext||(this.timeOutEvent=setTimeout(function(){t.longClick=1,t.hasMouseZoomArea?t.changeMouseZoomArea(!0):t.changeZoomArea(!0)},500)),this.touchStartTime=Date.now())},S.prototype.onTouchDoubleMove=function(e){NDSWebViewer.OpBase.prototype.onTouchDoubleMove.call(this,e),clearTimeout(this.timeOutEvent),this.timeOutEvent=0,this.longClick=0},S.prototype.onTouchSingleMove=function(e){var t=Date.now()-this.touchStartTime;if(t<500&&(3<Math.abs(this.pointer.x-this.singleTouchStartPos.x)||3<Math.abs(this.pointer.y-this.singleTouchStartPos.y))&&(clearTimeout(this.timeOutEvent),this.timeOutEvent=0),0!=this.longClick||!(Math.abs(this.pointer.x-this.singleTouchStartPos.x)<3||Math.abs(this.pointer.y-this.singleTouchStartPos.y)<3))if(0==this.longClick)if(this.invisible(),this.MeasureOper.clearCoordinate(),this.unsteady){var n,t=this.pointer.x,i=this.pointer.y;switch(this.unsteadyType){case"bodyDistance":(n=new o(this)).measureType="bodyDistance";break;case"Distance":n=new o(this);break;case"Radius":(n=new r(this)).measureType="radius";break;case"bodyEdgeLength":(n=new a(this)).measureType="bodyEdgeLength";break;case"measureEdges":(n=new a(this)).measureType="measureEdges";break;case"bodyAngle":(n=new l(this)).measureType="bodyAngle";break;case"Angle":(n=new l(this)).measureType="LineAngle";break;case"FaceAngle":(n=new l(this)).measureType="faceAngle";break;case"Lineargauge3D":(n=new I(this)).measureType="Lineargauge3D";break;case"WallThickness":(n=new u(this)).measureType="WallThickness"}n.onNMouseMove(t,i)}else NDSWebViewer.OpBase.prototype.onTouchSingleMove.call(this,e);else this.debounceStop=!1,this.hasMouseZoomArea?(this.debounceTouchSinglemove2(),this.changeMouseZoomArea()):(this.debounceTouchSinglemove(),this.changeZoomArea())},S.prototype.PostInfo=function(e){if(this.prompt)if(!e||this.MeasureOper.hasMeasured()&&NDSWebViewer.COMMON.isMobileDevice()&&e<=NDSWebViewer.NDS.INFOTYPE.MEASURENOTICEBEGIN)this.InfoType=0,this.prompt.style.display="none",this.prompt.innerHTML="";else{this.Popup&&(clearTimeout(this.Popup),this.Popup=null),this.InfoType=e;var t,n="",i=(NDSWebViewer.COMMON.getLanguage(),22);if(NDSWebViewer.COMMON.isMobileDevice()&&(i=42),this.prompt.removeAttribute("height"),this.prompt.style.height="",NDSWebViewer.COMMON.isMobileDevice())switch(e){case NDSWebViewer.NDS.INFOTYPE.POINT:n=NDSWebViewer.COMMON.translateString("MEASURE_APP_POINT");break;case NDSWebViewer.NDS.INFOTYPE.MOUSEENTER:n=NDSWebViewer.COMMON.translateString("MEASURE_APP_MOUSEENTER");break;case NDSWebViewer.NDS.INFOTYPE.THIRDPOINT:n=NDSWebViewer.COMMON.translateString("MEASURE_APP_THIRDPOINT");break;case NDSWebViewer.NDS.INFOTYPE.COORDINATEPOINT:n=NDSWebViewer.COMMON.translateString("MEASURE_APP_COORDINATEPOINT");break;case NDSWebViewer.NDS.INFOTYPE.CROSSENTER:n=NDSWebViewer.COMMON.translateString("MEASURE_APP_CROSSENTER");break;case NDSWebViewer.NDS.INFOTYPE.SECONDPOINT:n=NDSWebViewer.COMMON.translateString("MEASURE_APP_SECONDPOINT");break;case NDSWebViewer.NDS.INFOTYPE.POINTLINE:n=NDSWebViewer.COMMON.translateString("MEASURE_APP_POINTLINE");break;case NDSWebViewer.NDS.INFOTYPE.LINE:n=NDSWebViewer.COMMON.translateString("MEASURE_APP_LINE");break;case NDSWebViewer.NDS.INFOTYPE.POINTPLANE:n=NDSWebViewer.COMMON.translateString("MEASURE_APP_POINTPLANE");break;case NDSWebViewer.NDS.INFOTYPE.PLANE:n=NDSWebViewer.COMMON.translateString("MEASURE_APP_PLANE");break;case NDSWebViewer.NDS.INFOTYPE.FIRSTLINE:n=NDSWebViewer.COMMON.translateString("MEASURE_APP_FIRSTLINE");break;case NDSWebViewer.NDS.INFOTYPE.LINEANDCIRCLE:n=NDSWebViewer.COMMON.translateString("MEASURE_APP_LINEANDCIRCLE");break;case NDSWebViewer.NDS.INFOTYPE.SECONDLINE:n=NDSWebViewer.COMMON.translateString("MEASURE_APP_SECONDLINE");break;case NDSWebViewer.NDS.INFOTYPE.ENDMEASURE:n="";break;case NDSWebViewer.NDS.INFOTYPE.LINEPLANE:n=NDSWebViewer.COMMON.translateString("MEASURE_APP_LINEPLANE");break;case NDSWebViewer.NDS.INFOTYPE.FIRSTPLANE:n=NDSWebViewer.COMMON.translateString("MEASURE_APP_FIRSTPLANE");break;case NDSWebViewer.NDS.INFOTYPE.PARALLELLINE:n=NDSWebViewer.COMMON.translateString("MEASURE_APP_PARALLELLINE");break;case NDSWebViewer.NDS.INFOTYPE.PARALLELPLANE:n=NDSWebViewer.COMMON.translateString("MEASURE_APP_PARALLELPLANE");break;case NDSWebViewer.NDS.INFOTYPE.FIRSTPARALLELPLANE:n=NDSWebViewer.COMMON.translateString("MEASURE_APP_FIRSTPARALLELPLANE");break;case NDSWebViewer.NDS.INFOTYPE.CIRCLE:n=this.viewer.is2DModel?NDSWebViewer.COMMON.translateString("MEASURE_APP_2D_CIRCLE"):NDSWebViewer.COMMON.translateString("MEASURE_APP_CIRCLE");break;case NDSWebViewer.NDS.INFOTYPE.SECONDCIRCLE:n=this.viewer.is2DModel?NDSWebViewer.COMMON.translateString("MEASURE_APP_2D_SECONDCIRCLE"):NDSWebViewer.COMMON.translateString("MEASURE_APP_SECONDCIRCLE");break;case NDSWebViewer.NDS.INFOTYPE.CIRCLEA:n=this.viewer.is2DModel?NDSWebViewer.COMMON.translateString("MEASURE_APP_2D_CIRCLEA"):NDSWebViewer.COMMON.translateString("MEASURE_APP_CIRCLEA");break;case NDSWebViewer.NDS.INFOTYPE.SECONDPLANE:n=NDSWebViewer.COMMON.translateString("MEASURE_APP_SECONDPLANE");break;case NDSWebViewer.NDS.INFOTYPE.AXISLINE:n=this.viewer.is2DModel?NDSWebViewer.COMMON.translateString("MEASURE_APP_2D_AXISLINE"):NDSWebViewer.COMMON.translateString("MEASURE_APP_AXISLINE");break;case NDSWebViewer.NDS.INFOTYPE.AXISPOINT:n=this.viewer.is2DModel?NDSWebViewer.COMMON.translateString("MEASURE_APP_2D_AXISPOINT"):NDSWebViewer.COMMON.translateString("MEASURE_APP_AXISPOINT");break;case NDSWebViewer.NDS.INFOTYPE.AXIS:n=NDSWebViewer.COMMON.translateString("MEASURE_APP_AXIS");break;case NDSWebViewer.NDS.INFOTYPE.AXISPLANE:n=NDSWebViewer.COMMON.translateString("MEASURE_APP_AXISPLANE");break;case NDSWebViewer.NDS.INFOTYPE.FACE:n=NDSWebViewer.COMMON.translateString("MEASURE_APP_FACE");break;case NDSWebViewer.NDS.INFOTYPE.CIRCLEANDLINE:n=NDSWebViewer.COMMON.translateString("MEASURE_APP_CIRCLEANDLINE");break;case NDSWebViewer.NDS.INFOTYPE.FIRSTPOINT:n=NDSWebViewer.COMMON.translateString("MEASURE_APP_FIRSTPOINT");break;case NDSWebViewer.NDS.INFOTYPE.BODY:n=NDSWebViewer.COMMON.translateString("MEASURE_APP_BODY");break;case NDSWebViewer.NDS.INFOTYPE.LINEPOSITION:n=NDSWebViewer.COMMON.translateString("MEASURE_APP_LINEPOSITION");break;case NDSWebViewer.NDS.INFOTYPE.LINENOPARALLEL:n=NDSWebViewer.COMMON.translateString("MEASURE_APP_LINENOPARALLEL");break;case NDSWebViewer.NDS.INFOTYPE.PLANENOPARALLEL:n=NDSWebViewer.COMMON.translateString("MEASURE_APP_PLANENOPARALLEL");break;case NDSWebViewer.NDS.INFOTYPE.NOTFACE:n=NDSWebViewer.COMMON.translateString("MEASURE_APP_NOTFACE");break;case NDSWebViewer.NDS.INFOTYPE.NOTFACEPARALLEL:n=NDSWebViewer.COMMON.translateString("MEASURE_APP_NOTFACEPARALLEL");break;case NDSWebViewer.NDS.INFOTYPE.AXISNOPARALLEL:n=NDSWebViewer.COMMON.translateString("MEASURE_APP_AXISNOPARALLEL");break;case NDSWebViewer.NDS.INFOTYPE.NOBREP:n=NDSWebViewer.COMMON.translateString("MEASURE_APP_NOBREP");break;case NDSWebViewer.NDS.INFOTYPE.NOPARALLEL:n=NDSWebViewer.COMMON.translateString("MEASURE_APP_NOPARALLEL");break;case NDSWebViewer.NDS.INFOTYPE.NOTFACESECOND:n=NDSWebViewer.COMMON.translateString("MEASURE_APP_NOTFACESECOND");break;case NDSWebViewer.NDS.INFOTYPE.INTERSECT:n=NDSWebViewer.COMMON.translateString("MEASURE_APP_INTERSECT");break;case NDSWebViewer.NDS.INFOTYPE.LINEPARALLEL:n=NDSWebViewer.COMMON.translateString("MEASURE_APP_LINEPARALLEL");break;case NDSWebViewer.NDS.INFOTYPE.PLANEPARALLELLINE:n=NDSWebViewer.COMMON.translateString("MEASURE_APP_PLANEPARALLELLINE");break;case NDSWebViewer.NDS.INFOTYPE.LINEPARALLELPLANE:n=NDSWebViewer.COMMON.translateString("MEASURE_APP_LINEPARALLELPLANE");break;case NDSWebViewer.NDS.INFOTYPE.PLANEPARALLEL:n=NDSWebViewer.COMMON.translateString("MEASURE_APP_PLANEPARALLEL");break;case NDSWebViewer.NDS.INFOTYPE.TWOAXISNOPARALLEL:n=NDSWebViewer.COMMON.translateString("MEASURE_APP_TWOAXISNOPARALLEL");break;case NDSWebViewer.NDS.INFOTYPE.NOCONJOINT:n=NDSWebViewer.COMMON.translateString("MEASURE_APP_NOCONJOINT");break;case NDSWebViewer.NDS.INFOTYPE.NOCLOSE:n=NDSWebViewer.COMMON.translateString("MEASURE_APP_NOCLOSE");break;case NDSWebViewer.NDS.INFOTYPE.FIRMEASUREBODY:n=NDSWebViewer.COMMON.translateString("MEASURE_APP_FIRMEASUREBODY");break;case NDSWebViewer.NDS.INFOTYPE.SECMEASUREBODY:n=NDSWebViewer.COMMON.translateString("MEASURE_APP_SECMEASUREBODY");break;case NDSWebViewer.NDS.INFOTYPE.MEASUREBODY:n=NDSWebViewer.COMMON.translateString("MEASURE_APP_MEASUREBODY");break;case NDSWebViewer.NDS.INFOTYPE.TWOBODYPARALLEL:n=NDSWebViewer.COMMON.translateString("MEASURE_APP_TWOBODYPARALLEL");break;case NDSWebViewer.NDS.INFOTYPE.TWOBODYNOTPARALLEL:n=NDSWebViewer.COMMON.translateString("MEASURE_APP_TWOBODYNOTPARALLEL");break;case NDSWebViewer.NDS.INFOTYPE.LOADDATE:n=NDSWebViewer.COMMON.translateString("MEASURE_APP_LOADDATE");break;case NDSWebViewer.NDS.INFOTYPE.CLICKFIRSTPOINT:n=NDSWebViewer.COMMON.translateString("MEASURE_APP_CLICKFIRSTPOINT");break;case NDSWebViewer.NDS.INFOTYPE.CLICKSECONDPOINT:n=NDSWebViewer.COMMON.translateString("MEASURE_APP_CLICKSECONDPOINT");break;case NDSWebViewer.NDS.INFOTYPE.PROJECTPLANE:n=NDSWebViewer.COMMON.translateString("MEASURE_APP_PROJECTPLANE");break;case NDSWebViewer.NDS.INFOTYPE.SELECTPROJECTPLANE:n=NDSWebViewer.COMMON.translateString("MEASURE_APP_SELECTPROJECTPLANE");break;case NDSWebViewer.NDS.INFOTYPE.PLACELINELOCATION:n=NDSWebViewer.COMMON.translateString("MEASURE_APP_PLACELINELOCATION");break;case NDSWebViewer.NDS.INFOTYPE.SELECTPLACELINELOCATION:n=NDSWebViewer.COMMON.translateString("MEASURE_APP_SELECTPLACELINELOCATION");break;case NDSWebViewer.NDS.INFOTYPE.FIRSTMESH:n=NDSWebViewer.COMMON.translateString("MEASURE_APP_FIRSTMESH");break;case NDSWebViewer.NDS.INFOTYPE.SECONDMESH:n=NDSWebViewer.COMMON.translateString("MEASURE_APP_SECONDMESH");break;case NDSWebViewer.NDS.INFOTYPE.MESHVERTICAL:n=NDSWebViewer.COMMON.translateString("MEASURE_APP_MESHVERTICAL");break;case NDSWebViewer.NDS.INFOTYPE.AXISNOPARALLELLINE:n=`<div class = 'yellowdiv'>${NDSWebViewer.COMMON.translateString("MEASURE_APP_AXISNOPARALLELLINE_1")}</div><div class = 'blackdiv'>${NDSWebViewer.COMMON.translateString("MEASURE_APP_AXISNOPARALLELLINE_2")}</div>`,this.prompt.style.height=2*i+"px";break;case NDSWebViewer.NDS.INFOTYPE.NOBREPNOPLNE:n=NDSWebViewer.COMMON.translateString("MEASURE_APP_NOBREPNOPLNE");break;case NDS.INFOTYPE.BREPDATAERROR:n=NDSWebViewer.COMMON.translateString("MEASURE_APP_BREPDATAERROR")}else switch(e){case NDSWebViewer.NDS.INFOTYPE.POINT:n=NDSWebViewer.COMMON.translateString("MEASURE_POINT");break;case NDSWebViewer.NDS.INFOTYPE.COORDINATEPOINT:n=NDSWebViewer.COMMON.translateString("MEASURE_COORDINATEPOINT");break;case NDSWebViewer.NDS.INFOTYPE.SECONDPOINT:n=NDSWebViewer.SETTING.inBIMContext?NDSWebViewer.COMMON.translateString("MEASURE_BIM_SECONDPOINT"):NDSWebViewer.COMMON.translateString("MEASURE_SECONDPOINT");break;case NDSWebViewer.NDS.INFOTYPE.THIRDPOINT:n=NDSWebViewer.SETTING.inBIMContext?NDSWebViewer.COMMON.translateString("MEASURE_BIM_THIRDPOINT"):NDSWebViewer.COMMON.translateString("MEASURE_THIRDPOINT");break;case NDSWebViewer.NDS.INFOTYPE.POINTLINE:n=NDSWebViewer.COMMON.translateString("MEASURE_POINTLINE");break;case NDSWebViewer.NDS.INFOTYPE.LINE:n=NDSWebViewer.COMMON.translateString("MEASURE_LINE");break;case NDSWebViewer.NDS.INFOTYPE.LINEANDCIRCLE:n=NDSWebViewer.COMMON.translateString("MEASURE_LINEANDCIRCLE");break;case NDSWebViewer.NDS.INFOTYPE.POINTPLANE:n=NDSWebViewer.COMMON.translateString("MEASURE_POINTPLANE");break;case NDSWebViewer.NDS.INFOTYPE.PLANE:n=NDSWebViewer.COMMON.translateString("MEASURE_PLANE");break;case NDSWebViewer.NDS.INFOTYPE.FIRSTLINE:n=NDSWebViewer.COMMON.translateString("MEASURE_FIRSTLINE");break;case NDSWebViewer.NDS.INFOTYPE.SECONDLINE:n=NDSWebViewer.COMMON.translateString("MEASURE_SECONDLINE");break;case NDSWebViewer.NDS.INFOTYPE.LINEPLANE:n=NDSWebViewer.COMMON.translateString("MEASURE_LINEPLANE");break;case NDSWebViewer.NDS.INFOTYPE.PARALLELLINE:n=NDSWebViewer.COMMON.translateString("MEASURE_PARALLELLINE");break;case NDSWebViewer.NDS.INFOTYPE.FIRSTPARALLELPLANE:n=NDSWebViewer.COMMON.translateString("MEASURE_FIRSTPARALLELPLANE");break;case NDSWebViewer.NDS.INFOTYPE.PARALLELPLANE:n=NDSWebViewer.COMMON.translateString("MEASURE_PARALLELPLANE");break;case NDSWebViewer.NDS.INFOTYPE.CIRCLEBEGIN:n=NDSWebViewer.COMMON.translateString("MEASURE_FIRSTCENTERAXIS");break;case NDSWebViewer.NDS.INFOTYPE.CIRCLECYLINDER:n=NDSWebViewer.COMMON.translateString("MEASURE_SECONDCENTERAXIS");break;case NDSWebViewer.NDS.INFOTYPE.CIRCLECENTER:n=NDSWebViewer.COMMON.translateString("MEASURE_SECONDCENTER");break;case NDSWebViewer.NDS.INFOTYPE.CIRCLEA:n=this.viewer.is2DModel?NDSWebViewer.COMMON.translateString("MEASURE_2D_CIRCLEA"):NDSWebViewer.COMMON.translateString("MEASURE_CIRCLEA");break;case NDSWebViewer.NDS.INFOTYPE.SECONDCIRCLE:n=this.viewer.is2DModel?NDSWebViewer.COMMON.translateString("MEASURE_2D_SECONDCIRCLE"):NDSWebViewer.COMMON.translateString("MEASURE_SECONDCIRCLE");break;case NDSWebViewer.NDS.INFOTYPE.SECONDPLANE:n=NDSWebViewer.COMMON.translateString("MEASURE_SECONDPLANE");break;case NDSWebViewer.NDS.INFOTYPE.FIRSTPLANE:n=NDSWebViewer.COMMON.translateString("MEASURE_FIRSTPLANE");break;case NDSWebViewer.NDS.INFOTYPE.AXISLINE:n=this.viewer.is2DModel?NDSWebViewer.COMMON.translateString("MEASURE_2D_AXISLINE"):NDSWebViewer.COMMON.translateString("MEASURE_AXISLINE");break;case NDSWebViewer.NDS.INFOTYPE.AXISPOINT:n=this.viewer.is2DModel?NDSWebViewer.COMMON.translateString("MEASURE_2D_AXISPOINT"):NDSWebViewer.COMMON.translateString("MEASURE_AXISPOINT");break;case NDSWebViewer.NDS.INFOTYPE.AXIS:n=NDSWebViewer.COMMON.translateString("MEASURE_AXIS");break;case NDSWebViewer.NDS.INFOTYPE.AXISPLANE:n=NDSWebViewer.COMMON.translateString("MEASURE_AXISPLANE");break;case NDSWebViewer.NDS.INFOTYPE.FACE:n=NDSWebViewer.COMMON.translateString("MEASURE_FACE");break;case NDSWebViewer.NDS.INFOTYPE.CIRCLEANDLINE:n=`<div class = 'blackdiv'>${NDSWebViewer.COMMON.translateString("MEASURE_CIRCLEANDLINE_1")}</div><div class = 'whitediv'>${NDSWebViewer.COMMON.translateString("MEASURE_CIRCLEANDLINE_2")}</div>`,this.prompt.style.height=2*i+"px";break;case NDSWebViewer.NDS.INFOTYPE.FIRSTPOINT:n=NDSWebViewer.SETTING.inBIMContext?NDSWebViewer.COMMON.translateString("MEASURE_FIRSTPOINT_BIM"):NDSWebViewer.COMMON.translateString("MEASURE_FIRSTPOINT");break;case NDSWebViewer.NDS.INFOTYPE.BODY:n=NDSWebViewer.COMMON.translateString("MEASURE_BODY");break;case NDSWebViewer.NDS.INFOTYPE.LINEPOSITION:n=NDSWebViewer.COMMON.translateString("MEASURE_LINEPOSITION");break;case NDSWebViewer.NDS.INFOTYPE.ENDMEASURE:n=NDSWebViewer.COMMON.translateString("MEASURE_ENDMEASURE");break;case NDSWebViewer.NDS.INFOTYPE.CANCELLINE:n=`<div class = 'blackdiv'>${NDSWebViewer.COMMON.translateString("MEASURE_CANCELLINE_1")}</div><div class = 'whitediv'>${NDSWebViewer.COMMON.translateString("MEASURE_CANCELLINE_2")}</div>`,this.prompt.style.height=2*i+"px";break;case NDSWebViewer.NDS.INFOTYPE.LINENOPARALLEL:n=`<div class = 'yellowdiv'>${NDSWebViewer.COMMON.translateString("MEASURE_LINENOPARALLEL_1")}</div><div class = 'blackdiv'>${NDSWebViewer.COMMON.translateString("MEASURE_LINENOPARALLEL_2")}</div>`,this.prompt.style.height=2*i+"px";break;case NDSWebViewer.NDS.INFOTYPE.PLANENOPARALLEL:n=`<div class = 'yellowdiv'>${NDSWebViewer.COMMON.translateString("MEASURE_PLANENOPARALLEL_1")}</div><div class = 'blackdiv'>${NDSWebViewer.COMMON.translateString("MEASURE_PLANENOPARALLEL_2")}</div>`,this.prompt.style.height=2*i+"px";break;case NDSWebViewer.NDS.INFOTYPE.NOTFACE:n=`<div class = 'yellowdiv'>${NDSWebViewer.COMMON.translateString("MEASURE_NOTFACE_1")}</div><div class = 'blackdiv'>${NDSWebViewer.COMMON.translateString("MEASURE_NOTFACE_2")}</div>`,this.prompt.style.height=2*i+"px";break;case NDSWebViewer.NDS.INFOTYPE.NOTFACESECOND:n=`<div class = 'yellowdiv'>${NDSWebViewer.COMMON.translateString("MEASURE_NOTFACESECOND_1")}</div><div class = 'blackdiv'>${NDSWebViewer.COMMON.translateString("MEASURE_NOTFACESECOND_2")}</div>`,this.prompt.style.height=2*i+"px";break;case NDSWebViewer.NDS.INFOTYPE.NOTFACEPARALLEL:n=`<div class = 'yellowdiv'>${NDSWebViewer.COMMON.translateString("MEASURE_NOTFACEPARALLEL_1")}</div><div class = 'blackdiv'>${NDSWebViewer.COMMON.translateString("MEASURE_NOTFACEPARALLEL_2")}</div>`,this.prompt.style.height=2*i+"px";break;case NDSWebViewer.NDS.INFOTYPE.AXISNOPARALLEL:n=`<div class = 'yellowdiv'>${NDSWebViewer.COMMON.translateString("MEASURE_AXISNOPARALLEL_1")}</div><div class = 'blackdiv'>${NDSWebViewer.COMMON.translateString("MEASURE_AXISNOPARALLEL_2")}</div>`,this.prompt.style.height=2*i+"px";break;case NDSWebViewer.NDS.INFOTYPE.MOUSEENTER:n=NDSWebViewer.COMMON.translateString("MEASURE_MOUSEENTER");break;case NDSWebViewer.NDS.INFOTYPE.CROSSENTER:n=NDSWebViewer.COMMON.translateString("MEASURE_CROSSENTER");break;case NDSWebViewer.NDS.INFOTYPE.NOBREP:n=NDSWebViewer.COMMON.translateString("MEASURE_NOBREP");break;case NDSWebViewer.NDS.INFOTYPE.NOPARALLEL:n=NDSWebViewer.COMMON.translateString("MEASURE_NOPARALLEL");break;case NDSWebViewer.NDS.INFOTYPE.INTERSECT:n=`<div class = 'yellowdiv'>${NDSWebViewer.COMMON.translateString("MEASURE_INTERSECT_1")}</div><div class = 'blackdiv'>${NDSWebViewer.COMMON.translateString("MEASURE_INTERSECT_2")}</div>`,this.prompt.style.height=2*i+"px";break;case NDSWebViewer.NDS.INFOTYPE.LINEPARALLEL:n=`<div class = 'yellowdiv'>${NDSWebViewer.COMMON.translateString("MEASURE_LINEPARALLEL_1")}</div><div class = 'blackdiv'>${NDSWebViewer.COMMON.translateString("MEASURE_LINEPARALLEL_2")}</div>`,this.viewer.is2DModel&&(n=`<div class = 'yellowdiv'>${NDSWebViewer.COMMON.translateString("MEASURE_LINEPARALLEL_2D_1")}</div><div class = 'blackdiv'>${NDSWebViewer.COMMON.translateString("MEASURE_LINEPARALLEL_2D_2")}</div>`),this.prompt.style.height=2*i+"px";break;case NDSWebViewer.NDS.INFOTYPE.PLANEPARALLELLINE:n=`<div class = 'yellowdiv'>${NDSWebViewer.COMMON.translateString("MEASURE_PLANEPARALLELLINE_1")}</div><div class = 'blackdiv'>${NDSWebViewer.COMMON.translateString("MEASURE_PLANEPARALLELLINE_2")}</div>`,this.prompt.style.height=2*i+"px";break;case NDSWebViewer.NDS.INFOTYPE.LINEPARALLELPLANE:n=`<div class = 'yellowdiv'>${NDSWebViewer.COMMON.translateString("MEASURE_LINEPARALLELPLANE_1")}</div><div class = 'blackdiv'>${NDSWebViewer.COMMON.translateString("MEASURE_LINEPARALLELPLANE_2")}</div>`,this.prompt.style.height=2*i+"px";break;case NDSWebViewer.NDS.INFOTYPE.PLANEPARALLEL:n=`<div class = 'yellowdiv'>${NDSWebViewer.COMMON.translateString("MEASURE_PLANEPARALLEL_1")}</div><div class = 'blackdiv'>${NDSWebViewer.COMMON.translateString("MEASURE_PLANEPARALLEL_2")}</div>`,this.prompt.style.height=2*i+"px";break;case NDSWebViewer.NDS.INFOTYPE.TWOAXISNOPARALLEL:var s=this.viewer.is2DModel?NDSWebViewer.COMMON.translateString("MEASURE_TWOAXISNOPARALLEL_2D_2"):NDSWebViewer.COMMON.translateString("MEASURE_TWOAXISNOPARALLEL_2"),n=`<div class = 'yellowdiv'>${NDSWebViewer.COMMON.translateString("MEASURE_TWOAXISNOPARALLEL_1")}</div><div class = 'blackdiv'>${s}</div>`;this.prompt.style.height=2*i+"px";break;case NDSWebViewer.NDS.INFOTYPE.NOCONJOINT:n=`<div class = 'yellowdiv'>${NDSWebViewer.COMMON.translateString("MEASURE_NOCONJOINT_1")}</div><div class = 'blackdiv'>${NDSWebViewer.COMMON.translateString("MEASURE_NOCONJOINT_2")}</div><div class = 'whitediv'> ${NDSWebViewer.COMMON.translateString("MEASURE_NOCONJOINT_3")}</div>`,this.prompt.style.height=3*i+"px";break;case NDSWebViewer.NDS.INFOTYPE.NOCLOSE:n=`<div class = 'yellowdiv'>${NDSWebViewer.COMMON.translateString("MEASURE_NOCLOSE_1")}</div><div class = 'blackdiv'>${NDSWebViewer.COMMON.translateString("MEASURE_NOCLOSE_2")}</div><div class = 'whitediv'>${NDSWebViewer.COMMON.translateString("MEASURE_NOCLOSE_3")}</div>`,this.prompt.style.height=3*i+"px";break;case NDSWebViewer.NDS.INFOTYPE.FIRMEASUREBODY:n=NDSWebViewer.COMMON.translateString("MEASURE_FIRMEASUREBODY");break;case NDSWebViewer.NDS.INFOTYPE.SECMEASUREBODY:n=NDSWebViewer.COMMON.translateString("MEASURE_SECMEASUREBODY");break;case NDSWebViewer.NDS.INFOTYPE.MEASUREBODY:n=NDSWebViewer.COMMON.translateString("MEASURE_MEASUREBODY");break;case NDSWebViewer.NDS.INFOTYPE.TWOBODYPARALLEL:n=`<div class = 'yellowdiv'>${NDSWebViewer.COMMON.translateString("MEASURE_TWOBODYPARALLEL_1")}</div><div class = 'blackdiv'>${NDSWebViewer.COMMON.translateString("MEASURE_TWOBODYPARALLEL_2")}</div>`,this.prompt.style.height=2*i+"px";break;case NDSWebViewer.NDS.INFOTYPE.TWOBODYNOTPARALLEL:n=`<div class = 'yellowdiv'>${NDSWebViewer.COMMON.translateString("MEASURE_TWOBODYNOTPARALLEL_1")}</div><div class = 'blackdiv'>${NDSWebViewer.COMMON.translateString("MEASURE_TWOBODYNOTPARALLEL_2")}</div>`,this.prompt.style.height=2*i+"px";break;case NDSWebViewer.NDS.INFOTYPE.LOADDATE:n=NDSWebViewer.COMMON.translateString("MEASURE_LOADDATE");break;case NDSWebViewer.NDS.INFOTYPE.CLICKFIRSTPOINT:n=NDSWebViewer.COMMON.translateString("MEASURE_CLICKFIRSTPOINT");break;case NDSWebViewer.NDS.INFOTYPE.CLICKSECONDPOINT:n=NDSWebViewer.COMMON.translateString("MEASURE_CLICKSECONDPOINT");break;case NDSWebViewer.NDS.INFOTYPE.PROJECTPLANE:n=NDSWebViewer.COMMON.translateString("MEASURE_PROJECTPLANE");break;case NDSWebViewer.NDS.INFOTYPE.SELECTPROJECTPLANE:n=NDSWebViewer.COMMON.translateString("MEASURE_SELECTPROJECTPLANE");break;case NDSWebViewer.NDS.INFOTYPE.PLACELINELOCATION:n=NDSWebViewer.COMMON.translateString("MEASURE_PLACELINELOCATION");break;case NDSWebViewer.NDS.INFOTYPE.SELECTPLACELINELOCATION:n=NDSWebViewer.COMMON.translateString("MEASURE_SELECTPLACELINELOCATION");break;case NDSWebViewer.NDS.INFOTYPE.FIRSTMESH:n=NDSWebViewer.COMMON.translateString("MEASURE_FIRSTMESH");break;case NDSWebViewer.NDS.INFOTYPE.SECONDMESH:n=NDSWebViewer.COMMON.translateString("MEASURE_SECONDMESH");break;case NDSWebViewer.NDS.INFOTYPE.MESHVERTICAL:n=NDSWebViewer.COMMON.translateString("MEASURE_MESHVERTICAL");break;case NDSWebViewer.NDS.INFOTYPE.AXISNOPARALLELLINE:n=`<div class = 'yellowdiv'>${NDSWebViewer.COMMON.translateString("MEASURE_AXISNOPARALLELLINE_1")}</div><div class = 'blackdiv'>${NDSWebViewer.COMMON.translateString("MEASURE_AXISNOPARALLELLINE_2")}</div>`,this.prompt.style.height=2*i+"px";break;case NDSWebViewer.NDS.INFOTYPE.NOBREPNOPLNE:n=NDSWebViewer.COMMON.translateString("MEASURE_NOBREPNOPLNE");break;case NDS.INFOTYPE.BREPDATAERROR:n=NDSWebViewer.COMMON.translateString("MEASURE_BREPDATAERROR")}""==n||!NDSWebViewer.SETTING.broadcastMajor&&NDSWebViewer.SETTING.enableBroadcast?(this.prompt.style.display="none",this.prompt.innerHTML=n):(this.prompt.innerHTML=n,this.prompt.style.display="block",NDSWebViewer.COMMON.isMobileDevice()&&(e=this.viewer.renderer.getSize().height/2-21+"px",this.prompt.style.top=e),this.InfoType>NDSWebViewer.NDS.INFOTYPE.MEASURENOTICEBEGIN?this.prompt.style.color="#ff7d2c":NDSWebViewer.COMMON.isMobileDevice()?this.prompt.style.color="rgba(27,27,27,1)":this.prompt.style.color="rgba(51,51,51,1)",e=2e3,(t=this).InfoType>NDSWebViewer.NDS.INFOTYPE.MEASURENOTICEBEGIN&&(e=3e3),NDSWebViewer.COMMON.isMobileDevice()&&(this.Popup=setTimeout(function(){t.prompt.style.display="none"},e)))}},S.prototype.setMeasureType=function(e){switch(""!=e&&this.viewer.hasBrepFile()?this.showMouseZoomArea=!0:this.showMouseZoomArea=!1,this.measureType=e,this.viewer.brepInfo.BfacePerimeter||"facePerimeter"!=this.measureType||(this.measureType="Base"),NDSWebViewer.SETTING.enableBroadcast&&!NDSWebViewer.SETTING.broadcastMajor&&this.viewer.dispatchEvent({type:"FaceSelectionChangeEvent"}),this.viewer.selectionManager.clearSelection(),this.viewer.onOpChanged({id:"MeasureType"}),this.MeasureOper.OperatorEnd(),this.measureType){case"bodyDistance":case"PointToLine":case"PointToFace":case"AxisToPoint":case"LineToLine":case"LineToFace":case"faceDist":case"AxisToLine":case"AxisToFace":case"holeDist":case"pt2pt":case"pt2ptbim":"Distance"!=this.MeasureOper.measureClass&&(this.MeasureOper=new o(this));break;case"radius":"Hole"!=this.MeasureOper.measureClass&&(this.MeasureOper=new r(this));break;case"measureEdges":case"bodyEdgeLength":"Edge"!=this.MeasureOper.measureClass&&(this.MeasureOper=new a(this));break;case"facePerimeter":case"faceArea":"Face"!=this.MeasureOper.measureClass&&(this.MeasureOper=new s(this));break;case"bodyAngle":case"LineAngle":case"LineFaceAngle":case"faceAngle":case"angle":"Angle"!=this.MeasureOper.measureClass&&(this.MeasureOper=new l(this));break;case"BodyArea":case"BodyVolume":case"bodyBoundingBox":case"TotalArea":case"TotalVolume":case"BoundingBox":"BodyAndTotal"!=this.MeasureOper.measureClass&&(this.MeasureOper=new d(this));break;case"coordinate":"Coordinate"!=this.MeasureOper.measureClass&&(this.MeasureOper=new c(this));break;case"Lineargauge":"Lineargauge"!=this.MeasureOper.measureClass&&(this.MeasureOper=new h(this));break;case"LmPt2Pt":case"LmPt2Line":case"LmLine2Line":case"LmHole2Hole":case"LmAxis2Pt":case"LmAxis2Line":"Lineargauge3D"!=this.MeasureOper.measureClass&&(this.MeasureOper=new I(this)),this.MeasureOper.OperatorClear(this.measureType);break;case"contour":case"contourarea":"Contour"!=this.MeasureOper.measureClass&&(this.MeasureOper=new f(this));break;case"WallThickness":"WallThickness"!=this.MeasureOper.measureClass&&(this.MeasureOper=new u(this));break;case"ellipse":"Ellipse"!=this.MeasureOper.measureClass&&(this.MeasureOper=new p(this));break;default:"Base"!=this.MeasureOper.measureClass&&(this.MeasureOper=new i(this))}"Base"!=this.MeasureOper.measureClass&&!this.viewer.hasBrepInfo()&&this.viewer.hasBrepFile()?this.PostInfo(NDSWebViewer.NDS.INFOTYPE.LOADDATE):!this.viewer.hasBrepFile()&&this.measureType&&"pt2pt"!=this.measureType&&"pt2ptbim"!=this.measureType&&"angle"!=this.measureType&&"LmPt2Pt"!=this.measureType&&"BoundingBox"!=this.measureType&&"bodyBoundingBox"!=this.measureType||"facePerimeter"==e&&this.viewer.brepInfo&&!this.viewer.brepInfo.BfacePerimeter||"BodyArea"==e&&this.viewer.brepInfo&&!this.viewer.brepInfo.BbodyArea||("BodyVolume"==e||"TotalVolume"==e)&&this.viewer.brepInfo&&!this.viewer.brepInfo.BbodyVolume||"faceArea"==e&&this.viewer.brepInfo&&!this.viewer.brepInfo.BfaceArea||"TotalArea"==e&&this.viewer.brepInfo&&!this.viewer.brepInfo.BtotalArea?this.PostInfo(NDSWebViewer.NDS.INFOTYPE.NOBREP):this.MeasureOper.OperatorStart(this.measureType),this.prompt&&!NDSWebViewer.COMMON.isMobileDevice()&&(this.prompt.style.display="none"),NDSWebViewer.COMMON.isMobileDevice()&&(this.hasMouseZoomArea?this.createMouseZoomArea():this.createZoomArea()),this.render(!1,!1)},S.prototype.setPointScale=function(e,t){t=this.getScale(e,t);e.scale.x=t,e.scale.y=t,e.scale.z=t,e.updateMatrixWorld()},S.prototype.setCylinderScale=function(e,t){NDSWebViewer.COMMON.isMobileDevice()&&(t*=1.5);t=this.getScale(e,t);e.scale.x=t,e.scale.y=t,e.scale.z=t,e.oldPosition&&e.offsetPos&&e.position.addVectors(e.oldPosition,e.offsetPos.clone().multiplyScalar(t)),e.updateMatrixWorld()},S.prototype.setResolution=function(e){var t=this.viewer.renderer.getPixelRatio(),n=this.viewer.renderer.domElement.width/t,t=this.viewer.renderer.domElement.height/t;e.material.resolution.set(n,t)},S.prototype.getScale=function(e,t){var n=5,t=(null!=t&&(n=t),this.viewer.camera.getCameraTarget()),i=this.viewer.camera.position,s=new THREE.Vector3,t=(s.subVectors(t,i),e.position.clone()),e=this.viewer.camera.isPerspective?t.sub(i).dot(s.normalize()):s.length(),t=this.viewer.camera.fov,i=2*e*Math.tan(THREE.Math.degToRad(.5*t)),s=this.viewer.renderer.domElement.height;return n*i*this.viewer.renderer.getPixelRatio()/s},S.prototype.renderScale=function(e){for(var t=0;t<e.children.length;t++){var n=e.children[t];if(null!=n.objectType)switch(n.objectType){case"Point":this.setPointScale(n,this.MeasureOper.POINTSIZE);break;case"Cylinder":this.setCylinderScale(n,this.MeasureOper.CYLINDERWIDTH);break;case"Group":this.renderScale(n);break;case"SelLine":this.setResolution(n)}}},S.prototype.renderMeasureScene=function(e,t){if(this.scene){if(null!=this.rootObject&&this.renderScale(this.rootObject),e?this.viewer.renderer.render(this.scene,this.viewer.camera,e,t):this.viewer.renderer.render(this.scene,this.viewer.camera),this.MeasureOper.renderMeasureScene(),this.perimeterInfos)for(var n=0,i=this.perimeterInfos.length;n<i;n++){var s=this.perimeterInfos[n],o=this.MeasureOper.get2dPoint(s.textPos.clone());this.MeasureOper.updateTip(s.textimg,o.x,o.y)}for(n=0,i=this.boxInfos.length;n<i;n++){s=this.boxInfos[n];this.MeasureOper.getAndShowTextBox(s.textPos.clone(),s.dimString,s.textBox)}for(n=0,i=this.boundingboxInfos.length;n<i;n++){s=this.boundingboxInfos[n];this.MeasureOper.getAndShowTextBox(s.textPos.clone(),s.dimString,s.textBox)}}},S.prototype.setMeasureProjectPlane=function(e){if("Lineargauge3D"==this.MeasureOper.measureClass)switch(this.MeasureOper.selectProjectPlane=!1,this.MeasureOper.LineargaugeClearProjectPlaneSelect(),e){case"S":if(!this.viewer.hasBrepFile()&&("LmPt2Pt"==this.measureType||"LmHole2Hole"==this.measureType))return void this.PostInfo(NDSWebViewer.NDS.INFOTYPE.NOBREPNOPLNE);this.MeasureOper.selectProjectPlane=!0,this.MeasureOper.distanceInfo.projectPlane=null,this.PostInfo(NDSWebViewer.NDS.INFOTYPE.PROJECTPLANE);break;case"X":var t=this.viewer.controls.getBoundingBox().getCenter();if(this.MeasureOper.distanceInfo.projectPlane=(new THREE.Plane).setFromNormalAndCoplanarPoint(new THREE.Vector3(1,0,0),t),!this.viewer.hasBrepFile()&&"LmHole2Hole"==this.measureType)return this.MeasureOper.lineargaugeRotateOnly(this.MeasureOper.distanceInfo.projectPlane),this.MeasureOper.distanceInfo.projectPlane=null,void this.PostInfo(NDSWebViewer.NDS.INFOTYPE.NOBREP);this.MeasureOper.lineargaugeRotate(this.MeasureOper.distanceInfo.projectPlane,!0);break;case"Y":t=this.viewer.controls.getBoundingBox().getCenter();if(this.MeasureOper.distanceInfo.projectPlane=(new THREE.Plane).setFromNormalAndCoplanarPoint(new THREE.Vector3(0,1,0),t),!this.viewer.hasBrepFile()&&"LmHole2Hole"==this.measureType)return this.MeasureOper.lineargaugeRotateOnly(this.MeasureOper.distanceInfo.projectPlane),this.MeasureOper.distanceInfo.projectPlane=null,void this.PostInfo(NDSWebViewer.NDS.INFOTYPE.NOBREP);this.MeasureOper.lineargaugeRotate(this.MeasureOper.distanceInfo.projectPlane,!0);break;case"Z":t=this.viewer.controls.getBoundingBox().getCenter();if(this.MeasureOper.distanceInfo.projectPlane=(new THREE.Plane).setFromNormalAndCoplanarPoint(new THREE.Vector3(0,0,1),t),!this.viewer.hasBrepFile()&&"LmHole2Hole"==this.measureType)return this.MeasureOper.lineargaugeRotateOnly(this.MeasureOper.distanceInfo.projectPlane),this.MeasureOper.distanceInfo.projectPlane=null,void this.PostInfo(NDSWebViewer.NDS.INFOTYPE.NOBREP);this.MeasureOper.lineargaugeRotate(this.MeasureOper.distanceInfo.projectPlane,!0);break;default:this.MeasureOper.distanceInfo.projectPlane=null}else console.log("ERROR: Cant not Select Project Plane ")},S.prototype.setMeasureProjectDirection=function(e){NDSWebViewer.COMMON.isMobileDevice()?"V"==e?this.MeasureOper.lineargaugeSelectPlaceLine(1):"H"==e&&this.MeasureOper.lineargaugeSelectPlaceLine(0):console.log("Error: unknow project direction")},S.prototype.setMeasureScale=function(e){for(var t=0,n=this.boxInfos.length;t<n;t++){var i,s,o,r,a,l=this.boxInfos[t];"length"==l.textBox.getAttribute("type")?(i=l.textBox.getAttribute("dimString"),s=l.textBox.getAttribute("dimStringPrefix"),a=l.textBox.getAttribute("unit"),""==i[0]?l.dimString=" "+(i.slice(2)*e).toFixed(this.viewer.Decimal)+a:l.dimString=(i*e).toFixed(this.viewer.Decimal)+a,s&&(l.dimString=s+l.dimString)):"radius"==l.textBox.getAttribute("type")?(s=(i=l.textBox.getAttribute("dimString")).slice(0,2),o=i.slice(2),a=l.textBox.getAttribute("unit"),l.dimString=s+(o*e).toFixed(this.viewer.Decimal)+a):"perimeter"==l.textBox.getAttribute("type")?(r=parseFloat(l.textBox.getAttribute("dimString")),a=l.textBox.getAttribute("unit"),l.dimString=NDSWebViewer.COMMON.translateString("MEASURE_OVERLENGTH")+":"+(r*e).toFixed(this.viewer.Decimal)+a):"area"==l.textBox.getAttribute("type")&&(r=parseFloat(l.textBox.getAttribute("dimString")),a=l.textBox.getAttribute("unit"),l.dimString=NDSWebViewer.COMMON.translateString("MEASURE_AREA")+":"+(r*e*e).toFixed(this.viewer.Decimal)+a),l.textBox.screenX=-10,this.MeasureOper.getAndShowTextBox(l.textPos.clone(),l.dimString,l.textBox)}NDSWebViewer.SETTING.enableBroadcast&&NDSWebViewer.SETTING.broadcastMajor&&this.viewer.dispatchEvent({type:"broadcastEvent"})},S.prototype.setMeasureDisplayUnit=function(){for(var e=0,t=this.boxInfos.length;e<t;e++){var n,i,s,o,r,a,l=this.boxInfos[e],d=this.viewer.userModelUnit||this.viewer.modelUnit;"length"==l.textBox.getAttribute("type")?(n=l.textBox.getAttribute("dimString"),i=l.textBox.getAttribute("dimStringPrefix"),s=l.textBox.getAttribute("unit"),o=this.viewer.getUnitTransfrom(d,s),r={unit:this.viewer.userModelUnit||this.viewer.modelUnit,scale:1},this.viewer.userModelUnit||(r=this.viewer.getDispalyModelUnit(n*o)),""==n[0]?l.dimString=" "+(n.slice(2)*o*r.scale).toFixed(this.viewer.Decimal)+this.MeasureOper.getUnitStringmap(r.unit):l.dimString=(n*o*r.scale).toFixed(this.viewer.Decimal)+this.MeasureOper.getUnitStringmap(r.unit),i&&(l.dimString=i+l.dimString)):"radius"==l.textBox.getAttribute("type")?(i=(n=l.textBox.getAttribute("dimString")).slice(0,2),a=n.slice(2),s=l.textBox.getAttribute("unit"),o=this.viewer.getUnitTransfrom(d,s),r={unit:this.viewer.userModelUnit||this.viewer.modelUnit,scale:1},this.viewer.userModelUnit||(r=this.viewer.getDispalyModelUnit(a*o)),l.dimString=i+(a*o*r.scale).toFixed(this.viewer.Decimal)+this.MeasureOper.getUnitStringmap(r.unit)):"angle"==l.textBox.getAttribute("type")&&(a=parseFloat(l.textBox.getAttribute("dimString")),l.dimString=a.toFixed(this.viewer.Decimal)+l.textBox.getAttribute("unit")),l.textBox.screenX=-10,this.MeasureOper.getAndShowTextBox(l.textPos.clone(),l.dimString,l.textBox)}NDSWebViewer.SETTING.enableBroadcast&&NDSWebViewer.SETTING.broadcastMajor&&this.viewer.dispatchEvent({type:"broadcastEvent"})},S.prototype.isInMeasure=function(){var e,t=!1;for(e in this.MeasureOper.coordinatedivtextPos&&this.MeasureOper.coordinatediv&&(t=!0),this.MeasureOper.faceInfo)if(!(null==this.MeasureOper.faceInfo[e]||""==this.MeasureOper.faceInfo[e]||Array.isArray(this.MeasureOper.faceInfo[e])||this.MeasureOper.faceInfo[e]instanceof THREE.Vector2||this.MeasureOper.faceInfo[e]instanceof THREE.Vector3)&&null!=this.MeasureOper.faceInfo.textBox&&null!=this.MeasureOper.faceInfo.textPos){t=!0;break}for(e in this.MeasureOper.holeInfo)if(!(null==this.MeasureOper.holeInfo[e]||""==this.MeasureOper.holeInfo[e]||Array.isArray(this.MeasureOper.holeInfo[e])||this.MeasureOper.holeInfo[e]instanceof THREE.Vector2||this.MeasureOper.holeInfo[e]instanceof THREE.Vector3)&&null!=this.MeasureOper.holeInfo.textBox&&null!=this.MeasureOper.holeInfo.textPos){t=!0;break}for(e in this.MeasureOper.edgeInfo)if(!(null==this.MeasureOper.edgeInfo[e]||""==this.MeasureOper.edgeInfo[e]||Array.isArray(this.MeasureOper.edgeInfo[e])||this.MeasureOper.edgeInfo[e]instanceof THREE.Vector2||this.MeasureOper.edgeInfo[e]instanceof THREE.Vector3)&&null!=this.MeasureOper.edgeInfo.textBox&&null!=this.MeasureOper.edgeInfo.textPos){t=!0;break}for(e in this.MeasureOper.distanceInfo)if(!(null==this.MeasureOper.distanceInfo[e]||""==this.MeasureOper.distanceInfo[e]||Array.isArray(this.MeasureOper.distanceInfo[e])||this.MeasureOper.distanceInfo[e]instanceof THREE.Vector2||this.MeasureOper.distanceInfo[e]instanceof THREE.Vector3)&&null!=this.MeasureOper.distanceInfo.textBox&&null!=this.MeasureOper.distanceInfo.textPos){t=!0;break}for(e in this.MeasureOper.lineContoursInfo)if(!(null==this.MeasureOper.lineContoursInfo[e]||""==this.MeasureOper.lineContoursInfo[e]||Array.isArray(this.MeasureOper.lineContoursInfo[e])||this.MeasureOper.lineContoursInfo[e]instanceof THREE.Vector2||this.MeasureOper.lineContoursInfo[e]instanceof THREE.Vector3)&&null!=this.MeasureOper.lineContoursInfo.textBox&&null!=this.MeasureOper.lineContoursInfo.textPos){t=!0;break}for(e in this.MeasureOper.lineAngleInfo)if(!(null==this.MeasureOper.lineAngleInfo[e]||""==this.MeasureOper.lineAngleInfo[e]||Array.isArray(this.MeasureOper.lineAngleInfo[e])||this.MeasureOper.lineAngleInfo[e]instanceof THREE.Vector2||this.MeasureOper.lineAngleInfo[e]instanceof THREE.Vector2)&&null!=this.MeasureOper.lineAngleInfo.textBox&&null!=this.MeasureOper.lineAngleInfo.textPos){t=!0;break}return t},S.prototype.getMeasureContent=function(i=!1){function e(e,t){var n=[],t=(n[0]=o(e.textPos),n[1]=e.dimString,n[2]=t?e.textBox.getAttribute("lineInfo"):null,!n[2]&&e.textBox&&(n[2]=e.textBox.getAttribute("group")),e.textBox);if(t)switch(e.textBox.getAttribute("type")){case"length":n[3]=0,n[4]=e.textBox.getAttribute("dimString"),n[5]=e.textBox.getAttribute("unit"),n[6]=e.textBox.getAttribute("dimStringPrefix");break;case"radius":n[3]=1,n[4]=e.textBox.getAttribute("dimString"),n[5]=e.textBox.getAttribute("unit");break;case"perimeter":n[3]=2,n[4]=e.textBox.getAttribute("dimString"),n[5]=e.textBox.getAttribute("unit");break;case"area":n[3]=3,n[4]=e.textBox.getAttribute("dimString"),n[5]=e.textBox.getAttribute("unit");break;case"coordinate":n[3]=4;break;default:n[3]=5}else if(e.textimg)switch(e.textimg.getAttribute("type")){case"length":n[3]=0,n[4]=e.textBox.getAttribute("dimString"),n[5]=e.textBox.getAttribute("unit");break;case"radius":n[3]=1,n[4]=e.textBox.getAttribute("dimString"),n[5]=e.textBox.getAttribute("unit");break;case"perimeter":n[3]=2,n[4]=e.textBox.getAttribute("dimString"),n[5]=e.textBox.getAttribute("unit");break;case"area":n[3]=3,n[4]=e.textBox.getAttribute("dimString"),n[5]=e.textBox.getAttribute("unit");break;case"coordinate":n[3]=4;break;default:n[3]=5}return n}var s=[],o=function(e){if(e instanceof THREE.Vector3){var t=e.clone();t.x=Number.parseFloat(Number.parseFloat(e.x).toPrecision(6)),t.y=Number.parseFloat(Number.parseFloat(e.y).toPrecision(6)),t.z=Number.parseFloat(Number.parseFloat(e.z).toPrecision(6));for(var n=0;n<s.length;n++)if(t.distanceTo(s[n])<1e-5)return n;return s.push(t.clone()),s.length-1}if(e instanceof Array){var i=[];if(e[0]instanceof THREE.Vector3)for(n=0;n<e.length;++n)i.push(Number.parseFloat(Number.parseFloat(e[n].x).toPrecision(6))),i.push(Number.parseFloat(Number.parseFloat(e[n].y).toPrecision(6))),i.push(Number.parseFloat(Number.parseFloat(e[n].z).toPrecision(6)));else for(n=0;n<e.length;n+=3)i.push(Number.parseFloat(Number.parseFloat(e[n]).toPrecision(6))),i.push(Number.parseFloat(Number.parseFloat(e[n+1]).toPrecision(6)));return i}},t=0,n=[],r=[],a=[],l=[];for(t=0;t<this.boxInfos.length;t++)n.push(e(this.boxInfos[t],!0));for(t=0;t<this.boundingboxInfos.length;t++)r.push(e(this.boundingboxInfos[t],!1));for(t=0;t<this.MeasureOper.perimeterInfos.length;t++)a.push(e(this.MeasureOper.perimeterInfos[t],!1));var d=this.isInMeasure(),c=!!d||null;for(t=0;t<this.boxInfos.length;t++)l.push(this.boxInfos[t].textPos);var h={boxInfos:n,boundingboxInfos:r,perimeterInfos:a,textPos:l,textBox:c,textLines:this.textLines,snappedPoint:this.MeasureOper.snappedPoint||null,InMeasure:d},f=(0<this.MeasureOper.perimeterInfos.length&&(h.perimeterBroadcast=this.MeasureOper.perimeterBroadcast,h.perimeterunit=this.MeasureOper.perimeterunit),"faceArea"==this.measureType&&(c=(c=this.MeasureOper.getSelectedFaceArea())*(d=this.viewer.getDispalyModelUnit(c)).scale*d.scale,h.faceArea=c,h.faceAreaunit=d.unit),"radius"==this.measureType&&this.MeasureOper.holeInfo.textPos&&this.MeasureOper.holeInfo.fstClndPos&&(h.holeInfotextPos=this.MeasureOper.holeInfo.textPos,h.holeInfofstClndPos=this.MeasureOper.holeInfo.fstClndPos),[]);if(this.rootObject){h.cs=this.rootObject.children.length;for(var I=t=>{switch(t.objectType){case"Line":this.isInLinearguage3DAndMeasureLatestComponentMode(t)||(f.push(0),f.push(o(t.Start)),f.push(o(t.End))),this.lineargauge3DProcessedLineSet.add(t.uuid);break;case"Edge":f.push(1),f.push(o(t.Start)),f.push(o(t.End));break;case"CircleLine":f.push(2),f.push(o(t.Start)),f.push(o(t.Mid)),f.push(o(t.End));break;case"Cylinder":this.isInLinearguage3DAndMeasureLatestComponentMode(t)||(f.push(3),f.push(o(t.Start)),f.push(o(t.End)),f.push(o(t.position)),f.push(o(new THREE.Vector3(t.material.color.r,t.material.color.g,t.material.color.b)))),this.lineargauge3DProcessedLineSet.add(t.uuid);break;case"Point":f.push(4);let e=0;t.material.color.equals(this.MeasureOper.materialProjectPoint.color)&&(e=1),f.push(e),f.push(o(t.Point));break;case"Face":t.FaceInfo[4]?h.cs--:(f.push(5),f=f.concat(t.FaceInfo));break;case"AxisLine":f.push(6),f.push(o(t.Start)),f.push(o(t.End));break;case"SelLine":t.LineInfo[4]?h.cs--:(f.push(7),f=f.concat(t.LineInfo));break;case"BodyBoundingBox":f.push(8),f=f.concat(o(t.box));break;case"Contour":f.push(9),f.push(t.Vertices.length/3*2),f=f.concat(o(t.Vertices));break;case"Group":i&&(f.push(10),f.push(t.uuid),"Group"==t.parent.objectType&&"unsteady"==t.name?f.push(1):f.push(0));for(var n=0;n<t.children.length;++n)I(t.children[n])}},t=0;t<this.rootObject.children.length;++t){var u=this.rootObject.children[t];I(u)}var p=[];for(t=0;t<s.length;++t){var S=s[t];p.push(S.x),p.push(S.y),p.push(S.z)}h.Ps=p}return h.rootObject=f,h},S.prototype.createCoordinate=function(e,t){var n,i=document.createElement("div"),e=(i.className="mearesult",this.viewer.container.appendChild(i),e&&(n=e.clone(),this.MeasureOper.getAndShowTextBox(n.clone(),t,i)),{});e.dimString=t,e.textPos=n,e.textBox=i,e.textBox.setAttribute("type","coordinate"),e.textBox.setAttribute("dimString",t),this.boxInfos.push(e)},S.prototype.setMeasureContentNew=function(e){this.viewer.ndsModel.setActiveModel(0);for(var t,r=this,n=function(e){var t,n,i={},s=new THREE.Vector3(e.textPos.x,e.textPos.y,e.textPos.z),o=(i.textPos=s,i.dimString=e.dimString,document.createElement("div"));return r.viewer.is2DModel||(o.className="section10",o.innerHTML=e.textBoxInnerHTML,r.viewer.container.appendChild(o),(n=document.createElement("div")).className="sectionPoint",o.appendChild(n),NDSWebViewer.COMMON.isMobileDevice()?(o.addEventListener("touchstart",r.MeasureOper.touchstart,!1),o.addEventListener("touchend",r.MeasureOper.touchend,!1),o.addEventListener("touchmove",r.MeasureOper.touchmove,!1)):(o.addEventListener("mousedown",r.MeasureOper.touchstart,!1),o.addEventListener("mouseup",r.MeasureOper.touchend,!1),o.addEventListener("mousemove",r.MeasureOper.touchmove,!1),o.addEventListener("mouseleave",r.MeasureOper.mouseleave,!1),o.addEventListener("mouseenter",r.MeasureOper.mouseenter,!1)),(n=document.createElement("div")).className="sectionCross",o.appendChild(n),NDSWebViewer.COMMON.isMobileDevice()?n.addEventListener("touchend",r.MeasureOper.sectionCrossend,!1):(n.addEventListener("mousedown",r.MeasureOper.sectionCrossend,!1),n.addEventListener("mouseleave",r.MeasureOper.crossleave,!1),n.addEventListener("mouseenter",r.MeasureOper.crossenter,!1))),o.textPos=s,o.setAttribute("type",e.type),o.setAttribute("dimString",e.dimString),o.setAttribute("unit",e.unit),o.setAttribute("dimStringPrefix",e.dimStringPrefix),!r.viewer.is2DModel&&e.lineInfo&&e.lineInfo.start&&e.lineInfo.end?(n=new THREE.Vector3(e.lineInfo.start.x,e.lineInfo.start.y,e.lineInfo.start.z),t=new THREE.Vector3(e.lineInfo.end.x,e.lineInfo.end.y,e.lineInfo.end.z),n=n.clone().add(t.clone()).divideScalar(2),t=r.MeasureOper.get2dPoint(s.clone()),s=r.MeasureOper.get2dPoint(n.clone()),(n=new THREE.Vector2(t.x-s.x,t.y-s.y)).normalize(),n.y>=n.x/2&&n.y>=-n.x/2?(o.childNodes[1].style.left="calc(50% - 6px)",o.childNodes[1].style.top="-5.5px",o.setAttribute("mobile","down")):n.y>n.x/2&&n.y<-n.x/2?(o.childNodes[1].style.left="calc(100% - 4px)",o.childNodes[1].style.top="calc(50% - 5.5px)",o.setAttribute("mobile","right")):n.y<n.x/2&&n.y<-n.x/2?(o.childNodes[1].style.left="calc(50% - 6px)",o.childNodes[1].style.top="calc(100% - 5.5px)",o.setAttribute("mobile","up")):n.y<n.x/2&&n.y>-n.x/2&&(o.childNodes[1].style.left="-5.5px",o.childNodes[1].style.top="calc(50% - 5.5px)",o.setAttribute("mobile","left")),o.setAttribute("group",e.groupUuid),o.setAttribute("lineInfo",e.lineInfoIndex)):(o.setAttribute("group",e.groupUuid),o.childNodes[1].style.left="calc(50% - 6px)",o.childNodes[1].style.top="calc(100% - 5.5px)",o.setAttribute("mobile","up")),i.textBox=o,i},i=n(e),n=(i&&("ellipse"==e.unsteadyData.measureType&&i.textBox.setAttribute("radiusType","X"),this.boxInfos.push(i)),"ellipse"==e.unsteadyData.measureType&&(i=n({textPos:e.textPos1,dimString:e.dimString1,textBoxInnerHTML:e.textBoxInnerHTML1,type:e.type,lineInfo:e.lineInfo1,dimStringPrefix:e.dimStringPrefix,unit:e.unit,groupUuid:e.groupUuid,lineInfoIndex:e.lineInfoIndex}))&&(i.textBox.setAttribute("radiusType","Y"),this.boxInfos.push(i)),{}),i={},s=(e.lineInfo&&e.lineInfo.start&&(n.start=new THREE.Vector3(e.lineInfo.start.x,e.lineInfo.start.y,e.lineInfo.start.z),n.end=new THREE.Vector3(e.lineInfo.end.x,e.lineInfo.end.y,e.lineInfo.end.z),n.uuid=e.lineInfo.uuid,this.textLines.push(n)),e.lineInfo1&&e.lineInfo1.start&&(i.start=new THREE.Vector3(e.lineInfo1.start.x,e.lineInfo1.start.y,e.lineInfo1.start.z),i.end=new THREE.Vector3(e.lineInfo1.end.x,e.lineInfo1.end.y,e.lineInfo1.end.z),i.uuid=e.lineInfo1.uuid,this.textLines.push(i)),e.unsteadyData&&(this.CreateVector3(e.unsteadyData),this.unsteadyData[e.groupUuid]=e.unsteadyData),this.CreateVector3(e.measureObject),null),o=0;o<e.measureObject.length;){var a=null;switch(e.measureObject[o++]){case 0:var l=e.measureObject[o++],d=e.measureObject[o++],a=this.viewer.is2DModel?this.MeasureOper.createLineMesh2(l,d,this.MeasureOper.materialLine,1):this.MeasureOper.createLineMesh2(l,d,NDSWebViewer.SETTING.selectedEdgeMaterial,1);break;case 1:l=e.measureObject[o++],d=e.measureObject[o++];a=this.MeasureOper.createLineMesh3(l,d,NDSWebViewer.SETTING.selectedEdgeMaterial,1);break;case 2:var l=e.measureObject[o++],c=e.measureObject[o++],d=e.measureObject[o++];a=this.MeasureOper.createLineMesh4(l,c,d,this.MeasureOper.materialLine);break;case 3:var l=e.measureObject[o++],d=e.measureObject[o++],h=e.measureObject[o++],f=e.measureObject[o++],I=e.measureObject[o++],u=e.measureObject[o++];(T=new THREE.MeshBasicMaterial({color:16743724,opacity:.8,transparent:!0,depthTest:!1,depthWrite:!1,side:THREE.DoubleSide})).color.setRGB(u.x,u.y,u.z),(a=this.MeasureOper.createCylinderMesh(l,d,T)).position.copy(h),a.oldPosition=f,a.offsetPos=I;break;case 4:var c=e.measureObject[o++],p=e.measureObject[o++];a=this.MeasureOper.createPointMesh(p,0==c?this.MeasureOper.materialPoint:this.MeasureOper.materialProjectPoint,this.MeasureOper.POINTSIZE);break;case 5:var S=e.measureObject[o++],g=e.measureObject[o++],E=e.measureObject[o++],m=this.viewer.brepManager.GetBrepInfoByUUidAndTopolIndex(S,g,E,"face"),p=e.measureObject[o++],O=this.viewer.ndsModel.meshManager.getSingleMesh(p),b=!!e.measureObject[o++];O&&m&&(m.parentObj=O,m.geometry=O.geometry,m.bodyUuid=S,m.topolIndex=E,m.meshId=p,m.matrixWorld=O.matrixWorld.clone(),a=this.MeasureOper.createFace(m,b));break;case 6:l=e.measureObject[o++],d=e.measureObject[o++];a=this.MeasureOper.createLineMesh3(l,d,this.MeasureOper.axisLine,1);break;case 7:var S=e.measureObject[o++],g=e.measureObject[o++],E=e.measureObject[o++],m=this.viewer.brepManager.GetBrepInfoByUUidAndTopolIndex(S,g,E,"edge"),P=e.measureObject[o++],O=this.viewer.ndsModel.meshManager.getLineSegments(P),b=!!e.measureObject[o++];O&&m&&(m.parentObj=O,m.geometry=O.geometry,m.bodyUuid=S,m.matrixWorld=O.matrixWorld.clone(),m.topolIndex=E,m.lineSegId=P,a=this.MeasureOper.createLine(m,b));break;case 10:var M=e.measureObject[o++];(a=new THREE.Group).objectType="Group",a.uuid=M,s=a,1==(t=e.measureObject[o++])&&(a.name="unsteady");break;case 11:S=this.viewer.ndsModel.getBodyNode(e.measureObject[o++]).uuid,g=this.viewer.ndsModel.geomManager.geoms[e.measureObject[o++]].uuid,E=e.measureObject[o++],m=this.viewer.brepManager.GetBrepInfoByUUidAndTopolIndex(S,g,E,"edge"),P=e.measureObject[o++],O=this.viewer.ndsModel.meshManager.getLineSegments(P),b=!!e.measureObject[o++];O&&m&&(m.parentObj=O,m.geometry=O.geometry,m.bodyUuid=S,m.matrixWorld=O.matrixWorld.clone(),m.topolIndex=E,m.lineSegId=P,(a=this.MeasureOper.createEllipse(m,b)).measureType="ellipse"),t=2;break;case 12:l=e.measureObject[o++],d=e.measureObject[o++];(a=this.viewer.is2DModel?this.MeasureOper.createLineMesh2(l,d,this.MeasureOper.materialLine,1):this.MeasureOper.createLineMesh2(l,d,NDSWebViewer.SETTING.selectedEdgeMaterial,1)).radiusType="X";break;case 13:l=e.measureObject[o++],d=e.measureObject[o++];(a=this.viewer.is2DModel?this.MeasureOper.createLineMesh2(l,d,this.MeasureOper.materialLine,1):this.MeasureOper.createLineMesh2(l,d,NDSWebViewer.SETTING.selectedEdgeMaterial,1)).radiusType="Y";break;case 14:l=e.measureObject[o++],d=e.measureObject[o++],h=e.measureObject[o++],f=e.measureObject[o++],I=e.measureObject[o++],u=e.measureObject[o++];(T=new THREE.MeshBasicMaterial({color:16743724,opacity:.8,transparent:!0,depthTest:!1,depthWrite:!1,side:THREE.DoubleSide})).color.setRGB(u.x,u.y,u.z),(a=this.MeasureOper.createCylinderMesh(l,d,T)).position.copy(h),a.oldPosition=f,a.offsetPos=I,a.radiusType="X";break;case 15:var T,l=e.measureObject[o++],d=e.measureObject[o++],h=e.measureObject[o++],f=e.measureObject[o++],I=e.measureObject[o++],u=e.measureObject[o++];(T=new THREE.MeshBasicMaterial({color:16743724,opacity:.8,transparent:!0,depthTest:!1,depthWrite:!1,side:THREE.DoubleSide})).color.setRGB(u.x,u.y,u.z),(a=this.MeasureOper.createCylinderMesh(l,d,T)).position.copy(h),a.oldPosition=f,a.offsetPos=I,a.radiusType="Y"}a&&("Group"==a.type?0==t?(this.rootObject.add(a),this.measureTimes++):1==t?this.rootObject.children[this.rootObject.children.length-1].add(a):2==t&&null!==s&&(s.add(a),s.measureType="ellipse",s.subnum=0):null!==s&&s.add(a))}},S.prototype.getMeasureContentNew=function(){var t=[],n=new Set;for(let e=0;e<this.boxInfos.length;e++){var i=this.boxInfos[e].textBox.getAttribute("group");n.has(i)||(n.add(i),t.push(this.getMeasureContentFromUuid(i)))}return t},S.prototype.setMeasureContent=function(e,d=!1,c=!1){function t(e,t,n,i,s){var o={},n=n?new THREE.Vector3(n.x,n.y,n.z):f[e[0]];if(o.textPos=n,o.dimString=e[1],Number.isInteger(o.dimString)){var r=h.MeasureOper.get2dPoint(o.textPos.clone()),a=h.MeasureOper.addAnnotationTip(o.dimString,r.x,r.y);a&&h.viewer.container.appendChild(a),o.textimg=a}else{var r,l=document.createElement("div");if(h.viewer.is2DModel?(l.className="mearesult",h.viewer.container.appendChild(l)):(l.className="section10",l.innerHTML=e[1],h.viewer.container.appendChild(l),(a=document.createElement("div")).className="sectionPoint",l.appendChild(a),c&&(NDSWebViewer.COMMON.isMobileDevice()?(l.addEventListener("touchstart",h.MeasureOper.touchstart,!1),l.addEventListener("touchend",h.MeasureOper.touchend,!1),l.addEventListener("touchmove",h.MeasureOper.touchmove,!1)):(l.addEventListener("mousedown",h.MeasureOper.touchstart,!1),l.addEventListener("mouseup",h.MeasureOper.touchend,!1),l.addEventListener("mousemove",h.MeasureOper.touchmove,!1),l.addEventListener("mouseleave",h.MeasureOper.mouseleave,!1),l.addEventListener("mouseenter",h.MeasureOper.mouseenter,!1)),d)&&((a=document.createElement("div")).className="sectionCross",l.appendChild(a),NDSWebViewer.COMMON.isMobileDevice()?a.addEventListener("touchend",h.MeasureOper.sectionCrossend,!1):(a.addEventListener("mousedown",h.MeasureOper.sectionCrossend,!1),a.addEventListener("mouseleave",h.MeasureOper.crossleave,!1),a.addEventListener("mouseenter",h.MeasureOper.crossenter,!1)))),l.textPos=n,e[3]<5)switch(e[3]){case 0:l.setAttribute("type","length"),l.setAttribute("dimString",e[4]),l.setAttribute("unit",e[5]),l.setAttribute("dimStringPrefix",e[6]);break;case 1:l.setAttribute("type","radius"),l.setAttribute("dimString",e[4]),l.setAttribute("unit",e[5]);break;case 2:l.setAttribute("type","perimeter"),l.setAttribute("dimString",e[4]),l.setAttribute("unit",e[5]);break;case 3:l.setAttribute("type","area"),l.setAttribute("dimString",e[4]),l.setAttribute("unit",e[5]);break;case 4:l.setAttribute("type","coordinate"),l.setAttribute("dimString",e[1])}s&&!h.viewer.is2DModel&&(t[e[2]]?(a=new THREE.Vector3(t[e[2]].start.x,t[e[2]].start.y,t[e[2]].start.z),s=new THREE.Vector3(t[e[2]].end.x,t[e[2]].end.y,t[e[2]].end.z),a=a.clone().add(s.clone()).divideScalar(2),r=i.get2dPoint(n.clone()),s=i.get2dPoint(a.clone()),(n=new THREE.Vector2(r.x-s.x,r.y-s.y)).normalize(),n.y>=n.x/2&&n.y>=-n.x/2?(l.childNodes[1].style.left="calc(50% - 6px)",l.childNodes[1].style.top="-5.5px",l.setAttribute("mobile","down")):n.y>n.x/2&&n.y<-n.x/2?(l.childNodes[1].style.left="calc(100% - 4px)",l.childNodes[1].style.top="calc(50% - 5.5px)",l.setAttribute("mobile","right")):n.y<n.x/2&&n.y<-n.x/2?(l.childNodes[1].style.left="calc(50% - 6px)",l.childNodes[1].style.top="calc(100% - 5.5px)",l.setAttribute("mobile","up")):n.y<n.x/2&&n.y>-n.x/2&&(l.childNodes[1].style.left="-5.5px",l.childNodes[1].style.top="calc(50% - 5.5px)",l.setAttribute("mobile","left")),l.setAttribute("group",t[e[2]].uuid),l.setAttribute("lineInfo",e[2])):(l.childNodes[1].style.left="calc(50% - 6px)",l.childNodes[1].style.top="calc(100% - 5.5px)",l.setAttribute("mobile","up"),l.setAttribute("group",e[2]))),o.textBox=l}return o}var h=this,f=[];if(e){var n=0;for(n=0;n<e.Ps.length;n+=3){var i=e.Ps[n],s=e.Ps[n+1],o=e.Ps[n+2],r=new THREE.Vector3(i,s,o);f.push(r)}e.InMeasure=!0;for(var a=0,l=this.boxInfos.length;a<l;a++)(u=this.boxInfos[a]).textBox&&(this.viewer.container.removeChild(u.textBox),u.textPos=null,u.textBox=null);for(this.boxInfos.splice(0,this.boxInfos.length),n=0;n<e.boxInfos.length;n++){var I=t(e.boxInfos[n],e.textLines,e.textPos[n],this.MeasureOper,!0);I&&this.boxInfos.push(I)}for(a=0,l=this.boundingboxInfos.length;a<l;a++){var u=this.boundingboxInfos[a];this.viewer.container.removeChild(u.textBox),u.textPos=null,u.textBox=null}for(this.boundingboxInfos.splice(0,this.boundingboxInfos.length),n=0;n<e.boundingboxInfos.length;n++)this.boundingboxInfos.push(t(e.boundingboxInfos[n],null,null,null,!1));for(n=0;n<this.perimeterInfos.length;n++)this.viewer.removeIconFromContainer(this.perimeterInfos[n].textimg);for(this.perimeterInfos=[],this.MeasureOper.perimeterInfos=[],n=0;n<e.perimeterInfos.length;n++)this.perimeterInfos.push(t(e.perimeterInfos[n],null,null,null,!1));for(this.textLines=[],n=0;n<e.textLines.length;n++){var p={};p.start=new THREE.Vector3(e.textLines[n].start.x,e.textLines[n].start.y,e.textLines[n].start.z),p.end=new THREE.Vector3(e.textLines[n].end.x,e.textLines[n].end.y,e.textLines[n].end.z),p.uuid=e.textLines[n].uuid,this.textLines.push(p)}e.snappedPoint?this.MeasureOper.snappedPoint=new THREE.Vector3(e.snappedPoint.x,e.snappedPoint.y,e.snappedPoint.z):this.MeasureOper.snappedPoint=null;var S=e.rootObject;if(S&&0==S.length&&(this.rootObject.children=[]),S&&0<S.length){this.rootObject.children=[];for(var g,E=null,n=0;n<S.length;){var m=null;switch(S[n++]){case 0:var O=f[S[n++]],b=f[S[n++]],m=this.viewer.is2DModel?this.MeasureOper.createLineMesh2(O,b,this.MeasureOper.materialLine,1):this.MeasureOper.createLineMesh2(O,b,NDSWebViewer.SETTING.selectedEdgeMaterial,1);break;case 1:O=f[S[n++]],b=f[S[n++]];m=this.MeasureOper.createLineMesh3(O,b,NDSWebViewer.SETTING.selectedEdgeMaterial,1);break;case 2:var O=f[S[n++]],P=f[S[n++]],b=f[S[n++]];m=this.MeasureOper.createLineMesh4(O,P,b,this.MeasureOper.materialLine);break;case 3:var O=f[S[n++]],b=f[S[n++]],P=f[S[n++]],M=f[S[n++]],T=this.MeasureOper.materialLine.clone();T.color.setRGB(M.x,M.y,M.z),(m=this.MeasureOper.createCylinderMesh(O,b,T)).position.copy(P);break;case 4:M=S[n++],r=f[S[n++]];m=this.MeasureOper.createPointMesh(r,0==M?this.MeasureOper.materialPoint:this.MeasureOper.materialProjectPoint,this.MeasureOper.POINTSIZE);break;case 5:var x=this.viewer.ndsModel.getBodyNode(S[n++]).uuid,y=this.viewer.ndsModel.geomManager.geoms[S[n++]].uuid,C=S[n++],N=this.viewer.brepManager.GetBrepInfoByUUidAndTopolIndex(x,y,C,"face"),T=S[n++],L=this.viewer.ndsModel.meshManager.getSingleMesh(T),w=!!S[n++];L&&N&&(N.parentObj=L,N.geometry=L.geometry,N.bodyUuid=x,N.topolIndex=C,N.meshId=T,N.matrixWorld=L.matrixWorld.clone(),m=this.MeasureOper.createFace(N,w));break;case 6:O=f[S[n++]],b=f[S[n++]];m=this.MeasureOper.createLineMesh3(O,b,this.MeasureOper.axisLine,1);break;case 7:var x=this.viewer.ndsModel.getBodyNode(S[n++]).uuid,y=this.viewer.ndsModel.geomManager.geoms[S[n++]].uuid,C=S[n++],N=this.viewer.brepManager.GetBrepInfoByUUidAndTopolIndex(x,y,C,"edge"),A=S[n++],L=this.viewer.ndsModel.meshManager.getLineSegments(A),w=!!S[n++];L&&N&&(N.parentObj=L,N.geometry=L.geometry,N.bodyUuid=x,N.matrixWorld=L.matrixWorld.clone(),N.topolIndex=C,N.lineSegId=A,m=this.MeasureOper.createLine(N,w));break;case 8:for(var v=[],D=0;D<8;D++,n+=3){var R=new THREE.Vector3(S[n],S[n+1],S[n+2]);v.push(R)}m=this.MeasureOper.createBodyBoundingBox(v);break;case 9:for(var V=[],j=S[n++],D=0;D<j;D+=2,n+=2)V.push(S[n]),V.push(S[n+1]),V.push(0);m=this.MeasureOper.createContour(V);break;case 10:A=S[n++];(m=new THREE.Group).objectType="Group",m.uuid=A,E=m,1==(g=S[n++])&&(m.name="unsteady")}m&&(d||"Group"==m.type?"Group"==m.type?0==g?(this.rootObject.add(m),this.measureTimes++):1==g&&this.rootObject.children[this.rootObject.children.length-1].add(m):null!==E&&E.add(m):this.rootObject.add(m))}}"radius"==this.measureType?e.holeInfotextPos&&e.holeInfofstClndPos&&(this.MeasureOper.holeInfo.textPos=new THREE.Vector3(e.holeInfotextPos.x,e.holeInfotextPos.y,e.holeInfotextPos.z),this.MeasureOper.holeInfo.fstClndPos=new THREE.Vector3(e.holeInfofstClndPos.x,e.holeInfofstClndPos.y,e.holeInfofstClndPos.z)):"faceArea"==this.measureType?this.viewer.dispatchEvent({type:"FaceSelectionChangeEvent",faceArea:e.faceArea,modelUnit:e.faceAreaunit}):"BoundingBox"==this.measureType&&this.MeasureOper.measureBoundingBox(!0)}},S.prototype.isInLinearguage3DAndMeasureLatestComponentMode=function(e){return"Lineargauge3D"===this.MeasureOper.measureClass&&!this.lineargauge3DProcessedLineSet.has(e.uuid)&&this.isInMeasure()},S.prototype.CreateVector3=function(e){for(var t in e){var n=e[t];n&&(null!=n.x&&null!=n.y&&null!=n.z?e[t]=new THREE.Vector3(n.x,n.y,n.z):"[object Object]"===Object.prototype.toString.call(n)&&this.CreateVector3(n))}},S.prototype.setMeasureBox=function(e){e&&e.textBox&&e.textPos&&(this.textBoxBroadcast||(this.textBoxBroadcast=document.createElement("div"),this.textBoxBroadcast.className="mearesult",this.viewer.container.appendChild(this.textBoxBroadcast)),this.textPosBroadcast=new THREE.Vector3(e.textPos.x,e.textPos.y,e.textPos.z),e=this.dimString+this.unit,this.MeasureOper.getAndShowTextBox(this.textPosBroadcast.clone(),e,this.textBoxBroadcast))},S.prototype.clearMeasureBox=function(){this.textBoxBroadcast&&(this.viewer.container.removeChild(this.textBoxBroadcast),this.textBoxBroadcast=null,this.textPosBroadcast=null),this.MeasureOper.clearFaceInfo(),this.MeasureOper.clearHoleInfo(),this.MeasureOper.clearEdgeInfo(),this.MeasureOper.clearDistanceInfo(),this.MeasureOper.clearLineAngleInfo(),this.MeasureOper.clearContoursInfo()},S.prototype.setDimString=function(e,t){switch(this.measureType){case"pt2pt":case"PointToLine":case"PointToFace":case"LineToLine":case"LineToFace":case"AxisToPoint":case"AxisToLine":case"AxisToFace":case"LineAngle":case"LineFaceAngle":case"faceDist":this.MeasureOper.distanceInfo.dimString=e,this.MeasureOper.distanceInfo.unit=t;break;case"faceAngle":this.MeasureOper.faceInfo.dimString=e,this.MeasureOper.faceInfo.unit=t;break;case"measureEdges":this.MeasureOper.edgeInfo.dimString=e,this.MeasureOper.edgeInfo.unit=t;break;case"bodyAngle":this.MeasureOper.faceInfo.dimString=e,this.MeasureOper.faceInfo.unit=t;break;case"bodyDistance":this.MeasureOper.distanceInfo.dimString=e,this.MeasureOper.distanceInfo.unit=t;break;case"bodyEdgeLength":this.MeasureOper.edgeInfo.dimString=e,this.MeasureOper.edgeInfo.unit=t}},S.prototype.getDimString=function(){switch(this.measureType){case"pt2pt":case"PointToLine":case"PointToFace":case"LineToLine":case"LineToFace":case"AxisToPoint":case"AxisToLine":case"AxisToFace":case"Lineargauge":case"LmPt2Pt":case"LmPt2Line":case"LmLine2Line":case"LmHole2Hole":case"LmAxis2Pt":case"LmAxis2Line":case"WallThickness":case"faceDist":case"holeDist":return{str:(this.MeasureOper.distanceInfo.dimString*this.viewer.measuringScale).toFixed(this.viewer.Decimal),unit:this.MeasureOper.distanceInfo.unit};case"LineAngle":case"LineFaceAngle":return{str:this.MeasureOper.lineAngleInfo.dimString,unit:this.MeasureOper.lineAngleInfo.unit};case"faceAngle":return{str:this.MeasureOper.faceInfo.dimString,unit:this.MeasureOper.faceInfo.unit};case"measureEdges":var e="";return{str:e=""!=this.MeasureOper.edgeInfo.dimString?""==this.MeasureOper.edgeInfo.dimString[0]?" "+(this.MeasureOper.edgeInfo.dimString.slice(2)*this.viewer.measuringScale).toFixed(this.viewer.Decimal):(this.MeasureOper.edgeInfo.dimString*this.viewer.measuringScale).toFixed(this.viewer.Decimal):e,unit:this.MeasureOper.edgeInfo.unit};case"radius":return""==this.MeasureOper.holeInfo.dimString?{str:this.MeasureOper.holeInfo.dimString,unit:this.MeasureOper.holeInfo.unit}:{str:e=this.MeasureOper.holeInfo.dimString.slice(0,2)+(this.MeasureOper.holeInfo.dimString.slice(2)*this.viewer.measuringScale).toFixed(this.viewer.Decimal),unit:this.MeasureOper.holeInfo.unit};case"coordinate":return{str:this.MeasureOper.coordinatedivdims,unit:" "};case"bodyAngle":return this.MeasureOper.lineAngleInfo.dimString?{str:this.MeasureOper.lineAngleInfo.dimString,unit:this.MeasureOper.lineAngleInfo.unit}:{str:this.MeasureOper.faceInfo.dimString,unit:this.MeasureOper.faceInfo.unit};case"bodyDistance":return{str:(this.MeasureOper.distanceInfo.dimString*this.viewer.measuringScale).toFixed(this.viewer.Decimal),unit:this.MeasureOper.distanceInfo.unit};case"bodyEdgeLength":e="";return{str:e=""!=this.MeasureOper.edgeInfo.dimString?""==this.MeasureOper.edgeInfo.dimString[0]?" "+(this.MeasureOper.edgeInfo.dimString.slice(2)*this.viewer.measuringScale).toFixed(this.viewer.Decimal):(this.MeasureOper.edgeInfo.dimString*this.viewer.measuringScale).toFixed(this.viewer.Decimal):e,unit:this.MeasureOper.edgeInfo.unit}}},S.prototype.createMouseZoomArea=function(){var e,t,n;this.hasZoomArea||(t=document.createElement("div"),(e=document.createElement("canvas")).id="ZoomArea",e.style.height=this.pixWidth+"px",e.style.width=this.pixWidth+"px",t.id="ZoomCanvas",t.style.zIndex=4,t.style.width=this.pixWidth+"px",t.style.height=this.pixWidth+"px",t.style.position="fixed",t.style.top="20px",t.style.left="20px",t.onmouseup=function(e){n.singleTouchEndPos.set(e.clientX,e.clientY),e.preventDefault(),n.onTouchSingleEnd(e)},t.onmousedown=function(e){n.singleTouchStartPos.set(e.clientX,e.clientY),e.preventDefault(),n.onTouchSingleStart(e)},t.appendChild(e),this.viewer.container.appendChild(t),this.hasZoomArea=!0,this.imgMouseObject=new Image,t="img/mouse_"+this.dpr.toString()+"x.png",this.imgMouseObject.src=this.viewer.serverUrl?this.viewer.serverUrl+t:t,(n=this).imgMouseObject.onload=function(){e.width=Math.floor(n.imgMouseObject.width*n.dpr),e.height=Math.floor(n.imgMouseObject.height*n.dpr)})},S.prototype.changeMouseZoomArea=function(e){var t,n,i;this.showMouseZoomArea&&(t=document.getElementById("ZoomCanvas"))&&("inline"==t.style.display||e)&&(n=this.viewer.container.getBoundingClientRect(),i=parseInt(this.pointer.x)-this.pixWidth/2+n.left,n=parseInt(this.pointer.y)-this.pixWidth+n.top,t.style.top=n+"px",t.style.left=i+"px",i=(n=document.getElementById("ZoomArea")).getContext("2d"),n.width=this.imgMouseObject.width*this.dpr,n.height=this.imgMouseObject.height*this.dpr,i.scale(this.dpr,this.dpr),i.drawImage(this.imgMouseObject,0,0),"inline"!=t.style.display)&&e&&(t.style.display="inline")},S.prototype.createZoomArea=function(){var e,t,n,i;this.hasZoomArea||(e=document.createElement("div"),(n=document.createElement("canvas")).id="ZoomArea",n.style.height=this.pixWidth+"px",n.style.width=this.pixWidth+"px",e.id="ZoomCanvas",e.style.zIndex=4,e.style.width=this.pixWidth+"px",e.style.height=this.pixWidth+"px",e.style.position="fixed",e.style.top="20px",e.style.left="20px",e.onmouseup=function(e){t.singleTouchEndPos.set(e.clientX,e.clientY),t.onTouchSingleEnd(e)},e.onmousedown=function(e){t.singleTouchStartPos.set(e.clientX,e.clientY),t.onTouchSingleStart(e)},e.appendChild(n),this.viewer.container.appendChild(e),this.hasZoomArea=!0,n=(t=this).viewer.getScreenCapture(null,null,null),this.imageData=n,(i=new Image).src=n,i.onload=function(){var e=t.viewer.container.getBoundingClientRect();t.clientWidthRatio=i.width/e.width,t.clientHeightRatio=i.height/e.height})},S.prototype.clearZoomArea=function(){var e,t=document.getElementById("ZoomArea"),t=(t&&t.getContext("2d").clearRect(0,0,this.pixWidth,this.pixWidth),document.getElementById("ZoomCanvas"));t&&(e=document.getElementById("ZoomArea"),t.removeChild(e),this.viewer.container.removeChild(t),this.hasZoomArea=!1),this.imageData=null},S.prototype.getZoomAreaVisible=function(){var e=document.getElementById("ZoomCanvas");return!!e&&"inline"==e.style.display},S.prototype.invisible=function(){var e=document.getElementById("ZoomCanvas"),e=(e&&(e.style.display="none"),document.getElementById("ZoomArea"));e&&e.getContext("2d").clearRect(0,0,this.pixWidth,this.pixWidth),this.imageData=null},S.prototype.changeZoomArea=function(e){var s,t,o,n=document.getElementById("ZoomCanvas");this.clientHeightRatio&&n&&("inline"==n.style.display||e)&&(this.imageData?t=this.imageData:(t=this.viewer.getScreenCapture(null,null,null),this.imageData=t),t=this.viewer.getScreenCapture(null,null,null),(s=new Image).src=t,t=this.viewer.container.getBoundingClientRect(),s.width=t.width*this.clientWidthRatio,s.height=t.height*this.clientHeightRatio,o=this,s.onload=function(){var e=o.pixWidth;o.getImagePortion(s,e,e,o.pointer.x*o.clientWidthRatio-e/2,o.pointer.y*o.clientHeightRatio-e/2,1);var t,n,i=document.getElementById("ZoomArea").getContext("2d");i.moveTo(e/2-20,e/2),i.lineTo(e/2+20,e/2),i.moveTo(e/2,e/2-20),i.lineTo(e/2,e/2+20),i.lineWidth=1,i.strokeStyle="#FF0000",i.stroke(),o.MeasureOper.snappedPoint&&(n=o.MeasureOper.get2dPoint(o.MeasureOper.snappedPoint.clone()),t=o.pointer.x*o.clientWidthRatio-n.x,n=o.pointer.y*o.clientHeightRatio-n.y,i.fillStyle="#00FFFF",i.beginPath(),i.arc(e/2-t,e/2-n,2,0,2*Math.PI),i.closePath(),i.fill())},"inline"!=n.style.display)&&e&&(n.style.display="inline")},S.prototype.getImagePortion=function(e,t,n,i,s,o){var r=document.getElementById("ZoomArea"),a=r.getContext("2d"),r=(r.width=t,r.height=n,document.createElement("canvas")),l=r.getContext("2d");r.width=e.width,r.height=e.height,l.drawImage(e,0,0),a.drawImage(r,i,s,t*o,n*o,0,0,t,n)},S.prototype.resetMeasureTimesWithMeasureContent=function(e){e.boxInfos&&(this.measureTimes=e.boxInfos.length)};class g extends NDSWebViewer.Extension{constructor(){super(),this.name="NDSMeasureExtension",console.log("NDSMeasureExtension version 0.1"),this.viewer=null}getMeasure(){return new S(this.viewer)}load(e){this.viewer||(super.load(e),this.viewer=e)}unload(e){this.release(),super.unload(e)}}let E=new g;NDSWebViewer.ExtensionManager.addExtension(E),NDSWebViewer.MeasureBase=i}],i={},s.m=n,s.c=i,s.d=function(e,t,n){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(s.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)s.d(n,i,function(e){return t[e]}.bind(null,i));return n},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=0);function s(e){var t;return(i[e]||(t=i[e]={i:e,l:!1,exports:{}},n[e].call(t.exports,t,t.exports,s),t.l=!0,t)).exports}var n,i});