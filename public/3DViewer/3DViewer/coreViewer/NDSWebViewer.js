!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.NDSWebViewer=t():e.NDSWebViewer=t()}(window,function(){return r=[function(e,t,r){!function(t,e){var r,i;r=window,i="function"==typeof(i=r.atob)?i:"function"==typeof t?function(e){return new t(e,"base64").toString("binary")}:"object"==typeof r.base64js?function(e){e=r.base64js.b64ToByteArray(e);return Array.prototype.map.call(e,function(e){return String.fromCharCode(e)}).join("")}:function(){throw new Error("You're probably in an old browser or an iOS webworker. It might help to include beatgammit's base64-js.")},r.atob=i,e&&e.exports&&(e.exports=i)}.call(this,r(14).Buffer,r(19)(e))},function(e,t){THREE.RGBFormat=THREE.RGBAFormat,THREE.RGBIntegerFormat=THREE.RGBAIntegerFormat},function(e,t){THREE.Geometry=THREE.CompatibleGeometry,THREE.Geometry.prototype.applyMatrix=THREE.Geometry.prototype.applyMatrix4;var r=0;THREE.GeometryIdCount=function(){return r++},THREE.BufferGeometry.prototype.spatial_partition=null,THREE.BufferGeometry.prototype.buildSpatialPartition=function(){this.boundingBox&&!this.boundingBox.isEmpty()||this.computeBoundingBox();var e={max:[this.boundingBox.max.x,this.boundingBox.max.y,this.boundingBox.max.z],min:[this.boundingBox.min.x,this.boundingBox.min.y,this.boundingBox.min.z]},t=(this.spatial_partition=[],new THREE.Vector3),t=1<(t=this.boundingBox.getSize(t).length()/10)?Math.floor(t):t;THREE.buildGeometryGrid(this.attributes.position.array,this.index?this.index.array:null,this.drawRange,null,null,e,t,-1,this.spatial_partition)}},function(e,t){THREE.Matrix3.prototype.getInverse=function(e,t){e&&e.isMatrix4&&console.error("THREE.Matrix3: .getInverse() no longer takes a Matrix4 argument.");var e=e.elements,r=this.elements,i=e[0],n=e[1],a=e[2],o=e[3],s=e[4],l=e[5],d=e[6],c=e[7],e=e[8],h=e*s-l*c,u=l*d-e*o,p=c*o-s*d,f=i*h+n*u+a*p;if(0==f){var m="THREE.Matrix3: .getInverse() can't invert matrix, determinant is 0";if(!0===t)throw new Error(m);return console.warn(m),this.identity()}t=1/f;return r[0]=h*t,r[1]=(a*c-e*n)*t,r[2]=(l*n-a*s)*t,r[3]=u*t,r[4]=(e*i-a*d)*t,r[5]=(a*o-l*i)*t,r[6]=p*t,r[7]=(n*d-c*i)*t,r[8]=(s*i-n*o)*t,this}},function(e,t){THREE.Matrix4.prototype.getInverse=function(e,t){var r=this.elements,e=e.elements,i=e[0],n=e[1],a=e[2],o=e[3],s=e[4],l=e[5],d=e[6],c=e[7],h=e[8],u=e[9],p=e[10],f=e[11],m=e[12],g=e[13],v=e[14],e=e[15],y=u*v*c-g*p*c+g*d*f-l*v*f-u*d*e+l*p*e,A=m*p*c-h*v*c-m*d*f+s*v*f+h*d*e-s*p*e,M=h*g*c-m*u*c+m*l*f-s*g*f-h*l*e+s*u*e,E=m*u*d-h*g*d-m*l*p+s*g*p+h*l*v-s*u*v,w=i*y+n*A+a*M+o*E;if(0==w){var x="THREE.Matrix4: .getInverse() can't invert matrix, determinant is 0";if(!0===t)throw new Error(x);return console.warn(x),this.identity()}t=1/w;return r[0]=y*t,r[1]=(g*p*o-u*v*o-g*a*f+n*v*f+u*a*e-n*p*e)*t,r[2]=(l*v*o-g*d*o+g*a*c-n*v*c-l*a*e+n*d*e)*t,r[3]=(u*d*o-l*p*o-u*a*c+n*p*c+l*a*f-n*d*f)*t,r[4]=A*t,r[5]=(h*v*o-m*p*o+m*a*f-i*v*f-h*a*e+i*p*e)*t,r[6]=(m*d*o-s*v*o-m*a*c+i*v*c+s*a*e-i*d*e)*t,r[7]=(s*p*o-h*d*o+h*a*c-i*p*c-s*a*f+i*d*f)*t,r[8]=M*t,r[9]=(m*u*o-h*g*o-m*n*f+i*g*f+h*n*e-i*u*e)*t,r[10]=(s*g*o-m*l*o+m*n*c-i*g*c-s*n*e+i*l*e)*t,r[11]=(h*l*o-s*u*o-h*n*c+i*u*c+s*n*f-i*l*f)*t,r[12]=E*t,r[13]=(h*g*a-m*u*a+m*n*p-i*g*p-h*n*v+i*u*v)*t,r[14]=(m*l*a-s*g*a-m*n*d+i*g*d+s*n*v-i*l*v)*t,r[15]=(s*u*a-h*l*a+h*n*d-i*u*d-s*n*p+i*l*p)*t,this}},function(e,t){THREE.Quaternion.prototype.inverse=function(){return this.conjugate().normalize()}},function(e,t){THREE.Object3D.prototype.applyMatrix=function(e){this.applyMatrix4(e)}},function(e,t){function q(){this.indices=[],this.boundingBox=null,this.parent=-1}THREE.buildGeometryGrid=function(e,t,r,i,n,a,o,s,l){if(void 0===o&&(o=10),t){if(!i){var O=-1===r.count?0:r.start,d=(-1===r.count?t.length:r.count)/3;i=new Int32Array(d);for(var c=O/3,h=0;h<d;++c)i[h++]=c}if(!(i.length<3e3)){for(var u=!0,p=(n||(n=new Float32Array(6*i.length),u=!1),Math.ceil((a.max[0]-a.min[0])/o)),f=Math.ceil((a.max[1]-a.min[1])/o),m=Math.ceil((a.max[2]-a.min[2])/o),g=new Array(p*f*m),v=0;v<p;v++)for(var y=0;y<f;y++)for(var A=0;A<m;A++){var F=v+y*p+A*p*f,M=new q;M.boundingBox={min:[a.min[0]+v*o,a.min[1]+y*o,a.min[2]+A*o],max:[a.min[0]+(v+1)*o,a.min[1]+(y+1)*o,a.min[2]+(A+1)*o]},M.boundingBox.max[0]>a.max[0]&&(M.boundingBox.max[0]=a.max[0]),M.boundingBox.max[1]>a.max[1]&&(M.boundingBox.max[1]=a.max[1]),M.boundingBox.max[2]>a.max[2]&&(M.boundingBox.max[2]=a.max[2]),g[F]=M}for(var U=a.min[0],N=a.min[1],V=a.min[2],E=1/o,w=0,G=i.length;w<G;++w){var x,b,B,I=i[w],T=6*(I-(-1===r.count?0:r.start)/3);u||(B=3*I,x={x:e[S=3*(t?t[B]:B)],y:e[1+S],z:e[2+S]},b={x:e[S=3*(t?t[1+B]:1+B)],y:e[1+S],z:e[2+S]},B={x:e[S=3*(t?t[2+B]:2+B)],y:e[1+S],z:e[2+S]},n[T]=Math.min(x.x,Math.min(b.x,B.x)),n[1+T]=Math.min(x.y,Math.min(b.y,B.y)),n[2+T]=Math.min(x.z,Math.min(b.z,B.z)),n[3+T]=Math.max(x.x,Math.max(b.x,B.x)),n[4+T]=Math.max(x.y,Math.max(b.y,B.y)),n[5+T]=Math.max(x.z,Math.max(b.z,B.z)));for(var S=0<=(S=Math.floor((n[T]-U)*E))?S:0,R=0<=(R=Math.floor((n[1+T]-N)*E))?R:0,C=0<=(C=Math.floor((n[2+T]-V)*E))?C:0,k=Math.floor((n[3+T]-U)*E),j=Math.floor((n[4+T]-N)*E),z=Math.floor((n[5+T]-V)*E),D=S;D<=k;D++)for(var P=R;P<=j;P++)for(var H=C;H<=z;H++){var W=D+P*p+H*p*f;W>=g.length||g[W].indices.push(I)}}for(var _=0,X=g.length;_<X;_++){var L=g[_];0<L.indices.length&&(3e3<L.indices.length?(l[l.length]={boundingBox:L.boundingBox,parent:s},THREE.buildGeometryGrid(e,t,r,L.indices,n,L.boundingBox,o/2,l.length-1,l)):l[l.length]={index:L.index,boundingBox:L.boundingBox,indices:L.indices,parent:s})}}}}},function(e,t){THREE.BufferGeometry.prototype.addAttribute=THREE.BufferGeometry.prototype.setAttribute,THREE.BufferGeometry.prototype.applyMatrix=THREE.BufferGeometry.prototype.applyMatrix4},function(e,t){THREE.Math=THREE.MathUtils,THREE.Frustum.prototype.intersectsSphere2=function(e){for(var t=this.planes,r=e.center,i=-e.radius,n=0,a=0;a<6;a++){var o=t[a].distanceToPoint(r);if(o<i)return 0;o>=e.radius&&++n}return 6===n?2:1}},function(e,t){THREE.Triangle.normal=function(e,t,r){return THREE.Triangle.getNormal(e,t,r,new THREE.Vector3)}},function(e,t){THREE.Matrix4D=function(){THREE.Matrix4.call(this),this.elements=new Float64Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])},THREE.Matrix4D.prototype=Object.create(THREE.Matrix4.prototype)},function(e,t){THREE.ShaderChunk.mesh_modelMatrix_map_vertex="\n    #ifdef BATCHED_MESH\n    uniform drawId2MeshIdData {\n        ivec4 drawId2MeshId[256];\n    };\n    #endif\n\n    #ifdef SUPPORT_UNIFORM_BLOCK\n        uniform bodyWorldMatrixData {\n            mat4 bodyWorldMatrix[1024];\n        };\n    #else\n        uniform highp sampler2D bodyNodeWorldMatrixMap;\n        uniform int bodyNodeWorldMatrixMapSize;\n    #endif\n    \n    uniform ivec2 meshId2BodyIdParam; // [0] - meshset.meshOffset; [1] - meshset.meshId2BodyIdTexSize\n    uniform highp usampler2D meshId2BodyIdMap;\n    uniform int bodyWorldMatrixOffset;\n    #ifndef DEPTH_ONLY\n      varying float _mesh_id_;\n      varying float _color_;\n      varying float _opacity_;\n    #endif\n    mat4 getModelMatrix() {\n        #ifdef BATCHED_MESH\n          int _i = gl_DrawID/2;\n          int _j = gl_DrawID - _i*2;\n          meshId = drawId2MeshId[_i][_j*2];\n          #ifndef DEPTH_ONLY\n            color_opacity = drawId2MeshId[_i][_j*2+1];\n          #endif\n            int size = meshId2BodyIdParam[1];\n            int x = (meshId2BodyIdParam[0] + meshId) % size;\n            int y = (meshId2BodyIdParam[0] + meshId) / size;\n        #else\n        #ifdef INSTANCE_MESH\n            int size = meshId2BodyIdParam[1];\n            int x = (meshId2BodyIdParam[0] + meshId) % size;\n            int y = (meshId2BodyIdParam[0] + meshId) / size;\n        #else\n        #ifdef DEPTH_ONLY\n            int size = meshId2BodyIdParam[1];\n            int x = (meshId2BodyIdParam[0] + meshId) % size;\n            int y = (meshId2BodyIdParam[0] + meshId) / size;\n        #else\n            int size = meshId2BodyIdParam[1];\n            int x = (meshId2BodyIdParam[0] + meshId.x) % size;\n            int y = (meshId2BodyIdParam[0] + meshId.x) / size;\n        #endif\n        #endif\n        #endif\n\n        int bodyId = int(texelFetch( meshId2BodyIdMap, ivec2( x, y ), 0 ).r);\n        //\n        #ifdef SUPPORT_UNIFORM_BLOCK\n            mat4 res = bodyWorldMatrix[bodyWorldMatrixOffset+bodyId];\n        #else\n            int matrixTextureY = (bodyWorldMatrixOffset+bodyId) * 4 / bodyNodeWorldMatrixMapSize;\n            int matrixTextureX =  (bodyWorldMatrixOffset+bodyId) * 4 % bodyNodeWorldMatrixMapSize;\n            \n            vec4 col0 = texelFetch( bodyNodeWorldMatrixMap, ivec2( matrixTextureX + 0, matrixTextureY ), 0 );\n            vec4 col1 = texelFetch( bodyNodeWorldMatrixMap, ivec2( matrixTextureX + 1, matrixTextureY ), 0 );\n            vec4 col2 = texelFetch( bodyNodeWorldMatrixMap, ivec2( matrixTextureX + 2, matrixTextureY ), 0 );\n            vec4 col3 = texelFetch( bodyNodeWorldMatrixMap, ivec2( matrixTextureX + 3, matrixTextureY ), 0 );\n            mat4 res = mat4(col0, col1, col2, col3);\n        #endif\n        return res;\n    }\n\n    ivec2 getMtlColorOpacity(int input_color_opacity) {\n        if (input_color_opacity < 0) return ivec2(-2, 0);\n        int color = input_color_opacity/16; \n\t\tint opacity = input_color_opacity - color*16;\n        return ivec2(color, opacity);\n    }\n    \n    ",THREE.ShaderChunk.mesh_mtl_map_fragment="\n    #ifdef SUPPORT_GLOBAL_MTL_BLOCK\n        uniform globalMtlData {\n            ivec4 globalMtl[1024];\n        };\n    #else\n        uniform highp isampler2D globalMtlMap;\n        uniform int globalMtlMapSize;\n    #endif\n\n    uniform ivec2 meshMtlParam;\n    uniform highp sampler2D meshMtlMap;\n    varying float _mesh_id_;\n    varying float _color_;\n    varying float _opacity_;\n    int mesh_id = 0;\n    int mesh_color = 0;\n    int mesh_opacity = 0;\n    ivec4 getMeshMtl() {\n        int size = meshMtlParam.y;\n\t\tint x = (meshMtlParam.x + mesh_id) % size;\n\t\tint y = (meshMtlParam.x + mesh_id) / size;\n        vec4 res = texelFetch( meshMtlMap, ivec2( x, y ), 0 );\n        return ivec4(int(res.x+0.1), int(res.y+0.1), int(res.z+0.1), int(res.w+0.1));\n    }\n    vec3 getColorFromHex(int v) {\n        int r = v/65536;\n        int g = (v - r*65536)/256;\n        int b = v - r*65536 - g*256;\n        return vec3(float(r)/255.0, float(g)/255.0, float(b)/255.0);\n    }\n    ",THREE.ShaderChunk.mesh_physical_mtl_ext_map_fragment="\n    float getEncodedFloatValue (int val) {\n        return float(val) / 1000.0;\n    }\n\n    // | 8bit | 8 bit | 4 bit | 4 bit |\n    ivec4 getFourChannelProperty(int v) {\n        int offset =  65536; // 256 * 16 * 16\n        int offset2 = 256; // 16 * 16\n        int offset3 = 16;\n        int x = v / offset;\n        int y = (v - x * offset) / offset2;\n        int z = (v - x * offset - y * offset2) / offset3;\n        int w = v - x * offset - y * offset2 - z * offset3;\n        return ivec4(x, y, z, w);\n    }\n    ",THREE.ShaderChunk.line_mtl_map_fragment="\n    uniform ivec2 lineMtlParam;\n    uniform highp sampler2D lineMtlMap;\n    varying float _mesh_id_;\n    varying float _color_;\n    varying float _opacity_;\n    int mesh_id = 0;\n    int line_color = 0;\n    int line_opacity = 0;\n    ivec2 getLineMtl() {\n        int size = lineMtlParam.y;\n\t\tint x = (lineMtlParam.x + mesh_id) % size;\n\t\tint y = (lineMtlParam.x + mesh_id) / size;\n        vec2 res = texelFetch( lineMtlMap, ivec2( x, y ), 0 ).rg;\n        return ivec2(int(res.x+0.1), int(res.y+0.1));\n    }\n    vec3 getColorFromHex(int v) {\n        int r = v/65536;\n        int g = (v - r*65536)/256;\n        int b = v - r*65536 - g*256;\n        return vec3(float(r)/255.0, float(g)/255.0, float(b)/255.0);\n    }\n    ",THREE.ShaderChunk["2D_mesh_modelMatrix_map_vertex"]="\n    #ifdef BATCHED_MESH\n    uniform drawId2MeshIdData {\n        ivec4 drawId2MeshId[256];\n    };\n    #endif\n    \n    #ifdef SUPPORT_UNIFORM_BLOCK\n        uniform bodyWorldMatrixData {\n            mat4 bodyWorldMatrix[1024];\n        };\n    #else\n        uniform highp sampler2D bodyNodeWorldMatrixMap;\n        uniform int bodyNodeWorldMatrixMapSize;\n    #endif\n    \n    uniform ivec2 meshId2BodyIdParam;\n    uniform highp usampler2D meshId2BodyIdMap;\n    uniform int bodyWorldMatrixOffset;\n    varying float _mesh_id_;\n    varying float _packColor;\n    varying float _usePackColor;\n    mat4 getModelMatrix() {\n        #ifdef BATCHED_MESH\n            int _i = gl_DrawID/2;\n            int _j = gl_DrawID - _i*2;\n            meshId.x = drawId2MeshId[_i][_j*2];\n            meshId.y = drawId2MeshId[_i][_j*2+1];\n        #endif\n\n        _mesh_id_ = float(meshId.x);\n        _usePackColor = (meshId.y & 0x1000000) == 0 ? -1.0f : 1.0f;\n        _packColor = float(meshId.y & 0xffffff);\n\n        int size = meshId2BodyIdParam[1];\n\t\tint x = (meshId2BodyIdParam[0] + meshId.x) % size;\n\t\tint y = (meshId2BodyIdParam[0] + meshId.x) / size;\n\n        int bodyId = int(texelFetch( meshId2BodyIdMap, ivec2( x, y ), 0 ).r);\n        //\n        #ifdef SUPPORT_UNIFORM_BLOCK\n            mat4 res = bodyWorldMatrix[bodyWorldMatrixOffset+bodyId];\n        #else\n            int matrixTextureY = (bodyWorldMatrixOffset+bodyId) * 4 / bodyNodeWorldMatrixMapSize;\n            int matrixTextureX =  (bodyWorldMatrixOffset+bodyId) * 4 % bodyNodeWorldMatrixMapSize;\n            \n            vec4 col0 = texelFetch( bodyNodeWorldMatrixMap, ivec2( matrixTextureX + 0, matrixTextureY ), 0 );\n            vec4 col1 = texelFetch( bodyNodeWorldMatrixMap, ivec2( matrixTextureX + 1, matrixTextureY ), 0 );\n            vec4 col2 = texelFetch( bodyNodeWorldMatrixMap, ivec2( matrixTextureX + 2, matrixTextureY ), 0 );\n            vec4 col3 = texelFetch( bodyNodeWorldMatrixMap, ivec2( matrixTextureX + 3, matrixTextureY ), 0 );\n            mat4 res = mat4(col0, col1, col2, col3);\n        #endif\n        return res;\n    }\n    \n    ",THREE.ShaderChunk["2D_line_mtl_map_fragment"]="\n    uniform ivec2 lineMtlParam;\n    uniform highp sampler2D lineMtlMap;\n    varying float _mesh_id_;\n    varying float _packColor;\n    varying float _usePackColor;\n    int mesh_id = 0;\n    ivec2 getLineMtl() {\n        int size = lineMtlParam[1];\n\t\tint x = (lineMtlParam[0] + mesh_id) % size;\n\t\tint y = (lineMtlParam[0] + mesh_id) / size;\n        vec2 res = texelFetch( lineMtlMap, ivec2( x, y ), 0 ).rg;\n        return ivec2(int(res[0]+0.1), int(res[1]+0.1));\n    }\n    vec3 getColorFromHex(int v) {\n        int r = v/65536;\n        int g = (v - r*65536)/256;\n        int b = v - r*65536 - g*256;\n        return vec3(float(r)/255.0, float(g)/255.0, float(b)/255.0);\n    }\n    ",THREE.ShaderChunk["2D_line_mtl_map_fragment_4v"]="\n    uniform ivec2 lineMtlParam;\n    uniform highp sampler2D lineMtlMap;\n    uniform ivec2 extraMtlParam;\n    uniform highp sampler2D extraMtlMap;\n    varying float _mesh_id_;\n    varying float _packColor;\n    varying float _usePackColor;\n    int mesh_id = 0;\n    vec4 getLineMtl() {\n        int size = lineMtlParam[1];\n\t\tint x = (lineMtlParam[0] + mesh_id) % size;\n\t\tint y = (lineMtlParam[0] + mesh_id) / size;\n        vec4 res = texelFetch( lineMtlMap, ivec2( x, y ), 0 );\n        return res;\n    }\n    vec3 getColorFromHex(int v) {\n        int r = v/65536;\n        int g = (v - r*65536)/256;\n        int b = v - r*65536 - g*256;\n        return vec3(float(r)/255.0, float(g)/255.0, float(b)/255.0);\n    }\n    ",THREE.ShaderChunk["2D_line_mtl_map_fragment_linedistacne"]="\n    if (lineMtl[2] > -0.1f)\n    {\n        int index = int(lineMtl[2] + 0.1f) * 16;\n\n        int index_x = index % extraMtlParam[1];\n        int index_y = index / extraMtlParam[1];\n\n        float pattern = texelFetch(extraMtlMap, ivec2(index_x, index_y), 0).x;\n        int num = int(texelFetch(extraMtlMap, ivec2(index_x + 1, index_y), 0).x + 0.1) + 2;\n\n        if (num > 2)\n        {\n            // 第一段长度\n            float curValue = texelFetch(extraMtlMap, ivec2(index_x + 2, index_y), 0).x;\n\n            // 线段总长\n            float totalDistance = vLineDistance[1] / lineMtl[3];\n\n            // 线型段数\n            int totalNum = int(totalDistance / pattern);\n\n            if (totalNum >= 1 && totalNum < 10000)\n            {\n\n                // 计算A类对齐的首尾偏移\n                float fAlign = curValue;\n                float ptScale = 1.0f;\n                if (vLineDistance[2] > 1.0f)\n                {\n                    fAlign = 0.0f;\n                    curValue = 0.0f;\n                    totalNum = int(totalDistance / pattern + 0.5);\n                    if (totalNum == 1 && num == 4)\n                        totalNum = 2;\n                    ptScale = totalDistance / (float(totalNum) * pattern);\n                }\n                else\n                {\n                    if (curValue > 0.0)\n                    {\n                        fAlign = (totalDistance - (pattern * float(totalNum) - curValue)) / 2.0;\n                    }\n                    else if (curValue < 0.0)\n                    {\n                        fAlign = (totalDistance - (pattern * float(totalNum) - curValue)) / 2.0;\n                        if (fAlign < 0.0)\n                            fAlign = -fAlign + curValue * 2.0;\n                    }\n                    else\n                    {\n                        fAlign = texelFetch(extraMtlMap, ivec2(index_x + 3, index_y), 0).x;\n                        if (fAlign < 0.0)\n                            fAlign = -fAlign;\n                        fAlign = -(totalDistance - (pattern * float(totalNum) - 2.0 * fAlign)) / 2.0;\n                    }\n                }\n\n                // 当前线的长度\n                float newDistance = vLineDistance[0] / lineMtl[3];\n\n                // 首尾内容按照第一段绘制\n                if (fAlign > 0.0f && (newDistance < fAlign || newDistance + fAlign > totalDistance))\n                {\n                    // 首尾平移\n                    if (curValue <= 0.0f)\n                    {\n                        discard;\n                    }\n                }\n                else\n                {\n                    // 绘制线型\n                    float modSize = mod(newDistance + abs(curValue) - abs(fAlign), pattern * ptScale);\n                    float totalValue = 0.0f;\n                    for (int i = 2; i < num; i++)\n                    {\n                        curValue = texelFetch(extraMtlMap, ivec2(index_x + i, index_y), 0).x;\n                        totalValue += abs(curValue* ptScale);\n                        if (totalValue >= modSize)\n                        {\n                            break;\n                        }\n                    }\n                    if (curValue <= 0.0f)\n                    {\n                        discard;\n                    }\n                }\n            }\n        }\n    }\n    "},function(e,t){THREE.Plane.prototype.transformProvidingInverse=function(e){var t=new THREE.Vector4(this.normal.x,this.normal.y,this.normal.z,this.constant);t.applyMatrix4(e.clone().transpose()),this.setComponents(t.x,t.y,t.z,t.w),this.normalize()}},function(e,P,H){!function(e){var b=H(16),a=H(17),s=H(18);function r(){return h.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function l(e,t){if(r()<t)throw new RangeError("Invalid typed array length");return h.TYPED_ARRAY_SUPPORT?(e=new Uint8Array(t)).__proto__=h.prototype:(e=null===e?new h(t):e).length=t,e}function h(e,t,r){if(!(h.TYPED_ARRAY_SUPPORT||this instanceof h))return new h(e,t,r);if("number"!=typeof e)return i(this,e,t,r);if("string"==typeof t)throw new Error("If encoding is specified then the first argument must be a string");return o(this,e)}function i(e,t,r,i){if("number"==typeof t)throw new TypeError('"value" argument must not be a number');if("undefined"!=typeof ArrayBuffer&&t instanceof ArrayBuffer){var n=e,a=t,o=r;if(a.byteLength,o<0||a.byteLength<o)throw new RangeError("'offset' is out of bounds");if(a.byteLength<o+(i||0))throw new RangeError("'length' is out of bounds");return a=void 0===o&&void 0===i?new Uint8Array(a):void 0===i?new Uint8Array(a,o):new Uint8Array(a,o,i),h.TYPED_ARRAY_SUPPORT?(n=a).__proto__=h.prototype:n=d(n,a),n}if("string"!=typeof t){o=e,i=t;if(h.isBuffer(i))return a=0|c(i.length),0!==(o=l(o,a)).length&&i.copy(o,0,0,a),o;if(i){if("undefined"!=typeof ArrayBuffer&&i.buffer instanceof ArrayBuffer||"length"in i)return"number"!=typeof i.length||function(e){return e!=e}(i.length)?l(o,0):d(o,i);if("Buffer"===i.type&&s(i.data))return d(o,i.data)}throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.")}n=e,i=t,e=r;if(h.isEncoding(e="string"==typeof e&&""!==e?e:"utf8"))return t=0|u(i,e),n=(i=(n=l(n,t)).write(i,e))!==t?n.slice(0,i):n;throw new TypeError('"encoding" must be a valid string encoding')}function n(e){if("number"!=typeof e)throw new TypeError('"size" argument must be a number');if(e<0)throw new RangeError('"size" argument must not be negative')}function o(e,t){if(n(t),e=l(e,t<0?0:0|c(t)),!h.TYPED_ARRAY_SUPPORT)for(var r=0;r<t;++r)e[r]=0;return e}function d(e,t){var r=t.length<0?0:0|c(t.length);e=l(e,r);for(var i=0;i<r;i+=1)e[i]=255&t[i];return e}function c(e){if(e>=r())throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+r().toString(16)+" bytes");return 0|e}function u(e,t){if(h.isBuffer(e))return e.length;if("undefined"!=typeof ArrayBuffer&&"function"==typeof ArrayBuffer.isView&&(ArrayBuffer.isView(e)||e instanceof ArrayBuffer))return e.byteLength;var r=(e="string"!=typeof e?""+e:e).length;if(0===r)return 0;for(var i=!1;;)switch(t){case"ascii":case"latin1":case"binary":return r;case"utf8":case"utf-8":case void 0:return R(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*r;case"hex":return r>>>1;case"base64":return C(e).length;default:if(i)return R(e).length;t=(""+t).toLowerCase(),i=!0}}function t(e,t,r){var i,n=!1;if((t=void 0===t||t<0?0:t)>this.length)return"";if((r=void 0===r||r>this.length?this.length:r)<=0)return"";if((r>>>=0)<=(t>>>=0))return"";for(e=e||"utf8";;)switch(e){case"hex":var a=this,o=t,s=r,l=a.length;(!s||s<0||l<s)&&(s=l);for(var d="",c=o=!o||o<0?0:o;c<s;++c)d+=function(e){return e<16?"0"+e.toString(16):e.toString(16)}(a[c]);return d;case"utf8":case"utf-8":return B(this,t,r);case"ascii":var h=this,l=t,u=r,p="";u=Math.min(h.length,u);for(var f=l;f<u;++f)p+=String.fromCharCode(127&h[f]);return p;case"latin1":case"binary":var m=this,o=t,g=r,v="";g=Math.min(m.length,g);for(var y=o;y<g;++y)v+=String.fromCharCode(m[y]);return v;case"base64":return A=this,i=r,0===(M=t)&&i===A.length?b.fromByteArray(A):b.fromByteArray(A.slice(M,i));case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":for(var A=t,M=r,E=this.slice(A,M),w="",x=0;x<E.length;x+=2)w+=String.fromCharCode(E[x]+256*E[x+1]);return w;default:if(n)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),n=!0}}function p(e,t,r){var i=e[t];e[t]=e[r],e[r]=i}function f(e,t,r,i,n){if(0===e.length)return-1;if("string"==typeof r?(i=r,r=0):2147483647<r?r=2147483647:r<-2147483648&&(r=-2147483648),r=+r,(r=(r=isNaN(r)?n?0:e.length-1:r)<0?e.length+r:r)>=e.length){if(n)return-1;r=e.length-1}else if(r<0){if(!n)return-1;r=0}if("string"==typeof t&&(t=h.from(t,i)),h.isBuffer(t))return 0===t.length?-1:m(e,t,r,i,n);if("number"==typeof t)return t&=255,h.TYPED_ARRAY_SUPPORT&&"function"==typeof Uint8Array.prototype.indexOf?(n?Uint8Array.prototype.indexOf:Uint8Array.prototype.lastIndexOf).call(e,t,r):m(e,[t],r,i,n);throw new TypeError("val must be string, number or Buffer")}function m(e,t,r,i,n){var a=1,o=e.length,s=t.length;if(void 0!==i&&("ucs2"===(i=String(i).toLowerCase())||"ucs-2"===i||"utf16le"===i||"utf-16le"===i)){if(e.length<2||t.length<2)return-1;o/=a=2,s/=2,r/=2}function l(e,t){return 1===a?e[t]:e.readUInt16BE(t*a)}if(n)for(var d=-1,c=r;c<o;c++)if(l(e,c)===l(t,-1===d?0:c-d)){if(c-(d=-1===d?c:d)+1===s)return d*a}else-1!==d&&(c-=c-d),d=-1;else for(c=r=o<r+s?o-s:r;0<=c;c--){for(var h=!0,u=0;u<s;u++)if(l(e,c+u)!==l(t,u)){h=!1;break}if(h)return c}return-1}function g(e,t,r,i){return D(function(e){for(var t=[],r=0;r<e.length;++r)t.push(255&e.charCodeAt(r));return t}(t),e,r,i)}function v(e,t,r,i){return D(function(e,t){for(var r,i,n=[],a=0;a<e.length&&!((t-=2)<0);++a)r=e.charCodeAt(a),i=r>>8,n.push(r%256),n.push(i);return n}(t,e.length-r),e,r,i)}function B(e,t,r){r=Math.min(e.length,r);for(var i=[],n=t;n<r;){var a,o,s,l,d=e[n],c=null,h=239<d?4:223<d?3:191<d?2:1;if(n+h<=r)switch(h){case 1:d<128&&(c=d);break;case 2:128==(192&(a=e[n+1]))&&127<(l=(31&d)<<6|63&a)&&(c=l);break;case 3:a=e[n+1],o=e[n+2],128==(192&a)&&128==(192&o)&&2047<(l=(15&d)<<12|(63&a)<<6|63&o)&&(l<55296||57343<l)&&(c=l);break;case 4:a=e[n+1],o=e[n+2],s=e[n+3],128==(192&a)&&128==(192&o)&&128==(192&s)&&65535<(l=(15&d)<<18|(63&a)<<12|(63&o)<<6|63&s)&&l<1114112&&(c=l)}null===c?(c=65533,h=1):65535<c&&(i.push((c-=65536)>>>10&1023|55296),c=56320|1023&c),i.push(c),n+=h}var u=i,p=u.length;if(p<=y)return String.fromCharCode.apply(String,u);for(var f="",m=0;m<p;)f+=String.fromCharCode.apply(String,u.slice(m,m+=y));return f}P.Buffer=h,P.SlowBuffer=function(e){+e!=e&&(e=0);return h.alloc(+e)},P.INSPECT_MAX_BYTES=50,h.TYPED_ARRAY_SUPPORT=void 0!==e.TYPED_ARRAY_SUPPORT?e.TYPED_ARRAY_SUPPORT:function(){try{var e=new Uint8Array(1);return e.__proto__={__proto__:Uint8Array.prototype,foo:function(){return 42}},42===e.foo()&&"function"==typeof e.subarray&&0===e.subarray(1,1).byteLength}catch(e){return!1}}(),P.kMaxLength=r(),h.poolSize=8192,h._augment=function(e){return e.__proto__=h.prototype,e},h.from=function(e,t,r){return i(null,e,t,r)},h.TYPED_ARRAY_SUPPORT&&(h.prototype.__proto__=Uint8Array.prototype,h.__proto__=Uint8Array,"undefined"!=typeof Symbol)&&Symbol.species&&h[Symbol.species]===h&&Object.defineProperty(h,Symbol.species,{value:null,configurable:!0}),h.alloc=function(e,t,r){return i=null,t=t,r=r,n(e=e),!(e<=0)&&void 0!==t?"string"==typeof r?l(i,e).fill(t,r):l(i,e).fill(t):l(i,e);var i},h.allocUnsafe=function(e){return o(null,e)},h.allocUnsafeSlow=function(e){return o(null,e)},h.isBuffer=function(e){return!(null==e||!e._isBuffer)},h.compare=function(e,t){if(!h.isBuffer(e)||!h.isBuffer(t))throw new TypeError("Arguments must be Buffers");if(e===t)return 0;for(var r=e.length,i=t.length,n=0,a=Math.min(r,i);n<a;++n)if(e[n]!==t[n]){r=e[n],i=t[n];break}return r<i?-1:i<r?1:0},h.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},h.concat=function(e,t){if(!s(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return h.alloc(0);if(void 0===t)for(n=t=0;n<e.length;++n)t+=e[n].length;for(var r=h.allocUnsafe(t),i=0,n=0;n<e.length;++n){var a=e[n];if(!h.isBuffer(a))throw new TypeError('"list" argument must be an Array of Buffers');a.copy(r,i),i+=a.length}return r},h.byteLength=u,h.prototype._isBuffer=!0,h.prototype.swap16=function(){var e=this.length;if(e%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var t=0;t<e;t+=2)p(this,t,t+1);return this},h.prototype.swap32=function(){var e=this.length;if(e%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var t=0;t<e;t+=4)p(this,t,t+3),p(this,t+1,t+2);return this},h.prototype.swap64=function(){var e=this.length;if(e%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var t=0;t<e;t+=8)p(this,t,t+7),p(this,t+1,t+6),p(this,t+2,t+5),p(this,t+3,t+4);return this},h.prototype.toString=function(){var e=0|this.length;return 0==e?"":0===arguments.length?B(this,0,e):t.apply(this,arguments)},h.prototype.equals=function(e){if(h.isBuffer(e))return this===e||0===h.compare(this,e);throw new TypeError("Argument must be a Buffer")},h.prototype.inspect=function(){var e="",t=P.INSPECT_MAX_BYTES;return 0<this.length&&(e=this.toString("hex",0,t).match(/.{2}/g).join(" "),this.length>t)&&(e+=" ... "),"<Buffer "+e+">"},h.prototype.compare=function(e,t,r,i,n){if(!h.isBuffer(e))throw new TypeError("Argument must be a Buffer");if(void 0===r&&(r=e?e.length:0),void 0===i&&(i=0),void 0===n&&(n=this.length),(t=void 0===t?0:t)<0||r>e.length||i<0||n>this.length)throw new RangeError("out of range index");if(n<=i&&r<=t)return 0;if(n<=i)return-1;if(r<=t)return 1;if(this===e)return 0;for(var a=(n>>>=0)-(i>>>=0),o=(r>>>=0)-(t>>>=0),s=Math.min(a,o),l=this.slice(i,n),d=e.slice(t,r),c=0;c<s;++c)if(l[c]!==d[c]){a=l[c],o=d[c];break}return a<o?-1:o<a?1:0},h.prototype.includes=function(e,t,r){return-1!==this.indexOf(e,t,r)},h.prototype.indexOf=function(e,t,r){return f(this,e,t,r,!0)},h.prototype.lastIndexOf=function(e,t,r){return f(this,e,t,r,!1)},h.prototype.write=function(e,t,r,i){if(void 0===t)i="utf8",r=this.length,t=0;else if(void 0===r&&"string"==typeof t)i=t,r=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t|=0,isFinite(r)?(r|=0,void 0===i&&(i="utf8")):(i=r,r=void 0)}var n=this.length-t;if((void 0===r||n<r)&&(r=n),0<e.length&&(r<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");i=i||"utf8";for(var a,o,s,l=!1;;)switch(i){case"hex":var d=this,c=e,h=t,u=r,p=(h=Number(h)||0,d.length-h);if((!u||p<(u=Number(u)))&&(u=p),(p=c.length)%2!=0)throw new TypeError("Invalid hex string");p/2<u&&(u=p/2);for(var f=0;f<u;++f){var m=parseInt(c.substr(2*f,2),16);if(isNaN(m))return f;d[h+f]=m}return f;case"utf8":case"utf-8":return p=t,s=r,D(R(e,(o=this).length-p),o,p,s);case"ascii":return g(this,e,t,r);case"latin1":case"binary":return g(this,e,t,r);case"base64":return o=this,s=t,a=r,D(C(e),o,s,a);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return v(this,e,t,r);default:if(l)throw new TypeError("Unknown encoding: "+i);i=(""+i).toLowerCase(),l=!0}},h.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var y=4096;function A(e,t,r){if(e%1!=0||e<0)throw new RangeError("offset is not uint");if(r<e+t)throw new RangeError("Trying to access beyond buffer length")}function M(e,t,r,i,n,a){if(!h.isBuffer(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(n<t||t<a)throw new RangeError('"value" argument is out of bounds');if(r+i>e.length)throw new RangeError("Index out of range")}function E(e,t,r,i){t<0&&(t=65535+t+1);for(var n=0,a=Math.min(e.length-r,2);n<a;++n)e[r+n]=(t&255<<8*(i?n:1-n))>>>8*(i?n:1-n)}function w(e,t,r,i){t<0&&(t=4294967295+t+1);for(var n=0,a=Math.min(e.length-r,4);n<a;++n)e[r+n]=t>>>8*(i?n:3-n)&255}function x(e,t,r,i){if(r+i>e.length)throw new RangeError("Index out of range");if(r<0)throw new RangeError("Index out of range")}function I(e,t,r,i,n){return n||x(e,0,r,4),a.write(e,t,r,i,23,4),r+4}function T(e,t,r,i,n){return n||x(e,0,r,8),a.write(e,t,r,i,52,8),r+8}h.prototype.slice=function(e,t){var r=this.length;if((e=~~e)<0?(e+=r)<0&&(e=0):r<e&&(e=r),(t=void 0===t?r:~~t)<0?(t+=r)<0&&(t=0):r<t&&(t=r),t<e&&(t=e),h.TYPED_ARRAY_SUPPORT)(n=this.subarray(e,t)).__proto__=h.prototype;else for(var i=t-e,n=new h(i,void 0),a=0;a<i;++a)n[a]=this[a+e];return n},h.prototype.readUIntLE=function(e,t,r){e|=0,t|=0,r||A(e,t,this.length);for(var i=this[e],n=1,a=0;++a<t&&(n*=256);)i+=this[e+a]*n;return i},h.prototype.readUIntBE=function(e,t,r){e|=0,t|=0,r||A(e,t,this.length);for(var i=this[e+--t],n=1;0<t&&(n*=256);)i+=this[e+--t]*n;return i},h.prototype.readUInt8=function(e,t){return t||A(e,1,this.length),this[e]},h.prototype.readUInt16LE=function(e,t){return t||A(e,2,this.length),this[e]|this[e+1]<<8},h.prototype.readUInt16BE=function(e,t){return t||A(e,2,this.length),this[e]<<8|this[e+1]},h.prototype.readUInt32LE=function(e,t){return t||A(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},h.prototype.readUInt32BE=function(e,t){return t||A(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},h.prototype.readIntLE=function(e,t,r){e|=0,t|=0,r||A(e,t,this.length);for(var i=this[e],n=1,a=0;++a<t&&(n*=256);)i+=this[e+a]*n;return(n*=128)<=i&&(i-=Math.pow(2,8*t)),i},h.prototype.readIntBE=function(e,t,r){e|=0,t|=0,r||A(e,t,this.length);for(var i=t,n=1,a=this[e+--i];0<i&&(n*=256);)a+=this[e+--i]*n;return(n*=128)<=a&&(a-=Math.pow(2,8*t)),a},h.prototype.readInt8=function(e,t){return t||A(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},h.prototype.readInt16LE=function(e,t){t||A(e,2,this.length);t=this[e]|this[e+1]<<8;return 32768&t?4294901760|t:t},h.prototype.readInt16BE=function(e,t){t||A(e,2,this.length);t=this[e+1]|this[e]<<8;return 32768&t?4294901760|t:t},h.prototype.readInt32LE=function(e,t){return t||A(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},h.prototype.readInt32BE=function(e,t){return t||A(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},h.prototype.readFloatLE=function(e,t){return t||A(e,4,this.length),a.read(this,e,!0,23,4)},h.prototype.readFloatBE=function(e,t){return t||A(e,4,this.length),a.read(this,e,!1,23,4)},h.prototype.readDoubleLE=function(e,t){return t||A(e,8,this.length),a.read(this,e,!0,52,8)},h.prototype.readDoubleBE=function(e,t){return t||A(e,8,this.length),a.read(this,e,!1,52,8)},h.prototype.writeUIntLE=function(e,t,r,i){e=+e,t|=0,r|=0,i||M(this,e,t,r,Math.pow(2,8*r)-1,0);var n=1,a=0;for(this[t]=255&e;++a<r&&(n*=256);)this[t+a]=e/n&255;return t+r},h.prototype.writeUIntBE=function(e,t,r,i){e=+e,t|=0,r|=0,i||M(this,e,t,r,Math.pow(2,8*r)-1,0);var n=r-1,a=1;for(this[t+n]=255&e;0<=--n&&(a*=256);)this[t+n]=e/a&255;return t+r},h.prototype.writeUInt8=function(e,t,r){return e=+e,t|=0,r||M(this,e,t,1,255,0),h.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),this[t]=255&e,t+1},h.prototype.writeUInt16LE=function(e,t,r){return e=+e,t|=0,r||M(this,e,t,2,65535,0),h.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):E(this,e,t,!0),t+2},h.prototype.writeUInt16BE=function(e,t,r){return e=+e,t|=0,r||M(this,e,t,2,65535,0),h.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):E(this,e,t,!1),t+2},h.prototype.writeUInt32LE=function(e,t,r){return e=+e,t|=0,r||M(this,e,t,4,4294967295,0),h.TYPED_ARRAY_SUPPORT?(this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e):w(this,e,t,!0),t+4},h.prototype.writeUInt32BE=function(e,t,r){return e=+e,t|=0,r||M(this,e,t,4,4294967295,0),h.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):w(this,e,t,!1),t+4},h.prototype.writeIntLE=function(e,t,r,i){e=+e,t|=0,i||M(this,e,t,r,(i=Math.pow(2,8*r-1))-1,-i);var n=0,a=1,o=0;for(this[t]=255&e;++n<r&&(a*=256);)e<0&&0===o&&0!==this[t+n-1]&&(o=1),this[t+n]=(e/a>>0)-o&255;return t+r},h.prototype.writeIntBE=function(e,t,r,i){e=+e,t|=0,i||M(this,e,t,r,(i=Math.pow(2,8*r-1))-1,-i);var n=r-1,a=1,o=0;for(this[t+n]=255&e;0<=--n&&(a*=256);)e<0&&0===o&&0!==this[t+n+1]&&(o=1),this[t+n]=(e/a>>0)-o&255;return t+r},h.prototype.writeInt8=function(e,t,r){return e=+e,t|=0,r||M(this,e,t,1,127,-128),h.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),this[t]=255&(e=e<0?255+e+1:e),t+1},h.prototype.writeInt16LE=function(e,t,r){return e=+e,t|=0,r||M(this,e,t,2,32767,-32768),h.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):E(this,e,t,!0),t+2},h.prototype.writeInt16BE=function(e,t,r){return e=+e,t|=0,r||M(this,e,t,2,32767,-32768),h.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):E(this,e,t,!1),t+2},h.prototype.writeInt32LE=function(e,t,r){return e=+e,t|=0,r||M(this,e,t,4,2147483647,-2147483648),h.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24):w(this,e,t,!0),t+4},h.prototype.writeInt32BE=function(e,t,r){return e=+e,t|=0,r||M(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),h.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):w(this,e,t,!1),t+4},h.prototype.writeFloatLE=function(e,t,r){return I(this,e,t,!0,r)},h.prototype.writeFloatBE=function(e,t,r){return I(this,e,t,!1,r)},h.prototype.writeDoubleLE=function(e,t,r){return T(this,e,t,!0,r)},h.prototype.writeDoubleBE=function(e,t,r){return T(this,e,t,!1,r)},h.prototype.copy=function(e,t,r,i){if(r=r||0,i||0===i||(i=this.length),t>=e.length&&(t=e.length),(i=0<i&&i<r?r:i)===r)return 0;if(0===e.length||0===this.length)return 0;if((t=t||0)<0)throw new RangeError("targetStart out of bounds");if(r<0||r>=this.length)throw new RangeError("sourceStart out of bounds");if(i<0)throw new RangeError("sourceEnd out of bounds");i>this.length&&(i=this.length);var n,a=(i=e.length-t<i-r?e.length-t+r:i)-r;if(this===e&&r<t&&t<i)for(n=a-1;0<=n;--n)e[n+t]=this[n+r];else if(a<1e3||!h.TYPED_ARRAY_SUPPORT)for(n=0;n<a;++n)e[n+t]=this[n+r];else Uint8Array.prototype.set.call(e,this.subarray(r,r+a),t);return a},h.prototype.fill=function(e,t,r,i){if("string"==typeof e){var n;if("string"==typeof t?(i=t,t=0,r=this.length):"string"==typeof r&&(i=r,r=this.length),1===e.length&&(n=e.charCodeAt(0))<256&&(e=n),void 0!==i&&"string"!=typeof i)throw new TypeError("encoding must be a string");if("string"==typeof i&&!h.isEncoding(i))throw new TypeError("Unknown encoding: "+i)}else"number"==typeof e&&(e&=255);if(t<0||this.length<t||this.length<r)throw new RangeError("Out of range index");if(!(r<=t))if(t>>>=0,r=void 0===r?this.length:r>>>0,"number"==typeof(e=e||0))for(s=t;s<r;++s)this[s]=e;else for(var a=h.isBuffer(e)?e:R(new h(e,i).toString()),o=a.length,s=0;s<r-t;++s)this[s+t]=a[s%o];return this};var S=/[^+\/0-9A-Za-z-_]/g;function R(e,t){t=t||1/0;for(var r,i=e.length,n=null,a=[],o=0;o<i;++o){if(55295<(r=e.charCodeAt(o))&&r<57344){if(!n){if(56319<r){-1<(t-=3)&&a.push(239,191,189);continue}if(o+1===i){-1<(t-=3)&&a.push(239,191,189);continue}n=r;continue}if(r<56320){-1<(t-=3)&&a.push(239,191,189),n=r;continue}r=65536+(n-55296<<10|r-56320)}else n&&-1<(t-=3)&&a.push(239,191,189);if(n=null,r<128){if(--t<0)break;a.push(r)}else if(r<2048){if((t-=2)<0)break;a.push(r>>6|192,63&r|128)}else if(r<65536){if((t-=3)<0)break;a.push(r>>12|224,r>>6&63|128,63&r|128)}else{if(!(r<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;a.push(r>>18|240,r>>12&63|128,r>>6&63|128,63&r|128)}}return a}function C(e){return b.toByteArray(function(e){var t;if((e=((t=e).trim?t.trim():t.replace(/^\s+|\s+$/g,"")).replace(S,"")).length<2)return"";for(;e.length%4!=0;)e+="=";return e}(e))}function D(e,t,r,i){for(var n=0;n<i&&!(n+r>=t.length||n>=e.length);++n)t[n+r]=e[n];return n}}.call(this,H(15))},function(e,t){var r=function(){return this}();try{r=r||new Function("return this")()}catch(e){"object"==typeof window&&(r=window)}e.exports=r},function(e,t,r){t.byteLength=function(e){var e=c(e),t=e[0],e=e[1];return 3*(t+e)/4-e},t.toByteArray=function(e){var t,r,i=c(e),n=i[0],i=i[1],a=new d(function(e,t){return 3*(e+t)/4-t}(n,i)),o=0,s=0<i?n-4:n;for(r=0;r<s;r+=4)t=l[e.charCodeAt(r)]<<18|l[e.charCodeAt(r+1)]<<12|l[e.charCodeAt(r+2)]<<6|l[e.charCodeAt(r+3)],a[o++]=t>>16&255,a[o++]=t>>8&255,a[o++]=255&t;2===i&&(t=l[e.charCodeAt(r)]<<2|l[e.charCodeAt(r+1)]>>4,a[o++]=255&t);1===i&&(t=l[e.charCodeAt(r)]<<10|l[e.charCodeAt(r+1)]<<4|l[e.charCodeAt(r+2)]>>2,a[o++]=t>>8&255,a[o++]=255&t);return a},t.fromByteArray=function(e){for(var t,r=e.length,i=r%3,n=[],a=0,o=r-i;a<o;a+=16383)n.push(function(e,t,r){for(var i,n=[],a=t;a<r;a+=3)i=(e[a]<<16&16711680)+(e[a+1]<<8&65280)+(255&e[a+2]),n.push(function(e){return s[e>>18&63]+s[e>>12&63]+s[e>>6&63]+s[63&e]}(i));return n.join("")}(e,a,o<a+16383?o:a+16383));1==i?(t=e[r-1],n.push(s[t>>2]+s[t<<4&63]+"==")):2==i&&(t=(e[r-2]<<8)+e[r-1],n.push(s[t>>10]+s[t>>4&63]+s[t<<2&63]+"="));return n.join("")};for(var s=[],l=[],d="undefined"!=typeof Uint8Array?Uint8Array:Array,i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",n=0,a=i.length;n<a;++n)s[n]=i[n],l[i.charCodeAt(n)]=n;function c(e){var t=e.length;if(0<t%4)throw new Error("Invalid string. Length must be a multiple of 4");e=e.indexOf("="),t=(e=-1===e?t:e)===t?0:4-e%4;return[e,t]}l["-".charCodeAt(0)]=62,l["_".charCodeAt(0)]=63},function(e,t){t.read=function(e,t,r,i,n){var a,o,s=8*n-i-1,l=(1<<s)-1,d=l>>1,c=-7,h=r?n-1:0,u=r?-1:1,n=e[t+h];for(h+=u,a=n&(1<<-c)-1,n>>=-c,c+=s;0<c;a=256*a+e[t+h],h+=u,c-=8);for(o=a&(1<<-c)-1,a>>=-c,c+=i;0<c;o=256*o+e[t+h],h+=u,c-=8);if(0===a)a=1-d;else{if(a===l)return o?NaN:1/0*(n?-1:1);o+=Math.pow(2,i),a-=d}return(n?-1:1)*o*Math.pow(2,a-i)},t.write=function(e,t,r,i,n,a){var o,s,l=8*a-n-1,d=(1<<l)-1,c=d>>1,h=23===n?Math.pow(2,-24)-Math.pow(2,-77):0,u=i?0:a-1,p=i?1:-1,a=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(s=isNaN(t)?1:0,o=d):(o=Math.floor(Math.log(t)/Math.LN2),t*(i=Math.pow(2,-o))<1&&(o--,i*=2),2<=(t+=1<=o+c?h/i:h*Math.pow(2,1-c))*i&&(o++,i/=2),d<=o+c?(s=0,o=d):1<=o+c?(s=(t*i-1)*Math.pow(2,n),o+=c):(s=t*Math.pow(2,c-1)*Math.pow(2,n),o=0));8<=n;e[r+u]=255&s,u+=p,s/=256,n-=8);for(o=o<<n|s,l+=n;0<l;e[r+u]=255&o,u+=p,o/=256,l-=8);e[r+u-p]|=128*a}},function(e,t){var r={}.toString;e.exports=Array.isArray||function(e){return"[object Array]"==r.call(e)}},function(e,t){e.exports=function(e){return e.webpackPolyfill||(e.deprecate=function(){},e.paths=[],e.children||(e.children=[]),Object.defineProperty(e,"loaded",{enumerable:!0,get:function(){return e.l}}),Object.defineProperty(e,"id",{enumerable:!0,get:function(){return e.i}}),e.webpackPolyfill=1),e}},function(n,e,r){r.r(e),r.d(e,"NDS",function(){return Ce}),r.d(e,"Viewer",function(){return io}),r.d(e,"COMMON",function(){return Pe}),r.d(e,"SETTING",function(){return De}),r.d(e,"DecalGeometry",function(){return ot}),r.d(e,"NdsCoordSystem",function(){return ae}),r.d(e,"LineTypeCreater",function(){return mt}),r.d(e,"BIMXHRLoader",function(){return Rt}),r.d(e,"SDFCreater",function(){return de}),r.d(e,"NdsBrepManager",function(){return At}),r.d(e,"MaterialsSetting",function(){return Mt}),r.d(e,"NdsMeshManager",function(){return rt}),r.d(e,"NdsGeometry",function(){return le}),r.d(e,"NdsBodyNode",function(){return _e}),r.d(e,"NdsModel",function(){return ee}),r.d(e,"NdsModelSet",function(){return er}),r.d(e,"BVHCreater",function(){return _a}),r.d(e,"NdsModelBvh",function(){return Et}),r.d(e,"NdsMeshSet",function(){return nt}),r.d(e,"NdsLeafBodyAttri",function(){return se}),r.d(e,"NdsCoordSystemAttri",function(){return ce}),r.d(e,"PropertyManager",function(){return Ct}),r.d(e,"SelectionManager",function(){return In}),r.d(e,"Extension",function(){return H}),r.d(e,"ExtensionManager",function(){return He}),r.d(e,"CameraControl",function(){return Ge}),r.d(e,"TransformControls",function(){return Ie}),r.d(e,"EditControls",function(){return La}),r.d(e,"ClippingShader",function(){return l}),r.d(e,"LineMaterial",function(){return qe}),r.d(e,"LineSegments2",function(){return Ke}),r.d(e,"LineSegmentsGeometry",function(){return Xe}),r.d(e,"View",function(){return pa}),r.d(e,"ViewLayout",function(){return fa}),r.d(e,"ViewManager",function(){return ma}),r.d(e,"OpUtils",function(){return i}),r.d(e,"OpBase",function(){return a}),r.d(e,"OpOrbit",function(){return ui}),r.d(e,"SnappingTool",function(){return ja}),r.d(e,"SNAP_VERTEX",function(){return ka}),r.d(e,"LineMaterialOrigin",function(){return Xa}),r.d(e,"NdsMCAD2d",function(){return $i}),r.d(e,"MCAD2DMeshSet",function(){return qi}),r.d(e,"NdsMCAD3d",function(){return zi}),r.d(e,"NdsModelParser",function(){return St}),r.d(e,"NdsBinParser",function(){return $}),r.d(e,"ModelRequestor",function(){return Dt}),r.d(e,"ModelRequestorManager",function(){return Pt});function Re(e,t,r){THREE.Camera.call(this),this.fov=45,this.near=.5,this.far=1e4,this.aspect=e/t,this.orthoNear=-200,this.perpNear=.5,this.viewer=r,this.left=-e/2,this.right=e/2,this.top=t/2,this.bottom=-t/2,this.target=new THREE.Vector3(0,0,0),this.worldup=new THREE.Vector3(0,1,0),this.position.set(0,0,1),this.orthographicCamera=new THREE.OrthographicCamera(this.left,this.right,this.top,this.bottom,this.near,this.far),this.perspectiveCamera=new THREE.PerspectiveCamera(this.fov,this.aspect,this.near,this.far),this.updateMatrixWorld(!0),this.zoom=1,this.isPerspective=!0,this.zoomToFitRatio=5,this.orginalCameraInfo=void 0,this.toPerspective()}var l={},Ce=(r.r(l),r.d(l,"ClippingPlanesShader_pars_fragment1",function(){return Oa}),r.d(l,"ClippingPlanesShader_fragment1",function(){return Fa}),r.d(l,"ClippingPlanesShader1_MeshPhong",function(){return Ua}),r.d(l,"ClippingPlanesShader1_MeshPhysical",function(){return Na}),r.d(l,"ClippingPlanesShader2",function(){return Va}),r.d(l,"ClippingPlanesShader3",function(){return Ga}),{}),De=(r(1),r(2),r(3),r(4),r(5),r(6),r(7),r(8),r(9),r(10),r(11),r(12),Re.ORTHO_FOV=2*Math.atan(.5)*180/Math.PI,(Re.prototype=Object.create(THREE.Camera.prototype)).clone=function(){var e=new Re(2*this.right,2*this.top,this.viewer);return THREE.Camera.prototype.clone.call(this,e),e.position.copy(this.position),e.up.copy(this.up),this.target&&(e.target=this.target.clone()),this.worldup&&(e.worldup=this.worldup.clone()),e.left=this.left,e.right=this.right,e.top=this.top,e.bottom=this.bottom,e.near=this.near,e.far=this.far,e.fov=this.fov,e.saveFov=this.saveFov,e.aspect=this.aspect,e.zoom=this.zoom,e.orthoNear=this.orthoNear,e.perpNear=this.perpNear,e.isPerspective=this.isPerspective,this.updateProjectionMatrix(),e},Re.prototype.IsPerspective=function(){return this.isPerspective},Re.prototype.__computeFovPosition=function(e){var t,r;return Math.abs(this.fov-e)<=1e-4?this.position.clone():(t=this.target.clone().sub(this.position),r=THREE.Math.degToRad(this.fov),e=THREE.Math.degToRad(e),r=t.length()*Math.tan(.5*r)/Math.tan(.5*e),e=t.normalize().multiplyScalar(-r),this.target.clone().add(e))},Re.prototype.toPerspective=function(){!this.isPerspective&&this.saveFov&&(this.viewer.cameraControl&&this.viewer.cameraControl.adjustNearAndFar(),this.fov=this.saveFov,this.near=this.perpNear,2e3<this.far/this.near)&&(this.near=this.far/2e3),this.perspectiveCamera.aspect=this.aspect,this.perspectiveCamera.near=this.near,this.perspectiveCamera.far=this.far,this.perspectiveCamera.fov=this.fov/this.zoom,this.perspectiveCamera.updateProjectionMatrix(),this.projectionMatrix=this.perspectiveCamera.projectionMatrix,this.projectionMatrixInverse.copy(this.projectionMatrix).invert(),this.isPerspective=!0},Re.prototype.setPerspectiveCameraInfo=function(e){!this.isPerspective&&this.saveFov&&(this.viewer.cameraControl&&this.viewer.cameraControl.adjustNearAndFar(),this.fov=this.saveFov,this.near=this.perpNear,2e3<this.far/this.near)&&(this.near=this.far/2e3),this.near=(null!=e.near&&null!=e.near?e:this).near,this.far=(null!=e.far&&null!=e.far?e:this).far,this.perspectiveCamera.aspect=this.aspect,this.perspectiveCamera.near=this.near,this.perspectiveCamera.far=this.far,this.position.set(e.position.x,e.position.y,e.position.z),e.fov?this.perspectiveCamera.fov=e.fov:this.perspectiveCamera.fov=45,e.height&&e.width&&(this.perspectiveCamera.aspect=this.aspect=e.width/e.height),this.setCameraTarget(new THREE.Vector3(e.target.x,e.target.y,e.target.z)),e.up?this.up.set(e.up.x,e.up.y,e.up.z):this.up.set(0,1,0),this.lookAt(this.getCameraTarget()),this.perspectiveCamera.updateProjectionMatrix(),this.projectionMatrix=this.perspectiveCamera.projectionMatrix,this.projectionMatrixInverse.copy(this.projectionMatrix).invert(),this.isPerspective=!0},Re.prototype.toOrthographic=function(){var e,t,r;this.isPerspective&&(this.saveFov=this.fov,e=this.fov,this.fov=e,this.near=this.orthoNear),this.orthoScale=this.target.clone().sub(this.position).length(),this.aspect<1?t=(r=.5*this.orthoScale)/this.aspect:r=(t=.5*this.orthoScale)*this.aspect,this.left=this.orthographicCamera.left=-r,this.right=this.orthographicCamera.right=r,this.top=this.orthographicCamera.top=t,this.bottom=this.orthographicCamera.bottom=-t,this.orthographicCamera.near=this.near,this.orthographicCamera.far=this.far,this.orthographicCamera.updateProjectionMatrix(),this.projectionMatrix=this.orthographicCamera.projectionMatrix,this.projectionMatrixInverse.copy(this.projectionMatrix).invert(),this.isPerspective=!1},Re.prototype.setOrthographicCameraInfo=function(e){var t;this.isPerspective&&(this.saveFov=this.fov,t=this.fov,this.fov=t,this.near=this.orthoNear),this.orthoScale=this.target.clone().sub(this.position).length(),this.aspect<1?(this.orthoScale,this.aspect):(this.orthoScale,this.aspect),this.orthographicCamera.left=this.left=e.left,this.orthographicCamera.right=this.right=e.right,this.orthographicCamera.top=this.top=e.top,this.orthographicCamera.bottom=this.bottom=e.bottom,this.near=(null!=e.near&&null!=e.near?e:this).near,this.far=(null!=e.far&&null!=e.far?e:this).far,this.orthographicCamera.near=this.near,this.orthographicCamera.far=this.far,this.position.set(e.position.x,e.position.y,e.position.z),this.setCameraTarget(new THREE.Vector3(e.target.x,e.target.y,e.target.z)),e.up?this.up.set(e.up.x,e.up.y,e.up.z):this.up.set(0,1,0),this.lookAt(this.getCameraTarget()),this.orthographicCamera.updateProjectionMatrix(),this.projectionMatrix=this.orthographicCamera.projectionMatrix,this.projectionMatrixInverse.copy(this.projectionMatrix).invert(),this.isPerspective=!1},Re.prototype.updateProjectionMatrix=function(){this.isPerspective?this.toPerspective():this.toOrthographic()},Re.prototype.setSize=function(e,t){this.aspect=e/t,this.left=-e/2,this.right=e/2,this.top=t/2,this.bottom=-t/2},Re.prototype.setFov=function(e){this.fov=e,this.updateProjectionMatrix()},Re.prototype.setLens=function(e,t){void 0===t&&(t=24);t=2*THREE.Math.radToDeg(Math.atan(t/(2*e)));return this.setFov(t),t},Re.prototype.setCameraTarget=function(e){this.lookAt(e),this.target=e},Re.prototype.getCameraTarget=function(){return this.target},Re.prototype.adjustNearFar=function(e,t){var r;this.isPerspective?(this.far=t,this.near=.5,(2e3<this.far/this.near||this.far<=this.near)&&(this.near=this.far/2e3),r=(r=new THREE.Vector3).subVectors(this.viewer.controls.getBoundingBox().max,this.viewer.controls.getBoundingBox().min),this.near>.25*r.length()&&(this.near=.25*r.length())):(this.near=-t,this.far=t),this.updateProjectionMatrix()},Re.prototype.setFarNear=function(e,t){this.far=e,this.near=t},Re.prototype.setOrthoNear=function(e){e=e.min.distanceTo(e.max);-e<this.orthoNear&&(this.orthoNear=-e,this.isPerspective||(this.near=30*this.orthoNear))},Re.prototype.setZoomToFitRatio=function(e){this.zoomToFitRatio=e},Re.prototype.getZoomToFitRatio=function(){return this.zoomToFitRatio},Re.prototype.setOrginalCameraInfo=function(e){this.orginalCameraInfo=e},Re.prototype.getOrginalCameraInfo=function(){return this.orginalCameraInfo},Re.prototype.setCastRay=function(e,t,r){var i;this.isPerspective?((i=new THREE.Vector3(t,r,.5)).unproject(this),e.ray.origin=this.position.clone(),e.ray.direction=i.sub(this.position).normalize().clone()):(e.ray.origin.set(t,r,-1).unproject(this),e.ray.direction.set(0,0,-1).transformDirection(this.matrixWorld))},Re.prototype.setCastPolytopes=function(e,t,r,i,n){var a=new THREE.Vector3(t.x,t.y,-1).unproject(this),t=new THREE.Vector3(t.x,t.y,1).unproject(this),o=new THREE.Vector3(r.x,r.y,-1).unproject(this),r=(new THREE.Vector3(r.x,r.y,1).unproject(this),new THREE.Vector3(i.x,i.y,-1).unproject(this)),i=new THREE.Vector3(i.x,i.y,1).unproject(this),s=new THREE.Vector3(n.x,n.y,-1).unproject(this),n=new THREE.Vector3(n.x,n.y,1).unproject(this);e.push((new THREE.Plane).setFromCoplanarPoints(a,r,s)),e.push((new THREE.Plane).setFromCoplanarPoints(t,n,i)),e.push((new THREE.Plane).setFromCoplanarPoints(a,t,o)),e.push((new THREE.Plane).setFromCoplanarPoints(s,r,n)),e.push((new THREE.Plane).setFromCoplanarPoints(a,s,t)),e.push((new THREE.Plane).setFromCoplanarPoints(o,i,r))},{REVISION:"01"}),Pe=(De.toolbarButtonClickedBkgColor="",De.toolbarOpacity=.2,De.dialogOpacity=.2,De.bodyOpacity=.4,De.lineOpacity=.2,De.OES_element_index_uint=!1,De.avoidCaching=!0,De.lineSegAnnotationGridCount=200,De.enableBroadcast=!1,De.broadcastMajor=!1,De.selectedMaterial=new THREE.MeshStandardMaterial({color:16763200,metalness:.2,roughness:1,side:THREE.DoubleSide,polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:2,skinning:!1}),De.BIMselectedMaterial=new THREE.MeshBasicMaterial({opacity:.7,color:4168151,side:THREE.DoubleSide,depthTest:!1,depthWrite:!1,transparent:!0}),De.selectedColor=new THREE.Color(16776960),De.selectedLineMaterial=new THREE.LineBasicMaterial({color:16776960}),De.selectedPointMaterial=new THREE.MeshBasicMaterial({color:16776960,side:THREE.DoubleSide}),De.selected2DMeshMaterial=new THREE.MeshBasicMaterial({color:16776960,side:THREE.DoubleSide}),De.selectedFaceMaterial=new THREE.MeshBasicMaterial({opacity:.8,color:979390,side:THREE.DoubleSide,transparent:!0}),De.selectedFace2DMaterial=new THREE.MeshBasicMaterial({opacity:.8,color:16763200,side:THREE.DoubleSide,transparent:!0}),De.preSelectedFaceMaterial=new THREE.MeshBasicMaterial({opacity:.8,color:65535,side:THREE.DoubleSide,transparent:!0}),De.selectedEdgeMaterial=new THREE.LineBasicMaterial({color:16744512,opacity:.9,transparent:!0,depthTest:!1,depthWrite:!1,linewidth:1}),De.preSelectedEdgeMaterial=new THREE.LineBasicMaterial({color:65535,opacity:.9,transparent:!0,depthTest:!1,depthWrite:!1,linewidth:1}),De.SelectedEdgeMaterial1=new THREE.LineBasicMaterial({color:16711680,depthTest:!0,depthWrite:!0,linewidth:1}),De.selectedVertexMaterial=new THREE.MeshBasicMaterial({color:16711680,opacity:.8,transparent:!0,depthTest:!1,depthWrite:!1}),De.preSelectedVertexMaterial=new THREE.MeshBasicMaterial({color:65535,opacity:.8,transparent:!0,depthTest:!1,depthWrite:!1}),De.dashedMaterial=new THREE.ShaderMaterial({uniforms:{lineStyle:{value:-1},dashSize:{value:12},dashNum:{value:1},grapSize:{value:3},pointSize:{value:.5},pointNum:{value:1},opacity:{value:.8},diffuse:{value:new THREE.Color(16711680)}},linewidth:1,transparent:!0,fragmentShader:["uniform vec3 diffuse;","uniform float opacity;","uniform float dashSize;","uniform float dashNum;","uniform float pointNum;","uniform float grapSize;","uniform float pointSize;","varying float vLineDistance;","#include <common>","#include <color_pars_fragment>","#include <fog_pars_fragment>","#include <logdepthbuf_pars_fragment>","#include <clipping_planes_pars_fragment>","void main() {","#include <clipping_planes_fragment>","float totalSize = dashSize * dashNum + grapSize * (dashNum + pointNum) + pointSize * pointNum;","float modSize = mod( vLineDistance, totalSize );","bool grap = false;","for(float i = 1.0; i< 4.0; ++i){","if(i > dashNum){","break;","}","if(modSize < i * (grapSize + dashSize) && modSize > i * (grapSize + dashSize) - grapSize){","grap = true;","break;","}","}","if ( grap ) {","discard;","}","float dashlength = dashNum * (grapSize + dashSize);","for(float i = 1.0;i <4.0; ++i){","if(i > pointNum){","break;","}","if(modSize < i * (grapSize + pointSize) + dashlength && ","modSize > i * (grapSize + pointSize) - grapSize + dashlength){","grap = true;","break;","}","}","if ( grap ) {","discard;","}","vec3 outgoingLight = vec3( 0.0 );","vec4 diffuseColor = vec4( diffuse, opacity );","#include <logdepthbuf_fragment>","#include <color_fragment>","outgoingLight = diffuseColor.rgb;","gl_FragColor = vec4( outgoingLight, diffuseColor.a );","#include <premultiplied_alpha_fragment>","#include <tonemapping_fragment>","#include <encodings_fragment>","#include <fog_fragment>","}"].join("\n"),vertexShader:["attribute float lineDistance;","varying float vLineDistance;","#include <common>","#include <color_pars_vertex>","#include <fog_pars_vertex>","#include <logdepthbuf_pars_vertex>","#include <clipping_planes_pars_vertex>","void main() {","#include <color_vertex>","vLineDistance =  lineDistance;","vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );","gl_Position = projectionMatrix * mvPosition;","#include <logdepthbuf_vertex>","#include <clipping_planes_vertex>","#include <fog_vertex>","}"].join("\n")}),De.enableSelect=!1,De.autoSwitchFirstPersonView=!1,De.tangentEdgeVisible=!0,De.enableArrowKeyOp=!0,De.dynamicRotateCenter=!0,De.NdsLoadWorkerUrl="./coreViewer/NDSRequestWorker.min.js",De.NdsLoadBooleanWorkerUrl="coreViewer/NDSBooleanWorker.min.js",De.DISARequestWorkerUrl="./coreViewer/DISARequestWorker.min.js",De.NdsLoadClipExtension="./coreViewer/NDSClipExtension.js",De.enableOutlineEffect=!1,De.enableBodyVolumeMeasure=!1,De.enablePreSelectBrep=!1,De.selectObjectWithPropertyOnly=!1,De.enableDirectMove=!1,De.enableDirectRotate=!1,De.inAssemblyContext=!1,De.inBIMContext=!1,De.ScenarioEditor=!1,De.ScenarioEditorid=-1,De.AnimationEdit=!1,De.StopPMIOcclusion=!0,De.singleHTML=!1,De.HideLeafBody=!1,De.New2DMeasure=!1,De.MatrixChange=!1,{REVISION:"01"});function h(e,t){return(h=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}Pe.StringTable=void 0,Pe.SupportWebGL2=void 0,Pe.setLanguage=function(e,t,r){var i,n,a;this.language=e,Pe.StringTable=new StringTable(e),De.singleHTML?Pe.StringTable.tables=window.NdsLanguage:(i="coreViewer/language/en.js",n="coreViewer/language/",i=""+(n=t?t+n:n)+e+".js","zh-CN"==e&&(i=n+"zh.js"),(a=new XMLHttpRequest).open("GET",i),a.onload=function(){var e;200<=this.status&&this.status<300||0===this.status?(e=a.responseText.match(/= ({[^}]*})/))?(e=e[1].trim(),Pe.StringTable.tables=JSON.parse(e)):console.error("No JSON found in the string."):console.error("语言配置文件有丢失")},a.onerror=function(){console.error("语言配置文件有丢失")},a.crossOrigin="anonymous",a.responseType="text",a.send()),r||Pe.setExternalTranslate(t)},Pe.getExternalTranslateKeys=function(){var e;Pe.ExternalStringTable&&((e=Object.keys(Pe.ExternalStringTable.tables)).sort(function(e,t){return t.length-e.length}),Pe.ExternalStringTable.keys=e)},Pe.setExternalTranslate=function(e,t){var r,i;Pe.ExternalStringTable=new StringTable,De.singleHTML?(Pe.ExternalStringTable.tables=window.NdsExternalTranslate,Pe.getExternalTranslateKeys()):(r="coreViewer/External/",e=""+(r=e?e+r:r)+(t=t||"Translate")+".js",(i=new XMLHttpRequest).open("GET",e),i.onload=function(){var e;200<=this.status&&this.status<300||0===this.status?(e=i.responseText.match(/= ({[^}]*})/))?(e=e[1].trim(),Pe.ExternalStringTable.tables=JSON.parse(e),Pe.getExternalTranslateKeys()):console.error("No JSON found in the string."):console.error("语言配置文件有丢失")},i.onerror=function(){console.error("语言配置文件有丢失")},i.crossOrigin="anonymous",i.responseType="text",i.send())},Pe.getLanguage=function(){var e=this.language;return e=-1<(e=e||"en").indexOf("zh-CN")?"zh-HANS":e},Pe.translateString=function(e){return Pe.StringTable.translate(e)},Pe.getStyle=function(e,t){return e.style[t]||(e.currentStyle?e.currentStyle[t]:document.defaultView&&document.defaultView.getComputedStyle?(t=(t=t.replace(/[A-Z]/g,"-$1")).toLowerCase(),(e=document.defaultView.getComputedStyle(e,""))&&e.getPropertyValue(t)):null)},Pe.onAutoHide=function(e){function t(){clearTimeout(i)}var r=e.domElement,i=(r.addEventListener("mouseenter",t),setTimeout(function(){r.removeEventListener("mouseenter",t),e.setVisibility(!1)},300))},Pe.onShowTooltip=function(e){var t=e.event.type,r=e.target.subElements.tooltip;switch(t){case"mouseenter":r.setVisibility(!0);break;case"mouseleave":r.setVisibility(!1);break;case"mouseover":r.setVisibility(!0);break;case"mouseout":r.setVisibility(!1)}},Pe.map=function(e,t){this.key=e,this.value=t},Pe.isSupportCanvas2=function(){var e;return null==Pe.SupportWebGL2&&(e=document.createElement("canvas").getContext("webgl2"),Pe.SupportWebGL2=!!e),Pe.SupportWebGL2},Pe.getExtName=function(e){var t=e.lastIndexOf("."),r=e.length;return e.substring(t+1,r)},Pe.sleep=function(e){for(var t=new Date,r=t.getTime()+e;;)if((t=new Date).getTime()>r)return},Pe.isEmptyObject=function(e){for(var t in e)return!1;return!0},Pe.getObjectSize=function(e){var t,r=0;for(t in e)++r;return r},Pe.disposeObject=function(e){if(0==e.children.length)e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose();else for(var t=0;t<e.children.length;t++)this.disposeObject(e.children[t])},Pe.encodeURL=function(e){if(null==e)return null;if(Array.isArray(e))for(var t=0;t<e.length;++t)e[t]=e[t].replace(/&/g,"%26"),e[t]=e[t].replace(/#/g,"%23");else e=(e=e.replace(/&/g,"%26")).replace(/#/g,"%23");return e},Pe.isIOSDevice=function(){var e=navigator.userAgent.toLowerCase();return/ip(ad|hone|od)/.test(e)||-1!==e.indexOf("macintosh")},Pe.isAndroidDevice=function(){return-1!==navigator.userAgent.toLowerCase().indexOf("android")},Pe.isIpadDevice=function(){return-1!==navigator.userAgent.toLowerCase().indexOf("ipad")},Pe.isMobileDevice=function(){return this.platform?"mobile"==this.platform||"pc"!=this.platform&&(Pe.isIOSDevice()||Pe.isAndroidDevice()):Pe.isIOSDevice()||Pe.isAndroidDevice()},Pe.setMobileDevice=function(e){this.platform=e},Pe.getOSInfo=function(){var e,t,r={os:"unknown",version:"undefined"},i=navigator.userAgent;return/Windows/i.test(i)?(r.os="Windows",(t=i.match(/Windows NT (\d+\.\d+)/))&&(r.version=""+({"10.0":"10/11",6.3:"8.1",6.2:"8",6.1:"7","6.0":"Vista",5.2:"XP",5.1:"XP","5.0":"2000"}[t=t[1]]||t))):/Macintosh/i.test(i)||/MacIntel/i.test(i)?(r.os="macOS",(t=i.match(/Mac OS X (\d+[._]\d+)/))&&(r.version=""+t[1].replace(/_/g,"."))):/Android/i.test(i)||/android/i.test(i)?(r.os="Android",(e=i.match(/Android (\d+\.\d+)/))&&(r.version=""+e[1])):/iPhone|iPad|iPod/i.test(i)?(r.os="IOS",(e=i.match(/OS (\d+(_\d+)?)/))&&(r.version=""+e[1].replace(/_/g,"."))):/Linux/i.test(i)&&(r.os="Linux"),r},Pe.easeClamp=function(e,t,r){return e<=t?0:r<=e?1:.5*(Math.sin(((e-t)/(r-t)-.5)*Math.PI)+1)},Pe.linearClamp=function(e,t,r){return e<=t?0:r<=e?1:(e-t)/(r-t)},Pe.linearInterp=function(e,t,r){return t*(1-e)+r*e},Pe.round1=function(e){return Math.round(10*e)/10},Pe.round2=function(e){return Math.round(100*e)/100},Pe.getUniqueId=function(){var e=Date.now().toString(16);return e+=Math.random().toString(16).substr(3,4)},Pe.extractUrlBase=function(e){e=e.split("/");return 1===e.length?"./":(e.pop(),e.join("/")+"/")},Pe.getUUid32=function(e){return e=36===e.length?(e=e.slice(0,8)+e.slice(9,13)+e.slice(14,18)+e.slice(19,23)+e.slice(24,36)).toLowerCase():e},Pe.addSceneID=function(e){return 0!=De.ScenarioEditorid&&De.ScenarioEditor?e+"_"+De.ScenarioEditorid:e},Pe.resizeTextures=function(e,t,r){e=e.map(function(e){return Pe.resizeTexture(e,t,r)});return Promise.all(e)},Pe.resizeTexture=function(e,n,a){return new Promise(function(r,t){var i=new Image;i.crossOrigin="anonymous",i.src=e,i.onload=function(){var e=document.createElement("canvas"),t=e.getContext("2d"),t=(e.width=n,e.height=a,t.drawImage(i,0,0,n,a),e.toDataURL("image/jpeg"));r(t)},i.onerror=function(e){t(e)}})};function A(e){THREE.MeshBasicMaterial.call(this),this.depthTest=!1,this.depthWrite=!1,this.side=THREE.DoubleSide,this.transparent=!0,this.setValues(e),this.oldColor=this.color.clone(),this.oldOpacity=this.opacity,this.highlight=function(e){e?(this.color.setRGB(1,1,0),this.opacity=1):(this.color.copy(this.oldColor),this.opacity=this.oldOpacity)}}function M(e){THREE.LineBasicMaterial.call(this),this.depthTest=!1,this.depthWrite=!1,this.transparent=!0,this.linewidth=1,this.setValues(e),this.oldColor=this.color.clone(),this.oldOpacity=this.opacity,this.highlight=function(e){e?(this.color.setRGB(1,1,0),this.opacity=1):(this.color.copy(this.oldColor),this.opacity=this.oldOpacity)}}function E(){this.init=function(){THREE.Object3D.call(this),this.handles=new THREE.Object3D,this.pickers=new THREE.Object3D,this.planes=new THREE.Object3D,this.add(this.handles),this.add(this.pickers),this.add(this.planes);var o,e=new THREE.PlaneGeometry(50,50,2,2),t=new THREE.MeshBasicMaterial({visible:!1,side:THREE.DoubleSide}),r={XY:new THREE.Mesh(e,t),YZ:new THREE.Mesh(e,t),XZ:new THREE.Mesh(e,t),XYZE:new THREE.Mesh(e,t)};for(o in this.activePlane=r.XYZE,r.YZ.rotation.set(0,Math.PI/2,0),r.XZ.rotation.set(-Math.PI/2,0,0),r)r[o].name=o,this.planes.add(r[o]),this.planes[o]=r[o];function i(e,t){for(var r in e)for(o=e[r].length;o--;){var i=e[r][o][0],n=e[r][o][1],a=e[r][o][2];i.name=r,n&&i.position.set(n[0],n[1],n[2]),a&&i.rotation.set(a[0],a[1],a[2]),t.add(i)}}i(this.handleGizmos,this.handles),i(this.pickerGizmos,this.pickers),this.traverse(function(e){var t;e instanceof THREE.Mesh&&(e.updateMatrix(),(t=e.geometry.clone()).applyMatrix(e.matrix),e.geometry=t,e.position.set(0,0,0),e.rotation.set(0,0,0),e.scale.set(1,1,1))})},this.highlight=function(t){this.traverse(function(e){e.material&&e.material.highlight&&(e.name===t?e.material.highlight(!0):e.material.highlight(!1))})}}function te(e,t,r){function i(e,t){var r=new Image,i=(r.crossOrigin="anonymous",new THREE.Texture(r));switch(e){case 0:r.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAGuSURBVDhPpZK/SwJxGMbPkwYVAg0CHcIlECPEU8iisS2i0Yi2hiiiKWpoiH6ttRQRDTk4RP9EtAQhJxYhRkNGQ9MRhIQEZp/3zs47bfOBh/e95/3h931flV7haVlF07QBj8ezhftpGMZutVr9sSJtkDNNzlSz2cwXi0VdNNWMAAQD0we3Q6HQuik6QHGM4kvcdL1eL1mqo0ELm7BC4l4qldIsiYp0OoC5gt9wvlwuN0QXuBrouv6FWYAyWp4mftF58jFNR3EXyXkT7Q/elrXxDiKRiMyfhYFwODxI8Q7+CcWHkuOEvUQn4vG41+fz3eCOwxp8aTQamVKpVJe4E/82ELC0YX65gqsyQoYl31kRNzqXaINiGcGM46+K/Q9dOxCw9UlMDl7DVzjLXp5YzyO+C10jJJPJoKqqcud++TRFRbmHcrpE5xW6RqD4HDMEl0muCtmBjBCEuWg06qpxjcDilph3A/eCwgNLNU/7wAgx3Bm/31/j+9aKOF5A8QjFR7jPnGzNUtvgZSsYef4+f7CEKQK7AcUTmDOem+XecnsXCoXCB7E53FM4Zoq9Q1F+AdSNjQGiWI24AAAAAElFTkSuQmCC";break;case 1:r.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAEnSURBVDhP3ZM9S8RAEIbz0ZhAsEgj+QF6pDjyYWFj5Q/wbyhiIYetCCeWtoKVxZWW9gaxECTR7mwFIVWw0c4Qn8ntrYa7RsXGB968k8nuzDJhjd9iKjfSNN3GlpumGRVFkU+yXeI4XrEsa4twnOf5meQseSju0a5pmqMoihYmqU/CMLTZfE64g3QDXYCKt9gJ6tm2fdgmv+A4zh62ho5YO1tAqOv6AHtEgyRJVtskcPQeNkR3rDlukwo9gynMQrrcoDFKqqqqfd+/lk8oprk00NjKNWVZPgdBsEi4id5c1+3jMrh9Nl/iHWZOIHAKF3tAS+hdYs/zNrIsa4g7zC0gUGQdy9Ar6tP9SfLfgkG+UOhKvc6l8xd+wn8vwL045XJdqNe/wDA+AM+DTooKvznTAAAAAElFTkSuQmCC";break;case 2:r.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAE0SURBVDhPpZI9S8RAEIbzQRCLA8FeFPsYErk6jf4HLbQQwfZK7fTA2sbeRixsxcreIiQgthbXWUXRFHbGZ3aXkGA2V9wDwzs7w8zObOIsimtUkSTJGNnTJysfeZ5Pjd9tEMfxPnKtT11c1/WRETajwYYKQqeBjTRN3aqqbnFlugkNrlQCPKODUHyKSPFdu1iY24B32UEusFfWOFbBFoMrULyG5JjsP+b2N4m3sU4QhuESco+tYgd9xYK1QRAEsqt81inFDyrYQ28DPuchcoI9lmV5roIW/r0BxVs81jPuu+d521mWfepMP/I4DVEUrVD0hDuq63qX0Wc6Y6dZQX4W3/dvcDexo6IoXlRiDs0KcjsNZNxfbv/W0X5YcZ3pvpSvIsDuyyQuzXEQLjhjwh9zXATH+QMUOlTdo/cuSQAAAABJRU5ErkJggg=="}r.onload=function(){i.needsUpdate=!0,g.parent.dispatchEvent({type:"change"})},e=new THREE.SpriteMaterial({map:i,depthTest:!1,depthWrite:!1,transparent:!0}),(e=new THREE.Sprite(e)).scale.set(.2,.2,1),e.material.needsUpdate=!0,t(e)}var n,a,o,s=this,l=(void 0===r&&(r={}),E.call(this),!0),d=!0,c=!0;e&&(l=0<=e.indexOf("translateX"),d=0<=e.indexOf("translateY"),c=0<=e.indexOf("translateZ"));var h=(e=Pe.isMobileDevice())?new THREE.CylinderGeometry(0,.08,.17,14,1,!1):new THREE.CylinderGeometry(0,.06,.2,12,1,!1),u=((u=new THREE.Mesh(h)).position.y=.5,u.updateMatrix(),h.applyMatrix(u.matrix),1.4),p=new THREE.CylinderGeometry(e?.02:.015,e?.02:.015,e?u:1.4,3),f=[new THREE.Mesh(p,new A({color:16711680})),[.7,0,0],[0,0,Math.PI/2]],m=[new THREE.Mesh(p,new A({color:65280})),[0,.7,0],[0,Math.PI/2,0]],p=[new THREE.Mesh(p,new A({color:255})),[0,0,.7],[Math.PI/2,0,0]],g=(De.AnimationEdit&&((n=new THREE.BufferGeometry).addAttribute("position",new THREE.Float32BufferAttribute([0,0,0,1.4,0,0],3)),(a=new THREE.BufferGeometry).addAttribute("position",new THREE.Float32BufferAttribute([0,0,0,0,1.4,0],3)),(o=new THREE.BufferGeometry).addAttribute("position",new THREE.Float32BufferAttribute([0,0,0,0,0,1.4],3)),f=[new THREE.Line(n,new M({color:16711680}))],m=[new THREE.Line(a,new M({color:65280}))],p=[new THREE.Line(o,new M({color:255}))]),this.handleGizmos={},l&&(this.handleGizmos.X=[[new THREE.Mesh(h,new A({color:16711680})),[.9,0,0],[0,0,-Math.PI/2]],f]),d&&(this.handleGizmos.Y=[[new THREE.Mesh(h,new A({color:65280})),[0,.9,0]],m]),c&&(this.handleGizmos.Z=[[new THREE.Mesh(h,new A({color:255})),[0,0,.9],[Math.PI/2,0,0]],p]),this);Pe.isMobileDevice()&&!r.ViewBoxTransform||0==t||(i(0,function(e){e.position.set(1.7,0,0),e.name="xSprite",s.handleGizmos.X&&s.handleGizmos.X[0][0].add(e)}),i(1,function(e){e.position.set(0,1.7,0),e.name="ySprite",s.handleGizmos.Y&&s.handleGizmos.Y[0][0].add(e)}),i(2,function(e){e.position.set(0,0,1.7),e.name="zSprite",s.handleGizmos.Z&&s.handleGizmos.X&&s.handleGizmos.Y&&s.handleGizmos.Z[0][0].add(e)})),l&&d&&c&&(this.handleGizmos.XY=[[new THREE.Mesh(new THREE.PlaneGeometry(.29,.29),new A({color:16776960,opacity:.25})),[.15,.15,0]]],this.handleGizmos.YZ=[[new THREE.Mesh(new THREE.PlaneGeometry(.29,.29),new A({color:65535,opacity:.25})),[0,.15,.15],[0,Math.PI/2,0]]],this.handleGizmos.XZ=[[new THREE.Mesh(new THREE.PlaneGeometry(.29,.29),new A({color:16711935,opacity:.25})),[.15,0,.15],[-Math.PI/2,0,0]]]),this.pickerGizmos={},l&&(this.pickerGizmos.X=e?[[new THREE.Mesh(new THREE.CylinderGeometry(.22,.05,.4+u,4,1,!1),v),[(.4+u)/2,0,0],[0,0,-Math.PI/2]]]:[[new THREE.Mesh(new THREE.CylinderGeometry(.2,0,1.7,4,1,!1),v),[.6,0,0],[0,0,-Math.PI/2]]]),d&&(this.pickerGizmos.Y=e?[[new THREE.Mesh(new THREE.CylinderGeometry(.22,.05,.4+u,4,1,!1),v),[0,(.4+u)/2,0]]]:[[new THREE.Mesh(new THREE.CylinderGeometry(.2,0,1.7,4,1,!1),v),[0,.6,0]]]),c&&(this.pickerGizmos.Z=e?[[new THREE.Mesh(new THREE.CylinderGeometry(.22,.05,.4+u,4,1,!1),v),[0,0,(.4+u)/2],[Math.PI/2,0,0]]]:[[new THREE.Mesh(new THREE.CylinderGeometry(.2,0,1.7,4,1,!1),v),[0,0,.6],[Math.PI/2,0,0]]]),!1!==r.needPlane&&l&&d&&c&&(this.pickerGizmos.XYZ=[[new THREE.Mesh(new THREE.OctahedronGeometry(.2,0),v)]],this.pickerGizmos.XY=[[new THREE.Mesh(new THREE.PlaneGeometry(.4,.4),v),[.2,.2,0]]],this.pickerGizmos.YZ=[[new THREE.Mesh(new THREE.PlaneGeometry(.4,.4),v),[0,.2,.2],[0,Math.PI/2,0]]],this.pickerGizmos.XZ=[[new THREE.Mesh(new THREE.PlaneGeometry(.4,.4),v),[.2,0,.2],[-Math.PI/2,0,0]]]),this.setActivePlane=function(e,t){var r=new THREE.Matrix4;t.applyMatrix4(r.getInverse(r.extractRotation(this.planes.XY.matrixWorld))),"X"===e&&(this.activePlane=this.planes.XY,Math.abs(t.y)>Math.abs(t.z))&&(this.activePlane=this.planes.XZ),"Y"===e&&(this.activePlane=this.planes.XY,Math.abs(t.x)>Math.abs(t.z))&&(this.activePlane=this.planes.YZ),"Z"===e&&(this.activePlane=this.planes.XZ,Math.abs(t.x)>Math.abs(t.y))&&(this.activePlane=this.planes.YZ),"XYZ"===e&&(this.activePlane=this.planes.XYZE),"XY"===e&&(this.activePlane=this.planes.XY),"YZ"===e&&(this.activePlane=this.planes.YZ),"XZ"===e&&(this.activePlane=this.planes.XZ)},this.showAxis=function(e,t){if(void 0!==e&&""!==e)switch(e){case"x":for(var r=0;r<this.handleGizmos.X.length;r++)this.handleGizmos.X[r][0].visible=t;this.pickerGizmos.X[0][0].visible=t;break;case"y":for(r=0;r<this.handleGizmos.Y.length;r++)this.handleGizmos.Y[r][0].visible=t;this.pickerGizmos.Y[0][0].visible=t;break;case"z":for(r=0;r<this.handleGizmos.Z.length;r++)this.handleGizmos.Z[r][0].visible=t;this.pickerGizmos.Z[0][0].visible=t}},this.showText=function(e,t){if(void 0!==e&&""!==e)switch(e){case"x":this.handleGizmos.X[0][0].visible=t;break;case"y":this.handleGizmos.Y[0][0].visible=t;break;case"z":this.handleGizmos.Z[0][0].visible=t;case"r":this.handleGizmos.X[0][0].children[0].visible=t}},this.changeColor=function(e,t){if(void 0!==e&&""!==e)switch(e){case"x":this.handleGizmos.X[1][0].material.color.setRGB(t.x,t.y,t.z);break;case"y":this.handleGizmos.Y[1][0].material.color.setRGB(t.x,t.y,t.z);break;case"z":this.handleGizmos.Z[1][0].material.color.setRGB(t.x,t.y,t.z);case"r":this.handleGizmos.X[1][0].material.color.setRGB(t.x,t.y,t.z),this.handleGizmos.X[0][0].children[0].material.color.setRGB(t.x,t.y,t.z)}},this.init()}function re(){function e(e,t,r){var i=new THREE.BufferGeometry,n=[];r=r||1;for(var a=0;a<=64*r;++a)"x"===t&&n.push(0,Math.cos(a/32*Math.PI)*e,Math.sin(a/32*Math.PI)*e),"y"===t&&n.push(Math.cos(a/32*Math.PI)*e,0,Math.sin(a/32*Math.PI)*e),"z"===t&&n.push(Math.sin(a/32*Math.PI)*e,Math.cos(a/32*Math.PI)*e,0);return i.addAttribute("position",new THREE.Float32BufferAttribute(n,3)),i}E.call(this);var t=Pe.isMobileDevice()?.8:.7,r=new THREE.BufferGeometry,i=new Float32Array([-.1,0,0,0,.3,0,0,0,-.1,0,0,-.1,0,.3,0,.1,0,0,.1,0,0,0,.3,0,0,0,.1,0,0,.1,0,.3,0,-.1,0,0,-.1,0,0,0,-.3,0,0,0,-.1,0,0,-.1,0,-.3,0,.1,0,0,.1,0,0,0,-.3,0,0,0,.1,0,0,.1,0,-.3,0,-.1,0,0]),n=(r.addAttribute("position",new THREE.BufferAttribute(i,3)),new THREE.MeshBasicMaterial({color:16711680}));new THREE.Mesh(r,n).position.set(t,0,0),new THREE.Line(new e(t,"x",.5),new M({color:16711680})),new THREE.Line(new e(t,"y",.5),new M({color:65280})),new THREE.Line(new e(t,"z",.5),new M({color:255})),r.addAttribute("position",new THREE.BufferAttribute(i,3)),(n=new THREE.Mesh(r,new A({color:16711680}))).scale.set(.5,.5,.5),n.position.set(0,0,t),(i=new THREE.Mesh(r,new A({color:65280}))).scale.set(.5,.5,.5),i.rotateZ(Math.PI/2),i.position.set(0,0,t),(r=new THREE.Mesh(r,new A({color:255}))).scale.set(.5,.5,.5),r.position.set(t,0,0),Pe.isMobileDevice()?this.handleGizmos={X:[[new THREE.Mesh(new THREE.TorusGeometry(t,.01,10,40,Math.PI),new A({color:16711680})),[0,0,0],[0,-Math.PI/2,-Math.PI/2]],[n]],Y:[[new THREE.Mesh(new THREE.TorusGeometry(t,.01,10,40,Math.PI),new A({color:65280})),[0,0,0],[Math.PI/2,0,0]],[i]],Z:[[new THREE.Mesh(new THREE.TorusGeometry(t,.01,10,40,Math.PI),new A({color:255})),[0,0,0],[0,0,-Math.PI/2]],[r]],XYZE:[[new THREE.Line(new e(.8,"z",1),new M({color:7895160}))]]}:this.handleGizmos={X:[[new THREE.Mesh(new THREE.TorusGeometry(.8,.01,10,40,Math.PI),new A({color:16711680})),[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new THREE.Mesh(new THREE.TorusGeometry(.8,.01,10,40,Math.PI),new A({color:65280})),[0,0,0],[Math.PI/2,0,0]]],Z:[[new THREE.Mesh(new THREE.TorusGeometry(.8,.01,10,40,Math.PI),new A({color:255})),[0,0,0],[0,0,-Math.PI/2]]],XYZE:[[new THREE.Line(new e(.8,"z",1),new M({color:7895160}))]]},Pe.isMobileDevice()?this.pickerGizmos={X:[[new THREE.Mesh(new THREE.TorusGeometry(t,.1,10,40,Math.PI),v),[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new THREE.Mesh(new THREE.TorusGeometry(t,.1,10,40,Math.PI),v),[0,0,0],[Math.PI/2,0,0]]],Z:[[new THREE.Mesh(new THREE.TorusGeometry(t,.1,10,40,Math.PI),v),[0,0,0],[0,0,-Math.PI/2]]],XYZE:[[new THREE.Mesh(new THREE.Geometry)]]}:this.pickerGizmos={X:[[new THREE.Mesh(new THREE.TorusGeometry(.8,.132,4,12,Math.PI),v),[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new THREE.Mesh(new THREE.TorusGeometry(.8,.132,4,12,Math.PI),v),[0,0,0],[Math.PI/2,0,0]]],Z:[[new THREE.Mesh(new THREE.TorusGeometry(.8,.132,4,12,Math.PI),v),[0,0,0],[0,0,-Math.PI/2]]],XYZE:[[new THREE.Mesh(new THREE.Geometry)]]},this.showAxis=function(e,t){if(void 0!==e&&""!==e)switch(e){case"x":this.handleGizmos.X[0][0].visible=t,this.handleGizmos.X[1]&&(this.handleGizmos.X[1][0].visible=t),this.pickerGizmos.X[0][0].visible=t;break;case"y":this.handleGizmos.Y[0][0].visible=t,this.handleGizmos.Y[1]&&(this.handleGizmos.Y[1][0].visible=t),this.pickerGizmos.Y[0][0].visible=t;break;case"z":this.handleGizmos.Z[0][0].visible=t,this.handleGizmos.Z[1]&&(this.handleGizmos.Z[1][0].visible=t),this.pickerGizmos.Z[0][0].visible=t}},this.changeColor=function(e,t){if(void 0!==e&&""!==e)switch(e){case"x":this.handleGizmos.X[0][0].material.color.setRGB(t.x,t.y,t.z);break;case"y":this.handleGizmos.Y[0][0].material.color.setRGB(t.x,t.y,t.z);break;case"z":this.handleGizmos.Z[0][0].material.color.setRGB(t.x,t.y,t.z)}},this.setActivePlane=function(e){"E"===e&&(this.activePlane=this.planes.XYZE),"X"===e&&(this.activePlane=this.planes.YZ),"Y"===e&&(this.activePlane=this.planes.XZ),"Z"===e&&(this.activePlane=this.planes.XY)},this.update=function(e,t){E.prototype.update.apply(this,arguments);this.handles,this.pickers;var r=new THREE.Matrix4,i=new THREE.Euler(0,0,1),n=new THREE.Quaternion,a=new THREE.Vector3(1,0,0),o=new THREE.Vector3(0,1,0),s=new THREE.Vector3(0,0,1),l=new THREE.Quaternion,d=new THREE.Quaternion,c=new THREE.Quaternion,h=t.clone();i.copy(this.planes.XY.rotation),n.setFromEuler(i),r.makeRotationFromQuaternion(n).getInverse(r),h.applyMatrix4(r),this.traverse(function(e){n.setFromEuler(i),"X"===e.name&&(l.setFromAxisAngle(a,Math.atan2(-h.y,h.z)),n.multiplyQuaternions(n,l),e.quaternion.copy(n)),"Y"===e.name&&(d.setFromAxisAngle(o,Math.atan2(h.x,h.z)),n.multiplyQuaternions(n,d),e.quaternion.copy(n)),"Z"===e.name&&(c.setFromAxisAngle(s,Math.atan2(h.y,h.x)),n.multiplyQuaternions(n,c),e.quaternion.copy(n))})},this.init()}function ie(){var r=this;THREE.Object3D.call(this),this._gizmoTranslate=new te,this._gizmoRotate=new re,this.add(this._gizmoTranslate),this.add(this._gizmoRotate),this._translatePickers=this._gizmoTranslate.pickers,this._rotatePickers=this._gizmoRotate.pickers,this.activePlane=this._gizmoTranslate.activePlane,this.highlight=function(e,t){"translate"==t?(this._gizmoRotate.highlight(null),this._gizmoTranslate.highlight(e)):"rotate"==t&&(this._gizmoTranslate.highlight(null),this._gizmoRotate.highlight(e))},this.setActivePlane=function(e,t){"translate"==r.pickType?(this._gizmoTranslate.setActivePlane(e,t),this.activePlane=this._gizmoTranslate.activePlane):"rotate"==r.pickType&&(this._gizmoRotate.setActivePlane(e,t),this.activePlane=this._gizmoRotate.activePlane)},this.update=function(e,t){this.parent.viewer.viewManager&&!this.parent.viewer.viewManager.isActiveViewInRender()||this._gizmoTranslate.update(e,t),this._gizmoRotate.update(e,t)}}function ne(){E.call(this);var e=new THREE.BoxGeometry(.125,.125,.125),t=new THREE.Mesh(e);t.position.y=.5,t.updateMatrix(),e.applyMatrix4(t.matrix);(t=new THREE.BufferGeometry).addAttribute("position",new THREE.Float32BufferAttribute([0,0,0,1,0,0],3));var r=new THREE.BufferGeometry,i=(r.addAttribute("position",new THREE.Float32BufferAttribute([0,0,0,0,1,0],3)),new THREE.BufferGeometry);i.addAttribute("position",new THREE.Float32BufferAttribute([0,0,0,0,0,1],3)),this.handleGizmos={X:[[new THREE.Mesh(e,new A({color:16711680})),[.5,0,0],[0,0,-Math.PI/2]],[new THREE.Line(t,new M({color:16711680}))]],Y:[[new THREE.Mesh(e,new A({color:65280})),[0,.5,0]],[new THREE.Line(r,new M({color:65280}))]],Z:[[new THREE.Mesh(e,new A({color:255})),[0,0,.5],[Math.PI/2,0,0]],[new THREE.Line(i,new M({color:255}))]],XYZ:[[new THREE.Mesh(new THREE.BoxGeometry(.125,.125,.125),new A({color:16777215,opacity:.25}))]]},this.pickerGizmos={X:[[new THREE.Mesh(new THREE.CylinderGeometry(.2,0,1,4,1,!1),v),[.6,0,0],[0,0,-Math.PI/2]]],Y:[[new THREE.Mesh(new THREE.CylinderGeometry(.2,0,1,4,1,!1),v),[0,.6,0]]],Z:[[new THREE.Mesh(new THREE.CylinderGeometry(.2,0,1,4,1,!1),v),[0,0,.6],[Math.PI/2,0,0]]],XYZ:[[new THREE.Mesh(new THREE.BoxGeometry(.4,.4,.4),v)]]},this.setActivePlane=function(e,t){var r=new THREE.Matrix4;t.applyMatrix4(r.getInverse(r.extractRotation(this.planes.XY.matrixWorld))),"X"===e&&(this.activePlane=this.planes.XY,Math.abs(t.y)>Math.abs(t.z))&&(this.activePlane=this.planes.XZ),"Y"===e&&(this.activePlane=this.planes.XY,Math.abs(t.x)>Math.abs(t.z))&&(this.activePlane=this.planes.YZ),"Z"===e&&(this.activePlane=this.planes.XZ,Math.abs(t.x)>Math.abs(t.y))&&(this.activePlane=this.planes.YZ),"XYZ"===e&&(this.activePlane=this.planes.XYZE)},this.init()}function Fe(u){for(var l,e,h=u.lights,a=u.camera,t=u.scene,p=(this.viewer=u,new THREE.Group),o=(p.name="lightctrls",t.add(p),null),o=u.canvas2D||u.canvas3D,c=[],f=null,m=null,d=null,g=null,v=null,y=null,A=null,M=null,E=null,w=null,x=null,b=null,t=h.length,r=!1,i=.7,s=(o.width,o.height),B=new Array(t),n=null,I=2,T=.7,S=1e3,R=this,C=(this._scene=p,this._transformScene=new THREE.Scene,new THREE.TextureLoader(new THREE.LoadingManager)),D=0;D<h.length;D++)h[D]._enabled=!0,h[D]._visible=!0,h[D]._iconVisible=!1,p.add(h[D]),null!=h[D]._followCamera&&1==h[D]._followCamera&&(e=new H(D),h[D]._followCameraListener=e,h[D].oldDir=h[D].target.getWorldPosition(),h[D].oldDir.sub(h[D].getWorldPosition()),h[D].oldDir.normalize(),R.viewer.addFrameListener(e));function P(e){if(null!=e)for(var t=0;t<e.children.length;t++)if(e.children[t]instanceof THREE.Sprite)return t;return-1}function O(e){if(null!=e)for(var t=0;t<e.children.length;t++)if("spotframe"==e.children[t].name)return t;return-1}function F(){this.run=function(){new THREE.Vector3;o.width,s=o.height;for(var e,t=0;t<B.length;t++)h[t]&&h[t]._enabled&&h[t]._iconVisible&&0<=(e=P(B[t]))&&(e=B[t].children[e],n=B[t].position.distanceTo(a.position)/30,"hemilightctrl"==e.name&&(n*=1.6),n=n/(s/1e3)*T,e.scale.x=e.scale.y=n,e.updateMatrixWorld(!0));for(var r,i,n,t=0;t<B.length;t++)h[t]._enabled&&h[t]._iconVisible&&(r=-1,(i=null)!=B[t]&&"spotlightgroup"==B[t].name?r=O(B[t]):null!=B[t]&&"dirlightgroup"==B[t].name&&(r=function(e){if(null!=e)for(var t=0;t<e.children.length;t++)if("sundir"==e.children[t].name)return t;return-1}(B[t])),0<=r)&&(i=B[t].children[r],n=(n=B[t].position.distanceTo(a.position)/30)/(s/1e3)*T,i.scale.x=i.scale.y=i.scale.z=n,i.updateMatrixWorld(!0));null!=b&&b.update()}}function H(i){this.run=function(){var e,t,r;u.controls instanceof ke&&"DirectionalLight"==h[i].type&&(u.renderer.isInARModel||(r=a.getWorldDirection(new THREE.Vector3),t=a.up.clone(),r.normalize(),t.normalize(),r.negate(),t.multiplyScalar(.9),(e=new THREE.Vector3).addVectors(r,t),e.normalize(),e.negate(),t=(r=h[i]).target,r=r.position,t.position.set(r.x+e.x,r.y+e.y,r.z+e.z),t.updateMatrixWorld(!0)))}}function U(){(b=new z(c,o,u,R)).setSize(i),n=new F,R.viewer.addFrameListener(n);var e=P(B[0]);0<e&&b.attachTo(B[0].children[e]),u.render()}function N(){var e=new THREE.MeshBasicMaterial({color:6710886,wireframe:!0}),t=new THREE.CylinderGeometry(.1,.6,.8,20,1,!0),t=new THREE.Mesh(t,e);return t.position.set(0,0,0),t.name="spotframe",t}function V(e){null==x&&(x=new THREE.SpriteMaterial({map:w,side:THREE.DoubleSide,transparent:!0}));var t=h[e],r=new THREE.Sprite(x),i=(r.name="spotlightctrl",c.push(r),N()),n=(B[e]=new THREE.Group,B[e].name="spotlightgroup",B[e].index=e,B[e].position.copy(t.position),t.position.x),a=t.position.y,o=t.position.z,s=t.target.position.x,l=t.target.position.y,d=t.target.position.z,s=new THREE.Vector3(s-n,l-a,d-o),n=(s.normalize(),new THREE.Quaternion),l=new THREE.Vector3(0,-1,0),a=s,d=(t.position.set(0,0,0),t.target.position.set(0,-1,0),B[e].add(r),B[e].add(i),B[e].add(t.target),B[e].add(t),n.setFromUnitVectors(l,a),B[e].quaternion);d.multiplyQuaternions(n,d),d.normalize(),B[e].setRotationFromQuaternion(d),p.add(B[e]),h[e]._iconVisible=!0,B[e].updateMatrixWorld(!0)}function G(e){null==g&&(g=new THREE.SpriteMaterial({map:v,side:THREE.DoubleSide,transparent:!0}));var t=h[e],r=new THREE.Sprite(g);r.name="pointlightctrl",c.push(r),B[e]=new THREE.Group,B[e].name="pointlightgroup",B[e].position.copy(t.position),t.position.set(0,0,0),B[e].add(r),B[e].add(t),p.add(B[e]),h[e]._iconVisible=!0,B[e].updateMatrixWorld(!0)}function k(e){null==A&&(A=new THREE.SpriteMaterial({map:M,side:THREE.DoubleSide,transparent:!0}));var t=h[e],r=new THREE.Sprite(A);r.name="hemilightctrl",c.push(r),B[e]=new THREE.Group,B[e].name="hemilightgroup",B[e].position.copy(t.position),t.position.set(0,0,0),B[e].add(r),B[e].add(t),p.add(B[e]),h[e]._iconVisible=!0,B[e].updateMatrixWorld(!0)}function j(e){null==f&&(f=new THREE.SpriteMaterial({map:m,side:THREE.DoubleSide,transparent:!0}));var t=h[e],r=new THREE.Sprite(f),i=(r.name="dirlightctrl",c.push(r),new THREE.Geometry),n=(i.vertices.push(new THREE.Vector3(0,0,0)),t.position.x),a=t.position.y,o=t.position.z,s=t.target.position.x,l=t.target.position.y,d=t.target.position.z,s=new THREE.Vector3(s-n,l-a,d-o),n=((s=s.normalize()).x*=I,s.y*=I,s.z*=I,i.vertices.push(new THREE.Vector3(s.x,s.y,s.z)),new THREE.LineBasicMaterial({linewidth:1,color:16776960})),l=new THREE.Line(i,n);l.name="sundir",t.target.position.copy(s),B[e]=new THREE.Group,B[e].name="dirlightgroup",B[e].index=e,B[e].position.copy(t.position),t.position.set(0,0,0),B[e].add(r),B[e].add(t.target),B[e].add(t),B[e].add(l),p.add(B[e]),h[e]._iconVisible=!0,B[e].updateMatrixWorld(!0)}function _(e){for(var t=0;t<c.length;t++)if(e==c[t]){c.splice(t,1);break}}function L(e){for(var t=0;t<h.length;t++)if(e==h[t])return t}this.loadTextures=function(e){var t=this.viewer.serverUrl||"./";m=C.load(t+"img/sun.png",function(){M=C.load(t+"img/hemi.png",function(){v=C.load(t+"img/lamp.png",function(){w=C.load(t+"img/spotlight.png",function(){null!=e&&e()})})})})},this.renderLight=function(){this._transformScene&&this.viewer.renderer.render(this._transformScene,this.viewer.camera)},this.resetPosition=function(){for(var e=u.controls.getBoundingBox(),t=e.min.x,r=e.min.y,i=e.min.z,n=e.max.x,a=e.max.y,o=e.max.z,s=new Array(3),l=(s[0]=a-r,s[1]=n-t,s[2]=o-i,s[0]),d=0;d<3;d++)s[d]>l&&(l=s[d]);S=4*l,l/=10,R.setDirLength(2);for(var c=0;c<h.length;c++)0==c?(h[0]._iconVisible?(B[0].position.set(t+(n-t)/2,a+l,i-l),B):(h[0].position.set(t+(n-t)/2,a+l,i-l),h))[0].updateMatrixWorld(!0):1==c?(h[1]._iconVisible?(B[1].position.set(n+l,a+l,i+(o-i)/2),B):(h[1].position.set(n+l,a+l,i+(o-i)/2),h))[1].updateMatrixWorld(!0):2==c&&((h[2]._iconVisible?(B[2].position.set(t-l,a+l,i+(o-i)/2),B):(h[2].position.set(t-l,a+l,i+(o-i)/2),h))[2].updateMatrixWorld(!0),h[2]._distance=50,h[2].distance=h[2]._distance/100*S);u.render()},this.computeMaxdistance=function(){for(var e=u.controls.getBoundingBox(),t=e.min.x,r=e.min.y,i=e.min.z,n=e.max.x,a=e.max.y,e=e.max.z,o=new Array(3),s=(o[0]=a-r,o[1]=n-t,o[2]=e-i,o[0]),l=0;l<3;l++)o[l]>s&&(s=o[l]);S=4*s;for(l=0;l<h.length;l++)"PointLight"==h[l].type?R.setPointLightParam(h[l]._distance):"SpotLight"==h[l].type&&R.setSpotLightParam(h[l]._distance)},this.getMaxdistance=function(){return S},this.setMaxdistance=function(e){S=e},this.setIconVisible=function(e,t){if(null==e||!e._enabled)return!1;null==b&&(U(),b.isActive()||b.activate());var r=L(e),i=e.type;if(e._iconVisible!=t&&"DirectionalLight"!=i){if(t)switch(i){case"DirectionalLight":j(r);break;case"SpotLight":V(r);break;case"HemisphereLight":k(r);break;case"PointLight":G(r)}else{p.remove(B[r]);var n=P(B[r]),a=B[r].children[n],o=b.getCurrAttachObj();B[r]==o&&b.detach(),_(a),e.position.copy(B[r].position),"DirectionalLight"!=i&&"SpotLight"!=i||(o=e.target.getWorldPosition(),e.target.position.copy(o),p.add(e.target),e.target.updateMatrixWorld(!0)),p.add(e),e.updateMatrixWorld(!0),e._iconVisible=t}h[r]._iconVisible&&(b.detach(),n=P(B[r]),b.attachTo(B[r].children[n])),u.render()}h[r]._iconVisible&&(b.detach(),n=P(B[r]),b.attachTo(B[r].children[n])),u.render()},this.setIconSize=function(e){T=e},this.setControlsSize=function(e){i=e,b.setSize(i)},this.setDirLength=function(e){I=e},this.getLightsCount=function(){return h.length},this.setVisible=function(e){if(e==r)return!1;for(var t=0;t<h.length;t++)h[t]._enabled&&this.setIconVisible(h[t],e);return b&&b.detach(),(r=e)?null==b||b.isActive()||b.activate():null!=b&&b.isActive()&&b.deactivate(),!0},this.getVisible=function(){for(var e=!1,t=0;t<h.length;t++)if(h[t]._iconVisible){e=!0;break}return e},this.dispose=function(){for(var e,t=0;t<h.length;t++)p.remove(B[t]),h[t].position.copy(B[t].position),"DirectionalLight"!=h[t].type&&"SpotLight"!=h[t].type||(e=h[t].target.getWorldPosition(),h[t].target.position.copy(e)),p.add(h[t]);c.splice(0,c.length),u.render()},this.switchLight=function(e,t){if(e<0||e>=h.length)return!1;if(null==b&&(U(),b.isActive()||b.activate()),"None"==t)this.setIconVisible(h[e],!1),this.setLightEnabled(h[e],!1),h[e].type="None";else if(this.setLightEnabled(h[e],!0),h[e].type!=t){"DirectionalLight"==h[e].type&&h[e]._followCamera&&(R.viewer.removeFrameListener(h[e]._followCameraListener),h[e]._followCamera=null);var r,i=null,n=(h[e]._iconVisible?(i=B[e].position,p.remove(B[e]),r=P(B[e]),_(B[e].children[r])):(p.remove(h[e]),i=h[e].position),h[e]._iconVisible);switch(t){case"DirectionalLight":h[e]=new THREE.DirectionalLight(16777215,1),h[e]._enabled=!0,h[e]._visible=!0,h[e]._iconVisible=!1,h[e]._followCamera=!1,h[e].position.copy(i),p.add(h[e]),b.detach();break;case"PointLight":h[e]=new THREE.PointLight(16777215),h[e]._enabled=!0,h[e]._visible=!0,h[e]._iconVisible=!1,h[e]._distance=50,h[e].distance=.5*S,h[e].position.copy(i),n?G(e):p.add(h[e]);break;case"HemisphereLight":h[e]=new THREE.HemisphereLight(16777215,16777215,1),h[e]._enabled=!0,h[e]._visible=!0,h[e]._iconVisible=!1,h[e].position.copy(i),n?k(e):p.add(h[e]);break;case"SpotLight":h[e]=new THREE.SpotLight(16777215,1),h[e]._enabled=!0,h[e]._visible=!0,h[e]._iconVisible=!1,h[e]._distance=50,h[e].distance=.5*S,h[e].position.copy(i),h[e].target.position.set(i.x,i.y-1,i.z),n?V(e):p.add(h[e])}h[e]._iconVisible&&(b.detach(),r=P(B[e]),b.attachTo(B[e].children[r])),u.render()}return!0},this.addLight=function(e){for(var t=u.controls.getBoundingBox(),r=t.min.x,i=t.min.y,n=t.min.z,a=t.max.x,o=t.max.y,t=t.max.z,s=new Array(3),l=(s[0]=o-i,s[1]=a-r,s[2]=t-n,s[0]),d=0;d<3;d++)s[d]>l&&(l=s[d]);S=4*l,l/=10;var c=h.length;switch(e){case"DirectionalLight":h[c]=new THREE.DirectionalLight(16777215,1),h[c]._enabled=!0,h[c]._visible=!0,h[c]._iconVisible=!1,h[c]._followCamera=!1,h[c].position.set(1,2,0),p.add(h[c]);break;case"PointLight":h[c]=new THREE.PointLight(16777215),h[c]._enabled=!0,h[c]._visible=!0,h[c]._iconVisible=!1,h[c]._distance=50,h[c].distance=.5*S,h[c].position.set(0,0,0),p.add(h[c]);break;case"HemisphereLight":h[c]=new THREE.HemisphereLight(16777215,16777215,1),h[c]._enabled=!0,h[c]._visible=!0,h[c]._iconVisible=!1,h[c].position.set(0,5,0),p.add(h[c]);break;case"SpotLight":h[c]=new THREE.SpotLight(16777215,1),h[c]._enabled=!0,h[c]._visible=!0,h[c]._iconVisible=!1,h[c]._distance=50,h[c].distance=.5*S,h[c].position.set(10,10,10),h[c].target.position.set(10,9,10),p.add(h[c]);break;case"None":h[c]=new THREE.DirectionalLight(16777215,1),h[c]._enabled=!1,h[c]._visible=!1,h[c]._iconVisible=!1,h[c]._followCamera=!1,h[c].position.set(1,2,0),h[c].type="None"}h[c]&&(h[c].position.set(r+(a-r)/2+l*c,o+l,n-l+l*c),h[c].updateMatrixWorld(!0)),u.render()},this.removeLight=function(e){var t,e=L(e);"DirectionalLight"==h[e].type&&h[e]._followCamera&&(R.viewer.removeFrameListener(h[e]._followCameraListener),h[e]._followCamera=null),h[e]._iconVisible?(p.remove(B[e]),t=P(B[e]),_(B[e].children[t])):p.remove(h[e]),B.splice(e,1),h.splice(e,1);for(var r,i=0;i<h.length;i++)"DirectionalLight"==h[i].type&&h[i]._followCamera&&(R.viewer.removeFrameListener(h[i]._followCameraListener),r=new H(i),R.viewer.addFrameListener(r),h[i]._followCameraListener=r);b&&b.detach(),u.render()},this.getLightList=function(){return h},this.getLight=function(e){return e<0||e>=h.length?null:h[e]},this.showLightGizmo=function(e){var t,r;e._enabled&&e._iconVisible&&(r=L(e),t=P(B[r]),r=B[r].children[t],e._enabled?b.attachTo(r):b.detach())},this.getLightEnabled=function(e){if(null!=e)return e._enabled},this.setLightVisible=function(e,t){if(null==e)return!1;if(e._visible==t)return!0;if("DirectionalLight"==e.type)return!0;e._visible=t;var r=L(e),i=e.type;if(t){switch(i){case"DirectionalLight":null==f&&(f=new THREE.SpriteMaterial({map:m,side:THREE.DoubleSide,transparent:!0})),(o=new THREE.Sprite(f)).name="dirlightctrl";break;case"HemisphereLight":null==A&&(A=new THREE.SpriteMaterial({map:M,side:THREE.DoubleSide,transparent:!0})),(o=new THREE.Sprite(A)).name="hemilightctrl";break;case"PointLight":null==g&&(g=new THREE.SpriteMaterial({map:v,side:THREE.DoubleSide,transparent:!0})),(o=new THREE.Sprite(g)).name="pointlightctrl";break;case"SpotLight":null==x&&(x=new new THREE.SpriteMaterial({map:w,side:THREE.DoubleSide,transparent:!0})),(o=new THREE.Sprite(x)).name="spotlightctrl";var n=N();B[r].add(n)}a=P(B[r]);B[r].remove(B[r].children[a]),B[r].add(o),B[r].add(e),c.push(o)}else{B[r].remove(e);var a=P(B[r]),o=(_(B[r].children[a]),null);switch(i){case"DirectionalLight":null==d&&(d=new THREE.SpriteMaterial({map:null,side:THREE.DoubleSide,transparent:!0})),o=new THREE.Sprite(d);break;case"HemisphereLight":null==E&&(E=new THREE.SpriteMaterial({map:null,side:THREE.DoubleSide,transparent:!0})),o=new THREE.Sprite(E);break;case"PointLight":null==y&&(y=new THREE.SpriteMaterial({map:void 0,side:THREE.DoubleSide,transparent:!0})),o=new THREE.Sprite(y);break;case"SpotLight":null==l&&(l=new THREE.SpriteMaterial({map:void 0,side:THREE.DoubleSide,transparent:!0}));var o=new THREE.Sprite(l),s=O(B[r]);B[r].remove(B[r].children[s])}b.getCurrAttachObj()==B[r]&&b.detach();var a=P(B[r]);B[r].remove(B[r].children[a]),B[r].add(o)}},this.setLightEnabled=function(e,t){if(null==e)return!1;var r=L(e);if(e._enabled!=t){e._enabled=t;var i,n,a=e.type;switch(a){case"DirectionalLight":t?(e._iconVisible?p.add(B[r]):(p.add(e),p.add(e.target)),e._followCamera&&(i=new H(r),R.viewer.addFrameListener(i),e._followCameraListener=i)):(e._followCamera&&R.viewer.removeFrameListener(e._followCameraListener),e._iconVisible?p.remove(B[r]):(p.remove(e),p.remove(e.target)));break;case"PointLight":case"SpotLight":case"HemisphereLight":t?e._iconVisible?p.add(B[r]):(p.add(e),"SpotLight"==a&&p.add(e.target)):e._iconVisible?p.remove(B[r]):(p.remove(e),"SpotLight"==a&&p.remove(e.target))}t&&e._iconVisible?(n=P(B[r]),b.attachTo(B[r].children[n])):!t&&e._iconVisible&&null!=b&&b.getCurrAttachObj()==B[r]&&b.detach(),t&&R.setIconVisible(e,!0),u.render()}return!0},this.getLightParam=function(e){switch(e.type){case"PointLight":return this.getPointLightParam(e);case"DirectionalLight":return this.getDirLightParam(e);case"SpotLight":return this.getSpotLightParam(e);case"HemisphereLight":return this.getHemiLightParam(e);default:return null}},this.getPointLightParam=function(e){var t,r,i,n={};if(null!=e&&"PointLight"==e.type)return n.color=e.color.getHex(),n.intensity=e.intensity,n.distance=e._distance,t=new THREE.Vector3,r=new THREE.Quaternion,i=new THREE.Vector3,e.matrixWorld.decompose(t,r,i),n.position={},n.position.x=t.x,n.position.y=t.y,n.position.z=t.z,n.iconVisible=e._iconVisible,n},this.setPointLightParam=function(e,t){var r,i,n;return void 0!==t&&null!=e&&!!e._enabled&&"PointLight"==e.type&&(r=!1,i=L(e),e._visible&&(null!=t.color&&"null"!=t.color&&(n=parseInt(t.color),e.color=new THREE.Color(n),r=!0),null!=t.intensity&&"null"!=t.intensity&&(n=parseFloat(t.intensity),e.intensity=n,r=!0),null!=t.distance&&"null"!=t.distance&&(n=parseFloat(t.distance),e._distance=n,e.distance=n/100*S+.1,r=!0),null!=t.position)&&"null"!=t.position&&(n=null,n="[object String]"===Object.prototype.toString.call(t.position)?JSON.parse(t.position):t.position,(e._iconVisible?(B[i].position.set(n.x,n.y,n.z),B[i]):(e.position.set(n.x,n.y,n.z),e)).updateMatrixWorld(!0),r=!0),null!=t.visible&&"null"!=t.visible&&(i=null,"[object String]"===Object.prototype.toString.call(t.visible)?"true"==t.visible?i=!0:"false"==t.visible&&(i=!1):i=t.visible,this.setLightVisible(e,i),r=!0),null!=t.iconVisible&&"null"!=t.iconVisible&&(n=null,"[object String]"===Object.prototype.toString.call(t.iconVisible)?"true"==t.iconVisible?n=!0:"false"==t.iconVisible&&(n=!1):n=t.iconVisible,this.setIconVisible(e,n),r=!0),u.render(),r)},this.getDirLightParam=function(e){var t={};if(null!=e&&("DirectionalLight"==e.type||"None"==e.type))return t.color=e.color.getHex(),t.intensity=e.intensity,t.followCamera=e._followCamera,t.position={},t.position.x=e.position.x,t.position.y=e.position.y,t.position.z=e.position.z,t.target={},t.target.x=e.target.position.x,t.target.y=e.target.position.y,t.target.z=e.target.position.z,t.iconVisible=e._iconVisible,t.rotate=e.rotate,t.bias=e.bias,t},this.setDirLightParam=function(e,t){var r,i,n,a,o,s,l,d,c,h;return void 0!==t&&null!=e&&(r=L(e),!!e._enabled)&&"DirectionalLight"==e.type&&(i=!1,e._visible&&(null!=t.color&&"null"!=t.color&&(h=parseInt(t.color),e.color=new THREE.Color(h),i=!0),null!=t.intensity&&"null"!=t.intensity&&(h=parseFloat(t.intensity),e.intensity=h,i=!0),null!=t.followCamera&&"null"!=t.followCamera&&(h=null,"[object String]"===Object.prototype.toString.call(t.followCamera)?"true"==t.followCamera?h=!0:t.followCamera:h=t.followCamera,h?e._followCamera||(c=new H(r),e._followCameraListener=c,e.oldDir=e.target.getWorldPosition(),e.oldDir.sub(e.getWorldPosition()),e.oldDir.normalize(),R.viewer.addFrameListener(c),u.render()):e._followCamera&&(R.viewer.removeFrameListener(e._followCameraListener),c=new THREE.Vector3,void 0===e.oldDir&&(e.oldDir=e.target.getWorldPosition(),e.oldDir.sub(e.getWorldPosition()),e.oldDir.normalize()),c.addVectors(e.getWorldPosition(),e.oldDir),e.target.position.copy(c),e.target.updateMatrixWorld(!0),e._iconVisible)&&(c=b.getCurrAttachObj()==B[r],p.remove(B[r]),0<=(o=P(B[r]))&&_(B[r].children[o]),e.position.copy(B[r].position),j(r),c)&&0<=(o=P(B[r]))&&(c=B[r].children[o],b.attachTo(c)),e._followCamera=h,i=!0),null!=t.position&&"null"!=t.position&&(s=null,s="[object String]"===Object.prototype.toString.call(t.position)?JSON.parse(t.position):t.position,(e._iconVisible?(B[r].position.set(s.x,s.y,s.z),B[r]):(e.position.set(s.x,s.y,s.z),e)).updateMatrixWorld(!0),i=!0),null!=t.target&&"null"!=t.target&&t.position&&(l=null,l="[object String]"===Object.prototype.toString.call(t.target)?JSON.parse(t.target):t.target,e._iconVisible?(d=B[r].position,e.target.position.set(l.x-d.x,l.y-d.y,l.z-d.z)):e.target.position.set(l.x,l.y,l.z),e.target.updateMatrixWorld(!0),i=!0),null!=t.rotate&&"null"!=t.rotate&&((n=e.target.getWorldPosition()).sub(e.getWorldPosition()),n.normalize(),(a=new THREE.Vector3(-1,-1,0)).applyAxisAngle(new THREE.Vector3(0,1,0),t.rotate*Math.PI/180),a.normalize(),s=new THREE.Vector3,e._iconVisible?s.copy(B[r].position):s.copy(e.position),l=s.add(a),e._iconVisible?(d=B[r].position,e.target.position.set(l.x-d.x,l.y-d.y,l.z-d.z)):e.target.position.set(l.x,l.y,l.z),e.target.updateMatrixWorld(!0),e.rotate=t.rotate),null!=t.bias)&&"null"!=t.bias&&((n=e.target.getWorldPosition()).sub(e.getWorldPosition()),n.normalize(),a=new THREE.Vector3(n.x,0,n.z),o=(new THREE.Vector3).crossVectors(a,n),a.applyAxisAngle(o,t.bias*Math.PI/180),a.normalize(),s=new THREE.Vector3,e._iconVisible?s.copy(B[r].position):s.copy(e.position),l=s.add(a),e._iconVisible?(d=B[r].position,e.target.position.set(l.x-d.x,l.y-d.y,l.z-d.z)):e.target.position.set(l.x,l.y,l.z),e.target.updateMatrixWorld(!0),e.bias=t.bias),null!=t.visible&&"null"!=t.visible&&(c=null,"[object String]"===Object.prototype.toString.call(t.visible)?"true"==t.visible?c=!0:"false"==t.visible&&(c=!1):c=t.visible,this.setLightVisible(e,c),i=!0),null!=t.iconVisible&&"null"!=t.iconVisible&&(h=null,"[object String]"===Object.prototype.toString.call(t.iconVisible)?"true"==t.iconVisible?h=!0:"false"==t.iconVisible&&(h=!1):h=t.iconVisible,this.setIconVisible(e,h),i=!0),u.render(),i)},this.getSpotLightParam=function(e){var t,r,i,n={};if(null!=e&&"SpotLight"==e.type)return n.color=e.color.getHex(),n.intensity=e.intensity,n.distance=e._distance,n.angle=e.angle,n.penumbra=e.penumbra,t=new THREE.Vector3,r=new THREE.Quaternion,i=new THREE.Vector3,e.matrixWorld.decompose(t,r,i),n.position={},n.position.x=t.x,n.position.y=t.y,n.position.z=t.z,n.target={},e.target.matrixWorld.decompose(t,r,i),n.target.x=t.x,n.target.y=t.y,n.target.z=t.z,n.iconVisible=e._iconVisible,n},this.setSpotLightParam=function(e,t){var r,i,n;return void 0!==t&&null!=e&&!!e._enabled&&"SpotLight"==e.type&&(i=L(e),r=!1,e._visible&&(null!=t.color&&"null"!=t.color&&(n=parseInt(t.color),e.color=new THREE.Color(n),r=!0),null!=t.intensity&&"null"!=t.intensity&&(n=parseFloat(t.intensity),e.intensity=n,r=!0),null!=t.distance&&"null"!=t.distance&&(n=parseFloat(t.distance),e._distance=n,e.distance=n/100*S+.1,r=!0),null!=t.angle&&"null"!=t.angle&&(n=parseFloat(t.angle),e.angle=n,r=!0),null!=t.penumbra&&"null"!=t.penumbra&&(n=parseFloat(t.penumbra),e.penumbra=n,r=!0),null!=t.position&&"null"!=t.position&&(n=null,n="[object String]"===Object.prototype.toString.call(t.position)?JSON.parse(t.position):t.position,(e._iconVisible?(B[i].position.set(n.x,n.y,n.z),B[i]):(e.position.set(n.x,n.y,n.z),e)).updateMatrixWorld(!0),r=!0),null!=t.target)&&"null"!=t.target&&t.position&&(n=null,n="[object String]"===Object.prototype.toString.call(t.target)?JSON.parse(t.target):t.target,e._iconVisible?(i=B[i].position,e.target.position.set(n.x-i.x,n.y-i.y,n.z-i.z)):e.target.position.set(n.x,n.y,n.z),e.target.updateMatrixWorld(!0),r=!0),null!=t.visible&&"null"!=t.visible&&(i=null,"[object String]"===Object.prototype.toString.call(t.visible)?"true"==t.visible?i=!0:"false"==t.visible&&(i=!1):i=t.visible,this.setLightVisible(e,i),r=!0),null!=t.iconVisible&&"null"!=t.iconVisible&&(n=null,"[object String]"===Object.prototype.toString.call(t.iconVisible)?"true"==t.iconVisible?n=!0:"false"==t.iconVisible&&(n=!1):n=t.iconVisible,this.setIconVisible(e,n),r=!0),u.render(),r)},this.getHemiLightParam=function(e){var t,r,i,n={};if(null!=e&&"HemisphereLight"==e.type)return n.skyColor=e.color.getHex(),n.groundColor=e.groundColor.getHex(),n.intensity=e.intensity,t=new THREE.Vector3,r=new THREE.Quaternion,i=new THREE.Vector3,e.matrixWorld.decompose(t,r,i),n.position={},n.position.x=t.x,n.position.y=t.y,n.position.z=t.z,n.iconVisible=e._iconVisible,n},this.setHemiLightParam=function(e,t){var r,i,n;return void 0!==t&&null!=e&&!!e._enabled&&"HemisphereLight"==e.type&&(r=!1,i=L(e),e._visible&&(null!=t.skyColor&&"null"!=t.skyColor&&(n=parseInt(t.skyColor),e.color=new THREE.Color(n),r=!0),null!=t.groundColor&&"null"!=t.groundColor&&(n=parseInt(t.groundColor),e.groundColor=new THREE.Color(n),r=!0),null!=t.intensity&&"null"!=t.intensity&&(n=parseFloat(t.intensity),e.intensity=n,r=!0),null!=t.position)&&"null"!=t.position&&(n=null,n="[object String]"===Object.prototype.toString.call(t.position)?JSON.parse(t.position):t.position,(e._iconVisible?(B[i].position.set(n.x,n.y,n.z),B[i]):(e.position.set(n.x,n.y,n.z),e)).updateMatrixWorld(!0),r=!0),null!=t.visible&&"null"!=t.visible&&(i=null,"[object String]"===Object.prototype.toString.call(t.visible)?"true"==t.visible?i=!0:"false"==t.visible&&(i=!1):i=t.visible,this.setLightVisible(e,i),r=!0),null!=t.iconVisible&&"null"!=t.iconVisible&&(n=null,"[object String]"===Object.prototype.toString.call(t.iconVisible)?"true"==t.iconVisible?n=!0:"false"==t.iconVisible&&(n=!1):n=t.iconVisible,this.setIconVisible(e,n),r=!0),u.render(),r)},this.setLightParam=function(e,t){if(null==e||null==t)return!1;switch(e.type){case"DirectionalLight":return setDirLightParam(e,t);case"SpotLight":return setSpotLightParam(e,t);case"PointLight":return setPointLightParam(e,t);case"HemisphereLight":return setHemiLightParam(e,t)}},this.isLightEditControlSelected=function(){return!(null==b||!b.isActive())&&b.isSelected()}}function Ue(e){THREE.EventDispatcher.call(this);var t=this,r=null;this.viewer=e,this.render=function(){t.dispatchEvent({type:"render"})},this.update=function(){null!=r&&r.update()},this.onOpRender=function(){t.render()},this.onOpEvent=function(e){t.dispatchEvent({type:"event",event:e})},this.setOperator=function(e){t.releaseOperator(),e.create(),e.addEventListener("render",t.onOpRender),e.addEventListener("mouseEvent",t.onOpEvent),e.addEventListener("event",t.onOpEvent),r=e},this.getOperator=function(){return r},this.releaseOperator=function(){var e=r;null!=e&&(e.release(),e.removeEventListener("render",t.onOpRender),e.removeEventListener("mouseEvent",t.onOpEvent),e.removeEventListener("event",t.onOpEvent))}}function Ne(e,t,O){function F(){f.style.opacity="1.0",B=!1,requestAnimationFrame(y.render)}function U(e){var t;B||y.viewCubeMenuOpen||(t=Math.max(4*Math.abs((e.clientX-u.x)/u.w-.5)-1,0),e=Math.max(4*Math.abs((e.clientY-u.y)/u.h-.5)-1,0),t=Math.max(0,Math.min(Math.sqrt(t*t+e*e),1)),f.style.opacity=1-t*(1-y.inactiveOpacity))}function N(){f.style.opacity=y.inactiveOpacity,B=!0,y.render()}var V,n,G,r,c,k,j,a,z,h,o,s,l,u,y=this,p=(this.viewer=e).cameraControl,W=(O||e).camera,f=(O||e).viewBoxDiv,i=(this.viewCubeMenuOpen=!1,{}),X=(this.boxSize=void 0===t?235:t,y.currentFace="front",["top,front","top,right","top,left","top,back","bottom,front","bottom,right","bottom,left","bottom,back","left,front","front,right","right,back","back,left"]),q=["front,top,right","back,top,right","front,top,left","back,top,left","front,bottom,right","back,bottom,right","front,bottom,left","back,bottom,left"],A=null,d=(f.getBoundingClientRect(),y.camera=new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,1,2e3),this.originCamInfo={},[]),m=[],g=[],v=[],M=[],E=null,Y=null,w=null,x=0,Q=0,K=!0,Z=!1,J=!1,$=!1,b=!1,B=!1,I=[],ee=(this.width=0,this.height=0,this.animSpeed=500,this.animate=!0,this.compass=!1,this.viewScaleFactorCompass=1.5,this.viewScale=1,this.draggable=!1,this.wantHomeButton=!1,this.wantRollArrows=!0,this.wantContextMenu=!1,this.inactiveOpacity=.5,this.getPicSrc=function(e){e=e.split("/"),e=e[e.length-1];return"VCarrows.png"==e?"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAADDPmHLAAAACXBIWXMAAArwAAAK8AFCrDSYAAAAIGNIUk0AAHxpAAB8jwAA/qkAAICUAAB5PAAA8TsAADeRAAAmhApr+WQAAAa2SURBVHja7J1PaJNnHMd/T5Jp98bM+i7TGrBZtzTtDoMGqlawUvQileKEIXqwOYkXRTxZFKQMlN6c6EXKDomHjl6cBMt2UMQeLBhIwUubZWtSR4wue42LeVddkmeHJKNIq++bv++f7wdCIeR9S9/vp7/f8z7v+z5hnHMC5sWCQwABAAQAEABAAAABAAQAEACYBpve/wDGGBHRV4yxY7zEOGI1eAUoh16h12KxHIvH492I0wQCMMaoMn3NGOu1WCzH4/F4d7FYRJpGF2C98HE9wwQCIHwTC4DwG3hstX4QVYRfdLvdsXV2Ey//zJRfKSLKcM5TEEDDAqj8zy+uV9GSyeQzIqJYLPY6k8kUwuFw/tGjR5ZoNGory5Eq/4xzzlcggD7LfrGalpZMJp+Fw+FX4XA4HwqFrJIk/UlEC0S0YIYKoYcWoLTnVyXAWkLcu3fvZTAYpGg0+rosw7xRZdB6C1Az4KuLAKuRJCl99+7dF2UZ0kQ0V64MKxBAW+E3RIDVxGKxp8Fg8FUgECiWRZgzggiaFcBqtX6XSCQ8Kmb4GipAhVwul52cnFwOBAIWSZIeE9EDPYuAClAl+Xz+zczMzNKZM2fe6rkiaPosgEoXelo2BlBTEa5evVogop855/MQoDUStESA1QPGS5cupUKhULIsQgoCNFeClgpQ4eHDh7+ePXs2L0nSLOf8AQSoIfhVE0FKJNCEAJW2cP78+UQoFJKI6EfOeQYCNF6CNa8FCIJQ6OnpKTgcDu7z+T7q6+sTOjs7BY/H42xGNThx4sQ/nPMJCNBgCYrFInV1dUWJaPydXbS/8+ogog5BEBz9/f35/fv3tw0ODm5plBButzuq5dvUmB4uqSqR4D0CrEcbEX1efvU6nU778PAw8/v9W+slw9jY2NdTU1Pfcs4XIUCDJahCAFqjUvQSUZ/T6fz09OnTG44ePdppt9s3GjV8XQnwIQkKhUKtAqymg4gGiKj38OHD1osXL+7Ytm3bJ0YLX3cCvE+CpaWlbrfbXS8BVreJASIaUCqCnsLXpQDrScAYO85LbzZiwPW/CKOjo7axsbEv12oNegtf8/MAGqSNiIYEQdh55cqVjUeOHPlCz+FDgNrGCN/4fD7x5s2bnbt27UoR0ZTewocAtTMkCMKgLMvTegxft2MAUD/wdDAEABpqez2MsXHGWB8EMGH4RHQ8EomIRHSQMdYOAUwWfiKR8Iqi6Lx169bHRHQMApgs/Mp7+/bt6x4ZGREZY0M4CzBZ+BVyuVx27969f0iSNNnI28tQATQYPhGR3W53XLt2zUZEB9ECTBb+O63A1cizArQAjYZfQZKktM/nSxLR94147gAVoMns3r37B6XhExGJoug8d+6clUpXI9EC9M6TJ09+ef78+d9qtjl58mQnEQ0wxtoggM6RZXn21KlTy2q2sdvtjuvXr28goiEIoH8eRCIR6fbt27+r2Wh4eLhLFMWd9a4CEKA1/HThwoU3uVzujdINbDbbRr/fX6z3WAACtIaULMuPJyYmfmv1WAACtLAVBIPBvJoBod1ud/j9fguVbl+HADpnhYjmLl++/FTNRqOjo5vr2QYgQGuZu3PnTkFNFfB4PDu8Xq+TMdYBAcxbBYiI+iCAgaqAmjOCQ4cOba3XOAACaKMKLExPTyueHBJF0en1ejfVow1AAI1UgRs3brytog30QgCDzAuk0+m/YrFYWukGBw4c2AIBjMV8IBB4ofTDLpdruyiKn9U6KQQBtMPCzMyMqpszRkZGClRa4AICGIBMOp3OqWkD/f39NghgsCowOzv7UoUAm6n0oCoEMAjx+/fvK77ty+VybUcFMJgA4XBY1Zd5er3efC3zARBAW6zIspxVMw7Ys2dPkUoLXEEAo8wJLC8vyyoHgqgARhJgfn5esQDt7e1WVACDnQ5GIpF/lX7Y4/FsggAGEyCbzTZtfRwbjrf2BFhcXLSqPBXMogIYSABZlq3N+mUQwORAAJODMUCLeN9T2c1cIxECtBDG2Hij9/WhL6uAAC1GzaPiavdRXj0dYwANM6UkpGoo73cKAmh7HLDYCAkq4StZvxgCGEwCNeFDAINJoDZ8CGAgCaoJHwIYRIJqw4cABpCglvAhgM4lqDV8CKBjCeoRPgTQqQT1Ch8C6FCCeoZPhLWCm07lSp/a415ZY5jq/PV0EMDkoAVAAAABAAQAEABAAAABAAQAEABAAAABAAQAEABAAAABAAQAEABAAAABAAQAEABAAAABAAQAEABAAAABAAQAEABAAAABAAQAEABAAAABAAQA2uS/AQBz1tjC7H2raAAAAABJRU5ErkJggg==":"VCarrowsS0.png"==e?"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAADDPmHLAAAACXBIWXMAAArwAAAK8AFCrDSYAAAAIGNIUk0AAHxpAAB8jwAA/qkAAICUAAB5PAAA8TsAADeRAAAmhApr+WQAAAcVSURBVHja7J1dTFNnGMf/L1SEFASPsPChwwVW2BIjRjclI5WEZDEKysUuWGbEjBBvMZsX04sREyIJWYLRiyWuiR/JNNwA05gtWYzItmiGtojLwDH5cE5kla9CKRV6dmG7oKvY057COaf/X9KE0PbQ9P/jeZ73bU8rZFkGiV3i+BRQAEIBCAUgFIBQAEIBCAUgMYNJzw8+oaYDAASAfQJolQF4bTsFYzVwBfCHHkAA2CsEWi8f2co0jS5AQk0HvLadgZ8D4bddObIVPmZpbAGWCp8vZxhcAIYfwwIw/BheBYQTfkLNjWDXBCbHQf/FAWDQa7M6Yl0AodX3A4QRvk8G4oKtAadm57sBYMg5OzHpnpcdQ66k7iFXzuOJufV+ORwArgO47rVZJyiAtkQItez7wmlpU7Pz3XeHXeOOIVfST33jhdOehUEAbQDaYqFCaFoAhT0/LAGCCXGjd3yivWs07/HE3IJfhrNGlUHLLUDpwKeKAIvxPPPd//He08d+GZ4CaPZXhgkKEH0B9imc9lUXYDGjU95bLTdH8H23s9AvQrMRRNCsAIk1HbLCHb6oChBg3ic/uvTLyMAV++imac/CWQD1ehaBFSBMZBlTP98fv9P43cAWPVcELW8EfSfLqCxvug2hwdf3hMCakoK1pW2fbZmuKs4qAzCYUHPjICuAzlcBkQyMTVcG3Lf6JycB1Oll1RDz+wBq0/PQ1dHQ9qBo2rPQ7LVZ6ylA+MEr3gnUSkub98mPTrQ/+OdW/6QAUOm1WQcpQJQl8AHY23Q7WK+eSkk0DSSuivNYssyzRblrkjZmJKUVZpsLlqMafHHpjyKvzZpGAaIswSIBXh4ZcwFsXHQpAlAkBKSMlITf389L9ZS+uy4zWkKUN92B12YVFCDKEiwhwKtIBVDqv1Sa4sSqd3KS+6utOarJUN50BwD2em3WyxQgyhKEIQCCVIpKAAdNcSJj1+b0/v0lOUXJifGpRg1fVwK8ToIFOWIBFrMZQB2Ayo0ZSfeOVeZtzEpbvd5o4etOgKUkuPz5VpSrJ8DiNlEHoC5UEfQUvi4FeIUE/50XoLIA/xNh04aU7mOVeUFbg97C1/w+gAZJBVAvBD795IPsu1XFWSV6Dp8CRDYjnF2TZBJf7S9cV3vmt/V6DJ8CRM6XgKjXa/gUQEU2bUjBiSpL0Os+LEzW7OPm2cEq0fPQhY+a7Zj2LOjqcVMAFfE88+Hg13fR+/dMeOVYiAIhRL0QoogC6FiCI9/2KpZACFEA4GO73S4B2CWESKMAOkWWoUiCQPhDQ0MWSZLSL1y4kASgigLEgASLww/8zmq1vl1RUSEJIUq5CtA5QgBz3+wMOfwAMzMzrpKSkr/GxsbOyLI8wgqg40qgNHwAMJvNKSdPnjQB2MUWYDBeF/5LrSA7mqsCChBlAi9aKQ0/wPHjxzP9q4JECmAAtm/fbgs1fACQJCn98OHD8QB2UACd//cDQE9Pzw9PnjyZUnKc2traNwHsiEYVoADLjNvt7jx06NCwkvuYzeaUU6dOJeD5+xcpgF7/+/1ct9vtY62trQ+UHG/37t1vSZL0ntpVgAKsDG1Hjx6dm5mZmQv1DiaTaXV1dbVP7VmAAqwMI263+9fGxsY/V3oWoADLW/5faAXnz5+fVzIQms3mlOrq6jgAhRRA/3gA3GxoaHio5E4HDhxIVbMNUICV5WZ7e/uCkiqQn5+/wWKxpAshMimAfst/pFUAeH6OIwUwShVQsiLYs2fPG2rNARRAG7NAb0tLS8ibQ5IkpVsslmQ12gAFWLny/0IVOH36tDeMNlBIAQyyL+B0Op/29/c7Q71DWVnZWgpgLBznzp0bDfXG2dnZWZIkZUS6KUQBtEPv1atXFb0/r6KiYgHPP/WEAhiACafTOaOkDWzbts1EAfQ/AL5QBTo7O8cVCJAKIJMCGIfBa9eueZTMAawABhOgq6tL0df4WCyW+Uj2AyiAtvC43W6XkjmguLjYByCNAhhoT2B4eNitcBBkBTCSAA6HI2QB0tLS4lkBDLYctNvtz0K9cX5+fjIFMJgALpdr2T5a1sTnW3sC9PX1xStcCrpYAQwkgNvtjl+uP0YBYhwKoBJ6/TwDzgArxFIfzCGW8VuyKMAKIoSoj/axZFmupwAaRsmp4kqPkZube58zgLa5GEpI4eA/7kUKoO05oC8aEgTC9x+fAmh5JaC2BErCpwAGqwRKw6cABpIgnPApgEbaQKQShBs+BTBAJYgkfAqgcwkiDZ8CaLANhCqBGuFTAJ1WArXCpwAarwLBJFAzfAqgz0qgWviATr85lKgHKwAFIBSAUABCAQgFIBSAUABCAQgFIBSAUABCAQgFIBSAUABCAQgFIBSAUABCAQgFIBSAUABCAQgFIBSAUABCAQgFIBSAUABCAQgFIBSAUACiTf4dAFchuSsaUf6VAAAAAElFTkSuQmCC":"VCarrowsS1.png"==e?"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAADDPmHLAAAACXBIWXMAAArwAAAK8AFCrDSYAAAAIGNIUk0AAHxpAAB8jwAA/qkAAICUAAB5PAAA8TsAADeRAAAmhApr+WQAAAarSURBVHja7N1daFNnHMfx/zlJ03hqajpDbREb4/omqE1cp91LtcguhjhbYZQKUwu5VRSGGChIN9ANBrM3uxBxLMVRGbsoi4o3Qs0clS1jccLWZSlNpk3LqllqW1trcp5dNBlFGpeTl+a8/L5QCtKkmP/H53nO6YscY4yQduPxEgAAAgAEAAgAEAAgAEAAgDSTXul/AY7jiIi2chzXxZbqxVhVvgIkh56qkef5rlAoVIdxagAAx3GUun3NcVwjz/OHQ6FQnSiKmKbaAaQbPr6eoQEAGL6GAWD4BXxt5f4iShi+aLVag2meJpR8H0u+TRJRjDE2CQAyBiDxX76YbkWLRCITRETBYHA2FoslfD5ffHh4mA8EAvokjsnk+xBjbAEAlLnsi9lsaZFIZMLn8037fL64x+PRRaPRKSIaIaIRLawQStgCMt3zswKwEohbt27909/fT4FAYDaJwa9WDHLfAqQc+PICYHnRaPTR9evX/05ieEREd5MrwwIAyGv4BQGwvGAw+KC/v3/a7XaLSQh31QBBtgB0Ot3H4XC4VsIdvoICSDU3Nzdz6dKlv9xuNx+NRn8ioiElQ8AKkGXxePzZjRs3xk6cOLGo5BVB1lcBtPSFnqKdAaSsCBcuXEgQ0U3GmB8AioOgKACWHxjPnj076fF4IkkIkwCwugiKCiCV1+v98+TJk/FoNPo9Y2wIAHIY/LIbQZkgkAWA1LZw5syZsMfjiRLRVcZYDAAKj2DFrwUIgpBoaGhImEwm5nA4Sux2u1BTUyPU1tZaVmM1OHLkyDxj7FMAKDACURTJZrMFiKj3hacwv/BWRURVgiCYmpub4/v27TO2trZWFAqE1WoNyPnb1DglfEk1EwQvAZAuIxFtTr41WiyWsv3793PHjh2rzBcGl8u1fWBg4H3G2B8AUGAEWQCgFVaKRiKyWyyW9cePHzd0dnbWlJWVlap1+IoC8H8IEolErgCWV0VELUTU2N7eruvp6dm0YcOGcrUNX3EAXoZgbGyszmq15gvA8m2ihYhaMoWgpOErEkA6BBzHHWZLf1iIA9d/EI4ePap3uVyvrrQ1KG34sr8PIMOMRNQmCMLr58+fLz106NAWJQ8fAHI7I3Q4HI5XLl68WLNr165JIhpQ2vABIPfaBEFoffr06TdKHL5izwAof+GngwEAySWD0/uewellBqe3GwA0OHwi+u7bU/YAEfUZnN7NAKCx4V87vZOMJXz9J111fiIaBACNDT/V9k2mvbtr1zGD09uLqwCNDT9VXGTjH3zx69rZhUTb4uU9fqwAGho+EZGe5zb2dGzxE1EftgCNDf+FrWBdIa8KAECmw091+oBNSF4VmAFAHWU8fCIiYwlf3/VG9X0iOgUAKojj2JOJ2LOHUh7T9WaVjYhOFWIVAIBVjjH6/MMrI4+lPEbPcxtdB22/UAG+1wEAVr+PnszH2dXhiTtSHvRWfcXOtUZdd75XAQAoTt1f/xDZMbuQmM5866DyA47KvJ8FAKA43WOMvjw3OOov9lkAAIpX7/0HM01SDoR6ntv4bpNlhIg6AED5TRNR37nB0ZCUB3W2VFE+twEAKG59oan5bVJWgcpyw+5qc+l6g9NrBwCNrgLtzZWjRNQNACpaBaRcEbyzbX11vs4BACCPVWDwyp3xjK8IjCV8fbW5VJePbQAAZLIK3Lz3qDaLbaADAFRyXyAusqmRyFzGP1uwp7HCDADq6iu3dzzjXyxVvkbftNao25zrTSEAkE+Dv4/PStoG3m6oGCGiNgBQR+G4yJ5L2QbsVtM8AKhsFRj67XHG28COGlMFEdkBQD0N/Tg6bZRyDiCivQCgIgBTM4tbpTyg2lz6MJf7AQAgr6YZo6iUc0CT1TROS7/pDABUkj80NR+TeBDECqAmAP7wk/lMP3idoOewAqirUGBibk2mH2y1rDEDgMoALDwXjav1yfR4veUHYGYhbpN4KYjLQBUVZozKV+uTAYDGAwCNhzNAkVq8nP4OrsF5GwC0kMF5O0+/noWlfa7Fy3s5AJBx106/VrDnOPDZzzgDyLyDmQwpm5LPexAA5H0O8BQCQWr4yecHAC0hkDJ8AFAZAqnDBwAVIchm+ACgEgTZDh8AVIAgl+EDgMIR5Dp8AFAwgnwMHwAUiiBfwwcABSLI5/ABQJkI8jZ8Ivx/AZoPKwAAIABAAIAAAAEAAgAEAAgAEAAgAEAAgAAAAQACAAQACAAQACAAQACAAAABAAIABAAIABAAIABAAIAAAAEAAgAEAAgAEAAgAEAAgOTZvwMATRi8gArAJm8AAAAASUVORK5CYII=":"VCcontext.png"==e?"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAACXBIWXMAAAsSAAALEgHS3X78AAAAIGNIUk0AAH7FAACLdgAA9UcAAIsOAABxUAAA6BUAADlYAAAfBMec4XAAAAEBSURBVHja7JcxCsIwFIb/V3oFx04v4iB4A3ev4Ak9iOABOhQcageHDh7iuVSwpW1eYmIFEwiFQvN9SZP/ERIRLNkyLNySQBLIhy+I6AhgE5F5FZHTpACAbV3X61h0Zs5nVwBAJiL0rd+eNuHvnQIArTEmplhrE7gAWEUUePSO/Vg1jJgFvQyYWoFoWTDMgLlNWDFzIyIUqjNzA6DSCpwBlMaYW4iZd+OU3bh2ARG5h5J4h3fj6nIghIQNbg2iTyQ0cFUS+kho4eoodpFwgTvVAo2EK9y5GM1J+MC9quGYhC98shaoPiQqAOwB7Hzhrxn1umMrABy6pxeT0t3w7wWeAwD5qe4YizvzugAAAABJRU5ErkJggg==":"VCcontextS.png"==e?"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAACXBIWXMAAAsSAAALEgHS3X78AAAAIGNIUk0AAH7FAACLdgAA9UcAAIsOAABxUAAA6BUAADlYAAAfBMec4XAAAAEVSURBVHja7JcxDoJAEEX/rvY2HMEb6AEsaTDxBngKIzfgDBR6AxJtiI0egN7Ght6GWBIYGzVKQHaQDYU7yYSwxb5HMvs3CCJCnyXRcxkBIzAsLwyWpx0ARyNzn29m81oBAE60mmqj237smBkwAl9PAfIssv3Y1kbMs+j9VZQvIyHEGMBI40enRHSpFdCcBR8ZUJcD2rKgnAH1Q5gmnu3HXcOBNPGUBIrQDbqUeMKL0A2UBIjo2pXEO5yIrso50IVEE7wxiH6RUIErJWEbCVW4chRzJDhw1l2gIsGFPzdmNQBLLrZr6R7pcL69WrpHkovtGoDF2o8rUCXRFt5aoCzRFl4pwCwLwOTxBGOeXi3Mv+HfC9wHAAIQ03ZDDGqmAAAAAElFTkSuQmCC":"VCedge1.png"==e?"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAAXNSR0IArs4c6QAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB90BEBUkDgOwdkQAAADtSURBVHja7ZsxDoQgEEU/FCbsAWmoOJmVjfdz3VjIFmpizOoB9r/XGBMk8GEmwzCGXGqT9NHGKilIavtT5/dx6JN+kEud9za6fHslSGrj0L9u+pkkBcUu6Y51mY/+H8Yz7W3O42insR1zSsqlvmVKLvUdH1bLgRBPW9eRhgCYAAJ4gwA4QXMBBAAAzuzJDNu5EwkSCT7l3/5++buECSAAAiAAAngLsF01ebIuMxkhAABwhgoRboe5G+QwhAAIgADWAlAm5x4H2JuA9Q7gMAQAYA01QoTChMKkxDgO4wPwAdY7wNkPRHsnGNx/n/8CGU1kteidCpYAAAAASUVORK5CYII=":"VChome.png"==e?"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAACXBIWXMAAAsSAAALEgHS3X78AAAAIGNIUk0AAH8nAAB4zgABAecAAH1lAAB+pAAA60MAADfoAAAl6h9/B7IAAAFxSURBVHja7JfNTcNAEEbfjK0IhOgBKSZpAKWLdEABlEQB3DnQBaKBRI6UDjig8BNld7lMJCeQZNfxwiUj+eCf2fe8sr+1JYTAf1bZpklEBLgBxnboCXgJLe6mbAkfAePZbHYN0O/3FVAReU6VkJTrm/C6rgfeewFQ1VBV1dRmIkkiWmAb7pzT5vmiKHwbCe0CDuCc07quB/ZcjKzneIEY+DES2hW8rYR2CW8joV3DUyU0BzxFQnPBYyU0JzxGQnPDD0mIbVnh+xJTgeKv4L/MRFGawLyqqt56RiaTyVUO+HA4nAPBtvlaIACPwIUtz3cJA228RBHiHrgHVsACCKXtvAHvwJldRMRA2xUi+16BT8ABqzKE4IFl422IrR8zENn3FUL4MB7ZH7pOvgdOAieBk0DO2vgvEJFz4BYYRITQb0F0KIymwEMziLYbesClrQt6AL5LQPbE8MJif7krPtUWpCIhWlOi29na41v9G+ao7wEA29D8X0f9dpYAAAAASUVORK5CYII=":"VChomeS.png"==e?"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAACXBIWXMAAAsSAAALEgHS3X78AAAAIGNIUk0AAH8nAAB4zgABAecAAH1lAAB+pAAA60MAADfoAAAl6h9/B7IAAAF8SURBVHja7JdNTsJAFIC/eW1QYzyFV+ACLgS27q1hJ3gCjsAJUHdGDuCWIgkX4ABsPIOLxh9+2uemNQURaGnLhpfMos30fd+bSV87RlXZZ9hpHjLGGLl5vUXsewCCeTN4vnzUNNWoaqIBGHHcptSHOhh7Ohh7KvWhiuM2AZM0nySu3HEbWKVOv1X+vd9vlcEqdcRxG8YYkySn7ArfVUKygO8iIVnB00pIlvA0EpI1PKmE5AFPIiF5wbeVkDzh20hI3vBNElIEfJ2ECXt77vB4VNoj8Kd3Qbf6IIBVJDy+EoBlAxb+rFdpj2oLE/KqPAp/1osENOhWroFTwJb68C1RouXKNkTwdHEOzIEPQO3wwgM+geMCduAd+AZ8YG6ragBMo7ehAIGJqn6FvGQ/JHnEQeAgcBDYu4CJn6aMMSfi9F6wjqq50PyJG3RrV/FGtNz5SsBZ+F34b3U0NhaKiY2Vn4Gw/3tR52XFZAkPrNaaRGlDo/4fyvzdgn3EzwAYdgRqNummZQAAAABJRU5ErkJggg==":"back.png"==e?"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAADDPmHLAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAVISURBVHhe7dx/aFVlHMfx73GXud9brIyVc63EICiFQMJoCRFSGLT+yBn0A2L9EBwOXVkt0zb3j6NJYdAigoqFEGo1NKhIsqh/Eu2PsCjbWM0gw91t3K5390fPOc+j1+nUhc/V55zP5wXn+D3PFTfv3rv3nrt75+UUIVhzzJ8EigGAYwDgGAA4BgCOAYBjAOAYADgGAI4BgGMA4BgAOAYAjgGAYwDgGAA4BgCOAYBjAOAYADgGAI4BgGMA4BgAOAYAjgGAYwDgGAA4BgCOAYBjAOAYADgGAI4BgGMA4BgAOAYALhIBfHU0JW1tbZI4NGhWaLYi8WvivMZHRIY+NEd5W566V3Lzl0suk5JkKiMty+pkyco15lLyhT6AzsG4bH2gxhz9f1erraO3TxITY3rBiE8mpK93nZqu0wsRFeoAsmor8q5S++lfvMtliapnVUevJBMTZkUkrT6pxlhcntzUZ1bcFuoABo9MyndvPy/Hq2+S/lfWm9Ur7za1HQ7J1RrpXxXbM3BAkj/tlaLYXDn1n6ypLJP2DdvUdFwvFMCymMi3UwwglDa090hFdVJN554gVZWXyvrOfpHUUbMyMwYAyLv5MZFf3g/mMAXAJ4JsOTlphnBhAOAYADgGAI4B2DK3wgzhEsqzAM9bqPa/6QMH8Syg0GLXmoEuVTgDSIfzlMtFobwLaH/1HalO/67yVbe1DgieXu56VyR+JDjmM4GAvIUt6mHJzmDmYwBEUyfNEC4MwJbqSjOECwOwpLgqH4AXomuVAViSPeOh1HjK3/uvV3IfA7Akk8l/wePBPv8yMZcxAEsa6683k4g+OXXjFPViInEauH3nfvnn8GdSVFxiVgonlRFZXDsmq9ZtNyvaggdflpGPu4O5SG3p3M9qvyg4dpofQNjVrtjoR3zZthW1515td64ZmPZ3ctmD5hK3ReIuoKKs8N/5Zyqb4Qd/5Wcv/vWHGdzGxwCWlJaUm0nLHhsyk9siF4B/W5DLTfi30VY3KblHf4DzWHTHLWbS/uYtwJWRDvbHgr1V6X/NMLP6unlm0r7/4gczuY13AZYsmDf9qhwdP2EmtzEAS5bO9/f++xS13R8dNJPbGIAldf6u5vZg9n0ePB34azC7jAFYVN+03Exa8sAuM7mLAVj0cGurmbS+1143k7sYgEXPrJx+JrBjz59qP6UPHMUALPJfrC5Lnw5mn//lH/5grT5wFAOw7MWNXWbSnnj8LTMV4LkJCyIXgP4hbPCY3K5YqRkubGvzNWp/oz5Q9mdFxj55SU0F+JwsiFwA/q928LxKtXlWN0l+qT/ALKx+c4+ZtLube8zkHt4FFMDAs7eqff5W4Ed1K/B17/3myC0MoEBadpx1K9CxT+TEp+bIHZF4RdAND22R4d2bg9kvelv3WhlPq/viXCZYuxTqxl9iVeXS2fGGSHYkWGtuENk1dPGrzfPuUvtv9IEyurdb6u7zHw84xA8g7BqaN59+JU5x8F8a1RdYJMVNpz+GCsCsXtjASPDNFWyH+h81q26JxF3AZMJ/6KcFr8guxC+OTOX/zcQs35u62v8BUVOXPKceEixufU8vOiZSLwr1ikskFp+UTX0vqNVafaElp96QmsrFZnxR6PkMT4k0zBkWKVL3Gw7im0PB8SwAHAMAxwDAMQBwDAAcAwDHAMAxAHAMABwDAMcAwDEAcAwAHAMAxwDAMQBwDAAcAwDHAMAxAHAMABwDAMcAwDEAcAwAHAMAxwDAMQBwDAAcAwDHAMAxAHAMABwDAMcAwDEAcAwAHAMAxwDAMQBwDAAcAwDHAKCJ/AegxeeFlLjG0gAAAABJRU5ErkJggg==":"down.png"==e?"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAADDPmHLAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAOiSURBVHhe7d1PSBRhGMfxZ7IS80/aBhpBh7Q8BIEGYUHaIVAr6SaL1k3z2nWLbhXe6mjZKdBYOmq1HoL0kIfQbhGbHmMTNjW1pUSc3pl5it3NSpaCfef3+8C+887jRfE7ji6rOq4hBGuHHgkUAwDHAMAxAHAMABwDAMcAwDEAcAwAHAMAxwDAMQBwDAAcAwDHAMAxAHAMABwDAMcAwDEAcAwAHAMAxwDAMQBwDAAcAwDHAMAxAHAMABwDAMcAwDEAcAwAHAMAxwDAMQBwDAAcAwDHAMAxAHAMABwDAMcAwDEAcAwAHAMAxwDAWRmA0xAVx3GserSWOvreFxcrA9hZu0939th/QDdFhrcAcFYGsLGwqDt7pFO6KTL8n0F5HKfRrMngxHBXEyIV7XoWPrwFZFnx12/++lMqrZtwYgDgGAA4BgCOAfw3q3osbgwAHHwA47NL5ke/MpEXt2SXzv6NSj0WN9gAkpvmU3S0U7pOeE8rf5WqczfFZGCU+isKyAA6+0elscSRtfcJnQR37N5Lh8y62z9HARXA6GTSfLmvlMTDXp3kWt+sMOvH4AQERADL5lHe0CG9Z72nedf8WbY681iZGZMnY2/Nbq8/QxH6AKKD41LjOJKZn9BJrpG+Dkm5rlQ2X9Sngjf8FUVoA5iac82X+zqJx7p0kuuUuezdxRnpGX6uE0yhDOB0dFDajngf2kIwyPNypE9epVyRmmad4ApVAM/eLJurvlym4zGd5Gqv3yOuuyRtPcM6odAE0NBxQy4015hdJhjkmX16XRJzX8yuOhiQz/oAxl+n/Kt+fuKOTnL9uOqbzt/WCWWzOgDvB7quk8fMuvVVPznUzav+L6wOwHvaZsr99fWBh8vMd/junLQOxHVCv2P9LeCMeVx5MBucGEPdLTKf8V7mWB8M6I9C8U3go/4miTRGJT19Xwbi0zql7QhFAJ70u8cSabmqZ7RdoQmACsMAwDEAcAwAHAMAxwDAMQBwDKBAW7/SwD4MoEAf9Gg7BlCgg3q0HQMoUK0ebccAwDEAcAwgy6a/5v3iyMa6bsKJfyQqi/fXgWLX7klV9SezK5HPaxm5G7ssEjnuvz2MGAA43gLAMQBwDAAcAwDHAMAxAHAMABwDAMcAwDEAcAwAHAMAxwDAMQBwDAAcAwDHAMAxAHAMABwDAMcAwDEAcAwAHAMAxwDAMQBwDAAcAwDHAMAxAHAMABwDAMcAwDEAcAwAHAMAxwCgiXwH+DSb2mLzUIsAAAAASUVORK5CYII=":"front.png"==e?"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAADDPmHLAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAATSSURBVHhe7d1vaFV1HMfx77mt3f25s/mHSX8oAxVayxDBWSxScmxhj+rBDNTyiYotuUSKk1kbPcjK0AjF9aCejHGDwB44GyWRDHsQKP7LB0NhICauDLWlu2Pb8Zxzv3k7d7dzd+eg8zufzwt+1985h3vhet+enXP0Hi3bIQQrpr8SKAYAjgGAYwDgGAA4BgCOAYBjAOAYADgGAI4BgGMA4BgAOAYAjgGAYwDgGAA4BgCOAYBjAOAYADgGAI4BgGMA4BgAOAYAjgGAYwDgGAA4BgCOAYBjAOAYADgGAI4BgGMA4BgAOAYADiqAs4eP6ez+HP9+Zl4nDCAC6Dk+IJZVJc+92qhrpm/F7j5Z2dQob6+Yr2sM594oMsqk8X33Rpj3xp7mct1SvPbvbvlea4EzTBf5AD4/cdP3oblj4tQXunXqem94d1T1jUvdW3WruSIfgKu+vdf3wZU7oxgTzhCp8b3Gx03xzEbDQQTgktpW3wfYWjv1t16xfKfvuU87IyqgbhZtWTXO4++ZBUfXxidk05eDupTfL8Mi9VWWLmXYl3tEHntdl8wGdRo4bg+JVC725ltW1zkf/mlvHmR5wvvjLvVrd3jLqU0LI/Phe9w9gGleSB717ZJNGecOteg7CA8j9wDzqp3DOAPFE3N0Fh5GBnB7ZExnZhkbvaOz8DDyIPDrnwblTN8BKS2r1DXhN3w7LW3rGmTukjW6Jhz4X8aAgzoLoMmM3wMMpkUOtCWlcla1/D0yKm81PysLVrboVirE+ACO3RBpnJ29UPPDziZZ/WGfLlEhxv8IKMl5ByVlFTrz6z17Xdp2vCsdHR2SfGe7SHryFcCu8+7VQmtGh5zv0lcPJ5hjgG9ODsmeTz6Vzs5O+WzfXpE7F3VLViKuk5kUT+gknGACKC8t0ZmK5SyD4llAAPvCfu/vAYoZfX+ZdUjFAALcuuYcYRbpj6s6MQQDAMcAwDGAALPmV+ts6uY9rBNDMIAAVm0y77l90GjO+ddDYccAwDEAcAwgAK8DgON1AIo8BgCOAQTgdQBwvA5AkccAwDGAALwOAI7XASLkz+G0ztRY+L6m9X+ACSC1uc63q5Y5L+sWbMYH4H6W/xaz+FOtGMb/bj1UpRM1Mjqis/sXi5l1Tj8dxgdQ4b2D7NtIfdurs+LZEzr5x/i4TqLL+AAyN3zJPLq++lWkq+V5XfLbdvCIvNe6zZkNZVbkqMz5UtGGN/fqLMKcAyLj1az5wD0SmNJ43Bm2nc48MccVZ4gkJj0n3/hx90uZJ+XoHvCOSu4Ne6Bbt4ST8XsAV+pwu84Ke3GJ+1jqzXM94j40bPXmhaxav05nZotEAKseFOm/6N42pvC9g5Y+tVBn+V3v/0gk/qQu5ed9hXBRNE4jI3eHkINHTsvVn1PyQGmZrsly7x+QfGWZPNrwmq75bz39v8mFo/ulJO4/MBhzDhQXld2UN3bt0zV+7jeMtzyTPXuwzx0SqdusS+HDW8SAi8SPAJo+BgCOAYBjAOAYADgGAI4BgGMA4BgAOAYAjgGAYwDgGAA4BgCOAYBjAOAYADgGAI4BgGMA4BgAOAYAjgGAYwDgGAA4BgCOAYBjAOAYADgGAI4BgGMA4BgAOAYAjgGAYwDgGAA4BgCOAYBjAOAYADSRuxux88tGkLE+AAAAAElFTkSuQmCC":"left.png"==e?"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAADDPmHLAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAUbSURBVHhe7dxfaJV1HMfx75GDc8M17WZEDZtrBNofswu90KkX5bQIRtCUqJhdtLBWu5iNlUZ/tskML/qzQKoRgdhNWFAagS6tixiLaiVZy0gsyYu0NbfZDjv9fs/vi09nusOZO7Lf73w+L3iefX8TQc7ee54953lcIm0IwZqjHwkUAwDHAMAxAHAMABwDAMcAwDEAcAwAHAMAxwDAMQBwDAAcAwDHAMAxAHAMABwDAMcAwDEAcAwAHAMAxwDAMQBwDAAcAwDHAMAxAHAMABwDAMcAwDEAcAwAHAMAxwDAMQBwDAAcAwDHAHLQ1NQt73Y06aqw8PcETmHQbNWJhFsYRWYbS/9h9tdF60LBI8AUbrK7hXdHs3XB7k73R3MhYQBZlC1fopNzur9Xp8LBALKoq2vQyenvHdCpcDCALJatvFUnp3egT6fCwQCy2Hhn/EOgdazvrE6FgwFkUW13N9RHs3Ug+vqfiOZCEeRlYCJhf0b/xS0CUF8lsm/Qz5c5zCNAslyHMFxbntTJP2EGkBrWIQyjwymd/BPkKaD5xbelLPWryffqf2ctKC2R5h17REbiU84bzz8mZ+ZUiEyM62emdiE1Iasqk3LPozv0M37hW8E5WHR/l5z84BldmS/q0Rdk7io/v6DTxauAHNTeW6eTs3v3WzqFj0eAHHxjtjv+d2PoerOdSo+YfXG0DhmPADlYZncV8VHgd7sbeCeaQ8cAcnTXA1t0cjq2d+gUNp4CctQzKLKlevJpYNTs50XrUPEIkKOG6AGBFdFs2dPA+JevusVlhfFeBQOYhhWNjTo5W5+OLw0vdV4/+o2ngGnoOWFOA1WZdwjTaXuNcLtbZDhutpvd6DEeAaahYbHZLc08Cux/tlmnyfz/4lvBHwFm+86gvWX8U8AvYfhHgFm+M/iz2b7t3uQWASqAI4A9/37nFrNkXVLk0HiYL2PwAVzJncHSknnyUs+n8veP8VO+rY+sleLq9TIxPqafuTx7yPxnQam80txqpvg2718ftsnC+9p1FRAbAKKq+p02/Itbum+n/kluFm/uzvj7NYkwX0rYq4DUv5nf6UPD2b/zJ9u/93GdnCMmg9/2PqWrcPAy8ArZB8YrN3e7hVr3YLZ3Bv3EAGbgcHQUiN8YMj+JyEdtq90iEAxgBhaZbUPXYbdQdZ1fmP0ptwgAA5ihT1rWmP1StzAmzPbc6gq3CAADyIM3f/heJ6fdHgSO7HILzzGAPGhcIlJc26Urp2TNNp38xgDyZORAi9nHzwjaR0V2bShxC48xgDzq+tw+KBrbdtBkcNTvUwEDyKOWGpGi9ZmngkSNPRX4e1XAAPJs7KA9FcRXBdbD5f5eFTCAq+Djc5lXBe+dEXn/ycwofAEbQHJu5tO818zP39O9G8tEHtrzta6cTa8fE+nr1JU/grwdPNP/HDqT28FTGTo/Jp1ba6XoxrX6GXMpuHK7jH71cjTve6JS6l/z8JdLRPcEAyNy28XbsD5tZz9r1X9hTKQ63bbc35c5zFNAcr4OfpmTvPQ0MnDyuLT3D+nKP2EGkPpTB7+kRs/pFLulwt4tLHULDwX/SBjNDC8DwTEAcAwAHAMAxwDAMQBwDAAcAwDHAMAxAHAMABwDAMcAwDEAcAwAHAMAxwDAMQBwDAAcAwDHAMAxAHAMABwDAMcAwDEAcAwAHAMAxwDAMQBwDAAcAwDHAMAxAHAMABwDAMcAwDEAcAwAHAMAxwDAMQBwDAAcA4Am8h8GanSzb0xHnAAAAABJRU5ErkJggg==":"right.png"==e?"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAADDPmHLAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAATxSURBVHhe7dxvaFV1HMfx7xne/blbOrFwEHeSYSHRLIv+kA0iAjch6A9U6mARkwhmGsQabQ/KxaQ/kEFGIxbln54VFHUX9EDNB/qgMAsrJZJNkmrK3O7umgmn3++eb9zdcRfbumc7v/P5vOAcz/c8Uefb3znn7t55viEEq0x/JVAMABwDAMcAwDEAcAwAHAMAxwDAMQBwDAAcAwDHAMAxAHAMABwDAMcAwDEAcAwAHAMAxwDAMQBwDAAcAwDHAMAxAHAMABwDAMcAwDEAcAwAHAMAxwDAMQBwDAAcAwDHAMAxAHAMABwDAMcAwDGAGaRPZGXbKy9LvefpmXjiTwotwvOuMfvhYDAuf90riQ0v6BQvXAGKeLD3Ez0KtO/s1KP44QpQxAWzXe0lzP5Kbrb8Pz82Jx/SKT64AhSxwmyrH9sTDOrdnR16FC9cAWbwvdkapt0A+v5Zs18VDDHBFWAGN5vt+pZ3gkF9+mKrHsWH0yvA5ycvyNH9vVKRrNEzpVOZKJMjv5VJem+3nhFZbrbON16S8VH7JZv7ly07eUW2brhOGjY9pWciwAbgqtb+U//+Sziz9bc26J8+Gpy+BFSVL9Ejd5RXlX61+j+cDuBiZlKP3JG5+LseRQOfAmbhjNlumPJEUGG2v/yM2VfnZpfxKWAW1pjt3q7PgsGw685rzXXB4DiuALNkXxNMePb6PZ6bLX/wgEhqs05u4gowS/Z2c/uBH4NBNa/dokfuYgBzsGdzylz2m3QSSZvF4NxHz+rkJl4C5ujgkMiW+ukvEQ+avYmjgL1JjNYjXzFcAebILgKrHi98ifj15rV6NFX+XiHKuALMg/2ClXlJs5/IzZZ/+FWRxud1sn42243BYYQxgHl676RI27r8pcDmMO6PmP2y3OyKWAVw1jygv925Q6qX1uqZcNh/9tq6Wtmx3VwK/j4dnDTabxJ56we3vpyxCuAr8x/wgeWFN2gL7du+Frm17UOdoi9WN4FLIvC3Wb9tn8ilL3SKPj4FhGBl7Sazd2NhjXUAAx332/c7hLa1vHlKf6dCf5it++7ovwZgxTqA4dH8Y1oYMiMzf2u351hWBrrv0im6eAkooSeffkaPAk09x2VsIP+WsihiACXUv/cRqW7crVNgaVOPWSoGdIoeBlBKv5yXzOEOkao79UTAu8p+A+m7YIgYBlBKeuN/LnssOJhipXeL2V8KhghhACG41mx9JwofA+2TwerqcF+hnA8GEJK2dSJd6TGdAr9mReqT9pVK+z2DaGAAIdq1sUbu6ErrFBgyT6ZDR/p1WnwMIGTHd22UFVv7dDK3CWNHJdX4nE6LjwEsgOF9bZJa3yH++YMiNffo2WhgAAtk8JvdInVP6BQdDABcrANIVoT72cHySje+4fNfYvWGkEOjIvcty78h5OHbU3Lbo+1yeaL0b9BMVibk/S/PyE+HPtAz5gbv9H6RNW59ViDWASw0FwPgPQA4BgAu1gEs1juCXBLrABbzHUGu4CUAXKwCmMj/YM+csH8cy/DItBVm0n4g1C38aBg4XgLAMQBwDAAcAwDHAMAxAHAMABwDAMcAwDEAcAwAHAMAxwDAMQBwDAAcAwDHAMAxAHAMABwDAMcAwDEAcAwAHAMAxwDAMQBwDAAcAwDHAMAxAHAMABwDAMcAwDEAcAwAHAMAxwDAMQBwDAAcA4Am8g9ejRDNEuk3tQAAAABJRU5ErkJggg==":"up.png"==e?"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAADDPmHLAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAAAJpSURBVHhe7d3PShtBAIDx2RBxRS0pFIIHwYMnH6J47LuUgt7Se8FCD3rxAXwKFS/iQ3jpxZsUpAkRaYQQm5BB2MuSGGGz830/GGY2t+x+7OYvm72MBWE14iwoA4AzADgDgDMAOAOAMwA4A4AzADgDgDMAOAOAMwA4A4AzADgDgDMAOAOAMwA4A4AzADgDgDMAOAOAMwA4A4AzADgDgDMAOAOAMwA4A4AzADgDgDMAOAOAMwA4A4AzADgDgDMAOAOAMwA4AyhxeP43ZFn2OnbHIzUGUKK11oyrqXZxMwkGAGcAcAYAZwBwBgBnAHAGAGcAcAYAZwBzSO+DYAOYSzfOKTGAEq32h7ia+hjn2TzGebklF8Dq58PCN3iLjIO94kk/xVusJhfA1qdWXFVtM87LzUsAXHIB3D/04kqzSC6A55vjMLkh+nuMk9v0b6zuJaBE708/rtJlAHAGAGcAcAYAZwBwBgBnAHAGAGcAcAYAZwBwBgBnAHAGAGcAcAYAZwBwBlAi3yj+L6CZ4N7KXiY/fqux67vncHH6PeTrxYO1qHylES5//wvXZz/jIyFsjwP49utHeOoPx1tv3239p0E4+volrO7sx0cqNAmgzjpX3cmRqN3oXnXiM6hW7U9qeU3Py41mHlfVqn0Ag+EoruplNBzEVbV8DVCBZXoNUPsAtJgE39hoHgYAZwBwBgBnAHAGAGcAcAYAZwBwBgBnAHAGAGcAcAYAZwBwBgBnAHAGAGcAcAYAZwBwBgBnAHAGAGcAcAYAZwBwBgBnAHAGAGcAcAYAZwBwBgBnAHAGAGcAcAYAZwBwBoAWwn8GG/BweZN80wAAAABJRU5ErkJggg==":void 0},function(e){e=e.getBoundingClientRect();return{x:e.left,y:e.top,w:e.width,h:e.height}}),O=function(e){e.preventDefault(),e.stopPropagation(),J=document.pointerLockElement===f||document.mozPointerLockElement===f||document.webkitPointerLockElement===f},e=function(e){return e},t=(this.getView=function(){return y.center.clone().sub(y.camera.position)},function(){var e=new THREE.Vector3(1,1,1);e.normalize(),e.multiplyScalar(y.viewScale),y.camera.position.copy(e),y.center=new THREE.Vector3(0,0,0),y.camera.up.set(0,1,0),y.camera.lookAt(y.center),y.originCamInfo.position=e,y.originCamInfo.center=y.center.clone(),y.originCamInfo.up=new THREE.Vector3(0,1,0)}),T=function(e){var t=new Image,r=(t.crossOrigin="anonymous",new THREE.Texture(t));return t.onload=function(){r.needsUpdate=!0,11<=++Q&&requestAnimationFrame(y.render)},De.singleHTML?t.src=y.getPicSrc(e):t.src=e,r},te=function(){var e,t,r=[],i=[];for(r[0]=R(0,0),r[1]=R(0,Math.PI/2),r[2]=R(0,-Math.PI/2),r[3]=R(0,Math.PI),r[4]=R(Math.PI/2,0),r[5]=R(Math.PI/2,Math.PI/2),r[6]=R(Math.PI/2,-Math.PI/2),r[7]=R(Math.PI/2,Math.PI),i[0]=S(0,0,0),i[1]=S(0,Math.PI/2,0),i[2]=S(0,-Math.PI/2,0),i[3]=S(0,Math.PI,0),i[4]=S(Math.PI/2,0,0),i[5]=S(Math.PI/2,Math.PI/2,0),i[6]=S(Math.PI/2,-Math.PI/2,0),i[7]=S(Math.PI/2,Math.PI,0),i[8]=S(0,0,Math.PI/2),i[9]=S(0,0,-Math.PI/2),i[10]=S(-Math.PI/2,0,-Math.PI/2),i[11]=S(-Math.PI,0,-Math.PI/2),d.push(he(0,0)),d[0].name="front",g.push(d[0]),M.push(d[0]),n.add(d[0]),d.push(he(0,Math.PI/2)),d[1].name="right",g.push(d[1]),M.push(d[1]),n.add(d[1]),d.push(he(0,Math.PI)),d[2].name="back",g.push(d[2]),M.push(d[2]),n.add(d[2]),d.push(he(0,-Math.PI/2)),d[3].name="left",g.push(d[3]),M.push(d[3]),n.add(d[3]),d.push(he(Math.PI/2,0)),d[4].name="bottom",g.push(d[4]),M.push(d[4]),n.add(d[4]),d.push(he(-Math.PI/2,0)),d[5].name="top",g.push(d[5]),M.push(d[5]),n.add(d[5]),e=d.length,t=0;t<r.length;t++)d.push(r[t]),d[e+t].name=q[t],n.add(d[e+t]),g.push(d[e+t]),M.push(d[e+t]);for(e=d.length,t=0;t<i.length;t++)d.push(i[t]),d[e+t].name=X[t],n.add(d[e+t]),g.push(d[e+t]),M.push(d[e+t])},re=function(e,t,r){var i=new THREE.Vector3;return i.copy(e),i=i.unproject(t),new THREE.Raycaster(t.position,i.sub(t.position).normalize()).intersectObjects(r)},ie=function(e,t){var r=e.clientX-t.x,e=e.clientY-t.y,r=r/t.w*2-1,e=(t.h-e)/t.h*2-1;return new THREE.Vector3(r,e,.5)};function ne(e,t){var r={};return 0===e.type.indexOf("touch")?0<e.changedTouches.length?(r.clientX=e.changedTouches[0].clientX,r.clientY=e.changedTouches[0].clientY,r.pageX=e.changedTouches[0].pageX,r.pageY=e.changedTouches[0].pageY,r.screenX=e.changedTouches[0].screenX,r.screenY=e.changedTouches[0].screenY,r.movementX=r.screenX-t.prevX,r.movementY=r.screenY-t.prevY):r=t.prevCoords:(r.clientX=e.clientX,r.clientY=e.clientY,r.pageX=e.pageX,r.pageY=e.pageY,r.screenX=e.screenX,r.screenY=e.screenY,r.which=e.which,Z?(r.movementX=e.movementX||e.mozMovementX||e.webkitMovementX||0,r.movementY=e.movementY||e.mozMovementY||e.webkitMovementY||0):(r.movementX=r.screenX-t.prevX,r.movementY=r.screenY-t.prevY)),t.prevX=r.screenX,t.prevY=r.screenY,t.prevCoords=r}function ae(){u=ee(f),y.width=f.offsetWidth,y.height=f.offsetHeight,y.width,y.height,y.camera.aspect=y.width/y.height,y.camera.updateProjectionMatrix(),y.camera.topFov=y.camera.bottomFov=y.camera.fov/2,y.camera.leftFov=y.camera.rightFov=y.camera.aspect*y.camera.fov/2,y.renderer&&(y.renderer.setSize(y.width,y.height),y.render())}var oe=function(e){Pe.isMobileDevice()&&y.processMouseMove(e),e.preventDefault(),e.stopPropagation(),u=ee(f),f.removeEventListener("mousemove",ce,!1),f.addEventListener("mouseup",de,!1),f.addEventListener("touchend",de,!1)},se=function e(t){t.preventDefault(),t.stopPropagation(),y.animSpeed<=0?(document.removeEventListener("mousemove",e,!1),document.removeEventListener("touchmove",e,!1),avp.logger.error("animSpeed cannot be 0 or less")):p.currentlyAnimating||(t=ne(t,y),Z&&$&&($=!1,t.movementX=t.movementY=0),J&&(300<t.movementX||300<t.movementY)&&(t.movementX=0,t.movementY=0),t.movementX===t.movementY&&0===t.movementX?p.currentlyAnimating=!1:(b=!(K=!1),p.showPivot(!0),p.currentCursor=new THREE.Vector2(t.pageX,t.pageY),p.orbit(p.currentCursor,p.startCursor,new THREE.Vector3(-t.movementX,t.movementY,0),p.startState),y.camera.lookAt(y.center),requestAnimationFrame(y.render)))},le=function(e){e||(f.removeEventListener("mouseup",de,!1),f.removeEventListener("touchend",de,!1)),document.removeEventListener("mousemove",se,!1),document.removeEventListener("touchmove",se,!1),f.addEventListener("mousemove",ce,!1),J&&document.exitPointerLock()},de=(this.getDestByFace=function(e){var t,r,i,n,a=new THREE.Vector3(0,1,0),o=new THREE.Vector3(1,-0,0),s=new THREE.Vector3(0,0,-1),l=(null==A&&(l=new THREE.Vector3(0,-1,0),t=new THREE.Vector3(0,1,0),h=new THREE.Vector3(0,0,-1),r=new THREE.Vector3(0,0,1),i=new THREE.Vector3(1,0,0),c=new THREE.Vector3(-1,0,0),n=new THREE.Vector3,(A={}).top=l,A.bottom=t,A.front=h,A.back=r,A.left=i,A.right=c,A["top,front"]=n.addVectors(l,h).clone(),A["top,right"]=n.addVectors(l,c).clone(),A["top,left"]=n.addVectors(l,i).clone(),A["top,back"]=n.addVectors(l,r).clone(),A["bottom,front"]=n.addVectors(t,h).clone(),A["bottom,right"]=n.addVectors(t,c).clone(),A["bottom,left"]=n.addVectors(t,i).clone(),A["bottom,back"]=n.addVectors(t,r).clone(),A["left,front"]=n.addVectors(i,h).clone(),A["front,right"]=n.addVectors(h,c).clone(),A["right,back"]=n.addVectors(c,r).clone(),A["back,left"]=n.addVectors(r,i).clone(),A["front,top,right"]=n.addVectors(h,l).add(c).clone(),A["back,top,right"]=n.addVectors(r,l).add(c).clone(),A["front,top,left"]=n.addVectors(h,l).add(i).clone(),A["back,top,left"]=n.addVectors(r,l).add(i).clone(),A["front,bottom,right"]=n.addVectors(h,t).add(c).clone(),A["back,bottom,right"]=n.addVectors(r,t).add(c).clone(),A["front,bottom,left"]=n.addVectors(h,t).add(i).clone(),A["back,bottom,left"]=n.addVectors(r,t).add(i).clone()),A[e].clone().normalize()),d=a,c=l.clone().negate();if(1-Math.abs(c.dot(a))<1e-5)for(var h=this.getView().normalize(),u=[s.clone(),s.clone().negate(),o.clone(),o.clone().negate()],p=0<c.dot(a)?1:-1,f=h.clone().add(y.camera.up.clone().multiplyScalar(p)).normalize(),m=-2,g=0;g<4;g++){var v=f.dot(u[g]);m<v&&(m=v,d=u[g].multiplyScalar(p))}return{dir:l.clone(),up:d.clone()}},this.getOrientation=function(){var e=Pe.round1(W.up.x),t=Pe.round1(W.up.y),r=Pe.round1(W.up.z),i=new THREE.Vector3(0,0,-1),n=new THREE.Vector3(0,1,0),a=i.clone().cross(n).normalize(),o=(i.x=Pe.round1(i.x),i.y=Pe.round1(i.y),i.z=Pe.round1(i.z),n.x=Pe.round1(n.x),n.y=Pe.round1(n.y),n.z=Pe.round1(n.z),a.x=Pe.round1(a.x),a.y=Pe.round1(a.y),a.z=Pe.round1(a.z),a.clone().multiplyScalar(-1)),s=n.clone().multiplyScalar(-1),l=i.clone().multiplyScalar(-1);switch(y.currentFace){case"front":if(n.x==e&&n.y==t&&n.z==r)return"up";if(s.x==e&&s.y==t&&s.z==r)return"down";if(a.x==e&&a.y==t&&a.z==r)return"right";if(o.x==e&&o.y==t&&o.z==r)return"left";break;case"right":if(n.x==e&&n.y==t&&n.z==r)return"up";if(s.x==e&&s.y==t&&s.z==r)return"down";if(l.x==e&&l.y==t&&l.z==r)return"left";if(i.x==e&&i.y==t&&i.z==r)return"right";break;case"left":if(n.x==e&&n.y==t&&n.z==r)return"up";if(s.x==e&&s.y==t&&s.z==r)return"down";if(i.x==e&&i.y==t&&i.z==r)return"left";if(l.x==e&&l.y==t&&l.z==r)return"right";break;case"back":if(n.x==e&&n.y==t&&n.z==r)return"up";if(s.x==e&&s.y==t&&s.z==r)return"down";if(o.x==e&&o.y==t&&o.z==r)return"right";if(a.x==e&&a.y==t&&a.z==r)return"left";break;case"top":if(l.x==e&&l.y==t&&l.z==r)return"down";if(i.x==e&&i.y==t&&i.z==r)return"up";if(a.x==e&&a.y==t&&a.z==r)return"right";if(o.x==e&&o.y==t&&o.z==r)return"left";break;case"bottom":if(i.x==e&&i.y==t&&i.z==r)return"down";if(l.x==e&&l.y==t&&l.z==r)return"up";if(a.x==e&&a.y==t&&a.z==r)return"right";if(o.x==e&&o.y==t&&o.z==r)return"left"}},function(e){var t=Date.now();if(Pe.isMobileDevice()&&y.processMouseMove({type:"noIntersect"}),e.preventDefault(),e.stopPropagation(),p.isSmoothTranslationDone()){var r,i=ne(e,y),i=(u=ee(f),ie(i,u)),n=re(i,y.camera,M),a=re(i,c,m),i=re(i,c,v),o=y.isFaceView();if(0<n.length&&(n=n[0].object.name,s=y.viewer.getModelOperationMode(),d=y.viewer.getModelOperationVerticalRotationRange(),"FirstPerson"==s?"top"!=n&&"bottom"!=n&&(y.mouseMoveSave=e,y.cubeRotateTo(n)):("hall"!=s||(r=!0,"bottom"==n&&d.x<90&&(r=!1),("bottom,front"==n||"bottom,right"==n||"bottom,left"==n||"bottom,back"==n||"front,bottom,right"==n||"back,bottom,right"==n||"front,bottom,left"==n||"back,bottom,left"==n)&&d.x<45&&(r=!1),("top,front"==n||"top,right"==n||"top,left"==n||"top,back"==n||"front,top,right"==n||"back,top,right"==n||"front,top,left"==n||"back,top,left"==n)&&d.y<45&&(r=!1),r=!("top"==n&&d.y<90)&&r))&&(y.mouseMoveSave=e,y.cubeRotateTo(n))),0<a.length&&o){var s,l=y.getOrientation(),d=y.currentFace;switch(y.currentFace){case"front":switch(l){case"up":a[0].object===m[0]?y.currentFace="top":a[0].object===m[1]?y.currentFace="bottom":a[0].object===m[2]?y.currentFace="right":a[0].object===m[3]&&(y.currentFace="left");break;case"right":a[0].object===m[0]?y.currentFace="right":a[0].object===m[1]?y.currentFace="left":a[0].object===m[2]?y.currentFace="bottom":a[0].object===m[3]&&(y.currentFace="top");break;case"down":a[0].object===m[0]?y.currentFace="bottom":a[0].object===m[1]?y.currentFace="top":a[0].object===m[2]?y.currentFace="left":a[0].object===m[3]&&(y.currentFace="right");break;case"left":a[0].object===m[0]?y.currentFace="left":a[0].object===m[1]?y.currentFace="right":a[0].object===m[2]?y.currentFace="top":a[0].object===m[3]&&(y.currentFace="bottom")}break;case"right":switch(l){case"up":a[0].object===m[0]?y.currentFace="top":a[0].object===m[1]?y.currentFace="bottom":a[0].object===m[2]?y.currentFace="back":a[0].object===m[3]&&(y.currentFace="front");break;case"right":a[0].object===m[0]?y.currentFace="back":a[0].object===m[1]?y.currentFace="front":a[0].object===m[2]?y.currentFace="bottom":a[0].object===m[3]&&(y.currentFace="top");break;case"down":a[0].object===m[0]?y.currentFace="bottom":a[0].object===m[1]?y.currentFace="top":a[0].object===m[2]?y.currentFace="front":a[0].object===m[3]&&(y.currentFace="back");break;case"left":a[0].object===m[0]?y.currentFace="front":a[0].object===m[1]?y.currentFace="back":a[0].object===m[2]?y.currentFace="top":a[0].object===m[3]&&(y.currentFace="bottom")}break;case"left":switch(l){case"up":a[0].object===m[0]?y.currentFace="top":a[0].object===m[1]?y.currentFace="bottom":a[0].object===m[2]?y.currentFace="front":a[0].object===m[3]&&(y.currentFace="back");break;case"right":a[0].object===m[0]?y.currentFace="front":a[0].object===m[1]?y.currentFace="back":a[0].object===m[2]?y.currentFace="bottom":a[0].object===m[3]&&(y.currentFace="top");break;case"down":a[0].object===m[0]?y.currentFace="bottom":a[0].object===m[1]?y.currentFace="top":a[0].object===m[2]?y.currentFace="back":a[0].object===m[3]&&(y.currentFace="front");break;case"left":a[0].object===m[0]?y.currentFace="back":a[0].object===m[1]?y.currentFace="front":a[0].object===m[2]?y.currentFace="top":a[0].object===m[3]&&(y.currentFace="bottom")}break;case"back":switch(l){case"up":a[0].object===m[0]?y.currentFace="top":a[0].object===m[1]?y.currentFace="bottom":a[0].object===m[2]?y.currentFace="left":a[0].object===m[3]&&(y.currentFace="right");break;case"right":a[0].object===m[0]?y.currentFace="left":a[0].object===m[1]?y.currentFace="right":a[0].object===m[2]?y.currentFace="bottom":a[0].object===m[3]&&(y.currentFace="top");break;case"down":a[0].object===m[0]?y.currentFace="bottom":a[0].object===m[1]?y.currentFace="top":a[0].object===m[2]?y.currentFace="right":a[0].object===m[3]&&(y.currentFace="left");break;case"left":a[0].object===m[0]?y.currentFace="right":a[0].object===m[1]?y.currentFace="left":a[0].object===m[2]?y.currentFace="top":a[0].object===m[3]&&(y.currentFace="bottom")}break;case"top":switch(l){case"up":a[0].object===m[0]?y.currentFace="back":a[0].object===m[1]?y.currentFace="front":a[0].object===m[2]?y.currentFace="right":a[0].object===m[3]&&(y.currentFace="left");break;case"right":a[0].object===m[0]?y.currentFace="right":a[0].object===m[1]?y.currentFace="left":a[0].object===m[2]?y.currentFace="front":a[0].object===m[3]&&(y.currentFace="back");break;case"down":a[0].object===m[0]?y.currentFace="front":a[0].object===m[1]?y.currentFace="back":a[0].object===m[2]?y.currentFace="left":a[0].object===m[3]&&(y.currentFace="right");break;case"left":a[0].object===m[0]?y.currentFace="left":a[0].object===m[1]?y.currentFace="right":a[0].object===m[2]?y.currentFace="back":a[0].object===m[3]&&(y.currentFace="front")}break;case"bottom":switch(l){case"up":a[0].object===m[0]?y.currentFace="front":a[0].object===m[1]?y.currentFace="back":a[0].object===m[2]?y.currentFace="right":a[0].object===m[3]&&(y.currentFace="left");break;case"right":a[0].object===m[0]?y.currentFace="right":a[0].object===m[1]?y.currentFace="left":a[0].object===m[2]?y.currentFace="back":a[0].object===m[3]&&(y.currentFace="front");break;case"down":a[0].object===m[0]?y.currentFace="back":a[0].object===m[1]?y.currentFace="front":a[0].object===m[2]?y.currentFace="left":a[0].object===m[3]&&(y.currentFace="right");break;case"left":a[0].object===m[0]?y.currentFace="left":a[0].object===m[1]?y.currentFace="right":a[0].object===m[2]?y.currentFace="front":a[0].object===m[3]&&(y.currentFace="back")}}"hall"!=(s=y.viewer.getModelOperationMode())&&"FirstPerson"!=s||"top"!=y.currentFace&&"bottom"!=y.currentFace?y.cubeRotateTo(y.currentFace):y.currentFace=d}("normal"==(s=y.viewer.getModelOperationMode())||"bim"==s)&&0<i.length&&o&&(!y.wantRollArrows||i[0].object!==v[z]&&i[0].object!==v[h]||(r=i[0].object===v[h],e={center:y.center.clone(),position:y.camera.position.clone(),worldUp:new THREE.Vector3(0,1,0)},n=y.center.clone().sub(y.camera.position).normalize(),r?e.up=y.camera.up.clone().cross(n):(e.up=y.camera.up.clone().multiplyScalar(-1),e.up.cross(n)),e.up.normalize(),d={from:e.position.toArray(),to:e.center.toArray(),up:e.up.toArray(),animationSpeed:1e3},y.viewer.opViewportConnect(!1),p.look(d))),le(!1),y.viewer.logOperatorTime&&y.viewer.logOperatorTimeShow("[视图盒操作]",t)}else le(!1)}),ce=(this.cubeRotateTo=function(e){y.currentFace=e;var t=y.getDestByFace(e),r=y.center.clone().sub(t.dir),t=(r.normalize(),t.up.clone()),e=(Pe.isMobileDevice()&&("top,right"!=e&&"front,right"!=e&&"back,left"!=e&&"top,left"!=e&&"bottom,right"!=e&&"bottom,left"!=e||(r.x+=1e-6),"top,front"!=e&&"top,back"!=e&&"bottom,front"!=e&&"bottom,back"!=e&&"right,back"!=e&&"left,front"!=e||(r.z+=1e-6)),{from:r.toArray(),to:y.center.toArray(),up:t.toArray(),callback:function(){var e=y.viewer.getCameraInfo(),e=new THREE.Vector3(e.position.x-e.target.x,e.position.y-e.target.y,e.position.z-e.target.z),e=(new THREE.Quaternion).setFromUnitVectors(new THREE.Vector3(0,0,1).normalize(),e.normalize()),e=(new THREE.Euler).setFromQuaternion(e);y.viewer.ScenarioEditorInfo.EulerAngle.set(e.x,e.y,e.z),y.viewer.dispatchEvent({type:"Eulerchange",x:180*e.x/Math.PI,y:180*e.y/Math.PI,z:180*e.z/Math.PI}),y.viewer.dispatchEvent({type:"dischange",distance:20}),Pe.isMobileDevice()||y.mouseMoveSave&&y.processMouseMove(y.mouseMoveSave),"OpDrawGeom"==y.viewer.controls.getOperator().type&&y.viewer.controls.getOperator().rotateViewBox(),De.enableBroadcast&&De.broadcastMajor&&He.updateBroadcastInfo("generalInfo"),p.adjustNearAndFar()},sphericalTransition:!0});y.viewer.opViewportConnect(!1),p.look(e)},this.processMouseMove=function(e){var t,r;if(p.isSmoothTranslationDone()){if(y.mouseMoveSave=null,e=Pe.isMobileDevice()&&"noIntersect"==e.type?(t=[],r=[],[]):(e=ne(e,y),e=ie(e,u),t=re(e,y.camera,g),r=re(e,c,m),re(e,c,v)),E&&!b&&(E.material.color.setHex(14540253),E=null,requestAnimationFrame(y.render)),0<r.length&&!b){E=r[0].object;for(var i=a.children.length;0<=--i;)if(E===m[i]){(E=a.children[i]).material.color.setHex(45055);break}requestAnimationFrame(y.render)}Y&&!b&&(Y.material.opacity=0,Y=null,requestAnimationFrame(y.render)),0<t.length&&!b&&((Y=t[0].object).material.opacity=.7,requestAnimationFrame(y.render)),0<e.length&&!b?w!==e[0].object&&(y.wantHomeButton&&e[0].object===v[s]?(w=e[0].object,v[s].material.map=I[0]):y.wantRollArrows&&e[0].object===v[z]?(w=e[0].object,v[o].material.map=I[1]):y.wantRollArrows&&e[0].object===v[h]?(w=e[0].object,v[o].material.map=I[2]):y.wantContextMenu&&e[0].object===v[l]?(w=e[0].object,v[l].material.map=I[6]):y.wantHomeButton&&w===v[s]?(w=null,v[s].material.map=I[3]):!y.wantRollArrows||w!==v[z]&&w!==v[h]&&w!==v[o]?y.wantContextMenu&&w===v[l]&&(w=null,v[l].material.map=I[5]):(w=null,v[o].material.map=I[4]),requestAnimationFrame(y.render)):null===w||b||(y.wantHomeButton&&w===v[s]?(w=null,v[s].material.map=I[3]):!y.wantRollArrows||w!==v[z]&&w!==v[h]&&w!==v[o]?y.wantContextMenu&&w===v[l]&&(w=null,v[l].material.map=I[5]):(w=null,v[o].material.map=I[4]),requestAnimationFrame(y.render))}},function(e){u=ee(f),y.processMouseMove(e)}),he=function(e,t){var r=.3*x,i=.225*x+r,n=new THREE.Geometry,a=new THREE.Vector3(0,0,0),o=new THREE.Vector3(r,-r,i),s=new THREE.Vector3(r,r,i),l=new THREE.Vector3(-r,r,i),r=new THREE.Vector3(-r,-r,i);return n.vertices.push(a),n.vertices.push(o),n.vertices.push(s),n.vertices.push(l),n.vertices.push(r),n.faces.push(new THREE.Face3(1,2,3)),n.faces.push(new THREE.Face3(1,3,4)),n.applyMatrix((new THREE.Matrix4).makeRotationX(e)),n.applyMatrix((new THREE.Matrix4).makeRotationY(t)),n.computeFaceNormals(),n.computeVertexNormals(),i=new THREE.MeshBasicMaterial({opacity:0,color:45055,transparent:!0}),new THREE.Mesh(n,i)},S=function(e,t,r){var i=.3*x,n=.225*x+i,a=new THREE.Geometry,o=new THREE.Vector3(i,n,n),s=new THREE.Vector3(-i,n,n),l=new THREE.Vector3(-i,i,n),d=new THREE.Vector3(i,i,n),c=new THREE.Vector3(i,n,i),h=new THREE.Vector3(-i,n,i),u=new THREE.Vector3(-i,n,n),i=new THREE.Vector3(i,n,n);return a.vertices.push(o),a.vertices.push(s),a.vertices.push(l),a.vertices.push(d),a.vertices.push(c),a.vertices.push(h),a.vertices.push(u),a.vertices.push(i),a.faces.push(new THREE.Face3(0,1,2)),a.faces.push(new THREE.Face3(0,2,3)),a.faces.push(new THREE.Face3(4,5,6)),a.faces.push(new THREE.Face3(4,6,7)),a.applyMatrix((new THREE.Matrix4).makeRotationX(e)),a.applyMatrix((new THREE.Matrix4).makeRotationY(t)),a.applyMatrix((new THREE.Matrix4).makeRotationZ(r)),a.computeFaceNormals(),a.computeVertexNormals(),n=new THREE.MeshBasicMaterial({opacity:0,color:45055,transparent:!0}),new THREE.Mesh(a,n)},R=function(e,t){var r=.3*x,i=.225*x+r,n=new THREE.Geometry,a=new THREE.Vector3(i,i,i),o=new THREE.Vector3(r,i,i),s=new THREE.Vector3(r,r,i),l=new THREE.Vector3(i,r,i),d=new THREE.Vector3(i,i,r),c=new THREE.Vector3(i,i,i),h=new THREE.Vector3(i,r,i),u=new THREE.Vector3(i,r,r),p=new THREE.Vector3(i,i,i),f=new THREE.Vector3(i,i,r),m=new THREE.Vector3(r,i,r),r=new THREE.Vector3(r,i,i);return n.vertices.push(a),n.vertices.push(o),n.vertices.push(s),n.vertices.push(l),n.vertices.push(d),n.vertices.push(c),n.vertices.push(h),n.vertices.push(u),n.vertices.push(p),n.vertices.push(f),n.vertices.push(m),n.vertices.push(r),n.faces.push(new THREE.Face3(0,1,2)),n.faces.push(new THREE.Face3(0,2,3)),n.faces.push(new THREE.Face3(4,5,6)),n.faces.push(new THREE.Face3(4,6,7)),n.faces.push(new THREE.Face3(8,9,10)),n.faces.push(new THREE.Face3(8,10,11)),n.applyMatrix((new THREE.Matrix4).makeRotationX(e)),n.applyMatrix((new THREE.Matrix4).makeRotationY(t)),n.computeFaceNormals(),n.computeVertexNormals(),i=new THREE.MeshBasicMaterial({opacity:0,color:45055,transparent:!0}),new THREE.Mesh(n,i)},ue=(this.render=function(){ue();var e=y.renderer;e&&(e.clear(),e.render(V,y.camera),e.render(G,y.camera),e.render(n,y.camera),e.render(r,c))},this.isFaceView=function(){var e=!1,t=new THREE.Vector3(0,-1,0),r=new THREE.Vector3(0,1,0),i=new THREE.Vector3(0,0,-1),n=new THREE.Vector3(0,0,1),a=new THREE.Vector3(1,0,0),o=new THREE.Vector3(-1,0,0),s=new THREE.Vector3;return s.subVectors(y.center,y.camera.position),s.normalize(),e=s.equals(t)||s.equals(r)||s.equals(i)||s.equals(n)||s.equals(a)||s.equals(o)?!0:e},function(){K=y.isFaceView(),(Pe.isMobileDevice()?K&&p.isSmoothTranslationDone()?fe:pe:K&&!B&&p.isSmoothTranslationDone()?fe:pe)(),(B?me:ge)(),(B?ve:ye)()}),pe=function(){r.remove(a),v[o].material.opacity=0,v[l].material.opacity=0},fe=function(){r.add(a);var e=y.wantRollArrows?1:0,e=(v[o].material.opacity=e,v[l].material.opacity=e,y.viewer.getModelOperationMode());"hall"==e||"FirstPerson"==e?(v[o].material.opacity=0,i.up.visible=!1,i.down.visible=!1):(i.up.visible=!0,i.down.visible=!0)},me=function(){j.material.opacity=0},ge=function(){j.material.opacity=y.wantContextMenu?1:0},ve=function(){k.material.opacity=0},ye=function(){k.material.opacity=y.wantHomeButton?1:0},C=(this.refreshCube=function(){ae()},this.setSize=function(e,t){if(y.width=e,y.height=t,1<f.children.length)for(var r=1;r<f.children.length;r++)f.children[r].style.bottom=(y.height/5).toString()+"px";ae()},this.useTransparency=function(e){(B=e)?(f.onmouseover=F,f.onmousemove=U,f.onmouseout=N,N()):(f.onmouseover=null,f.onmouseout=null,f.onmousemove=null,f.style.opacity="1.0")},this.dtor=function(){this.renderer=null},this.updateCurrentFace=function(e){var t=new THREE.Vector3(0,-1,0),r=new THREE.Vector3(0,1,0),i=(new THREE.Vector3(0,0,-1),new THREE.Vector3(0,0,1)),n=new THREE.Vector3(1,0,0),a=new THREE.Vector3(-1,0,0);e||((e=new THREE.Vector3).subVectors(y.center,y.camera.position),e.normalize()),e.equals(t)?y.currentFace="top":e.equals(r)?y.currentFace="bottom":e.equals(n)?y.currentFace="left":e.equals(a)?y.currentFace="right":e.equals(i)?y.currentFace="back":y.currentFace="front"},this.enableViewBox=function(e){e?(f.addEventListener("touchstart",oe,!1),f.addEventListener("mousedown",oe,!1),f.addEventListener("mousemove",ce,!1),f.onmouseover=F,f.onmousemove=U,f.onmouseout=N):(f.removeEventListener("touchstart",oe,!1),f.removeEventListener("mousedown",oe,!1),f.removeEventListener("mousemove",ce,!1),f.onmouseover=null,f.onmousemove=null,f.onmouseout=null)},this.updateCameraForView=function(e){W=e.camera},f.getBoundingClientRect()),C=(y.width=C.width,y.height=C.height,u=ee(f),y.width,y.height,1),C=(0!=y.width&&0!=y.height&&(C=y.height/y.width),(c=new THREE.PerspectiveCamera(70,C,1,1e4)).position.set(0,0,500),V=new THREE.Scene,n=new THREE.Scene,G=new THREE.Scene,r=new THREE.Scene,K=!0,x=y.boxSize,y.viewScale=700,t(),THREE.LinearFilter),t=(y.viewer.serverUrl||"./")+"img/viewbox/",Ae=[(P=t+(Pe.getLanguage()+"/"))+"left"+(D=".png"),P+"right"+D,P+"up"+D,P+"down"+D,P+"front"+D,P+"back"+D];if(De.singleHTML)for(var Me=0;Me<Ae.length;++Me)Ae[Me]=y.getPicSrc(Ae[Me]);(P=(new THREE.CubeTextureLoader).load(Ae)).format=THREE.RGBFormat,P.minFilter=P.maxFilter=C;var D=THREE.ShaderLib.cube,P=((D=new THREE.ShaderMaterial({fragmentShader:D.fragmentShader,vertexShader:D.vertexShader,uniforms:THREE.UniformsUtils.clone(D.uniforms),depthWrite:!1,transparent:!0})).uniforms.tCube.value=P,D.uniforms.opacity.value=.85,new THREE.BoxGeometry(x,x,x,4,4,4)),H=new THREE.BoxGeometry(x+1,x+1,x+1,4,4,4),D=((_=new THREE.Mesh(P,D)).position.set(0,0,0),V.add(_),(P=T(e(t+"VCedge1.png"))).minFilter=P.maxFilter=C,(_=new THREE.Mesh(H,new THREE.MeshBasicMaterial({map:P,transparent:!0,opacity:.85}))).position.set(0,0,0),G.add(_),x),C=new THREE.Geometry,H=new THREE.Vector3(-30,0,0),P=new THREE.Vector3(30,0,0),_=new THREE.Vector3(0,-30,0),H=(C.vertices.push(H),C.vertices.push(P),C.vertices.push(_),C.faces.push(new THREE.Face3(1,0,2)),C.computeFaceNormals(),new THREE.MeshBasicMaterial({color:14540253,transparent:!1,opacity:1})),P=new THREE.MeshBasicMaterial({color:14540253,transparent:!1,opacity:1}),_=new THREE.MeshBasicMaterial({color:14540253,transparent:!1,opacity:1}),L=new THREE.MeshBasicMaterial({color:14540253,transparent:!1,opacity:1}),Ee=new THREE.PlaneGeometry(.5*x,.3*x,2,2),we=new THREE.MeshBasicMaterial({transparent:!0,opacity:0}),H=(i.up=H,new THREE.Mesh(C,H)),xe=new THREE.Mesh(Ee,we),P=(H.position.set(0,D,0),xe.position.set(0,.9*D,.1),i.down=P,new THREE.Mesh(C,P)),be=new THREE.Mesh(Ee,we),_=(P.position.set(0,-D,0),be.position.set(0,.9*-D,.1),P.rotation.z+=Math.PI,be.rotation.z+=Math.PI,i.right=_,new THREE.Mesh(C,_)),Be=new THREE.Mesh(Ee,we),C=(_.position.set(D,0,0),Be.position.set(.9*D,0,.1),_.rotation.z-=Math.PI/2,Be.rotation.z-=Math.PI/2,i.left=L,new THREE.Mesh(C,L)),L=new THREE.Mesh(Ee,we),Ee=(C.position.set(-D,0,0),L.position.set(.9*-D,0,.1),C.rotation.z+=Math.PI/2,L.rotation.z+=Math.PI/2,(a=new THREE.Object3D).position.set(0,0,0),a.add(H),a.add(P),a.add(_),a.add(C),r.add(xe),r.add(be),r.add(Be),r.add(L),r.add(a),m.push(xe),m.push(be),m.push(Be),m.push(L),new THREE.PlaneGeometry(x/2,x/2,2,2)),we=new THREE.MeshBasicMaterial({map:T(e(t+"VChome.png")),transparent:!0}),D=((k=new THREE.Mesh(Ee,we)).position.set(1.4*-x,1.4*x,0),s=v.length,r.add(k),v.push(k),new THREE.PlaneGeometry(1.5*x,1.5*x,2,2)),H=new THREE.MeshBasicMaterial({map:T(e(t+"VCarrows.png")),transparent:!0}),_=((P=new THREE.Mesh(D,H)).position.set(.5*x+20,.5*x+20,0),new THREE.PlaneGeometry(.6*x,.45*x,2,2)),C=new THREE.MeshBasicMaterial({transparent:!0,opacity:0}),be=((xe=new THREE.Mesh(_,C)).position.set(.5*x+20,x+20,.1),new THREE.PlaneGeometry(.45*x,.6*x,2,2)),Be=new THREE.MeshBasicMaterial({transparent:!0,opacity:0}),Ee=((L=new THREE.Mesh(be,Be)).position.set(x+20,.5*x+20,.1),r.add(P),r.add(xe),r.add(L),z=v.length,v.push(xe),h=v.length,v.push(L),o=v.length,v.push(P),new THREE.PlaneGeometry(x/2.3,x/2.3,2,2)),we=new THREE.MeshBasicMaterial({map:T(e(t+"VCcontext.png")),transparent:!0});(j=new THREE.Mesh(Ee,we)).position.set(x,-x,0),l=v.length,r.add(j),v.push(j),te(),y.renderer=new THREE.WebGLRenderer({alpha:!0,antialias:!1}),(D=new Ie(y.viewer,y.renderer.domElement,["translateX","translateY","translateZ"],!0,{needListen:!1,needPlane:!1,ViewBoxTransform:!0})).setMode("translate"),D.setSpace("local"),H=new THREE.SphereGeometry(.1,1,1),_=new THREE.MeshBasicMaterial({colorWrite:!1}),(C=new THREE.Mesh(H,_)).position.set(-x/2,-x/2,-x/2),C.updateMatrixWorld(!0),D.attach(C),D.update(),V.add(D),y.useTransparency(!0),y.setSize(y.width,y.height),y.camera.topFov=y.camera.bottomFov=y.camera.fov/2,y.camera.leftFov=y.camera.rightFov=y.camera.aspect*y.camera.fov/2,y.renderer.autoClear=!1,y.renderer.setSize(y.width,y.height),y.renderer.sortObjects=!1,f.appendChild(y.renderer.domElement),f.addEventListener("touchstart",oe,!1),f.addEventListener("mousedown",oe,!1),f.addEventListener("mousemove",ce,!1),(Z=!1)&&(document.exitPointerLock=document.exitPointerLock||document.mozExitPointerLock||document.webkitExitPointerLock,f.requestPointerLock=f.requestPointerLock||f.mozRequestPointerLock||f.webkitRequestPointerLock,document.addEventListener("pointerlockchange",O,!1),document.addEventListener("mozpointerlockchange",O,!1),document.addEventListener("webkitpointerlockchange",O,!1)),I.push(T(e(t+"VChomeS.png"))),I.push(T(e(t+"VCarrowsS0.png"))),I.push(T(e(t+"VCarrowsS1.png"))),I.push(T(e(t+"VChome.png"))),I.push(T(e(t+"VCarrows.png"))),I.push(T(e(t+"VCcontext.png"))),I.push(T(e(t+"VCcontextS.png")))}function u(){this.enabled=!0,this.needsSwap=!0,this.clear=!1,this.renderToScreen=!1,this.renderToColor=!1}function g(e,t){u.call(this),this.scene=e,this.camera=t,this.clear=!0,this.needsSwap=!1,this.inverse=!1}function w(){u.call(this),this.needsSwap=!1}function x(e,t){u.call(this),this.textureID=void 0!==t?t:"tDiffuse",e instanceof THREE.ShaderMaterial?(this.uniforms=e.uniforms,this.material=e):e&&(this.uniforms=THREE.UniformsUtils.clone(e.uniforms),this.material=new THREE.ShaderMaterial({defines:e.defines||{},uniforms:this.uniforms,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader})),this.camera=new THREE.OrthographicCamera(-1,1,1,-1,0,1),this.scene=new THREE.Scene,this.quad=new THREE.Mesh(new THREE.PlaneGeometry(2,2),null),this.quad.frustumCulled=!1,this.scene.add(this.quad)}function Ve(e,t,r){var i;this.renderer=e,void 0===t&&(i={minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat,stencilBuffer:!1},e=e.getSize(),(t=new THREE.WebGLRenderTarget((r||e).width,(r||e).height,i)).texture.name="EffectComposer.rt1"),this.renderTarget1=t,this.renderTarget2=t.clone(),this.renderTarget2.texture.name="EffectComposer.rt2",this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2,this.colorTarget=r||null,this.passes=[],this.copyPass=new x(je)}function b(e,t,r,i,n){u.call(this),this.scene=e,this.camera=t,this.overrideMaterial=r,this.clearColor=i,this.oldClearColor=new THREE.Color,this.clearAlpha=void 0!==n?n:0,this.clear=!0,this.clearDepth=!1,this.needsSwap=!1}function B(e,t,r,i,n){u.call(this),this.scene=e,this.viewer=t,this.overrideMaterial=r,void 0===this.overrideMaterial&&(this.overrideMaterial=new THREE.MeshLambertMaterial({color:0,side:THREE.DoubleSide,polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1})),this.oldClearColor=new THREE.Color,this.clearColor=i,this.clearColor||(this.clearColor=new THREE.Color(16777215)),this.clearAlpha=void 0!==n?n:1,this.clear=!0,this.clearDepth=!1,this.needsSwap=!1,this.selectedMaterial=new THREE.MeshLambertMaterial({color:16711680,side:THREE.DoubleSide,polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1})}function R(){this.bodyFlag=Ce.BODYFLAG.NONE_FLAG,this.bbox=new THREE.Box3,this.coords=[]}var P,H=function(t){function e(){var e=t.call(this)||this;return e.name="",e.prototypeMap=new Map,e.viewer=null,e.__flags__=0,e}r=t,(i=e).prototype=Object.create(r.prototype),h(i.prototype.constructor=i,r);var r,i=e.prototype;return i.overrideValue=function(e,t,r){this.prototypeMap.has(e)||this.prototypeMap.set(e,new Map),this.prototypeMap.get(e).set(t,{type:"value",value:r})},i.overrideFunction=function(e,t,r){this.prototypeMap.has(e)||this.prototypeMap.set(e,new Map),this.prototypeMap.get(e).set(t,{type:"function",value:r})},i.overridePrototype=function(e,t){this.prototypeMap.has(e)||this.prototypeMap.set(e,new Map),this.prototypeMap.get(e).set("",{type:"prototype",value:t})},i.load=function(n){var e;this.isLoad||(this.viewer=n,this.prototypeMap.forEach(function(e,i,t){e.forEach(function(e,t,r){"prototype"===e.type?(e.lastValue=NDSWebViewer[i].prototype,NDSWebViewer[i].prototype=e.value):("Viewer"===i&&n&&(n[t]=e.value),e.lastValue=NDSWebViewer[i].prototype[t],NDSWebViewer[i].prototype[t]=e.value)})}),this.isLoad=!0,this.onLoad&&(this.onLoad(n),e=this,setTimeout(function(){n.dispatchEvent({type:"Pluginloaded",name:e.name})},200)))},i.unload=function(n){this.isLoad&&(this.prototypeMap.forEach(function(e,i,t){e.forEach(function(e,t,r){"prototype"===e.type?NDSWebViewer[i].prototype=e.lastValue:("Viewer"===i&&n&&(n[t]=e.lastValue),NDSWebViewer[i].prototype[t]=e.lastValue)})}),this.isLoad=!1,this.onUnLoad)&&this.onUnLoad()},i.update=function(e){},i.setFlags=function(e){this.__flags__=e},i.matchFlags=function(e){return(this.__flags__&e)===e},e}(THREE.EventDispatcher),He=(H.FLAG_ENABLE_NODE_TRANSFORM=1,function(){function e(){}return e.addExtension=function(e){this.extensions.set(e.name,e)},e.removeExtension=function(e){this.extensions.has(e)&&this.extensions.get(e).unload(),this.extensions.delete(e)},e.getExtension=function(e){return this.extensions.get(e)},e.update=function(i){this.extensions.forEach(function(e,t,r){e.update(i)})},e.clear=function(){this.extensions.forEach(function(e,t,r){"function"==typeof e.clear&&e.clear()})},e.needDisableInputEvent=function(){var i=!1;return this.extensions.forEach(function(e,t,r){if(i)return!0;"function"==typeof e.needDisableInputEvent&&(i=i||e.needDisableInputEvent())}),i},e.getExtensionWithFlags=function(i){var n=[];return this.extensions.forEach(function(e,t,r){e.matchFlags(i)&&n.push(e)}),n},e.onInitLights=function(i){this.extensions.forEach(function(e,t,r){e.onInitLights&&e.onInitLights(i)})},e.onNdsModelPrepareForRendering=function(i){this.extensions.forEach(function(e,t,r){e.onNdsModelPrepareForRendering&&e.onNdsModelPrepareForRendering(i)})},e.onBeforeNdsModelUpdate=function(i,n){this.extensions.forEach(function(e,t,r){e.onBeforeNdsModelUpdate&&e.onBeforeNdsModelUpdate(i,n)})},e.onAfterNdsModelUpdate=function(i,n){this.extensions.forEach(function(e,t,r){e.onAfterNdsModelUpdate&&e.onAfterNdsModelUpdate(i,n)})},e.onBeforeNdsModelSetRender=function(i,n){var e=n._render_,t=n._renderScene_,r=n.render,a=n.renderScene;n.render=e,n.renderScene=t,this.extensions.forEach(function(e,t,r){e.onBeforeNdsModelSetRender&&e.onBeforeNdsModelSetRender(i,n)}),n.render=r,n.renderScene=a},e.onAfterNdsModelSetRender=function(i,n){var e=n._render_,t=n._renderScene_,r=n.render,a=n.renderScene;n.render=e,n.renderScene=t,this.extensions.forEach(function(e,t,r){e.onAfterNdsModelSetRender&&e.onAfterNdsModelSetRender(i,n)}),n.render=r,n.renderScene=a},e.onBeforeNdsMeshRender=function(i,n){this.extensions.forEach(function(e,t,r){e.onBeforeNdsMeshRender&&e.onBeforeNdsMeshRender(i,n)})},e.onAfterAllNdsModelSetRender=function(i,n){this.extensions.forEach(function(e,t,r){e.onAfterAllNdsModelSetRender&&e.onAfterAllNdsModelSetRender(i,n)})},e.onAfterCopyPassRender=function(i){this.extensions.forEach(function(e,t,r){e.onAfterCopyPassRender&&e.onAfterCopyPassRender(i)})},e.onBeforeScreenCapture=function(i){this.extensions.forEach(function(e,t,r){e.onBeforeScreenCapture&&e.onBeforeScreenCapture(i)})},e.onAfterScreenCapture=function(){this.extensions.forEach(function(e,t,r){e.onAfterScreenCapture&&e.onAfterScreenCapture()})},e.onSetCaptureView=function(i,n){this.extensions.forEach(function(e,t,r){e.onSetCaptureView&&e.onSetCaptureView(i,n)})},e.onBeforeChangeBackGroundColor=function(i){this.extensions.forEach(function(e,t,r){e.onBeforeChangeBackGroundColor&&e.onBeforeChangeBackGroundColor(i)})},e.onAfterChangeBackGroundColor=function(i){this.extensions.forEach(function(e,t,r){e.onAfterChangeBackGroundColor&&e.onAfterChangeBackGroundColor(i)})},e.onAfterWindowsResize=function(i,n,a){this.extensions.forEach(function(e,t,r){e.onAfterWindowsResize&&e.onAfterWindowsResize(i,n,a)})},e.onAfterGetBroadcastInfo=function(i){this.extensions.forEach(function(e,t,r){e.onAfterGetBroadcastInfo&&e.onAfterGetBroadcastInfo(i)})},e.onAfterSetBroadcastInfo=function(i){this.extensions.forEach(function(e,t,r){e.onAfterSetBroadcastInfo&&e.onAfterSetBroadcastInfo(i)})},e.updateBroadcastInfo=function(e){var t=this.extensions.get("NDSBroadcastExtension");t&&t.updateExtensionState(e)},e}()),Ge=(He.extensions=new Map,function(m){var s,d,c,h,u,v=this,y=(this.viewer=m).viewBox,n=.5,a=!1,p=null,f=null,g=null,A=null,M=null,o=new THREE.Box3,l=new THREE.Box3,E=null,w=1.5;function x(){v.resetOperationMode(),v.adjustNearAndFar(),v.viewer.dispatchEvent({type:"ZoomFitEvent"})}this.isViewLockedBySingleBody=!1,this.setCameraSize=function(e,t){m.camera.setSize(e,t),m.camera.updateProjectionMatrix()},this.center=function(){return this.viewer.camera.getCameraTarget()},this.setZoomSpeed=function(e){w=e},this.setRotateSpeed=function(e){0},this.StandardView={front:{from:[0,0,1],to:[0,0,0],up:[0,1,0]},back:{from:[0,0,-1],to:[0,0,0],up:[0,1,0]},left:{from:[-1,0,0],to:[0,0,0],up:[0,1,0]},right:{from:[1,0,0],to:[0,0,0],up:[0,1,0]},top:{from:[0,1,0],to:[0,0,0],up:[0,0,-1]},bottom:{from:[0,-1,0],to:[0,0,0],up:[0,0,1]},frontRight:{from:[1,0,1],to:[0,0,0],up:[0,1,0]},leftFront:{from:[-1,0,1],to:[0,0,0],up:[0,1,0]},backLeft:{from:[-1,0,-1],to:[0,0,0],up:[0,1,0]},rightBack:{from:[1,0,-1],to:[0,0,0],up:[0,1,0]},frontUpLeft:{from:[-.5773502691896258,.5773502691896258,.5773502691896258],to:[0,0,0],up:[0,1,0]},bottomRightFront:{from:[.5773502691896258,-.5773502691896258,.5773502691896258],to:[0,0,0],up:[0,1,0]},rightUpFront:{from:[.5773502691896258,.5773502691896258,.5773502691896258],to:[0,0,0],up:[0,1,0]},bottomFrontLeft:{from:[-.5773502691896258,-.5773502691896258,.5773502691896258],to:[0,0,0],up:[0,1,0]},backUpRight:{from:[.5773502691896258,.5773502691896258,-.5773502691896258],to:[0,0,0],up:[0,1,0]},leftUpBack:{from:[-.5773502691896258,.5773502691896258,-.5773502691896258],to:[0,0,0],up:[0,1,0]},bottomBackRight:{from:[.5773502691896258,-.5773502691896258,-.5773502691896258],to:[0,0,0],up:[0,1,0]},bottomLeftBack:{from:[-.5773502691896258,-.5773502691896258,-.5773502691896258],to:[0,0,0],up:[0,1,0]}},this.setViewBox=function(e){(y=e)&&this.updateViewBoxCamDir()},this.setRotateCenter=function(e){M=e},this.getRotateCenter=function(){return M},this.setCameraInfo=function(e,t){null!=e?m.camera.setOrginalCameraInfo({center:new THREE.Vector3(e.target.x,e.target.y,e.target.z),up:new THREE.Vector3(e.up.x,e.up.y,e.up.z),position:new THREE.Vector3(e.position.x,e.position.y,e.position.z),fov:e.fov,near:e.near,far:e.far,isPerspective:e.isPerspective,width:e.width,height:e.height,modelScreenBBox:e.modelScreenBBox}):(this.viewer.camera.setOrginalCameraInfo(void 0),this.viewer.controls.SetBoundingBoxUpdated(!1),this.viewer.camera.up.set(0,1,0),(e=new THREE.Matrix4).lookAt(new THREE.Vector3(1,1,1),new THREE.Vector3,this.viewer.camera.up),this.viewer.camera.quaternion.setFromRotationMatrix(e)),t&&(this.viewer.viewManager?this.viewer.viewManager.updateActiveViewCameraInfo():this.viewer.resetCamera({useOrginal:!0}))},this.getCameraInfo=function(){var e={},t=m.camera,t=(e.fov=t.fov,e.near=t.near,e.far=t.far,e.position={x:t.position.x,y:t.position.y,z:t.position.z},e.up={x:t.up.x,y:t.up.y,z:t.up.z},m.camera.getCameraTarget()),t=(e.target={x:t.x,y:t.y,z:t.z},e.isPerspective=m.camera.isPerspective,e.top=m.camera.top,e.bottom=m.camera.bottom,e.left=m.camera.left,e.right=m.camera.right,m.renderer.getPixelRatio());return e.width=m.renderer.domElement.width/t,e.height=m.renderer.domElement.height/t,e.modelScreenBBox=m.computeModelScreenBBox(),e},this.setAutoRotateSpeed=function(e){n=e},this.setAutoRotationEnabled=function(e){e?a||(a=!0,p=Date.now(),this.autoRotation()):a=!1},this.toggleAutoRotation=function(e){var t=a;a=!a,(a=void 0!==e?e:a)&&!t&&(p=Date.now(),this.autoRotation())},this.autoRotation=function(){var e,t,r,i;De.enableBroadcast&&!De.broadcastMajor||a&&(requestAnimationFrame(function(){v.autoRotation()}),1e3/30<=(t=(e=Date.now())-p))&&(p=e-t%(1e3/30),e=new THREE.Vector3,e=m.controls.getBoundingBox().getCenter(e),(t=new THREE.Vector3).subVectors(m.camera.position,e),i=new THREE.Vector3(0,1,0),(r=new THREE.Quaternion).setFromAxisAngle(i,n*Math.PI/180),t.applyQuaternion(r),(i=new THREE.Vector3).subVectors(m.camera.getCameraTarget(),e),i.applyQuaternion(r),m.camera.getCameraTarget().addVectors(e,i),m.camera.up.applyQuaternion(r),m.camera.position.addVectors(e,t),m.camera.setCameraTarget(m.camera.getCameraTarget()),m.render(),y)&&v.updateViewBoxCamQuaternion(r)},this.look=function(e){var t=[1,1,1],r=[0,0,0],i=[0,1,0],n=("hall"==m.getModelOperationMode()&&(t=[0,0,1]),void 0!==e&&(void 0!==e.type&&void 0!==v.StandardView[e.type]?(t=v.StandardView[e.type].from,r=v.StandardView[e.type].to,i=v.StandardView[e.type].up):(void 0!==e.from&&(t=e.from),void 0!==e.to&&(r=e.to)),void 0!==e.up)&&(i=e.up),new THREE.Vector3),a=new THREE.Vector3,o=new THREE.Vector3,a=a.fromArray(r).sub(n.fromArray(t)),r=(a.normalize(),{dir:a,up:o.fromArray(i),callback:e.callback,sphericalTransition:e.sphericalTransition,animationSpeed:e.animationSpeed,viewCapture:e.viewCapture});void 0!==e&&void 0!==e.smoothTranslation?v.zoomExtents(e.smoothTranslation,e.useOrginal,r,!0):v.zoomExtents(void 0,e.useOrginal,r,!0)},this.zoomExtents=function(e,t,r,i){var n=new THREE.Vector3,a=new THREE.Vector3,o={flag:!0},s=m.controls.IsBoundingBoxUpdated();if(0<m.isolateMeshes.length&&(null==i||0==i))m.computeMeshesBoundingBox(m.isolateMeshes,n,a,o);else if(s)n.copy(m.controls.getBoundingBox().min),a.copy(m.controls.getBoundingBox().max);else{if(m.computeBoundingBox(m.scene,n,a,o),n.x>a.x||n.y>a.y||n.z>a.z)return;m.controls.setBoundingBox(n,a)}r&&r.viewCapture&&m.computeVisibleBoundingBox(m.scene,n,a,{},void 0,!0);i=new THREE.Vector3,i.x=.5*(a.x+n.x),i.y=.5*(a.y+n.y),i.z=.5*(a.z+n.z),o=new THREE.Vector3;(o=o.subVectors(a,n)).length()<1e-6&&o.set(1,1,1);var l=.5*o.length()/Math.sin(Math.PI/180*m.camera.fov*.5),o=(m.camera.IsPerspective()&&m.camera.aspect<1&&(l/=m.camera.aspect),0==l&&(l=1e-4),1!=Number(m.disratio)&&(l*=Number(m.disratio)),m.camera.far=5*l,m.camera.setZoomToFitRatio(5),m.camera.far<1e3&&(m.camera.setZoomToFitRatio(1e3/l),m.camera.far=1e3),2e3<m.camera.far/m.camera.near&&(m.camera.near=m.camera.far/2e3),m.camera.near>.25*o.length()&&(m.camera.near=.25*o.length()),m.camera.perpNear>.25*o.length()&&(m.camera.perpNear=.25*o.length()),null),d=null;if(r?((o=r.dir.clone().normalize()).multiplyScalar(l),d=i.clone().sub(o)):((o=new THREE.Vector3(0,0,1).applyQuaternion(m.camera.quaternion)).multiplyScalar(l),(d=new THREE.Vector3).addVectors(i,o)),s||(m.groundShadow.updateGroundTransform(m.camera,m.controls.getBoundingBox()),m.is2DModel?m.camera.setOrthoNear(m.modelRootObject.boundingBox.clone()):m.camera.setOrthoNear(m.controls.getBoundingBox()),m.camera.getOrginalCameraInfo())||m.camera.setOrginalCameraInfo({center:i.clone(),up:r?r.up.clone():new THREE.Vector3(0,1,0),position:d}),!0===t&&m.camera.getOrginalCameraInfo()&&(i.copy(m.camera.getOrginalCameraInfo().center),d.copy(m.camera.getOrginalCameraInfo().position),m.camera.getOrginalCameraInfo().fov&&(m.camera.fov=m.camera.getOrginalCameraInfo().fov),m.camera.getOrginalCameraInfo().near&&m.camera.IsPerspective()==m.camera.getOrginalCameraInfo().isPerspective&&(m.camera.near=m.camera.getOrginalCameraInfo().near),m.camera.getOrginalCameraInfo().far)&&m.camera.IsPerspective()==m.camera.getOrginalCameraInfo().isPerspective&&(m.camera.far=m.camera.getOrginalCameraInfo().far),m.camera.updateProjectionMatrix(),m.camera.updateMatrixWorld(!0),r&&r.viewCapture){var c,l=1,l=m.camera.isPerspective?(c=new THREE.PerspectiveCamera(m.camera.fov,m.camera.aspect,m.camera.near,m.camera.far),1.3):(c=new THREE.OrthographicCamera(m.camera.left,m.camera.right,m.camera.top,m.camera.bottom,m.camera.near,m.camera.far),1.2);c.position.copy(d),c.up.copy(r.up),c.lookAt(i),c.updateProjectionMatrix(),c.updateMatrixWorld(!0);for(var o=new THREE.Box3(n,a),s=o.min,n=o.max,h=[new THREE.Vector3(s.x,s.y,s.z),new THREE.Vector3(s.x,s.y,n.z),new THREE.Vector3(s.x,n.y,s.z),new THREE.Vector3(s.x,n.y,n.z),new THREE.Vector3(n.x,s.y,s.z),new THREE.Vector3(n.x,s.y,n.z),new THREE.Vector3(n.x,n.y,s.z),new THREE.Vector3(n.x,n.y,n.z)],u=0;u<h.length;u++)h[u].project(c);var p=[],f=[],a=(h.forEach(function(e){p.push(e.x),f.push(e.y)}),i.clone()),o=(a.project(c),new THREE.Vector3(Math.min.apply(Math,p),Math.min.apply(Math,f),a.z)),s=new THREE.Vector3(Math.max.apply(Math,p),Math.max.apply(Math,f),a.z),n=new THREE.Vector3(Math.min.apply(Math,p),Math.max.apply(Math,f),a.z),a=new THREE.Vector3(Math.max.apply(Math,p),Math.min.apply(Math,f),a.z),s=(o.unproject(c),s.unproject(c),n.unproject(c),a.unproject(c),o.distanceTo(n)),n=o.distanceTo(a),o=m.renderer.domElement,a=o.width/o.height,o=n/s,n=0,n=o<a?s/Math.tan(Math.PI/180*m.camera.fov*.5)*.5*l:s/Math.tan(Math.PI/180*m.camera.fov*.5)*.5*o/a*l,s=r.dir.clone().normalize();s.multiplyScalar(n),d=i.clone().sub(s)}void 0===e||e?(o={center:i,up:(r||m.camera).up.clone(),position:d},!0===t&&m.camera.getOrginalCameraInfo()&&m.camera.getOrginalCameraInfo().up&&(o.up=m.camera.getOrginalCameraInfo().up),r&&r.animationSpeed&&(o.animationSpeed=r.animationSpeed),r&&!0===r.sphericalTransition?v.sphericalTransition(o,r.callback):m.startSmoothTranslation(o,x)):(r&&r.up&&m.camera.up.copy(r.up.clone()),!0===t&&m.camera.getOrginalCameraInfo()&&m.camera.getOrginalCameraInfo().up&&m.camera.up.copy(m.camera.getOrginalCameraInfo().up),m.camera.position.copy(d),m.camera.setCameraTarget(i),m.camera.updateProjectionMatrix(),m.camera.updateMatrixWorld(!0),y&&v.updateViewBoxCamDir(),m.render(),x()),De.autoSwitchFirstPersonView&&"FirstPerson"==m.getModelOperationMode()&&m.setModelOperationModeInternal(m.originalModelOperationMode)},this.sphericalTransition=function(e,o){var s,l,t,r,d,c,i,n,a,h,u;p=Date.now(),f=0,null==g&&(s=new THREE.Quaternion,l=new THREE.Quaternion,t=new THREE.Quaternion,r=new THREE.Quaternion,d=m.camera.getCameraTarget().clone().sub(m.camera.position).length(),c=e.center.clone().sub(e.position).length(),i=e.center.clone().sub(e.position).normalize(),h=(a=(n=m.camera.getCameraTarget().clone().sub(m.camera.position).normalize()).clone().cross(m.camera.up).normalize()).clone().cross(n).normalize(),(u=new THREE.Matrix4).set(n.x,h.x,a.x,0,n.y,h.y,a.y,0,n.z,h.z,a.z,0,0,0,0,1),s.setFromRotationMatrix(u),h=(a=(n=i).clone().cross(e.up).normalize()).clone().cross(n).normalize(),u.set(n.x,h.x,a.x,0,n.y,h.y,a.y,0,n.z,h.z,a.z,0,0,0,0,1),t.setFromAxisAngle(n,0),r.setFromAxisAngle(h,0),l.setFromRotationMatrix(u),l.multiply(t).multiply(r).normalize(),function e(t,r){var i,n,a;De.enableBroadcast&&!De.broadcastMajor||(n=m.camera.position.distanceToSquared(t.position),(i=new THREE.Vector3).subVectors(m.camera.up,t.up),n=n<1e-6&&Math.abs(i.x)<1e-5&&Math.abs(i.y)<1e-5&&Math.abs(i.z)<1e-5,!m.getEnableSmoothTranslation()||1<=f||n?(f=1,m.camera.position.copy(t.position),m.camera.up.copy(t.up),m.camera.setCameraTarget(t.center.clone()),m.camera.lookAt(v.center()),m.camera.updateMatrixWorld(!0),m.camera.updateProjectionMatrix(),m.render(),y&&(i=t.center.clone().sub(t.position),(n=y.center.clone().sub(i).normalize()).multiplyScalar(y.viewScale),y.camera.position.copy(n),y.camera.up.copy(t.up),y.camera.lookAt(y.center),y.render()),null!=g&&cancelAnimationFrame(g),g=null,y&&y.render(),void 0!==(i=m.getLoadingManager()).onSmoothTranslationDone&&i.onSmoothTranslationDone(),r&&r()):(i=1-(n=Pe.linearClamp(f,0,1)),a=(r=Date.now())-p,p=r,t.animationSpeed?f+=a/t.animationSpeed:f+=a/500,r=new THREE.Matrix4,(a=s.clone()).slerp(l,n),r.makeRotationFromQuaternion(a),a=Pe.linearInterp(n,d,c),r=r.elements,i=m.camera.getCameraTarget().clone().multiplyScalar(i).add(t.center.clone().multiplyScalar(n)),n=t.center.clone().sub(new THREE.Vector3(r[0],r[1],r[2]).multiplyScalar(a)),a=new THREE.Vector3(r[4],r[5],r[6]),m.camera.position.copy(n),m.camera.up.copy(a),m.camera.setCameraTarget(i),m.camera.updateProjectionMatrix(),m.render(),y&&(n=y.center.clone().sub(new THREE.Vector3(r[0],r[1],r[2]).multiplyScalar(y.viewScale)),y.camera.position.copy(n),y.camera.up.copy(a),y.camera.lookAt(y.center),y.render()),g=requestAnimationFrame(function(){e(t,o)})))}(e,o))},this.startSmoothTranslation=function(e,t){p=Date.now(),f=0,null!=g&&(cancelAnimationFrame(g),g=null),v.smoothTranslation(e,t)},this.isSmoothTranslationDone=function(){return null==g},this.smoothTranslation=function(e,t){var r,i,n,a,o,s;De.enableBroadcast&&!De.broadcastMajor||e&&(a=m.camera.position.distanceToSquared(e.position),(i=new THREE.Vector3).subVectors(m.camera.up,e.up),n=e.center.clone().sub(e.position),y&&(r=y.center.clone().sub(n).normalize()).multiplyScalar(y.viewScale),n=a<1e-6&&Math.abs(i.x)<1e-5&&Math.abs(i.y)<1e-5&&Math.abs(i.z)<1e-5,!m.getEnableSmoothTranslation()||1<=f||n?(f=1,m.camera.position.copy(e.position),m.camera.up.copy(e.up),m.camera.setCameraTarget(e.center.clone()),m.camera.lookAt(v.center()),m.camera.updateMatrixWorld(!0),m.camera.updateProjectionMatrix(),m.render(),y&&(y.camera.position.copy(r),y.camera.up.copy(e.up),y.camera.lookAt(y.center),v.updateViewBoxCamDir()),null!=g&&cancelAnimationFrame(g),g=null,y&&y.render(),void 0!==(a=m.getLoadingManager()).onSmoothTranslationDone&&a.onSmoothTranslationDone(),t&&t(),De.enableBroadcast&&De.broadcastMajor&&He.updateBroadcastInfo("generalInfo")):(n=1-(i=Pe.linearClamp(f,0,1)),o=(a=Date.now())-p,p=a,e.animationSpeed?f+=o/e.animationSpeed:f+=o/1e3,a=m.camera.getCameraTarget().clone().multiplyScalar(n).add(e.center.clone().multiplyScalar(i)),o=m.camera.position.clone().multiplyScalar(n).add(e.position.clone().multiplyScalar(i)),s=m.camera.up.clone().multiplyScalar(n).add(e.up.clone().multiplyScalar(i)),m.camera.position.copy(o),m.camera.up.copy(s),m.camera.setCameraTarget(a),m.camera.updateProjectionMatrix(),m.camera.updateMatrixWorld(!0),m.render(),y&&((o=y.camera.position.clone().multiplyScalar(n).add(r.clone().multiplyScalar(i))).normalize(),o.multiplyScalar(y.viewScale),y.camera.position.copy(o),y.camera.up.copy(s),y.camera.lookAt(y.center),y.render()),g=requestAnimationFrame(function(){v.smoothTranslation(e,t)})))},this.resetOperationMode=function(){var e=m.getModelOperationMode();De.autoSwitchFirstPersonView&&"FirstPerson"==e&&!m.controls.getBoundingBox().containsPoint(m.camera.position)&&m.setModelOperationModeInternal(m.originalModelOperationMode)},this.orthographicPMI=(s=new THREE.Box3,d=null,c=new THREE.Matrix4,h=new THREE.Matrix4,u=new THREE.Matrix4,function(e){function l(e){if(e.geometry&&(e.textOrSymbolObject||e.geometry.TextBox))return t=new THREE.Line3(new THREE.Vector3(0,0,0),new THREE.Vector3(0,100,0)),r=new THREE.Line3(new THREE.Vector3(0,0,100),new THREE.Vector3(0,0,0)),t.applyMatrix4(e.matrixWorld),t.start.sub(t.end),r.applyMatrix4(e.matrixWorld),r.start.sub(r.end),{up:t.start.normalize().negate(),dir:r.start.normalize().negate()};if(e.geometry&&e.geometry.attributes.instanceStart){var t=e.geometry.attributes.instanceStart.data.array,r=new THREE.Vector3,i=new THREE.Vector3,t=(r.fromArray(t,0).applyMatrix4(e.matrixWorld),i.fromArray(t,3).applyMatrix4(e.matrixWorld),(new THREE.Vector3).subVectors(r,i));if(d){if(1e-4<d.clone().cross(t).length())return{up:null,dir:(new THREE.Vector3).crossVectors(d,t).normalize()}}else d=t}for(var n=e.children,a=0,o=n.length;a<o;a++){var s=l(n[a]);if(s)return s}return null}function o(e,t){e.updateWorldMatrix(!1,!1),void 0!==e.boundingBox?(null===e.boundingBox&&e.computeBoundingBox(),s.copy(e.boundingBox),s.applyMatrix4(e.matrixWorld),t.union(s)):void 0!==(r=e.geometry)&&(null===r.boundingBox&&r.computeBoundingBox(),r=r.TextBox||r.boundingBox,s.copy(r),s.applyMatrix4(e.matrixWorld),t.union(s));for(var r,i=e.children,n=0,a=i.length;n<a;n++)o(i[n],t)}var t,r,i,n,a;if(!((e=e instanceof _e?this.viewer.ndsModel.getModelById(e.ndsModel.id).PMIUUIDtoPMIObject[e.uuid]:e).fixedPmi&&e.fixedBox&&e.followCamera))return!e.followCamera||"Mesh"===e.type&&"TextBufferGeometry"===e.geometry.type||(c.copy(e.parent.matrixWorld),h.copy(e.matrixWorld),e.matrix.copy(h.premultiply(u.getInverse(c)))),o(e,t=new THREE.Box3),d=null,(n=l(e))&&(r=n.dir,i=n.up),e.followCamera?(r=this.center().clone().sub(m.camera.position).normalize(),i=m.camera.up):r=r||(Math.abs(t.min.x-t.max.x)<1e-4?new THREE.Vector3(-1,0,0):Math.abs(t.min.y-t.max.y)<1e-4?new THREE.Vector3(0,-1,0):Math.abs(t.min.z-t.max.z)<1e-4?new THREE.Vector3(0,0,-1):(n=new THREE.Vector3(t.min.x,t.min.y,t.min.z),e=new THREE.Vector3(t.max.x,t.min.y,t.max.z),a=new THREE.Vector3(t.max.x,t.max.y,t.max.z),e=(new THREE.Vector3).subVectors(e,n),a=(new THREE.Vector3).subVectors(a,n),(new THREE.Vector3).crossVectors(e,a).normalize().negate())),{box:t,destCam:{dir:r.negate(),up:i||new THREE.Vector3(0,1,0)}}}),this.zoomToObject=function(e,t){var r=!(e instanceof _e&&!("PMI"===e.type||e.parent&&"PMI"===e.parent.type));r?(r=this.orthographicPMI(e))&&this.zoomToObjectByBbox(r.box,t,r.destCam):(r=new THREE.Box3,m.computeBoundingBox(e,r.min,r.max,{flag:!0}),this.zoomToObjectByBbox(r,t))},this.zoomToObjectByBbox=function(e,t,r){void 0===r&&(r={});var i=e.min,e=e.max,n=m.controls.IsBoundingBoxUpdated(),a=new THREE.Vector3,o=(a.x=.5*(e.x+i.x),a.y=.5*(e.y+i.y),a.z=.5*(e.z+i.z),new THREE.Vector3);(e=.5*(o=o.subVectors(e,i)).length())<1e-6||(i=e/Math.sin(Math.PI/180*m.camera.fov*.5),m.camera.IsPerspective()&&m.camera.aspect<1&&(i/=m.camera.aspect),m.camera.far<5*(i=0==i?1e-4:i)&&(m.camera.far=5*i),m.camera.setZoomToFitRatio(5),m.camera.far<1e3&&(m.camera.setZoomToFitRatio(1e3/i),m.camera.far=1e3),2e3<m.camera.far/m.camera.near&&(m.camera.near=m.camera.far/2e3),m.camera.near>.5*o.length()&&(m.camera.near=.25*o.length()),e=new THREE.Vector3(0,0,1).applyQuaternion(m.camera.quaternion),(e=r.dir?r.dir:e).multiplyScalar(i),(o=new THREE.Vector3).addVectors(a,e),n||(m.groundShadow.updateGroundTransform(m.camera,m.controls.getBoundingBox()),m.camera.setOrthoNear(m.controls.getBoundingBox()),m.camera.getOrginalCameraInfo())||m.camera.setOrginalCameraInfo({center:a.clone(),up:r.up||new THREE.Vector3(0,1,0),position:o}),m.camera.updateProjectionMatrix(),void 0===t||t?(i={center:a,up:r.up||m.camera.up,position:o},v.startSmoothTranslation(i,x)):(m.camera.position.copy(o),m.camera.setCameraTarget(a),r.up&&m.camera.up.copy(r.up),m.render(),x()),e=m.controls.getBoundingBox().containsPoint(o),n=m.getModelOperationMode(),De.autoSwitchFirstPersonView&&"hall"!=n&&(e?"FirstPerson"!=n&&m.setModelOperationModeInternal("FirstPerson"):"FirstPerson"==n&&m.setModelOperationModeInternal(m.originalModelOperationMode)))},this.setModelUpDirection=function(e,t){var r=-1,i=He.getExtension("ExplodeModelExtension"),n=i?i.getExplodeFactor():-1;0<n&&(r=n,m.Optoolbar?m.Optoolbar.resetExplosion():i.onExplode(0)),m.initModelUpDirection(e),m.scene.updateMatrixWorld(!0),m.controls.SetBoundingBoxUpdated(!1),m.scene.remove(m.lightControls._scene),m.scene.traverse(function(e){e.hasOwnProperty("geometry")&&(e.matrixWorldTransOrginal&&(e.matrixWorldTransOrginal=void 0),e.matrixWorldTransOrginalDrag)&&(e.matrixWorldTransOrginalDrag=void 0)}),m.scene.add(m.lightControls._scene),null!=m.modelSceneOrgin&&m.modelSceneOrgin!=m.scene&&(m.modelSceneOrgin.updateMatrixWorld(!0),m.modelSceneOrgin.traverse(function(e){e.hasOwnProperty("geometry")&&(e.matrixWorldTransOrginal&&(e.matrixWorldTransOrginal=void 0),e.matrixWorldTransOrginalDrag)&&(e.matrixWorldTransOrginalDrag=void 0)})),0!=t&&(n=m.camera.getOrginalCameraInfo(),m.camera.setOrginalCameraInfo(void 0),m.camera.up.set(0,1,0),(e=new THREE.Matrix4).lookAt(new THREE.Vector3(1,1,1),new THREE.Vector3,m.camera.up),m.camera.quaternion.setFromRotationMatrix(e),m.resetCamera({useOrginal:!0}),n)&&null!=n.fov&&m.camera.setOrginalCameraInfo(n),0<r&&i&&i.onExplode(r)},this.onOperationModeChange=function(e){m.camera.setOrginalCameraInfo(void 0),m.camera.up.set(0,1,0);var t=new THREE.Matrix4,r=(t.lookAt(new THREE.Vector3(1,1,1),new THREE.Vector3,m.camera.up),m.camera.quaternion.setFromRotationMatrix(t),.5*Math.PI-m.camera.up.angleTo(new THREE.Vector3(1,1,1).normalize())),i=m.getModelOperationVerticalRotationRange();null!=i&&Math.abs(i.y)*Math.PI/180<r&&(Math.abs(i.y)<4.5?t.lookAt(new THREE.Vector3(1,0,1),new THREE.Vector3,m.camera.up):t.lookAt(new THREE.Vector3(1,.1,1),new THREE.Vector3,m.camera.up),m.camera.quaternion.setFromRotationMatrix(t)),0!=e&&m.resetCamera({useOrginal:!0})},this.rotateToPlane=function(e){this.viewer.camera.updateMatrixWorld(!0);var t=new THREE.Vector3(0,0,1),r=(new THREE.Vector3,new THREE.Vector3),i=new THREE.Vector3,n=(i.copy(e.normal),new THREE.Vector3),a=new THREE.Vector3,o=new THREE.Vector3,o=(e.projectPoint(new THREE.Vector3(0,0,0),n),e.projectPoint(new THREE.Vector3(10,0,0),a),e.projectPoint(new THREE.Vector3(0,10,0),o),r.subVectors(o,n).normalize(),(new THREE.Vector3).crossVectors(r,i).length()<1e-4&&r.subVectors(a,n).normalize(),Math.abs(r.x<1e-5)&&Math.abs(r.y<1e-5)&&Math.abs(r.z<1e-5)&&(r=t),e=(new THREE.Vector3).crossVectors(r,i).normalize(),(new THREE.Matrix3).set(e.x,e.y,e.z,r.x,r.y,r.z,i.x,i.y,i.z).transpose()),a=(new THREE.Matrix3).copy(o).transpose(),t=new THREE.Vector3,t=this.viewer.controls.getBoundingBox().getCenter(t),e=(new THREE.Vector3).copy(t);return e.addScaledVector(i,this.viewer.camera.position.distanceTo(t)),this.viewer.camera.up.set(r.x,r.y,r.z),this.viewer.camera.position.copy(e),this.center().copy(t),this.adjustNearAndFar(),this.viewer.camera.lookAt(this.center()),this.viewer.camera.updateMatrixWorld(!0),y&&v.updateViewBoxCamDir(),{origin:n,matrix:o,matrixInvert:a}},this.rotateByTrackBall=function(e,t,r){var i,n,a,o,s=this.viewer.renderer.getPixelRatio(),l=2*Math.PI*(e.pointer.x-e.pointerOld.x)*s/this.viewer.renderer.domElement.width,s=-2*Math.PI*(e.pointer.y-e.pointerOld.y)*s/this.viewer.renderer.domElement.height;this.viewer.camera.updateMatrixWorld(!0),t.length()&&(t=null,t=r?this.center().clone():this.viewer.controls.getBoundingBox().getCenter(new THREE.Vector3),null!=M&&(t=M),(a=new THREE.Vector3).subVectors(this.viewer.camera.position,t),(i=new THREE.Vector3(0,0,0)).unproject(this.viewer.camera),(o=new THREE.Vector3(10,0,0)).unproject(this.viewer.camera),o.sub(i).normalize(),(n=new THREE.Vector3(0,10,0)).unproject(this.viewer.camera),n.sub(i).normalize(),(i=new THREE.Quaternion).setFromAxisAngle(n,-l),(n=new THREE.Quaternion).setFromAxisAngle(o,s),a.applyQuaternion(i),a.applyQuaternion(n),(l=new THREE.Vector3).addVectors(t,a),(o=new THREE.Vector3).subVectors(this.center(),t),s=this.center().clone(),!0!==r&&(o.applyQuaternion(i),o.applyQuaternion(n),s.addVectors(t,o)),this.viewer.camera.up.applyQuaternion(i),this.viewer.camera.up.applyQuaternion(n),this.viewer.camera.position.copy(l),this.center().copy(s),this.adjustNearAndFar(),this.viewer.camera.lookAt(this.center()),this.viewer.camera.updateMatrixWorld(!0),a=this.viewer.getCameraInfo(),r=new THREE.Vector3(a.position.x-a.target.x,a.position.y-a.target.y,a.position.z-a.target.z),t=(new THREE.Quaternion).setFromUnitVectors(new THREE.Vector3(0,0,1).normalize(),r.normalize()),o=(new THREE.Euler).setFromQuaternion(t),this.viewer.ScenarioEditorInfo.EulerAngle.set(o.x,o.y,o.z),this.viewer.dispatchEvent({type:"Eulerchange",x:180*o.x/Math.PI,y:180*o.y/Math.PI,z:180*o.z/Math.PI}),e.render(),y)&&v.updateViewBoxCamDir()},this.rotateByHall=function(e,t){var r=this.viewer.renderer.getPixelRatio(),i=2*Math.PI*(e.pointer.x-e.pointerOld.x)*r/this.viewer.renderer.domElement.width,r=-2*Math.PI*(e.pointer.y-e.pointerOld.y)*r/this.viewer.renderer.domElement.height,n=(this.viewer.camera.updateMatrixWorld(!0),new THREE.Vector3(0,0,1));if(n.unproject(this.viewer.camera),!isFinite(n.x)||!isFinite(n.y)||!isFinite(n.z))return!1;var a=new THREE.Vector3(.25,0,1);if(a.unproject(this.viewer.camera),!isFinite(a.x)||!isFinite(a.y)||!isFinite(a.z))return!1;a.sub(n).normalize();var n=null,n=t?this.center().clone():this.viewer.controls.getBoundingBox().getCenter(new THREE.Vector3),t=(0!=i&&(r*=.25),new THREE.Quaternion),i=(t.setFromAxisAngle(THREE.Object3D.DefaultUp,-i),new THREE.Quaternion),a=(i.setFromAxisAngle(a,r),new THREE.Vector3),r=(a.subVectors(this.viewer.camera.position,n),a.applyQuaternion(t),a.applyQuaternion(i),new THREE.Vector3),i=(r.subVectors(this.center(),n),r.applyQuaternion(t),r.applyQuaternion(i),(new THREE.Vector3).subVectors((new THREE.Vector3).addVectors(n,a),(new THREE.Vector3).addVectors(n,r))),i=(i.normalize(),i.angleTo(THREE.Object3D.DefaultUp)),o=this.viewer.getModelOperationVerticalRotationRange(),s=.06*Math.PI,l=(null!=o&&(s=Math.max(s,.5*Math.PI-Math.abs(o.y)*Math.PI/180)),.94*Math.PI);null!=o&&(l=Math.min(l,.5*Math.PI+Math.abs(o.x)*Math.PI/180)),(i<s||l<i)&&(r.subVectors(this.center(),n),r.applyQuaternion(t),a.subVectors(this.viewer.camera.position,n),a.applyQuaternion(t)),this.center().addVectors(n,r),this.viewer.camera.position.addVectors(n,a),this.adjustNearAndFar(),this.viewer.camera.lookAt(this.center()),e.render(),y&&v.updateViewBoxCamDir()},this.rotateByBim=function(e,t){var r=this.viewer.renderer.getPixelRatio(),i=2*Math.PI*(e.pointer.x-e.pointerOld.x)*r/this.viewer.renderer.domElement.width,r=-2*Math.PI*(e.pointer.y-e.pointerOld.y)*r/this.viewer.renderer.domElement.height,n=new THREE.Vector3(0,1,0),a=(this.viewer.camera.updateMatrixWorld(!0),new THREE.Vector3(0,0,0));if(a.unproject(this.viewer.camera),!isFinite(a.x)||!isFinite(a.y)||!isFinite(a.z))return!1;var o=new THREE.Vector3(10,0,0);if(o.unproject(this.viewer.camera),!isFinite(o.x)||!isFinite(o.y)||!isFinite(o.z))return!1;o.sub(a).normalize();var s,l=this.viewer.camera.position.clone(),d=this.center().clone(),c=this.viewer.camera.up.clone(),h=null,h=t?this.center().clone():this.viewer.controls.getBoundingBox().getCenter(new THREE.Vector3),u=(null!=M&&(h=M),new THREE.Vector3),p=(u.subVectors(this.viewer.camera.position,h),new THREE.Quaternion),i=(p.setFromAxisAngle(n,-i),new THREE.Quaternion),r=(i.setFromAxisAngle(o,r),u.applyQuaternion(i),u.applyQuaternion(p),new THREE.Vector3),f=(r.addVectors(h,u),new THREE.Vector3),m=(f.subVectors(this.center(),h),this.center().clone()),i=(!0!==t&&(f.applyQuaternion(i),f.applyQuaternion(p),m.addVectors(h,f)),this.viewer.camera.up.applyQuaternion(i),this.viewer.camera.up.applyQuaternion(p),this.viewer.camera.position.copy(r),this.center().copy(m),this.viewer.camera.lookAt(this.center()),this.viewer.camera.updateMatrixWorld(!0),a.set(0,0,0),a.unproject(this.viewer.camera),o.set(10,0,0),o.unproject(this.viewer.camera),o.sub(a).normalize(),new THREE.Vector3(0,10,0)),r=(i.unproject(this.viewer.camera),i.sub(a).normalize(),!0),m=this.viewer.getModelOperationVerticalRotationRange(),a=Math.min(Math.PI,Math.abs(m.x)*Math.PI/180),m=Math.min(Math.PI,Math.abs(m.y)*Math.PI/180),g=n.angleTo(i);1e-6<g&&((s=new THREE.Vector3).crossVectors(i,n),s.normalize(),s.dot(o)<0?a<g&&(r=!1):m<g&&(r=!1)),this.adjustNearAndFar(),r||(this.viewer.camera.up.copy(c),this.viewer.camera.up.applyQuaternion(p),u.subVectors(l,h),u.applyQuaternion(p),this.viewer.camera.position.addVectors(h,u),!0!==t&&(f.subVectors(d,h),f.applyQuaternion(p)),this.center().addVectors(h,f),this.viewer.camera.lookAt(this.center())),e.render(),y&&v.updateViewBoxCamDir()},this.rotateByFirstPerson=function(e,t){var r=this.viewer.renderer.getPixelRatio(),i=2*Math.PI*(e.pointer.x-e.pointerOld.x)*r/this.viewer.renderer.domElement.width,r=-.5*Math.PI*(e.pointer.y-e.pointerOld.y)*r/this.viewer.renderer.domElement.height,n=(this.viewer.camera.updateMatrixWorld(!0),this.viewer.camera.position),a=this.center(),o=this.viewer.camera.up,s=(1e-7<o.distanceTo(new THREE.Vector3(0,1,0))&&o.set(0,1,0),new THREE.Vector3),i=(s.subVectors(a,n),s.applyAxisAngle(o,-i),s.clone().normalize()),l=i.clone(),d=(i.negate(),new THREE.Vector3);i.equals(o)||l.equals(o)?d.set(1,0,0):(d.crossVectors(o,i),d.normalize()),e.latAngle-=r,e.latAngle>-.25*Math.PI&&e.latAngle<.25*Math.PI?s.applyAxisAngle(d,r):e.latAngle+=r,a.addVectors(n,s),this.adjustNearAndFar(),this.viewer.camera.lookAt(a),e.render(),y&&v.updateViewBoxCamDir()},this.calFarthestDistToCamera=function(){var e=this.viewer.controls.getBoundingBox(),t=e.getCenter(new THREE.Vector3),e=.5*(new THREE.Vector3).subVectors(e.max,e.min).length(),t=this.viewer.camera.position.distanceTo(t);return t+=e},this.pan=function(e,t,r){var i=void 0,n=(this.viewer.viewManager&&null!=this.viewer.camera.viewId&&(n=this.viewer.viewManager.getActiveView()).viewId!=this.viewer.camera.viewId&&(i=this.viewer.camera,this.viewer.camera=n.camera),[e.downModelPnt.x,e.downModelPnt.y,e.downModelPnt.z]),n=this.viewer.modelCoordToClientCoord(n),t=[n[0]+t.x,n[1]-t.y,n[2]],n=this.viewer.clientCoordToModelCoord(t),t=new THREE.Vector3(n[0],n[1],n[2]).clone();t.sub(e.downModelPnt),this.viewer.camera.position.add(t),this.center().add(t),void 0!==i&&(this.viewer.camera=i),!1!==r&&e.render()},this.moveForwardBack=function(e,t,r){var i=this.center(),n=this.viewer.camera.position,a=(n.distanceTo(i),new THREE.Vector3),i=(a.subVectors(i,n),.03);this.viewer.controls.getBoundingBox().containsPoint(this.viewer.camera.position)&&(i=.01),a.multiplyScalar(i),0==t&&a.negate(),this.viewer.camera.position.add(a),this.center().add(a),!1!==r&&m.render()},this.setBoundingBox=function(e,t){o.set(e,t),E=o.getCenter(new THREE.Vector3)},this.setBoundingBoxCenter=function(e){E=e},this.adjustNearAndFar=function(){var t,e,r,i;this.viewer.is2DModel||(t=null,t=(E?o:this.viewer.controls.getBoundingBox()).clone(),this.viewer.pmiObject&&(i=this.viewer.calculatePMIBoundingBox())&&!t.containsBox(i)&&t.union(i),this.viewer.controls.staticDrawGeomOp&&this.viewer.controls.staticDrawGeomOp.drawScene&&this.viewer.controls.staticDrawGeomOp.drawScene.children.forEach(function(e){e.visible&&(e=l.copy(e.geometry.boundingBox).applyMatrix4(e.matrixWorld))&&!t.containsBox(e)&&t.union(e)}),i=new THREE.Vector3,t.getCenter(i),e=t.min.distanceTo(t.max),r=this.viewer.camera.position.clone(),i=Math.abs(i.distanceTo(r))+1.2*e,this.viewer.camera.adjustNearFar(i,i))},this.zoom=function(e,t,r,i){if(this.viewer.is2DViewer)(a=this.camDisTo2DViewer())<this.viewer.camera.near+.1&&t.z<0||(t.multiplyScalar(1e-4*a),t.length()>a)||(t.applyMatrix3(e.normalMatrix.getNormalMatrix(this.viewer.camera.matrix)),n=this.viewer.camera.IsPerspective(),this.viewer.camera.position.add(t),n&&this.center().add(t),this.adjustNearAndFar(),this.viewer.camera.updateProjectionMatrix(),!1!==i&&e.render());else{if(this.viewer.viewManager&&this.viewer.viewManager.getActiveView().is2DView)this.setZoomSpeed(this.viewer.viewManager.defaultMultiViewZoomSpeed);else if(this.setZoomSpeed(1.5),r){if(this.zoomByMouse(e,t,r,i))return}else if("hall"==this.viewer.getModelOperationMode())return void(0!=t.z&&(0<t.z?t.z=30:t.z=-30,this.zoomByMouse(e,t,{offsetX:0,offsetY:0},i)));var n=this.viewer.camera.IsPerspective(),a=this.viewer.camera.position.distanceTo(this.center());a*=w/1.5,t.multiplyScalar(1e-4*a),t.applyMatrix3(e.normalMatrix.getNormalMatrix(this.viewer.camera.matrix)),this.viewer.camera.position.add(t),n&&this.center().add(t),this.adjustNearAndFar(),this.viewer.camera.updateProjectionMatrix(),0<t.z&&(r=this.calFarthestDistToCamera())>this.viewer.camera.far&&(this.viewer.camera.far=r),!1!==i&&e.render()}},this.zoomByMouse=function(e,t,r,i){var n=this.viewer.renderer.domElement,a=this.viewer.renderer.getPixelRatio(),o=r.offsetX||r.clientX-this.viewer.container.getBoundingClientRect().left,s=r.offsetY||r.clientY-this.viewer.container.getBoundingClientRect().top,r=(r.srcElement&&r.srcElement!==this.viewer.renderer.domElement&&(o=r.clientX-this.viewer.container.getBoundingClientRect().left,s=r.clientY-this.viewer.container.getBoundingClientRect().top),null==r.srcElement&&r.target&&r.target!==this.viewer.renderer.domElement&&(o=r.clientX-this.viewer.container.getBoundingClientRect().left,s=r.clientY-this.viewer.container.getBoundingClientRect().top),this.viewer.viewManager&&(o=(r=this.viewer.viewManager.remapViewCoordinateToFullView(o,s))[0],s=r[1]),this.viewer.camera.position.clone()),l=(r.sub(this.center()),r.length()),o=(r.multiplyScalar(.7),r.add(this.center()),r.project(this.viewer.camera),new THREE.Vector3(o*a/n.width*2-1,2*-(s*a/n.height)+1,r.z)),s=this.viewer.camera.IsPerspective(),a=this.viewer.getModelOperationMode();if("hall"==a&&(n=new THREE.Vector3,(n=this.viewer.controls.getBoundingBox().getCenter(n)).project(this.viewer.camera),o.copy(n)),o.unproject(this.viewer.camera),!isFinite(o.x)||!isFinite(o.y)||!isFinite(o.z))return!1;var r=this.viewer.camera.position.clone(),n=(r.sub(this.center()),r.length(),this.center().clone()),o=(n.sub(o),w),t=t.z,d=this.viewer.controls.getBoundingBox(),c=d.containsPoint(this.viewer.camera.position),c=(c&&t<0&&(o*=.6),De.autoSwitchFirstPersonView&&"hall"!=a&&(c?"FirstPerson"!=a&&(this.viewer.setModelOperationModeInternal("FirstPerson"),e.latAngle=0):"FirstPerson"==a&&this.viewer.setModelOperationModeInternal(this.viewer.originalModelOperationMode)),this.viewer.camera.position.clone()),a=this.center().clone(),h=new THREE.Vector3,u=(h.x=(r.x+n.x)*o/t,h.y=(r.y+n.y)*o/t,h.z=(r.z+n.z)*o/t,new THREE.Vector3);u.x=n.x*o/t,u.y=n.y*o/t,u.z=n.z*o/t,c.add(h),a.add(u);var p,f,m,n=.8*d.min.distanceTo(d.max),o=(l<n&&(l=n),new THREE.Vector3);return o.subVectors(a,c),o.normalize(),o.multiplyScalar(l),s&&this.viewer.camera.getOrginalCameraInfo()&&(a.addVectors(c,o),p=this.viewer.camera.getOrginalCameraInfo(),f=new THREE.Vector3(p.position.x-p.center.x,p.position.y-p.center.y,p.position.z-p.center.z).length(),h=new THREE.Vector3(p.center.x,p.center.y,p.center.z),(m=100<(m=20/f*c.clone().sub(h).length())?100:m)<.1&&(m=.1),u=c.clone().sub(h),d=c.clone().sub(a),u.dot(d)<0&&(m=.1),this.viewer.dispatchEvent({type:"dischange",distance:m})),this.adjustNearAndFar(),(s||((n=c.clone()).sub(a),0<=n.dot(r)))&&(this.viewer.camera.position.copy(c),this.center().copy(a)),0<t&&(l=this.calFarthestDistToCamera())>this.viewer.camera.far&&(this.viewer.camera.far=l),this.viewer.camera.updateProjectionMatrix(),!s&&this.viewer.camera.getOrginalCameraInfo()&&(p=this.viewer.camera.getOrginalCameraInfo(),m=20/(f=new THREE.Vector3(p.position.x-p.center.x,p.position.y-p.center.y,p.position.z-p.center.z).length())*this.viewer.camera.position.clone().sub(this.center()).length(),this.viewer.dispatchEvent({type:"dischange",distance:m=(m=100<m?100:m)<.1?.1:m})),!1!==i&&e.render(),!0},this.set2DViewerInfo=function(e){var t,r;null!=e.center&&m.viewer2DInfo.center.copy(e.center),null!=e.yDir&&(m.viewer2DInfo.yDir.copy(e.yDir),(r=new THREE.Vector3).copy(e.yDir),m.camera.up.copy(r)),null!=e.normal&&(e.normal.normalize(),m.viewer2DInfo.normal.copy(e.normal),(r=new THREE.Vector3).copy(e.normal),(t=new THREE.Vector3).copy(r),t.multiplyScalar(-1),null!=e.distance?(m.viewer2DInfo.distance=e.distance,r.multiplyScalar(e.distance)):r.multiplyScalar(100),(e=new THREE.Vector3(0,0,0)).copy(m.viewer2DInfo.center),e.add(r),m.camera.position.copy(e),(r=new THREE.Vector3).copy(m.camera.position),r.add(t),m.camera.lookAt(r)),m.camera.updateProjectionMatrix()},this.camDisTo2DViewer=function(){var e=m.viewer2DInfo.normal.x,t=m.viewer2DInfo.normal.y,r=m.viewer2DInfo.normal.z,i={a:0,b:0,c:0},i=(i.a=m.viewer2DInfo.center.x,i.b=m.viewer2DInfo.center.y,i.c=m.viewer2DInfo.center.z,-(e*i.a+t*i.b+r*i.c)),n={a:0,b:0,c:0};return n.a=m.camera.position.x,n.b=m.camera.position.y,n.c=m.camera.position.z,Math.abs(e*n.a+t*n.b+r*n.c+i)/Math.sqrt(e*e+t*t+r*r)},this.updateViewBoxCamQuaternion=function(e){y.camera.up.applyQuaternion(e),y.camera.position.applyQuaternion(e),y.camera.lookAt(y.center);e=new THREE.Vector3;e.subVectors(m.camera.getCameraTarget(),m.camera.position),e.normalize(),y.updateCurrentFace(e),requestAnimationFrame(y.render)},this.updateViewBoxCamDir=function(e){void 0===e&&((e=new THREE.Vector3).subVectors(m.camera.getCameraTarget(),m.camera.position),e.normalize(),De.AnimationEdit)&&(e.x<-.999999&&e.setX(-1),e.y<-.999999&&e.setY(-1),e.z<-.999999&&e.setZ(-1),.999999<e.x&&e.setX(1),.999999<e.y&&e.setY(1),.999999<e.z)&&e.setZ(1),y.camera.position.subVectors(y.center,e),y.camera.position.multiplyScalar(y.viewScale),y.camera.up.copy(m.camera.up),y.camera.lookAt(y.center),y.updateCurrentFace(e),y.render()},this.lookByFace=function(e){var t=new THREE.Vector3(0,0,0),e=v.getDestByFace(e),r=t.clone().sub(e.dir),e=(r.normalize(),e.up.clone()),r={from:r.toArray(),to:t.toArray(),up:e.toArray(),sphericalTransition:!0};this.look(r)},this.getView=function(){return this.viewer.camera.getWorldDirection(new THREE.Vector3)},this.getDestByFace=function(e){var t,r,i,n,a=new THREE.Vector3(0,1,0),o=new THREE.Vector3(1,-0,0),s=new THREE.Vector3(0,0,-1),l=(null==A&&(l=new THREE.Vector3(0,-1,0),t=new THREE.Vector3(0,1,0),h=new THREE.Vector3(0,0,-1),r=new THREE.Vector3(0,0,1),i=new THREE.Vector3(1,0,0),c=new THREE.Vector3(-1,0,0),n=new THREE.Vector3,(A={}).top=l,A.bottom=t,A.front=h,A.back=r,A.left=i,A.right=c,A["top,front"]=n.addVectors(l,h).clone(),A["top,right"]=n.addVectors(l,c).clone(),A["top,left"]=n.addVectors(l,i).clone(),A["top,back"]=n.addVectors(l,r).clone(),A["bottom,front"]=n.addVectors(t,h).clone(),A["bottom,right"]=n.addVectors(t,c).clone(),A["bottom,left"]=n.addVectors(t,i).clone(),A["bottom,back"]=n.addVectors(t,r).clone(),A["left,front"]=n.addVectors(i,h).clone(),A["front,right"]=n.addVectors(h,c).clone(),A["right,back"]=n.addVectors(c,r).clone(),A["back,left"]=n.addVectors(r,i).clone(),A["front,top,right"]=n.addVectors(h,l).add(c).clone(),A["back,top,right"]=n.addVectors(r,l).add(c).clone(),A["front,top,left"]=n.addVectors(h,l).add(i).clone(),A["back,top,left"]=n.addVectors(r,l).add(i).clone(),A["front,bottom,right"]=n.addVectors(h,t).add(c).clone(),A["back,bottom,right"]=n.addVectors(r,t).add(c).clone(),A["front,bottom,left"]=n.addVectors(h,t).add(i).clone(),A["back,bottom,left"]=n.addVectors(r,t).add(i).clone()),A[e].clone().normalize()),d=a,c=l.clone().negate();if(1-Math.abs(c.dot(a))<1e-5)for(var h=this.getView().normalize(),u=[s.clone(),s.clone().negate(),o.clone(),o.clone().negate()],p=0<c.dot(a)?1:-1,f=h.clone().add(this.viewer.camera.up.clone().multiplyScalar(p)).normalize(),m=-2,g=0;g<4;g++){var v=f.dot(u[g]);m<v&&(m=v,d=u[g].multiplyScalar(p))}return{dir:l.clone(),up:d.clone()}}}),v=((A.prototype=Object.create(THREE.MeshBasicMaterial.prototype)).constructor=A,(M.prototype=Object.create(THREE.LineBasicMaterial.prototype)).constructor=M,new A({visible:!1,transparent:!1})),Ie=(((E.prototype=Object.create(THREE.Object3D.prototype)).constructor=E).prototype.update=function(t,r){var i=new THREE.Vector3(0,0,0),n=new THREE.Vector3(0,1,0),a=new THREE.Matrix4;this.traverse(function(e){-1!==e.name.search("E")?e.quaternion.setFromRotationMatrix(a.lookAt(r,i,n)):-1===e.name.search("X")&&-1===e.name.search("Y")&&-1===e.name.search("Z")||e.quaternion.setFromEuler(t)})},(te.prototype=Object.create(E.prototype)).constructor=te,THREE.Object3D.prototype.rotateAroundWorldAxis=(P=new THREE.Quaternion,function(e,t,r){return P.setFromAxisAngle(t,r),this.applyQuaternion(P),this.position.sub(e),this.position.applyQuaternion(P),this.position.add(e),this}),(re.prototype=Object.create(E.prototype)).constructor=re,(ie.prototype=Object.create(THREE.Object3D.prototype)).constructor=ie,(ne.prototype=Object.create(E.prototype)).constructor=ne,function(l,d,O,F,e){void 0===e&&(e={}),THREE.Object3D.call(this),d=void 0!==d?d:document,this.object=void 0,this.visible=!1,this.translationSnap=null,this.rotationSnap=null,this.space="world",this.size=1,this.axis=null,this.pickType=null,this.newPosition=new THREE.Vector3,this.viewer=l,this.ViewBoxTransform=void 0!==e.ViewBoxTransform&&e.ViewBoxTransform;var U,i=this,n="translate",a=!1,o={translate:new te(O,F,e),rotate:new re,both:new ie,scale:new ne};for(U in o){var N=o[U];N.visible=U===n,this.add(N)}var V=1,s={type:"change"},G={type:"mouseDown"},k={type:"mouseUp",mode:n},j={type:"objectChange"},z=new THREE.Raycaster,W=new THREE.Vector2,r=new THREE.Vector3,c=new THREE.Vector3,h=new THREE.Vector3,u=new THREE.Vector3,p=1,X=new THREE.Matrix4,f=new THREE.Vector3,m=new THREE.Matrix4,g=new THREE.Vector3,v=new THREE.Quaternion,y=new THREE.Vector3(1,0,0),A=new THREE.Vector3(0,1,0),M=new THREE.Vector3(0,0,1),E=new THREE.Quaternion,w=new THREE.Quaternion,x=new THREE.Quaternion,b=new THREE.Quaternion,B=new THREE.Quaternion,I=new THREE.Vector3,T=new THREE.Vector3,q=new THREE.Matrix4,S=new THREE.Vector3,R=new THREE.Vector3,C=(new THREE.Quaternion,new THREE.Matrix4),D=new THREE.Vector3,P=new THREE.Vector3,Y=new THREE.Euler,H=new THREE.Matrix4,Q=new THREE.Vector3,K=new THREE.Euler;function t(e){var t,r;!i.visible||De.enableBroadcast&&!De.broadcastMajor||void 0===i.object||!0===a||void 0!==e.button&&0!==e.button||(r=e.changedTouches?e.changedTouches[0]:e,t=null,"both"!=n?t=L(r,o[n].pickers.children):(t=L(r,o[n]._rotatePickers.children))?i.pickType="rotate":(t=L(r,o[n]._translatePickers.children))&&(i.pickType="translate"),r=null,t&&(r=t.object.name,e.preventDefault()),i.axis!==r&&(i.axis=r,i.update(),s.axis=r,i.dispatchEvent(s)))}function Z(e){if((!De.enableBroadcast||De.broadcastMajor)&&i.visible&&void 0!==i.object&&!0!==a&&(void 0===e.button||0===e.button)){var t=e.changedTouches?e.changedTouches[0]:e;if(0===t.button||void 0===t.button){var r=null;if("both"!=n?r=L(t,o[n].pickers.children):(r=L(t,o[n]._rotatePickers.children))?i.pickType="rotate":(r=L(t,o[n]._translatePickers.children))&&(i.pickType="translate"),r){if(e.preventDefault(),e.stopPropagation(),i.dispatchEvent(G),!i.visible)return;if(i.axis=r.object.name,!r.object.visible)return;i.update(),f.copy(Q).sub(P).normalize(),o[n].setActivePlane(i.axis,f);e=L(t,[o[n].activePlane]);e&&(I.copy(i.object.position),T.copy(i.object.scale),q.extractRotation(i.object.matrix),H.extractRotation(i.object.matrixWorld),i.object.parent&&(C.extractRotation(i.object.parent.matrixWorld),D.setFromMatrixScale(m.getInverse(i.object.parent.matrixWorld))),c.copy(e.point))}}a=!0}}function J(e){var t;De.enableBroadcast&&!De.broadcastMajor||void 0===i.object||null===i.axis||!1===a||void 0!==e.button&&0!==e.button||!1!==(t=L(e.changedTouches?e.changedTouches[0]:e,[o[n].activePlane]))&&(e.preventDefault(),e.stopPropagation(),i.visible)&&(r.copy(t.point),"translate"===n||"translate"==i.pickType?(r.sub(c),r.multiply(D),"local"===i.space&&(r.applyMatrix4(m.getInverse(H)),-1===i.axis.search("X")&&(r.x=0),-1===i.axis.search("Y")&&(r.y=0),-1===i.axis.search("Z")&&(r.z=0),r.applyMatrix4(q),r.multiplyScalar(V),i.object.position.copy(I),i.object.position.add(r),i.newPosition=i.object.position.clone(),l.clipDataManager.isSectionViewEnabled())&&i.getDeltaPosition(!0),"world"!==i.space&&-1===i.axis.search("XYZ")||(-1===i.axis.search("X")&&(r.x=0),-1===i.axis.search("Y")&&(r.y=0),-1===i.axis.search("Z")&&(r.z=0),r.applyMatrix4(m.getInverse(C)),i.object.position.copy(I),i.object.position.add(r)),null!==i.translationSnap&&("local"===i.space&&i.object.position.applyMatrix4(m.getInverse(H)),-1!==i.axis.search("X")&&(i.object.position.x=Math.round(i.object.position.x/i.translationSnap)*i.translationSnap),-1!==i.axis.search("Y")&&(i.object.position.y=Math.round(i.object.position.y/i.translationSnap)*i.translationSnap),-1!==i.axis.search("Z")&&(i.object.position.z=Math.round(i.object.position.z/i.translationSnap)*i.translationSnap),"local"===i.space)&&i.object.position.applyMatrix4(H)):"scale"===n?(r.sub(c),r.multiply(D),"local"===i.space&&("XYZ"===i.axis?(p=1+r.y/Math.max(T.x,T.y,T.z),i.object.scale.x=T.x*p,i.object.scale.y=T.y*p,i.object.scale.z=T.z*p):(r.applyMatrix4(m.getInverse(H)),"X"===i.axis&&(i.object.scale.x=T.x*(1+r.x/T.x)),"Y"===i.axis&&(i.object.scale.y=T.y*(1+r.y/T.y)),"Z"===i.axis&&(i.object.scale.z=T.z*(1+r.z/T.z))))):"rotate"!==n&&"rotate"!=i.pickType||(r.sub(P),r.multiply(D),g.copy(c).sub(P),g.multiply(D),"E"===i.axis?(r.applyMatrix4(m.getInverse(X)),g.applyMatrix4(m.getInverse(X)),h.set(Math.atan2(r.z,r.y),Math.atan2(r.x,r.z),Math.atan2(r.y,r.x)),u.set(Math.atan2(g.z,g.y),Math.atan2(g.x,g.z),Math.atan2(g.y,g.x)),v.setFromRotationMatrix(m.getInverse(C)),B.setFromAxisAngle(f,h.z-u.z),E.setFromRotationMatrix(H),v.multiplyQuaternions(v,B),v.multiplyQuaternions(v,E),i.object.quaternion.copy(v)):"XYZE"===i.axis?(B.setFromEuler(r.clone().cross(g).normalize()),v.setFromRotationMatrix(m.getInverse(C)),w.setFromAxisAngle(B,-r.clone().angleTo(g)),E.setFromRotationMatrix(H),v.multiplyQuaternions(v,w),v.multiplyQuaternions(v,E),i.object.quaternion.copy(v)):"local"===i.space?(r.applyMatrix4(m.getInverse(H)),g.applyMatrix4(m.getInverse(H)),h.set(Math.atan2(r.z,r.y),Math.atan2(r.x,r.z),Math.atan2(r.y,r.x)),u.set(Math.atan2(g.z,g.y),Math.atan2(g.x,g.z),Math.atan2(g.y,g.x)),E.setFromRotationMatrix(q),null!==i.rotationSnap?(w.setFromAxisAngle(y,Math.round((h.x-u.x)/i.rotationSnap)*i.rotationSnap),x.setFromAxisAngle(A,Math.round((h.y-u.y)/i.rotationSnap)*i.rotationSnap),b.setFromAxisAngle(M,Math.round((h.z-u.z)/i.rotationSnap)*i.rotationSnap)):(w.setFromAxisAngle(y,h.x-u.x),x.setFromAxisAngle(A,h.y-u.y),b.setFromAxisAngle(M,h.z-u.z)),"X"===i.axis&&E.multiplyQuaternions(E,w),"Y"===i.axis&&E.multiplyQuaternions(E,x),"Z"===i.axis&&E.multiplyQuaternions(E,b),i.object.quaternion.copy(E),l.clipDataManager.isSectionViewEnabled()&&i.getDeltaRotation(!0,i.RDelta)):"world"===i.space&&(h.set(Math.atan2(r.z,r.y),Math.atan2(r.x,r.z),Math.atan2(r.y,r.x)),u.set(Math.atan2(g.z,g.y),Math.atan2(g.x,g.z),Math.atan2(g.y,g.x)),v.setFromRotationMatrix(m.getInverse(C)),null!==i.rotationSnap?(w.setFromAxisAngle(y,Math.round((h.x-u.x)/i.rotationSnap)*i.rotationSnap),x.setFromAxisAngle(A,Math.round((h.y-u.y)/i.rotationSnap)*i.rotationSnap),b.setFromAxisAngle(M,Math.round((h.z-u.z)/i.rotationSnap)*i.rotationSnap)):(w.setFromAxisAngle(y,h.x-u.x),x.setFromAxisAngle(A,h.y-u.y),b.setFromAxisAngle(M,h.z-u.z)),E.setFromRotationMatrix(H),"X"===i.axis&&v.multiplyQuaternions(v,w),"Y"===i.axis&&v.multiplyQuaternions(v,x),"Z"===i.axis&&v.multiplyQuaternions(v,b),v.multiplyQuaternions(v,E),i.object.quaternion.copy(v))),i.update(),i.dispatchEvent(s),i.dispatchEvent(j))}function _(e){De.enableBroadcast&&!De.broadcastMajor||(e.preventDefault(),!i.visible)||void 0!==e.button&&0!==e.button||(a&&null!==i.axis&&(k.mode=n,i.dispatchEvent(k),a=!1,i.dispatchEvent({type:"objectChange",mouseUp:!0})),a=!1,"TouchEvent"in window&&e instanceof TouchEvent?(i.axis=null,i.update(),i.dispatchEvent(s)):t(e))}function L(e,t){var r=d.getBoundingClientRect(),i=r.width,n=r.height,a=(null!=d.clientWidth&&null!=d.clientHeight&&(10<Math.abs(i-d.clientWidth)&&(i=d.clientWidth),10<Math.abs(n-d.clientHeight))&&(n=d.clientHeight),0),o=0,s=(o=l.viewManager?(a=(s=l.viewManager.normalizeViewCoordinateToViewPort(e.clientX,e.clientY,{left:r.left,top:r.top,width:i,height:n}))[0],-s[1]):(a=(e.clientX-r.left)/i*2-1,-(e.clientY-r.top)/n*2+1),W.set(a,o),(l.viewManager?l.viewManager.getActiveView():l).camera.setCastRay(z,W.x,W.y),z.intersectObjects(t,!0));return s[0]||!1}!e.needListen&&void 0!==e.needListen||(Pe.isMobileDevice()?(d.addEventListener("touchstart",Z,!1),d.addEventListener("touchmove",t,!1),d.addEventListener("touchmove",J,!1),d.addEventListener("touchend",_,!1),d.addEventListener("touchcancel",_,!1)):(d.addEventListener("mousedown",Z,!1),d.addEventListener("mousemove",t,!1),d.addEventListener("mousemove",J,!1),d.addEventListener("mouseup",_,!1))),this.setTranslateScale=function(e){V=e},this.isDragging=function(){return a},this.isSelected=function(){return null!=i.axis},this.setOldPosition=function(e){e&&I.copy(e)},this.getOldPosition=function(){return I},this.dispose=function(){Pe.isMobileDevice()?(d.removeEventListener("touchstart",Z),d.removeEventListener("touchmove",t),d.removeEventListener("touchmove",J),d.removeEventListener("touchend",_),d.removeEventListener("touchcancel",_),d.removeEventListener("touchleave",_)):(d.removeEventListener("mousedown",Z),d.removeEventListener("mousemove",t),d.removeEventListener("mousemove",J),d.removeEventListener("mouseup",_),d.removeEventListener("mouseout",_))},this.attach=function(e){this.object=e,this.visible=!0,this.update()},this.detach=function(){this.object=void 0,this.visible=!1,this.axis=null},this.getMode=function(){return n},this.setMode=function(e){for(var t in"scale"===(n=e||n)&&(i.space="local"),o)o[t].visible=t===n;this.update(),i.dispatchEvent(s),i.pickType=null},this.setTranslationSnap=function(e){i.translationSnap=e},this.setRotationSnap=function(e){i.rotationSnap=e},this.setSize=function(e){i.size=e,this.update(),i.dispatchEvent(s)},this.setSpace=function(e){i.space=e,this.update(),i.dispatchEvent(s)},this.update=function(){var e,t,r;void 0!==i.object&&(i.object.updateMatrixWorld(),P.setFromMatrixPosition(i.object.matrixWorld),Y.setFromRotationMatrix(m.extractRotation(i.object.matrixWorld)),l.camera.updateMatrixWorld(),Q.setFromMatrixPosition(l.camera.matrixWorld),K.setFromRotationMatrix(m.extractRotation(l.camera.matrixWorld)),l.camera.updateMatrix(),r=l.camera.getCameraTarget(),t=l.camera.position,(e=new THREE.Vector3).subVectors(r,t),r=P.clone(),r=l.camera.isPerspective?r.sub(t).dot(e.normalize()):1.2*e.length(),t=l.camera.fov,r=120*(2*r*Math.tan(THREE.Math.degToRad(.5*t)))/d.height*i.size,Pe.isMobileDevice()&&(r*=3),this.position.copy(P),this.ViewBoxTransform&&(r=190),this.scale.set(r,r,r),(l.camera.isPerspective?f.copy(Q).sub(P):f.copy(e).negate()).normalize(),"local"===i.space?o[n].update(Y,f):"world"===i.space&&o[n].update(new THREE.Euler,f),o[n].highlight(i.axis,i.pickType))},this.getDeltaRotation=function(e,t){var r;if(i.object)return"YZ"==i.name?((r=new THREE.Euler(0,0,0,"YZX")).setFromQuaternion(i.object.quaternion),R.set(r.x,r.y,r.z),e&&l.dispatchEvent({type:"clippingBall",deltaAngle:{y:Math.abs(180*R.y/Math.PI)<1e-5?0:180*R.y/Math.PI,z:Math.abs(180*R.z/Math.PI)<1e-5?0:180*R.z/Math.PI}})):"XZ"==i.name?((r=new THREE.Euler(0,0,0,"XZY")).setFromQuaternion(i.object.quaternion),R.set(r.x,r.y,r.z),e&&l.dispatchEvent({type:"clippingBall",deltaAngle:{x:Math.abs(180*R.x/Math.PI)<1e-5?0:180*R.x/Math.PI,z:Math.abs(180*R.z/Math.PI)<1e-5?0:180*R.z/Math.PI}})):"XY"==i.name?((r=new THREE.Euler(0,0,0,"XYZ")).setFromQuaternion(i.object.quaternion),R.set(r.x,r.y,r.z),e&&l.dispatchEvent({type:"clippingBall",deltaAngle:{x:Math.abs(180*R.x/Math.PI)<1e-5?0:180*R.x/Math.PI,y:Math.abs(180*R.y/Math.PI)<1e-5?0:180*R.y/Math.PI}})):"R"==i.name&&((r=new THREE.Euler(0,0,0,"YZX")).setFromQuaternion(i.object.quaternion),R.set(r.x,r.y,r.z),e)&&(r=R.y,e=R.z,t&&(r=R.y-t.y,e=R.z-t.z),t=180*r/Math.PI,r=180*e/Math.PI,l.dispatchEvent({type:"clippingBall",deltaAngle:{y:Math.abs(t)<1e-5?0:t,z:Math.abs(r)<1e-5?0:r}})),R},this.getDeltaPosition=function(e){var t,r;if(i.object)return t=!0,r=0,"R"==i.name?i.object.clickOriPosition&&(S.subVectors(i.object.position,i.object.clickOriPosition),t=0<=S.dot(i.object.clickNormal)):(S.subVectors(i.object.position,i.object.oriPosition),"YZ"==i.name&&(t=0<=S.dot(y)),"XZ"==i.name&&(t=0<=S.dot(A)),"XY"==i.name&&(t=0<=S.dot(M))),r=S.length(),t=t?r:-r,r=l.getDispalyModelUnit(r,r),e&&l.dispatchEvent({type:"clippingBall",deltaPosition:t,displayUnitScale:r}),t}}),z=(Ie.prototype=Object.create(THREE.Object3D.prototype),Ie.prototype.constructor=Ie,function(t,r,i,e){var n=e._transformScene,a=null,o=null,s=(new THREE.Plane,new THREE.Raycaster),l=new THREE.Vector2,d=(new THREE.Vector3,null),c=!1,h=!1,u=!1,p=!0,f=(this._enabled=!0,1),m=this,g=!1,v=null;function y(){r.addEventListener("mousemove",E,!1),r.addEventListener("mousedown",M,!1),r.addEventListener("mouseup",w,!1),null==a&&((a=new Ie(i,r)).setMode("translate"),a.setSpace("local"),a.setSize(f),n.add(a),a.addEventListener("change",function(){a.update(),o.update(),i.render()})),null==o&&((o=new Ie(i,r)).setMode("both"),o.setSpace("local"),o.setSize(f),n.add(o),o.addEventListener("change",function(){o.update(),a.update(),i.render()})),g=!0}function A(){null!=a&&a.detach(a.object),null!=o&&o.detach(o.object),r.removeEventListener("mousemove",E,!1),r.removeEventListener("mousedown",M,!1),r.removeEventListener("mouseup",w,!1),g=!1}function M(e){c=!(h=!0),v=r.style.cursor,e.preventDefault(),e.stopPropagation(),i.camera instanceof Re?(i.camera.setCastRay(s,l.x,l.y),s.camera=i.camera):s.setFromCamera(l,i.camera);e=s.intersectObjects(t);0<e.length&&(d=e[0].object,r.style.cursor="move",m.dispatchEvent({type:"mousedown",object:d}))}function E(e){e.preventDefault(),e.stopPropagation();var t=r.getBoundingClientRect();l.x=(e.clientX-t.left)/t.width*2-1,l.y=2*-((e.clientY-t.top)/t.height)+1,h&&(c=!0,o.update(),a.update(),i.render())}function w(e){null!=e&&e.preventDefault(),c?(m.dispatchEvent({type:"mouseup",object:d}),h=!1):(a.detach(a.object),o.detach(o.object),null!=d&&m.attachTo(d)),i.render(),d=null,r.style.cursor=v,h=!1}this.isActive=function(){return g},this.getCurrAttachObj=function(){return u?a.object:p?o.object:void 0},this.setSize=function(e){f=e,null!=a&&a.setSize(e),null!=o&&o.setSize(e),this.update(),i.render()},this.addEventListener=function(e,t,r){"rotate"==e?o.addEventListener(t,r):"transform"==e?a.addEventListener(t,r):"both"==e&&(o.addEventListener(t,r),a.addEventListener(t,r))},this.getRotateControls=function(){return o},this.getTransformControls=function(){return a},this.attachTo=function(e){a.detach(a.object),o.detach(o.object),null!=e&&e instanceof THREE.Sprite&&("pointlightctrl"==e.name||"hemilightctrl"==e.name?(p=!(u=!0),a.attach(e.parent)):"dirlightctrl"!=e.name&&"spotlightctrl"!=e.name||(p=!(u=!1),o.attach(e.parent))),i.render()},this.detach=function(){null!=a&&a.detach(a.object),null!=o&&o.detach(o.object)},this.update=function(){null!=a&&(a.update(),a.updateMatrixWorld(!0)),null!=o&&(o.update(),o.updateMatrixWorld(!0))},this.setTransformEnabled=function(e){u=e},this.setRotateEnabled=function(e){p=e},this.setEnabled=function(e){e?this._enabled||y():this._enabled&&A(),this._enabled=e},this.activate=y,this.deactivate=A,this.dispose=function(){A()},this.isSelected=function(){return null!=d||!(null==a||!a.isSelected())||!(null==o||!o.isSelected())}}),ke=(z.prototype=Object.create(THREE.EventDispatcher.prototype),z.prototype.constructor=z,function(e){THREE.EventDispatcher.call(this);void 0===(t=e.renderer.domElement)&&document;var t,r=this,i=null,n=new THREE.Box3,a=!1;this.viewer=e,this.enabled=!0,this.staticAnnotation=null,this.staticDrawGeomOp=null,this.render=function(e){r.dispatchEvent(e||{type:"render"})},this.update=function(){null!=i&&i.update()},this.onOpRender=function(e){r.render(e)},this.onOpEvent=function(e){r.dispatchEvent({type:"event",event:e})},this.setOperator=function(e){r.releaseOperator();var t=this.viewer.__globalMeasureExtension;this.viewer.is2DModel&&!De.New2DMeasure&&t&&e.type!=t.getOperatorName()&&t.OpMeasureRelease(),t&&e.type==t.getOperatorName()?i=t.getMeasureOp():null!=this.staticDrawGeomOp&&"OpDrawGeom"==e.type?(i=this.staticDrawGeomOp).init():null!=this.staticAnnotation&&"OpAnnotationNew"==e.type?i=this.staticAnnotation:(e.create(),"OpDrawGeom"==(i=e).type?(this.staticDrawGeomOp=i).init():"OpAnnotationNew"==e.type&&(this.staticAnnotation=i)),i.addEventListener("render",r.onOpRender),i.addEventListener("mouseEvent",r.onOpEvent),i.addEventListener("event",r.onOpEvent),this.viewer.clearCenterCross&&(this.viewer.clearCenterCross(),"OpOrbit"==e.type)&&"FirstPerson"==this.viewer.getModelOperationMode()&&this.viewer.drawCenterCross()},this.getOperator=function(){return i},this.releaseOperator=function(){var e=i,t=this.viewer.__globalMeasureExtension;null!=e&&(t&&e.type==t.getOperatorName()||"OpDrawGeom"==e.type||"OpAnnotationNew"==e.type?e.clearFlag():e.release(),this.viewer.is2DModel&&De.New2DMeasure&&t&&e.type==t.getOperatorName()||e.removeEventListener("render",r.onOpRender),e.removeEventListener("mouseEvent",r.onOpEvent),e.removeEventListener("event",r.onOpEvent))},this.setBoundingBox=function(e,t){n.set(e,t),a=!0},this.getBoundingBox=function(){return n},this.IsBoundingBoxUpdated=function(){return a},this.SetBoundingBoxUpdated=function(e){a=e}}),ae=(ke.prototype=Object.create(THREE.EventDispatcher.prototype),Ue.prototype=Object.create(THREE.EventDispatcher.prototype),function(a,o){THREE.Object3D.call(this);function e(e,t){for(var r in e)for(var i=e[r].length;i--;){var n=e[r][i][0],a=e[r][i][1],o=e[r][i][2];n.name=r,a&&n.position.set(a[0],a[1],a[2]),o&&n.rotation.set(o[0],o[1],o[2]),t.add(n)}}var t=new THREE.CylinderGeometry(0,.05,.2,12,1,!1),r=new THREE.Mesh(t),r=(r.position.y=.5,r.updateMatrix(),t.applyMatrix(r.matrix),new THREE.BufferGeometry),i=(r.addAttribute("position",new THREE.Float32BufferAttribute([0,0,0,1,0,0],3)),new THREE.BufferGeometry),n=(i.addAttribute("position",new THREE.Float32BufferAttribute([0,0,0,0,1,0],3)),new THREE.BufferGeometry),s=(n.addAttribute("position",new THREE.Float32BufferAttribute([0,0,0,0,0,1],3)),{}),r=(s.X=[[new THREE.Mesh(t,new A({color:16711680})),[.5,0,0],[0,0,-Math.PI/2]],[new THREE.Line(r,new M({color:16711680}))]],s.Y=[[new THREE.Mesh(t,new A({color:65280})),[0,.5,0]],[new THREE.Line(i,new M({color:65280}))]],s.Z=[[new THREE.Mesh(t,new A({color:255})),[0,0,.5],[Math.PI/2,0,0]],[new THREE.Line(n,new M({color:255}))]],new A({visible:!1,transparent:!1})),i={},l=(i.X=[[new THREE.Mesh(new THREE.CylinderGeometry(.2,0,1,4,1,!1),r),[.6,0,0],[0,0,-Math.PI/2]]],i.Y=[[new THREE.Mesh(new THREE.CylinderGeometry(.2,0,1,4,1,!1),r),[0,.6,0]]],i.Z=[[new THREE.Mesh(new THREE.CylinderGeometry(.2,0,1,4,1,!1),r),[0,0,.6],[Math.PI/2,0,0]]],this.axes=new THREE.Object3D,this.pickers=new THREE.Object3D,e(s,this.axes),e(i,this.pickers),this.add(this.axes),this.add(this.pickers),this),t=void 0!==o?o:document,d=(this.size=1,this.type="CoordSystem",this.pickedAxis=null,this.axis=null,this.parentNode=void 0,this.visible=!1,new THREE.Raycaster),c=new THREE.Vector2,h=new THREE.Vector3,u=new THREE.Quaternion,p=new THREE.Vector3;new THREE.Vector3;function f(e){var t,r;!l.visible||De.enableBroadcast&&!De.broadcastMajor||void 0===l.parentNode||void 0!==e.button&&0!==e.button||0!==(t=e.changedTouches?e.changedTouches[0]:e).button&&void 0!==t.button||(r=null,(r=y(t,l.pickers.children))?(e.preventDefault(),e.stopPropagation(),l.axis=r.object.name,l.update()):l.axis=null)}function m(e){}function g(e){}function v(e){var t,r;!l.visible||De.enableBroadcast&&!De.broadcastMajor||void 0===l.parentNode||void 0!==e.button&&0!==e.button||(r=t=null,(t=y(e.changedTouches?e.changedTouches[0]:e,l.pickers.children))&&(r=t.object.name,e.preventDefault()),l.pickedAxis!==r&&(l.pickedAxis=r,l.update()))}function y(e,t){var r=o.getBoundingClientRect(),i=r.width,n=r.height,i=(null!=o.clientWidth&&null!=o.clientHeight&&(10<Math.abs(i-o.clientWidth)&&(i=o.clientWidth),10<Math.abs(n-o.clientHeight))&&(n=o.clientHeight),(e.clientX-r.left)/i),e=(e.clientY-r.top)/n,r=(c.set(2*i-1,-2*e+1),a.setCastRay(d,c.x,c.y),d.intersectObjects(t,!0));return r[0]||!1}Pe.isMobileDevice()?(t.addEventListener("touchstart",f,!1),t.addEventListener("touchmove",v,!1),t.addEventListener("touchmove",g,!0),t.addEventListener("touchend",m,!1),t.addEventListener("touchcancel",m,!1)):(t.addEventListener("mousedown",f,!1),t.addEventListener("mousemove",v,!1),t.addEventListener("mousemove",g,!0),t.addEventListener("mouseup",m,!1)),this.dispose=function(){Pe.isMobileDevice()?(o.removeEventListener("touchstart",f),o.removeEventListener("touchmove",v),o.removeEventListener("touchmove",g),o.removeEventListener("touchend",m),o.removeEventListener("touchcancel",m)):(o.removeEventListener("mousedown",f),o.removeEventListener("mousemove",v),o.removeEventListener("mousemove",g),o.removeEventListener("mouseup",m))},this.isSelected=function(){return null!=this.axis},this.attach=function(e){this.parentNode=e,this.visible=!0,this.update()},this.detach=function(){this.parentNode=void 0,this.visible=!1,this.pickedAxis=null,this.axis=null},this.setSize=function(e){l.size=e,this.update()},this.highlight=function(t){this.traverse(function(e){e.material&&e.material.highlight&&(e.name===t?e.material.highlight(!0):e.material.highlight(!1))})},this.axisVisible=function(t,r){this.traverse(function(e){e.material&&e.material.highlight&&(e.name===r&&t?e.visible=!0:e.visible=!1)})},this.getAxisVisible=function(t){var r=!1;return this.traverse(function(e){e.material&&e.material.highlight&&e.name===t&&(r=e.visible)}),r},this.update=function(){if(void 0!==l.parentNode){l.visible=l.parentNode.visible;var e=l.parentNode.getModel();if("explodeObject"==l.name){var t=e.viewer.controls.getBoundingBox(),t=(t||renturn,t.getCenter(new THREE.Vector3));if(!t)return;h=t.clone()}else{if(!l.parentNode.worldMatrix)return;l.parentNode.worldMatrix.decompose(h,u,p)}a.updateMatrix();var t=a.getCameraTarget(),r=a.position,i=new THREE.Vector3,t=(i.subVectors(t,r),h.clone()),t=a.isPerspective?t.sub(r).dot(i.normalize()):1.2*i.length(),r=a.fov,i=2*t*Math.tan(THREE.Math.degToRad(.5*r)),t=e.viewer.renderer.domElement.height,r=70*i*e.viewer.renderer.getPixelRatio()/t;Pe.isMobileDevice()&&(r*=3),r*=l.size,l.position.copy(h),l.quaternion.copy(u),l.scale.set(r,r,r),l.updateMatrixWorld(!0),this.highlight(l.axis)}}}),je=(ae.prototype=Object.create(THREE.Object3D.prototype),ae.prototype.constructor=ae,{uniforms:{tDiffuse:{type:"t",value:null},opacity:{type:"f",value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float opacity;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","vec4 texel = texture2D( tDiffuse, vUv );","gl_FragColor = opacity * texel;","}"].join("\n")}),ze={uniforms:{tDiffuse:{type:"t",value:null}},defines:{},vertexShader:["varying vec2 vUv;","void main() {","vUv = vec2(uv.x, uv.y);","gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","varying vec2 vUv;","#ifdef HORIZONTAL","#define GET_UV(X) vec2(vUv.x + RESOLUTION*(X), vUv.y)","#else","#define GET_UV(Y) vec2(vUv.x, vUv.y + RESOLUTION*(Y))","#endif","#define BLUR_RADIUS (3.0 * SIGMA + 0.5)","#define SIGMASQ2 (2.0 * SIGMA * SIGMA)","#define GAUSS_EXP(X) ( exp(-(X)*(X)/SIGMASQ2) )","void main() {","vec4 sum = vec4( 0.0 );","float total = 0.0;","for (float x=-BLUR_RADIUS; x<=BLUR_RADIUS; x+=1.0) {","float ratio = GAUSS_EXP(x);","sum += texture2D(tDiffuse, GET_UV(x)) * ratio;","total += ratio;","}","sum /= total;","gl_FragColor = sum;","}"].join("\n")},We={uniforms:{tDiffuse:{type:"t",value:null}},defines:{},vertexShader:["varying vec2 vUv;","void main() {","vUv = vec2(uv.x, uv.y);","gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","varying vec2 vUv;","#ifdef HORIZONTAL","#define GET_UV(X) vec2(vUv.x + RESOLUTION*(X), vUv.y)","#else","#define GET_UV(Y) vec2(vUv.x, vUv.y + RESOLUTION*(Y))","#endif","void main() {","vec4 sum = texture2D(tDiffuse, GET_UV(0.0));","#if BLUR_LEVEL == 1","sum += texture2D(tDiffuse, GET_UV(-1.0)) * 0.882496903;","sum += texture2D(tDiffuse, GET_UV(1.0)) * 0.882496903;","sum += texture2D(tDiffuse, GET_UV(-2.0)) * 0.60653066;","sum += texture2D(tDiffuse, GET_UV(2.0)) * 0.60653066;","sum += texture2D(tDiffuse, GET_UV(-3.0)) * 0.324652467;","sum += texture2D(tDiffuse, GET_UV(3.0)) * 0.324652467;","sum += texture2D(tDiffuse, GET_UV(-4.0)) * 0.135335283;","sum += texture2D(tDiffuse, GET_UV(4.0)) * 0.135335283;","sum *= 0.204163689;","#elif BLUR_LEVEL == 2","sum += texture2D(tDiffuse, GET_UV(-1.0)) * 0.960005441;","sum += texture2D(tDiffuse, GET_UV(1.0)) * 0.960005441;","sum += texture2D(tDiffuse, GET_UV(-2.0)) * 0.849365817;","sum += texture2D(tDiffuse, GET_UV(2.0)) * 0.849365817;","sum += texture2D(tDiffuse, GET_UV(-3.0)) * 0.692569324;","sum += texture2D(tDiffuse, GET_UV(3.0)) * 0.692569324;","sum += texture2D(tDiffuse, GET_UV(-4.0)) * 0.520450121;","sum += texture2D(tDiffuse, GET_UV(4.0)) * 0.520450121;","sum += texture2D(tDiffuse, GET_UV(-5.0)) * 0.360447789;","sum += texture2D(tDiffuse, GET_UV(5.0)) * 0.360447789;","sum += texture2D(tDiffuse, GET_UV(-6.0)) * 0.230066299;","sum += texture2D(tDiffuse, GET_UV(6.0)) * 0.230066299;","sum += texture2D(tDiffuse, GET_UV(-7.0)) * 0.135335283;","sum += texture2D(tDiffuse, GET_UV(7.0)) * 0.135335283;","sum *= 0.117695797;","#elif BLUR_LEVEL == 3","sum += texture2D(tDiffuse, GET_UV(-1.0)) * 0.988235431;","sum += texture2D(tDiffuse, GET_UV(1.0)) * 0.988235431;","sum += texture2D(tDiffuse, GET_UV(-2.0)) * 0.953765659;","sum += texture2D(tDiffuse, GET_UV(2.0)) * 0.953765659;","sum += texture2D(tDiffuse, GET_UV(-3.0)) * 0.898967069;","sum += texture2D(tDiffuse, GET_UV(3.0)) * 0.898967069;","sum += texture2D(tDiffuse, GET_UV(-4.0)) * 0.827497567;","sum += texture2D(tDiffuse, GET_UV(4.0)) * 0.827497567;","sum += texture2D(tDiffuse, GET_UV(-5.0)) * 0.743893062;","sum += texture2D(tDiffuse, GET_UV(5.0)) * 0.743893062;","sum += texture2D(tDiffuse, GET_UV(-6.0)) * 0.653093155;","sum += texture2D(tDiffuse, GET_UV(6.0)) * 0.653093155;","sum += texture2D(tDiffuse, GET_UV(-7.0)) * 0.559964631;","sum += texture2D(tDiffuse, GET_UV(7.0)) * 0.559964631;","sum += texture2D(tDiffuse, GET_UV(-8.0)) * 0.468885606;","sum += texture2D(tDiffuse, GET_UV(8.0)) * 0.468885606;","sum += texture2D(tDiffuse, GET_UV(-9.0)) * 0.383437025;","sum += texture2D(tDiffuse, GET_UV(9.0)) * 0.383437025;","sum += texture2D(tDiffuse, GET_UV(-10.0)) * 0.30622598;","sum += texture2D(tDiffuse, GET_UV(10.0)) * 0.30622598;","sum += texture2D(tDiffuse, GET_UV(-11.0)) * 0.238842089;","sum += texture2D(tDiffuse, GET_UV(11.0)) * 0.238842089;","sum *= 0.06646455;","#endif","gl_FragColor = sum;","}"].join("\n")},oe=(["varying vec2 vUv;","void main() {","vUv = vec2(uv.x, uv.y);","gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join("\n"),["uniform sampler2D tDiffuse;","varying vec2 vUv;","#define repeats 40.0","vec3 texture(vec2 uv) {","return texture2D(tDiffuse,uv).rgb;","}","float grid(float var, float size) {","return floor(var*size)/size;","}","float rand(vec2 co){","return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);","}","void main() {","vec3 blurred_image = vec3(0.0);","for(float i=0.0;i<repeats;i++){","vec2 q = vec2(cos(degrees((i/repeats)*360.0)),sin(degrees((i/repeats)*360.0))) *  (rand(vec2(i,vUv.x+vUv.y))+BLUR_AMOUNT);","vec2 uv2 = vUv+(q*BLUR_AMOUNT);","blurred_image += texture(uv2)/2.0;","q = vec2(cos(degrees((i/repeats)*360.0)),sin(degrees((i/repeats)*360.0))) *  (rand(vec2(i+2.,vUv.x+vUv.y+24.0))+BLUR_AMOUNT);","uv2 = vUv+(q*BLUR_AMOUNT);","blurred_image += texture(uv2)/2.0;","}","blurred_image /= repeats;","gl_FragColor = vec4(blurred_image,1.0);","}"].join("\n"),u.prototype={constructor:u,setSize:function(e,t){},render:function(e,t,r,i,n){console.error("Pass: .render() must be implemented in derived pass.")}},g.prototype=Object.create(u.prototype),Object.assign(g.prototype,{render:function(e,t,r,i,n){var a,o,s=e.context,l=e.state;l.buffers.color.setMask(!1),l.buffers.depth.setMask(!1),l.buffers.color.setLocked(!0),l.buffers.depth.setLocked(!0),o=this.inverse?(a=0,1):(a=1,0),l.buffers.stencil.setTest(!0),l.buffers.stencil.setOp(s.REPLACE,s.REPLACE,s.REPLACE),l.buffers.stencil.setFunc(s.ALWAYS,a,4294967295),l.buffers.stencil.setClear(o),e.render(this.scene,this.camera,r,this.clear),e.render(this.scene,this.camera,t,this.clear),l.buffers.color.setLocked(!1),l.buffers.depth.setLocked(!1),l.buffers.stencil.setFunc(s.EQUAL,1,4294967295),l.buffers.stencil.setOp(s.KEEP,s.KEEP,s.KEEP)}}),w.prototype=Object.create(u.prototype),Object.assign(w.prototype,{render:function(e,t,r,i,n){e.state.buffers.stencil.setTest(!1)}}),x.prototype=Object.assign(Object.create(u.prototype),{constructor:x,render:function(e,t,r,i,n,a){this.uniforms[this.textureID]&&(this.uniforms[this.textureID].value=r.texture),this.quad.material=this.material,this.renderToColor&&i?e.render(this.scene,this.camera,i,this.clear):this.renderToScreen?e.render(this.scene,this.camera):e.render(this.scene,this.camera,t,this.clear)}}),Object.assign(Ve.prototype,{swapBuffers:function(){var e=this.readBuffer;this.readBuffer=this.writeBuffer,this.writeBuffer=e},addPass:function(e){this.passes.push(e);var t=this.renderer.getSize();e.setSize(t.width,t.height)},insertPass:function(e,t){this.passes.splice(t,0,e)},render:function(e){this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2;for(var t,r,i=!1,n=this.passes.length,a=0;a<n;a++)!1!==(r=this.passes[a]).enabled&&(r.render(this.renderer,this.writeBuffer,this.readBuffer,this.colorTarget,e,i),r.needsSwap&&(i&&((t=this.renderer.context).stencilFunc(t.NOTEQUAL,1,4294967295),this.copyPass.render(this.renderer,this.writeBuffer,this.readBuffer,e),t.stencilFunc(t.EQUAL,1,4294967295)),this.swapBuffers()),r instanceof g?i=!0:r instanceof w&&(i=!1))},reset:function(e){var t;void 0===e&&(t=this.renderer.getSize(),(e=this.renderTarget1.clone()).setSize(t.width,t.height)),this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.renderTarget1=e,this.renderTarget2=e.clone(),this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2},setSize:function(e,t){this.renderTarget1.setSize(e,t),this.renderTarget2.setSize(e,t);for(var r=0;r<this.passes.length;r++)this.passes[r].setSize(e,t)},setColorTarget:function(e){this.colorTarget&&this.colorTarget.dispose(),this.colorTarget=e,this.renderTarget1.setSize(e.width,e.height),this.renderTarget2.setSize(e.width,e.height);for(var t=0;t<this.passes.length;t++)this.passes[t].setSize(e.width,e.height)}}),b.prototype=Object.assign(Object.create(u.prototype),{constructor:b,render:function(e,t,r,i,n){var a,o,s=e.autoClear;e.autoClear=!1,this.scene.overrideMaterial=this.overrideMaterial,this.clearColor&&(a=e.getClearColor(this.oldClearColor).getHex(),o=e.getClearAlpha(),e.setClearColor(this.clearColor,this.clearAlpha)),this.clearDepth&&e.clearDepth(),e.render(this.scene,this.camera,this.renderToScreen?null:r,this.clear),this.clearColor&&e.setClearColor(a,o),this.scene.overrideMaterial=null,e.autoClear=s}}),B.prototype=Object.assign(Object.create(u.prototype),{constructor:b,render:function(e,t,r,i,n,a,o){void 0===o&&(o=null);var s,l,d,c,h=e.autoClear,u=(e.autoClear=!1,this.viewer.scene.overrideMaterial);this.scene.overrideMaterial=this.overrideMaterial,null!==this.overrideMaterial&&(s=(new this.overrideMaterial.constructor).copy(this.overrideMaterial),this.viewer.ndsModel.setOverrideMaterial(this.overrideMaterial,s,!1)),this.clearColor&&(l=e.getClearColor(this.oldClearColor).getHex(),d=e.getClearAlpha(),e.setClearColor(this.clearColor,this.clearAlpha)),this.clearDepth&&e.clearDepth(),this.viewer.ndsModel.backupDirty(),this.viewer.ndsModel.backupAllBodyFlag(),this.viewer.ndsModel.setDirty(),this.viewer.ndsModel.setDrawMode(this.viewer.ndsModel.SHADED),this.scene.children.push(this.viewer.ndsModel),this.viewer.ndsModel.meshManager.selectedMaterial&&(c=this.viewer.ndsModel.meshManager.selectedMaterial.clone(),this.viewer.ndsModel.meshManager.selectedMaterial=this.selectedMaterial);for(var p=0;p<this.viewer.scene.children.length;++p)"Object3D"==this.viewer.scene.children[p].type&&(this.viewer.scene.children[p].oldVisible=this.viewer.scene.children[p].visible,this.viewer.scene.children[p].visible=!1);e.render(this.scene,this.viewer.camera,r,this.clear,!1,!1,a),o&&o(),this.clearColor&&e.setClearColor(l,d),this.viewer.ndsModel.setOverrideMaterial(null,null,!1),this.viewer.ndsModel.resetAllBodyFlag(),this.viewer.ndsModel.resetDirty(),this.viewer.ndsModel.meshManager.selectedMaterial&&(this.viewer.ndsModel.meshManager.selectedMaterial=c);for(var f=0;f<this.viewer.scene.children.length;++f)"Object3D"==this.viewer.scene.children[f].type&&(this.viewer.scene.children[f].visible=this.viewer.scene.children[f].oldVisible);this.scene.overrideMaterial=u,e.autoClear=h}}),Ce.BODYFLAG={NONE_FLAG:0,SELECTED_FLAG:1,HIDDEN_FLAG:2,ISOLATED_FLAG:4,TRANSPARENT_FLAG:8,PRESELECTED_FLAG:16,DRAGGED_FLAG:32,ORIGINALTRANSPARENT_FLAG:64},0),se=function(e){var t=this;this.id=oe++,this.bodyFlag=Ce.BODYFLAG.NONE_FLAG,this._bodyMeshIds=[],this._bodyLineSegIds=[],this.bodyTextIds=[],this.Node=e,this._bodyBbox=null,this.bodyOpacity=1,this._mesh_box_=new THREE.Box3,this.isHidden=function(){return 0!=(t.bodyFlag&Ce.BODYFLAG.HIDDEN_FLAG)},this.isTransparent=function(){return 0!=(t.bodyFlag&Ce.BODYFLAG.TRANSPARENT_FLAG)},this.isPreSelected=function(){return 0!=(t.bodyFlag&Ce.BODYFLAG.PRESELECTED_FLAG)},this.isSelected=function(){return 0!=(t.bodyFlag&Ce.BODYFLAG.SELECTED_FLAG)},this.isIsolated=function(){return 0!=(t.bodyFlag&Ce.BODYFLAG.ISOLATED_FLAG)},this.isOriginalTransparent=function(){return 0!=(t.bodyFlag&Ce.BODYFLAG.ORIGINALTRANSPARENT_FLAG)},this.isDragged=function(){return 0!=(t.bodyFlag&Ce.BODYFLAG.DRAGGED_FLAG)}},ce=(Object.defineProperties(se.prototype,{bodyMeshIds:{get:function(){var t;return this.Node.getModel().NeedsMergeBodyNode&&!this.Node.IsMergedNode?this.totalMeshIds||(t=[],this.Node.parent.children.forEach(function(e){!e.unload&&e._leafBodyAttri&&(t=t.concat(e._leafBodyAttri._bodyMeshIds))}),this.totalMeshIds=t.concat(),t):this._bodyMeshIds},set:function(e){this._bodyMeshIds=e}},bodyLineSegIds:{get:function(){var t;return this.Node.getModel().NeedsMergeBodyNode&&!this.Node.IsMergedNode?this.totalLineSegIds||(t=[],this.Node.parent.children.forEach(function(e){!e.unload&&e._leafBodyAttri&&(t=t.concat(e._leafBodyAttri._bodyLineSegIds))}),this.totalLineSegIds=t.concat(),t):this._bodyLineSegIds},set:function(e){this._bodyLineSegIds=e}},bodyBbox:{get:function(){var r,i=this;return this.Node.ndsModel.NeedsMergeBodyNode&&!this.Node.IsMergedNode?this.totalBbox||(r=[1/0,1/0,1/0,-1/0,-1/0,-1/0],this.Node.parent.children.forEach(function(e){if(!e.unload&&e._leafBodyAttri&&(i.Node.ndsModel.isMCAD2DModel||i.Node.ndsModel.isSketchModel||0<e._leafBodyAttri._bodyMeshIds.length||0<e._leafBodyAttri._bodyLineSegIds.length&&0===i.Node.ndsModel.meshManager.nMeshes)){e.__bounding_box_dirty__&&e._leafBodyAttri.updateBoundingBox();for(var t=0;t<3;++t)r[t]>e._leafBodyAttri._bodyBbox[t]&&(r[t]=e._leafBodyAttri._bodyBbox[t]),r[3+t]<e._leafBodyAttri._bodyBbox[3+t]&&(r[3+t]=e._leafBodyAttri._bodyBbox[3+t])}}),this.totalBbox=r.concat(),r):this._bodyBbox},set:function(e){this._bodyBbox=e}}}),se.prototype.updateBoundingBox=function(){function e(e,t){e[0]>t.min.x&&(e[0]=t.min.x),e[1]>t.min.y&&(e[1]=t.min.y),e[2]>t.min.z&&(e[2]=t.min.z),e[3]<t.max.x&&(e[3]=t.max.x),e[4]<t.max.y&&(e[4]=t.max.y),e[5]<t.max.z&&(e[5]=t.max.z)}this.totalBbox&&(this.totalBbox=null);var t=this.Node.ndsModel.viewer.is2DModel,r=this.Node.ndsModel.meshManager;if(this._bodyBbox||(this._bodyBbox=[]),this._bodyBbox[0]=1/0,this._bodyBbox[1]=1/0,this._bodyBbox[2]=1/0,this._bodyBbox[3]=-1/0,this._bodyBbox[4]=-1/0,this._bodyBbox[5]=-1/0,this.__isBBoxDirty__=!1,t||this.Node.ndsModel.isSketchModel||0===this._bodyMeshIds.length)for(var i=0,n=this._bodyLineSegIds.length;i<n;++i)r.getLineSegBBox(this._bodyLineSegIds[i],this._mesh_box_),e(this._bodyBbox,this._mesh_box_);for(var a=0,o=this.bodyMeshIds.length;a<o;++a)r.getMeshBBox(this.bodyMeshIds[a],this._mesh_box_),e(this._bodyBbox,this._mesh_box_),this.__isBBoxDirty__=r.isMeshBBoxDirty(this.bodyMeshIds[a])},function(){this.bodyFlag=Ce.BODYFLAG.NONE_FLAG,this.renderObject=null}),_e=(Ce.COMPONENT_ELEMENT_FLAG={NONE_FLAG:0,COORDINATE_VISIBLE_FLAG:1,REFPLANE_VISIBLE_FLAG:2,REFAXIS_VISIBLE_FLAG:4,BODY_VISISBLE_FLAG:8},function n(){var r=arguments,i=this;this.uuid=null,this.name=null,this.ndsModel=null,this.type=null,this.visible=!0,this.fixed=!1,this.children=[],this.parent=null,this.persistentId=null,this.externalRefUuid=null,this.area=void 0,this.volume=void 0,this.matrix=null,this.worldMatrix=null,this.synchronizedWorldMatrix=[],this.worldMatrixNeedsUpdate=!0,this.objectid=null,this.id=-1,this._leafBodyAttri=null,this._mesh_box_dirty_=!1,this.componentElementFlag=Ce.COMPONENT_ELEMENT_FLAG.BODY_VISISBLE_FLAG,this.useBodyNodeMaterial=!1,this.userMaterial=null,this.refNum=0,this.IsMergedNode=!1,this.layerId=null,this.responsNode=null,this.IsBatchedNode=!1,this.subparts=null,this.defaultVisible=!0,this.cullInfo={valid:!1,cullState:1},this.add=function(e){if(1<r.length)for(var t=0;t<r.length;t++)i.add(r[t]);else i.children.indexOf(e)<0&&(e.parent&&e.parent.remove(e),e.lastParent&&delete e.lastParent,(e.parent=i).children.push(e));return i},this.remove=function(e){if(1<arguments.length)for(var t=0;t<arguments.length;t++)this.remove(arguments[t]);else{var r=this.children.indexOf(e);-1!==r&&(e.lastParent=this,e.parent=null,this.children.splice(r,1))}return this},this.copyFrom=function(e,t){this.uuid=e.uuid,this.name=e.name,this.type=e.type,this.refNum=e.refNum,this.visible=e.visible,this._originalVisible=e._originalVisible,this.visible=e._originalVisible,this.fixed=e.fixed,this._originalMatrix=e._originalMatrix,this.matrix=e._originalMatrix?e._originalMatrix.slice():null,this.persistentId=e.persistentId,this.externalRefUuid=e.externalRefUuid,this.objectid=e.objectid,this.id=e.id,this.fullpath=e.fullpath,this.propertyfile=e.propertyfile,this.unload=e.unload,this.volume=e.volume,this.area=e.area,this.referencename=e.referencename,e.fileUnit&&(this.fileUnit=e.fileUnit),e.referenceNode&&(this.referenceNode=e.referenceNode),this.ndsModel=t,e.pmiuuid&&t.pmiuuidMap&&(this.pmiuuid=e.pmiuuid.map(function(e){return t.pmiuuidMap.get(e)})),e.bodyPmiuuid&&t.pmiuuidMap&&(this.bodyPmiuuid=e.bodyPmiuuid.map(function(e){return t.pmiuuidMap.get(e)})),this.propertyList=e.propertyList,this.componentElementFlag=e.componentElementFlag,this.useBodyNodeMaterial=e.useBodyNodeMaterial,this.renderMode=e.renderMode;for(var r=0;r<e.children.length;++r){var i=new n;i.parent=this,i.copyFrom(e.children[r],t),this.children.push(i)}},this.clone=function(){var e=new n;e.uuid=this.uuid,e.name=this.name,e.refNum=this.refNum,e.type=this.type,e.visible=this.visible,e.fixed=this.fixed,e.matrix=this.matrix||[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],e.persistentId=this.persistentId,e.externalRefUuid=this.externalRefUuid,e.worldMatrix=this.worldMatrix,e.objectid=this.objectid,e.id=this.id,e.fullpath=this.fullpath,e.propertyfile=this.propertyfile,e.unload=this.unload,e.volume=this.volume,e.area=this.area,e.renderMode=this.renderMode,e.referencename=this.referencename,this.ndsModel&&(e.ndsModel=this.ndsModel),e.pmiuuid=this.pmiuuid,e.bodyPmiuuid=this.bodyPmiuuid,this.refMatrix&&(e.refMatrix=this.refMatrix),this.propertyList&&(e.propertyList=this.propertyList),e.leafBodyAttri=this.leafBodyAttri,e.componentElementFlag=this.componentElementFlag,e.useBodyNodeMaterial=this.useBodyNodeMaterial;for(var t=0;t<this.children.length;t++)(!De.HideLeafBody||this.children[t]&&"Body"!=this.children[t].type)&&e.add(this.children[t].clone());return e},this.cloneNew=function(){var e=new n;if(e.uuid=this.uuid+"_"+Math.random(),e.name=this.name,e.type=this.type,e.refNum=this.refNum,e.visible=this.visible,e.fixed=this.fixed,e.matrix=this.matrix,e.worldMatrix=this.worldMatrix,e.objectid=this.objectid,e.id=this.id,e.persistentId=this.persistentId,e.externalRefUuid=this.externalRefUuid,e.fullpath=this.fullpath,e.propertyfile=this.propertyfile,e.unload=this.unload,e.volume=this.volume,e.area=this.area,e.renderMode=this.renderMode,this.ndsModel&&(e.ndsModel=this.ndsModel),this.sketchRefModelUri&&(e.sketchRefModelUri=this.sketchRefModelUri),e.pmiuuid=this.pmiuuid,e.bodyPmiuuid=this.bodyPmiuuid,this.refMatrix&&(e.refMatrix=this.refMatrix),e.leafBodyAttri=this.leafBodyAttri,e.componentElementFlag=this.componentElementFlag,e.useBodyNodeMaterial=this.useBodyNodeMaterial,this.children[0]&&"Body"!=this.children[0].type)for(var t=0;t<this.children.length;t++)e.add(this.children[t].cloneNew());return e},this.__bounding_box_dirty__=!0,this.__setBoundingBoxDirty__=function(){i.__bounding_box_dirty__=!0,i.parent&&!i.parent.__bounding_box_dirty__&&i.parent.__setBoundingBoxDirty__()},this.__bounding_box__=new THREE.Box3,this.__bounding_sphere__=new THREE.Sphere}),_=new THREE.Box3;_e.prototype={constructor:_e,applyTransform:function(e){if(void 0===e&&(e=null),this._leafBodyAttri){if(e&&(e[e.length]=this),this.matrix){for(var t=0;t<16;++t)this.worldMatrix.elements[t]=this.matrix[t];this.parent&&this.worldMatrix.premultiply(this.parent.worldMatrix)}else this.parent?this.worldMatrix.copy(this.parent.worldMatrix):this.worldMatrix.identity();e=this.ndsModel.getBodyTransform(this);this.worldMatrix.copy(e.multiply(this.worldMatrix)),this._mesh_box_dirty_=!0;for(var r=0;r<this.synchronizedWorldMatrix.length;++r)this.synchronizedWorldMatrix[r].copy(this.worldMatrix);this.__setBoundingBoxDirty__(),this.ndsModel.meshManager.makeMeshBBoxDirty(this._leafBodyAttri._bodyMeshIds)}for(var i=0;i<this.children.length;++i)this.children[i].applyTransform()},updateMatrixWorld:function(e,t){if(void 0===t&&(t=!0),(e=void 0===e?!1:e)||this.worldMatrixNeedsUpdate){if(this.worldMatrix||(this.worldMatrix=new THREE.Matrix4),this.matrix)for(var r=0;r<16;++r)this.worldMatrix.elements[r]=this.matrix[r];else this.worldMatrix.identity();if(this.parent&&this.worldMatrix.premultiply(this.parent.worldMatrix),this._leafBodyAttri){var i=this.ndsModel.getBodyTransform(this);this.worldMatrix.copy(i.multiply(this.worldMatrix));for(var n=0;n<this.synchronizedWorldMatrix.length;++n)this.synchronizedWorldMatrix[n].copy(this.worldMatrix);this.__setBoundingBoxDirty__(),(this._mesh_box_dirty_=t)&&this.ndsModel.meshManager.makeMeshBBoxDirty(this._leafBodyAttri._bodyMeshIds)}for(var a=0;a<this.children.length;++a)this.children[a].updateMatrixWorld(e,t);this.worldMatrixNeedsUpdate=!1}},getBoundingBox:function(e,t){return void 0===e&&(e=null),this.updateBoundingBox(t=void 0===t?!0:t),e?(e.copy(this.__bounding_box__),e):this.__bounding_box__},getBoundingSphere:function(e,t){return void 0===e&&(e=null),this.updateBoundingBox(t=void 0===t?!0:t),e?(e.copy(this.__bounding_sphere__),e):this.__bounding_sphere__},updateBoundingBox:function(e){if(void 0===e&&(e=!0),this.__bounding_box_dirty__){if(this._leafBodyAttri&&(0<this._leafBodyAttri._bodyLineSegIds.length&&(this.ndsModel.viewer.is2DModel||0===this.ndsModel.meshManager.nMeshes)||0<this._leafBodyAttri._bodyMeshIds.length))this._mesh_box_dirty_&&(this._leafBodyAttri.updateBoundingBox(),this._mesh_box_dirty_=this._leafBodyAttri.__isBBoxDirty__),this.__bounding_box__.min.fromArray(this._leafBodyAttri.bodyBbox,0),this.__bounding_box__.max.fromArray(this._leafBodyAttri.bodyBbox,3),this.__bounding_box_dirty__=this._mesh_box_dirty_;else{this.__bounding_box__.makeEmpty(),this.__bounding_box_dirty__=!1;for(var t,r=0;r<this.children.length;r++)this.children[r].unload?(this.children[r].__bounding_box_dirty__=!1,this.children[r].__bounding_box__.makeEmpty()):(t=this.ndsModel.getBodyOrSomeChildVisibleStatus(this.children[r]),e&&0===t?e&&0===t&&this.children[r].__bounding_box_dirty__&&(this.children[r].updateBoundingBox(e),this.children[r].__bounding_box_dirty__=!1,this.children[r].__bounding_box__.makeEmpty()):(this.children[r].updateBoundingBox(e),this.__bounding_box__.union(this.children[r].__bounding_box__),this.children[r].__bounding_box_dirty__&&(this.__bounding_box_dirty__=!0)))}this.__bounding_box__.getBoundingSphere(this.__bounding_sphere__)}},setMatrixWorld:function(e){this.worldMatrix||(this.worldMatrix=new THREE.Matrix4);for(var t=0;t<16;++t)this.worldMatrix.elements[t]=e.elements[t];if(this._leafBodyAttri){for(var r=0;r<this.synchronizedWorldMatrix.length;++r)this.synchronizedWorldMatrix[r].copy(this.worldMatrix);this.__setBoundingBoxDirty__(),this._mesh_box_dirty_=!0,this.ndsModel.meshManager.makeMeshBBoxDirty(this._leafBodyAttri._bodyMeshIds)}for(var i=0;i<this.children.length;++i)this.children[i].updateMatrixWorld(!0)},intersect2D:function(e,t,r,i,n){if(!(n&&6<=r.length)){var a=this.getBoundingBox(_);if(Math.abs(a.min.x-a.max.x)<t&&(a.min.x-=t/2,a.max.x+=t/2),Math.abs(a.min.y-a.max.y)<t&&(a.min.y-=t/2,a.max.y+=t/2),!this.isHidden()){var o=this.ndsModel.viewer.is2DModel;if((!o||!(e.origin.x<a.min.x-t||e.origin.x>a.max.x+t||e.origin.y<a.min.y-t||e.origin.y>a.max.y+t))&&(o||!1!==e.intersectsBox(a))){var s=this.ndsModel,l=this.ndsModel.meshManager,o=this.leafBodyAttri;if(o&&r&&0<t){for(var d=o.bodyLineSegIds,c=0;c<d.length;++c)if(n){var h=l.intersectLineSegments2D(d[c],e,1/0,t,s.is2DModel,2);if(h)for(var u=0;u<h.length;u++)h[u]&&l.getLineSegments(h[u].lineSegId)&&r.push(h[u]);if(6<=r.length)break}else{var p=l.intersectLineSegments2D(d[c],e,1/0,t,s.is2DModel,1);p&&p[0]&&l.getLineSegments(p[0].lineSegId)&&r.push(p[0])}if(0<r.length){if(n){r.sort(function(e,t){return e.distance-t.distance});for(var f=0;f<r.length;f++)r[f].bodyNode=s.bodyUuid2NodeMap[r[f].bodyUuid],r[f].object=r[f].bodyNode;return}for(var m=0,g=r[0].distance,v=1,y=r.length;v<y;++v)r[v].distance<g&&(g=r[v].distance,m=v);r[m].bodyNode=s.bodyUuid2NodeMap[r[m].bodyUuid],r[m].object=r[m].bodyNode,0!==m&&(r[0]=r[m]),r.length=1}}for(var A=0,M=this.children.length;A<M;++A)this.children[A].intersect2D(e,t,r,i,n)}}}},intersect:function(e,t,r,i){var n=this.getBoundingBox(_);if(Math.abs(n.min.x-n.max.x)<t&&(n.min.x-=t/2,n.max.x+=t/2),Math.abs(n.min.y-n.max.y)<t&&(n.min.y-=t/2,n.max.y+=t/2),!this.isHidden()){var a=this.ndsModel.viewer.is2DModel;if((!a||!(e.origin.x<n.min.x-t||e.origin.x>n.max.x+t||e.origin.y<n.min.y-t||e.origin.y>n.max.y+t))&&(a||!1!==e.intersectsBox(n))){var o=this.ndsModel,s=this.ndsModel.meshManager,a=this.leafBodyAttri;if(a){if(r&&0<t){for(var l=a.bodyLineSegIds,d=0;d<l.length;++d){var c=s.intersectLineSegments(l[d],e,1/0,t,o.is2DModel);c&&s.getLineSegments(c.lineSegId)&&r.push(c)}if(0<r.length){for(var h=0,u=r[0].distance,p=1,f=r.length;p<f;++p)r[p].distance<u&&(u=r[p].distance,h=p);r[h].bodyNode=o.bodyUuid2NodeMap[r[h].bodyUuid],r[h].object=r[h].bodyNode,0!==h&&(r[0]=r[h]),r.length=1}}if(i){for(var m=a.bodyMeshIds,g=0;g<m.length;++g){var v=s.intersectMesh(m[g],e);v&&i.push(v)}if(0<i.length){for(var y=0,A=i[0].distance,M=1,E=i.length;M<E;++M)i[M].distance<A&&(A=i[M].distance,y=M);i[y].bodyNode=o.bodyUuid2NodeMap[i[y].bodyUuid],i[y].object=i[y].bodyNode,0!==y&&(i[0]=i[y]),i.length=1}}}for(var w=0,x=this.children.length;w<x;++w)this.children[w].intersect(e,t,r,i)}}},isFixed:function(){if(this.fixed)return!0;for(var e=this.parent;e;){if(e.fixed)return!0;e=e.parent}return!1},isSelected:function(){var e=this;return!!(e=this.ndsModel.NeedsMergeBodyNode&&this.IsMergedNode&&this.responsNode?this.responsNode:e)._leafBodyAttri&&e._leafBodyAttri.isSelected()},isTransparent:function(){var e=this;return!!(e=this.ndsModel.NeedsMergeBodyNode&&this.IsMergedNode&&this.responsNode?this.responsNode:e)._leafBodyAttri&&e._leafBodyAttri.isTransparent()},isOriginalTransparent:function(){return!!this.leafBodyAttri&&this.leafBodyAttri.isOriginalTransparent()},isIsolated:function(){return!!this.leafBodyAttri&&this.leafBodyAttri.isIsolated()},isHidden:function(e){var t;return void 0===e&&(e=!1),!!this.unload||!!((t=this).ndsModel.NeedsMergeBodyNode&&this.IsMergedNode&&this.responsNode&&(t=this.responsNode).unload)||!(!t._leafBodyAttri||!t._leafBodyAttri.isHidden()&&(e||("Body"!==this.type||"Assembly"!==this.parent.type&&"Part"!==this.parent.type?"RefAxis"!==this.type||"Assembly"!==this.parent.type&&"Part"!==this.parent.type?"RefPlane"!==this.type||"Assembly"!==this.parent.type&&"Part"!==this.parent.type?"CoordSystem"!==this.type||"Assembly"!==this.parent.type&&"Part"!==this.parent.type||!1!==this.parent.isComponentCoordinateSysVisible():!1!==this.parent.isComponentRefPlaneVisible():!1!==this.parent.isComponentRefAxisVisible():!1!==this.parent.isComponentBodyVisible())))},isPreSelected:function(){return!!this.leafBodyAttri&&this.leafBodyAttri.isPreSelected()},isDragged:function(){return!!this.leafBodyAttri&&this.leafBodyAttri.isDragged()},isReferenceEntity:function(){var e=this.type.toLowerCase();return"refplane"==e||"refaxis"==e||"refpoint"==e},isCoordinate:function(){return"coordsystem"==this.type.toLowerCase()},isOtherNode:function(){var e=this.type.toLowerCase();return"pmi"==e||"view"==e||"captures"==e||"views"==e||"capture"==e},isChildOfNode:function(e){for(var t=this.parent;t;){if(t==e)return!0;t=t.parent}return!1},select:function(){this.leafBodyAttri&&0==(this.leafBodyAttri.bodyFlag&Ce.BODYFLAG.SELECTED_FLAG)&&(this.leafBodyAttri.bodyFlag|=Ce.BODYFLAG.SELECTED_FLAG,this.updateReferenceEntityDisplayFlag())},deSelect:function(){this.leafBodyAttri&&0!=(this.leafBodyAttri.bodyFlag&Ce.BODYFLAG.SELECTED_FLAG)&&(this.leafBodyAttri.bodyFlag&=~Ce.BODYFLAG.SELECTED_FLAG,this.updateReferenceEntityDisplayFlag())},preSelect:function(){this.leafBodyAttri&&0==(this.leafBodyAttri.bodyFlag&Ce.BODYFLAG.PRESELECTED_FLAG)&&(this.leafBodyAttri.bodyFlag|=Ce.BODYFLAG.PRESELECTED_FLAG,this.updateReferenceEntityDisplayFlag())},dePreSelect:function(){this.leafBodyAttri&&0!=(this.leafBodyAttri.bodyFlag&Ce.BODYFLAG.PRESELECTED_FLAG)&&(this.leafBodyAttri.bodyFlag&=~Ce.BODYFLAG.PRESELECTED_FLAG,this.updateReferenceEntityDisplayFlag())},isEmptyNode:function(){return this.type.toLowerCase&&this.type.toLowerCase(),!this.leafBodyAttri&&0===this.children.length},hide:function(){this.leafBodyAttri?0==(this.leafBodyAttri.bodyFlag&Ce.BODYFLAG.HIDDEN_FLAG)&&(this.leafBodyAttri.bodyFlag|=Ce.BODYFLAG.HIDDEN_FLAG,this.updateReferenceEntityDisplayFlag(),this.visible=!1,"CoordSystem"==this.type&&this.leafBodyAttri.renderObject&&this.leafBodyAttri.renderObject.detach(),this.__setBoundingBoxDirty__()):this.isEmptyNode()&&(this.visible=!1)},show:function(){var e,t;this.leafBodyAttri?0!=(this.leafBodyAttri.bodyFlag&Ce.BODYFLAG.HIDDEN_FLAG)&&(this.leafBodyAttri.bodyFlag&=~Ce.BODYFLAG.HIDDEN_FLAG,this.updateReferenceEntityDisplayFlag(),this.visible=!0,"CoordSystem"==this.type&&(this.leafBodyAttri.renderObject?this.leafBodyAttri.renderObject.attach(this):(t=null,t=(e=this.getModel()).viewer.canvas2D||e.viewer.canvas3D,(t=new ae(e.viewer.camera,t)).attach(this),this.leafBodyAttri.renderObject=t,e.viewer.scene.add(t))),this.__setBoundingBoxDirty__()):this.isEmptyNode()&&(this.visible=!0)},transparent:function(){this.leafBodyAttri&&0==(this.leafBodyAttri.bodyFlag&Ce.BODYFLAG.TRANSPARENT_FLAG)&&(this.leafBodyAttri.bodyFlag|=Ce.BODYFLAG.TRANSPARENT_FLAG)},originalTransparent:function(){this.leafBodyAttri&&0==(this.leafBodyAttri.bodyFlag&Ce.BODYFLAG.ORIGINALTRANSPARENT_FLAG)&&(this.leafBodyAttri.bodyFlag|=Ce.BODYFLAG.ORIGINALTRANSPARENT_FLAG)},opaque:function(){this.leafBodyAttri&&0!=(this.leafBodyAttri.bodyFlag&Ce.BODYFLAG.TRANSPARENT_FLAG)&&(this.leafBodyAttri.bodyFlag&=~Ce.BODYFLAG.TRANSPARENT_FLAG)},isolate:function(){this.leafBodyAttri&&0==(this.leafBodyAttri.bodyFlag&Ce.BODYFLAG.ISOLATED_FLAG)&&(this.leafBodyAttri.bodyFlag|=Ce.BODYFLAG.ISOLATED_FLAG)},deIsolate:function(){this.leafBodyAttri&&0!=(this.leafBodyAttri.bodyFlag&Ce.BODYFLAG.ISOLATED_FLAG)&&(this.leafBodyAttri.bodyFlag&=~Ce.BODYFLAG.ISOLATED_FLAG)},setDragged:function(e){this.leafBodyAttri&&(e?this.leafBodyAttri.bodyFlag|=Ce.BODYFLAG.DRAGGED_FLAG:this.leafBodyAttri.bodyFlag&=~Ce.BODYFLAG.DRAGGED_FLAG)},getMaterialBodyNodeUUid:function(){for(var e=null,t=this;null!=t;)t.useBodyNodeMaterial&&(e=t.uuid),t=t.parent;return e},getUseBodyNodeMaterial:function(){return this.useBodyNodeMaterial},getAllMeshIds:function(){var e=this.getModel(),t=[];if(0<this.children.length)for(var r=e.getLeafBodies(this),i=r.length,n=0;n<i;++n)r[n].leafBodyAttri&&0!=r[n].leafBodyAttri.bodyMeshIds.length&&(t=t.concat(r[n].leafBodyAttri.bodyMeshIds));else if(this.leafBodyAttri)return this.leafBodyAttri.bodyMeshIds;return t},getAllbodyLineSegIds:function(){var e=this.getModel(),t=[];if(0<this.children.length)for(var r=e.getLeafBodies(this),i=r.length,n=0;n<i;++n)r[n].leafBodyAttri&&0!=r[n].leafBodyAttri.bodyLineSegIds.length&&(t=t.concat(r[n].leafBodyAttri.bodyLineSegIds));else if(this.leafBodyAttri)return this.leafBodyAttri.bodyLineSegIds;return t},getUserMaterial:function(){return this.leafBodyAttri||this.IsMergedNode?this.userMaterial:null},setUserMaterial:function(t){function r(e){e.userMaterial&&e.userMaterial.dispose(),e.userMaterial=t}this.leafBodyAttri&&(r(this),this.getModel().NeedsMergeBodyNode&&this.parent.children.forEach(function(e){e.IsMergedNode&&r(e)}),this.getModel().meshMtlNeedsUpdate=!0)},getModel:function(){if(this.ndsModel)return this.ndsModel;for(var e=this.parent;e;){if(e.ndsModel)return e.ndsModel;e=e.parent}return null},getLevel:function(){for(var e=0,t=this;t;){if(e++,t.ndsModel&&!t.parent)return e;t=t.parent}return e},updateReferenceEntityDisplayFlag:function(){var e;"RefAxis"==this.type?(e=this.getModel())&&(e.referenceEntityDispManager.needUpdateRefAxisDispData=!0):"RefPlane"==this.type&&(e=this.getModel())&&(e.referenceEntityDispManager.needUpdateRefPlaneDispData=!0)},isComponentRefPlaneVisible:function(){return 0!=(this.componentElementFlag&Ce.COMPONENT_ELEMENT_FLAG.REFPLANE_VISIBLE_FLAG)},isComponentRefAxisVisible:function(){return 0!=(this.componentElementFlag&Ce.COMPONENT_ELEMENT_FLAG.REFAXIS_VISIBLE_FLAG)},isComponentCoordinateSysVisible:function(){return 0!=(this.componentElementFlag&Ce.COMPONENT_ELEMENT_FLAG.COORDINATE_VISIBLE_FLAG)},isComponentBodyVisible:function(){return 0!=(this.componentElementFlag&Ce.COMPONENT_ELEMENT_FLAG.BODY_VISISBLE_FLAG)},setComponentRefPlaneVisibility:function(e){if("Part"==this.type||"Assembly"==this.type)if(e){0==(this.componentElementFlag&Ce.COMPONENT_ELEMENT_FLAG.REFPLANE_VISIBLE_FLAG)&&(this.componentElementFlag|=Ce.COMPONENT_ELEMENT_FLAG.REFPLANE_VISIBLE_FLAG);for(var t=0;t<this.children.length;t++)"RefPlane"==(r=this.children[t]).type&&r.show()}else{0!=(this.componentElementFlag&Ce.COMPONENT_ELEMENT_FLAG.REFPLANE_VISIBLE_FLAG)&&(this.componentElementFlag&=~Ce.COMPONENT_ELEMENT_FLAG.REFPLANE_VISIBLE_FLAG);for(var r,t=0;t<this.children.length;t++)"RefPlane"==(r=this.children[t]).type&&r.hide()}},setComponentRefAxisVisibility:function(e){if(e){0==(this.componentElementFlag&Ce.COMPONENT_ELEMENT_FLAG.REFAXIS_VISIBLE_FLAG)&&(this.componentElementFlag|=Ce.COMPONENT_ELEMENT_FLAG.REFAXIS_VISIBLE_FLAG);for(var t=0;t<this.children.length;t++)"RefAxis"==(r=this.children[t]).type&&r.show()}else{0!=(this.componentElementFlag&Ce.COMPONENT_ELEMENT_FLAG.REFAXIS_VISIBLE_FLAG)&&(this.componentElementFlag&=~Ce.COMPONENT_ELEMENT_FLAG.REFAXIS_VISIBLE_FLAG);for(var r,t=0;t<this.children.length;t++)"RefAxis"==(r=this.children[t]).type&&r.hide()}},setComponentCoordinateSysVisibility:function(e){if("Part"==this.type||"Assembly"==this.type||"Model"==this.type){var t=this.getModel();if(e){0==(this.componentElementFlag&Ce.COMPONENT_ELEMENT_FLAG.COORDINATE_VISIBLE_FLAG)&&(this.componentElementFlag|=Ce.COMPONENT_ELEMENT_FLAG.COORDINATE_VISIBLE_FLAG);for(var r=0;r<this.children.length;r++)"CoordSystem"==(i=this.children[r]).type&&i.show()}else{0!=(this.componentElementFlag&Ce.COMPONENT_ELEMENT_FLAG.COORDINATE_VISIBLE_FLAG)&&(this.componentElementFlag&=~Ce.COMPONENT_ELEMENT_FLAG.COORDINATE_VISIBLE_FLAG);for(var i,r=0;r<this.children.length;r++)"CoordSystem"==(i=this.children[r]).type&&i.hide()}t.viewer.render()}},setComponentBodyVisibility:function(e){"Part"!=this.type&&"Assembly"!=this.type||(e?0==(this.componentElementFlag&Ce.COMPONENT_ELEMENT_FLAG.BODY_VISISBLE_FLAG)&&(this.componentElementFlag|=Ce.COMPONENT_ELEMENT_FLAG.BODY_VISISBLE_FLAG):0!=(this.componentElementFlag&Ce.COMPONENT_ELEMENT_FLAG.BODY_VISISBLE_FLAG)&&(this.componentElementFlag&=~Ce.COMPONENT_ELEMENT_FLAG.BODY_VISISBLE_FLAG))}};function L(e,t){return(L=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}Object.defineProperties(_e.prototype,{leafBodyAttri:{get:function(){var e=this.getModel();return this.unload||e.NeedsMergeBodyNode&&this.IsMergedNode?null:this._leafBodyAttri},set:function(e){this._leafBodyAttri=e}}});function O(e){var r=this;this.refCount=0,this.geoms=[],this.uuidToIdMap={},this.usedGpuMemory=0,this.usedGpuMemoryInstanced=0,this.usedGpuMemoryLineSeg=0,this.usedMemory=0,this.viewer=e,this.pointGeomsMap={},this.maxGpuMemory=419430400,this.maxMemory=1.25*this.maxGpuMemory,this.loadedVertexAttributes=new Set,this.stopLoading=!1,this.allGeomInMemory=!0,this.ignorePendingBufferChunks=!1,this.ignorePendingLineSegBufferChunks=!1,this.maxBufferChunksInLoading=4,this.bufferChunksInLoading=0,this.bufferChunksToLoad=[],this.bufferChunk={},this.enableMergeGeomChunk=!1,this.dispose=function(){if(1===r.refCount){for(var e=0,t=r.geoms.length;e<t;++e)r.geoms[e].dispose(),r.geoms[e]=null;r.geoms=[]}else--r.refCount}}function F(e,t){var i=this,n=(void 0===t&&(t=!1),this.isRefGeometryManager=!0,this.renderContext=null,e);this.geoms=[];for(var r=0,a=n.geoms.length;r<a;++r)this.geoms[r]={owner:this,refMeshes:n.geoms[r].refMeshes,refLineSegs:n.geoms[r].refLineSegs,refTexts:n.geoms[r].refTexts,dirty:n.geoms[r].dirty,modelMatrixAttribute:t?n.geoms[r].modelMatrixAttribute:null,isInstancedBufferGeometry:!1,instanceCount:0,drawRange:n.geoms[r].drawRange};function o(e){var t=n.geoms[e],e=(t.refGeom=null,i.geoms[e]);t.dirty=e.dirty,t.modelMatrixAttribute=e.modelMatrixAttribute,t.modelMatrixAttribute?t.setAttribute("modelMatrixAttrib",e.modelMatrixAttribute):t.hasAttribute("modelMatrixAttrib")&&t.deleteAttribute("modelMatrixAttrib"),t.isInstancedBufferGeometry=e.isInstancedBufferGeometry,t.instanceCount=e.instanceCount,t.refGeom=e}this.bufferChunk=n.bufferChunk,Object.defineProperties(this,{geometryManager:{get:function(){return n}},refCount:{get:function(){return n.refCount},set:function(e){n.refCount=e}},uuidToIdMap:{get:function(){return n.uuidToIdMap}},usedGpuMemory:{get:function(){return n.usedGpuMemory},set:function(e){n.usedGpuMemory=e}},usedGpuMemoryInstanced:{get:function(){return n.usedGpuMemoryInstanced}},usedGpuMemoryLineSeg:{get:function(){return n.usedGpuMemoryLineSeg}},usedMemory:{get:function(){return n.usedMemory},set:function(e){n.usedMemory=e}},maxGpuMemory:{get:function(){return n.maxGpuMemory},set:function(e){n.maxGpuMemory=e}},maxMemory:{get:function(){return n.maxMemory},set:function(e){n.maxMemory=e}},loadedVertexAttributes:{get:function(){return n.loadedVertexAttributes},set:function(e){n.loadedVertexAttributes=e}}}),this.dispose=function(){if(i.renderContext)for(var e=0,t=i.geoms.length;e<t;++e){var r=i.geoms[e].modelMatrixAttribute;r&&i.renderContext.attributes.remove(r)}n.dispose(),i.geoms=null},this.addGeom=function(e){n.addGeom(e)},this.addPointGeom=function(e){n.addPointGeom(e)},this.getGeomFromId=function(e){if(!(e>=i.geoms.length||e<0))return o(e),n.geoms[e]},this.getGeomIdFromUuid=function(e,t){return n.getGeomIdFromUuid(e,t)},this.getGeomFromUuid=function(e,t){e=n.getGeomIdFromUuid(e,t);return-1<e?(o(e),n.geoms[e]):null}}function U(e){this.meshManager=e,this.dirty=!0}function N(e,t,r,i){this.meshId=e,this.materialId=t,this.programId=r,this.z=i}var le=function(r){function e(){var e=r.call(this)||this;return e.isNdsGeometry=!0,e.needsUpdate=!1,e.subGeomId=null,e.boundingBox=new THREE.Box3,e.boundingSphere=null,e.bufferLength=0,e.vertexColors=!1,e.loaded=!1,e.refMeshes=[],e.refLineSegs=[],e.refTexts=[],e._dirty=!0,e._modelMatrixAttribute=null,e._isInstancedBufferGeometry=!1,e._instanceCount=0,e.viewportId=-1,e.isBatchedGeometry=!1,Object.defineProperties(e,{dirty:{get:function(){return this.refGeom?this.refGeom.dirty:this._dirty},set:function(e){this.refGeom?this.refGeom.dirty=e:this._dirty=e}},modelMatrixAttribute:{get:function(){return this.refGeom?this.refGeom.modelMatrixAttribute:this._modelMatrixAttribute},set:function(e){this.refGeom?this.refGeom.modelMatrixAttribute=e:this._modelMatrixAttribute=e}},isInstancedBufferGeometry:{get:function(){return this.refGeom?this.refGeom.isInstancedBufferGeometry:this._isInstancedBufferGeometry},set:function(e){this.refGeom?this.refGeom.isInstancedBufferGeometry=e:this._isInstancedBufferGeometry=e}},instanceCount:{get:function(){return this.refGeom?this.refGeom.instanceCount:this._instanceCount},set:function(e){this.refGeom?this.refGeom.instanceCount=e:this._instanceCount=e}}}),e}t=r,(i=e).prototype=Object.create(t.prototype),L(i.prototype.constructor=i,t);var t,i=e.prototype;return i.setIndex=function(e){return this.needsUpdate=!0,r.prototype.setIndex.call(this,e)},i.setAttribute=function(e,t){return this.needsUpdate=!0,r.prototype.setAttribute.call(this,e,t)},i.deleteAttribute=function(e){return this.needsUpdate=!0,r.prototype.deleteAttribute.call(this,e)},i.applyMatrix4=function(e){return this.needsUpdate=!0,r.prototype.applyMatrix4.call(this,e)},e}(THREE.BufferGeometry);O.prototype={constructor:O,addGeom:function(e){var t=this.geoms.length;if(void 0===this.uuidToIdMap[e.uuid])this.uuidToIdMap[e.uuid]=[t],this.geoms.push(e);else{for(var r,i=0;i<this.uuidToIdMap[e.uuid].length;i++)if(r=this.uuidToIdMap[e.uuid][i],this.geoms[r].subGeomId==e.subGeomId)return t=r;this.geoms.push(e),this.uuidToIdMap[e.uuid].push(t)}return t},addPointGeom:function(e){void 0===this.pointGeomsMap[e.uuid]&&(this.pointGeomsMap[e.uuid]=e)},getPointGeomFromUuid:function(e){return this.pointGeomsMap[e]},getGeomFromId:function(e){if(!(e>=this.geoms.length||e<0))return this.geoms[e]},getGeomIdFromUuid:function(e,t){var r=this.uuidToIdMap[e];if(void 0!==(r=void 0===r&&e.toUpperCase?this.uuidToIdMap[e.toUpperCase()]:r))for(var i=0,i=0;i<r.length;++i)if(this.geoms[r[i]].subGeomId===t)return r[i];return-1},getGeomFromUuid:function(e,t){e=this.getGeomIdFromUuid(e,t);return-1<e?this.geoms[e]:null},useSmallMemory:function(){this.maxGpuMemory=83886080,this.maxMemory=1.25*this.maxGpuMemory},useMediumMemory:function(){this.maxGpuMemory=314572800,this.maxMemory=1.25*this.maxGpuMemory},useLargeMemory:function(){this.maxGpuMemory=629145600,this.maxMemory=1.25*this.maxGpuMemory},usePCMemory:function(){this.maxGpuMemory=2147483648,this.maxMemory=3*this.maxGpuMemory},unloadGeometry:function(e){var t;e.index.array&&(t=e.index.array.byteLength,e.attributes.position.data?t+=e.attributes.position.data.array.byteLength:t+=e.attributes.position.array.byteLength,this.usedMemory-=t,e.index.array=null,e.attributes.position.data?e.attributes.position.data.array=null:e.attributes.position.array=null)},reloadGeometry:function(e){}},U.prototype={constructor:U,getNumLineSegments:function(){return this.meshManager.getNumLineSegments()},getLineSegmentsWithState:function(e,t,r){return this.meshManager.getLineSegmentsWithState(e,t,r=void 0===r?!1:r)},getLineSegments:function(e,t,r){e=this.meshManager.getLineSegmentsWithState(e,t,r=void 0===r?!1:r);return 1===e.state?e.lineSegments:null},isLineSegmentsLoaded:function(e){return this.meshManager.isLineSegmentsLoaded(e)},removeGeometry:function(){for(var e,t=0,r=this.getNumLineSegments();t<r;++t)this.meshManager.isLineSegmentsLoaded(t)&&(e=this.meshManager.geomManager.getGeomFromId(this.meshManager.lineSegGeomId[t])).index.indexBuffer&&e.index.array&&this.meshManager.geomManager.unloadGeometry(e)}};function V(e,t){return e.programId===t.programId?e.materialId===t.materialId?0:e.materialId-t.materialId:e.programId-t.programId}function G(e,t){return(G=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}var k=new THREE.Box3,j=new THREE.Vector3,Xe=function(r){function e(){var e=r.call(this)||this,t=(e.isLineSegmentsGeometry=!0,e.type="LineSegmentsGeometry",[0,2,1,2,3,1,2,4,3,4,5,3,4,6,5,6,7,5]);return e.setIndex(t),e.addAttribute("position",new THREE.Float32BufferAttribute([-1,2,0,1,2,0,-1,1,0,1,1,0,-1,0,0,1,0,0,-1,-1,0,1,-1,0],3)),e.addAttribute("uv",new THREE.Float32BufferAttribute([-1,2,1,2,-1,1,1,1,-1,-1,1,-1,-1,-2,1,-2],2)),e.drawRange.start=0,e.drawRange.count=t.length,e}t=r,(i=e).prototype=Object.create(t.prototype),G(i.prototype.constructor=i,t);var t,i=e.prototype;return i.applyMatrix4=function(e){var t=this.attributes.instanceStart,r=this.attributes.instanceEnd;return void 0!==t&&(t.applyMatrix4(e),r.applyMatrix4(e),t.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this},i.setPositions=function(e){e instanceof Float32Array?t=e:Array.isArray(e)&&(t=new Float32Array(e));var t,e=new THREE.InstancedInterleavedBuffer(t,6,1);return this.addAttribute("instanceStart",new THREE.InterleavedBufferAttribute(e,3,0,!1)),this.addAttribute("instanceEnd",new THREE.InterleavedBufferAttribute(e,3,3,!1)),this.computeBoundingBox(),this.computeBoundingSphere(),this},i.setLineDistances=function(e){e instanceof Float32Array?t=e:Array.isArray(e)&&(t=new Float32Array(e));var t,e=new THREE.InstancedInterleavedBuffer(t,2,1);return this.addAttribute("instanceDistanceStart",new THREE.InterleavedBufferAttribute(e,1,0,!1)),this.addAttribute("instanceDistanceEnd",new THREE.InterleavedBufferAttribute(e,1,1,!1)),this},i.setLineWidth=function(e){e instanceof Float32Array?t=e:Array.isArray(e)&&(t=new Float32Array(e));var t,e=new THREE.InstancedInterleavedBuffer(t,2,1);return this.addAttribute("instanceWidthStart",new THREE.InterleavedBufferAttribute(e,1,0,!1)),this.addAttribute("instanceWidthEnd",new THREE.InterleavedBufferAttribute(e,1,1,!1)),this},i.setColors=function(e){e instanceof Float32Array?t=e:Array.isArray(e)&&(t=new THREE.Float32Array(e));var t,e=new THREE.InstancedInterleavedBuffer(t,6,1);return this.setAttribute("instanceColorStart",new THREE.InterleavedBufferAttribute(e,3,0,!1)),this.setAttribute("instanceColorEnd",new THREE.InterleavedBufferAttribute(e,3,3,!1)),this},i.fromWireframeGeometry=function(e){return this.setPositions(e.attributes.position.array),this},i.fromEdgesGeometry=function(e){return this.setPositions(e.attributes.position.array),this},i.fromMesh=function(e){return this.fromWireframeGeometry(new THREE.WireframeGeometry(e.geometry)),this},i.fromLineSegments=function(e){e=e.geometry;return this.setPositions(e.attributes.position.array),this},i.computeBoundingBox=function(){null===this.boundingBox&&(this.boundingBox=new THREE.Box3);var e=this.attributes.instanceStart,t=this.attributes.instanceEnd;void 0!==e&&void 0!==t&&(this.boundingBox.setFromBufferAttribute(e),k.setFromBufferAttribute(t),this.boundingBox.union(k))},i.computeBoundingSphere=function(){null===this.boundingSphere&&(this.boundingSphere=new THREE.Sphere),null===this.boundingBox&&this.computeBoundingBox();var e=this.attributes.instanceStart,t=this.attributes.instanceEnd;if(void 0!==e&&void 0!==t){for(var r=this.boundingSphere.center,i=(this.boundingBox.getCenter(r),0),n=0,a=e.count;n<a;n++)j.fromBufferAttribute(e,n),i=Math.max(i,r.distanceToSquared(j)),j.fromBufferAttribute(t,n),i=Math.max(i,r.distanceToSquared(j));this.boundingSphere.radius=Math.sqrt(i),isNaN(this.boundingSphere.radius)&&console.error("THREE.LineSegmentsGeometry.computeBoundingSphere(): Computed radius is NaN. The instanced position data is likely to have NaN values.",this)}},i.toJSON=function(){},i.applyMatrix=function(e){return console.warn("THREE.LineSegmentsGeometry: applyMatrix() has been renamed to applyMatrix4()."),this.applyMatrix4(e)},e}(THREE.InstancedBufferGeometry);function W(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,function(e){e=function(e,t){if("object"!=typeof e||!e)return e;var r=e[Symbol.toPrimitive];if(void 0===r)return("string"===t?String:Number)(e);r=r.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}(e,"string");return"symbol"==typeof e?e:e+""}(i.key),i)}}function q(e,t){return(q=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}THREE.UniformsLib.line2={worldUnits:{value:1},mutiWidth:{value:0},linewidth:{value:1},linewidthScale:{value:1},resolution:{value:new THREE.Vector2(1,1)},lineScale:{value:1},lineTypeId:{value:0},uSampler:{value:null},patternLength:{value:1}},THREE.ShaderLib.line2={uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib.common,THREE.UniformsLib.fog,THREE.UniformsLib.line2]),vertexShader:"\n\t\t#include <common>\n\t\t#include <color_pars_vertex>\n\t\t#include <fog_pars_vertex>\n\t\t#include <logdepthbuf_pars_vertex>\n\t\t#include <clipping_planes_pars_vertex>\n\n\t\tuniform float linewidth;\n\t\tuniform float linewidthScale;\n\t\tuniform vec2 resolution;\n\n\t\tattribute vec3 instanceStart;\n\t\tattribute vec3 instanceEnd;\n\n\t\tattribute vec3 instanceColorStart;\n\t\tattribute vec3 instanceColorEnd;\n\n\t\tvarying float vLineWidth;\n\n\t\t#ifdef WORLD_UNITS\n\n\t\t\tvarying vec4 worldPos;\n\t\t\tvarying vec3 worldStart;\n\t\t\tvarying vec3 worldEnd;\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tvarying vec2 vUv;\n\n\t\t\t#endif\n\n\t\t#else\n\n\t\t\tvarying vec2 vUv;\n\n\t\t#endif\n\n\t\t//#ifdef USE_DASH\n\t\t\tattribute float instanceDistanceStart;\n\t\t\tattribute float instanceDistanceEnd;\n\t\t\tvarying float vLineDistance;\n\n\t\t//#endif\n\n\t\t#ifdef MUTI_WIDTH\n\t\t\tattribute float instanceWidthStart;\n\t\t\tattribute float instanceWidthEnd;\n\t\t#endif\n\n\t\tvoid trimSegment( const in vec4 start, inout vec4 end ) {\n\n\t\t\t// trim end segment so it terminates between the camera plane and the near plane\n\n\t\t\t// conservative estimate of the near plane\n\t\t\tfloat a = projectionMatrix[ 2 ][ 2 ]; // 3nd entry in 3th column\n\t\t\tfloat b = projectionMatrix[ 3 ][ 2 ]; // 3nd entry in 4th column\n\t\t\tfloat nearEstimate = - 0.5 * b / a;\n\n\t\t\tfloat alpha = ( nearEstimate - start.z ) / ( end.z - start.z );\n\n\t\t\tend.xyz = mix( start.xyz, end.xyz, alpha );\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\t#ifdef USE_COLOR\n\n\t\t\t\tvColor.xyz = ( position.y < 0.5 ) ? instanceColorStart : instanceColorEnd;\n\n\t\t\t#endif\n\n\t\t\t#ifdef MUTI_WIDTH\n\t\t\t\tvLineWidth = ( position.y < 0.5 ) ?  instanceWidthStart :  instanceWidthEnd;\n\t\t\t#else\n\t\t\t\tvLineWidth = linewidth;\n\t\t\t#endif\n\n\t\t\tvLineWidth = vLineWidth * linewidthScale;\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tvLineDistance = ( position.y < 0.5 ) ?  instanceDistanceStart :  instanceDistanceEnd;\n\t\t\t\tvUv = uv;\n\n\t\t\t#endif\n\n\t\t\tfloat aspect = resolution.x / resolution.y;\n\n\t\t\t#ifdef USE_MODELMATRIXATTRIB\n\t\t\t\tmat4 ndsModelViewMatrix = viewMatrix * modelMatrixAttrib;\n\t\t\t\t// camera space\n\t\t\t\tvec4 start = ndsModelViewMatrix * vec4( instanceStart, 1.0 );\n\t\t\t\tvec4 end = ndsModelViewMatrix * vec4( instanceEnd, 1.0 );\n\t\t\t#else\n\t\t\t\t// camera space\n\t\t\t\tvec4 start = modelViewMatrix * vec4( instanceStart, 1.0 );\n\t\t\t\tvec4 end = modelViewMatrix * vec4( instanceEnd, 1.0 );\n\t\t\t#endif\n\n\t\t\t#ifdef WORLD_UNITS\n\n\t\t\t\tworldStart = start.xyz;\n\t\t\t\tworldEnd = end.xyz;\n\n\t\t\t#else\n\n\t\t\t\tvUv = uv;\n\n\t\t\t#endif\n\n\t\t\t// special case for perspective projection, and segments that terminate either in, or behind, the camera plane\n\t\t\t// clearly the gpu firmware has a way of addressing this issue when projecting into ndc space\n\t\t\t// but we need to perform ndc-space calculations in the shader, so we must address this issue directly\n\t\t\t// perhaps there is a more elegant solution -- WestLangley\n\n\t\t\tbool perspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 ); // 4th entry in the 3rd column\n\n\t\t\tif ( perspective ) {\n\n\t\t\t\tif ( start.z < 0.0 && end.z >= 0.0 ) {\n\n\t\t\t\t\ttrimSegment( start, end );\n\n\t\t\t\t} else if ( end.z < 0.0 && start.z >= 0.0 ) {\n\n\t\t\t\t\ttrimSegment( end, start );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\t// clip space\n\t\t\tvec4 clipStart = projectionMatrix * start;\n\t\t\tvec4 clipEnd = projectionMatrix * end;\n\n\t\t\t// ndc space\n\t\t\tvec3 ndcStart = clipStart.xyz / clipStart.w;\n\t\t\tvec3 ndcEnd = clipEnd.xyz / clipEnd.w;\n\n\t\t\t// direction\n\t\t\tvec2 dir = ndcEnd.xy - ndcStart.xy;\n\n\t\t\t// account for clip-space aspect ratio\n\t\t\tdir.x *= aspect;\n\t\t\tdir = normalize( dir );\n\n\t\t\t#ifdef WORLD_UNITS\n\n\t\t\t\t// get the offset direction as perpendicular to the view vector\n\t\t\t\tvec3 worldDir = normalize( end.xyz - start.xyz );\n\t\t\t\tvec3 offset;\n\t\t\t\tif ( position.y < 0.5 ) {\n\n\t\t\t\t\toffset = normalize( cross( start.xyz, worldDir ) );\n\n\t\t\t\t} else {\n\n\t\t\t\t\toffset = normalize( cross( end.xyz, worldDir ) );\n\n\t\t\t\t}\n\n\t\t\t\t// sign flip\n\t\t\t\tif ( position.x < 0.0 ) offset *= - 1.0;\n\n\t\t\t\tfloat forwardOffset = dot( worldDir, vec3( 0.0, 0.0, 1.0 ) );\n\n\t\t\t\t// don't extend the line if we're rendering dashes because we\n\t\t\t\t// won't be rendering the endcaps\n\t\t\t\t#ifndef USE_DASH\n\n\t\t\t\t\tif(instanceDistanceStart > 0.0){\n\t\t\t\t\t// extend the line bounds to encompass  endcaps\n\t\t\t\t\tstart.xyz += - worldDir * vLineWidth * 0.5;\n\t\t\t\t\t//end.xyz += worldDir * vLineWidth * 0.5;\n\n\t\t\t\t\t// shift the position of the quad so it hugs the forward edge of the line\n\t\t\t\t\t//offset.xy -= dir * forwardOffset;\n\t\t\t\t\t//offset.z += 0.5;\n\t\t\t\t\t}\t\n\n\t\t\t\t#endif\n\n\t\t\t\t// endcaps\n\t\t\t\tif ( position.y > 1.0 || position.y < 0.0 ) {\n\n\t\t\t\t\toffset.xy += dir * 2.0 * forwardOffset;\n\n\t\t\t\t}\n\n\t\t\t\t// adjust for linewidth\n\t\t\t\toffset *= vLineWidth * 0.5;\n\n\t\t\t\t// set the world position\n\t\t\t\tworldPos = ( position.y < 0.5 ) ? start : end;\n\t\t\t\tworldPos.xyz += offset;\n\n\t\t\t\t// project the worldpos\n\t\t\t\tvec4 clip = projectionMatrix * worldPos;\n\n\t\t\t\t// shift the depth of the projected points so the line\n\t\t\t\t// segments overlap neatly\n\t\t\t\tvec3 clipPose = ( position.y < 0.5 ) ? ndcStart : ndcEnd;\n\t\t\t\tclip.z = clipPose.z * clip.w;\n\n\t\t\t#else\n\n\t\t\t\tvec2 offset = vec2( dir.y, - dir.x );\n\t\t\t\t// undo aspect ratio adjustment\n\t\t\t\tdir.x /= aspect;\n\t\t\t\toffset.x /= aspect;\n\n\t\t\t\t// sign flip\n\t\t\t\tif ( position.x < 0.0 ) offset *= - 1.0;\n\n\t\t\t\t// endcaps\n\t\t\t\tif ( position.y < 0.0 ) {\n\n\t\t\t\t\toffset += - dir;\n\n\t\t\t\t} else if ( position.y > 1.0 ) {\n\n\t\t\t\t\toffset += dir;\n\n\t\t\t\t}\n\n\t\t\t\t// adjust for linewidth\n\t\t\t\toffset *= vLineWidth;\n\n\t\t\t\t// adjust for clip-space to screen-space conversion // maybe resolution should be based on viewport ...\n\t\t\t\toffset /= resolution.y;\n\n\t\t\t\t// select end\n\t\t\t\tvec4 clip = ( position.y < 0.5 ) ? clipStart : clipEnd;\n\n\t\t\t\t// back to clip space\n\t\t\t\toffset *= clip.w;\n\n\t\t\t\tclip.xy += offset;\n\n\t\t\t#endif\n\n\t\t\tgl_Position = clip;\n\n\t\t\tvec4 mvPosition = ( position.y < 0.5 ) ? start : end; // this is an approximation\n\n\t\t\t#include <logdepthbuf_vertex>\n\t\t\t#include <clipping_planes_vertex>\n\t\t\t#include <fog_vertex>\n\n\t\t}\n\t\t",fragmentShader:"\n\t\tuniform vec3 diffuse;\n\t\tuniform float opacity;\n\t\tuniform float linewidth;\n\t\tvarying float vLineWidth;\n\t\t\n\t\t#ifdef USE_DASH\n\t\t\tuniform float patternLength;\n\t\t\tuniform float lineScale;\n\t\t\tuniform sampler2D uSampler;\n\t\t#endif\n\n\t\tvarying float vLineDistance;\n\n\t\t#ifdef WORLD_UNITS\n\n\t\t\tvarying vec4 worldPos;\n\t\t\tvarying vec3 worldStart;\n\t\t\tvarying vec3 worldEnd;\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tvarying vec2 vUv;\n\n\t\t\t#endif\n\n\t\t#else\n\n\t\t\tvarying vec2 vUv;\n\n\t\t#endif\n\n\t\t#include <common>\n\t\t#include <color_pars_fragment>\n\t\t#include <fog_pars_fragment>\n\t\t#include <logdepthbuf_pars_fragment>\n\t\t#include <clipping_planes_pars_fragment>\n\n\t\tvec2 closestLineToLine(vec3 p1, vec3 p2, vec3 p3, vec3 p4) {\n\n\t\t\tfloat mua;\n\t\t\tfloat mub;\n\n\t\t\tvec3 p13 = p1 - p3;\n\t\t\tvec3 p43 = p4 - p3;\n\n\t\t\tvec3 p21 = p2 - p1;\n\n\t\t\tfloat d1343 = dot( p13, p43 );\n\t\t\tfloat d4321 = dot( p43, p21 );\n\t\t\tfloat d1321 = dot( p13, p21 );\n\t\t\tfloat d4343 = dot( p43, p43 );\n\t\t\tfloat d2121 = dot( p21, p21 );\n\n\t\t\tfloat denom = d2121 * d4343 - d4321 * d4321;\n\n\t\t\tfloat numer = d1343 * d4321 - d1321 * d4343;\n\n\t\t\tmua = numer / denom;\n\t\t\tmua = clamp( mua, 0.0, 1.0 );\n\t\t\tmub = ( d1343 + d4321 * ( mua ) ) / d4343;\n\t\t\tmub = clamp( mub, 0.0, 1.0 );\n\n\t\t\treturn vec2( mua, mub );\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\t#include <clipping_planes_fragment>\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tif ( vUv.y < - 1.0 || vUv.y > 1.0 ) discard; // discard endcaps\n\n                float newDistance = vLineDistance/lineScale;\n                float modSize = mod( newDistance, patternLength);\n                vec3 value = texture2D(uSampler,vec2(modSize/patternLength,0.0)).rgb;\n                if(value.r > 0.9){\n                \tdiscard;\n                }\n\t\t\t\tif(value.r <=0.9 && value.r >=0.8){\n\t\t\t\t\tfloat a = vUv.x;\n\t\t\t\t\tfloat b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;\n\t\t\t\t\tfloat len2 = a * a + b * b;\n\n\t\t\t\t\tif ( len2 > 1.0 ) discard;\n\t\t\t\t}\n\n\t\t\t#endif\n\n\t\t\tfloat alpha = opacity;\n\n\t\t\t#ifdef WORLD_UNITS\n\n\t\t\t\t// Find the closest points on the view ray and the line segment\n\t\t\t\tvec3 rayEnd = normalize( worldPos.xyz ) * 1e5;\n\t\t\t\tvec3 lineDir = worldEnd - worldStart;\n\t\t\t\tvec2 params = closestLineToLine( worldStart, worldEnd, vec3( 0.0, 0.0, 0.0 ), rayEnd );\n\n\t\t\t\tvec3 p1 = worldStart + lineDir * params.x;\n\t\t\t\tvec3 p2 = rayEnd * params.y;\n\t\t\t\tvec3 delta = p1 - p2;\n\t\t\t\tfloat len = length( delta );\n\t\t\t\tfloat norm = len / vLineWidth;\n\n\t\t\t\t#ifndef USE_DASH\n\n\t\t\t\t\t#ifdef USE_ALPHA_TO_COVERAGE\n\n\t\t\t\t\t\tfloat dnorm = fwidth( norm );\n\t\t\t\t\t\talpha = 1.0 - smoothstep( 0.5 - dnorm, 0.5 + dnorm, norm );\n\n\t\t\t\t\t#else\n\n\t\t\t\t\t\tif ( norm > 0.5 ) {\n\n\t\t\t\t\t\t\tdiscard;\n\n\t\t\t\t\t\t}\n\n\t\t\t\t\t#endif\n\n\t\t\t\t#endif\n\n\t\t\t#else\n\n\t\t\t\t#ifdef USE_ALPHA_TO_COVERAGE\n\n\t\t\t\t\t// artifacts appear on some hardware if a derivative is taken within a conditional\n\t\t\t\t\tfloat a = vUv.x;\n\t\t\t\t\tfloat b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;\n\t\t\t\t\tfloat len2 = a * a + b * b;\n\t\t\t\t\tfloat dlen = fwidth( len2 );\n\n\t\t\t\t\tif ( abs( vUv.y ) > 1.0 ) {\n\n\t\t\t\t\t\talpha = 1.0 - smoothstep( 1.0 - dlen, 1.0 + dlen, len2 );\n\n\t\t\t\t\t}\n\n\t\t\t\t#else\n\n\t\t\t\t\tif ( abs( vUv.y ) > 1.0 ) {\n\n\t\t\t\t\t\tfloat a = vUv.x;\n\t\t\t\t\t\tfloat b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;\n\t\t\t\t\t\tfloat len2 = a * a + b * b;\n\n\t\t\t\t\t\tif ( len2 > 1.0 ) discard;\n\n\t\t\t\t\t}\n\n\t\t\t\t#endif\n\n\t\t\t#endif\n\n\t\t\tvec4 diffuseColor = vec4( diffuse, alpha );\n\n\t\t\t#include <logdepthbuf_fragment>\n\t\t\t#include <color_fragment>\n\n\t\t\tgl_FragColor = vec4( diffuseColor.rgb, alpha );\n\n\t\t\t#include <tonemapping_fragment>\n\t\t\t#include <encodings_fragment>\n\t\t\t#include <fog_fragment>\n\t\t\t#include <premultiplied_alpha_fragment>\n\n\t\t}\n\t\t"};var qe=function(r){function e(e){var t=r.call(this,{type:"LineMaterial",uniforms:THREE.UniformsUtils.clone(THREE.ShaderLib.line2.uniforms),vertexShader:THREE.ShaderLib.line2.vertexShader,fragmentShader:THREE.ShaderLib.line2.fragmentShader,clipping:!0})||this;return t.isLineMaterial=!0,t.setValues(e),t}var t,i,n;return i=r,(t=e).prototype=Object.create(i.prototype),q(t.prototype.constructor=t,i),t=e,(i=[{key:"color",get:function(){return this.uniforms.diffuse.value},set:function(e){this.uniforms.diffuse.value=e}},{key:"worldUnits",get:function(){return"WORLD_UNITS"in this.defines},set:function(e){!0===e?this.defines.WORLD_UNITS="":delete this.defines.WORLD_UNITS}},{key:"linewidth",get:function(){return this.uniforms.linewidth.value},set:function(e){this.uniforms.linewidth&&(this.uniforms.linewidth.value=e)}},{key:"linewidthScale",get:function(){return this.uniforms.linewidthScale.value},set:function(e){this.uniforms.linewidthScale&&(this.uniforms.linewidthScale.value=e)}},{key:"dashed",get:function(){return"USE_DASH"in this.defines},set:function(e){!0===e!==this.dashed&&(this.needsUpdate=!0),!0===e?this.defines.USE_DASH="":delete this.defines.USE_DASH}},{key:"dashScale",get:function(){return this.uniforms.dashScale.value},set:function(e){this.uniforms.dashScale.value=e}},{key:"dashSize",get:function(){return this.uniforms.dashSize.value},set:function(e){this.uniforms.dashSize.value=e}},{key:"dashOffset",get:function(){return this.uniforms.dashOffset.value},set:function(e){this.uniforms.dashOffset.value=e}},{key:"gapSize",get:function(){return this.uniforms.gapSize.value},set:function(e){this.uniforms.gapSize.value=e}},{key:"opacity",get:function(){return this.uniforms.opacity.value},set:function(e){this.uniforms&&(this.uniforms.opacity.value=e)}},{key:"resolution",get:function(){return this.uniforms.resolution.value},set:function(e){this.uniforms.resolution.value.copy(e)}},{key:"alphaToCoverage",get:function(){return"USE_ALPHA_TO_COVERAGE"in this.defines},set:function(e){this.defines&&(!0===e!==this.alphaToCoverage&&(this.needsUpdate=!0),!0===e?(this.defines.USE_ALPHA_TO_COVERAGE="",this.extensions.derivatives=!0):(delete this.defines.USE_ALPHA_TO_COVERAGE,this.extensions.derivatives=!1))}},{key:"lineScale",get:function(){return this.uniforms.lineScale.value},set:function(e){this.uniforms.lineScale.value=e}},{key:"lineTypeId",get:function(){return this.uniforms.lineTypeId.value},set:function(e){this.uniforms.lineTypeId.value=e}},{key:"patternLength",get:function(){return this.uniforms.patternLength.value},set:function(e){this.uniforms.patternLength.value=e}},{key:"uSampler",get:function(){return this.uniforms.uSampler.value},set:function(e){this.uniforms.uSampler.value=e}},{key:"mutiWidth",get:function(){return"MUTI_WIDTH"in this.defines},set:function(e){!0===e?this.defines.MUTI_WIDTH="":delete this.defines.MUTI_WIDTH}}])&&W(t.prototype,i),n&&W(t,n),Object.defineProperty(t,"prototype",{writable:!1}),t}(THREE.ShaderMaterial);function Y(e,t){return(Y=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}var Q,K,Z=new THREE.Vector3,J=new THREE.Vector3,C=new THREE.Vector4,D=new THREE.Vector4,he=new THREE.Vector4,ue=new THREE.Vector3,pe=new THREE.Matrix4,fe=new THREE.Line3,me=new THREE.Vector3,ge=new THREE.Box3,ve=new THREE.Sphere,ye=new THREE.Vector4;function Ae(e,t,r){return ye.set(0,0,-t,1).applyMatrix4(e.projectionMatrix),ye.multiplyScalar(1/ye.w),ye.x=K/r.width,ye.y=K/r.height,ye.applyMatrix4(e.projectionMatrixInverse),ye.multiplyScalar(1/ye.w),Math.abs(Math.max(ye.x,ye.y))}var Ke=function(r){function e(e,t){return void 0===e&&(e=new Xe),void 0===t&&(t=new qe({color:16777215*Math.random()})),(e=r.call(this,e,t)||this).isLineSegments2=!0,e.type="LineSegments2",e}t=r,(i=e).prototype=Object.create(t.prototype),Y(i.prototype.constructor=i,t);var t,i=e.prototype;return i.computeLineDistances=function(){for(var e=this.geometry,t=e.attributes.instanceStart,r=e.attributes.instanceEnd,i=new Float32Array(2*t.count),n=0,a=0,o=t.count;n<o;n++,a+=2)Z.fromBufferAttribute(t,n),J.fromBufferAttribute(r,n),i[a]=0===a?0:i[a-1],i[a+1]=i[a]+Z.distanceTo(J);var s=new THREE.InstancedInterleavedBuffer(i,2,1);return e.addAttribute("instanceDistanceStart",new THREE.InterleavedBufferAttribute(s,1,0,!1)),e.addAttribute("instanceDistanceEnd",new THREE.InterleavedBufferAttribute(s,1,1,!1)),this},i.raycast=function(e,t){var r=this.material.worldUnits,i=e.camera,n=(null!==i||r||console.error('LineSegments2: "Raycaster.camera" needs to be set in order to raycast against LineSegments2 while worldUnits is set to false.'),void 0!==e.params.Line2&&e.params.Line2.threshold||0),e=(Q=e.ray,this.matrixWorld),a=this.geometry,o=this.material;if((K=o.linewidth+n,null===a.boundingSphere&&a.computeBoundingSphere(),ve.copy(a.boundingSphere).applyMatrix4(e),n=r?.5*K:Ae(i,Math.max(i.near,ve.distanceToPoint(Q.origin)),o.resolution),ve.radius+=n,!1!==Q.intersectsSphere(ve))&&(null===a.boundingBox&&a.computeBoundingBox(),ge.copy(a.boundingBox).applyMatrix4(e),n=r?.5*K:Ae(i,Math.max(i.near,ge.distanceToPoint(Q.origin)),o.resolution),ge.expandByScalar(n),!1!==Q.intersectsBox(ge)))if(r)for(var s=this,l=t,d=s.matrixWorld,a=s.geometry,c=a.attributes.instanceStart,h=a.attributes.instanceEnd,u=0,p=Math.min(a.instanceCount,c.count);u<p;u++){fe.start.fromBufferAttribute(c,u),fe.end.fromBufferAttribute(h,u),fe.applyMatrix4(d);var f=new THREE.Vector3,m=new THREE.Vector3;Q.distanceSqToSegment(fe.start,fe.end,m,f),m.distanceTo(f)<.5*K&&l.push({point:m,pointOnLine:f,distance:Q.origin.distanceTo(m),object:s,face:null,faceIndex:u,uv:null,uv1:null})}else{var g=this,e=i,v=t,y=e.projectionMatrix,A=g.material.resolution,M=g.matrixWorld,E=(o=g.geometry).attributes.instanceStart,w=o.attributes.instanceEnd,o=Math.min(o.instanceCount,E.count),x=-e.near;Q.at(1,he),he.w=1,he.applyMatrix4(e.matrixWorldInverse),he.applyMatrix4(y),he.multiplyScalar(1/he.w),he.x*=A.x/2,he.y*=A.y/2,he.z=0,ue.copy(he),pe.multiplyMatrices(e.matrixWorldInverse,M);for(var b,B,I,T,S=0,R=o;S<R;S++)C.fromBufferAttribute(E,S),D.fromBufferAttribute(w,S),C.w=1,D.w=1,C.applyMatrix4(pe),D.applyMatrix4(pe),C.z>x&&D.z>x||(C.z>x?(b=C.z-D.z,b=(C.z-x)/b,C.lerp(D,b)):D.z>x&&(b=D.z-C.z,B=(D.z-x)/b,D.lerp(C,B)),C.applyMatrix4(y),D.applyMatrix4(y),C.multiplyScalar(1/C.w),D.multiplyScalar(1/D.w),C.x*=A.x/2,C.y*=A.y/2,D.x*=A.x/2,D.y*=A.y/2,fe.start.copy(C),fe.start.z=0,fe.end.copy(D),fe.end.z=0,B=fe.closestPointToPointParameter(ue,!0),fe.at(B,me),I=-1<=(I=THREE.Math.lerp(C.z,D.z,B))&&I<=1,T=ue.distanceTo(me),I&&(K<5?T<5:T<K)&&(fe.start.fromBufferAttribute(E,S),fe.end.fromBufferAttribute(w,S),fe.start.applyMatrix4(M),fe.end.applyMatrix4(M),I=new THREE.Vector3,T=new THREE.Vector3,Q.distanceSqToSegment(fe.start,fe.end,T,I),v.push({point:T,pointOnLine:I,distance:Q.origin.distanceTo(T),object:g,face:null,faceIndex:S,uv:null,uv1:null})))}},e}(THREE.Mesh);function Me(e,t){e.prototype=Object.create(t.prototype),Ee(e.prototype.constructor=e,t)}function Ee(e,t){return(Ee=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}var we=function(r){function e(e,t){return(e=r.call(this,e=void 0===e?{}:e,t=void 0===t?{}:t)||this).isBatchedMesh=!0,e._multiDrawStarts=null,e._multiDrawCounts=null,e._multiDrawCount=0,e}return Me(e,r),e}(THREE.Mesh),xe=function(r){function e(e,t){return(e=r.call(this,e=void 0===e?{}:e,t=void 0===t?{}:t)||this).isBatchedMesh=!0,e.isBatchedLineSegments=!0,e._multiDrawStarts=null,e._multiDrawCounts=null,e._multiDrawCount=0,e}return Me(e,r),e}(THREE.LineSegments),be=function(r){function e(e,t){return(e=r.call(this,e=void 0===e?{}:e,t=void 0===t?{}:t)||this).isBatchedMesh=!0,e.isBatchedPoints=!0,e._multiDrawStarts=null,e._multiDrawCounts=null,e._multiDrawCount=0,e}return Me(e,r),e}(THREE.Points),Be=function(r){function e(e,t){return(e=r.call(this,e=void 0===e?{}:e,t=void 0===t?{}:t)||this).isBatchedMesh=!0,e.isInstancedBatchedMesh=!0,e._multiDrawStarts=null,e._multiDrawCounts=null,e._multiDrawInstanceCounts=null,e._multiDrawCount=0,e}return Me(e,r),e}(THREE.Mesh);function Te(e,t){return e-t}function Se(e){var r=this;this.boundingBox=new THREE.Box3,this.boundingSphere=new THREE.Sphere,this.children=[],this.meshes=null,this.lines=null,this.texts=null,this.parent=null,this.addSubTree=function(e){((e=e.isSpatialIndex?e:new at(e)).root.parent=r).children.push(e.root);for(var t=r;t;)t.boundingBox.expandByPoint(e.root.boundingBox.min),t.boundingBox.expandByPoint(e.root.boundingBox.max),t=t.parent;return e.root},this.queryByRayCast=function(){function a(e,t,r){if(t.intersectsBox(e.boundingBox)){0<=e.meshSetId&&(r[r.length]=e.meshSetId);for(var i=0,n=e.children.length;i<n;++i)a(e.children[i],t,r)}}new THREE.Vector3,new THREE.Quaternion,new THREE.Vector3;return function(e,t){a(this,e,t)}}()}function Ze(e){this.ndsModel=e,this.needUpdateRefPlaneVertexBuffer=!0,this.needUpdateRefPlaneDispData=!0,this.needUpdateRefAxisVertexBuffer=!0,this.needUpdateRefAxisDispData=!0;var x=this,b=(this.refPlanes=[],this.refAxises=[],null),B=null,M=null,E=null,w=null,I=null,T=new THREE.Mesh,S=new THREE.Mesh,R=new THREE.Mesh,C=new THREE.LineSegments,D=new THREE.LineSegments,P=new THREE.LineSegments,H=new le,_=new le,L=new le,O=new le,F=new le,U=new le,N=new THREE.LineSegments,V=new THREE.LineSegments,G=new THREE.LineSegments,k=new le,j=new le,z=new le;this.hasNormalPlane=!1,this.hasSelectedPlane=!1,this.hasPreselecedPlane=!1,this.hasNormalAxis=!1,this.hasSelectedAxis=!1,this.hasPreselectedAxis=!1,this.axisMaterial=new THREE.LineDashedMaterial({color:255,linewidth:2,dashSize:.003,gapSize:.002}),this.axisSelectedMaterial=new THREE.LineDashedMaterial({color:65280,linewidth:2,dashSize:.003,gapSize:.002}),this.axisPreSelectedMaterial=new THREE.LineDashedMaterial({color:65535,linewidth:2,dashSize:.003,gapSize:.002}),this.planeMaterial=new THREE.MeshBasicMaterial({color:15527167,side:THREE.DoubleSide,transparent:!0,opacity:.2,polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1}),this.planeSelectedMaterial=new THREE.MeshBasicMaterial({color:16763200,side:THREE.DoubleSide,transparent:!0,opacity:.2,polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1}),this.planePreSelectedMaterial=new THREE.MeshBasicMaterial({color:15527167,side:THREE.DoubleSide,transparent:!0,opacity:.2,polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1}),this.planeEdgeMaterial=new THREE.LineBasicMaterial({color:5987327}),this.planeEdgeSelectedMaterial=new THREE.LineBasicMaterial({color:16776960}),this.planeEdgePreSelectedMaterial=new THREE.LineBasicMaterial({color:65535}),this.overrideMaterial=null,this.overrideMaterialCopy=null,this.useBodyIdMaterial=!1,this.getPlaneDispData=function(){var e={};if(x.needUpdateRefPlaneVertexBuffer){for(var t=x.refPlanes.length,r=4*t*3,i=(b&&b.length==r||(b=new Float32Array(r),B=new THREE.BufferAttribute(b,3)),new THREE.Vector3),n=0;n<t;n++)for(var a=x.refPlanes[n].worldMatrix,o=x.refPlanes[n].leafBodyAttri.coords,s=0;s<4;s++)i.fromArray(o,3*s),i.applyMatrix4(a),b[3*(4*n+s)+0]=i.x,b[3*(4*n+s)+1]=i.y,b[3*(4*n+s)+2]=i.z;B.needsUpdate=!0,x.needUpdateRefPlaneVertexBuffer=!1}if(this.needUpdateRefPlaneDispData){for(var l=this.refPlanes.length,r=4*l,d=0,c=0,h=0,u=0;u<l;u++)this.refPlanes[u].isHidden()||(this.refPlanes[u].isPreSelected()?h++:this.refPlanes[u].isSelected()?c++:d++);for(var p=null,f=null,m=null,g=null,v=null,y=null,A=(0<d?(this.hasNormalPlane=!0,p=new(r<=65535?Uint16Array:Uint32Array)(6*d),g=new(r<=65535?Uint16Array:Uint32Array)(8*d),T.geometry=H,T.material=this.planeMaterial,H.attributes.position=B,H.index=new THREE.BufferAttribute(p,1),C.geometry=O,C.material=this.planeEdgeMaterial,O.attributes.position=B,O.index=new THREE.BufferAttribute(g,1),e.normalPlaneMesh=T,e.normalPlaneEdge=C):(this.hasNormalPlane=!1,T.geometry=null,H.index=null,H.attributes.position=null,C.geometry=null,O.index=null,O.attributes.position=null),0<c?(this.hasSelectedPlane=!0,f=new(r<=65535?Uint16Array:Uint32Array)(6*c),v=new(r<=65535?Uint16Array:Uint32Array)(8*c),S.geometry=_,S.material=this.planeSelectedMaterial,_.attributes.position=B,_.index=new THREE.BufferAttribute(f,1),D.geometry=F,D.material=this.planeEdgeSelectedMaterial,F.attributes.position=B,F.index=new THREE.BufferAttribute(v,1),e.selectedPlaneMesh=S,e.selectedPlaneEdge=D):(this.hasSelectedPlane=!1,S.geometry=null,_.index=null,_.attributes.position=null,D.geometry=null,F.index=null,F.attributes.position=null),0<h?(this.hasPreselecedPlane=!0,m=new(r<=65535?Uint16Array:Uint32Array)(6*h),y=new(r<=65535?Uint16Array:Uint32Array)(8*h),R.geometry=L,R.material=this.planePreSelectedMaterial,L.attributes.position=B,L.index=new THREE.BufferAttribute(m,1),P.geometry=U,P.material=this.planeEdgePreSelectedMaterial,U.attributes.position=B,U.index=new THREE.BufferAttribute(y,1),e.preselectedPlaneMesh=R,e.preselectedPlaneEdge=P):(this.hasPreselecedPlane=!1,R.geometry=null,L.index=null,L.attributes.position=null,P.geometry=null,U.index=null,U.attributes.position=null),0),M=0,E=0,u=0;u<l;u++)if(!this.refPlanes[u].isHidden())if(this.refPlanes[u].isPreSelected()){m[6*A+0]=4*u+0,m[6*A+1]=4*u+1,m[6*A+2]=4*u+2,m[6*A+3]=4*u+2,m[6*A+4]=4*u+3,m[6*A+5]=4*u+0;for(var w=0;w<3;w++)y[8*A+2*w]=4*u+w,y[8*A+2*w+1]=4*u+w+1;y[8*A+6]=4*u+3,y[8*A+7]=4*u,A++}else if(this.refPlanes[u].isSelected()){f[6*M+0]=4*u+0,f[6*M+1]=4*u+1,f[6*M+2]=4*u+2,f[6*M+3]=4*u+2,f[6*M+4]=4*u+3,f[6*M+5]=4*u+0;for(w=0;w<3;w++)v[8*M+2*w]=4*u+w,v[8*M+2*w+1]=4*u+w+1;v[8*M+6]=4*u+3,v[8*M+7]=4*u,M++}else{p[6*E+0]=4*u+0,p[6*E+1]=4*u+1,p[6*E+2]=4*u+2,p[6*E+3]=4*u+2,p[6*E+4]=4*u+3,p[6*E+5]=4*u+0;for(w=0;w<3;w++)g[8*E+2*w]=4*u+w,g[8*E+2*w+1]=4*u+w+1;g[8*E+6]=4*u+3,g[8*E+7]=4*u,E++}this.needUpdateRefPlaneDispData=!1}else this.hasNormalPlane&&(e.normalPlaneMesh=T,e.normalPlaneEdge=C),this.hasSelectedPlane&&(e.selectedPlaneMesh=S,e.selectedPlaneEdge=D),this.hasPreselecedPlane&&(e.preselectedPlaneMesh=R,e.preselectedPlaneEdge=P);return e},this.getAxisDispData=function(){var e={};if(x.needUpdateRefAxisVertexBuffer){for(var t,r=x.refAxises.length,i=2*r*3,n=2*r,a=(M&&M.length==i||(M=new Float32Array(i),E=new THREE.BufferAttribute(M,3),w=new Float32Array(n),I=new THREE.BufferAttribute(w,1)),new THREE.Vector3),o=new THREE.Vector3,s=0;s<r;s++){t=x.refAxises[s].worldMatrix,l=x.refAxises[s].leafBodyAttri.coords,a.fromArray(l,0),o.fromArray(l,3);var l=a.distanceTo(o);a.applyMatrix4(t),o.applyMatrix4(t),M[2*s*3]=a.x,M[2*s*3+1]=a.y,M[2*s*3+2]=a.z,M[3*(2*s+1)]=o.x,M[3*(2*s+1)+1]=o.y,M[3*(2*s+1)+2]=o.z,w[2*s]=0,w[2*s+1]=l}E.needsUpdate=!0,I.needsUpdate=!0,x.needUpdateRefAxisVertexBuffer=!1}if(this.needUpdateRefAxisDispData){for(var d=this.refAxises.length,i=2*d,c=0,h=0,u=0,p=0;p<d;p++)this.refAxises[p].isHidden()||(this.refAxises[p].isPreSelected()?u++:this.refAxises[p].isSelected()?h++:c++);for(var f=null,m=null,g=null,v=(0<c?(this.hasNormalAxis=!0,f=new(i<=65535?Uint16Array:Uint32Array)(2*c),N.geometry=k,N.material=this.axisMaterial,k.attributes.position=E,k.attributes.lineDistance=I,k.index=new THREE.BufferAttribute(f,1),e.normalAxisLines=N):(this.hasNormalAxis=!1,N.geometry=null,k.index=null,k.attributes.position=null,k.attributes.lineDistance=null),0<h?(this.hasSelectedAxis=!0,m=new(i<=65535?Uint16Array:Uint32Array)(2*h),V.geometry=j,V.material=this.axisSelectedMaterial,j.attributes.position=E,j.attributes.lineDistance=I,j.index=new THREE.BufferAttribute(m,1),e.selectedAxisLines=V):(this.hasSelectedAxis=!1,V.geometry=null,j.index=null,j.attributes.position=null,j.attributes.lineDistance=null),0<u?(this.hasPreselectedAxis=!0,g=new(i<=65535?Uint16Array:Uint32Array)(2*u),G.geometry=z,G.material=this.axisPreSelectedMaterial,z.attributes.position=E,z.attributes.lineDistance=I,z.index=new THREE.BufferAttribute(g,1),e.preselectedAxisLines=G):(this.hasPreselectedAxis=!1,G.geometry=null,z.index=null,z.attributes.position=null,z.attributes.lineDistance=null),0),y=0,A=0,p=0;p<d;p++)this.refAxises[p].isHidden()||(this.refAxises[p].isPreSelected()?(g[2*v]=2*p,g[2*v+1]=2*p+1,v++):this.refAxises[p].isSelected()?(m[2*y]=2*p,m[2*y+1]=2*p+1,y++):(f[2*A]=2*p,f[2*A+1]=2*p+1,A++));this.needUpdateRefAxisDispData=!1}else this.hasNormalAxis&&(e.normalAxisLines=N),this.hasSelectedAxis&&(e.selectedAxisLines=V),this.hasPreselectedAxis&&(e.preselectedAxisLines=G);return e},this.addRefEntity=function(e){"RefAxis"==e.type?(this.refAxises.push(e),this.needUpdateRefAxisVertexBuffer=!0,this.needUpdateRefAxisDispData=!0):"RefPlane"==e.type&&(this.refPlanes.push(e),this.needUpdateRefPlaneVertexBuffer=!0,this.needUpdateRefPlaneDispData=!0)},this.removeRefEntity=function(e){var t;"RefAxis"==e.type?(-1<(t=this.refAxises.indexOf(e))&&this.refAxises.splice(t,1),this.needUpdateRefAxisVertexBuffer=!0,this.needUpdateRefAxisDispData=!0):"RefPlane"==e.type&&(-1<(t=this.refPlanes.indexOf(e))&&this.refPlanes.splice(t,1),this.needUpdateRefPlaneVertexBuffer=!0,this.needUpdateRefPlaneDispData=!0)}}var Je,$e,et,tt,rt=function(e,t){var n=this;this.geomManager=e,++this.geomManager.refCount,this.refInfo={matRefCount:0},this.ndsModel=t,this.nMeshes=0,this.matrixes=null,this._meshBoxes_=[],this._mesh_boxes_flag_=[],this.geomId=[],this.matrixId=null,this.materialId=[],this.materialIdOriginal=[],this.materialUuids=[],this.bodyNodes=[],this.bodyUuids=[],this.meshObjectUuids=void 0,this.bodyUuid2IdMap={},this.materials={},this.mats=[],this.matsCopy=[],this.lineSegments2=new Ke,this.lineSegToLineSeg2Map=new Map,this.lineSegToLineSeg2MatMap=new Map,this.oriGeomUuid2MeshPosMap=new Map,this.lineStyleGeomUuid2MeshPosMap=new Map,this.geomUuid2MeshMtMap=new Map,this.geomUuid2MeshPosMap=new Map,this.spliceTextRow=[],this.spliceTextRowSelectArea=[],this.lineTypeUuid2ParamsMap=new Map,this.geomUuid2IndexMap=new Map,this.nLineSegments=0,this.lineSegGeomId=[],this.lineSegMatrixId=null,this.lineSegMaterialId=[],this.lineSegBodyNodes=[],this.lineSegBodyUuids=[],this.lineSegObjectUuids=void 0,this.lineSegMaterial=null,this.lineSegMaterialCopy=null,this.lineSegMaterialHidden=null,this.lineSegSelectedMaterialHidden=null,this.LINESEG_LOADED_FLAG=1,this.lineSegFlag=[],this.nTexts=0,this.textGeomId=[],this.textMatrixId=null,this.textMaterialId=[],this.textBodyNodes=[],this.textBodyUuids=[],this.textObjectUuids=void 0,this.geomUuid=[],this.subgeomId=[],this.lineSegGeomUuid=[],this.textGeomUuid=[],this.globalTransform=null,this._matrix_copy_=new THREE.Matrix4,this._bbox_=new THREE.Box3,this.mesh=new THREE.Mesh,this.mesh.bbox=new THREE.Box3,this.batchedMesh=new we,this.lineSegments=new THREE.LineSegments,this.batchedLineSegments=new xe,this.points=new THREE.Points,this.batchedPoint=new be,this.batchedLine2Segments=new Be,this.supportInstancedArrays=!1,this.supportInstancedArraysCopy=!1,this.instancedMeshIds=[],this.instancedLineSegInfos=[],this.instancedLineSegs=new Set,this.unInstancedLineSegIds=[],this.bNeedRecalculateInstanceMesh=!0,this.selectedMaterial=null,this.selectedLineSegMaterial=null,this.overrideMaterial=null,this.overrideMaterialCopy=null,this.useBodyIdMaterial=!1,this.enableTransparent=!0,this.ovrrideMeshOriginalColor=new Map,this.meshMaterial=new THREE.MeshBasicMaterial({color:16711680,side:THREE.DoubleSide}),this.copyFrom=function(e){this.refInfo=e.refInfo,this.nMeshes=e.nMeshes,this.matrixes=e.matrixes,this._meshBoxes_=e._meshBoxes_.slice(),this.geomId=e.geomId,this.matrixId=e.matrixId,this.materialId=e.materialId,this.materialIdOriginal=e.materialIdOriginal,this.materialUuids=e.materialUuids,this.bodyUuids=e.bodyUuids,this.meshObjectUuids=e.meshObjectUuids,this.bodyUuid2IdMap=e.bodyUuid2IdMap,this.materials=e.materials,this.mats=e.mats,this.matsCopy=e.matsCopy,++this.refInfo.matRefCount,this.lineSegments2=e.lineSegments,this.lineSegToLineSeg2Map=e.lineSegToLineSeg2Map,this.lineSegToLineSeg2MatMap=e.lineSegToLineSeg2MatMap,this.nLineSegments=e.nLineSegments,this.lineSegGeomId=e.lineSegGeomId,this.lineSegMatrixId=e.lineSegMatrixId,this.lineSegMaterialId=e.lineSegMaterialId,this.lineSegBodyUuids=e.lineSegBodyUuids,this.lineSegObjectUuids=e.lineSegObjectUuids,this.lineSegMaterial=e.lineSegMaterial,this.lineSegMaterialCopy=e.lineSegMaterialCopy,this.lineSegMaterialHidden=e.lineSegMaterialHidden,this.lineSegSelectedMaterialHidden=e.lineSegSelectedMaterialHidden,this.LINESEG_LOADED_FLAG=1,this.lineSegFlag=e.lineSegFlag,this.nTexts=e.nTexts,this.textGeomId=e.textGeomId,this.textMatrixId=e.textMatrixId,this.textMaterialId=e.textMaterialId,this.textBodyUuids=e.textBodyUuids,this.textObjectUuids=e.textObjectUuids,this.geomUuid=e.geomUuid,this.subgeomId=e.subgeomId,this.lineSegGeomUuid=e.lineSegGeomUuid,this.textGeomUuid=e.textGeomUuid,this.supportInstancedArrays=e.supportInstancedArrays,this.supportInstancedArraysCopy=e.supportInstancedArraysCopy,this.bNeedRecalculateInstanceMesh=!0},Array.prototype.extend=function(e){var t=this;e.forEach(function(e){t.push(e)},this)},Array.prototype.deletefromIds=function(e,t){var r=this;t&&e.sort(Te).reverse(),e.forEach(function(e){r.splice(e,1)},this)},this.dispose=function(){if(0===n.refInfo.matRefCount){for(var e=0,t=n.mats.length;e<t;++e)n.mats[e]&&n.mats[e].dispose(),n.mats[e]=null;n.mats=[];for(var r=0,i=n.matsCopy.length;r<i;++r)n.matsCopy[r]&&n.matsCopy[r].dispose(),n.matsCopy[r]=null}else--n.refInfo.matRefCount,n.mats=[];n.matsCopy=[]}},it=new THREE.Box3,nt=(rt.prototype={constructor:rt,setMatrixes:function(e){this.matrixes=e},expandMatrixes:function(e){var t,r;return this.matrixes?(t=this.matrixes.length/16,(r=new Array).extend(this.matrixes),r.extend(e),this.matrixes=new Float32Array(r),t):(this.setMatrixes(e),0)},setNumMeshes:function(e,t,r){void 0===t&&(t=!1),void 0===r&&(r=!1),this.nMeshes=e,this._meshBoxes_=new Float32Array(6*e),this._mesh_boxes_flag_=new Uint8Array(e),this.geomId=new Int32Array(e),this.materialId=new Int32Array(e),this.materialIdOriginal=new Int32Array(e),this.bodyNodes=new Array(e),this.bodyUuids=new Array(e),t&&(this.meshObjectUuids=new Array(e)),r&&(this.matrixId=new Int32Array(e))},expandMeshes:function(e,t,r){if(void 0===t&&(t=!1),void 0===r&&(r=!1),0===this.nMeshes)return this.setNumMeshes(e,t,r),0;var i=this.nMeshes;if(this.nMeshes+=e,this.nMeshes>this.geomId.length){for(var e=100<=e?e:100,n=new Float32Array(this._meshBoxes_.length+6*e),a=new Uint8Array(this._mesh_boxes_flag_.length+e),o=0,s=this._meshBoxes_.length;o<s;++o)n[o]=this._meshBoxes_[o],a[o]=this._mesh_boxes_flag_[o];this._meshBoxes_=n,this._mesh_boxes_flag_=a;for(var l=new Int32Array(this.geomId.length+e),d=0,c=this.geomId.length;d<c;++d)l[d]=this.geomId[d];this.geomId=l;for(var h=new Int32Array(this.materialId.length+e),u=0,p=this.materialId.length;u<p;++u)h[u]=this.materialId[u];this.materialId=h;for(var f=new Int32Array(this.materialIdOriginal.length+e),m=0,g=this.materialIdOriginal.length;m<g;++m)f[m]=this.materialIdOriginal[m];if(this.materialIdOriginal=f,this.bodyNodes=this.bodyNodes.concat(new Array(e)),this.bodyUuids=this.bodyUuids.concat(new Array(e)),t&&(this.meshObjectUuids=this.meshObjectUuids.concat(new Array(e))),r){for(var v=new Int32Array(this.matrixId.length+e),y=0,A=this.matrixId.length;y<A;++y)v[y]=this.matrixId[y];this.materialId=v}}return this.instancedMeshIds.length=0,i},getNumMeshes:function(){return this.nMeshes},deleteMeshes:function(r){r.sort(Te).reverse(),this.nMeshes-=r.length;var e=new Array,e=(e.extend(this._meshBoxes_),e=e.filter(function(e,t){if(-1==r.indexOf(Math.floor(t/6)))return!0}),this._meshBoxes_=new Float32Array(e),new Array),e=(e.extend(this.geomId),e.deletefromIds(r),this.geomId=new Int32Array(e),new Array),e=(e.extend(this.geomUuid),e.deletefromIds(r),this.geomUuid=e,new Array),e=(e.extend(this.materialId),e.deletefromIds(r),this.materialId=new Int32Array(e),new Array),e=(e.extend(this.materialIdOriginal),e.deletefromIds(r),this.materialIdOriginal=new Int32Array(e),new Array),e=(e.extend(this.bodyNodes),e.deletefromIds(r),this.bodyNodes=e,new Array);e.extend(this.bodyUuids),e.deletefromIds(r),this.bodyUuids=e,this.bNeedRecalculateInstanceMesh=!0},setMeshFromGeomUuid:function(e,t,r,i,n,a,o,s){var l=0;if(this.globalTransform)this._bbox_.min.x=t[0],this._bbox_.min.y=t[1],this._bbox_.min.z=t[2],this._bbox_.max.x=t[3],this._bbox_.max.y=t[4],this._bbox_.max.z=t[5],this._bbox_.applyMatrix4(this.globalTransform),this._meshBoxes_[6*e+0]=this._bbox_.min.x,this._meshBoxes_[6*e+1]=this._bbox_.min.y,this._meshBoxes_[6*e+2]=this._bbox_.min.z,this._meshBoxes_[6*e+3]=this._bbox_.max.x,this._meshBoxes_[6*e+4]=this._bbox_.max.y,this._meshBoxes_[6*e+5]=this._bbox_.max.z;else for(l=0;l<6;++l)this._meshBoxes_[6*e+l]=t[l];this._mesh_boxes_flag_[e]=0,this.geomUuid[e]=r,this.subgeomId[e]=i,this.materialId[e]=n,this.materialIdOriginal[e]=n,this.bodyUuids[e]=a,this.meshObjectUuids&&(this.meshObjectUuids[e]=o),this.matrixId&&(this.matrixId[e]=s)},setMaterialUuids:function(e){this.materialUuids=e},expandMaterialUuids:function(e){if(!this.materialUuids)return this.setMaterialUuids(e),null;var t=[];if(e&&0<e.length)for(var r=0,i=e.length;r<i;++r){var n=this.materialUuids.indexOf(e[r]);-1===n&&(n=this.materialUuids.length,this.materialUuids[n]=e[r]),t[r]=n}return t},setMaterials:function(e){Object.assign(this.materials,e)},expandBodyUuids:function(e,t,r,i){void 0===r&&(r=0),void 0===i&&(i=0);for(var n,a=t=void 0===t?0:t;a<this.nMeshes;a++)n=this.bodyUuids[a],this.ndsModel.viewer.ndsModel.bodyuuidOld2New[e[n]]?this.bodyUuids[a]=this.ndsModel.viewer.ndsModel.bodyuuidOld2New[e[n]]:this.bodyUuids[a]=e[n],this.meshObjectUuids&&(n=this.meshObjectUuids[a],this.ndsModel.viewer.ndsModel.bodyuuidOld2New[e[n]]?this.meshObjectUuids[a]=this.ndsModel.viewer.ndsModel.bodyuuidOld2New[e[n]]:this.meshObjectUuids[a]=e[n]);for(var o,a=r;a<this.nLineSegments;a++)o=this.lineSegBodyUuids[a],this.ndsModel.viewer.ndsModel.bodyuuidOld2New[e[o]]?this.lineSegBodyUuids[a]=this.ndsModel.viewer.ndsModel.bodyuuidOld2New[e[o]]:this.lineSegBodyUuids[a]=e[o],this.lineSegObjectUuids&&(o=this.lineSegObjectUuids[a],this.lineSegObjectUuids[a]=e[o]);for(var s,l=i;l<this.nTexts;++l)s=this.textBodyUuids[l],this.textBodyUuids[l]=e[s],this.textObjectUuids&&(s=this.textObjectUuids[l],this.textObjectUuids[l]=e[s]);for(var d=this.bodyUuids.length,c=0;c<d;++c)this.bodyUuid2IdMap[this.bodyUuids[c]]=c},setBodyUuids:function(e){this.expandBodyUuids(e)},collectGeomRefEntities:function(){for(var r=this,e=0,t=this.geomManager.geoms.length;e<t;++e)this.geomManager.geoms[e].refMeshes.length=0,this.geomManager.geoms[e].refLineSegs.length=0,this.geomManager.geoms[e].refTexts.length=0;for(var e=0;e<this.nMeshes;++e){var i=this.bodyNodes[e];1==De.HideLeafBody&&i.unload||-1<(i=this.geomId[e])&&this.geomManager.geoms[i].refMeshes.push(e)}for(e=0;e<this.nLineSegments;++e)-1<this.lineSegGeomId[e]&&this.geomManager.geoms[this.lineSegGeomId[e]].refLineSegs.push(e);for(e=0;e<this.nTexts;++e)-1<this.textGeomId[e]&&this.geomManager.geoms[this.textGeomId[e]].refTexts.push(e);for(e=0,t=this.geomManager.geoms.length;e<t;++e)this.geomManager.geoms[e].refMeshes.sort(function(e,t){return r.materialId[e]-r.materialId[t]}),1<this.geomManager.geoms[e].refLineSegs.length&&this.geomManager.geoms[e].refLineSegs.sort(function(e,t){return r.lineSegMaterialId[e]-r.lineSegMaterialId[t]}),1<this.geomManager.geoms[e].refTexts.length&&this.geomManager.geoms[e].refTexts.sort(function(e,t){return r.textMaterialId[e]-r.textMaterialId[t]})},setMaterialInfor:function(){if(!this.geomManager.isRefGeometryManager){for(s=0;s<this.geomManager.geoms.length;++s){var e=this.geomManager.geoms[s];if(1<e.refMeshes.length){e.refMeshesSameMaterial=!0,e.refMeshesSameMaterialOriginal=!0;for(var t=0;t<e.refMeshes.length-1;++t){var r=e.refMeshes[t],i=e.refMeshes[t+1];if(this.materialId[r]!==this.materialId[i]){e.refMeshesSameMaterial=!1,e.refMeshesSameMaterialOriginal=!1;break}}}if(1<e.refLineSegs.length){e.refLineSegsSameMaterial=!0,e.refLineSegsSameMaterialOriginal=!0;for(var n=0;n<e.refLineSegs.length-1;++n){var a=e.refLineSegs[n],o=e.refLineSegs[n+1];if(this.lineSegMaterialId[a]!==this.lineSegMaterialId[o]){e.refLineSegsSameMaterial=!1,e.refLineSegsSameMaterialOriginal=!1;break}}}}var s=0,l=this.mats.length,d=(this.mats=[],this.materialUuids.length);for(s=0;s<d;++s){var c=(c=this.materials[this.materialUuids[s]])||this.materials[this.materialUuids[s].toUpperCase()];this.mats.push(c?c.mat:null)}var h,u,p,f={};for(s=0;s<this.nMeshes;++s)-1<this.geomId[s]&&this.geomManager.getGeomFromId(this.geomId[s]).vertexColors&&((h=f[this.materialId[s]])||((u=(new(u=this.mats[this.materialId[s]]).constructor).copy(u)).vertexColors=!0,this.mats.push(u),++d,h=this.mats.length-1,f[this.materialId[s]]=h),this.materialId[s]=h,this.materialIdOriginal[s]=h);for(s=0;s<d;++s)this.mats[s]?(p=(new this.mats[s].constructor).copy(this.mats[s]),this.mats.push(p)):this.mats.push(null);if(this.supportInstancedArrays)for(var m,g=this.mats.length/2,s=0;s<this.nMeshes;++s)-1<this.geomId[s]&&(1<(m=this.geomManager.getGeomFromId(this.geomId[s])).refMeshes.length&&!m.useSharedGlBuffer?(this.materialId[s]=this.materialIdOriginal[s]+g,m.updateModelMatrix=!0):this.materialId[s]=this.materialIdOriginal[s]);if(0<this.matsCopy.length&&this.mats.length!=l){var v=this.matsCopy[0].opacity;for(s=0;s<this.matsCopy.length;++s)this.matsCopy[s].dispose();for(s=this.matsCopy.length=0;s<this.mats.length;++s)this.mats[s]&&(this.matsCopy[s]=this.mats[s].clone(),this.matsCopy[s].uuid=this.mats[s].uuid,this.matsCopy[s].program=this.mats[s].program,this.matsCopy[s].needsUpdate=this.mats[s].needsUpdate,this.matsCopy[s].opacity=v,this.matsCopy[s].transparent=!0)}}},mapGeomUuidToGeomId:function(){var e=0;if(!this.geomManager.isRefGeometryManager){for(e=0;e<this.nMeshes;++e)this.geomId[e]=this.geomManager.getGeomIdFromUuid(this.geomUuid[e],this.subgeomId[e]);for(e=0;e<this.nLineSegments;++e)this.lineSegGeomId[e]=this.geomManager.getGeomIdFromUuid(this.lineSegGeomUuid[e],0);for(e=0;e<this.nTexts;++e)this.textGeomId[e]=this.geomManager.getGeomIdFromUuid(this.textGeomUuid[e],0);this.collectGeomRefEntities()}this.bNeedRecalculateInstanceMesh=!0},setMeshMaterialEnvMap:function(e,t){if(this.ndsModel.bodyNodeUUidToMaterial)for(var r in this.ndsModel.bodyNodeUUidToMaterial){r=this.ndsModel.bodyNodeUUidToMaterial[r];r.envMap=e,r.combine=t}for(var i=0,n=this.mats.length;i<n;++i)this.mats[i]&&void 0!==this.mats[i].envMap&&(this.mats[i].envMap=e,void 0!==this.mats[i].combine&&(this.mats[i].combine=t),this.mats[i].needsUpdate=!0)},makeMeshBBoxDirty:function(e){for(var t=0,r=e.length;t<r;++t)this._mesh_boxes_flag_[e[t]]=1},isMeshBBoxDirty:function(e){return 1===this._mesh_boxes_flag_[e]},getMeshBBox:function(){new THREE.Matrix4;return function(e,t){return 1===this._mesh_boxes_flag_[e]?t.copy(this.updateMeshBBox(e)):(t.min.fromArray(this._meshBoxes_,6*e),t.max.fromArray(this._meshBoxes_,6*e+3)),t}}(),reCalculateMeshBBox:function(){for(var e=0;e<this.nMeshes;++e)this.updateMeshBBox(e)},updateMeshBBox:function(e){var t,r,i=this._bbox_;return this.geomId[e]<0||(t=this.bodyNodes[e],(r=this.geomManager.getGeomFromId(this.geomId[e])).boundingBox.isEmpty()||1!==this._mesh_boxes_flag_[e]?(i.min.x=this._meshBoxes_[6*e],i.min.y=this._meshBoxes_[6*e+1],i.min.z=this._meshBoxes_[6*e+2],i.max.x=this._meshBoxes_[6*e+3],i.max.y=this._meshBoxes_[6*e+4],i.max.z=this._meshBoxes_[6*e+5]):(i.copy(r.boundingBox),i.applyMatrix4(t.worldMatrix),this._meshBoxes_[6*e]=i.min.x,this._meshBoxes_[6*e+1]=i.min.y,this._meshBoxes_[6*e+2]=i.min.z,this._meshBoxes_[6*e+3]=i.max.x,this._meshBoxes_[6*e+4]=i.max.y,this._meshBoxes_[6*e+5]=i.max.z,this._mesh_boxes_flag_[e]=0)),i},getMeshInfor:function(e,t,r,i){return void 0===r&&(r=!0),void 0===i&&(i=!0),(t=t||{}).bodyNode=this.bodyNodes[e],-1<this.geomId[e]?t.geometry=this.geomManager.getGeomFromId(this.geomId[e]):t.geometry=null,r&&(t.material=this.getMeshMaterialByMeshId(e,t.bodyNode,t.geometry)),i&&(t.matrixWorld||(t.matrixWorld=new THREE.Matrix4),r=t.bodyNode.worldMatrix,t.matrixWorld.copy(r)),t},getSingleMesh:function(e){var t=this.supportInstancedArrays,e=(this.supportInstancedArrays=!1,this.getMesh(e));return this.supportInstancedArrays=t,e},getMeshMaterialByMeshId:function(t,e,r){var i,n,a,o,s=e;if(e||!(s=this.bodyNodes[t]).isHidden())return(e=r)||(e=this.geomManager.getGeomFromId(this.geomId[t])),r=s.getMaterialBodyNodeUUid(),(i=s.getUserMaterial())?(i.colors&&i.colors.forEach(function(e){e.meshId==t&&(i.color.copy(e.value),i.needsUpdate=!0,i.needsRefresh=!0)}),i.opacities&&i.opacities.forEach(function(e){e.meshId==t&&(i.opacity=e.value,i.opacity<1?i.transparent=!0:i.transparent=!1,i.needsUpdate=!0,i.needsRefresh=!0)}),(o=this.materialId[t])>=this.mats.length/2&&(e.refMeshesSameMaterial&&this.supportInstancedArrays&&!e.useSharedGlBuffer||(o-=this.mats.length/2)),a=this.mats[o],i.backMaterial||(i.backMaterial=i.clone(),i.backMaterial.transparent=!0,i.backMaterial.opacity=De.bodyOpacity,i.backoriMaterial=i.clone(),i.backoriMaterial.transparent=a.transparent,i.backoriMaterial.opacity=a.opacity,i.colors&&(i.backMaterial.colors=Array.from(i.colors)),i.colors&&(i.backoriMaterial.colors=Array.from(i.colors))),a=i,e.refMeshesSameMaterial=!1,0<this.ndsModel.transparentizedBodies.length&&s.isTransparent()?a=i.backMaterial:s.isOriginalTransparent()&&(a=i.backoriMaterial)):(n=r&&(r=this.ndsModel.bodyNodeUUidToMaterial[r])?r:n)?(n.transparentMaterial||(n.transparentMaterial=n.clone(),n.transparentMaterial.transparent=!0,n.transparentMaterial.opacity=De.bodyOpacity),a=n,e.refMeshesSameMaterial=!1,0<this.ndsModel.transparentizedBodies.length&&s.isTransparent()&&(a=n.transparentMaterial)):((o=this.materialId[t])>=this.mats.length/2&&(e.refMeshesSameMaterial&&this.supportInstancedArrays||(o-=Math.floor(this.mats.length/2))),a=this.mats[o],0<this.ndsModel.transparentizedBodies.length&&s.isTransparent()&&(a=this.matsCopy[o])),a.transparent&&a.opacity<.99?a.depthWrite=!1:a.depthWrite=!0,a},getMesh:function(e){if(!(this.geomId[e]<0)){var t=this.bodyNodes[e];if(De.HideLeafBody){var r=t.parent.FirstVisibleNode||0;if(t.parent.children[r].isHidden()||t.unload)return}else if(t.isHidden())return;if(this.mesh.meshId=e,this.mesh.hasSurface=t.hasSurface,this.mesh.geometry=this.geomManager.getGeomFromId(this.geomId[e]),this.mesh.geometry.aniMorphInfluences&&this.mesh.geometry.aniMorphDictionary?(this.mesh.morphTargetInfluences=this.mesh.geometry.aniMorphInfluences,this.mesh.morphTargetDictionary=this.mesh.geometry.aniMorphDictionary):this.mesh.morphTargetInfluences&&(delete this.mesh.morphTargetInfluences,delete this.mesh.morphTargetDictionary),this.mesh.geometry.isInstancedBufferGeometry=!1,this.mesh.material=this.getMeshMaterialByMeshId(e,t,this.mesh.geometry),this.mesh.material.OriginTransparentFlag||(this.mesh.material.OriginTransparent=this.mesh.material.transparent,this.mesh.material.OriginOpacity=this.mesh.material.opacity,this.mesh.material.OriginTransparentFlag=!0),this.mesh.material){var r=this.mesh.geometry.refMeshes.length;if(this.supportInstancedArrays&&1<r)this.mesh.geometry.isInstancedBufferGeometry=!0,this.mesh.geometry.instanceCount=this.mesh.instancedCount;else{if(this.mesh.geometry.instanceCount=0,this.matrixes&&!this.ndsModel.viewer.animationRun)for(var i=0;i<16;++i)this.mesh.matrixWorld.elements[i]=this.matrixes[16*this.matrixId[e]+i];else this.mesh.matrixWorld.copy(t.worldMatrix);this.overrideMaterial&&(this.mesh.material=this.overrideMaterial,this.useBodyIdMaterial)&&(this.mesh.material=this.overrideMaterialCopy,this.mesh.material.color.setHex(10*t.id)),this.enableTransparent?void 0!==this.mesh.material.OriginTransparent&&void 0!==this.mesh.material.OriginOpacity&&(this.mesh.material.originalTransparentInfo&&this.mesh.material.originalTransparentInfo.get(e)?(r=this.mesh.material.originalTransparentInfo.get(e),this.mesh.material.transparent=r.originalTransparent,this.mesh.material.opacity=r.originalOpacity):this.mesh.material.transparent!=this.mesh.material.OriginTransparent&&(this.mesh.material.transparent=this.mesh.material.OriginTransparent,this.mesh.material.opacity=this.mesh.material.OriginOpacity,this.mesh.material.needsUpdate=!0)):this.mesh.material.transparent&&(this.mesh.material.transparent=!1,this.mesh.material.opacity=1,this.mesh.material.needsUpdate=!0)}return this.mesh}}},getMeshOriginalMaterial:function(e){var t,r,i,n=this.bodyNodes[e],a=(De.HideLeafBody&&!n.sketchBody&&(a=n.parent.FirstVisibleNode||0,n=n.parent.children[a]),n.getMaterialBodyNodeUUid()),o=n.getUserMaterial(),s=null;return o?((i=this.materialId[e])>=this.mats.length/2&&(this.mesh.geometry.refMeshesSameMaterial&&this.supportInstancedArrays||(i-=this.mats.length/2)),r=this.mats[i],o.backMaterial||(o.backMaterial=o.clone(),o.backMaterial.transparent=!0,o.backMaterial.opacity=De.bodyOpacity,o.backoriMaterial=o.clone(),o.backoriMaterial.transparent=r.transparent,o.backoriMaterial.opacity=r.opacity,o.colors&&(o.backMaterial.colors=Array.from(o.colors)),o.colors&&(o.backoriMaterial.colors=Array.from(o.colors))),s=o,0<this.ndsModel.transparentizedBodies.length&&n.isTransparent()?s=o.backMaterial:n.isOriginalTransparent()&&(s=o.backoriMaterial)):s=(t=a&&(r=this.ndsModel.bodyNodeUUidToMaterial[a])?r:t)||(i=this.materialId[e],this.mats[i]),s},getTextInfo:function(e,t){return(t=t||{}).bodyNode=this.textBodyNodes[e],-1<this.textGeomId[e]?(t.geometry=this.geomManager.getGeomFromId(this.textGeomId[e]),t.geometry.isInstancedBufferGeometry=!1):t.geometry=null,t},getText:function(e){if(!(this.textGeomId[e]<0)){var t=this.textBodyNodes[e];if(!t.isHidden())return"shxLoad"==(t=this.geomManager.getGeomFromId(this.textGeomId[e])).textLoad?this.getLineText(e):"ttfLoad"==t.textLoad?this.getMeshText(e):void t.textLoad}},getLineText:function(e){var t=this.textBodyNodes[e];if(!t.isHidden()){this.lineSegments.geometry=this.geomManager.getGeomFromId(this.textGeomId[e]),this.lineSegments.geometry.isInstancedBufferGeometry=!1,this.lineSegments.material=this.materials["text:"+this.lineSegments.geometry.styleId].mat;var r=this.mats[this.textMaterialId[e]],i=(this.lineSegments.material.uniforms.diffuse.value.copy(t.isSelected()?De.selectedColor:r.color),this.lineSegments.material.uniformsNeedUpdate=!0,1<this.lineSegments.material.linewidth&&(this.lineSegments.material.linewidthCopy=this.lineSegments.material.linewidth),this.lineSegments.material.linewidth=1,this.lineSegments.geometry.refMeshes.length);if(this.supportInstancedArrays&&1<i&&!this.lineSegments.geometry.useSharedGlBuffer&&this.lineSegments.geometry.refMeshesSameMaterial){if(this.lineSegments.instancedCount=i,!this.lineSegments.geometry.dirty&&!this.lineSegments.geometry.updateModelMatrix&&this.lineSegments.geometry.modelMatrixBuffer)return void(this.lineSegments.matrixWorlds=null);if(!this.lineSegments.geometry.vao&&!this.lineSegments.geometry.modelMatrixBuffer||this.lineSegments.geometry.updateModelMatrix){this.lineSegments.matrixWorlds=new Float32Array(16*i);for(var n=0;n<i;++n){var a=this.lineSegments.geometry.refMeshes[n],o=16*n;if(this.matrixes)for(var s=0;s<16;++s)this.lineSegments.matrixWorlds[o+s]=this.matrixes[16*this.textMatrixId[a]+s];else this.bodyNodes[a].worldMatrix.toArray(this.lineSegments.matrixWorlds,o)}this.lineSegments.geometry.updateModelMatrix=!1}else this.lineSegments.matrixWorlds=null;this.lineSegments.geometry.dirty=!1,this.overrideMaterialCopy&&(this.lineSegments.material=this.overrideMaterialCopy)}else{if(this.lineSegments.position.copy(this.lineSegments.geometry.position),this.lineSegments.quaternion.copy(this.lineSegments.geometry.quaternion),this.lineSegments.updateMatrix(),this.lineSegments.matrixWorldNeedsUpdate=!1,this.lineSegments.geometry.modelMatrixAttribute&&(this.lineSegments.geometry.deleteAttribute("modelMatrixAttrib"),delete this.lineSegments.geometry.modelMatrixAttribute),this.lineSegments.instancedCount=0,this.lineSegments.geometry.instanceCount=0,this.matrixes)for(s=0;s<16;++s)this.lineSegments.matrixWorld.elements[s]=this.matrixes[16*this.textMatrixId[e]+s];else this.lineSegments.matrixWorld.copy(t.worldMatrix);this.lineSegments.matrixWorld.multiply(this.lineSegments.matrix),this.lineSegments.lineSegments2=this.lineSegmentToLineSegment2(this.lineSegments,this.lineSegments.geometry,this.lineSegments.material,t.isSelected())}return this.lineSegments}},getMeshText:function(e){if(!(this.textGeomId[e]<0)){var t=this.textBodyNodes[e];if(!t.isHidden()){this.mesh.meshId=e,this.mesh.geometry=this.geomManager.getGeomFromId(this.textGeomId[e]),this.mesh.geometry.isInstancedBufferGeometry=!1,this.mesh.material=this.materials["text:"+this.mesh.geometry.styleId].mat;var r=this.mats[this.textMaterialId[e]],i=(this.mesh.material.uniforms.diffuse.value.copy(t.isSelected()?De.selectedColor:r.color),this.mesh.material.uniformsNeedUpdate=!0,this.mesh.geometry.refMeshes.length);if(this.supportInstancedArrays&&1<i&&!this.mesh.geometry.useSharedGlBuffer&&this.mesh.geometry.refMeshesSameMaterial){if(this.mesh.instancedCount=i,!this.mesh.geometry.dirty&&!this.mesh.geometry.updateModelMatrix&&this.mesh.geometry.modelMatrixBuffer)return void(this.mesh.matrixWorlds=null);if(!this.mesh.geometry.vao&&!this.mesh.geometry.modelMatrixBuffer||this.mesh.geometry.updateModelMatrix){this.mesh.matrixWorlds=new Float32Array(16*i);for(var n=0;n<i;++n){var a=this.mesh.geometry.refMeshes[n],o=16*n;if(this.matrixes)for(var s=0;s<16;++s)this.mesh.matrixWorlds[o+s]=this.matrixes[16*this.textMatrixId[a]+s];else this.bodyNodes[a].worldMatrix.toArray(this.mesh.matrixWorlds,o)}this.mesh.geometry.updateModelMatrix=!1}else this.mesh.matrixWorlds=null;this.mesh.geometry.dirty=!1,this.overrideMaterialCopy&&(this.mesh.material=this.overrideMaterialCopy)}else{if(this.mesh.position.copy(this.mesh.geometry.position),this.mesh.quaternion.copy(this.mesh.geometry.quaternion),this.mesh.updateMatrix(),this.mesh.matrixWorldNeedsUpdate=!1,this.mesh.geometry.modelMatrixAttribute&&(this.mesh.geometry.deleteAttribute("modelMatrixAttrib"),delete this.mesh.geometry.modelMatrixAttribute),this.mesh.instancedCount=0,this.mesh.geometry.instanceCount=0,this.matrixes)for(s=0;s<16;++s)this.mesh.matrixWorld.elements[s]=this.matrixes[16*this.textMatrixId[e]+s];else this.mesh.matrixWorld.copy(t.worldMatrix);this.mesh.matrixWorld.multiply(this.mesh.matrix)}return this.mesh}}},recalculateInstance:function(){var t=this;if(this.bNeedRecalculateInstanceMesh){this.instancedLineSegInfos.length=0;for(var e=this.unInstancedLineSegIds.length=0,r=this.geomManager.geoms.length;e<r;++e)if(1<this.geomManager.geoms[e].refMeshes.length&&this.instancedMeshIds.push(this.geomManager.geoms[e].refMeshes[0]),1<this.geomManager.geoms[e].refLineSegs.length){for(var i=this.geomManager.geoms[e],n=this.lineSegMaterialId[i.refLineSegs[0]],a=[],o=this.instancedLineSegInfos.length,s=0,l=i.refLineSegs.length;s<l;++s)a[a.length]=i.refLineSegs[s],n!==this.lineSegMaterialId[i.refLineSegs[s]]&&(n=this.lineSegMaterialId[i.refLineSegs[s]],1<a.length?(this.instancedLineSegInfos.push({instanceId:o,lineSegIds:a}),a.forEach(function(e){return t.instancedLineSegs.add(e)})):this.unInstancedLineSegIds.push(a[0]),a=[]);1<a.length?(this.instancedLineSegInfos.push({instanceId:o,lineSegIds:a}),a.forEach(function(e){return t.instancedLineSegs.add(e)})):1===a.length&&this.unInstancedLineSegIds.push(a[0])}else 1===this.geomManager.geoms[e].refLineSegs.length&&this.unInstancedLineSegIds.push(this.geomManager.geoms[e].refLineSegs[0]);this.unInstancedLineSegIds.sort(function(e,t){return e-t});for(var d=[],e=0,r=this.instancedMeshIds.length;e<r;++e){var c=this.instancedMeshIds[e],h=this.materialId[c],u=this.mats[h],u=u.program?u.program.id:1e4;d.push(new N(c,h,u,0))}d.sort(V),this.instancedMeshDirtyFlags=[];for(e=0,r=this.instancedMeshIds.length;e<r;++e)this.instancedMeshIds[e]=d[e].meshId,this.instancedMeshDirtyFlags[e]=!0;this.instancedLineDirtyFlags=[];for(e=0,r=this.instancedLineSegs.size;e<r;++e)this.instancedLineDirtyFlags[e]=!0;this.bNeedRecalculateInstanceMesh=!1}},resetLineInstance:function(){for(var e=0,t=this.geomManager.geoms.length;e<t;++e)if(1<this.geomManager.geoms[e].refLineSegs.length){for(var r=this.geomManager.geoms[e],i=this.lineSegMaterialId[r.refLineSegs[0]],n=[],a=0,o=r.refLineSegs.length;a<o;++a)n[n.length]=r.refLineSegs[a],i!==this.lineSegMaterialId[r.refLineSegs[a]]&&(i=this.lineSegMaterialId[r.refLineSegs[a]],1<n.length&&(r.dirty=!0),n=[]);1<n.length&&(r.dirty=!0)}},getNumInstancedLineSegs:function(){return this.recalculateInstance(),this.instancedLineSegInfos.length},getNumUnInstancedLineSegs:function(){return this.recalculateInstance(),this.unInstancedLineSegIds.length},getNumInstancedMeshes:function(){return this.recalculateInstance(),this.instancedMeshIds.length},getInstancedMesh:function(e){e=this.instancedMeshIds[e],e=this.getMesh(e);if(e&&e.geometry.refMeshesSameMaterial)return e},getInstancedLineSegWithState:function(e,t){e=this.instancedLineSegInfos[e];return this.getLineSegmentsWithState(e,t)},getInstancedLineSeg:function(e,t){e=this.instancedLineSegInfos[e],e=this.getLineSegmentsWithState(e,t);return 1===e.state?e.lineSegments:null},getUnInstancedLineSegWithState:function(e,t){return this.getLineSegmentsWithState(this.unInstancedLineSegIds[e],t,!0)},getUnInstancedLineSeg:function(e,t){e=this.getLineSegmentsWithState(this.unInstancedLineSegIds[e],t,!0);return 1===e.state?e.lineSegments:null},getInstancedLineSegId:function(e){return this.instancedLineSegInfos[e].lineSegIds[0]},getUnInstancedLineSegId:function(e){return this.unInstancedLineSegIds[e]},getInstancedMeshId:function(e){return this.instancedMeshIds[e]},setNumLineSegments:function(e,t,r){void 0===t&&(t=!1),void 0===r&&(r=!1),this.nLineSegments=e,this.lineSegGeomId=new Int32Array(e),this.lineSegMaterialId=new Int32Array(e),this.lineSegFlag=new Uint8Array(e),this.lineSegBodyUuids=new Array(e),this.lineSegBodyNodes=new Array(e),t&&(this.lineSegObjectUuids=new Array(e)),r&&(this.lineSegMatrixId=new Int32Array(e))},expandLineSegments:function(e,t,r){var i,n;return void 0===t&&(t=!1),void 0===r&&(r=!1),0===this.nLineSegments?(this.setNumLineSegments(e,t,r),0):(i=this.nLineSegments,this.nLineSegments+=e,this.nLineSegments>this.lineSegGeomId.length&&(e=100<=e?e:100,(n=new Int32Array(this.lineSegGeomId.length+e)).set(this.lineSegGeomId),this.lineSegGeomId=n,(n=new Int32Array(this.lineSegMaterialId.length+e)).set(this.lineSegMaterialId),this.lineSegMaterialId=n,(n=new Uint8Array(this.lineSegFlag.length+e)).set(this.lineSegFlag),this.lineSegFlag=n,this.lineSegBodyNodes=this.lineSegBodyNodes.concat(new Array(e)),this.lineSegBodyUuids=this.lineSegBodyUuids.concat(new Array(e)),t&&(this.lineSegObjectUuids=this.lineSegObjectUuids.concat(new Array(e))),r)&&((n=new Int32Array(this.lineSegMatrixId.length+e)).set(this.lineSegMatrixId),this.lineSegMatrixId=n),i)},deleteLineSegments:function(e){e.sort(Te).reverse(),this.nLineSegments-=e.length;var t=new Array,t=(t.extend(this.lineSegGeomId),t.deletefromIds(e),this.lineSegGeomId=new Int32Array(t),new Array),t=(t.extend(this.lineSegGeomUuid),t.deletefromIds(e),this.lineSegGeomUuid=t,new Array),t=(t.extend(this.lineSegMaterialId),t.deletefromIds(e),this.lineSegMaterialId=new Int32Array(t),new Array),t=(t.extend(this.lineSegFlag),t.deletefromIds(e),this.lineSegFlag=new Uint8Array(t),new Array),t=(t.extend(this.lineSegBodyUuids),t.deletefromIds(e),this.lineSegBodyUuids=t,new Array);t.extend(this.lineSegBodyNodes),t.deletefromIds(e),this.lineSegBodyNodes=t},setLineSegmentsFromGeomUuid:function(e,t,r,i,n,a){this.lineSegGeomUuid[e]=t,this.lineSegBodyUuids[e]=r,this.lineSegMaterialId[e]=void 0!==i?i:-1,this.lineSegObjectUuids&&(this.lineSegObjectUuids[e]=n),this.lineSegMatrixId&&(this.lineSegMatrixId[e]=a)},calcLineSegmentsBox:function(){for(var e=0;e<this.nLineSegments;++e){var t=this.lineSegBodyNodes[e];if(!(0<this.getNumBodyMeshs(t))){var r=this.geomManager.getGeomFromId(this.lineSegGeomId[e]);if(r&&r.boundingBox&&!r.boundingBox.isEmpty()){var i=r.boundingBox.clone();if(0==t.leafBodyAttri.bodyBbox.length)for(var n=0;n<3;++n)t.leafBodyAttri.bodyBbox[n]=i.min.getComponent(n),t.leafBodyAttri.bodyBbox[3+n]=i.max.getComponent(n)}}}},mergeLineSegments:function(){for(var e,t,r=0;r<this.nLineSegments;++r){var i,n=this.lineSegBodyNodes[r];if(!(0<this.getNumBodyMeshs(n))&&n.leafBodyAttri)if(i=this.geomManager.getGeomFromId(this.lineSegGeomId[r])){var a=i.boundingBox.clone();if(6==n.leafBodyAttri.bodyBbox.length)for(var o=0;o<3;++o)a.min.getComponent(o)<n.leafBodyAttri.bodyBbox[o]&&(n.leafBodyAttri.bodyBbox[o]=a.min.getComponent(o)),a.max.getComponent(o)>n.leafBodyAttri.bodyBbox[3+o]&&(n.leafBodyAttri.bodyBbox[3+o]=a.max.getComponent(o));else for(o=0;o<3;++o)n.leafBodyAttri.bodyBbox[o]=a.min.getComponent(o),n.leafBodyAttri.bodyBbox[3+o]=a.max.getComponent(o)}}for(r=0;r<this.nLineSegments-1;++r)this.lineSegBodyNodes[r]===this.lineSegBodyNodes[r+1]&&this.lineSegMaterialId[r]===this.lineSegMaterialId[r+1]&&(t=this.lineSegGeomId[r],e=this.lineSegGeomId[r+1],i=this.geomManager.getGeomFromId(t),t=this.geomManager.getGeomFromId(e),i&&t)&&(i.tangentEdgeObject&&!t.tangentEdgeObject||!i.tangentEdgeObject&&t.tangentEdgeObject||i.index===t.index&&i.drawRange.start+i.drawRange.count===t.drawRange.start&&(t.drawRange.start-=i.drawRange.count,t.drawRange.count+=i.drawRange.count,i.drawRange.count=0))},getNumLineSegments:function(){return this.nLineSegments},isLineSegmentsLoaded:function(e){if(0==(this.lineSegFlag[e]&this.LINESEG_LOADED_FLAG)){var t=this.geomManager,r=t.getGeomFromId(this.lineSegGeomId[e]);if(!r||!r.loaded||!r.index)return!1;t.loadedVertexAttributes.has(r.index.uuid)||(t.usedMemory+=r.index.array.byteLength,t.usedGpuMemory+=r.index.array.byteLength,t.loadedVertexAttributes.add(r.index.uuid)),t.loadedVertexAttributes.has(r.attributes.position.uuid)||(t.usedMemory+=(r.attributes.position.array?r.attributes.position:r.attributes.position.data).array.byteLength,t.usedGpuMemory+=(r.attributes.position.array?r.attributes.position:r.attributes.position.data).array.byteLength,t.loadedVertexAttributes.add(r.attributes.position.uuid)),this.lineSegFlag[e]|=this.LINESEG_LOADED_FLAG,t.usedMemory>=.9*t.maxMemory&&(t.stopLoading=!0,t.allGeomInMemory=!1)}return!0},getLineSegBBox:function(e,t){var r;this.lineSegMatrixId&&-1<this.lineSegMatrixId[e]?(this._matrix_copy_.fromArray(this.matrixes,16*this.lineSegMatrixId[e]),(r=this.geomManager.getGeomFromId(this.lineSegGeomId[e])).boundingBox.isEmpty()&&r.computeBoundingBox(),t.copy(r.boundingBox),t.applyMatrix4(this._matrix_copy_)):((r=this.geomManager.getGeomFromId(this.lineSegGeomId[e])).boundingBox.isEmpty()&&r.computeBoundingBox(),t.copy(r.boundingBox),t.applyMatrix4(this.lineSegBodyNodes[e].worldMatrix))},getLineSegmentsInfor:function(e,t,r,i){if(void 0===r&&(r=!0),void 0===i&&(i=!0),(t=t||{}).bodyNode=this.lineSegBodyNodes[e],-1<this.lineSegGeomId[e]?t.geometry=this.geomManager.getGeomFromId(this.lineSegGeomId[e]):t.geometry=null,r){r=null,e=this.lineSegMaterialId[e];if(-1<e&&(1<(r=this.mats[e]).linewidth&&(r.linewidthCopy=r.linewidth),r.linewidth=1),!r||"LineBasicMaterial"!=r.type&&"ShaderMaterial"!=r.type){if(!this.lineSegMaterial){for(var n in this.materials)if("LineBasicMaterial"===this.materials[n].mat.type){this.lineSegMaterial=this.materials[n].mat;break}this.lineSegMaterial||(this.lineSegMaterial=new THREE.LineBasicMaterial({color:0,linewidth:1}))}r=this.lineSegMaterial}this.enableTransparent&&t.bodyNode.isTransparent()&&this.lineSegMaterialCopy?t.material=this.lineSegMaterialCopy:t.material=r}return i&&(e=this.ndsModel.getBodyTranslate(t.bodyNode),t.matrixWorld||(t.matrixWorld=new THREE.Matrix4),r=t.bodyNode.worldMatrix,t.matrixWorld.copy(r),t.matrixWorld.elements[12]+=e[0],t.matrixWorld.elements[13]+=e[1],t.matrixWorld.elements[14]+=e[2]),t},getLineSegmentsWithState:function(e,t,r){i=e.lineSegIds?(n=e).lineSegIds[0]:e;var i,n,e={state:1,lineSegments:null,lineStyle:null};if((r=void 0===r?!1:r)&&this.instancedLineSegs.has(i))e.state=0;else if(this.isLineSegmentsLoaded(i)){this.instanceMats||(this.instanceMats=new Map);r=this.geomManager.getGeomFromId(this.lineSegGeomId[i]);if(0===r.drawRange.count)e.state=0;else if(!1===De.tangentEdgeVisible&&r.tangentEdgeObject)e.state=0;else{var a=this.lineSegBodyNodes[i],o=void 0;if(a){if(De.HideLeafBody&&!a.sketchBody){var s=a.parent.FirstVisibleNode||0;if(a.parent.children[s].isHidden()||a.unload){if(a.unload)return e.state=0,e;if(!a.parent.children[s].isSelected())return e.state=0,e;o=a.parent.children[s].isHidden(),a.parent.children[s].show()}}else if(a.isSelected()&&(o=a.isHidden(),a.show()),a.isHidden())return e.state=0,e;this.lineSegments.geometry=r,this.lineSegments.geometry.isInstancedBufferGeometry=!1;var s=null,r=this.lineSegMaterialId[i];if(-1<r&&(1<(s=this.mats[r]).linewidth&&(s.linewidthCopy=s.linewidth),s.linewidth=1),!s||"LineBasicMaterial"!=s.type&&"ShaderMaterial"!=s.type){if(!this.lineSegMaterial){for(var l in this.materials)if("LineBasicMaterial"===this.materials[l].mat.type){this.lineSegMaterial=this.materials[l].mat;break}this.lineSegMaterial||(this.lineSegMaterial=new THREE.LineBasicMaterial({color:0,linewidth:1}))}s=this.lineSegMaterial}if(n&&(this.instanceMats.has(s.uuid)||(r=s.clone(),s.linewidthCopy&&(r.linewidthCopy=s.linewidthCopy),r.needsUpdate=!0,r.needsRefresh=!0,this.instanceMats.set(s.uuid,r)),"ShaderMaterial"==(r=this.instanceMats.get(s.uuid)).type||r.color.equals(s.color)?"ShaderMaterial"!=r.type||r.uniforms.diffuse.value.equals(s.uniforms.diffuse.value)||(r.color&&r.color.copy(s.color),r.uniforms.diffuse.value.copy(s.color)):r.color.copy(s.color),a.isSelected()&&("ShaderMaterial"==r.type||r.color.equals(De.selectedColor)?"ShaderMaterial"!=r.type||r.uniforms.diffuse.value.equals(De.selectedColor)||(r.color&&r.color.copy(De.selectedColor),r.uniforms.diffuse.value.copy(De.selectedColor)):r.color.copy(De.selectedColor)),r.isInstanceMaterial=!0,s=r),t?(void 0===s.oldOpacity&&(s.oldOpacity=s.opacity,s.oldTransparent=s.transparent,s.oldDepthFunc=s.depthFunc,s.needsUpdate=!0,s.needsRefresh=!0),s.opacity=.2,s.transparent=!0,s.depthFunc=THREE.GreaterDepth):null!=s.oldOpacity&&(s.opacity=s.oldOpacity,s.transparent=s.oldTransparent,s.depthFunc=s.oldDepthFunc,s.needsUpdate=!0,s.needsRefresh=!0,s.oldOpacity=void 0,s.oldTransparent=void 0,s.oldDepthFunc=void 0),this.lineSegments.material=s,a.isSelected()&&(this.selectedLineSegMaterial=s.clone(),this.ndsModel.viewer.selectionManager.shouldApplySelectedMaterial&&(this.selectedLineSegMaterial.color&&this.selectedLineSegMaterial.color.copy(De.selectedColor),"ShaderMaterial"==this.selectedLineSegMaterial.type)&&this.selectedLineSegMaterial.uniforms.diffuse.value.copy(De.selectedColor),this.ndsModel.viewer.selectionManager.overrideLineSelectionMaterialIn3DViewer(this.selectedLineSegMaterial),t&&!this.lineSegSelectedMaterialHidden&&(this.lineSegSelectedMaterialHidden=this.selectedLineSegMaterial.clone(),this.lineSegSelectedMaterialHidden.uuid=this.selectedLineSegMaterial.uuid,this.lineSegSelectedMaterialHidden.program=this.selectedLineSegMaterial.program,this.lineSegSelectedMaterialHidden.needsUpdate=!0,this.lineSegSelectedMaterialHidden.opacity=.2,this.lineSegSelectedMaterialHidden.transparent=!0,this.lineSegSelectedMaterialHidden.depthFunc=THREE.GreaterDepth),this.lineSegments.material=t?this.lineSegSelectedMaterialHidden:this.selectedLineSegMaterial),a.isTransparent()&&this.lineSegMaterialCopy&&!a.isSelected()&&(n?(this.instancedLineSegMaterialCopy||(this.instancedLineSegMaterialCopy=this.lineSegMaterialCopy.clone()),this.lineSegments.material=this.instancedLineSegMaterialCopy):this.lineSegments.material=this.lineSegMaterialCopy),n&&!a.isSelected()){var d=n.lineSegIds.length;if(this.supportInstancedArrays&&1<d&&!this.lineSegments.geometry.useSharedGlBuffer){if(this.lineSegments.geometry.refLineSegsSameMaterial){if(this.lineSegments.instancedCount=d,this.lineSegments.geometry.dirty||this.lineSegments.geometry.updateModelMatrix||!this.lineSegments.geometry.modelMatrixAttribute){if(!this.lineSegments.geometry.modelMatrixAttribute||this.lineSegments.geometry.updateModelMatrix){this.lineSegments.matrixWorlds=new Float32Array(16*d);for(var c=0;c<d;++c){var h=n.lineSegIds[c],u=16*c;if(this.matrixes)for(var p=0;p<16;++p)this.lineSegments.matrixWorlds[u+p]=this.matrixes[16*this.lineSegMatrixId[h]+p];else this.lineSegBodyNodes[h].worldMatrix.toArray(this.lineSegments.matrixWorlds,u)}this.lineSegments.geometry.modelMatrixAttribute?(this.lineSegments.geometry.modelMatrixAttribute.array=this.lineSegments.matrixWorlds,this.lineSegments.geometry.modelMatrixAttribute.needsUpdate=!0,this.lineSegments.geometry.needsUpdate=!0):(this.lineSegments.geometry.modelMatrixAttribute=new THREE.InstancedBufferAttribute(this.lineSegments.matrixWorlds,16),this.lineSegments.geometry.modelMatrixAttribute.onUploadCallback=function(){this.array=null},this.lineSegments.geometry.setAttribute("modelMatrixAttrib",this.lineSegments.geometry.modelMatrixAttribute)),this.lineSegments.geometry.updateModelMatrix=!1}this.lineSegments.geometry.isInstancedBufferGeometry=!0,this.lineSegments.geometry.instanceCount=this.lineSegments.instancedCount,this.lineSegments.geometry.modelMatrixAttribute.unUsed=!1,this.lineSegments.geometry.dirty=!1,null!=s.uniforms&&null!=s.uniforms.lineTypeId&&this.ndsModel.lineTypes&&(e.lineStyle=this.ndsModel.lineTypes.getLineStyleInfo(this.lineSegments.geometry,s.uniforms.lineTypeId.value,s.uniforms.lineScale.value,s.color||s.uniforms.diffuse.value,s.linewidthCopy||1,a.isSelected())),e.state=1,e.lineSegments=this.lineSegments,e.lineSegments2=this.lineSegmentToLineSegment2(this.lineSegments,this.lineSegments.geometry,s,a.isSelected())}else this.lineSegments.matrixWorlds=null,e.state=2;return e}this.lineSegments.geometry.modelMatrixAttribute&&(this.lineSegments.geometry.modelMatrixAttribute.unUsed=!0)}}if(this.lineSegments.geometry.modelMatrixAttribute&&(this.lineSegments.geometry.modelMatrixAttribute.unUsed=!0),this.lineSegments.instancedCount=0,this.lineSegments.geometry.instanceCount=0,this.matrixes)for(p=0;p<16;++p)this.lineSegments.matrixWorld.elements[p]=this.matrixes[16*this.lineSegMatrixId[i]+p];else this.lineSegments.matrixWorld.copy(a.worldMatrix);null!=s.uniforms&&null!=s.uniforms.lineTypeId&&this.ndsModel.lineTypes&&(e.lineStyle=this.ndsModel.lineTypes.getLineStyleInfo(this.lineSegments.geometry,s.uniforms.lineTypeId.value,s.uniforms.lineScale.value,s.color||s.uniforms.diffuse.value,s.linewidthCopy||1,a.isSelected()),a.isSelected()),e.state=1,e.lineSegments=this.lineSegments,e.lineSegments2=this.lineSegmentToLineSegment2(this.lineSegments,this.lineSegments.geometry,s,a.isSelected()),!0===o&&(a.hide(),De.HideLeafBody)&&!a.sketchBody&&(r=a.parent.FirstVisibleNode||0,a.parent.children[r].hide())}else e.state=0}}else e.state=-1;return e},lineSegmentToLineSegment2:function(e,t,r,i){if(!this.ndsModel.viewer.showLineWidth||!r.linewidthCopy||!this.ndsModel.viewer.is2DModel)return null;var n=null,a=null;if(this.lineSegToLineSeg2Map.has(t.uuid))n=this.lineSegToLineSeg2Map.get(t.uuid);else{n=new Xe,this.lineSegToLineSeg2Map.set(t.uuid,n);for(var o,s,l,d=[],c=[],h=0,u=new THREE.Vector3,p=new THREE.Vector3,f=t.getAttribute("position"),m=t.drawRange.start;m<t.drawRange.start+t.drawRange.count;m+=2)o=t.index.getX(m),s=t.index.getX(m+1),u.fromBufferAttribute(f,o),p.fromBufferAttribute(f,s),d.push(u.x,u.y,u.z,p.x,p.y,p.z),l&&l.equals(u)?(c.push(h),h+=u.distanceTo(p)):(c.push(0),h=u.distanceTo(p)),c.push(h),(l=l||new THREE.Vector3).copy(p);n.needsUpdate=!0,n.setPositions(d),n.setLineDistances(c)}this.lineSegToLineSeg2MatMap.has(r.uuid)?a=this.lineSegToLineSeg2Map.get(r.uuid):(a=new qe({linewidth:r.linewidthCopy,opacity:r.opacity}),null!=r.uniforms&&null!=r.uniforms.lineTypeId&&this.ndsModel.lineTypes&&(a.dashed=!0,a.lineScale=r.uniforms.lineScale.value,a.lineTypeId=r.uniforms.lineTypeId.value,a.uSampler=r.uniforms.uSampler.value,a.patternLength=r.uniforms.patternLength.value),this.lineSegToLineSeg2Map.set(r.uuid,a));var g=this.ndsModel.viewer.renderer.getPixelRatio(),v=this.ndsModel.viewer.renderer.domElement.width/g,g=this.ndsModel.viewer.renderer.domElement.height/g;return a.resolution.set(v,g),a.color.set(i?De.selectedColor:r.color||r.uniforms.diffuse.value),a.uniformsNeedUpdate=!0,this.lineSegments2.geometry=n,this.lineSegments2.material=a,this.lineSegments2},getLineSegments:function(e,t,r){e=this.getLineSegmentsWithState(e,t,r=void 0===r?!1:r);return 1===e.state?e.lineSegments:null},setNumTexts:function(e,t,r){void 0===r&&(r=!1),this.nTexts=e,this.textGeomId=new Int32Array(e),this.textMaterialId=new Int32Array(e),this.textBodyUuids=new Array(e),this.textBodyNodes=new Array(e),t&&(this.textObjectUuids=new Array(e)),r&&(this.textMatrixId=new Int32Array(e))},expandTexts:function(e,t,r){var i,n;return void 0===r&&(r=!1),0===this.nTexts?(this.setNumTexts(e,t,r),0):(i=this.nTexts,this.nTexts+=e,(n=new Array).extend(this.textGeomId),n.extend(new Array(e).fill(0)),this.textGeomId=new Int32Array(n),(n=new Array).extend(this.textMaterialId),n.extend(new Array(e).fill(0)),this.textMaterialId=new Int32Array(n),(n=new Array).extend(this.textBodyNodes),n.extend(new Array(e)),this.textBodyNodes=n,(n=new Array).extend(this.textBodyUuids),n.extend(new Array(e)),this.textBodyUuids=n,t&&((n=new Array).extend(this.textObjectUuids),n.extend(new Array(e)),this.textObjectUuids=n),r&&((t=new Array).extend(this.textMatrixId),t.extend(new Array(e)),this.textMatrixId=new Int32Array(t)),i)},setTextFromGeomUuid:function(e,t,r,i,n,a){this.textGeomUuid[e]=t,this.textBodyUuids[e]=r,this.textMaterialId[e]=i||-1,this.textObjectUuids&&(this.textObjectUuids[e]=n),this.textMatrixId&&(this.textMatrixId[e]=a)},getNumTexts:function(){return this.nTexts},__pointClipped:function(e,t){var r=!1,i=this.ndsModel.viewer.clipDataManager;if(i&&i.isSectionViewEnabled()){if(i.isPartClipEnabled()&&!i.isCurrentNodeClipped(t))return r;r=i.isPointBeoforeClipPlanes(e)}else i.isSectionBoxEnabled()&&(t=i.getClipBoxInfo())&&!t.clipbox.containsPoint(e)&&(r=!0);return r},__line3Clipped:function(e,t){var r=!1,i=this.ndsModel.viewer.clipDataManager;if(i&&i.isSectionViewEnabled()){if(i.isPartClipEnabled()&&!i.isCurrentNodeClipped(bodyNode))return r;r=i.isPointBeoforeClipPlanes(e.at(t))}else i.isSectionBoxEnabled()&&(i=i.getClipBoxInfo())&&!i.clipbox.containsPoint(e.at(t))&&(r=!0);return r},intersectPolytope:function(e,t){if(this.geomId[e]<0)return null;var r=this.geomManager.getGeomFromId(this.geomId[e]);this.mats[this.materialId[e]];if(!r||!r.loaded||r.index&&null==r.index.array)return null;var i=this.bodyNodes[e];if(i.isHidden())return null;if(this.matrixId)for(var n=0;n<16;++n)this._matrix_copy_.elements[n]=this.matrixes[16*this.matrixId[e]+n];else this._matrix_copy_.copy(i.worldMatrix);var a=this._matrix_copy_,o=this.ndsModel.getBodyTranslate(i),o=(a.elements[12]+=o[0],a.elements[13]+=o[1],a.elements[14]+=o[2],new THREE.Matrix4),s=(o.getInverse(a),new THREE.Polytope),l=(s.copy(t).applyMatrix4(o),{}),d=(l.distance=1/0,l.point=new THREE.Vector3,l.face=new THREE.Face3,l.faceIndex=-1,l.meshId=-1,l.lineSegId=-1,r.index);if(!d)return null;var c=r.attributes.position,a=(null===r.boundingBox&&r.computeBoundingBox(),s.intersectsBoxDetailed(r.boundingBox));if(2!==a)return 1===a?null:0===a?(l.meshId=e,l.bodyNode=i,l.bodyUuid=i.uuid,l.state=0,-1===l.meshId?null:l):void 0;for(var h=new THREE.Vector3,u=new THREE.Vector3,p=new THREE.Vector3,f=(new THREE.Vector3,new THREE.Face3),m=r.drawRange.start,g=r.drawRange.start+r.drawRange.count;m<g;m+=3){var v=d.getX(m),y=d.getX(m+1),A=d.getX(m+2);if(h.fromBufferAttribute(c,v),u.fromBufferAttribute(c,y),p.fromBufferAttribute(c,A),s.intersectsTriangle(p,u,h)){l.face.copy(f),l.faceIndex=m/3,l.meshId=e,l.lineSegId=-1,l.geomId=this.geomId[e],l.geomUuid=this.geomUuid[e],l.bodyNode=i,l.bodyUuid=i.uuid,l.state=2;break}}return-1===l.meshId?null:l},intersectMesh:function(e,t){if(this.geomId[e]<0)return null;var r=this.geomManager.getGeomFromId(this.geomId[e]),i=this.mats[this.materialId[e]];if(!r||!r.loaded||r.index&&null==r.index.array)return null;var n=this.bodyNodes[e];if(n.isHidden())return null;var a=this.getMeshBBox(e,it);if(!1===t.intersectsBox(a))return null;var o=n.worldMatrix,a=new THREE.Matrix4,s=(a.getInverse(o),new THREE.Ray),l=(s.copy(t).applyMatrix4(a),{}),d=(l.distance=1/0,l.point=new THREE.Vector3,l.face=new THREE.Face3,l.faceIndex=-1,l.meshId=-1,l.lineSegId=-1,r.index);if(!d)return null;var c=r.attributes.position,h=new THREE.Vector3,u=new THREE.Vector3,p=new THREE.Vector3,f=new THREE.Vector3,m=new THREE.Face3,g=new THREE.Box3;if(r.spatial_partition&&0<r.spatial_partition.length)for(var v=0,y=r.spatial_partition.length;v<y;++v){var A=r.spatial_partition[v],M=(A.visible=!0,g.min.set(A.boundingBox.min[0],A.boundingBox.min[1],A.boundingBox.min[2]),g.max.set(A.boundingBox.max[0],A.boundingBox.max[1],A.boundingBox.max[2]),A.parent);if(void 0!==M&&0<=M&&!r.spatial_partition[M].visible)A.visible=!1;else if(!1===s.intersectsBox(g))A.visible=!1;else if(A.indices)for(var E=0,w=A.indices.length;E<w;++E,0){var x=A.indices[E],b=3*x,B=1+b,I=2+b,T=d?d.array[b]:b,S=d?d.array[B]:B,R=d?d.array[I]:I;h.fromBufferAttribute(c,T),u.fromBufferAttribute(c,S),p.fromBufferAttribute(c,R);null===(i.side===THREE.BackSide?s.intersectTriangle(p,u,h,!0,f):s.intersectTriangle(h,u,p,i.side!==THREE.DoubleSide,f))||(f.applyMatrix4(o),m.a=T,m.b=S,m.c=R,m.normal=THREE.Triangle.normal(h,u,p),this.__pointClipped(f,n))||(b=t.origin.distanceTo(f))<l.distance&&(l.distance=b,l.point.copy(f),l.face.copy(m),l.faceIndex=x,l.meshId=e,l.lineSegId=-1,l.geomId=this.geomId[e],l.geomUuid=this.geomUuid[e],l.bodyNode=n,l.bodyUuid=n.uuid)}}else for(var C=r.drawRange.start,D=r.drawRange.start+r.drawRange.count;C<D;C+=3){T=d.getX(C),S=d.getX(C+1),R=d.getX(C+2),h.fromBufferAttribute(c,T),u.fromBufferAttribute(c,S),p.fromBufferAttribute(c,R);var P;null===(i.side===THREE.BackSide?s.intersectTriangle(p,u,h,!0,f):s.intersectTriangle(h,u,p,i.side!==THREE.DoubleSide,f))||(f.applyMatrix4(o),m.a=T,m.b=S,m.c=R,m.normal=THREE.Triangle.normal(h,u,p),this.__pointClipped(f,n))||(P=t.origin.distanceTo(f))<l.distance&&(l.distance=P,l.point.copy(f),l.face.copy(m),l.faceIndex=C/3,l.meshId=e,l.lineSegId=-1,l.geomId=this.geomId[e],l.geomUuid=this.geomUuid[e],l.bodyNode=n,l.bodyUuid=n.uuid)}return-1===l.meshId?null:l},intersectall:function(e,t){if(this.geomId[e]<0)return null;var r=this.geomManager.getGeomFromId(this.geomId[e]),i=this.mats[this.materialId[e]];if(!r||!r.loaded||r.index&&null==r.index.array)return null;var n=this.bodyNodes[e];if(n.isHidden())return null;if(this.matrixId)for(var a=0;a<16;++a)this._matrix_copy_.elements[a]=this.matrixes[16*this.matrixId[e]+a];else this._matrix_copy_.copy(n.worldMatrix);var o=this._matrix_copy_,s=this.ndsModel.getBodyTranslate(n),s=(o.elements[12]+=s[0],o.elements[13]+=s[1],o.elements[14]+=s[2],new THREE.Matrix4),l=(s.getInverse(o),new THREE.Ray),d=(l.copy(t).applyMatrix4(s),[]),c=r.index;if(!c)return null;for(var h=r.attributes.position,u=new THREE.Vector3,p=new THREE.Vector3,f=new THREE.Vector3,m=new THREE.Vector3,g=new THREE.Face3,v=r.drawRange.start,y=r.drawRange.start+r.drawRange.count;v<y;v+=3){var A=c.getX(v),M=c.getX(v+1),E=c.getX(v+2);u.fromBufferAttribute(h,A),p.fromBufferAttribute(h,M),f.fromBufferAttribute(h,E),null===(i.side===THREE.BackSide?l.intersectTriangle(f,p,u,!0,m):l.intersectTriangle(u,p,f,i.side!==THREE.DoubleSide,m))||(m.applyMatrix4(o),g.a=A,g.b=M,g.c=E,g.normal=THREE.Triangle.normal(u,p,f),this.__pointClipped(m,n))||(A=t.origin.distanceTo(m),(M={}).point=new THREE.Vector3,M.face=new THREE.Face3,M.distance=A,M.point.copy(m),M.face.copy(g),M.faceIndex=v/3,M.meshId=e,M.lineSegId=-1,M.geomId=this.geomId[e],M.geomUuid=this.geomUuid[e],M.bodyNode=n,M.bodyUuid=n.uuid,-1!=M.meshId&&d.push(M))}return d},intersectLineSegments2D:function(e,t,r,i,n,a){if(this.lineSegGeomId[e]<0)return null;var o=this.geomManager.getGeomFromId(this.lineSegGeomId[e]);if(0===o.drawRange.count||!o.loaded||o.index&&null==o.index.array)return null;var s=this.lineSegBodyNodes[e];if(s.isHidden())return null;var l=this.lineSegMatrixId?(new THREE.Matrix4).fromArray(this.matrixes,16*this.lineSegMatrixId[e]):s.worldMatrix,d=new THREE.Vector3,c=new THREE.Vector3,h=new THREE.Quaternion,d=(l.decompose(d,h,c),new THREE.Matrix4),u=(d.getInverse(l),new THREE.Ray);if(u.copy(t).applyMatrix4(d),o.boundingBox&&!o.boundingBox.isEmpty()||o.computeBoundingBox(),(!n||!(u.origin.x<o.boundingBox.min.x-i||u.origin.x>o.boundingBox.max.x+i||u.origin.y<o.boundingBox.min.y-i||u.origin.y>o.boundingBox.max.y+i))&&(n||!1!==u.intersectsBox(o.boundingBox))){var p=[],h=i/((c.x+c.y+c.z)/3),f=h*h,m=new THREE.Vector3,g=(new THREE.Vector3,o.index),v=o.attributes.position;if(!g)return null;for(var y=new THREE.Vector3,A=new THREE.Vector3,M=new THREE.Vector3,E=new THREE.Vector3,w=new THREE.Vector3,x=o.drawRange.start,b=o.drawRange.start+o.drawRange.count;x<b;x+=2){B=g.getX(x),I=g.getX(x+1),E.fromBufferAttribute(v,B),w.fromBufferAttribute(v,I);var B=new THREE.Line3(E.clone(),w.clone()),I=(E.z=0,w.z=0,new THREE.Plane(new THREE.Vector3(0,0,-1),0)),I=(u.intersectPlane(I,M),y.subVectors(M,E),A.subVectors(w,E),A.dot(y)/A.dot(A));if(!(I<0||1<I||isNaN(I))){var T=M.distanceToSquared(A.clone().multiplyScalar(I).add(E));if(!(f<T)){B.at(I,m);T={};if(T.point=new THREE.Vector3,T.distance=u.origin.distanceTo(m),T.point.copy(m),T.point.applyMatrix4(l),T.index=x,T.face=null,T.faceIndex=-1,T.meshId=-1,T.lineSegId=e,T.geomId=this.lineSegGeomId[e],T.geomUuid=this.lineSegGeomUuid[e],T.bodyNode=s,T.bodyUuid=s.uuid,p.push(T),a<=p.length)return p}}}return p}},intersectLineSegments:function(e,t,r,i,n){if(this.lineSegGeomId[e]<0)return null;var a=this.geomManager.getGeomFromId(this.lineSegGeomId[e]);if(0===a.drawRange.count||!a.loaded||a.index&&null==a.index.array)return null;var o=this.lineSegBodyNodes[e];if(o.isHidden())return null;var s=this.lineSegMatrixId?(new THREE.Matrix4).fromArray(this.matrixes,16*this.lineSegMatrixId[e]):o.worldMatrix,l=new THREE.Vector3,d=new THREE.Vector3,c=new THREE.Quaternion,l=(s.decompose(l,c,d),new THREE.Matrix4),h=(l.getInverse(s),new THREE.Ray);if(h.copy(t).applyMatrix4(l),a.boundingBox&&!a.boundingBox.isEmpty()||a.computeBoundingBox(),!n||!(h.origin.x<a.boundingBox.min.x-i||h.origin.x>a.boundingBox.max.x+i||h.origin.y<a.boundingBox.min.y-i||h.origin.y>a.boundingBox.max.y+i)){if(o.ndsModel.isSketchModel){c=a.boundingBox.clone();if(c.min.x-=4*i,c.min.y-=4*i,c.min.z-=4*i,c.max.x+=4*i,c.max.y+=4*i,c.max.z+=4*i,!1===h.intersectsBox(c))return}else if(!n&&!1===h.intersectsBox(a.boundingBox))return;var u={},l=(u.distance=r,u.point=new THREE.Vector3,u.face=null,u.faceIndex=-1,u.meshId=-1,u.lineSegId=-1,i/((d.x+d.y+d.z)/3)),p=l*l,f=new THREE.Vector3,m=new THREE.Vector3,g=a.index,v=a.attributes.position;if(!g)return null;for(var y=new THREE.Vector3,A=new THREE.Vector3,M=new THREE.Vector3,E=new THREE.Vector3,w=new THREE.Vector3,x=a.drawRange.start,b=a.drawRange.start+a.drawRange.count;x<b;x+=2)if(B=g.getX(x),I=g.getX(x+1),E.fromBufferAttribute(v,B),w.fromBufferAttribute(v,I),n){var B=new THREE.Line3(E.clone(),w.clone()),I=(E.z=0,w.z=0,new THREE.Plane(new THREE.Vector3(0,0,-1),0)),I=(h.intersectPlane(I,M),y.subVectors(M,E),A.subVectors(w,E),A.dot(y)/A.dot(A));if(!(I<0||1<I||isNaN(I))){var T=M.distanceToSquared(A.clone().multiplyScalar(I).add(E));if(!(p<T)){var T=this.__line3Clipped(B,I);if(!T)return B.at(I,f),u.distance=h.origin.distanceTo(f),u.point.copy(f),u.point.applyMatrix4(s),u.index=x,u.face=null,u.faceIndex=-1,u.meshId=-1,u.lineSegId=e,u.geomId=this.lineSegGeomId[e],u.geomUuid=this.lineSegGeomUuid[e],u.bodyNode=o,u.bodyUuid=o.uuid,u}}}else p<h.distanceSqToSegment(E,w,m,f)||(M=f.clone().applyMatrix4(s),this.__pointClipped(M,o))||(m.applyMatrix4(s),(T=t.origin.distanceTo(m))<u.distance&&(u.distance=T,u.point.copy(f),u.point.applyMatrix4(s),u.index=x,u.face=null,u.faceIndex=-1,u.meshId=-1,u.lineSegId=e,u.geomId=this.lineSegGeomId[e],u.geomUuid=this.lineSegGeomUuid[e],u.bodyNode=o,u.bodyUuid=o.uuid));return-1===u.lineSegId?null:u}},isMeshSelected:function(e){return this.bodyNodes[e].isSelected()},isLineSegSelected:function(e){return this.lineSegBodyNodes[e].isSelected()},isTextSelected:function(e){return this.textBodyNodes[e].isSelected()},setSelectedMaterial:function(e,t){this.selectedMaterial=e,this.selectedLineSegMaterial=t},isMeshHidden:function(e){return this.bodyNodes[e].isHidden()},isLineHidden:function(e){return this.lineSegBodyNodes[e].isHidden()},isTextHidden:function(e){return this.textBodyNodes[e].isHidden()},RemoveElement:function(e,t){for(var r=1;-1<r;)-1<(r=e.indexOf(t))&&e.splice(r,1)},getNumBodyMeshs:function(e){return e.leafBodyAttri?e.leafBodyAttri.bodyMeshIds.length:0},getBodyMesh:function(e,t){e=e.leafBodyAttri.bodyMeshIds[t];return this.getSingleMesh(e)},getBodyMeshId:function(e,t){return e.leafBodyAttri.bodyMeshIds[t]},getBodyMeshIdFromGeomUUid:function(e,t){for(var r=0,i=e.leafBodyAttri.bodyMeshIds.length;r<i;++r){var n=e.leafBodyAttri.bodyMeshIds[r];if(this.geomUuid[n]==t)return n}return-1},getNumBodyLineSegments:function(e){return e.leafBodyAttri?e.leafBodyAttri.bodyLineSegIds.length:0},getBodyLineSegments:function(e,t){e=e.leafBodyAttri.bodyLineSegIds[t];return this.getLineSegments(e)},getBodyLineSegmentsFromGeomUUid:function(e,t){for(var r,i=[],n=new Set,a=0,o=(e=De.HideLeafBody&&(r=e.parent.FirstVisibleNode||0,e.parent.children[r].uuid!=e.uuid)?e.parent.children[r]:e).leafBodyAttri.bodyLineSegIds.length;a<o;++a){var s,l=e.leafBodyAttri.bodyLineSegIds[a];this.lineSegGeomUuid[l]!=t||n.has(l)||(s=this.getLineSegments(l),n.add(l),s&&(i[i.length]=s.clone()))}return 1===i.length?i[0]:1<i.length?i:null},getBodyNode:function(e){return this.bodyNodes[e]}},Ce.RENDER_BIT={NORMAL:1,HIDDEN_LINE_VISIBLE:2,HIDDEN_LINE_REMOVE:4,WIREFRAME:8},function(e){var t=this;this.sptIndex=e,this.nodes=[],this.meshes=[],this.lines=[],this.texts=[],this.meshCount=0,this.lineCount=0,this.textCount=0,this.loaded=!1,this.sorted=!1,this.renderOnce=!1,this.geoms=[],this.requireReload=!1,this.bufferId=0,this.meshId2BodyId=new Uint16Array(500),this.materialBuffer=new Float32Array(8192),this.materialTexture=new THREE.DataTexture(this.materialBuffer,128,64,THREE.AlphaFormat,THREE.FloatType),this.visualStates={dirty:!0,visible:!0},this.copyFrom=function(e){t.nodes=e.nodes,t.loaded=e.loaded,t.sorted=e.sorted,t.renderOnce=e.renderOnce,t.geoms=e.geoms,t.requireReload=e.requireReload,t.visualStates.dirty=e.visualStates.dirty,t.visualStates.visible=e.visualStates.visible,t.bufferId=e.bufferId}}),at=(nt.prototype={constructor:nt,bindNode:function(e){if(this.nodes.push({nodeId:e.id,loaded:!1}),e.meshes){this.meshCount+=e.meshes.length;for(var t=0,r=e.meshes.length;t<r;++t){var i={nodeId:e.id,index:t};this.meshes.push(i)}}if(e.lines){this.lineCount+=e.lines.length;for(var n=0,a=e.lines.length;n<a;++n){var o={nodeId:e.id,index:n};this.lines.push(o)}}if(e.texts){this.textCount+=e.texts.length;for(var s=0,l=e.texts.length;s<l;++s){var d={nodeId:e.id,index:s};this.texts.push(d)}}},isLoaded:function(){if(this.loaded)return!0;for(var e=!0,t=0;t<this.nodes.length;++t){var r=this.nodes[t].nodeId;if(!this.nodes[t].loaded){for(var i=this.sptIndex.getNumMeshes(r),n=[],a=0;a<i;++a){var o=this.sptIndex.getMeshId(r,a),s=this.sptIndex.meshManager.geomId[o];if(!(s<0)){if(!(d=this.sptIndex.meshManager.geomManager.getGeomFromId(s))||!d.loaded){e=!1;break}1===d.refMeshes.length&&n.push(d)}}if(!e)break;this.nodes[t].loaded=!0,this.geoms=this.geoms.concat(n);for(var l=this.sptIndex.meshManager.geomManager,a=0;a<i;++a){var d,o=this.sptIndex.getMeshId(r,a);(s=this.sptIndex.meshManager.geomId[o])<0||null==(d=l.getGeomFromId(s)).index||(this.bufferId||(this.bufferId=d.id),l.loadedVertexAttributes.has(d.index.uuid)||(l.usedMemory+=d.index.array.byteLength,l.usedGpuMemory+=d.index.array.byteLength,l.loadedVertexAttributes.add(d.index.uuid)),l.loadedVertexAttributes.has(d.attributes.position.uuid))||(l.usedMemory+=(d.attributes.position.array?d.attributes.position:d.attributes.position.data).array.byteLength,l.usedGpuMemory+=(d.attributes.position.array?d.attributes.position:d.attributes.position.data).array.byteLength,l.loadedVertexAttributes.add(d.attributes.position.uuid))}}}return this.loaded=e,this.loaded},sortMeshes:function(e){for(var t=[],r=0;r<this.meshCount;++r){var i=this.meshes[r],i=this.sptIndex.getMeshId(i.nodeId,i.index),i=this.sptIndex.meshManager.materialId[i],n=this.sptIndex.meshManager.mats[i],n=n.program?n.program.id:1e4;t.push(new N(r,i,n,0))}t.sort(V);for(var a=[],o=0;o<this.meshCount;++o)a[o]=this.meshes[t[o].meshId];this.meshes=a,this.sorted=!0},isAllMeshHidden:function(){this.visualStates.visible=!0;for(var e=0;e<this.meshCount;++e){var t=this.meshes[e],t=this.sptIndex.getMeshId(t.nodeId,t.index);if(!this.sptIndex.meshManager.isMeshHidden(t))return!1}for(var r=0;r<this.lineCount;++r){var i=this.lines[r],i=this.sptIndex.getLineSegmentsId(i.nodeId,i.index);if(!this.sptIndex.meshManager.isLineHidden(i))return!1}for(var n=0;n<this.textCount;++n){var a=this.texts[n],a=this.sptIndex.getTextId(a.nodeId,a.index);if(!this.sptIndex.meshManager.isTextHidden(a))return!1}return!(this.visualStates.visible=!1)},isVisible:function(e,t){return!0},getNumMeshes:function(){return this.meshCount},getMesh:function(e){return this.sptIndex.getMesh(this.meshes[e].nodeId,this.meshes[e].index)},getMeshId:function(e){return this.sptIndex.getMeshId(this.meshes[e].nodeId,this.meshes[e].index)},includeTexts:function(){return!!this.sptIndex.texts},getNumTexts:function(){return this.sptIndex.getNumTexts(this.node)},getTextId:function(){return this.sptIndex.getTextId(this.node)},getText:function(e){return this.sptIndex.getText(this.node,e)},includeLineSegments:function(){return!!this.sptIndex.lines},getNumLineSegments:function(){return this.sptIndex.getNumLineSegments(this.node)},getLineSegmentsWithState:function(e,t,r){return this.sptIndex.getLineSegmentsWithState(this.node,e,t=void 0===t?!1:t,r=void 0===r?!1:r)},getLineSegments:function(e,t,r){e=this.sptIndex.getLineSegmentsWithState(this.node,e,t=void 0===t?!1:t,r=void 0===r?!1:r);return 1===e.state?e.lineSegments:null},intersect:function(e,t){for(var r=this.sptIndex.getNumMeshes(this.node),i=new THREE.Box3,n=0;n<r;++n){var a=this.sptIndex.getMeshId(this.node,n),o=this.sptIndex.meshManager.bodyNodes[a];this.sptIndex.meshManager.ndsModel.hasHiddenBodies&&o.isHidden()||(this.sptIndex.meshManager.getMeshBBox(a,i),e.intersectsBox(i)&&t.push(a))}}},Se.CurrentNodeId=0,function(){function e(e,t){var r=this;this.isSpatialIndex=!0,this.nodeId2NodeMap=[],this.root=new Se,e&&e.isModelBvh&&(this.meshManager=e.meshManager||t,this.buildFromModelBvh(e)),!this.meshManager&&t&&(this.meshManager=t),this.copyFrom=function(e){r.nodeId2NodeMap=e.nodeId2NodeMap,r.nodeId2MeshSetIdMap=e.nodeId2MeshSetIdMap,r.root=e.root}}var t=e.prototype;return t.mergeSubTree=function(e,t){if(!e){if(t.isModelBvh)return this.buildFromModelBvh(t);if(t.isSpatialIndex)return this.nodeId2NodeMap=t.nodeId2NodeMap,this.root=t.root,this.meshManager=t.meshManager||this.meshManager,this.root}return e.addSubTree(t)},t.buildFromModelBvh=function(e){return 0<e.nNodes&&this.initNodeByModelBvhNode(this.root,e,0),e&&0<e.leftChild.length&&-1!==e.leftChild[0]&&(this.buildSubTreeFromModelBvh(this.root,e,e.leftChild[0]),this.buildSubTreeFromModelBvh(this.root,e,e.leftChild[0]+1)),this.root},t.initNodeByModelBvhNode=function(e,t,r){if(!(t.nNodes<=r))if(e.boundingBox.min.set(t.bboxes[6*r+0],t.bboxes[6*r+1],t.bboxes[6*r+2]),e.boundingBox.max.set(t.bboxes[6*r+3],t.bboxes[6*r+4],t.bboxes[6*r+5]),4===t.version){e.meshes=new Uint32Array(t.nMeshes[r]);for(var i=0,n=e.meshes.length;i<n;++i)e.meshes[i]=t.getMeshId(r,i);var a=t.nLines[r];if(a){e.lines=new Uint32Array(a);for(var o=0;o<a;++o)e.lines[o]=t.getLineSegmentsId(r,o)}var s=t.nTexts[r];if(s){e.texts=new Uint32Array(s);for(var l=0;l<s;++l)e.texts[l]=t.getTextId(r,l)}}else if(0<t.leftChild.length&&-1!==t.leftChild[r])e.meshes=[];else{e.meshes=new Uint32Array(t.nMeshes[r]);for(var d=0,c=e.meshes.length;d<c;++d)e.meshes[d]=t.getMeshId(r,d)}},t.buildSubTreeFromModelBvh=function(e,t,r){var i=new Se;i.parent=e,this.initNodeByModelBvhNode(i,t,r),e.children.push(i),0<t.leftChild.length&&-1!==t.leftChild[r]&&(this.buildSubTreeFromModelBvh(i,t,t.leftChild[r]),this.buildSubTreeFromModelBvh(i,t,t.leftChild[r]+1))},t.buildMeshSets=function(e){void 0===e&&(e=-1);for(var t=0,r=[],i=(this.nodeId2MeshSetIdMap=[],this.nodeId2NodeMap=[],[this.root]),n=0;n!==i.length;){var a=i[n];a.id=t++;for(var o=0,s=(this.nodeId2NodeMap[a.id]=a).children.length;o<s;++o)i.push(a.children[o]);++n}for(var l=new nt(this),n=0;n<i.length;++n){var d=i[n],c=d.meshes?d.meshes.length:0,h=d.lines?d.lines.length:0,u=d.texts?d.texts.length:0;0<c?(l.meshCount+c>e&&(r.push(l),l=new nt(this)),d.meshSetId=r.length,this.nodeId2MeshSetIdMap[d.id]=d.meshSetId,l.bindNode(d)):0<h?(l.lineCount+h>e&&(r.push(l),l=new nt(this)),d.meshSetId=r.length,this.nodeId2MeshSetIdMap[d.id]=d.meshSetId,l.bindNode(d)):0<u?(l.textCount+u>e&&(r.push(l),l=new nt(this)),d.meshSetId=r.length,this.nodeId2MeshSetIdMap[d.id]=d.meshSetId,l.bindNode(d)):this.nodeId2MeshSetIdMap[d.id]=-1}return 0<l.meshCount&&r.push(l),r},t.getNode=function(e){return this.nodeId2NodeMap[e]},t.getNodeBox=function(e,t){t=t||new THREE.Box3,e=this.nodeId2NodeMap[e];return e&&t.copy(e.boundingBox),t},t.getNumMeshes=function(e){e=this.nodeId2NodeMap[e];return e&&e.meshes?e.meshes.length:0},t.getMesh=function(e,t){var e=this.nodeId2NodeMap[e];return e&&e.meshes&&t<e.meshes.length?(e=e.meshes[t],this.meshManager.getMesh(e)):null},t.getMeshId=function(e,t){e=this.nodeId2NodeMap[e];return e&&e.meshes&&t<e.meshes.length?e.meshes[t]:-1},t.getNumTexts=function(e){e=this.nodeId2NodeMap[e];return e&&e.texts?e.texts.length:-1},t.getTextId=function(e,t){e=this.nodeId2NodeMap[e];return e?e.texts[t]:-1},t.getText=function(e,t){var e=this.nodeId2NodeMap[e];return e&&e.texts&&t<e.texts.length?(e=e.texts[t],this.meshManager.getText(e)):null},t.getNumLineSegments=function(e){e=this.nodeId2NodeMap[e];return e&&e.lines?e.lines.length:-1},t.getLineSegmentsId=function(e,t){e=this.nodeId2NodeMap[e];return e&&e.lines&&t<e.lines.length?e.lines[t]:-1},t.getLineSegmentsWithState=function(e,t,r,i){var e=this.nodeId2NodeMap[e];return e&&e.lines&&t<e.lines.length?(e=e.lines[t],this.meshManager.getLineSegmentsWithState(e,r,i)):{state:-1,lineSegments:null}},t.getLineSegments=function(e,t,r,i){e=this.getLineSegmentsWithState(e,t,r,i);return 1===e.state?e.lineSegments:null},t.intersect=function(e){var t=[];if(this.meshManager.ndsModel.hasDraggedBodies()||De.MatrixChange||1e-10<Math.abs(this.meshManager.ndsModel.explodeFactor)||1e-10<Math.abs(this.meshManager.ndsModel.explodeFactorX)||1e-10<Math.abs(this.meshManager.ndsModel.explodeFactorY)||1e-10<Math.abs(this.meshManager.ndsModel.explodeFactorZ)||NDSWebViewer.SETTING.inBIMContext||"posy"!=De.modelUpDirection||De.ScenarioEditor||De.AnimationEdit)for(var r=0,i=this.nodeId2MeshSetIdMap.length;r<i;++r)0<=this.nodeId2MeshSetIdMap[r]&&(t[t.length]=this.nodeId2MeshSetIdMap[r]);else this.root.queryByRayCast(e,t);return t},e}()),ot=function(l,e,t,r,i){THREE.Geometry.call(this),this.uvs=[];var n=t.length(),a=r.length(),t=t.clone(),r=(t.normalize(),r.clone()),o=(r.normalize(),new THREE.Vector3);if(o.crossVectors(t,r),l.hasOwnProperty("geometry")){for(var s=new THREE.Box3,d=(s.setFromObject(l),new Array),c=s.min.clone(),s=(d.push(c),s.max.clone()),h=(d.push(s),new THREE.Vector3),h=(h.set(s.x,c.y,c.z),d.push(h),new THREE.Vector3),h=(h.set(s.x,s.y,c.z),d.push(h),new THREE.Vector3),h=(h.set(c.x,s.y,c.z),d.push(h),new THREE.Vector3),h=(h.set(c.x,c.y,s.z),d.push(h),new THREE.Vector3),h=(h.set(s.x,c.y,s.z),d.push(h),new THREE.Vector3),u=(h.set(c.x,s.y,s.z),d.push(h),1e8),p=-1e8,f=0;f<d.length;f++){var m=new THREE.Vector3,m=(m.subVectors(d[f],e),m.dot(o));m<u&&(u=m),p<m&&(p=m)}c=e.clone(),s=(c.addScaledVector(o,p),e.clone()),h=(s.addScaledVector(o,u),p-u),n=(null!=i&&"ProjBoth"==i&&(h*=2.1),this.dimensions=new THREE.Vector3(n,a,h),this.cube=new THREE.Mesh(new THREE.BoxGeometry(n,a,h),new THREE.MeshBasicMaterial),new THREE.Matrix4);n.makeBasis(t,r,o),null!=i&&"ProjBackward"==i?n.setPosition(s):n.setPosition(c),this.cube.applyMatrix(n),this.iCubeMatrix=(new THREE.Matrix4).getInverse(this.cube.matrix),this.faceIndices=["a","b","c","d"],this.clipFace=function(e,t){var n=.5*Math.abs(this.dimensions.clone().dot(t));function r(e,t,r){var i=e.vertex.dot(r)-n,i=i/(i-(t.vertex.dot(r)-n));return new THREE.DecalVertex(new THREE.Vector3(e.vertex.x+i*(t.vertex.x-e.vertex.x),e.vertex.y+i*(t.vertex.y-e.vertex.y),e.vertex.z+i*(t.vertex.z-e.vertex.z)),new THREE.Vector3(e.normal.x+i*(t.normal.x-e.normal.x),e.normal.y+i*(t.normal.y-e.normal.y),e.normal.z+i*(t.normal.z-e.normal.z)))}if(0===e.length)return[];for(var i=[],a=0;a<e.length;a+=3){var o,s,l,d=0<e[a+0].vertex.dot(t)-n,c=0<e[a+1].vertex.dot(t)-n,h=0<e[a+2].vertex.dot(t)-n;switch((d?1:0)+(c?1:0)+(h?1:0)){case 0:i.push(e[a]),i.push(e[a+1]),i.push(e[a+2]);break;case 1:(d&&(o=e[a+1],s=e[a+2],l=r(e[a],o,t),nV4=r(e[a],s,t)),c)?(o=e[a],s=e[a+2],l=r(e[a+1],o,t),nV4=r(e[a+1],s,t),i.push(l),i.push(s.clone()),i.push(o.clone()),i.push(s.clone()),i.push(l.clone()),i.push(nV4)):(h&&(o=e[a],s=e[a+1],l=r(e[a+2],o,t),nV4=r(e[a+2],s,t)),i.push(o.clone()),i.push(s.clone()),i.push(l),i.push(nV4),i.push(l.clone()),i.push(s.clone()));break;case 2:d||(s=r(o=e[a].clone(),e[a+1],t),l=r(o,e[a+2],t),i.push(o),i.push(s),i.push(l)),c||(s=r(o=e[a+1].clone(),e[a+2],t),l=r(o,e[a],t),i.push(o),i.push(s),i.push(l)),h||(s=r(o=e[a+2].clone(),e[a],t),l=r(o,e[a+1],t),i.push(o),i.push(s),i.push(l))}}return i},this.pushVertex=function(e,t,r){t=l.geometry.vertices[t].clone();t.applyMatrix4(l.matrixWorld),t.applyMatrix4(this.iCubeMatrix),e.push(new THREE.DecalVertex(t,r.clone()))},this.pushVertexBufferGeometry=function(e,t){var r=l.geometry.attributes.position.array,i=l.geometry.attributes.normal.array,n=new THREE.Vector3,a=new THREE.Vector3;n.fromArray(r,3*t),a.fromArray(i,3*t),n.applyMatrix4(l.matrixWorld),n.applyMatrix4(this.iCubeMatrix),e.push(new THREE.DecalVertex(n,a))},this.computeDecal=function(){var e=[];if(l.geometry instanceof THREE.Geometry)for(var t=0;t<l.geometry.faces.length;t++){var r=l.geometry.faces[t],i=[];this.pushVertex(i,r[this.faceIndices[0]],r.vertexNormals[0]),this.pushVertex(i,r[this.faceIndices[1]],r.vertexNormals[1]),this.pushVertex(i,r[this.faceIndices[2]],r.vertexNormals[2]),i=this.clipFace(i,new THREE.Vector3(1,0,0)),i=this.clipFace(i,new THREE.Vector3(-1,0,0)),i=this.clipFace(i,new THREE.Vector3(0,1,0)),i=this.clipFace(i,new THREE.Vector3(0,-1,0)),i=this.clipFace(i,new THREE.Vector3(0,0,1)),i=this.clipFace(i,new THREE.Vector3(0,0,-1));for(var n=0;n<i.length;n++){var a=i[n];this.uvs.push(new THREE.Vector2(.5+a.vertex.x/this.dimensions.x,.5+a.vertex.y/this.dimensions.y)),i[n].vertex.applyMatrix4(this.cube.matrix)}0!==i.length&&(e=e.concat(i))}else if(l.geometry instanceof THREE.BufferGeometry)for(var o=l.geometry.index.array,t=0;t<o.length/3;t++){i=[];this.pushVertexBufferGeometry(i,o[3*t]),this.pushVertexBufferGeometry(i,o[3*t+1]),this.pushVertexBufferGeometry(i,o[3*t+2]),i=this.clipFace(i,new THREE.Vector3(1,0,0)),i=this.clipFace(i,new THREE.Vector3(-1,0,0)),i=this.clipFace(i,new THREE.Vector3(0,1,0)),i=this.clipFace(i,new THREE.Vector3(0,-1,0)),i=this.clipFace(i,new THREE.Vector3(0,0,1)),i=this.clipFace(i,new THREE.Vector3(0,0,-1));for(n=0;n<i.length;n++){a=i[n];this.uvs.push(new THREE.Vector2(.5+a.vertex.x/this.dimensions.x,.5+a.vertex.y/this.dimensions.y)),i[n].vertex.applyMatrix4(this.cube.matrix)}0!==i.length&&(e=e.concat(i))}for(var s=0;s<e.length;s+=3)this.vertices.push(e[s].vertex,e[s+1].vertex,e[s+2].vertex),(r=new THREE.Face3(s,s+1,s+2)).vertexNormals.push(e[s+0].normal),r.vertexNormals.push(e[s+1].normal),r.vertexNormals.push(e[s+2].normal),this.faces.push(r),this.faceVertexUvs[0].push([this.uvs[s],this.uvs[s+1],this.uvs[s+2]]);this.verticesNeedUpdate=!0,this.elementsNeedUpdate=!0,this.morphTargetsNeedUpdate=!0,this.uvsNeedUpdate=!0,this.normalsNeedUpdate=!0,this.colorsNeedUpdate=!0,this.computeFaceNormals()},this.computeDecal()}},yt=(ot.prototype=Object.create(THREE.Geometry.prototype),ot.prototype.constructor=ot,{}),y=(yt.CompressionMethod={RAW:5718354,MG1:3229517,MG2:3295053},yt.Flags={NORMALS:1},yt.File=function(e){this.load(e)},yt.File.prototype.load=function(e){this.header=new yt.FileHeader(e),this.body=new yt.FileBody(this.header),this.getReader().read(e,this.body)},yt.File.prototype.getReader=function(){var e;switch(this.header.compressionMethod){case yt.CompressionMethod.RAW:e=new yt.ReaderRAW;break;case yt.CompressionMethod.MG1:e=new yt.ReaderMG1;break;case yt.CompressionMethod.MG2:e=new yt.ReaderMG2}return e},yt.FileHeader=function(e){e.readInt32(),this.fileFormat=e.readInt32(),this.compressionMethod=e.readInt32(),this.vertexCount=e.readInt32(),this.triangleCount=e.readInt32(),this.uvMapCount=e.readInt32(),this.attrMapCount=e.readInt32(),this.flags=e.readInt32(),this.comment=e.readString()},yt.FileHeader.prototype.hasNormals=function(){return this.flags&yt.Flags.NORMALS},yt.FileBody=function(e){var t=3*e.triangleCount,r=3*e.vertexCount,i=e.hasNormals()?3*e.vertexCount:0,n=2*e.vertexCount,a=4*e.vertexCount,o=0,s=new ArrayBuffer(4*(t+r+i+n*e.uvMapCount+a*e.attrMapCount));if(this.indices=new Uint32Array(s,0,t),this.vertices=new Float32Array(s,4*t,r),e.hasNormals()&&(this.normals=new Float32Array(s,4*(t+r),i)),e.uvMapCount)for(this.uvMaps=[],o=0;o<e.uvMapCount;++o)this.uvMaps[o]={uv:new Float32Array(s,4*(t+r+i+o*n),n)};if(e.attrMapCount)for(this.attrMaps=[],o=0;o<e.attrMapCount;++o)this.attrMaps[o]={attr:new Float32Array(s,4*(t+r+i+n*e.uvMapCount+o*a),a)}},yt.FileMG2Header=function(e){e.readInt32(),this.vertexPrecision=e.readFloat32(),this.normalPrecision=e.readFloat32(),this.lowerBoundx=e.readFloat32(),this.lowerBoundy=e.readFloat32(),this.lowerBoundz=e.readFloat32(),this.higherBoundx=e.readFloat32(),this.higherBoundy=e.readFloat32(),this.higherBoundz=e.readFloat32(),this.divx=e.readInt32(),this.divy=e.readInt32(),this.divz=e.readInt32(),this.sizex=(this.higherBoundx-this.lowerBoundx)/this.divx,this.sizey=(this.higherBoundy-this.lowerBoundy)/this.divy,this.sizez=(this.higherBoundz-this.lowerBoundz)/this.divz},yt.ReaderRAW=function(){},yt.ReaderRAW.prototype.read=function(e,t){this.readIndices(e,t.indices),this.readVertices(e,t.vertices),t.normals&&this.readNormals(e,t.normals),t.uvMaps&&this.readUVMaps(e,t.uvMaps),t.attrMaps&&this.readAttrMaps(e,t.attrMaps)},yt.ReaderRAW.prototype.readIndices=function(e,t){e.readInt32(),e.readArrayInt32(t)},yt.ReaderRAW.prototype.readVertices=function(e,t){e.readInt32(),e.readArrayFloat32(t)},yt.ReaderRAW.prototype.readNormals=function(e,t){e.readInt32(),e.readArrayFloat32(t)},yt.ReaderRAW.prototype.readUVMaps=function(e,t){for(var r=0;r<t.length;++r)e.readInt32(),t[r].name=e.readString(),t[r].filename=e.readString(),e.readArrayFloat32(t[r].uv)},yt.ReaderRAW.prototype.readAttrMaps=function(e,t){for(var r=0;r<t.length;++r)e.readInt32(),t[r].name=e.readString(),e.readArrayFloat32(t[r].attr)},yt.ReaderMG1=function(){},yt.ReaderMG1.prototype.read=function(e,t){this.readIndices(e,t.indices),this.readVertices(e,t.vertices),t.normals&&this.readNormals(e,t.normals),t.uvMaps&&this.readUVMaps(e,t.uvMaps),t.attrMaps&&this.readAttrMaps(e,t.attrMaps)},yt.ReaderMG1.prototype.readIndices=function(e,t){e.readInt32(),e.readInt32();var r=new yt.InterleavedStream(t,3);LZMA.decompress(e,e,r,r.data.length),yt.restoreIndices(t,t.length)},yt.ReaderMG1.prototype.readVertices=function(e,t){e.readInt32(),e.readInt32();t=new yt.InterleavedStream(t,1);LZMA.decompress(e,e,t,t.data.length)},yt.ReaderMG1.prototype.readNormals=function(e,t){e.readInt32(),e.readInt32();t=new yt.InterleavedStream(t,3);LZMA.decompress(e,e,t,t.data.length)},yt.ReaderMG1.prototype.readUVMaps=function(e,t){for(var r=0;r<t.length;++r){e.readInt32(),t[r].name=e.readString(),t[r].filename=e.readString(),e.readInt32();var i=new yt.InterleavedStream(t[r].uv,2);LZMA.decompress(e,e,i,i.data.length)}},yt.ReaderMG1.prototype.readAttrMaps=function(e,t){for(var r=0;r<t.length;++r){e.readInt32(),t[r].name=e.readString(),e.readInt32();var i=new yt.InterleavedStream(t[r].attr,4);LZMA.decompress(e,e,i,i.data.length)}},yt.ReaderMG2=function(){},yt.ReaderMG2.prototype.read=function(e,t){this.MG2Header=new yt.FileMG2Header(e),this.readVertices(e,t.vertices),this.readIndices(e,t.indices),t.normals&&this.readNormals(e,t),t.uvMaps&&this.readUVMaps(e,t.uvMaps),t.attrMaps&&this.readAttrMaps(e,t.attrMaps)},yt.ReaderMG2.prototype.readVertices=function(e,t){e.readInt32(),e.readInt32();var r=new yt.InterleavedStream(t,3),r=(LZMA.decompress(e,e,r,r.data.length),this.readGridIndices(e,t));yt.restoreVertices(t,this.MG2Header,r,this.MG2Header.vertexPrecision)},yt.ReaderMG2.prototype.readGridIndices=function(e,t){e.readInt32(),e.readInt32();var t=new Uint32Array(t.length/3),r=new yt.InterleavedStream(t,1);return LZMA.decompress(e,e,r,r.data.length),yt.restoreGridIndices(t,t.length),t},yt.ReaderMG2.prototype.readIndices=function(e,t){e.readInt32(),e.readInt32();var r=new yt.InterleavedStream(t,3);LZMA.decompress(e,e,r,r.data.length),yt.restoreIndices(t,t.length)},yt.ReaderMG2.prototype.readNormals=function(e,t){e.readInt32(),e.readInt32();var r=new yt.InterleavedStream(t.normals,3),e=(LZMA.decompress(e,e,r,r.data.length),yt.calcSmoothNormals(t.indices,t.vertices));yt.restoreNormals(t.normals,e,this.MG2Header.normalPrecision)},yt.ReaderMG2.prototype.readUVMaps=function(e,t){for(var r=0;r<t.length;++r){e.readInt32(),t[r].name=e.readString(),t[r].filename=e.readString();var i=e.readFloat32(),n=(e.readInt32(),new yt.InterleavedStream(t[r].uv,2));LZMA.decompress(e,e,n,n.data.length),yt.restoreMap(t[r].uv,2,i)}},yt.ReaderMG2.prototype.readAttrMaps=function(e,t){for(var r=0;r<t.length;++r){e.readInt32(),t[r].name=e.readString();var i=e.readFloat32(),n=(e.readInt32(),new yt.InterleavedStream(t[r].attr,4));LZMA.decompress(e,e,n,n.data.length),yt.restoreMap(t[r].attr,4,i)}},yt.restoreIndices=function(e,t){var r=3;for(0<t&&(e[2]+=e[0],e[1]+=e[0]);r<t;r+=3)e[r]+=e[r-3],e[r]===e[r-3]?e[r+1]+=e[r-2]:e[r+1]+=e[r],e[r+2]+=e[r]},yt.restoreIndices2=function(e,t,r){var i=3;for(0<r&&(e[t+2]+=e[t+0],e[t+1]+=e[t+0]);i<r;i+=3)e[t+i]+=e[t+i-3],e[t+i]===e[t+i-3]?e[t+i+1]+=e[t+i-2]:e[t+i+1]+=e[t+i],e[t+i+2]+=e[t+i]},yt.restoreGridIndices=function(e,t){for(var r=1;r<t;++r)e[r]+=e[r-1]},yt.restoreVertices=function(e,t,r,i){for(var n,a,o,s,l,d=new Uint32Array(e.buffer,e.byteOffset,e.length),c=t.divx,h=c*t.divy,u=2147483647,p=0,f=0,m=0,g=r.length;f<g;m+=3)o=n=r[f++],o=(o-=~~((l=~~(o/h))*h))-~~((s=~~(o/c))*c),a=d[m],n===u&&(a+=p),e[m]=t.lowerBoundx+o*t.sizex+i*a,e[m+1]=t.lowerBoundy+s*t.sizey+i*d[m+1],e[m+2]=t.lowerBoundz+l*t.sizez+i*d[m+2],u=n,p=a},yt.restoreNormals=function(e,t,r){for(var i,n,a,o,s,l,d=new Uint32Array(e.buffer,e.byteOffset,e.length),c=0,h=e.length,u=1.5707963267948966;c<h;c+=3)s=d[c]*r,0===(o=d[c+1])?(e[c]=t[c]*s,e[c+1]=t[c+1]*s,e[c+2]=t[c+2]*s):(a=o<=4?(d[c+2]-2)*u:(4*d[c+2]/o-2)*u,o*=r*u,i=(n=s*Math.sin(o))*Math.cos(a),n=n*Math.sin(a),a=s*Math.cos(o),s=t[c+1],o=t[c]-t[c+2],1e-20<(l=Math.sqrt(2*s*s+o*o))&&(o/=l,s/=l),e[c]=t[c]*a+(t[c+1]*s-t[c+2]*o)*n-s*i,e[c+1]=t[c+1]*a-(t[c+2]+t[c])*s*n+o*i,e[c+2]=t[c+2]*a+(t[c]*o+t[c+1]*s)*n+s*i)},yt.restoreMap=function(e,t,r){for(var i,n,a,o=new Uint32Array(e.buffer,e.byteOffset,e.length),s=0,l=e.length;s<t;++s)for(i=0,a=s;a<l;a+=t)i+=1&(n=o[a])?-(n+1>>1):n>>1,e[a]=i*r},yt.calcSmoothNormals=function(e,t){for(var r,i,n,a,o,s,l,d,c,h,u,p=new Float32Array(t.length),f=0,m=e.length;f<m;)r=3*e[f++],i=3*e[f++],n=3*e[f++],o=t[i]-t[r],d=t[n]-t[r],s=t[1+i]-t[1+r],c=t[1+n]-t[1+r],l=t[2+i]-t[2+r],a=s*(h=t[2+n]-t[2+r])-l*c,l=l*d-o*h,h=o*c-s*d,1e-10<(u=Math.sqrt(a*a+l*l+h*h))&&(a/=u,l/=u,h/=u),p[r]+=a,p[1+r]+=l,p[2+r]+=h,p[i]+=a,p[1+i]+=l,p[2+i]+=h,p[n]+=a,p[1+n]+=l,p[2+n]+=h;for(f=0,m=p.length;f<m;f+=3)1e-10<(u=Math.sqrt(p[f]*p[f]+p[f+1]*p[f+1]+p[f+2]*p[f+2]))&&(p[f]/=u,p[f+1]/=u,p[f+2]/=u);return p},yt.isLittleEndian=(e=new ArrayBuffer(2),ia=new Uint8Array(e),e=new Uint16Array(e),(ia[0]=1)===e[0]),yt.InterleavedStream=function(e,t){this.data=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),this.offset=yt.isLittleEndian?3:0,this.count=4*t,this.len=this.data.length},yt.InterleavedStream.prototype.writeByte=function(e){this.data[this.offset]=e,this.offset+=this.count,this.offset>=this.len&&(this.offset-=this.len-4,this.offset>=this.count)&&(this.offset-=this.count+(yt.isLittleEndian?1:-1))},yt.BIMStream=function(e,t,r){this.data=e,this.offset=t,this.count=r,this.len=this.data.length},yt.BIMStream.prototype.writeByte=function(e){this.data[this.offset]=e,this.offset+=this.count,this.offset>=this.len&&(this.offset=0)},yt.Stream=function(e){this.data=e,this.dataView=new DataView(e.buffer),this.offset=0},yt.Stream.prototype.TWO_POW_MINUS23=Math.pow(2,-23),yt.Stream.prototype.TWO_POW_MINUS126=Math.pow(2,-126),yt.Stream.prototype.seek=function(e){this.offset=e},yt.Stream.prototype.readByte=function(){return 255&this.data[this.offset++]},yt.Stream.prototype.skipByte=function(){this.offset++},yt.Stream.prototype.readInt8=function(){return this.dataView.getInt8(this.offset++,!0)},yt.Stream.prototype.skipInt8=function(){this.offset++},yt.Stream.prototype.readUInt8=function(){return this.dataView.getUint8(this.offset++,!0)},yt.Stream.prototype.skipUInt8=function(){this.offset++},yt.Stream.prototype.readInt32=function(){var e=this.dataView.getInt32(this.offset,!0);return this.offset+=4,e},yt.Stream.prototype.skipInt32=function(){this.offset+=4},yt.Stream.prototype.readUInt32=function(){var e=this.dataView.getUint32(this.offset,!0);return this.offset+=4,e},yt.Stream.prototype.skipUInt32=function(){this.offset+=4},yt.Stream.prototype.readInt64=function(){var e=this.dataView.getUint32(this.offset,!0),t=(this.offset+=4,this.dataView.getUint32(this.offset,!0)),t=(this.offset+=4,BigInt(t)<<BigInt(32)|BigInt(e));return Number(t.valueOf())},yt.Stream.prototype.skipInt64=function(){this.offset+=8},yt.Stream.prototype.readInt16=function(){var e=this.dataView.getInt16(this.offset,!0);return this.offset+=2,e},yt.Stream.prototype.skipInt16=function(){this.offset+=2},yt.Stream.prototype.readUInt16=function(){var e=this.dataView.getUint16(this.offset,!0);return this.offset+=2,e},yt.Stream.prototype.skipUInt16=function(){this.offset+=2},yt.Stream.prototype.readFloat32=function(){var e=this.dataView.getFloat32(this.offset,!0);return this.offset+=4,e},yt.Stream.prototype.skipFloat32=function(){this.offset+=4},yt.Stream.prototype.readFloat64=function(){var e=this.dataView.getFloat64(this.offset,!0);return this.offset+=8,e},yt.Stream.prototype.skipFloat64=function(){this.offset+=8},yt.Stream.prototype.readString=function(){var e=this.readInt32();return this.offset+=e,String.fromCharCode.apply(null,this.data.subarray(this.offset-e,this.offset))},yt.Stream.prototype.skipString=function(){var e=this.readInt32();this.offset+=e},yt.Stream.prototype.readIDType=function(e,t){var r=null;if(1===e)r=this.readInt32();else if(0===e){for(var i="",n=0===t?stream.readInt32():t,a=0;a<n;++a)i+=String.fromCharCode(this.readByte());r=i}return r},yt.Stream.prototype.readTexture=function(){for(var e=this.readByte(),t=[],r=0;r<8;r++){var i=4*r;e&Math.pow(2,r)?(t[i]=0,t[1+i]=0,t[2+i]=0,t[3+i]=255):(t[i]=255,t[1+i]=255,t[2+i]=255,t[3+i]=0)}return t},yt.Stream.prototype.readGuid=function(){for(var e,t="";t+=e=String.fromCharCode(this.readByte()),0!==e.charCodeAt(0););return 0==De.ScenarioEditorid?t.substring(0,t.length-1):Pe.addSceneID(t.substring(0,t.length-1))},yt.Stream.prototype.readArrayUint8=function(e){for(var t=0,r=e.length;t<r;++t)e[t]=this.data[this.offset++];return e},yt.Stream.prototype.skipArrayUint8=function(e){this.offset+=e},yt.Stream.prototype.readArrayInt32=function(e){for(var t=0,r=e.length;t<r;)e[t++]=this.readInt32();return e},yt.Stream.prototype.skipArrayInt32=function(e){for(;0<e--;)this.skipInt32()},yt.Stream.prototype.readArrayUInt32=function(e){for(var t=0,r=e.length;t<r;)e[t++]=this.readUInt32();return e},yt.Stream.prototype.skipArrayUInt32=function(e){for(;0<e--;)this.skipUInt32()},yt.Stream.prototype.readArrayInt16=function(e){for(var t=0,r=e.length;t<r;)e[t++]=this.readInt16();return e},yt.Stream.prototype.skipArrayInt16=function(e){for(;0<e--;)this.skipInt16()},yt.Stream.prototype.readArrayFloat32=function(e){for(var t=0,r=e.length;t<r;)e[t++]=this.readFloat32();return e},yt.Stream.prototype.skipArrayFloat32=function(e){for(;0<e--;)this.skipFloat32()},{}),lt=(y.OutWindow=function(){this._windowSize=0},y.OutWindow.prototype.create=function(e){this._buffer&&this._windowSize===e||(this._buffer=[]),this._windowSize=e,this._pos=0,this._streamPos=0},y.OutWindow.prototype.flush=function(){var e=this._pos-this._streamPos;if(0!==e){for(;e--;)this._stream.writeByte(this._buffer[this._streamPos++]);this._pos>=this._windowSize&&(this._pos=0),this._streamPos=this._pos}},y.OutWindow.prototype.releaseStream=function(){this.flush(),this._stream=null},y.OutWindow.prototype.setStream=function(e){this.releaseStream(),this._stream=e},y.OutWindow.prototype.init=function(e){e||(this._streamPos=0,this._pos=0)},y.OutWindow.prototype.copyBlock=function(e,t){var r=this._pos-e-1;for(r<0&&(r+=this._windowSize);t--;)r>=this._windowSize&&(r=0),this._buffer[this._pos++]=this._buffer[r++],this._pos>=this._windowSize&&this.flush()},y.OutWindow.prototype.putByte=function(e){this._buffer[this._pos++]=e,this._pos>=this._windowSize&&this.flush()},y.OutWindow.prototype.getByte=function(e){e=this._pos-e-1;return e<0&&(e+=this._windowSize),this._buffer[e]},y.RangeDecoder=function(){},y.RangeDecoder.prototype.setStream=function(e){this._stream=e},y.RangeDecoder.prototype.releaseStream=function(){this._stream=null},y.RangeDecoder.prototype.init=function(){var e=5;for(this._code=0,this._range=-1;e--;)this._code=this._code<<8|this._stream.readByte()},y.RangeDecoder.prototype.decodeDirectBits=function(e){for(var t,r=0,i=e;i--;)this._range>>>=1,t=this._code-this._range>>>31,this._code-=this._range&t-1,r=r<<1|1-t,0==(4278190080&this._range)&&(this._code=this._code<<8|this._stream.readByte(),this._range<<=8);return r},y.RangeDecoder.prototype.decodeBit=function(e,t){var r=e[t],i=(this._range>>>11)*r;return(2147483648^this._code)<(2147483648^i)?(this._range=i,e[t]+=2048-r>>>5,0==(4278190080&this._range)&&(this._code=this._code<<8|this._stream.readByte(),this._range<<=8),0):(this._range-=i,this._code-=i,e[t]-=r>>>5,0==(4278190080&this._range)&&(this._code=this._code<<8|this._stream.readByte(),this._range<<=8),1)},y.initBitModels=function(e,t){for(;t--;)e[t]=1024},y.BitTreeDecoder=function(e){this._models=[],this._numBitLevels=e},y.BitTreeDecoder.prototype.init=function(){y.initBitModels(this._models,1<<this._numBitLevels)},y.BitTreeDecoder.prototype.decode=function(e){for(var t=1,r=this._numBitLevels;r--;)t=t<<1|e.decodeBit(this._models,t);return t-(1<<this._numBitLevels)},y.BitTreeDecoder.prototype.reverseDecode=function(e){for(var t,r=1,i=0,n=0;n<this._numBitLevels;++n)r=r<<1|(t=e.decodeBit(this._models,r)),i|=t<<n;return i},y.reverseDecode2=function(e,t,r,i){for(var n,a=1,o=0,s=0;s<i;++s)a=a<<1|(n=r.decodeBit(e,t+a)),o|=n<<s;return o},y.LenDecoder=function(){this._choice=[],this._lowCoder=[],this._midCoder=[],this._highCoder=new y.BitTreeDecoder(8),this._numPosStates=0},y.LenDecoder.prototype.create=function(e){for(;this._numPosStates<e;++this._numPosStates)this._lowCoder[this._numPosStates]=new y.BitTreeDecoder(3),this._midCoder[this._numPosStates]=new y.BitTreeDecoder(3)},y.LenDecoder.prototype.init=function(){var e=this._numPosStates;for(y.initBitModels(this._choice,2);e--;)this._lowCoder[e].init(),this._midCoder[e].init();this._highCoder.init()},y.LenDecoder.prototype.decode=function(e,t){return 0===e.decodeBit(this._choice,0)?this._lowCoder[t].decode(e):0===e.decodeBit(this._choice,1)?8+this._midCoder[t].decode(e):16+this._highCoder.decode(e)},y.Decoder2=function(){this._decoders=[]},y.Decoder2.prototype.init=function(){y.initBitModels(this._decoders,768)},y.Decoder2.prototype.decodeNormal=function(e){for(var t=1;(t=t<<1|e.decodeBit(this._decoders,t))<256;);return 255&t},y.Decoder2.prototype.decodeWithMatchByte=function(e,t){var r,i,n=1;do{if(r=t>>7&1,t<<=1,n=n<<1|(i=e.decodeBit(this._decoders,(1+r<<8)+n)),r!==i){for(;n<256;)n=n<<1|e.decodeBit(this._decoders,n);break}}while(n<256);return 255&n},y.LiteralDecoder=function(){},y.LiteralDecoder.prototype.create=function(e,t){var r;if(!this._coders||this._numPrevBits!==t||this._numPosBits!==e)for(this._numPosBits=e,this._posMask=(1<<e)-1,this._numPrevBits=t,this._coders=[],r=1<<this._numPrevBits+this._numPosBits;r--;)this._coders[r]=new y.Decoder2},y.LiteralDecoder.prototype.init=function(){for(var e=1<<this._numPrevBits+this._numPosBits;e--;)this._coders[e].init()},y.LiteralDecoder.prototype.getDecoder=function(e,t){return this._coders[((e&this._posMask)<<this._numPrevBits)+((255&t)>>>8-this._numPrevBits)]},y.Decoder=function(){this._outWindow=new y.OutWindow,this._rangeDecoder=new y.RangeDecoder,this._isMatchDecoders=[],this._isRepDecoders=[],this._isRepG0Decoders=[],this._isRepG1Decoders=[],this._isRepG2Decoders=[],this._isRep0LongDecoders=[],this._posSlotDecoder=[],this._posDecoders=[],this._posAlignDecoder=new y.BitTreeDecoder(4),this._lenDecoder=new y.LenDecoder,this._repLenDecoder=new y.LenDecoder,this._literalDecoder=new y.LiteralDecoder,this._dictionarySize=-1,this._dictionarySizeCheck=-1,this._posSlotDecoder[0]=new y.BitTreeDecoder(6),this._posSlotDecoder[1]=new y.BitTreeDecoder(6),this._posSlotDecoder[2]=new y.BitTreeDecoder(6),this._posSlotDecoder[3]=new y.BitTreeDecoder(6)},y.Decoder.prototype.setDictionarySize=function(e){return!(e<0||(this._dictionarySize!==e&&(this._dictionarySize=e,this._dictionarySizeCheck=Math.max(this._dictionarySize,1),this._outWindow.create(Math.max(this._dictionarySizeCheck,4096))),0))},y.Decoder.prototype.setLcLpPb=function(e,t,r){var i=1<<r;return!(8<e||4<t||4<r||(this._literalDecoder.create(t,e),this._lenDecoder.create(i),this._repLenDecoder.create(i),this._posStateMask=i-1,0))},y.Decoder.prototype.init=function(){var e=4;for(this._outWindow.init(!1),y.initBitModels(this._isMatchDecoders,192),y.initBitModels(this._isRep0LongDecoders,192),y.initBitModels(this._isRepDecoders,12),y.initBitModels(this._isRepG0Decoders,12),y.initBitModels(this._isRepG1Decoders,12),y.initBitModels(this._isRepG2Decoders,12),y.initBitModels(this._posDecoders,114),this._literalDecoder.init();e--;)this._posSlotDecoder[e].init();this._lenDecoder.init(),this._repLenDecoder.init(),this._posAlignDecoder.init(),this._rangeDecoder.init()},y.Decoder.prototype.decode=function(e,t,r){var i,n,a,o,s=0,l=0,d=0,c=0,h=0,u=0,p=0;for(this._rangeDecoder.setStream(e),this._outWindow.setStream(t),this.init();r<0||u<r;)if(o=u&this._posStateMask,0===this._rangeDecoder.decodeBit(this._isMatchDecoders,(s<<4)+o))a=this._literalDecoder.getDecoder(u++,p),p=7<=s?a.decodeWithMatchByte(this._rangeDecoder,this._outWindow.getByte(l)):a.decodeNormal(this._rangeDecoder),this._outWindow.putByte(p),s=s<4?0:s-(s<10?3:6);else{if(1===this._rangeDecoder.decodeBit(this._isRepDecoders,s))(i=0)===this._rangeDecoder.decodeBit(this._isRepG0Decoders,s)?0===this._rangeDecoder.decodeBit(this._isRep0LongDecoders,(s<<4)+o)&&(s=s<7?9:11,i=1):(0===this._rangeDecoder.decodeBit(this._isRepG1Decoders,s)?n=d:(0===this._rangeDecoder.decodeBit(this._isRepG2Decoders,s)?n=c:(n=h,h=c),c=d),d=l,l=n),0===i&&(i=2+this._repLenDecoder.decode(this._rangeDecoder,o),s=s<7?8:11);else if(h=c,c=d,d=l,i=2+this._lenDecoder.decode(this._rangeDecoder,o),s=s<7?7:10,4<=(a=this._posSlotDecoder[i<=5?i-2:3].decode(this._rangeDecoder))){if(l=(2|1&a)<<(o=(a>>1)-1),a<14)l+=y.reverseDecode2(this._posDecoders,l-a-1,this._rangeDecoder,o);else if((l=(l+=this._rangeDecoder.decodeDirectBits(o-4)<<4)+this._posAlignDecoder.reverseDecode(this._rangeDecoder))<0){if(-1===l)break;return!1}}else l=a;if(u<=l||l>=this._dictionarySizeCheck)return!1;this._outWindow.copyBlock(l,i),u+=i,p=this._outWindow.getByte(0)}return this._outWindow.flush(),this._outWindow.releaseStream(),this._rangeDecoder.releaseStream(),!0},y.Decoder.prototype.setDecoderProperties=function(e){var t;return!(e.size<5||(t=e.readByte(),!this.setLcLpPb(t%9,(t=~~(t/9))%5,~~(t/5))))&&(t=e.readByte(),t=(t=(t|=e.readByte()<<8)|e.readByte()<<16)+16777216*e.readByte(),this.setDictionarySize(t))},y.decompress=function(e,t,r,i){var n=new y.Decoder;if(!n.setDecoderProperties(e))throw"Incorrect stream properties";if(n.decode(t,r,i))return!0;throw"Error in data stream"},ia=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]),tt=new Uint8Array([32,0,65,2,1,106,34,33,3,128,11,4,13,64,6,253,10,7,15,116,127,5,8,12,40,16,19,54,20,9,27,255,113,17,42,67,24,23,146,148,18,14,22,45,70,69,56,114,101,21,25,63,75,136,108,28,118,29,73,115]),"object"!=typeof WebAssembly?{supported:!1}:(e="B9h79tEBBBE8fV9gBB9gVUUUUUEU9gIUUUB9gEUEU9gIUUUEUIKQBEEEDDDILLVIEBEOWEUEC+Q/IEKR/LEdO9tw9t9vv95DBh9f9f939h79t9f9j9h229f9jT9vv7BB8a9tw79o9v9wT9f9kw9j9v9kw9WwvTw949C919m9mwvBEy9tw79o9v9wT9f9kw9j9v9kw69u9kw949C919m9mwvBDe9tw79o9v9wT9f9kw9j9v9kw69u9kw949Twg91w9u9jwBIl9tw79o9v9wT9f9kw9j9v9kws9p2Twv9P9jTBLk9tw79o9v9wT9f9kw9j9v9kws9p2Twv9R919hTBVl9tw79o9v9wT9f9kw9j9v9kws9p2Twvt949wBOL79iv9rBRQ+f8yQDBK/tSEhU8jJJJJBCJ/EB9rGV8kJJJJBC9+HODNADCEFAL0MBCUHOAIrBBC+gE9HMBAVAIALFGRAD9rADZ1JJJBHWCJ/ABAD9uC/wfBgGOCJDAOCJD6eHdAICEFHQDNDNADtMBCBHKINAKAE9PMDAdAEAK9rAKAdFAE6eGXCSFGOCL4CIFCD4HMDNDNDNDNAOC9wgGptMBCBHSCEHZAWCJDFHhAQHoINARAo9rAM6MLAoAMFHQCBHICBHLINARAQ9rCk6MIAWCJ/CBFALFHODNDNDNDNDNAoALCO4FrBBAICOg4CIgpLBEDIBKAO9CB83IBAOCWF9CB83IBXIKAOAQrBLAQrBBGaCO4GcAcCIsGce86BBAOCEFAQCLFAcFGcrBBAaCL4CIgGxAxCIsGxe86BBAOCDFAcAxFGcrBBAaCD4CIgGxAxCIsGxe86BBAOCIFAcAxFGcrBBAaCIgGaAaCIsGae86BBAOCLFAcAaFGcrBBAQrBEGaCO4GxAxCIsGxe86BBAOCVFAcAxFGcrBBAaCL4CIgGxAxCIsGxe86BBAOCOFAcAxFGcrBBAaCD4CIgGxAxCIsGxe86BBAOCRFAcAxFGcrBBAaCIgGaAaCIsGae86BBAOCWFAcAaFGcrBBAQrBDGaCO4GxAxCIsGxe86BBAOCdFAcAxFGcrBBAaCL4CIgGxAxCIsGxe86BBAOCQFAcAxFGcrBBAaCD4CIgGxAxCIsGxe86BBAOCKFAcAxFGcrBBAaCIgGaAaCIsGae86BBAOCXFAcAaFGarBBAQrBIGQCO4GcAcCIsGce86BBAOCMFAaAcFGarBBAQCL4CIgGcAcCIsGce86BBAOCpFAaAcFGarBBAQCD4CIgGcAcCIsGce86BBAOCSFAaAcFGOrBBAQCIgGQAQCIsGQe86BBAOAQFHQXDKAOAQrBWAQrBBGaCL4GcAcCSsGce86BBAOCEFAQCWFAcFGcrBBAaCSgGaAaCSsGae86BBAOCDFAcAaFGarBBAQrBEGcCL4GxAxCSsGxe86BBAOCIFAaAxFGarBBAcCSgGcAcCSsGce86BBAOCLFAaAcFGarBBAQrBDGcCL4GxAxCSsGxe86BBAOCVFAaAxFGarBBAcCSgGcAcCSsGce86BBAOCOFAaAcFGarBBAQrBIGcCL4GxAxCSsGxe86BBAOCRFAaAxFGarBBAcCSgGcAcCSsGce86BBAOCWFAaAcFGarBBAQrBLGcCL4GxAxCSsGxe86BBAOCdFAaAxFGarBBAcCSgGcAcCSsGce86BBAOCQFAaAcFGarBBAQrBVGcCL4GxAxCSsGxe86BBAOCKFAaAxFGarBBAcCSgGcAcCSsGce86BBAOCXFAaAcFGarBBAQrBOGcCL4GxAxCSsGxe86BBAOCMFAaAxFGarBBAcCSgGcAcCSsGce86BBAOCpFAaAcFGarBBAQrBRGQCL4GcAcCSsGce86BBAOCSFAaAcFGOrBBAQCSgGQAQCSsGQe86BBAOAQFHQXEKAOAQ8pBB83BBAOCWFAQCWF8pBB83BBAQCZFHQKAICDFHIALCZFGLAp6MBKAQtMDDNAXtMBAWASFrBBHICBHOAhHLINALAWCJ/CBFAOFrBBGoCE4CBAoCEg9r7AIFGI86BBALADFHLAOCEFGOAX9HMBKKAhCEFHhASCEFGSAD6HZAQHoASAD9HMBXIKKAQAMAD2FHcDNAXtMBCBHpCEHZAWCJDFHaINARAQ9rAM6MLAQtMDAQAMFHQAWApFrBBHICBHOAaHLINALAWCJ/CBFAOFrBBGoCE4CBAoCEg9r7AIFGI86BBALADFHLAOCEFGOAX9HMBKAaCEFHaApCEFGpAD6HZApAD9HMBKAcHQXDKCBHOCEHZINARAQ9rAM6MIAQtMEAOCEFGOAD6HZAQAMFHQADAO9HMBKAcHQXEKCBHQAZCEgMEKABAKAD2FAWCJDFAXAD2Z1JJJB8aAWAWCJDFAXCUFAD2FADZ1JJJB8aAXAKFHKAQMEKKC9+HOXDKAEtMBCBHOINAdAEAO9rAOAdFAE6eAOFGOAE6MBKKCBC99ARAQ9rADCAADCA0eseHOKAVCJ/EBF8kJJJJBAOK/YZEhU8jJJJJBC/AE9rGV8kJJJJBC9+HODNAECI9uGRChFAL0MBCUHOAIrBBGWC/wEgC/gE9HMBAWCSgGdCE0MBAVC/ABFCfECJEZ+JJJJB8aAVCuF9CU83IBAVC8wF9CU83IBAVCYF9CU83IBAVCAF9CU83IBAVCkF9CU83IBAVCZF9CU83IBAV9CU83IWAV9CU83IBALAIFC9wFHQAICEFGWARFHODNAEtMBCMCSAdCEseHKCBHXCBHMCBHdCBHICBHLINDNAOAQ9NMBC9+HOXIKDNDNAWrBBGRC/vE0MBAVC/ABFALARCL4CU7FCSgCITFGpYDLHSApYDBHZDNARCSgGpAK9PMBAVAIARCU7FCSgCDTFYDBAXApeHRAptHpDNDNADCD9HMBABAdCETFGhAZ87EBAhCDFAS87EBAhCLFAR87EBXEKABAdCDTFGhAZbDBAhCLFASbDBAhCWFARbDBKAXApFHXAVC/ABFALCITFGhARbDBAhASbDLAVAICDTFARbDBAVC/ABFALCEFCSgGLCITFGhAZbDBAhARbDLAIApFHIALCEFHLXDKDNDNApCSsMBAMApFApC987FCEFHMXEKAOCEFHRAO8sBBGpCfEgHhDNDNApCU9MMBARHOXEKAOCVFHOAhCfBgHhCRHpDNINAR8sBBGoCfBgApTAhvHhAoCU9KMEARCEFHRApCRFGpC8j9HMBXDKKARCEFHOKAhCE4CBAhCEg9r7AMFHMKDNDNADCD9HMBABAdCETFGRAZ87EBARCDFAS87EBARCLFAM87EBXEKABAdCDTFGRAZbDBARCLFASbDBARCWFAMbDBKAVC/ABFALCITFGRAMbDBARASbDLAVAICDTFAMbDBAVC/ABFALCEFCSgGLCITFGRAZbDBARAMbDLAICEFHIALCEFHLXEKDNARCPE0MBAXCEFGoAVAIAQARCSgFrBBGpCL49rCSgCDTFYDBApCZ6GheHRAVAIAp9rCSgCDTFYDBAoAhFGSApCSgGoeHpAotHoDNDNADCD9HMBABAdCETFGZAX87EBAZCDFAR87EBAZCLFAp87EBXEKABAdCDTFGZAXbDBAZCLFARbDBAZCWFApbDBKAVAICDTFAXbDBAVC/ABFALCITFGZARbDBAZAXbDLAVAICEFGICSgCDTFARbDBAVC/ABFALCEFCSgCITFGZApbDBAZARbDLAVAIAhFCSgGICDTFApbDBAVC/ABFALCDFCSgGLCITFGRAXbDBARApbDLALCEFHLAIAoFHIASAoFHXXEKAXCBAOrBBGZeGaARC/+EsGRFHSAZCSgHcAZCL4HxDNDNAZCS0MBASCEFHoXEKASHoAVAIAx9rCSgCDTFYDBHSKDNDNAcMBAoCEFHXXEKAoHXAVAIAZ9rCSgCDTFYDBHoKDNDNARtMBAOCEFHRXEKAOCDFHRAO8sBEGhCfEgHpDNAhCU9KMBAOCOFHaApCfBgHpCRHODNINAR8sBBGhCfBgAOTApvHpAhCU9KMEARCEFHRAOCRFGOC8j9HMBKAaHRXEKARCEFHRKApCE4CBApCEg9r7AMFGMHaKDNDNAxCSsMBARHpXEKARCEFHpAR8sBBGOCfEgHhDNAOCU9KMBARCVFHSAhCfBgHhCRHODNINAp8sBBGRCfBgAOTAhvHhARCU9KMEApCEFHpAOCRFGOC8j9HMBKASHpXEKApCEFHpKAhCE4CBAhCEg9r7AMFGMHSKDNDNAcCSsMBApHOXEKApCEFHOAp8sBBGRCfEgHhDNARCU9KMBApCVFHoAhCfBgHhCRHRDNINAO8sBBGpCfBgARTAhvHhApCU9KMEAOCEFHOARCRFGRC8j9HMBKAoHOXEKAOCEFHOKAhCE4CBAhCEg9r7AMFGMHoKDNDNADCD9HMBABAdCETFGRAa87EBARCDFAS87EBARCLFAo87EBXEKABAdCDTFGRAabDBARCLFASbDBARCWFAobDBKAVC/ABFALCITFGRASbDBARAabDLAVAICDTFAabDBAVC/ABFALCEFCSgCITFGRAobDBARASbDLAVAICEFGICSgCDTFASbDBAVC/ABFALCDFCSgCITFGRAabDBARAobDLAVAIAZCZ6AxCSsvFGICSgCDTFAobDBAIActAcCSsvFHIALCIFHLKAWCEFHWALCSgHLAICSgHIAdCIFGdAE6MBKKCBC99AOAQseHOKAVC/AEF8kJJJJBAOK+LLEVU8jJJJJBCZ9rHVC9+HODNAECVFAL0MBCUHOAIrBBC/+EgC/QE9HMBAV9CB83IWAICEFHRALAIFC98FHWDNAEtMBDNADCDsMBCBHdINDNARAW6MBC9+SKARCEFHOAR8sBBGLCfEgHIDNDNALCU9MMBAOHRXEKARCVFHRAICfBgHICRHLDNINAO8sBBGDCfBgALTAIvHIADCU9KMEAOCEFHOALCRFGLC8j9HMBXDKKAOCEFHRKABAdCDTFAICD4CBAICE4CEg9r7AVCWFAICEgCDTvGOYDBFGLbDBAOALbDBAdCEFGdAE9HMBXDKKCBHdINDNARAW6MBC9+SKARCEFHOAR8sBBGLCfEgHIDNDNALCU9MMBAOHRXEKARCVFHRAICfBgHICRHLDNINAO8sBBGDCfBgALTAIvHIADCU9KMEAOCEFHOALCRFGLC8j9HMBXDKKAOCEFHRKABAdCETFAICD4CBAICE4CEg9r7AVCWFAICEgCDTvGOYDBFGL87EBAOALbDBAdCEFGdAE9HMBKKCBC99ARAWseHOKAOK+lVOEUE99DUD99EUD99DNDNADCL9HMBAEtMEINDNDNjBBBzjBBB+/ABCDFGD8sBB+yAB8sBBGI+yGL+L+TABCEFGV8sBBGO+yGR+L+TGWjBBBB9gGdeAWjBB/+9CAWAWnjBBBBAWAdeGQAQ+MGKAICU9KeALmGLALnAQAKAOCU9KeARmGQAQnmm+R+VGRnmGW+LjBBB9P9dtMBAW+oHIXEKCJJJJ94HIKADAI86BBDNDNjBBBzjBBB+/AQjBBBB9geAQARnmGW+LjBBB9P9dtMBAW+oHDXEKCJJJJ94HDKAVAD86BBDNDNjBBBzjBBB+/ALjBBBB9geALARnmGW+LjBBB9P9dtMBAW+oHDXEKCJJJJ94HDKABAD86BBABCLFHBAECUFGEMBXDKKAEtMBINDNDNjBBBzjBBB+/ABCLFGD8uEB+yAB8uEBGI+yGL+L+TABCDFGV8uEBGO+yGR+L+TGWjBBBB9gGdeAWjB/+fsAWAWnjBBBBAWAdeGQAQ+MGKAICU9KeALmGLALnAQAKAOCU9KeARmGQAQnmm+R+VGRnmGW+LjBBB9P9dtMBAW+oHIXEKCJJJJ94HIKADAI87EBDNDNjBBBzjBBB+/AQjBBBB9geAQARnmGW+LjBBB9P9dtMBAW+oHDXEKCJJJJ94HDKAVAD87EBDNDNjBBBzjBBB+/ALjBBBB9geALARnmGW+LjBBB9P9dtMBAW+oHDXEKCJJJJ94HDKABAD87EBABCWFHBAECUFGEMBKKK/SILIUI99IUE99DNAEtMBCBHIABHLINDNDNj/zL81zALCOF8uEBGVCIv+y+VGOAL8uEB+ynGRjB/+fsnjBBBzjBBB+/ARjBBBB9gemGW+LjBBB9P9dtMBAW+oHdXEKCJJJJ94HdKALCLF8uEBHQALCDF8uEBHKABAVCEFCIgAIvCETFAd87EBDNDNAOAK+ynGWjB/+fsnjBBBzjBBB+/AWjBBBB9gemGX+LjBBB9P9dtMBAX+oHKXEKCJJJJ94HKKABAVCDFCIgAIvCETFAK87EBDNDNAOAQ+ynGOjB/+fsnjBBBzjBBB+/AOjBBBB9gemGX+LjBBB9P9dtMBAX+oHQXEKCJJJJ94HQKABAVCUFCIgAIvCETFAQ87EBDNDNjBBJzARARn+TAWAWn+TAOAOn+TGRjBBBBARjBBBB9ge+RjB/+fsnjBBBzmGR+LjBBB9P9dtMBAR+oHQXEKCJJJJ94HQKABAVCIgAIvCETFAQ87EBALCWFHLAICLFHIAECUFGEMBKKK9MBDNADCD4AE2GEtMBINABABYDBGDCWTCW91+yADCE91CJJJ/8IFCJJJ98g++nuDBABCLFHBAECUFGEMBKKK9TEIUCBCBYDJ1JJBGEABCIFC98gFGBbDJ1JJBDNDNABzBCZTGD9NMBCUHIABAD9rCffIFCZ4NBCUsMEKAEHIKAIK/lEEEUDNDNAEABvCIgtMBABHIXEKDNDNADCZ9PMBABHIXEKABHIINAIAEYDBbDBAICLFAECLFYDBbDBAICWFAECWFYDBbDBAICXFAECXFYDBbDBAICZFHIAECZFHEADC9wFGDCS0MBKKADCL6MBINAIAEYDBbDBAECLFHEAICLFHIADC98FGDCI0MBKKDNADtMBINAIAErBB86BBAICEFHIAECEFHEADCUFGDMBKKABK/AEEDUDNDNABCIgtMBABHIXEKAECfEgC+B+C+EW2HLDNDNADCZ9PMBABHIXEKABHIINAIALbDBAICXFALbDBAICWFALbDBAICLFALbDBAICZFHIADC9wFGDCS0MBKKADCL6MBINAIALbDBAICLFHIADC98FGDCI0MBKKDNADtMBINAIAE86BBAICEFHIADCUFGDMBKKABKKKEBCJWKLZ9kBB",WebAssembly.validate(ia)&&(e="B9h79tEBBBEkL9gBB9gVUUUUUEU9gIUUUB9gEUEUIKQBBEBEEDDDILVE9wEEEVIEBEOWEUEC+Q/aEKR/LEdO9tw9t9vv95DBh9f9f939h79t9f9j9h229f9jT9vv7BB8a9tw79o9v9wT9f9kw9j9v9kw9WwvTw949C919m9mwvBDy9tw79o9v9wT9f9kw9j9v9kw69u9kw949C919m9mwvBLe9tw79o9v9wT9f9kw9j9v9kw69u9kw949Twg91w9u9jwBVl9tw79o9v9wT9f9kw9j9v9kws9p2Twv9P9jTBOk9tw79o9v9wT9f9kw9j9v9kws9p2Twv9R919hTBRl9tw79o9v9wT9f9kw9j9v9kws9p2Twvt949wBWL79iv9rBdQ/49TQLBZIK9+EVU8jJJJJBCZ9rHBCBHEINCBHDCBHIINABCWFADFAICJUAEAD4CEgGLe86BBAIALFHIADCEFGDCW9HMBKAEC+Q+YJJBFAI86BBAECITC+Q1JJBFAB8pIW83IBAECEFGECJD9HMBKK/s8jLhUD97EUO978jJJJJBCJ/KB9rGV8kJJJJBC9+HODNADCEFAL0MBCUHOAIrBBC+gE9HMBAVAIALFGRAD9rAD/8QBBCJ/ABAD9uC/wfBgGLCJDALCJD6eHWAICEFHLDNDNADtMBCBHdINAdAE9PMDAWAEAd9rAdAWFAE6eGQCSFGOC9wgGKCI2HXAKCETHMAOCL4CIFCD4HpABAdAD2FHSCBHZDNINCEHhALHoCBHaDNINARAo9rAp6MIAVCJ/CBFAaAK2FHcAoApFHLCBHIDNAKC/AB6MBARAL9rC/gB6MBCBHOINAcAOFHIDNDNDNDNDNAoAOCO4FrBBGxCIgpLBEDIBKAIPXBBBBBBBBBBBBBBBBPKLBXIKAIALPBBLALPBBBGqCLP+MEAqPMBZEhDoIaLcVxOqRlGqCDP+MEAqPMBZEhDoIaLcVxOqRlPXIIIIIIIIIIIIIIIIP9OGlPXIIIIIIIIIIIIIIIIP8jGqP5B9CJf/8/4/w/g/AB9+9Cu1+nGkCITC+Q1JJBFPBIBAkC+Q+YJJBFPBBBGyAyPMBBBBBBBBBBBBBBBBAqP5E9CJf/8/4/w/g/AB9+9Cu1+nGkCITC+Q1JJBFPBIBP9uPMBEDILVORZhoacxqlPpAlAqP9SPKLBALCLFAkC+Q+YJJBFrBBAyPqBFFHLXDKAIALPBBWALPBBBGqCLP+MEAqPMBZEhDoIaLcVxOqRlPXSSSSSSSSSSSSSSSSP9OGlPXSSSSSSSSSSSSSSSSP8jGqP5B9CJf/8/4/w/g/AB9+9Cu1+nGkCITC+Q1JJBFPBIBAkC+Q+YJJBFPBBBGyAyPMBBBBBBBBBBBBBBBBAqP5E9CJf/8/4/w/g/AB9+9Cu1+nGkCITC+Q1JJBFPBIBP9uPMBEDILVORZhoacxqlPpAlAqP9SPKLBALCWFAkC+Q+YJJBFrBBAyPqBFFHLXEKAIALPBBBPKLBALCZFHLKDNDNDNDNDNAxCD4CIgpLBEDIBKAIPXBBBBBBBBBBBBBBBBPKLZXIKAIALPBBLALPBBBGqCLP+MEAqPMBZEhDoIaLcVxOqRlGqCDP+MEAqPMBZEhDoIaLcVxOqRlPXIIIIIIIIIIIIIIIIP9OGlPXIIIIIIIIIIIIIIIIP8jGqP5B9CJf/8/4/w/g/AB9+9Cu1+nGkCITC+Q1JJBFPBIBAkC+Q+YJJBFPBBBGyAyPMBBBBBBBBBBBBBBBBAqP5E9CJf/8/4/w/g/AB9+9Cu1+nGkCITC+Q1JJBFPBIBP9uPMBEDILVORZhoacxqlPpAlAqP9SPKLZALCLFAkC+Q+YJJBFrBBAyPqBFFHLXDKAIALPBBWALPBBBGqCLP+MEAqPMBZEhDoIaLcVxOqRlPXSSSSSSSSSSSSSSSSP9OGlPXSSSSSSSSSSSSSSSSP8jGqP5B9CJf/8/4/w/g/AB9+9Cu1+nGkCITC+Q1JJBFPBIBAkC+Q+YJJBFPBBBGyAyPMBBBBBBBBBBBBBBBBAqP5E9CJf/8/4/w/g/AB9+9Cu1+nGkCITC+Q1JJBFPBIBP9uPMBEDILVORZhoacxqlPpAlAqP9SPKLZALCWFAkC+Q+YJJBFrBBAyPqBFFHLXEKAIALPBBBPKLZALCZFHLKDNDNDNDNDNAxCL4CIgpLBEDIBKAIPXBBBBBBBBBBBBBBBBPKLAXIKAIALPBBLALPBBBGqCLP+MEAqPMBZEhDoIaLcVxOqRlGqCDP+MEAqPMBZEhDoIaLcVxOqRlPXIIIIIIIIIIIIIIIIP9OGlPXIIIIIIIIIIIIIIIIP8jGqP5B9CJf/8/4/w/g/AB9+9Cu1+nGkCITC+Q1JJBFPBIBAkC+Q+YJJBFPBBBGyAyPMBBBBBBBBBBBBBBBBAqP5E9CJf/8/4/w/g/AB9+9Cu1+nGkCITC+Q1JJBFPBIBP9uPMBEDILVORZhoacxqlPpAlAqP9SPKLAALCLFAkC+Q+YJJBFrBBAyPqBFFHLXDKAIALPBBWALPBBBGqCLP+MEAqPMBZEhDoIaLcVxOqRlPXSSSSSSSSSSSSSSSSP9OGlPXSSSSSSSSSSSSSSSSP8jGqP5B9CJf/8/4/w/g/AB9+9Cu1+nGkCITC+Q1JJBFPBIBAkC+Q+YJJBFPBBBGyAyPMBBBBBBBBBBBBBBBBAqP5E9CJf/8/4/w/g/AB9+9Cu1+nGkCITC+Q1JJBFPBIBP9uPMBEDILVORZhoacxqlPpAlAqP9SPKLAALCWFAkC+Q+YJJBFrBBAyPqBFFHLXEKAIALPBBBPKLAALCZFHLKDNDNDNDNDNAxCO4pLBEDIBKAIPXBBBBBBBBBBBBBBBBPKL8wXIKAIALPBBLALPBBBGqCLP+MEAqPMBZEhDoIaLcVxOqRlGqCDP+MEAqPMBZEhDoIaLcVxOqRlPXIIIIIIIIIIIIIIIIP9OGlPXIIIIIIIIIIIIIIIIP8jGqP5B9CJf/8/4/w/g/AB9+9Cu1+nGxCITC+Q1JJBFPBIBAxC+Q+YJJBFPBBBGyAyPMBBBBBBBBBBBBBBBBAqP5E9CJf/8/4/w/g/AB9+9Cu1+nGxCITC+Q1JJBFPBIBP9uPMBEDILVORZhoacxqlPpAlAqP9SPKL8wALCLFAxC+Q+YJJBFrBBAyPqBFFHLXDKAIALPBBWALPBBBGqCLP+MEAqPMBZEhDoIaLcVxOqRlPXSSSSSSSSSSSSSSSSP9OGlPXSSSSSSSSSSSSSSSSP8jGqP5B9CJf/8/4/w/g/AB9+9Cu1+nGxCITC+Q1JJBFPBIBAxC+Q+YJJBFPBBBGyAyPMBBBBBBBBBBBBBBBBAqP5E9CJf/8/4/w/g/AB9+9Cu1+nGxCITC+Q1JJBFPBIBP9uPMBEDILVORZhoacxqlPpAlAqP9SPKL8wALCWFAxC+Q+YJJBFrBBAyPqBFFHLXEKAIALPBBBPKL8wALCZFHLKAOC/ABFHIAOCJEFAK0MEAIHOARAL9rC/fB0MBKKDNDNAIAK9PMBAICI4HOINARAL9rCk6MDAcAIFHxDNDNDNDNDNAoAICO4FrBBAOCOg4CIgpLBEDIBKAxPXBBBBBBBBBBBBBBBBPKLBXIKAxALPBBLALPBBBGqCLP+MEAqPMBZEhDoIaLcVxOqRlGqCDP+MEAqPMBZEhDoIaLcVxOqRlPXIIIIIIIIIIIIIIIIP9OGlPXIIIIIIIIIIIIIIIIP8jGqP5B9CJf/8/4/w/g/AB9+9Cu1+nGkCITC+Q1JJBFPBIBAkC+Q+YJJBFPBBBGyAyPMBBBBBBBBBBBBBBBBAqP5E9CJf/8/4/w/g/AB9+9Cu1+nGkCITC+Q1JJBFPBIBP9uPMBEDILVORZhoacxqlPpAlAqP9SPKLBALCLFAkC+Q+YJJBFrBBAyPqBFFHLXDKAxALPBBWALPBBBGqCLP+MEAqPMBZEhDoIaLcVxOqRlPXSSSSSSSSSSSSSSSSP9OGlPXSSSSSSSSSSSSSSSSP8jGqP5B9CJf/8/4/w/g/AB9+9Cu1+nGkCITC+Q1JJBFPBIBAkC+Q+YJJBFPBBBGyAyPMBBBBBBBBBBBBBBBBAqP5E9CJf/8/4/w/g/AB9+9Cu1+nGkCITC+Q1JJBFPBIBP9uPMBEDILVORZhoacxqlPpAlAqP9SPKLBALCWFAkC+Q+YJJBFrBBAyPqBFFHLXEKAxALPBBBPKLBALCZFHLKAOCDFHOAICZFGIAK6MBKKALtMBAaCI6HhALHoAaCEFGOHaAOCLsMDXEKKCBHLAhCEgMDKDNAKtMBAVCJDFAZFHIAVAZFPBDBHyCBHxINAIAVCJ/CBFAxFGOPBLBGlCEP9tAlPXEEEEEEEEEEEEEEEEGqP9OP9hP9RGlAOAKFPBLBG8aCEP9tA8aAqP9OP9hP9RG8aPMBZEhDoIaLcVxOqRlGeAOAMFPBLBG3CEP9tA3AqP9OP9hP9RG3AOAXFPBLBG5CEP9tA5AqP9OP9hP9RG5PMBZEhDoIaLcVxOqRlG8ePMBEZhDIoaLVcxORqlGqAqPMBEDIBEDIBEDIBEDIAyP9uGyP9aDBBAIADFGOAyAqAqPMLVORLVORLVORLVORP9uGyP9aDBBAOADFGOAyAqAqPMWdQKWdQKWdQKWdQKP9uGyP9aDBBAOADFGOAyAqAqPMXMpSXMpSXMpSXMpSP9uGyP9aDBBAOADFGOAyAeA8ePMWdkyQK8aeXM35pS8e8fGqAqPMBEDIBEDIBEDIBEDIP9uGyP9aDBBAOADFGOAyAqAqPMLVORLVORLVORLVORP9uGyP9aDBBAOADFGOAyAqAqPMWdQKWdQKWdQKWdQKP9uGyP9aDBBAOADFGOAyAqAqPMXMpSXMpSXMpSXMpSP9uGyP9aDBBAOADFGOAyAlA8aPMWkdyQ8aKeX3M5p8eS8fGlA3A5PMWkdyQ8aKeX3M5p8eS8fG8aPMBEZhDIoaLVcxORqlGqAqPMBEDIBEDIBEDIBEDIP9uGyP9aDBBAOADFGOAyAqAqPMLVORLVORLVORLVORP9uGyP9aDBBAOADFGOAyAqAqPMWdQKWdQKWdQKWdQKP9uGyP9aDBBAOADFGOAyAqAqPMXMpSXMpSXMpSXMpSP9uGyP9aDBBAOADFGOAyAlA8aPMWdkyQK8aeXM35pS8e8fGqAqPMBEDIBEDIBEDIBEDIP9uGyP9aDBBAOADFGOAyAqAqPMLVORLVORLVORLVORP9uGyP9aDBBAOADFGOAyAqAqPMWdQKWdQKWdQKWdQKP9uGyP9aDBBAOADFGOAyAqAqPMXMpSXMpSXMpSXMpSP9uGyP9aDBBAOADFHIAxCZFGxAK6MBKKAZCLFGZAD6MBKASAVCJDFAQAD2/8QBBAVAVCJDFAQCUFAD2FAD/8QBBAQAdFHdC9+HOALMEXLKKC9+HOXDKAEtMBCBHOINAWAEAO9rAOAWFAE6eAOFGOAE6MBKKCBC99ARAL9rADCAADCA0eseHOKAVCJ/KBF8kJJJJBAOKWBZ+BJJJBK/UZEhU8jJJJJBC/AE9rGV8kJJJJBC9+HODNAECI9uGRChFAL0MBCUHOAIrBBGWC/wEgC/gE9HMBAWCSgGdCE0MBAVC/ABFCfECJE/8KBAVCuF9CU83IBAVC8wF9CU83IBAVCYF9CU83IBAVCAF9CU83IBAVCkF9CU83IBAVCZF9CU83IBAV9CU83IWAV9CU83IBALAIFC9wFHQAICEFGWARFHODNAEtMBCMCSAdCEseHKCBHXCBHMCBHdCBHICBHLINDNAOAQ9NMBC9+HOXIKDNDNAWrBBGRC/vE0MBAVC/ABFALARCL4CU7FCSgCITFGpYDLHSApYDBHZDNARCSgGpAK9PMBAVAIARCU7FCSgCDTFYDBAXApeHRAptHpDNDNADCD9HMBABAdCETFGhAZ87EBAhCDFAS87EBAhCLFAR87EBXEKABAdCDTFGhAZbDBAhCLFASbDBAhCWFARbDBKAXApFHXAVC/ABFALCITFGhARbDBAhASbDLAVAICDTFARbDBAVC/ABFALCEFCSgGLCITFGhAZbDBAhARbDLAIApFHIALCEFHLXDKDNDNApCSsMBAMApFApC987FCEFHMXEKAOCEFHRAO8sBBGpCfEgHhDNDNApCU9MMBARHOXEKAOCVFHOAhCfBgHhCRHpDNINAR8sBBGoCfBgApTAhvHhAoCU9KMEARCEFHRApCRFGpC8j9HMBXDKKARCEFHOKAhCE4CBAhCEg9r7AMFHMKDNDNADCD9HMBABAdCETFGRAZ87EBARCDFAS87EBARCLFAM87EBXEKABAdCDTFGRAZbDBARCLFASbDBARCWFAMbDBKAVC/ABFALCITFGRAMbDBARASbDLAVAICDTFAMbDBAVC/ABFALCEFCSgGLCITFGRAZbDBARAMbDLAICEFHIALCEFHLXEKDNARCPE0MBAXCEFGoAVAIAQARCSgFrBBGpCL49rCSgCDTFYDBApCZ6GheHRAVAIAp9rCSgCDTFYDBAoAhFGSApCSgGoeHpAotHoDNDNADCD9HMBABAdCETFGZAX87EBAZCDFAR87EBAZCLFAp87EBXEKABAdCDTFGZAXbDBAZCLFARbDBAZCWFApbDBKAVAICDTFAXbDBAVC/ABFALCITFGZARbDBAZAXbDLAVAICEFGICSgCDTFARbDBAVC/ABFALCEFCSgCITFGZApbDBAZARbDLAVAIAhFCSgGICDTFApbDBAVC/ABFALCDFCSgGLCITFGRAXbDBARApbDLALCEFHLAIAoFHIASAoFHXXEKAXCBAOrBBGZeGaARC/+EsGRFHSAZCSgHcAZCL4HxDNDNAZCS0MBASCEFHoXEKASHoAVAIAx9rCSgCDTFYDBHSKDNDNAcMBAoCEFHXXEKAoHXAVAIAZ9rCSgCDTFYDBHoKDNDNARtMBAOCEFHRXEKAOCDFHRAO8sBEGhCfEgHpDNAhCU9KMBAOCOFHaApCfBgHpCRHODNINAR8sBBGhCfBgAOTApvHpAhCU9KMEARCEFHRAOCRFGOC8j9HMBKAaHRXEKARCEFHRKApCE4CBApCEg9r7AMFGMHaKDNDNAxCSsMBARHpXEKARCEFHpAR8sBBGOCfEgHhDNAOCU9KMBARCVFHSAhCfBgHhCRHODNINAp8sBBGRCfBgAOTAhvHhARCU9KMEApCEFHpAOCRFGOC8j9HMBKASHpXEKApCEFHpKAhCE4CBAhCEg9r7AMFGMHSKDNDNAcCSsMBApHOXEKApCEFHOAp8sBBGRCfEgHhDNARCU9KMBApCVFHoAhCfBgHhCRHRDNINAO8sBBGpCfBgARTAhvHhApCU9KMEAOCEFHOARCRFGRC8j9HMBKAoHOXEKAOCEFHOKAhCE4CBAhCEg9r7AMFGMHoKDNDNADCD9HMBABAdCETFGRAa87EBARCDFAS87EBARCLFAo87EBXEKABAdCDTFGRAabDBARCLFASbDBARCWFAobDBKAVC/ABFALCITFGRASbDBARAabDLAVAICDTFAabDBAVC/ABFALCEFCSgCITFGRAobDBARASbDLAVAICEFGICSgCDTFASbDBAVC/ABFALCDFCSgCITFGRAabDBARAobDLAVAIAZCZ6AxCSsvFGICSgCDTFAobDBAIActAcCSsvFHIALCIFHLKAWCEFHWALCSgHLAICSgHIAdCIFGdAE6MBKKCBC99AOAQseHOKAVC/AEF8kJJJJBAOK+LLEVU8jJJJJBCZ9rHVC9+HODNAECVFAL0MBCUHOAIrBBC/+EgC/QE9HMBAV9CB83IWAICEFHRALAIFC98FHWDNAEtMBDNADCDsMBCBHdINDNARAW6MBC9+SKARCEFHOAR8sBBGLCfEgHIDNDNALCU9MMBAOHRXEKARCVFHRAICfBgHICRHLDNINAO8sBBGDCfBgALTAIvHIADCU9KMEAOCEFHOALCRFGLC8j9HMBXDKKAOCEFHRKABAdCDTFAICD4CBAICE4CEg9r7AVCWFAICEgCDTvGOYDBFGLbDBAOALbDBAdCEFGdAE9HMBXDKKCBHdINDNARAW6MBC9+SKARCEFHOAR8sBBGLCfEgHIDNDNALCU9MMBAOHRXEKARCVFHRAICfBgHICRHLDNINAO8sBBGDCfBgALTAIvHIADCU9KMEAOCEFHOALCRFGLC8j9HMBXDKKAOCEFHRKABAdCETFAICD4CBAICE4CEg9r7AVCWFAICEgCDTvGOYDBFGL87EBAOALbDBAdCEFGdAE9HMBKKCBC99ARAWseHOKAOK+epLIUO97EUE978jJJJJBCA9rHIDNDNADCL9HMBDNAEC98gGLtMBCBHVABHDINADADPBBBGOCkP+rECkP+sEP/6EGRAOCWP+rECkP+sEP/6EARP/gEAOCZP+rECkP+sEP/6EGWP/gEP/kEP/lEGdPXBBBBBBBBBBBBBBBBP+2EGQARPXBBBJBBBJBBBJBBBJGKP9OP9RP/kEGRPXBB/+9CBB/+9CBB/+9CBB/+9CARARP/mEAdAdP/mEAWAQAWAKP9OP9RP/kEGRARP/mEP/kEP/kEP/jEP/nEGWP/mEPXBBN0BBN0BBN0BBN0GQP/kEPXfBBBfBBBfBBBfBBBP9OAOPXBBBfBBBfBBBfBBBfP9OP9QARAWP/mEAQP/kECWP+rEPXBfBBBfBBBfBBBfBBP9OP9QAdAWP/mEAQP/kECZP+rEPXBBfBBBfBBBfBBBfBP9OP9QPKBBADCZFHDAVCLFGVAL6MBKKALAE9PMEAIAECIgGVCDTGDvCBCZAD9r/8KBAIABALCDTFGLAD/8QBBDNAVtMBAIAIPBLBGOCkP+rECkP+sEP/6EGRAOCWP+rECkP+sEP/6EARP/gEAOCZP+rECkP+sEP/6EGWP/gEP/kEP/lEGdPXBBBBBBBBBBBBBBBBP+2EGQARPXBBBJBBBJBBBJBBBJGKP9OP9RP/kEGRPXBB/+9CBB/+9CBB/+9CBB/+9CARARP/mEAdAdP/mEAWAQAWAKP9OP9RP/kEGRARP/mEP/kEP/kEP/jEP/nEGWP/mEPXBBN0BBN0BBN0BBN0GQP/kEPXfBBBfBBBfBBBfBBBP9OAOPXBBBfBBBfBBBfBBBfP9OP9QARAWP/mEAQP/kECWP+rEPXBfBBBfBBBfBBBfBBP9OP9QAdAWP/mEAQP/kECZP+rEPXBBfBBBfBBBfBBBfBP9OP9QPKLBKALAIAD/8QBBSKDNAEC98gGXtMBCBHVABHDINADCZFGLALPBBBGOPXBBBBBBffBBBBBBffGKP9OADPBBBGdAOPMLVORXMpScxql358e8fPXfUBBfUBBfUBBfUBBP9OP/6EAdAOPMBEDIWdQKZhoaky8aeGOCZP+sEP/6EGRP/gEAOCZP+rECZP+sEP/6EGWP/gEP/kEP/lEGOPXB/+fsB/+fsB/+fsB/+fsAWAOPXBBBBBBBBBBBBBBBBP+2EGQAWPXBBBJBBBJBBBJBBBJGMP9OP9RP/kEGWAWP/mEAOAOP/mEARAQARAMP9OP9RP/kEGOAOP/mEP/kEP/kEP/jEP/nEGRP/mEPXBBN0BBN0BBN0BBN0GQP/kECZP+rEAWARP/mEAQP/kEPXffBBffBBffBBffBBP9OP9QGWAOARP/mEAQP/kEPXffBBffBBffBBffBBP9OGOPMWdkyQK8aeXM35pS8e8fP9QPKBBADAdAKP9OAWAOPMBEZhDIoaLVcxORqlP9QPKBBADCAFHDAVCLFGVAX6MBKKAXAE9PMBAIAECIgGVCITGDFCBCAAD9r/8KBAIABAXCITFGLAD/8QBBDNAVtMBAIAIPBLZGOPXBBBBBBffBBBBBBffGKP9OAIPBLBGdAOPMLVORXMpScxql358e8fPXfUBBfUBBfUBBfUBBP9OP/6EAdAOPMBEDIWdQKZhoaky8aeGOCZP+sEP/6EGRP/gEAOCZP+rECZP+sEP/6EGWP/gEP/kEP/lEGOPXB/+fsB/+fsB/+fsB/+fsAWAOPXBBBBBBBBBBBBBBBBP+2EGQAWPXBBBJBBBJBBBJBBBJGMP9OP9RP/kEGWAWP/mEAOAOP/mEARAQARAMP9OP9RP/kEGOAOP/mEP/kEP/kEP/jEP/nEGRP/mEPXBBN0BBN0BBN0BBN0GQP/kECZP+rEAWARP/mEAQP/kEPXffBBffBBffBBffBBP9OP9QGWAOARP/mEAQP/kEPXffBBffBBffBBffBBP9OGOPMWdkyQK8aeXM35pS8e8fP9QPKLZAIAdAKP9OAWAOPMBEZhDIoaLVcxORqlP9QPKLBKALAIAD/8QBBKK/4WLLUE97EUV978jJJJJBC8w9rHIDNAEC98gGLtMBCBHVABHOINAIAOPBBBGRAOCZFGWPBBBGdPMLVORXMpScxql358e8fGQCZP+sEGKCLP+rEPKLBAOPXBBJzBBJzBBJzBBJzPX/zL81z/zL81z/zL81z/zL81zAKPXIBBBIBBBIBBBIBBBP9QP/6EP/nEGKARAdPMBEDIWdQKZhoaky8aeGRCZP+rECZP+sEP/6EP/mEGdAdP/mEAKARCZP+sEP/6EP/mEGXAXP/mEAKAQCZP+rECZP+sEP/6EP/mEGQAQP/mEP/kEP/kEP/lEPXBBBBBBBBBBBBBBBBP+4EP/jEPXB/+fsB/+fsB/+fsB/+fsGKP/mEPXBBN0BBN0BBN0BBN0GRP/kEPXffBBffBBffBBffBBGMP9OAXAKP/mEARP/kECZP+rEP9QGXAQAKP/mEARP/kECZP+rEAdAKP/mEARP/kEAMP9OP9QGKPMBEZhDIoaLVcxORqlGRP5BAIPBLBPeB+t+J83IBAOCWFARP5EAIPBLBPeE+t+J83IBAWAXAKPMWdkyQK8aeXM35pS8e8fGKP5BAIPBLBPeD+t+J83IBAOCkFAKP5EAIPBLBPeI+t+J83IBAOCAFHOAVCLFGVAL6MBKKDNALAE9PMBAIAECIgGVCITGOFCBCAAO9r/8KBAIABALCITFGWAO/8QBBDNAVtMBAIAIPBLBGRAIPBLZGdPMLVORXMpScxql358e8fGQCZP+sEGKCLP+rEPKLAAIPXBBJzBBJzBBJzBBJzPX/zL81z/zL81z/zL81z/zL81zAKPXIBBBIBBBIBBBIBBBP9QP/6EP/nEGKARAdPMBEDIWdQKZhoaky8aeGRCZP+rECZP+sEP/6EP/mEGdAdP/mEAKARCZP+sEP/6EP/mEGXAXP/mEAKAQCZP+rECZP+sEP/6EP/mEGQAQP/mEP/kEP/kEP/lEPXBBBBBBBBBBBBBBBBP+4EP/jEPXB/+fsB/+fsB/+fsB/+fsGKP/mEPXBBN0BBN0BBN0BBN0GRP/kEPXffBBffBBffBBffBBGMP9OAXAKP/mEARP/kECZP+rEP9QGXAQAKP/mEARP/kECZP+rEAdAKP/mEARP/kEAMP9OP9QGKPMBEZhDIoaLVcxORqlGRP5BAIPBLAPeB+t+J83IBAIARP5EAIPBLAPeE+t+J83IWAIAXAKPMWdkyQK8aeXM35pS8e8fGKP5BAIPBLAPeD+t+J83IZAIAKP5EAIPBLAPeI+t+J83IkKAWAIAO/8QBBKK+pDDIUE978jJJJJBC/AB9rHIDNADCD4AE2GLC98gGVtMBCBHDABHEINAEAEPBBBGOCWP+rECWP+sEP/6EAOCEP+sEPXBBJzBBJzBBJzBBJzP+uEPXBBJfBBJfBBJfBBJfP9OP/mEPKBBAECZFHEADCLFGDAV6MBKKDNAVAL9PMBAIALCIgGDCDTGEvCBC/ABAE9r/8KBAIABAVCDTFGVAE/8QBBDNADtMBAIAIPBLBGOCWP+rECWP+sEP/6EAOCEP+sEPXBBJzBBJzBBJzBBJzP+uEPXBBJfBBJfBBJfBBJfP9OP/mEPKLBKAVAIAE/8QBBKK9TEIUCBCBYDJ1JJBGEABCIFC98gFGBbDJ1JJBDNDNABzBCZTGD9NMBCUHIABAD9rCffIFCZ4NBCUsMEKAEHIKAIKKKEBCJWKLZ9tBB"),ia=WebAssembly.instantiate(function(e){for(var t=new Uint8Array(e.length),r=0;r<e.length;++r){var i=e.charCodeAt(r);t[r]=96<i?i-71:64<i?i-65:47<i?i+4:46<i?63:62}for(var n=0,r=0;r<e.length;++r)t[n++]=t[r]<60?tt[t[r]]:64*(t[r]-60)+t[++r];return t.buffer.slice(0,n)}(e),{}).then(function(e){(Je=e.instance).exports.__wasm_call_ctors()}),$e={0:"",1:"meshopt_decodeFilterOct",2:"meshopt_decodeFilterQuat",3:"meshopt_decodeFilterExp",NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},et={0:"meshopt_decodeVertexBuffer",1:"meshopt_decodeIndexBuffer",2:"meshopt_decodeIndexSequence",ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"},{ready:ia,supported:!0,decodeVertexBuffer:function(e,t,r,i,n){st(Je.exports.meshopt_decodeVertexBuffer,e,t,r,i,Je.exports[$e[n]])},decodeIndexBuffer:function(e,t,r,i){st(Je.exports.meshopt_decodeIndexBuffer,e,t,r,i)},decodeIndexSequence:function(e,t,r,i){st(Je.exports.meshopt_decodeIndexSequence,e,t,r,i)},decodeGltfBuffer:function(e,t,r,i,n,a){st(Je.exports[et[n]],e,t,r,i,Je.exports[$e[a]])}}));function st(e,t,r,i,n,a){var o=Je.exports.sbrk,s=r+3&-4,l=o(s*i),d=o(n.length),c=new Uint8Array(Je.exports.memory.buffer),e=(c.set(n,d),e(l,r,i,d,n.length));if(0==e&&a&&a(l,s,i),t.set(c.subarray(l,l+r*i)),o(l-o(0)),0!=e)throw new Error("Malformed buffer data: "+e)}function It(e,t){var r,i="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(i)return(i=i.call(e)).next.bind(i);if(Array.isArray(e)||(i=function(e,t){{var r;if(e)return"string"==typeof e?dt(e,t):"Map"===(r="Object"===(r={}.toString.call(e).slice(8,-1))&&e.constructor?e.constructor.name:r)||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?dt(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length)return i&&(e=i),r=0,function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}};throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function dt(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,i=Array(t);r<t;r++)i[r]=e[r];return i}function ct(e){return ft=ft.byteLength>=e?ft:new ArrayBuffer(e)}function ht(e){this.manager=void 0!==e?e:THREE.DefaultLoadingManager}function ut(e,t,r,i){this.showStatus=e,this.statusDomElement=e?ut.prototype.addStatusElement():null,this.imageLoader=new THREE.ImageLoader,this.manager=void 0!==t?t:THREE.DefaultLoadingManager,this.viewer=r,this.ndsModel=i,this.onLoadStart=function(){},this.onLoadProgress=function(){},this.onLoadComplete=function(){}}var pt,$=function(e){(e=void 0===e?{}:e)&&(this.objectIdType=void 0!==e.objectIdType?e.objectIdType:1,this.materialIdType=void 0!==e.materialIdType?e.materialIdType:1,this.geomIdType=void 0!==e.geomIdType?e.geomIdType:1,this.instanceIdType=void 0!==e.instanceIdType?e.instanceIdType:1,this.ndsModel=e.ndsModel||null)},ft=($.prototype=Object.create(THREE.Loader.prototype),$.prototype.load=function(e,l,d,c,h,u){c=c||{};var t=l.lastIndexOf("."),t=l.substring(t+1,l.length),r=l.lastIndexOf("/"),p=l.substring(r+1,l.length),f=("drc"==t&&(c.compress=!1),this),m=void 0!==c.bufferlenth?c.bufferlenth:0,g=new XMLHttpRequest;Date.now(),performance.now().toFixed(0);if(g.onreadystatechange=function(){if(4===g.readyState){if(200===g.status||0===g.status){var e=new Uint8Array(g.response),n=(d&&d(p,e),!c.geometriesArray),a=n?c.ndsGeometriesArray:c.geometriesArray;if(c.compress){if(c.useWorker)return(s=c.worker||("."==De.loadWorkerUrl.charAt(0)?new Worker(De.loadWorkerUrl):(s=new Blob(['importScripts("'+De.loadWorkerUrl+'")'],{type:"application/javascript"}),s=window.URL.createObjectURL(s),new Worker(s)))).onmessage=function(e){var e=e.data,t=new yt.Stream(e.data),r=(t.offset=e.offset,f.readBIMBuffer(t,d,a,h),a.length);if(c.ndsGeometriesArray)for(var i=0;i<r;++i)n||c.ndsGeometriesArray[i].copy(c.geometriesArray[i]),c.ndsGeometriesArray[i].loaded=!0,c.ndsGeometriesArray[i].bufferChunkUrl=l;this.terminate(),u&&u()},r={data:e,bufferlenth:m},void(-1!==(t=navigator.userAgent.toLowerCase()).indexOf("chrome")||-1!==t.indexOf("firefox")?s.postMessage(r,[r.data.buffer]):s.postMessage(r));var t=new ArrayBuffer(m),r=((s=new yt.Stream(e)).readInt32(),new Uint8Array(t)),t=new yt.BIMStream(r,0,1),r=(y.decompress(s,s,t,t.data.length),new yt.Stream(t.data)),i=(f.readBIMBuffer(r,d,a,h),a.length);if(c.ndsGeometriesArray)for(var o=0;o<i;++o)n||c.ndsGeometriesArray[o].copy(c.geometriesArray[o]),c.ndsGeometriesArray[o].loaded=!0,c.ndsGeometriesArray[o].bufferChunkUrl=l;u&&u()}else{c.useWorker&&c.worker&&c.worker.terminate();var s=new yt.Stream(e);try{f.readBIMBufferDraco(s,d,a,h)}catch(e){d&&d(),h&&h()}}i=a.length;if(c.ndsGeometriesArray)for(o=0;o<i;++o)n||c.ndsGeometriesArray[o].copy(c.geometriesArray[o]),c.ndsGeometriesArray[o].loaded=!0,c.ndsGeometriesArray[o].bufferChunkUrl=l}else console.error("Couldn't load ["+l+"] ["+g.status+"]");u&&u()}else 3!==g.readyState&&g.readyState},g.open("GET",l,!0),e)for(var i in e)g.setRequestHeader(i,e[i]);g.responseType="arraybuffer",g.send(null)},$.prototype.parseBvh=function(e,t,r){e=new yt.Stream(e);this.readBvh(e,t,r)},$.prototype.parseBrep=function(e,S,t){if(6==e[0]||7==e[0]){var r=new yt.Stream(e);this.readBrep(r,S.brepManager,null)}else if(8==e[0]){r=new yt.Stream(e);this.readBrep8(r,S.brepManager,null)}else if(9==e[0]){r=new yt.Stream(e);this.readBrep9(r,S.brepManager,null)}else{S.brepManager.type=1;var i,n=function(e){for(var t=e.readByte(),r=(S.brepManager.version=t,e.readInt32()),i={},n=0,n=0;n<r;++n){var a={},o=e.readGuid();if(3<S.brepManager.version)if(e.readByte()){a.referenceBodyUuid=e.readGuid(),i[o]=a;continue}a.area=e.readFloat32(),a.volume=e.readFloat32();var s=e.readInt32();a.edgeGroups=[],i[o]=a;for(var l=0;l<s;++l)for(var d={},c=(a.edgeGroups.push(d),d.meshID=e.readGuid(),d.edges=[],void 0),c=2<t?e.readInt32():e.readInt16(),h=0;h<c;++h){var u={},p=(d.edges.push(u),e.readByte());0==p?(u.type="circle",u.center=[],u.center[0]=e.readFloat32(),u.center[1]=e.readFloat32(),u.center[2]=e.readFloat32(),u.radius=e.readFloat32()):1==p?u.type="line":2==p?u.type="ellipse":3==p?u.type="nurbs":4==p&&(u.type="other"),u.id=e.readInt32(),u.indexRange=[],u.indexRange[0]=e.readInt32(),u.indexRange[1]=e.readInt32(),u.length=e.readFloat32()}var f=e.readInt32();a.faceGroups=[];for(var m=0;m<f;++m)for(var g={},v=(a.faceGroups.push(g),g.meshID=e.readGuid(),g.faces=[],void 0),v=2<t?e.readInt32():e.readInt16(),y=0;y<v;++y){var A={},M=(g.faces.push(A),e.readByte());if(0==M?(A.type="plane",A.origin=[],A.origin[0]=e.readFloat32(),A.origin[1]=e.readFloat32(),A.origin[2]=e.readFloat32(),A.normal=[],A.normal[0]=e.readFloat32(),A.normal[1]=e.readFloat32(),A.normal[2]=e.readFloat32()):1==M?(A.type="cylinder",A.origin=[],A.origin[0]=e.readFloat32(),A.origin[1]=e.readFloat32(),A.origin[2]=e.readFloat32(),A.axis=[],A.axis[0]=e.readFloat32(),A.axis[1]=e.readFloat32(),A.axis[2]=e.readFloat32(),A.radius=e.readFloat32()):2==M?(A.type="cone",4<S.brepManager.version&&(A.origin=[],A.origin[0]=e.readFloat32(),A.origin[1]=e.readFloat32(),A.origin[2]=e.readFloat32(),A.axis=[],A.axis[0]=e.readFloat32(),A.axis[1]=e.readFloat32(),A.axis[2]=e.readFloat32(),A.radius=e.readFloat32())):3==M?A.type="sphere":4==M?A.type="torus":5==M?A.type="nurbs":6==M&&(A.type="other"),A.id=e.readInt32(),A.indexRange=[],A.indexRange[0]=e.readInt32(),A.indexRange[1]=e.readInt32(),A.area=e.readFloat32(),S.brepManager.version<4&&(A.perimeter=e.readFloat32()),1<t){var E=void 0,E=2<t?e.readInt32():e.readInt16();A.edgeIDS=[];for(var w,x=0;x<E;++x)S.brepManager.version<4?A.edgeIDS[x]=e.readInt32():(w={perimeter:e.readFloat32(),startID:e.readInt32()},A.edgeIDS[x]=w)}S.brepManager.version<4&&(0<(M=e.readGuid()).length&&(A.materialID=M),A.thick=e.readFloat32())}var b=e.readInt32(),B=[];b&&(a.vertices=B);for(var I=0;I<b;++I){var T={};B.push(T),T.id=e.readInt32(),T.coords=[],T.coords[0]=e.readFloat32(),T.coords[1]=e.readFloat32(),T.coords[2]=e.readFloat32()}}return i}(new yt.Stream(e));for(i in n)S.brepManager.brepInfos[i]=n[i]}var a,o=!1,s=!1,l=!1,d=2===S.brepManager.type?S.brepManager.brepInfos.breps:S.brepManager.brepInfos;for(a in d)if(1e-9<d[a].volume&&(o=!0),1e-9<d[a].area&&(s=!0),d[a].faceGroups&&0<d[a].faceGroups.length&&(l=!0),1==s&&1==o&&1==l)break;return{BbodyVolume:o,BbodyArea:s,BfaceArea:l}},$.prototype.computeGeometryFaceNormal=function(e){if(e instanceof THREE.Geometry)for(var t=new THREE.Vector3,r=new THREE.Vector3,i=new THREE.Vector3,n=0,a=e.faces.length;n<a;n++){var o,s,l,d=e.faces[n];!0===d.normal.equals(i)&&(o=e.vertices[d.a],s=e.vertices[d.b],l=e.vertices[d.c],t.subVectors(l,s),r.subVectors(o,s),t.cross(r),t.normalize(),d.normal=t.clone())}},$.prototype.createModel=function(o,e){function t(){THREE.BufferGeometry.call(this),this.materials=[];var e,t,r=o.body.indices,i=o.body.vertices,n=o.body.normals,a=o.body.uvMaps;void 0!==a&&0<a.length&&(e=a[0].uv),void 0!==(a=o.body.attrMaps)&&0<a.length&&"Color"===a[0].name&&(t=a[0].attr),this.addAttribute("index",new THREE.BufferAttribute(r,1)),this.addAttribute("position",new THREE.BufferAttribute(i,3)),void 0!==n&&this.addAttribute("normal",new THREE.BufferAttribute(n,3)),void 0!==e&&this.addAttribute("uv",new THREE.BufferAttribute(e,2)),void 0!==t&&this.addAttribute("color",new THREE.BufferAttribute(t,4))}t.prototype=Object.create(THREE.BufferGeometry.prototype);var r=new t;r.computeOffsets(),void 0===r.attributes.normal&&r.computeVertexNormals(),e(r)},$.prototype.readTexture=function(e,t,r){var i=new yt.Stream(e),n=(i.readInt32(),i.readInt32()),a=(n++,4096),o=[];if(2<r)for(var s=a*a,l=0;l<n;l++){for(var e=new Uint8Array(67108864),d=0,c=0;c<s;++c)e[d++]=0,e[d++]=0,e[d++]=0,e[d++]=i.readByte();var h=new THREE.DataTexture(e,a,a);o.push(h)}else for(s=2097152,o=[],l=0;l<n;l++){for(e=new Uint8Array(67108864),d=0,c=0;c<s;++c)for(var h=i.readTexture(),u=0;u<32;u++,d++)e[d]=h[u];h=new THREE.DataTexture(e,a,a);o.push(h)}return o},$.prototype.readBIMBuffer=function(e,t,r,i,n){e.readString();var a=e.readInt32();1===a?this.readBIMBufferVersion1(e,t,r,i):2===a?this.readBIMBufferVersion2(e,t,r,i):3===a?this.readBIMBufferVersion3(e,t,r,i):4===a?this.readBIMBufferVersion4(e,t,r,i):5===a?this.readBIMBufferVersion5(e,t,r,i):6===a?this.readBIMBufferVersion6(e,t,r,i):7===a?this.readBIMBufferVersion7(e,t,r,i,n):8===a?this.readBIMBufferVersion8(e,t,r,i,n):9===a&&this.readBIMBufferVersion9(e,t,r,i,n)},$.prototype.readMultipleBIMBuffer=function(e,t,r,i,n){for(var a=e.length,o=[],s=[],l=-1,d=0;d<a;++d){var c=e[d],h=(c.readString(),c.readInt32()),l=h,h=c.readInt32(),h=(o.push(h),c.readInt32(),c.readInt32());s.push(h)}8===l?this.readMultipleBIMBuffersVersion8(e,t,r,i,n,o,s):9===l&&this.readMultipleBIMBuffersVersion9(e,t,r,i,n,o,s)},$.prototype.readBIMBufferDraco=function(e,O,F,U){for(var t,r,i,N,V,G,n=0,a=0,k=0,j=F.length,z=new Int8Array(j),W=new Int8Array(j),X=!1,o=0;o<j;++o)t=F[o],z[o]=t.index?0:1,W[o]=t.index&&!t.index.array?1:0,W[o]&&(X=!0);for(var s=[],o=0;o<j;++o){var l,d=e.readInt64(),c=(n+=8,new this.DracoModule.DecoderBuffer),h=(c.Init(e.data.slice(n,n+d),d),new this.DracoModule.Decoder),d=(n+=d,e.offset+=d,h.GetEncodedGeometryType(c)),q=(d==this.DracoModule.TRIANGULAR_MESH?(l=new this.DracoModule.Mesh,h.DecodeBufferToMesh(c,l)):d==this.DracoModule.POINT_CLOUD&&(l=new this.DracoModule.PointCloud,h.DecodeBufferToPointCloud(c,l)),this.DracoModule.destroy(c),[]);if(d==this.DracoModule.POINT_CLOUD){var Y=e.readInt32();n+=4;for(var u=0;u<Y/4;++u)q.push(e.readInt32()),n+=4}var Q,K,Z,c=h.GetAttributeId(l,this.DracoModule.NORMAL),p=(-1!=c&&(p=h.GetAttribute(l,c),Q=new this.DracoModule.DracoFloat32Array,h.GetAttributeFloatForAllPoints(l,p,Q)),h.GetAttributeId(l,this.DracoModule.TEX_COORD)),f=(-1!=p&&(f=h.GetAttribute(l,p),K=new this.DracoModule.DracoFloat32Array,h.GetAttributeFloatForAllPoints(l,f,K)),h.GetAttributeId(l,this.DracoModule.COLOR)),J=(-1!=f&&(J=h.GetAttribute(l,f),Z=new this.DracoModule.DracoFloat32Array,h.GetAttributeFloatForAllPoints(l,J,Z)),h.GetAttributeId(l,this.DracoModule.POSITION)),m=h.GetAttribute(l,J),$=new this.DracoModule.DracoFloat32Array,m=(h.GetAttributeFloatForAllPoints(l,m,$),t=F[o],z[o]),g=W[o];if(d==this.DracoModule.TRIANGULAR_MESH){var v,y,A=l.num_points(),M=-1==h.GetAttributeId(l,this.DracoModule.COLOR)?0:A,E=-1==h.GetAttributeId(l,this.DracoModule.TEX_COORD)?0:A,w=-1==h.GetAttributeId(l,this.DracoModule.NORMAL)?0:A,ee=l.num_faces(),x=0<(M=0<M&&M!==A?0:M)?3:0,b=0<(E=0<E&&E!==A?0:E)?2:0,B=0<(w=0<w&&w!==A?0:w)?3:0,w=3+x+b+B,k=(m?(r=new Float32Array(A*w),i=new THREE.InterleavedBuffer(r,w),Ee=new THREE.InterleavedBufferAttribute(i,3,0,!1),N=new THREE.InterleavedBufferAttribute(i,x,3,!1),V=new THREE.InterleavedBufferAttribute(i,b,3+x,!1),G=new THREE.InterleavedBufferAttribute(i,B,3+x+b,!1)):i=g?(t.attributes.position.data.array=new Float32Array(A*w),r=t.attributes.position.data.array,t.attributes.position.data):r=null,a=0,we=m?(H=new(A<=65535?Uint16Array:Uint32Array)(3*ee),new THREE.BufferAttribute(H,1)):g?(t.index.array=new(A<=65535?Uint16Array:Uint32Array)(3*ee),H=t.index.array,t.index):H=null,0),I=l.num_points(),T=-1==h.GetAttributeId(l,this.DracoModule.COLOR)?0:I,te=-1==h.GetAttributeId(l,this.DracoModule.TEX_COORD)?0:I,re=-1==h.GetAttributeId(l,this.DracoModule.NORMAL)?0:I,S=l.num_faces(),ee=new THREE.Vector3,ie=new THREE.Vector3,R=0,C=3+(x=0<T?3:0)+(b=0<te?2:0)+(B=0<re?3:0),ne=!1,ae=!1;if(r?(0===M&&0<T&&(ne=!0,C-=x),0===E&&0<te&&(ae=!0,C-=b),v=r,y=i):(y=m?(v=new Float32Array(I*C),new THREE.InterleavedBuffer(v,C)):g?(t.attributes.position.data.array=new Float32Array(I*C),v=t.attributes.position.data.array,t.attributes.position.data):v=null,k=a=0),0<I){for(u=0;u<I;++u)for(L=0;L<3;++L)v&&(v[a+u*C+L]=$.GetValue(3*u+L));m&&(t.attributes.position=r?Ee:new THREE.InterleavedBufferAttribute(y,3,0,!1)),R+=3}if(0<T)if(ne)for(u=0;u<T;++u)for(L=0;L<x;++L)e.readByte();else{for(u=0;u<T;++u)for(L=0;L<x;++L)v?v[a+u*C+R+L]=e.readByte()*(1/255):e.readByte();m&&(t.attributes.color=r?N:new THREE.InterleavedBufferAttribute(y,x,R,!1)),R+=x}if(0<te)if(ae)for(u=0;u<te;++u)for(L=0;L<b;++L)e.readFloat32();else{for(u=0;u<te;++u)for(L=0;L<b;++L)v?v[a+u*C+R+L]=e.readFloat32():e.readFloat32();m&&(t.attributes.uv=r?V:new THREE.InterleavedBufferAttribute(y,b,R,!1)),R+=b}if(0<re){for(u=0;u<re;++u)for(L=0;L<B;++L)v&&(v[a+u*C+R+L]=Q.GetValue(u*B+L));m&&(t.attributes.normal=r?G:new THREE.InterleavedBufferAttribute(y,B,R,!1))}if(0<S){for(var oe=3*S,se=0,le=(se=r?(P=H,_=we,a/C):(_=m?(P=new(I<=65535?Uint16Array:Uint32Array)(oe),new THREE.BufferAttribute(P,1)):g?(t.index.array=new(I<=65535?Uint16Array:Uint32Array)(oe),P=t.index.array,t.index):P=null,0),new this.DracoModule.DracoInt32Array),D=0;D<S;++D){h.GetFaceFromMesh(l,D,le);var de=3*D;P[de]=le.GetValue(0),P[1+de]=le.GetValue(1),P[2+de]=le.GetValue(2)}m&&(t.setIndex(_),t.drawRange.start=k,t.drawRange.count=oe)}r&&(k+=3*S,A*w<=(a+=I*C))&&(r=null,k=a=0)}else if(d==this.DracoModule.POINT_CLOUD){if(I=l.num_points(),S=q.length,m&&0<I&&s.push(t),0<I){var oe=3*I,ce=new Float32Array(oe);for(D=0;D<oe;++D)ce[D]=$.GetValue(D);m&&t.addAttribute("position",new THREE.BufferAttribute(ce,3))}if(0<S){for(var P=new(I<=65535?Uint16Array:Uint32Array)(S),u=0;u<q.length;++u)P[u]=q[u];if(!1===De.OES_element_index_uint&&65535<I&&0===nLineIndexSorted){var he=new Uint16Array(S),ue=0,pe=0,fe=1,me=0;for(D=0;D<S-1;D+=2)P[D]<=65535*fe&&P[D+1]<=65535*fe?(pe+=2,he[D]=P[D]-ue,he[D+1]=P[D+1]-ue):(t.addDrawCall(me,pe,ue),me=D,pe=0,D-=2,ue+=65535*(++fe-1));1!==fe&&t.addDrawCall(me,pe,ue),t.setIndex(new THREE.BufferAttribute(he,1))}else m&&t.setIndex(new THREE.BufferAttribute(P,1))}}t.boundingBox||(ee.equals(ie)?(t.boundingBox=null,t.attributes.position&&t.computeBoundingBox()):t.boundingBox=new THREE.Box3(ee,ie)),this.DracoModule.destroy($),-1!=f&&this.DracoModule.destroy(Z),-1!=c&&this.DracoModule.destroy(Q),-1!=p&&this.DracoModule.destroy(K),this.DracoModule.destroy(h),this.DracoModule.destroy(l),De.OES_element_index_uint,t.boundingSphere=null,m?O&&O():g&&!r&&O&&O(t)}if(!X&&0<s.length){for(var ge=0,ve=0,u=0,ye=s.length;u<ye;++u)ge+=s[u].attributes.position.array.length,ve+=s[u].index.array.length;for(var Ae=ge/3,Me=new Float32Array(ge),H=new(Ae<=65535?Uint16Array:Uint32Array)(ve),Ee=new THREE.BufferAttribute(Me,3),we=new THREE.BufferAttribute(H,1),R=0,xe=0,u=0,ye=s.length;u<ye;++u){for(var be=s[u].attributes.position,_=s[u].index,se=(s[u].attributes.position=Ee,s[u].setIndex(we),s[u].drawRange.start=xe,s[u].drawRange.count=_.array.length,R/3),L=0,Be=_.array.length;L<Be;++L)H[xe+L]=_.array[L]+se;xe+=_.array.length;for(var Ie=0,Te=be.array.length;Ie<Te;++Ie)Me[R+Ie]=be.array[Ie];R+=be.array.length}}U&&U()},$.prototype.readBIMBufferVersion7=function(e,O,F,U,N){for(var V=e.readInt32(),G=(e.readInt32(),e.readInt32()),k=[],t=(NDSWebViewer.Viewer.renderer.context,0);t<G;++t){var r=e.readInt32(),i=e.readInt32(),n=e.readInt32(),a=e.readInt32(),o=e.readInt32(),s=new THREE.BufferGeometry,j=0<i?3:0,z=0<n?2:0,l=0<a?3:0,d=r/3;if(0<r&&(r=new Float32Array(r),e.readArrayFloat32(r),s.addAttribute("position",new THREE.BufferAttribute(r,3,0,!1))),0<i){for(var c=new Uint8Array(i),W=0;W<d;++W)c[12]=e.readByte(),c[13]=e.readByte(),c[14]=e.readByte(),c[15]=255;s.addAttribute("color",new THREE.BufferAttribute(c,j,0,!0))}if(0<n&&(r=new Float32Array(n),e.readArrayFloat32(r),s.addAttribute("uv",new THREE.BufferAttribute(r,z,0,!1))),0<a){var h=new Float32Array(a);if(4===o)for(var u=0;u<d;++u)h[3*u+0]=e.readFloat32(),h[3*u+1]=e.readFloat32(),h[3*u+2]=e.readFloat32();else{var X=new Int32Array([1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1]),p=void 0,q=1===o?1/255:1/65535;if(1===o)for(var f=0;f<d;++f){p=e.readByte(),--p;for(var m=0;m<l;++m){var Y=e.readByte();h[3*f+m]=X[3*p+m]*Y*q}}else if(2===o)for(var g=0;g<d;++g){p=e.readByte(),--p;for(var v=0;v<l;++v)h[3*g+v]=X[3*p+v]*e.readInt16()*q}}s.addAttribute("normal",new THREE.BufferAttribute(h,l,0,!1))}var y=e.readInt32(),A=e.readInt32(),M=e.readInt32();if(0<y){for(var Q=new(65535<d?Uint32Array:256<d?Uint16Array:Uint8Array)(y),K=0;K<y;++K)Q[K]=e.readInt32();s.setIndex(new THREE.BufferAttribute(Q,1)),s.attributes.normal}if(0<A){for(var Z,E,w,x=new(65535<d?Uint32Array:256<d?Uint16Array:Uint8Array)(A),b=s.getAttribute("position"),B=N?new Float32Array(3*b.count):null,J=new THREE.Vector3,$=new THREE.Vector3,ee=new THREE.Vector3,te=0,I=0;I<A;I+=2)x[I]=e.readInt32(),x[I+1]=e.readInt32(),B&&(E=x[I],w=x[I+1],J.fromBufferAttribute(b,E),$.fromBufferAttribute(b,w),Z=$.distanceTo(J),0!=I&&te==E?(B[3*E]=B[3*te],B[3*w]=Z+B[3*E]):B[3*w]=Z,ee.copy($),te=w);if(s.addAttribute("lineIndices",new THREE.BufferAttribute(x,1)),B){for(var T=0,re=0,S=0;S<b.count;S++)if(0===B[3*S]){if(T<S)for(var re=B[3*(S-1)],ie=T;ie<S;ie++)B[3*ie+1]=re;T=S}for(var ne=T;ne<b.count;ne++)re=B[3*(b.count-1)],B[3*ne+1]=re;s.addAttribute("lineDistance",new THREE.BufferAttribute(B,3))}}if(0<M){for(var ae=new(65535<d?Uint32Array:256<d?Uint16Array:Uint8Array)(M),oe=0;oe<M;++oe)ae[oe]=e.readInt32();s.addAttribute("pointIndices",new THREE.BufferAttribute(ae,1))}k[t]=s}for(var R=new THREE.Vector3,C=new THREE.Vector3,se=0;se<V;++se){var D=e.readInt32(),P=(R.x=e.readFloat32(),R.y=e.readFloat32(),R.z=e.readFloat32(),C.x=e.readFloat32(),C.y=e.readFloat32(),C.z=e.readFloat32(),e.readInt32()),H=e.readInt32(),_=e.readInt32(),L=F[se],P=(L.geomType,k[P]);P.attributes.position&&(L.attributes.position=P.attributes.position),P.attributes.normal&&(L.attributes.normal=P.attributes.normal),P.attributes.color&&(L.attributes.color=P.attributes.color),P.attributes.lineDistance&&(L.attributes.lineDistance=P.attributes.lineDistance),P.uv,P.normal,P.validEntities,0===D?(L.isTriangles=!0,P.index?(L.setIndex(P.index),L.drawRange.start=H,L.drawRange.count=_):(L.drawRange.start=-H,L.drawRange.count=-_)):1===D?(L.isLines=!0,P.attributes.lineIndices?(L.setIndex(P.attributes.lineIndices),L.drawRange.start=H,L.drawRange.count=_):(L.drawRange.start=-H,L.drawRange.count=-_)):2===D&&(L.isPoints=!0,P.attributes.pointIndices?(L.setIndex(P.attributes.pointIndices),L.drawRange.start=H,L.drawRange.count=_):(L.drawRange.start=-H,L.drawRange.count=-_)),(!L.boundingBox||L.boundingBox.min.x>L.boundingBox.max.x||L.boundingBox.min.y>L.boundingBox.max.y||L.boundingBox.min.z>L.boundingBox.max.z)&&R.equals(C)?(L.boundingBox=null,L.attributes.position&&L.computeBoundingBox()):L.boundingBox.set(R,C),0===D&&L.attributes.normal,L.boundingSphere=null,O&&O()}U&&U()},$.prototype.readBIMBufferVersion8=function(e,O,F,U,N){for(var V=e.readInt32(),G=(e.readInt32(),e.readInt32()),k=[],t=new Map,r=0;r<G;++r){var i=e.readInt32(),n=e.readInt32(),a=e.readInt32(),o=e.readInt32(),s=e.readInt32(),l=new THREE.BufferGeometry,j=0<n?3:0,z=0<a?2:0,d=0<o?3:0,W=(d<<12)+(z<<8)+(j<<4)+3,c=i/3;if(0<i&&(i=new Float32Array(i),e.readArrayFloat32(i),l.addAttribute("position",new THREE.BufferAttribute(i,3,!1))),0<n){for(var h=new Uint8Array(n),X=0;X<c;++X)h[12]=e.readByte(),h[13]=e.readByte(),h[14]=e.readByte(),h[15]=255;l.addAttribute("color",new THREE.BufferAttribute(h,j,!0))}if(0<a&&(i=new Float32Array(a),e.readArrayFloat32(i),l.addAttribute("uv",new THREE.BufferAttribute(i,z,!1))),0<o){var u=new Int8Array(o);if(4===s)for(var p=0;p<c;++p)u[3*p+0]=127*e.readFloat32(),u[3*p+1]=127*e.readFloat32(),u[3*p+2]=127*e.readFloat32();else{var q=new Int32Array([1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1]),f=void 0,Y=1===s?127/255:127/65535;if(1===s)for(var m=0;m<c;++m){f=e.readByte(),--f;for(var g=0;g<d;++g){var Q=e.readByte();u[3*m+g]=q[3*f+g]*Q*Y}}else if(2===s)for(var v=0;v<c;++v){f=e.readByte(),--f;for(var y=0;y<d;++y)u[3*v+y]=q[3*f+y]*e.readInt16()*Y}l.addAttribute("normal",new THREE.BufferAttribute(u,d,!1))}}var A=e.readInt32(),M=e.readInt32(),K=e.readInt32();if(0<A){for(var Z=new(65535<c?Uint32Array:256<c?Uint16Array:Uint8Array)(A),J=0;J<A;++J)Z[J]=65535<c?e.readInt32():256<c?e.readUInt16():e.readUInt8();l.setIndex(new THREE.BufferAttribute(Z,1)),l.attributes.normal}if(0<M){for(var $,E,w,x=new(65535<c?Uint32Array:256<c?Uint16Array:Uint8Array)(M),b=l.getAttribute("position"),B=N?new Float32Array(3*b.count):null,ee=new THREE.Vector3,te=new THREE.Vector3,re=new THREE.Vector3,ie=0,I=0;I<M;I+=2)x[I]=65535<c?e.readInt32():256<c?e.readUInt16():e.readUInt8(),x[I+1]=65535<c?e.readInt32():256<c?e.readUInt16():e.readUInt8(),B&&(E=x[I],w=x[I+1],ee.fromBufferAttribute(b,E),te.fromBufferAttribute(b,w),$=te.distanceTo(ee),0!=I&&ie==E?(B[3*E]=B[3*ie],B[3*w]=$+B[3*E]):B[3*w]=$,re.copy(te),ie=w);if(l.addAttribute("lineIndices",new THREE.BufferAttribute(x,1)),B){for(var T=0,ne=0,S=0;S<b.count;S++)if(0===B[3*S]){if(T<S)for(var ne=B[3*(S-1)],ae=T;ae<S;ae++)B[3*ae+1]=ne;T=S}for(var oe=T;oe<b.count;oe++)ne=B[3*(b.count-1)],B[3*oe+1]=ne;l.addAttribute("lineDistance",new THREE.BufferAttribute(B,3))}}if(0<K){for(var se=new(65535<c?Uint32Array:256<c?Uint16Array:Uint8Array)(K),le=0;le<K;++le)se[le]=65535<c?e.readInt32():256<c?e.readUInt16():e.readUInt8();l.addAttribute("pointIndices",new THREE.BufferAttribute(se,1))}t.set(W,{nTotalLine:M}),k[r]=l}for(var R=new THREE.Vector3,C=new THREE.Vector3,de=0;de<V;++de){var D=e.readInt32(),ce=(R.x=e.readFloat32(),R.y=e.readFloat32(),R.z=e.readFloat32(),C.x=e.readFloat32(),C.y=e.readFloat32(),C.z=e.readFloat32(),e.readInt32()),P=e.readInt32(),H=e.readInt32(),_=1===t.size||2===t.size&&t.has(3)&&0<t.get(3).nTotalLine,L=F[de],_=(L.geomType,_||(L.supportMultiDraw=_),k[ce]);L.id=_.id,_.attributes.position&&(L.attributes.position=_.attributes.position),_.attributes.normal&&(L.attributes.normal=_.attributes.normal),_.attributes.color&&(L.attributes.color=_.attributes.color),_.attributes.lineDistance&&(L.attributes.lineDistance=_.attributes.lineDistance),_.uv,_.normal,_.validEntities,0===D?(L.isTriangles=!0,_.index?(L.setIndex(_.index),L.drawRange.start=P,L.drawRange.count=H):(L.drawRange.start=-P,L.drawRange.count=-H)):1===D?(L.isLines=!0,_.attributes.lineIndices?(L.setIndex(_.attributes.lineIndices),L.drawRange.start=P,L.drawRange.count=H):(L.drawRange.start=-P,L.drawRange.count=-H)):2===D&&(L.isPoints=!0,_.attributes.pointIndices?(L.setIndex(_.attributes.pointIndices),L.drawRange.start=P,L.drawRange.count=H):(L.drawRange.start=-P,L.drawRange.count=-H)),(!L.boundingBox||L.boundingBox.min.x>L.boundingBox.max.x||L.boundingBox.min.y>L.boundingBox.max.y||L.boundingBox.min.z>L.boundingBox.max.z)&&R.equals(C)?(L.boundingBox=null,L.attributes.position&&L.computeBoundingBox()):L.boundingBox.set(R,C),0===D&&L.attributes.normal,L.boundingSphere=null,O&&O()}U&&U()},$.prototype.readMultipleBIMBuffersVersion8=function(e,O,F,U,N,V,G){for(var t=e.length,r=-1,i=new Map,k=[],j=function(e){var t=e.readInt32(),r=e.readInt32(),i=e.readInt32(),n=e.readInt32(),a=0<t?3:0,o=0<r?3:0,s=0<i?2:0,l=0<n?3:0;return{nVertexCount:t,nVertexColorsCount:r,nUVCount:i,nNormalCount:n,nNormalBit:e.readInt32(),vertexItemSize:a,colorItemSize:o,uvItemSize:s,normalItemSize:l,numVertexItem:t/a,strideMapKey:(l<<12)+(s<<8)+(o<<4)+a}},z=e,n=0;n<t;++n){var a=z[n];-1===r&&(r=a.offset);for(var W=0,X=G[n];W<X;++W){var o=j(a),q=void 0,Y=o.nVertexCount,Q=o.nVertexColorsCount,K=o.nUVCount,Z=o.nNormalCount,J=o.nNormalBit,$=o.vertexItemSize,ee=o.colorItemSize,te=o.uvItemSize,re=o.normalItemSize,s=o.numVertexItem,ie=o.strideMapKey;if(i.has(ie)?(i.get(o.strideMapKey).totalVertexCount+=Y,i.get(o.strideMapKey).totalVertexColorsCount+=Q,i.get(o.strideMapKey).totalUVCount+=K,i.get(o.strideMapKey).totalNormalCount+=Z,i.get(o.strideMapKey).totalNumVertexItem+=s):i.set(ie,{totalVertexCount:Y,totalVertexColorsCount:Q,totalUVCount:K,totalNormalCount:Z,totalNumVertexItem:s,nNormalBit:J,vertexItemSize:$,colorItemSize:ee,uvItemSize:te,normalItemSize:re,numVertexItem:s,nTotalFace:0,nTotalFaceIndexBufferSize:0,nTotalLine:0,nTotalLineIndexBufferSize:0,nTotalPoint:0,nTotalPointIndexBufferSize:0,faceDrawStartOffsets:[],lineDrawStartOffsets:[],pointDrawStartOffsets:[]}),q=i.get(o.strideMapKey),0<Y)for(var ne=0;ne<s;++ne)for(var ae=0;ae<$;++ae)a.skipFloat32();if(0<Q)for(var oe=0;oe<s;++oe)a.skipByte(),a.skipByte(),a.skipByte();if(0<K)for(var se=0;se<s;++se)for(var le=0;le<te;++le)a.skipFloat32();if(0<Z)if(4===J)for(var de=0;de<s;++de)a.skipFloat32(),a.skipFloat32(),a.skipFloat32();else if(1===J)for(var ce=0;ce<s;++ce){a.skipByte(),0;for(var he=0;he<re;++he)a.skipByte()}else if(2===J)for(var ue=0;ue<s;++ue){a.skipByte(),0;for(var pe=0;pe<re;++pe)a.skipInt16()}var fe=a.readInt32(),me=a.readInt32(),ge=a.readInt32();if(q.nTotalFace+=fe,q.nTotalLine+=me,q.nTotalPoint+=ge,0<fe)for(var ve=0;ve<fe;++ve)65535<s?a.skipInt32():256<s?a.skipUInt16():a.skipUInt8();if(0<me)for(var ye=0;ye<me;ye+=2)65535<s?a.skipInt32():256<s?a.skipUInt16():a.skipUInt8(),65535<s?a.skipInt32():256<s?a.skipUInt16():a.skipUInt8();if(0<ge)for(var Ae=0;Ae<ge;++Ae)65535<s?a.skipInt32():256<s?a.skipUInt16():a.skipUInt8();W===k.length&&k.push([]),k[W][n]=o.strideMapKey}}for(var Me=0;Me<t;++Me)e[Me].seek(-1===r?0:r);for(var Ee=It(i);!(l=Ee()).done;){var l=l.value,l=(l[0],l[1]),d=l.totalNumVertexItem,we=l.vertexItemSize,xe=l.colorItemSize,be=l.uvItemSize,Be=l.normalItemSize,Ie=Math.max(0,l.nTotalFace),Te=Math.max(0,l.nTotalLine),Se=Math.max(0,l.nTotalPoint),we=(0<we&&(l.vertexArray=new Float32Array(d*we),l.positionAttrib=new THREE.BufferAttribute(l.vertexArray,we,!1)),0<xe&&(l.colorArray=new Uint8Array(d*xe),l.colorAttrib=new THREE.BufferAttribute(l.colorArray,xe,!0)),0<be&&(l.uvArray=new Float32Array(d*be),l.uvAttrib=new THREE.BufferAttribute(l.uvArray,be,!1)),0<Be&&(l.normalArray=new Int8Array(d*Be),l.normalAttrib=new THREE.BufferAttribute(l.normalArray,Be,!0)),new THREE.BufferGeometry);0<Ie&&(l.faceIndices=new(65535<d?Uint32Array:256<d?Uint16Array:Uint8Array)(Ie)),0<Te&&(l.lineIndices=new(65535<d?Uint32Array:256<d?Uint16Array:Uint8Array)(Te),N)&&(l.lineDistance=new Float32Array(totalVertexCount)),0<Se&&(l.pointIndices=new(65535<d?Uint32Array:256<d?Uint16Array:Uint8Array)(Se)),l.bufferGeom=we,l.currentVertexCount=0,l.currentFaceCount=0,l.currentLineCount=0,l.currentPointCount=0,l.vertexBufferOffset=0,l.colorBufferOffset=0,l.uvBufferOffset=0,l.normalBufferOffset=0}for(var Re,Ce,De,c=0;c<t;++c)for(var h=e[c],Pe=0,He=G[c];Pe<He;++Pe){var u=j(h),_e=u.nVertexColorsCount,Le=u.nUVCount,Oe=u.nNormalCount,Fe=u.nNormalBit,Ue=u.vertexItemSize,Ne=u.colorItemSize,Ve=u.uvItemSize,p=u.normalItemSize,f=u.numVertexItem,u=u.strideMapKey,m=i.get(u),Ge=m.vertexArray,ke=m.colorArray,je=m.uvArray,g=m.normalArray,ze=m.faceIndices,v=m.lineIndices,y=m.lineDistance,We=m.pointIndices,Xe=m.vertexBufferOffset,qe=m.colorBufferOffset,Ye=m.uvBufferOffset,A=m.normalBufferOffset;if(0<f&&Ge){for(var Qe=0;Qe<f;++Qe)for(var Ke=0;Ke<Ue;++Ke)Ge[Qe*Ue+Ke+Xe]=h.readFloat32();m.vertexBufferOffset+=f*Ue}if(0<_e&&ke){for(var M=0;M<f;++M)ke[M*Ne+0+qe]=h.readByte(),ke[M*Ne+1+qe]=h.readByte(),ke[M*Ne+2+qe]=h.readByte();m.colorBufferOffset+=f*Ne}if(0<Le&&je){for(var Ze=0;Ze<f;++Ze)for(var Je=0;Je<Ve;++Je)je[Ze*Ve+Je+Ye]=h.readFloat32();m.uvBufferOffset+=f*Ve}if(0<Oe&&g){if(4===Fe)for(var E=0;E<f;++E)g[E*p+0+A]=127*h.readFloat32(),g[E*p+1+A]=127*h.readFloat32(),g[E*p+2+A]=127*h.readFloat32();else{var $e=new Int32Array([1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1]),w=void 0,et=1===Fe?127/255:127/65535;if(1===Fe)for(var tt=0;tt<f;++tt){w=h.readByte(),--w;for(var rt=0;rt<p;++rt){var it=h.readByte();g[tt*p+rt+A]=$e[3*w+rt]*it*et}}else if(2===Fe)for(var nt=0;nt<f;++nt){w=h.readByte(),--w;for(var at=0;at<p;++at)g[nt*p+at+A]=$e[3*w+at]*h.readInt16()*et}}m.normalBufferOffset+=f*p}var ot=h.readInt32(),st=h.readInt32(),lt=h.readInt32();if(0<ot){Re=m.currentFaceCount,m.faceDrawStartOffsets[c]=Re;for(var dt=0;dt<ot;++dt)ze[dt+Re]=m.currentVertexCount+(65535<f?h.readInt32():256<f?h.readUInt16():h.readUInt8());m.currentFaceCount+=ot}if(0<st){Ce=m.currentLineCount,m.lineDrawStartOffsets[c]=Ce;for(var ct,ht=new THREE.Vector3,ut=new THREE.Vector3,pt=new THREE.Vector3,ft=0,mt=m.bufferGeom.getAttribute("position"),gt=0;gt<st;gt+=2){var x=gt+Ce;v[x]=m.currentVertexCount+(65535<f?h.readInt32():256<f?h.readUInt16():h.readUInt8()),v[x+1]=m.currentVertexCount+(65535<f?h.readInt32():256<f?h.readUInt16():h.readUInt8()),y&&(ht.fromBufferAttribute(mt,v[x]),ut.fromBufferAttribute(mt,v[x+1]),ct=ut.distanceTo(ht),0!=gt&&ht.equals(pt)?(y[v[x]]=y[ft],y[v[x+1]]=ct+y[v[x]]):y[v[x+1]]=ct,pt.copy(ut),ft=v[x+1])}m.currentLineCount+=st}if(0<lt){De=m.currentPointCount,m.pointDrawStartOffsets[c]=De;for(var vt=0;vt<lt;++vt)We[vt+De]=m.currentVertexCount+(65535<f?h.readInt32():256<f?h.readUInt16():h.readUInt8());m.currentPointCount+=lt}m.currentVertexCount+=f}for(var yt=It(i);!(b=yt()).done;){var b=b.value,b=(b[0],b[1]),B=b.bufferGeom,At=b.positionAttrib,Mt=b.colorAttrib,Et=b.uvAttrib,wt=b.normalAttrib;0<b.totalVertexCount&&(B.attributes.position=At),0<b.totalVertexColorsCount&&(B.attributes.color=Mt),0<b.totalUVCount&&(B.attributes.uv=Et),0<b.totalNormalCount&&(B.attributes.normal=wt),0<b.nTotalFace&&B.setIndex(new THREE.BufferAttribute(b.faceIndices,1)),0<b.nTotalLine&&(B.addAttribute("lineIndices",new THREE.BufferAttribute(b.lineIndices,1)),b.lineDistance)&&B.addAttribute("lineDistance",new THREE.BufferAttribute(b.lineDistance,1)),0<b.nTotalPoint&&B.addAttribute("pointIndices",new THREE.BufferAttribute(b.pointIndices,1))}for(var I=new THREE.Vector3,T=new THREE.Vector3,S=0;S<t;++S)for(var R=e[S],xt=V[S],bt=0;bt<xt;++bt){var Bt=R.readInt32(),C=(I.x=R.readFloat32(),I.y=R.readFloat32(),I.z=R.readFloat32(),T.x=R.readFloat32(),T.y=R.readFloat32(),T.z=R.readFloat32(),R.readInt32()),D=R.readInt32(),P=R.readInt32(),C=k[C][S],C=i.get(C),H=1===i.size||2===i.size&&i.has(3)&&0<i.get(3).nTotalLine,_=C.bufferGeom,L=F[S][bt];L.geomType,L.id=_.id,_.attributes.position&&(L.attributes.position=_.attributes.position),_.attributes.normal&&(L.attributes.normal=_.attributes.normal),_.attributes.color&&(L.attributes.color=_.attributes.color),_.attributes.lineDistance&&(L.attributes.lineDistance=_.attributes.lineDistance),_.attributes.uv&&(L.attributes.uv=_.attributes.uv),_.normal,_.validEntities,H||(L.supportMultiDraw=H),0===Bt?(L.isTriangles=!0,H=C.faceDrawStartOffsets[S],_.index?(L.setIndex(_.index),L.drawRange.start=D+H,L.drawRange.count=P):(L.drawRange.start=-D,L.drawRange.count=-P)):1===Bt?(L.isLines=!0,H=C.lineDrawStartOffsets[S],_.attributes.lineIndices?(L.setIndex(_.attributes.lineIndices),L.drawRange.start=D+H,L.drawRange.count=P):(L.drawRange.start=-D,L.drawRange.count=-P)):2===Bt&&(L.isPoints=!0,H=C.pointDrawStartOffsets[S],_.attributes.pointIndices?(L.setIndex(_.attributes.pointIndices),L.drawRange.start=D+H,L.drawRange.count=P):(L.drawRange.start=-D,L.drawRange.count=-P)),(!L.boundingBox||L.boundingBox.min.x>L.boundingBox.max.x||L.boundingBox.min.y>L.boundingBox.max.y||L.boundingBox.min.z>L.boundingBox.max.z)&&I.equals(T)?(L.boundingBox=null,L.attributes.position&&L.computeBoundingBox()):L.boundingBox.set(I,T),0===Bt&&L.attributes.normal,L.boundingSphere=null,O&&O()}U&&U()},new ArrayBuffer(10485760)),de=($.prototype.readBIMBufferVersion9=function(e,O,F,U,N){for(var t,r,i,n,a,o,V=lt,G=e.readInt32(),k=(e.readInt32(),e.readInt32()),j=[],z=!1,s=(this.ndsModel&&(this.ndsModel.isECAD2DModel||this.ndsModel.isECAD3DModel)&&(z=!0),new Map),W=0;W<k;++W){var l=e.readInt32(),d=e.readInt32(),c=e.readInt32(),h=e.readInt32(),u=e.readInt32(),X=((0<u?3:0)<<12)+((0<h?2:0)<<8)+((0<c?4:0)<<4)+(0<l?3:0),p=new THREE.BufferGeometry;if(0<d&&(e.readFloat32(),e.readFloat32(),e.readFloat32(),d=new Float32Array(3*l),e.readArrayFloat32(d),p.addAttribute("position",new THREE.BufferAttribute(d,3,!1))),0<c&&(d=new Uint8Array(ct(c),0,c),e.readArrayUint8(d),c=new Uint8Array(3*l),V.decodeVertexBuffer(c,l,3,d),p.addAttribute("color",new THREE.BufferAttribute(c,3,!0))),0<h)if(z){for(var q=new Int32Array(l),Y=0;Y<l;++Y)q[Y]=e.readFloat32()+.1,e.skipFloat32();p.addAttribute("uv",new THREE.BufferAttribute(q,1,!1))}else{d=new Float32Array(2*l);e.readArrayFloat32(d),p.addAttribute("uv",new THREE.BufferAttribute(d,2,!1))}if(0<u){for(var Q=new Int16Array(ct(2*l*2),0,2*l),K=(e.readArrayInt16(Q),new Int8Array(3*l)),Z=0;Z<l;++Z)r=K,o=a=n=void 0,n=(t=Q)[2*(i=Z)+0]/2047,t=t[2*i+1]/2047,a=1-(Math.abs(n)+Math.abs(t)),o=Math.max(-a,0),n+=0<=n?-o:o,t+=0<=t?-o:o,o=1/Math.sqrt(n*n+t*t+a*a),r[3*i+0]=n*o*127,r[3*i+1]=t*o*127,r[3*i+2]=a*o*127;p.addAttribute("normal",new THREE.BufferAttribute(K,3,!0))}c=e.readInt32(),h=e.readInt32(),d=e.readInt32(),u=0;if(0<c){var f=e.readInt32(),c=new Uint8Array(ct(c),0,c),m=(e.readArrayUint8(c),new ArrayBuffer(4*f)),J=(V.decodeIndexBuffer(new Uint8Array(m),f,4,c),new Uint32Array(m,0,f)),g=J;if(!(65535<l))if(256<=l)for(var g=new Uint16Array(f),v=0;v<f;++v)g[v]=J[v];else{g=new Uint8Array(f);for(var y=0;y<f;++y)g[y]=J[y]}p.setIndex(new THREE.BufferAttribute(g,1)),p.attributes.normal}if(0<h){var A=e.readInt32(),u=A,c=new Uint8Array(ct(h),0,h),m=(e.readArrayUint8(c),new ArrayBuffer(4*A)),$=(V.decodeIndexSequence(new Uint8Array(m),A,4,c),new Uint32Array(m,0,A)),M=$;if(!(65535<l))if(256<=l)for(var M=new Uint16Array(A),E=0;E<A;++E)M[E]=$[E];else{M=new Uint8Array(A);for(var w=0;w<A;++w)M[w]=$[w]}if(p.addAttribute("lineIndices",new THREE.BufferAttribute(M,1)),N){for(var ee,x,b,B=p.getAttribute("position"),I=new Float32Array(3*B.count),te=new THREE.Vector3,re=new THREE.Vector3,ie=new THREE.Vector3,ne=0,T=0;T<A;T+=2)x=M[T],b=M[T+1],te.fromBufferAttribute(B,x),re.fromBufferAttribute(B,b),ee=re.distanceTo(te),0==T||ne!=x&&!ie.equals(te)?I[3*b]=ee:(I[3*x]=I[3*ne],I[3*b]=ee+I[3*x]),ie.copy(re),ne=b;for(var S=0,ae=0,R=0;R<B.count;R++)if(0===I[3*R]){if(S<R)for(var ae=I[3*(R-1)],oe=S;oe<R;oe++)I[3*oe+1]=ae;S=R}for(var se=S;se<B.count;se++)ae=I[3*(B.count-1)],I[3*se+1]=ae;p.addAttribute("lineDistance",new THREE.BufferAttribute(I,3))}}if(0<d){for(var le=e.readInt32(),de=void 0,de=new(65535<l?Uint32Array:256<=l?Uint16Array:Uint8Array)(le),ce=0;ce<le;ce++)de[ce]=e.readInt32();p.addAttribute("pointIndices",new THREE.BufferAttribute(de,1))}s.set(X,{nTotalLine:u}),j[W]=p}for(var C=new THREE.Vector3,D=new THREE.Vector3,he=0;he<G;++he){var ue=e.readInt32(),pe=(C.x=e.readFloat32(),C.y=e.readFloat32(),C.z=e.readFloat32(),D.x=e.readFloat32(),D.y=e.readFloat32(),D.z=e.readFloat32(),e.readInt32()),P=e.readInt32(),H=e.readInt32(),_=1===s.size||2===s.size&&s.has(3)&&0<s.get(3).nTotalLine,L=F[he],_=(L.geomType,_||(L.supportMultiDraw=_),j[pe]);L.id=_.id,_.attributes.position&&(L.attributes.position=_.attributes.position),_.attributes.normal&&(L.attributes.normal=_.attributes.normal),_.attributes.color&&(L.attributes.color=_.attributes.color),_.attributes.lineDistance&&(L.attributes.lineDistance=_.attributes.lineDistance),_.attributes.uv&&(z?L.attributes.partId=_.attributes.uv:L.attributes.uv=_.attributes.uv),_.normal,_.validEntities,0===ue?(L.isTriangles=!0,_.index?(L.setIndex(_.index),L.drawRange.start=P,L.drawRange.count=H):(L.drawRange.start=-P,L.drawRange.count=-H),1e5<L.drawRange.count&&L.buildSpatialPartition()):1===ue?(L.isLines=!0,_.attributes.lineIndices?(L.setIndex(_.attributes.lineIndices),L.drawRange.start=P,L.drawRange.count=H):(L.drawRange.start=-P,L.drawRange.count=-H)):2===ue&&(L.isPoints=!0,_.attributes.pointIndices?(L.setIndex(_.attributes.pointIndices),L.drawRange.start=P,L.drawRange.count=H):(L.drawRange.start=-P,L.drawRange.count=-H)),(!L.boundingBox||L.boundingBox.min.x>L.boundingBox.max.x||L.boundingBox.min.y>L.boundingBox.max.y||L.boundingBox.min.z>L.boundingBox.max.z)&&C.equals(D)&&!L.isPoints?(L.boundingBox=null,L.attributes.position&&!this.computeBoundingBox(L)&&L.computeBoundingBox()):L.boundingBox.set(C,D),0===ue&&L.attributes.normal,L.boundingSphere=null,O&&O()}U&&U()},$.prototype.computeBoundingBox=function(e){if(null===e.boundingBox&&(e.boundingBox=new THREE.Box3),e.index){if(e.isTriangles){for(var t,r,i,n=new THREE.Vector3,a=new THREE.Vector3,o=new THREE.Vector3,s=e.drawRange.start,l=e.drawRange.start+e.drawRange.count;s<l;s+=3)t=e.index.getX(s),r=e.index.getX(s+1),i=e.index.getX(s+2),n.fromBufferAttribute(e.attributes.position,t),a.fromBufferAttribute(e.attributes.position,r),o.fromBufferAttribute(e.attributes.position,i),e.boundingBox.expandByPoint(n),e.boundingBox.expandByPoint(a),e.boundingBox.expandByPoint(o);return!0}if(e.isLines){for(var d,c,h=new THREE.Vector3,u=new THREE.Vector3,s=e.drawRange.start,l=e.drawRange.start+e.drawRange.count;s<l;s+=2)d=e.index.getX(s),c=e.index.getX(s+1),h.fromBufferAttribute(e.attributes.position,d),u.fromBufferAttribute(e.attributes.position,c),e.boundingBox.expandByPoint(h),e.boundingBox.expandByPoint(u);return!0}}return!1},$.prototype.readMultipleBIMBuffersVersion9=function(e,O,F,U,N,V,G){for(var k=e.length,j=[],t=new Map,z=-1,W=!1,X=(this.ndsModel&&(this.ndsModel.isECAD2DModel||this.ndsModel.isECAD3DModel)&&(W=!0),lt),q=function(e){var t=e.readInt32(),r=e.readInt32(),i=e.readInt32(),n=e.readInt32(),e=e.readInt32(),a=0<t?3:0,o=0<i?4:0,s=0<n?2:0,l=0<e?3:0;return{nVertexCount:t,vertexBufferSize:r,colorBufferSize:i,UVBufferSize:n,normalBufferSize:e,vertexItemSize:a,colorItemSize:o,uvItemSize:s,normalItemSize:l,strideMapKey:(l<<12)+(s<<8)+(o<<4)+a}},Y=function(e,t,r,i,n){var a=e[2*r+0]/2047,e=e[2*r+1]/2047,o=1-(Math.abs(a)+Math.abs(e)),s=Math.max(-o,0),s=(a+=0<=a?-s:s,e+=0<=e?-s:s,Math.sqrt(a*a+e*e+o*o));t[r*i+n+0]=a/s*127,t[r*i+n+1]=e/s*127,t[r*i+n+2]=o/s*127},Q=e,r=0;r<k;++r){var i=Q[r];-1===z&&(z=i.offset);for(var K=0,Z=G[r];K<Z;++K){var n=q(i),a=void 0,o=n.nVertexCount,s=n.vertexBufferSize,J=n.colorBufferSize,$=n.UVBufferSize,ee=n.normalBufferSize,l=n.vertexItemSize,d=n.colorItemSize,te=n.uvItemSize,re=n.normalItemSize;if(t.has(n.strideMapKey)?(t.get(n.strideMapKey).totalVertexCount+=o,t.get(n.strideMapKey).totalVertexBufferSize+=s,t.get(n.strideMapKey).totalColorBufferSize+=J,t.get(n.strideMapKey).totalUVBufferSize+=$,t.get(n.strideMapKey).totalNormalBufferSize+=ee):t.set(n.strideMapKey,{totalVertexCount:o,totalVertexBufferSize:s,totalColorBufferSize:J,totalUVBufferSize:$,totalNormalBufferSize:ee,vertexItemSize:l,colorItemSize:d,uvItemSize:te,normalItemSize:re,nTotalFace:0,nTotalFaceIndexBufferSize:0,nTotalLine:0,nTotalLineIndexBufferSize:0,nTotalPoint:0,nTotalPointIndexBufferSize:0,faceDrawStartOffsets:[],lineDrawStartOffsets:[],pointDrawStartOffsets:[]}),a=t.get(n.strideMapKey),0<s){i.skipFloat32(),i.skipFloat32(),i.skipFloat32();for(var ie=0;ie<o;++ie)i.skipFloat32(),i.skipFloat32(),i.skipFloat32()}if(0<J&&i.skipArrayUint8(J),0<$)for(var ne=0;ne<o;++ne)i.skipFloat32(),i.skipFloat32();0<ee&&i.skipArrayInt16(2*o);l=i.readInt32(),d=i.readInt32(),te=i.readInt32();if(a.nTotalFaceIndexBufferSize+=l,a.nTotalLineIndexBufferSize+=d,a.nTotalPointIndexBufferSize+=te,0<l&&(re=i.readInt32(),a.nTotalFace+=re,i.skipArrayUint8(l)),0<d&&(s=i.readInt32(),a.nTotalLine+=s,i.skipArrayUint8(d)),0<te){var ae=i.readInt32();a.nTotalPoint+=ae;for(var oe=0;oe<ae;oe++)i.skipInt32()}K===j.length&&j.push([]),j[K][r]=n.strideMapKey}}for(var se=0;se<k;++se)e[se].seek(-1===z?0:z);for(var le=It(t);!(c=le()).done;){var c=c.value,c=(c[0],c[1]),de=c.vertexItemSize,ce=c.colorItemSize,he=c.uvItemSize,ue=c.normalItemSize,h=c.totalVertexCount,de=(0<de&&(c.vertexArray=new Float32Array(h*de),c.positionAttrib=new THREE.BufferAttribute(c.vertexArray,de,!1)),0<ce&&(c.colorArray=new Uint8Array(h*ce),c.colorAttrib=new THREE.BufferAttribute(c.colorArray,ce,!0)),0<he&&(W?(c.uvArray=new Int32Array(h),c.uvArray=new THREE.BufferAttribute(c.uvArray,1,!1)):(c.uvArray=new Float32Array(h*he),c.uvAttrib=new THREE.BufferAttribute(c.uvArray,he,!1))),0<ue&&(c.normalArray=new Int8Array(h*ue),c.normalAttrib=new THREE.BufferAttribute(c.normalArray,ue,!0)),new THREE.BufferGeometry);c.bufferGeom=de,(c.currentVertexCount=0)<c.nTotalFaceIndexBufferSize&&(c.face32FloatIndices=new Uint32Array(c.nTotalFace),65535<c.nTotalFace?c.faceIndices=c.face32FloatIndices:256<c.nTotalFace?c.faceIndices=new Uint16Array(c.nTotalFace):c.faceIndices=new Uint8Array(c.nTotalFace)),0<c.nTotalLineIndexBufferSize&&(c.line32FloatIndices=new Uint32Array(c.nTotalLine),65535<c.nTotalLine?c.lineIndices=c.line32FloatIndices:256<c.nTotalLine?c.lineIndices=new Uint16Array(c.nTotalLine):c.lineIndices=new Uint8Array(c.nTotalLine)),0<c.nTotalPointIndexBufferSize&&(65535<c.nTotalPoint?c.pointIndices=new Uint32Array(c.nTotalPoint):256<c.nTotalPoint?c.pointIndices=new Uint16Array(c.nTotalPoint):c.pointIndices=new Uint8Array(c.nTotalPoint)),c.currentFaceCount=0,c.currentLineCount=0,c.currentPointCount=0,c.vertexBufferOffset=0,c.colorBufferOffset=0,c.uvBufferOffset=0,c.normalBufferOffset=0}for(var u=0;u<k;++u)for(var p=e[u],pe=0,fe=G[u];pe<fe;++pe){var f=q(p),m=f.nVertexCount,g=f.vertexBufferSize,v=f.colorBufferSize,me=f.UVBufferSize,ge=f.normalBufferSize,ve=f.vertexItemSize,y=f.colorItemSize,ye=f.uvItemSize,Ae=f.normalItemSize,f=f.strideMapKey,A=t.get(f),Me=A.vertexBufferOffset,Ee=A.colorBufferOffset,we=A.uvBufferOffset,xe=A.normalBufferOffset,be=A.vertexArray,Be=A.uvArray||A.partIdArray,Ie=A.colorArray,Te=A.normalArray;if(0<g){p.readFloat32(),p.readFloat32(),p.readFloat32();for(var M=0;M<m;++M)be[M*ve+0+Me]=p.readFloat32(),be[M*ve+1+Me]=p.readFloat32(),be[M*ve+2+Me]=p.readFloat32();A.vertexBufferOffset+=m*ve}if(0<v){var f=new Uint8Array(ct(v),0,v),Se=(p.readArrayUint8(f),new Uint8Array(3*m));X.decodeVertexBuffer(Se,m,3,f);for(var E=0;E<m;++E)Ie[E*y+0+Ee]=Se[E*y+0],Ie[E*y+1+Ee]=Se[E*y+1],Ie[E*y+2+Ee]=Se[E*y+2];A.colorBufferOffset+=m*y}if(0<me)if(W){for(var Re=0;Re<m;++Re)Be[Re+we]=p.readFloat32()+.1,p.skipFloat32();A.uvBufferOffset+=m}else{for(var Ce=0;Ce<m;++Ce)Be[Ce*ye+0+we]=p.readFloat32(),Be[Ce*ye+1+we]=p.readFloat32();A.uvBufferOffset+=m*ye}if(0<ge){var De=new Int16Array(ct(2*m*2),0,2*m);p.readArrayInt16(De);for(var Pe=0;Pe<m;++Pe)Y(De,Te,Pe,Ae,xe);A.normalBufferOffset+=m*Ae}var g=p.readInt32(),v=p.readInt32(),f=p.readInt32(),He=A.faceIndices,_e=A.face32FloatIndices,Le=A.lineIndices,Oe=A.line32FloatIndices,Fe=A.pointIndices;if(0<g){A.faceDrawStartOffsets[u]=A.currentFaceCount;var Ue=A.currentFaceCount,Ne=p.readInt32(),me=new Uint8Array(ct(g),0,g),ge=(p.readArrayUint8(me),new Uint8Array(_e.buffer,4*Ue,4*Ne));X.decodeIndexBuffer(ge,Ne,4,me);for(var Ve=0;Ve<Ne;++Ve)He[Ve+Ue]=A.currentVertexCount+_e[Ve+Ue];A.currentFaceCount+=Ne}if(0<v){A.lineDrawStartOffsets[u]=A.currentLineCount;var Ge=A.currentLineCount,ke=p.readInt32(),g=new Uint8Array(ct(v),0,v),ge=(p.readArrayUint8(g),new Uint8Array(Oe.buffer,4*Ge,4*ke));X.decodeIndexSequence(ge,ke,4,g);for(var je=0;je<ke;++je)Le[je+Ge]=A.currentVertexCount+Oe[je+Ge];A.currentLineCount+=ke}if(0<f){A.pointDrawStartOffsets[u]=A.currentPointCount;for(var ze=p.readInt32(),We=A.currentPointCount,Xe=0;Xe<ze;++Xe)Fe[Xe+We]=p.readInt32()+A.currentVertexCount;A.currentPointCount+=ze}A.currentVertexCount+=m}for(var qe=It(t);!(w=qe()).done;){var w=w.value,x=(w[0],w[1]),w=x.bufferGeom,Ye=x.positionAttrib,Qe=x.uvAttrib,Ke=x.colorAttrib,Ze=x.normalAttrib;if(0<x.totalVertexBufferSize&&w.addAttribute("position",Ye),0<x.totalColorBufferSize&&w.addAttribute("color",Ke),0<x.totalUVBufferSize&&w.addAttribute("uv",Qe),0<x.totalNormalBufferSize&&w.addAttribute("normal",Ze),0<x.nTotalFace&&w.setIndex(new THREE.BufferAttribute(x.faceIndices,1)),0<x.nTotalLine&&w.addAttribute("lineIndices",new THREE.BufferAttribute(x.lineIndices,1)),0<x.nTotalPoint&&w.addAttribute("pointIndices",new THREE.BufferAttribute(x.pointIndices,1)),N){for(var Je,$e=w.getAttribute("position"),b=new Float32Array($e.count),et=x.nTotalLine,tt=new THREE.Vector3,rt=new THREE.Vector3,it=new THREE.Vector3,nt=0,B=0;B<et;B+=2)tt.fromBufferAttribute($e,x.lineIndices[B]),rt.fromBufferAttribute($e,x.lineIndices[B+1]),Je=rt.distanceTo(tt),0!=B&&tt.equals(it)?(b[x.lineIndices[B]]=b[nt],b[x.lineIndices[B+1]]=Je+b[x.lineIndices[B]]):b[x.lineIndices[B+1]]=Je,it.copy(rt),nt=x.lineIndices[B+1];w.addAttribute("lineDistance",new THREE.BufferAttribute(b,1))}}for(var I=new THREE.Vector3,T=new THREE.Vector3,S=0;S<k;++S)for(var R=e[S],at=V[S],ot=0;ot<at;++ot){var st=R.readInt32(),C=(I.x=R.readFloat32(),I.y=R.readFloat32(),I.z=R.readFloat32(),T.x=R.readFloat32(),T.y=R.readFloat32(),T.z=R.readFloat32(),R.readInt32()),D=R.readInt32(),P=R.readInt32(),C=j[C][S],C=t.get(C),H=1===t.size||2===t.size&&t.has(3)&&0<t.get(3).nTotalLine,_=(H&&(_=C.currentFaceCount+C.currentLineCount+C.currentPointCount)>C.currentFaceCount&&_>C.currentLineCount&&_>C.currentPointCount&&(H=!1),C.bufferGeom),L=F[S][ot];L.geomType,L.id=_.id,_.attributes.position&&(L.attributes.position=_.attributes.position),_.attributes.normal&&(L.attributes.normal=_.attributes.normal),_.attributes.color&&(L.attributes.color=_.attributes.color),_.attributes.lineDistance&&(L.attributes.lineDistance=_.attributes.lineDistance),_.attributes.uv&&(W?L.attributes.partId=_.attributes.uv:L.attributes.uv=_.attributes.uv),_.normal,_.validEntities,H||(L.supportMultiDraw=H),0===st?(L.isTriangles=!0,H=C.faceDrawStartOffsets[S],_.index?(L.setIndex(_.index),L.drawRange.start=D+H,L.drawRange.count=P):(L.drawRange.start=-D,L.drawRange.count=-P),1e5<L.drawRange.count&&L.buildSpatialPartition()):1===st?(L.isLines=!0,H=C.lineDrawStartOffsets[S],_.attributes.lineIndices?(L.setIndex(_.attributes.lineIndices),L.drawRange.start=D+H,L.drawRange.count=P):(L.drawRange.start=-D,L.drawRange.count=-P)):2===st&&(L.isPoints=!0,H=C.pointDrawStartOffsets[S],_.attributes.pointIndices?(L.setIndex(_.attributes.pointIndices),L.drawRange.start=D+H,L.drawRange.count=P):(L.drawRange.start=-D,L.drawRange.count=-P)),(!L.boundingBox||L.boundingBox.min.x>L.boundingBox.max.x||L.boundingBox.min.y>L.boundingBox.max.y||L.boundingBox.min.z>L.boundingBox.max.z)&&I.equals(T)?(L.boundingBox=null,L.attributes.position&&L.computeBoundingBox()):L.boundingBox.set(I,T),0===st&&L.attributes.normal,L.boundingSphere=null,O&&O()}U&&U()},$.prototype.readBIMBufferVersion7_=function(e,O,F,U){for(var N=e.readInt32(),V=(e.readInt32(),e.readInt32()),G=[],t=0;t<V;++t){var r=e.readInt32(),i=e.readInt32(),n=e.readInt32(),a=e.readInt32(),o=e.readInt32(),s=e.readInt32(),l={},d=0<i?3:0,c=0<n?2:0,h=0<a?3:0,k=0<o?1:0,u=r/3,p=new ArrayBuffer(4*r+4*i/3+4*n+4*a+4*o),f=3+(0<d?1:0)+c+h+k,j=f,z=4*f,m=new Float32Array(p),g=new Uint8Array(p),W=new Int32Array(p),p=new THREE.InterleavedBuffer(m,f),X=new THREE.InterleavedBuffer(z),j=new THREE.InterleavedBuffer(W,j);if(0<r){for(var v=0;v<u;++v){var y=v*f;m[0+y]=e.readFloat32(),m[1+y]=e.readFloat32(),m[2+y]=e.readFloat32()}l.position=new THREE.InterleavedBufferAttribute(p,3,0,!1)}if(0<i){for(var A=0;A<u;++A){var M=A*z+12;g[M]=e.readByte(),g[1+M]=e.readByte(),g[2+M]=e.readByte(),g[3+M]=255}l.color=new THREE.InterleavedBufferAttribute(X,d,12,!0)}if(0<n){for(var q=3+(0<d?1:0),E=0;E<u;++E){var Y=E*f+q;m[Y]=e.readFloat32(),m[1+Y]=e.readFloat32()}l.uv=new THREE.InterleavedBufferAttribute(p,c,q,!1)}if(0<a){var w=3+(0<d?1:0)+c;if(4===s)for(var x=0;x<u;++x){var b=x*f+w;m[b]=e.readFloat32(),m[1+b]=e.readFloat32(),m[2+b]=e.readFloat32()}else{var Q=new Int32Array([1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1]),B=void 0,K=1===s?1/255:1/65535;if(1===s)for(var I=0;I<u;++I){B=e.readByte(),--B;for(var Z=I*f+w,T=0;T<h;++T){var J=e.readByte();m[Z+T]=Q[3*B+T]*J*K}}else if(2===s)for(var $=0;$<u;++$){B=e.readByte(),--B;for(var ee=$*f+w,S=0;S<h;++S)m[ee+S]=Q[3*B+S]*e.readInt16()*K}}l.normal=new THREE.InterleavedBufferAttribute(p,h,w,!1)}if(0<o){for(var te=3+(0<d?1:0)+c+h,re=0;re<u;++re)W[te]=e.readInt32();l.validEntities=new THREE.InterleavedBufferAttribute(j,k,te,!1)}var ie=e.readInt32(),ne=e.readInt32(),ae=e.readInt32();if(0<ie){l.faceIndices=new(65535<u?Uint32Array:256<u?Uint16Array:Uint8Array)(ie);for(var oe=0;oe<ie;++oe)l.faceIndices[oe]=e.readInt32()}if(0<ne){l.lineIndices=new(65535<u?Uint32Array:256<u?Uint16Array:Uint8Array)(ne);for(var se=0;se<ne;++se)l.lineIndices[se]=e.readInt32()}if(0<ae){l.pointIndices=new(65535<u?Uint32Array:256<u?Uint16Array:Uint8Array)(ae);for(var le=0;le<ae;++le)l.pointIndices[le]=e.readInt32()}G[t]=l}for(var R=new THREE.Vector3,C=new THREE.Vector3,de=0;de<N;++de){var D=e.readInt32(),P=(R.x=e.readFloat32(),R.y=e.readFloat32(),R.z=e.readFloat32(),C.x=e.readFloat32(),C.y=e.readFloat32(),C.z=e.readFloat32(),e.readInt32()),H=e.readInt32(),_=e.readInt32(),L=F[de],P=G[P];P.position&&(L.attributes.position=P.position),P.color&&(L.attributes.color=P.color),P.uv&&(L.attributes.uv=P.uv),P.normal&&(L.attributes.normal=P.normal),P.validEntities&&(L.attributes.validEntity=P.validEntities),0===D?P.faceIndices?(L.setIndex(new THREE.BufferAttribute(P.faceIndices,1)),L.drawRange.start=H,L.drawRange.count=_):(L.drawRange.start=-H,L.drawRange.count=-_):1===D?P.lineIndices?(L.setIndex(new THREE.BufferAttribute(P.lineIndices,1)),L.drawRange.start=H,L.drawRange.count=_):(L.drawRange.start=-H,L.drawRange.count=-_):2===D&&(P.pointIndices?(L.setIndex(new THREE.BufferAttribute(P.pointIndices,1)),L.drawRange.start=H,L.drawRange.count=_):(L.drawRange.start=-H,L.drawRange.count=-_)),L.boundingBox||(R.equals(C)?(L.boundingBox=null,L.attributes.position&&L.computeBoundingBox()):L.boundingBox=new THREE.Box3(R,C)),0===D&&null==L.attributes.normal&&L.computeVertexNormals(),L.boundingSphere=null,O&&O()}U&&U()},$.prototype.readBIMBufferVersion6=function(e,O,F,U){function N(e){var t=e.readInt32(),r=e.readInt32(),i=0,n=0,a=0,o=0,s=(1!==t&&(i=e.readInt32(),n=e.readInt32(),a=e.readInt32()),e.readInt32()),l=0<r?3:0,d=0<i?3:0,c=0<n?2:0,h=0<a?3:0;return{nGeometryCategory:t,nVertexCount:r,nVertexColorsCount:i,nUVCount:n,nNormalCount:a,nFacesCount:s,nNormalPrecision:o=0===t?e.readInt32():o,vertexItemSize:l,colorItemSize:d,uvItemSize:c,normalItemSize:h,strideMapKey:(h<<12)+(c<<8)+(d<<4)+l}}var V=e.readInt32(),G=e.readInt32(),t=-1,r=new Map,k=[],i=e;-1===t&&(t=i.offset);for(var n=0;n<V;++n){var a=N(i);if(100<=a.nGeometryCategory)--n;else{var o=a.nGeometryCategory,s=a.nVertexCount,j=a.nVertexColorsCount,z=a.nUVCount,W=a.nNormalCount,l=a.nFacesCount,X=a.nNormalPrecision,q=a.vertexItemSize,Y=a.colorItemSize,Q=a.uvItemSize,d=a.normalItemSize,c=a.strideMapKey;if(r.has(c)?(r.get(a.strideMapKey).totalVertexCount+=s,r.get(a.strideMapKey).totalVertexColorsCount+=j,r.get(a.strideMapKey).totalUVCount+=z,r.get(a.strideMapKey).totalNormalCount+=W):r.set(c,{totalVertexCount:s,totalVertexColorsCount:j,totalUVCount:z,totalNormalCount:W,nGeometryCategory:o,nFacesCount:l,vertexItemSize:q,colorItemSize:Y,uvItemSize:Q,normalItemSize:d,nTotalFaceIndexNum:0,nTotalLineIndexNum:0,faceDrawStartOffsets:[],faceDrawCountOffsets:[],lineDrawStartOffsets:[],lineDrawCountOffsets:[]}),0===o?r.get(a.strideMapKey).nTotalFaceIndexNum+=l*q:1===o&&(r.get(a.strideMapKey).nTotalLineIndexNum+=l),i.skipFloat32(),i.skipFloat32(),i.skipFloat32(),i.skipFloat32(),i.skipFloat32(),i.skipFloat32(),0<s)for(var K=0;K<s;++K)for(var Z=0;Z<q;++Z)i.skipFloat32();if(0===o){if(0<j)for(var J=0;J<s;++J)for(var $=0;$<Y;++$)i.skipByte();if(0<z)for(var ee=0;ee<s;++ee)for(var te=0;te<Q;++te)i.skipFloat32();if(0<W)if(4===X)for(var re=0;re<s;++re)for(var ie=0;ie<d;++ie)i.skipFloat32();else if(1===X)for(var ne=0;ne<s;++ne){i.skipByte(),0;for(var ae=0;ae<d;++ae)i.skipByte()}else if(2===X)for(var oe=0;oe<s;++oe){i.skipByte(),0;for(var se=0;se<d;++se)i.skipInt16()}}if(0<l){var c=i.readInt32(),h=0;if(0===o?h=3*l:1===o&&(h=l),1===c)for(var le=0;le<h;++le)i.skipByte();else if(2===c)for(var de=0;de<h;++de)i.skipInt16();else if(4===c)for(var ce=0;ce<h;++ce)i.skipInt32()}k[n]=a.strideMapKey}}e.seek(-1===t?0:t);for(var he=It(r);!(u=he()).done;){var u=u.value,u=(u[0],u[1]),p=u.totalVertexCount,ue=u.vertexItemSize,pe=u.colorItemSize,fe=u.uvItemSize,me=u.normalItemSize,ge=Math.max(0,u.nTotalFaceIndexNum),ve=Math.max(0,u.nTotalLineIndexNum),ue=(0<ue&&(u.vertexArray=new Float32Array(p*ue),u.positionAttrib=new THREE.BufferAttribute(u.vertexArray,ue,!1)),0<pe&&(u.colorArray=new Uint8Array(p*pe),u.colorAttrib=new THREE.BufferAttribute(u.colorArray,pe,!0)),0<fe&&(u.uvArray=new Float32Array(p*fe),u.uvAttrib=new THREE.BufferAttribute(u.uvArray,fe,!1)),0<me&&(u.normalArray=new Int8Array(p*me),u.normalAttrib=new THREE.BufferAttribute(u.normalArray,me,!0)),new THREE.BufferGeometry);0<ge&&(u.faceIndices=new(65535<p?Uint32Array:256<p?Uint16Array:Uint8Array)(ge)),0<ve&&(u.lineIndices=new(65535<p?Uint32Array:256<p?Uint16Array:Uint8Array)(ve),u.lineDistance=new Float32Array(p)),u.bufferGeom=ue,u.currentVertexCount=0,u.currentFaceIndexCount=0,u.currentLineIndexCount=0,u.vertexBufferOffset=0,u.colorBufferOffset=0,u.uvBufferOffset=0,u.normalBufferOffset=0}for(var f=e,m=0;m<V;++m){var g=N(f);if(100<=g.nGeometryCategory)--m;else{var ye=g.nGeometryCategory,v=g.nVertexCount,Ae=g.nVertexColorsCount,Me=g.nUVCount,Ee=g.nNormalCount,we=g.nFacesCount,xe=g.nNormalPrecision,be=g.vertexItemSize,Be=g.colorItemSize,Ie=g.uvItemSize,y=g.normalItemSize,g=g.strideMapKey,A=r.get(g),Te=A.vertexArray,Se=A.colorArray,Re=A.uvArray,Ce=A.normalArray,De=A.faceIndices,M=A.lineIndices,Pe=A.vertexBufferOffset,He=A.colorBufferOffset,_e=A.uvBufferOffset,Le=A.normalBufferOffset,g=new THREE.Vector3,Oe=new THREE.Vector3,Fe=(g.x=f.readFloat32(),g.y=f.readFloat32(),g.z=f.readFloat32(),Oe.x=f.readFloat32(),Oe.y=f.readFloat32(),Oe.z=f.readFloat32(),F[m]);if(Fe.boundingBox.set(g,Oe),0<v&&Te){for(var Ue=0;Ue<v;++Ue)for(var Ne=0;Ne<be;++Ne)Te[Ue*be+Ne+Pe]=f.readFloat32();A.vertexBufferOffset+=v*be}if(0===ye){if(0<Ae&&Se){for(var Ve=0;Ve<v;++Ve)for(var Ge=0;Ge<Be;++Ge)Se[Ve*Be+Ge+He]=f.readByte();A.colorBufferOffset+=v*Be}if(0<Me&&Re){for(var ke=0;ke<v;++ke)for(var je=0;je<Ie;++je)Re[ke*Ie+je+_e]=f.readFloat32();A.uvBufferOffset+=v*Ie}if(0<Ee&&Ce){if(4===xe)for(var ze=0;ze<v;++ze)for(var We=0;We<y;++We)Ce[ze*y+We+Le]=127*f.readFloat32();else{var Xe=new Int32Array([1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1]),E=void 0,qe=1===xe?127/255:127/65535;if(1===xe)for(var Ye=0;Ye<v;++Ye){E=f.readByte(),--E;for(var Qe=0;Qe<y;++Qe){var Ke=f.readByte();Ce[Ye*y+Qe+Le]=Xe[3*E+Qe]*Ke*qe}}else if(2===xe)for(var Ze=0;Ze<v;++Ze){E=f.readByte(),--E;for(var Je=0;Je<y;++Je)Ce[Ze*y+Je+Le]=Xe[3*E+Je]*f.readInt16()*qe}}A.normalBufferOffset+=v*y}}if(0<we){var w=f.readInt32();if(0===ye){var x=3*we,$e=A.currentFaceIndexCount;A.faceDrawStartOffsets[m]=$e,A.faceDrawCountOffsets[m]=x;for(var et=0;et<x;++et)De[et+$e]=4===w?f.readInt32():2==w?f.readUInt16():f.readUInt8();if(De){yt.restoreIndices2(De,$e,x);for(var b=0;b<x;++b)De[$e+b]+=A.currentVertexCount}A.currentFaceIndexCount+=x}else if(1===ye){var tt=we,B=A.currentLineIndexCount;A.lineDrawStartOffsets[m]=B,A.lineDrawCountOffsets[m]=tt;for(var rt=0;rt<tt-1;rt+=2){var it=rt+B;M[it]=4===w?f.readInt32():2==w?f.readUInt16():f.readUInt8(),M[it+1]=4===w?f.readInt32():2===w?f.readUInt16():f.readUInt8()}if(0===G)for(var nt=1;nt<we;++nt)M[nt+B]+=M[nt+B-1];for(b=0;b<tt;++b)M[B+b]+=A.currentVertexCount;A.currentLineIndexCount+=tt}}A.currentVertexCount+=v}}for(var at=It(r);!(I=at()).done;){var I=I.value,T=(I[0],I[1]),I=T.bufferGeom,ot=T.positionAttrib,st=T.colorAttrib,lt=T.uvAttrib,dt=T.normalAttrib;if(0<T.totalVertexCount&&(I.attributes.position=ot),0<T.totalVertexColorsCount&&(I.attributes.color=st),0<T.totalUVCount&&(I.attributes.uv=lt),0<T.totalNormalCount&&(I.attributes.normal=dt),0<T.nTotalFaceIndexNum&&I.setIndex(new THREE.BufferAttribute(T.faceIndices,1)),T.nTotalLineIndexNum){for(var ct,ht=I.getAttribute("position"),S=new Float32Array(ht.count),ut=T.nTotalLineIndexNum,pt=new THREE.Vector3,ft=new THREE.Vector3,mt=new THREE.Vector3,gt=0,R=0;R<ut;R+=2)pt.fromBufferAttribute(ht,T.lineIndices[R]),ft.fromBufferAttribute(ht,T.lineIndices[R+1]),ct=ft.distanceTo(pt),0!=R&&pt.equals(mt)?(S[T.lineIndices[R]]=S[gt],S[T.lineIndices[R+1]]=ct+S[T.lineIndices[R]]):S[T.lineIndices[R+1]]=ct,mt.copy(ft),gt=T.lineIndices[R+1];I.addAttribute("lineDistance",new THREE.BufferAttribute(S,1)),I.setIndex(new THREE.BufferAttribute(T.lineIndices,1))}}for(var C=0;C<V;++C){var D,P,H=r.get(k[C]),_=H.bufferGeom,vt=H.nGeometryCategory,L=F[C];L.geomType,L.id=_.id,_.attributes.position&&(L.attributes.position=_.attributes.position),_.attributes.normal&&(L.attributes.normal=_.attributes.normal),_.attributes.color&&(L.attributes.color=_.attributes.color),_.attributes.lineDistance&&(L.attributes.lineDistance=_.attributes.lineDistance),0===vt?(L.isTriangles=!0,D=H.faceDrawStartOffsets[C],P=H.faceDrawCountOffsets[C],_.index?(L.setIndex(_.index),L.drawRange.start=D,L.drawRange.count=P):(L.drawRange.start=-D,L.drawRange.count=-P)):1===vt&&(L.isLines=!0,D=H.lineDrawStartOffsets[C],P=H.lineDrawCountOffsets[C],_.index?(L.setIndex(_.index),L.drawRange.start=D,L.drawRange.count=P):(L.drawRange.start=-D,L.drawRange.count=-P)),(!L.boundingBox||L.boundingBox.min.x>L.boundingBox.max.x||L.boundingBox.min.y>L.boundingBox.max.y||L.boundingBox.min.z>L.boundingBox.max.z)&&L.boundingBox.min.equals(L.boundingBox.max)&&(L.boundingBox=null,L.attributes.position)&&L.computeBoundingBox(),0===vt&&L.attributes.normal,L.boundingSphere=null,O&&O()}U&&U()},$.prototype.readBIMBufferVersion5=function(e,O,F,U){for(var N,t,r,i,n,a,o,s,V=e.readInt32(),G=e.readInt32(),k=new Int32Array([1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1]),j=new Int8Array(V),z=new Int8Array(V),W=0,l=0;l<F.length;++l)(t=F[l])&&t.isRawMeshEdge||(t?(j[W]=t.index&&"LineGeometry"!=t.type&&"LineSegmentsGeometry"!=t.type?0:1,z[W]=t.index&&!t.index.array?1:0,z[W]&&0):(j[W]=0,z[W]=0),W++);for(var d,X,q,c,h,Y=[],Q=0,l=0;l<V;++l){t=F[Q],Q++;var u=e.readInt32(),p=j[l],K=z[l];if(0===u){r=e.readInt32(),i=e.readInt32(),n=e.readInt32(),a=e.readInt32(),X=e.readInt32(),P=e.readInt32(),q=e.readInt32(),o=e.readInt32(),s=e.readInt32(),c=new THREE.Vector3,h=new THREE.Vector3,c.x=e.readFloat32(),c.y=e.readFloat32(),c.z=e.readFloat32(),h.x=e.readFloat32(),h.y=e.readFloat32(),h.z=e.readFloat32();var f=0,m=(S=3)+(R=0<i?3:0)+(C=0<n?2:0)+(D=0<a?3:0);if(b=p?(x=new Float32Array(r*m),new THREE.InterleavedBuffer(x,m)):K?(t.attributes.position.data.array=new Float32Array(r*m),x=t.attributes.position.data.array,t.attributes.position.data):x=null,0<r){for(L=0;L<r;++L)for(_=0;_<S;++_)x?x[0+L*m+_]=e.readFloat32():e.readFloat32();p&&(t.attributes.position=new THREE.InterleavedBufferAttribute(b,S,0,!1)),f+=S}if(0<i){var g=1/255;for(L=0;L<i;++L)for(_=0;_<R;++_)x?x[0+L*m+f+_]=e.readByte()*g:e.readByte();p&&(t.attributes.color=new THREE.InterleavedBufferAttribute(b,R,f,!1)),f+=R}if(0<n){for(L=0;L<n;++L)for(_=0;_<C;++_)x?x[0+L*m+f+_]=e.readFloat32():e.readFloat32();p&&(t.attributes.uv=new THREE.InterleavedBufferAttribute(b,C,f,!1)),f+=C}if(0<a){if(4===s)for(v=0;v<a;++v)for(_=0;_<D;++_)x?x[0+L*m+f+_]=e.readFloat32():e.readFloat32();else{g=1===s?1/255:1/65535;if(1===s)for(L=0;L<a;++L)for(I=e.readByte(),--I,_=0;_<D;++_){var Z=e.readByte();x&&(x[0+L*m+f+_]=k[3*I+_]*Z*g)}else if(2===s)for(L=0;L<a;++L)for(I=e.readByte(),--I,_=0;_<D;++_)x&&(x[0+L*m+f+_]=k[3*I+_]*e.readInt16()*g)}p&&(t.attributes.normal=new THREE.InterleavedBufferAttribute(b,D,f,!1))}if(0<P){for(var J=P*X,$=new Float32Array(J),v=0;v<J;v++)$[v]=e.readInt32();t.addAttribute("skinIndex",new THREE.BufferAttribute($,X))}if(0<q){var ee=q*X,te=new Float32Array(ee);for(v=0;v<ee;v++)te[v]=e.readFloat32();t.addAttribute("skinWeight",new THREE.BufferAttribute(te,X))}if(0<o){d=e.readInt32();var y=3*o,re=0;if(Re=p?(A=new(r<=65535?Uint16Array:Uint32Array)(y),new THREE.BufferAttribute(A,1)):K?(t.index.array=new(r<=65535?Uint16Array:Uint32Array)(y),A=t.index.array,t.index):A=null,re=0,1===d)for(v=0;v<y;++v)A?A[0+v]=e.readByte():e.readByte();else if(2===d)for(v=0;v<y;++v)A?A[0+v]=e.readInt16():e.readInt16();else if(4===d)for(v=0;v<y;++v)A?A[0+v]=e.readInt32():e.readInt32();if(A){yt.restoreIndices2(A,0,y);for(var ie=0;ie<y;++ie)A[0+ie]+=re}p&&(t.setIndex(Re),t.drawRange.start=0,t.drawRange.count=y)}}else if(1===u){if(r=e.readInt32(),E=e.readInt32(),p&&0<r&&Y.push(t),c=new THREE.Vector3,h=new THREE.Vector3,c.x=e.readFloat32(),c.y=e.readFloat32(),c.z=e.readFloat32(),h.x=e.readFloat32(),h.y=e.readFloat32(),h.z=e.readFloat32(),0<r){var y=3*r,ne=new Float32Array(y);for(v=0;v<y;++v)ne[v]=e.readFloat32();"LineSegmentsGeometry"!=t.type&&"LineGeometry"!=t.type||!p?"TextBufferGeometry"!=t.type&&p&&t.addAttribute("position",new THREE.BufferAttribute(ne,3)):t._positions=ne}if(0<E){d=e.readInt32();var A=new(r<=65535?Uint16Array:Uint32Array)(E);if(1===d)for(v=0;v<E;++v)A[v]=e.readByte();else if(2===d)for(v=0;v<E;++v)A[v]=e.readInt16();else if(4===d)for(v=0;v<E;++v)A[v]=e.readInt32();if(0===G)for(v=1;v<E;++v)A[v]+=A[v-1];if(!1===De.OES_element_index_uint&&65535<r&&0===G){var ae=new Uint16Array(E),oe=0,se=0,le=1,de=0;for(v=0;v<E-1;v+=2)A[v]<=65535*le&&A[v+1]<=65535*le?(se+=2,ae[v]=A[v]-oe,ae[v+1]=A[v+1]-oe):(t.addDrawCall(de,se,oe),de=v,se=0,v-=2,oe+=65535*(++le-1));1!==le&&t.addDrawCall(de,se,oe),t.setIndex(new THREE.BufferAttribute(ae,1))}else if(p&&"LineGeometry"!=t.type&&"LineSegmentsGeometry"!=t.type)t.setIndex(new THREE.BufferAttribute(A,1));else if(p&&("LineSegmentsGeometry"==t.type||"LineGeometry"==t.type)){for(var ce=[],M=0;M<A.length;M+=2)ce.push(t._positions[3*A[M]],t._positions[3*A[M]+1],t._positions[3*A[M]+2],t._positions[3*A[M+1]],t._positions[3*A[M+1]+1],t._positions[3*A[M+1]+2]);t.setPositions(ce)}}else if(p&&0<r){var E=2*r-2,A=new(r<=65535?Uint16Array:Uint32Array)(E);for(v=0;v<r-1;v++)A[2*v]=v,A[2*v+1]=v+1;if(p&&"LineGeometry"!=t.type&&"LineSegmentsGeometry"!=t.type)t.setIndex(new THREE.BufferAttribute(A,1));else if(p&&("LineSegmentsGeometry"==t.type||"LineGeometry"==t.type)){for(var he=[],w=0;w<A.length;w+=2)he.push(t._positions[3*A[w]],t._positions[3*A[w]+1],t._positions[3*A[w]+2],t._positions[3*A[w+1]],t._positions[3*A[w+1]+1],t._positions[3*A[w+1]+2]);t.setPositions(he)}}}else if(2===u){if(0<(r=e.readInt32())){y=3*r,ne=new Float32Array(y);for(v=0;v<y;++v)ne[v]=e.readFloat32();t instanceof NdsPointGeometry&&(t.vertices=ne)}}else if(3===u){r=e.readInt32(),i=e.readInt32(),n=e.readInt32(),a=e.readInt32(),o=e.readInt32(),E=e.readInt32(),s=e.readInt32(),c=new THREE.Vector3,h=new THREE.Vector3,c.x=e.readFloat32(),c.y=e.readFloat32(),c.z=e.readFloat32(),h.x=e.readFloat32(),h.y=e.readFloat32(),h.z=e.readFloat32();var x,b,B,ue,pe,fe,me,f=0,m=(S=3)+(R=0<i?3:0)+(C=0<n?2:0)+(D=0<a?3:0),y=0;if(0<r)for(y=3*r,B=new Float32Array(y),L=0;L<y;++L)B[L]=e.readFloat32();if(0<i){g=1/255;for(y=3*i,ue=new Float32Array(y),L=0;L<y;++L)ue[L]=e.readByte()*g}if(0<n)for(y=2*n,pe=new Float32Array(y),L=0;L<y;++L)pe[L]=e.readByte()*g;if(0<a)if(y=3*a,fe=new Float32Array(y),4===s)for(L=0;L<y;++L)fe[L]=e.readFloat32();else{var I,g=1===s?1/255:1/65535;if(1===s)for(L=0;L<a;++L)for(I=e.readByte(),--I,_=0;_<3;++_)fe[3*L+_]=k[3*I+_]*e.readByte()*g;else if(2===s)for(L=0;L<a;++L)for(I=e.readByte(),--I,_=0;_<3;++_)fe[3*L+_]=k[3*I+_]*e.readInt16()*g}if(0<o){d=e.readInt32();var ge=3*o,T=new(r<=65535?Uint16Array:Uint32Array)(ge);if(1===d)for(v=0;v<ge;++v)T[v]=e.readByte();else if(2===d)for(v=0;v<ge;++v)T[v]=e.readInt16();else if(4===d)for(v=0;v<ge;++v)T[v]=e.readInt32()}if(0<E)if(d=e.readInt32(),me=new(r<=65535?Uint16Array:Uint32Array)(E),1===d)for(v=0;v<E;++v)me[v]=e.readByte();else if(2===d)for(v=0;v<E;++v)me[v]=e.readInt16();else if(4===d)for(v=0;v<E;++v)me[v]=e.readInt32();if(0<o){var S,R,C,D,m=(S=3)+(R=0<i?3:0)+(C=0<n?2:0)+(D=3),P=3*o;if(p?(x=new Float32Array(P*m),b=new THREE.InterleavedBuffer(x,m),A=new(P<=65535?Uint16Array:Uint32Array)(P),Re=new THREE.BufferAttribute(A,1)):K&&(t.attributes.position.data.array=new Float32Array(P*m),x=t.attributes.position.data.array,b=t.attributes.position.data,t.index.array=new(P<=65535?Uint16Array:Uint32Array)(P),A=t.index.array,Re=t.index),p||K){var ve,ye,Ae,Me,Ee,f=0,we=new THREE.Vector3,xe=new THREE.Vector3,be=new THREE.Vector3,Be=new THREE.Vector3,Ie=new THREE.Vector3,Te=new THREE.Vector3,Se=new Float32Array(3);for(v=0;v<o;++v){if(0<a)for(var H=0;H<3;++H)Se[H]=fe[3*v+H];else Ae=T[3*v+0],Me=T[3*v+1],Ee=T[3*v+2],we.set(B[3*Ae],B[3*Ae+1],B[3*Ae+2]),xe.set(B[3*Me],B[3*Me+1],B[3*Me+2]),be.set(B[3*Ee],B[3*Ee+1],B[3*Ee+2]),Be.subVectors(xe,we),Ie.subVectors(be,we),Te.crossVectors(Be,Ie),Te.normalize(),Te.toArray(Se);for(N=0;N<3;++N){ye=T[3*v+N],A[ve=3*v+N]=ve;for(H=0;H<S;++H)x[ve*m+H]=B[ye*S+H];if(0<R){f=S;for(H=0;H<R;++H)x[ve*m+f+H]=ue[ye*R+H]}if(0<C){f=S+R;for(H=0;H<C;++H)x[ve*m+f+H]=pe[ye*C+H]}f=S+R+C;for(H=0;H<D;++H)x[ve*m+f+H]=Se[H]}}p&&(t.attributes.position=new THREE.InterleavedBufferAttribute(b,S,0,!1),0<R&&(f=S,t.attributes.color=new THREE.InterleavedBufferAttribute(b,R,f,!1)),0<C&&(f=S+R,t.attributes.uv=new THREE.InterleavedBufferAttribute(b,C,f,!1)),0<D&&(f=S+R+C,t.attributes.normal=new THREE.InterleavedBufferAttribute(b,D,f,!1)),t.setIndex(Re),t.drawRange.start=0,t.drawRange.count=P)}}t=F[Q],Q++,E&&p&&(t.addAttribute("position",new THREE.BufferAttribute(B,3)),Re=new THREE.BufferAttribute(me,1),t.setIndex(Re),t.drawRange.start=0,t.drawRange.count=E)}t&&(2==u||t.boundingBox||(c.equals(h)?(t.boundingBox=null,t.attributes.position&&t.computeBoundingBox()):t.boundingBox=new THREE.Box3(c,h)),0===u&&void 0!==t.attributes&&null==t.attributes.normal&&"TextBufferGeometry"!=t.type&&t.computeVertexNormals(),!1===De.OES_element_index_uint&&0===u&&65535<r&&t.computeOffsets(),t.boundingSphere=null,p&&O?O():K&&O&&O(t))}var Re,_,L;U&&U()},$.prototype.readBIMBufferVersion4=function(e,t,r,i){for(var n,a,o,s,l,d,c,h,u,p,f=e.readInt32(),m=e.readInt32(),g=new Int32Array([1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1]),v=0;v<f;++v){if(n=r[v],0===(h=e.readInt32())){if(a=e.readInt32(),o=e.readInt32(),s=e.readInt32(),l=e.readInt32(),d=e.readInt32(),c=e.readInt32(),u=new THREE.Vector3,p=new THREE.Vector3,u.x=e.readFloat32(),u.y=e.readFloat32(),u.z=e.readFloat32(),p.x=e.readFloat32(),p.y=e.readFloat32(),p.z=e.readFloat32(),0<a){for(var y=3*a,A=new Float32Array(y),M=0;M<y;++M)A[M]=e.readFloat32();n.addAttribute("position",new THREE.BufferAttribute(A,3))}if(0<o){var y=3*o,E=new Float32Array(y),w=1/255;for(M=0;M<y;++M)E[M]=e.readByte()*w;n.addAttribute("color",new THREE.BufferAttribute(E,3))}if(0<s){var y=2*s,x=new Float32Array(y);for(M=0;M<y;++M)x[M]=e.readFloat32();n.addAttribute("uv",new THREE.BufferAttribute(x,2))}if(0<l){if(4===c){var y=3*l,b=new Float32Array(y);for(M=0;M<y;++M)b[M]=e.readFloat32()}else{var B,w=1===c?1/255:1/65535,b=new Float32Array(3*l);if(1===c)for(M=0;M<l;++M){B=e.readByte(),--B;var I=e.readByte();b[3*M]=g[3*B]*I*w,I=e.readByte(),b[3*M+1]=g[3*B+1]*I*w,I=e.readByte(),b[3*M+2]=g[3*B+2]*I*w}else if(2===c)for(M=0;M<l;++M)B=e.readByte(),--B,b[3*M]=g[3*B]*e.readInt16()*w,b[3*M+1]=g[3*B+1]*e.readInt16()*w,b[3*M+2]=g[3*B+2]*e.readInt16()*w}n.addAttribute("normal",new THREE.BufferAttribute(b,3))}if(0<d){var T=e.readInt32(),y=3*d,S=new(a<=65535?Uint16Array:Uint32Array)(y);if(1===T)for(M=0;M<y;++M)S[M]=e.readByte();else if(2===T)for(M=0;M<y;++M)S[M]=e.readInt16();else if(4===T)for(M=0;M<y;++M)S[M]=e.readInt32();yt.restoreIndices(S,S.length),n.setIndex(new THREE.BufferAttribute(S,1))}}else if(1===h){if(a=e.readInt32(),d=e.readInt32(),u=new THREE.Vector3,p=new THREE.Vector3,u.x=e.readFloat32(),u.y=e.readFloat32(),u.z=e.readFloat32(),p.x=e.readFloat32(),p.y=e.readFloat32(),p.z=e.readFloat32(),0<a){y=3*a,A=new Float32Array(y);for(M=0;M<y;++M)A[M]=e.readFloat32();n.addAttribute("position",new THREE.BufferAttribute(A,3))}if(0<d){T=e.readInt32();S=new(a<=65535?Uint16Array:Uint32Array)(d);if(1===T)for(M=0;M<d;++M)S[M]=e.readByte();else if(2===T)for(M=0;M<d;++M)S[M]=e.readInt16();else if(4===T)for(M=0;M<d;++M)S[M]=e.readInt32();if(0===m)for(M=1;M<d;++M)S[M]+=S[M-1];if(!1===De.OES_element_index_uint&&65535<a&&0===m){var R=new Uint16Array(d),C=0,D=0,P=1,H=0;for(M=0;M<d-1;M+=2)S[M]<=65535*P&&S[M+1]<=65535*P?(D+=2,R[M]=S[M]-C,R[M+1]=S[M+1]-C):(n.addDrawCall(H,D,C),H=M,D=0,M-=2,C+=65535*(++P-1));1!==P&&n.addDrawCall(H,D,C),n.setIndex(new THREE.BufferAttribute(R,1))}else n.setIndex(new THREE.BufferAttribute(S,1))}}n.boundingBox||(u.equals(p)?n.attributes.position&&n.computeBoundingBox():n.boundingBox=new THREE.Box3(u,p)),0===h&&null==n.attributes.normal&&n.computeVertexNormals(),!1===De.OES_element_index_uint&&0===h&&65535<a&&n.computeOffsets(),n.boundingSphere=null,t&&t()}i&&i()},$.prototype.readBIMBufferVersion3=function(e,t,r,i){for(var n,a,o,s,l,d,c,h,u,p=e.readInt32(),f=e.readInt32(),m=new Int32Array([1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1]),g=0;g<p;++g){if(n=r[g],0===(c=e.readInt32())){if(a=e.readInt32(),o=e.readInt32(),s=e.readInt32(),l=e.readInt32(),d=e.readInt32(),h=new THREE.Vector3,u=new THREE.Vector3,h.x=e.readFloat32(),h.y=e.readFloat32(),h.z=e.readFloat32(),u.x=e.readFloat32(),u.y=e.readFloat32(),u.z=e.readFloat32(),0<a){for(var v=3*a,y=new Float32Array(v),A=0;A<v;++A)y[A]=e.readFloat32();n.addAttribute("position",new THREE.BufferAttribute(y,3))}if(0<o){var v=2*o,M=new Float32Array(v);for(A=0;A<v;++A)M[A]=e.readFloat32();n.addAttribute("uv",new THREE.BufferAttribute(M,2))}if(0<s){if(4===d){var v=3*s,E=new Float32Array(v);for(A=0;A<v;++A)E[A]=e.readFloat32()}else{var w,x=1===d?1/255:1/65535,E=new Float32Array(3*s);if(1===d)for(A=0;A<s;++A){w=e.readByte(),--w;var b=e.readByte();E[3*A]=m[3*w]*b*x,b=e.readByte(),E[3*A+1]=m[3*w+1]*b*x,b=e.readByte(),E[3*A+2]=m[3*w+2]*b*x}else if(2===d)for(A=0;A<s;++A)w=e.readByte(),--w,E[3*A]=m[3*w]*e.readInt16()*x,E[3*A+1]=m[3*w+1]*e.readInt16()*x,E[3*A+2]=m[3*w+2]*e.readInt16()*x}n.addAttribute("normal",new THREE.BufferAttribute(E,3))}if(0<l){var B=e.readInt32(),v=3*l,I=new(a<=65535?Uint16Array:Uint32Array)(v);if(1===B)for(A=0;A<v;++A)I[A]=e.readByte();else if(2===B)for(A=0;A<v;++A)I[A]=e.readInt16();else if(4===B)for(A=0;A<v;++A)I[A]=e.readInt32();yt.restoreIndices(I,I.length),n.setIndex(new THREE.BufferAttribute(I,1))}}else if(1===c){if(a=e.readInt32(),l=e.readInt32(),h=new THREE.Vector3,u=new THREE.Vector3,h.x=e.readFloat32(),h.y=e.readFloat32(),h.z=e.readFloat32(),u.x=e.readFloat32(),u.y=e.readFloat32(),u.z=e.readFloat32(),0<a){v=3*a,y=new Float32Array(v);for(A=0;A<v;++A)y[A]=e.readFloat32();n.addAttribute("position",new THREE.BufferAttribute(y,3))}if(0<l){B=e.readInt32();I=new(a<=65535?Uint16Array:Uint32Array)(l);if(1===B)for(A=0;A<l;++A)I[A]=e.readByte();else if(2===B)for(A=0;A<l;++A)I[A]=e.readInt16();else if(4===B)for(A=0;A<l;++A)I[A]=e.readInt32();if(0===f)for(A=1;A<l;++A)I[A]+=I[A-1];if(!1===De.OES_element_index_uint&&65535<a&&0===f){var T=new Uint16Array(l),S=0,R=0,C=1,D=0;for(A=0;A<l-1;A+=2)I[A]<=65535*C&&I[A+1]<=65535*C?(R+=2,T[A]=I[A]-S,T[A+1]=I[A+1]-S):(n.addDrawCall(D,R,S),D=A,R=0,A-=2,S+=65535*(++C-1));1!==C&&n.addDrawCall(D,R,S),n.setIndex(new THREE.BufferAttribute(T,1))}else n.setIndex(new THREE.BufferAttribute(I,1))}}n.boundingBox||(h.equals(u)?n.attributes.position&&n.computeBoundingBox():n.boundingBox=new THREE.Box3(h,u)),0===c&&null==n.attributes.normal&&n.computeVertexNormals(),!1===De.OES_element_index_uint&&0===c&&65535<a&&n.computeOffsets(),n.boundingSphere=null,t&&t()}i&&i()},$.prototype.readBIMBufferVersion2=function(e,t,r,i){for(var n,a,o,s,l,d,c,h=e.readInt32(),u=new Int32Array([1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1]),p=0;p<h;++p){if(n=r[p],0===(l=e.readInt32())){if(a=e.readInt32(),e.readInt32(),o=e.readInt32(),s=e.readInt32(),w=e.readInt32(),d=new THREE.Vector3,c=new THREE.Vector3,d.x=e.readFloat32(),d.y=e.readFloat32(),d.z=e.readFloat32(),c.x=e.readFloat32(),c.y=e.readFloat32(),c.z=e.readFloat32(),0<a){for(var f=3*a,m=new Float32Array(f),g=0;g<f;++g)m[g]=e.readFloat32();n.addAttribute("position",new THREE.BufferAttribute(m,3))}if(0<o){if(4===w){var f=3*o,v=new Float32Array(f);for(g=0;g<f;++g)v[g]=e.readFloat32()}else{var y,A=1===w?1/255:1/65535,v=new Float32Array(3*o);if(1===w)for(g=0;g<o;++g){y=e.readByte(),--y;var M=e.readByte();v[3*g]=u[3*y]*M*A,M=e.readByte(),v[3*g+1]=u[3*y+1]*M*A,M=e.readByte(),v[3*g+2]=u[3*y+2]*M*A}else if(2===w)for(g=0;g<o;++g)y=e.readByte(),--y,v[3*g]=u[3*y]*e.readInt16()*A,v[3*g+1]=u[3*y+1]*e.readInt16()*A,v[3*g+2]=u[3*y+2]*e.readInt16()*A}n.addAttribute("normal",new THREE.BufferAttribute(v,3))}if(w=e.readInt32(),0<s){var f=3*s,E=new(a<=65535?Uint16Array:Uint32Array)(f);if(1===w)for(g=0;g<f;++g)E[g]=e.readByte();else if(2===w)for(g=0;g<f;++g)E[g]=e.readInt16();else if(4===w)for(g=0;g<f;++g)E[g]=e.readInt32();yt.restoreIndices(E,E.length),n.setIndex(new THREE.BufferAttribute(E,1))}}else if(1===l){if(a=e.readInt32(),s=e.readInt32(),d=new THREE.Vector3,c=new THREE.Vector3,d.x=e.readFloat32(),d.y=e.readFloat32(),d.z=e.readFloat32(),c.x=e.readFloat32(),c.y=e.readFloat32(),c.z=e.readFloat32(),0<a){f=3*a,m=new Float32Array(f);for(g=0;g<f;++g)m[g]=e.readFloat32();n.addAttribute("position",new THREE.BufferAttribute(m,3))}if(0<s){var w=e.readInt32(),E=new(a<=65535?Uint16Array:Uint32Array)(s);if(1===w)for(g=0;g<s;++g)E[g]=e.readByte();else if(2===w)for(g=0;g<s;++g)E[g]=e.readInt16();else if(4===w)for(g=0;g<s;++g)E[g]=e.readInt32();for(g=1;g<s;++g)E[g]+=E[g-1];if(!1===De.OES_element_index_uint&&65535<a){var x=new Uint16Array(s),b=0,B=0,I=1,T=0;for(g=0;g<s-1;g+=2)E[g]<=65535*I&&E[g+1]<=65535*I?(B+=2,x[g]=E[g]-b,x[g+1]=E[g+1]-b):(n.addDrawCall(T,B,b),T=g,B=0,g-=2,b+=65535*(++I-1));1!==I&&n.addDrawCall(T,B,b),n.setIndex(new THREE.BufferAttribute(x,1))}else n.setIndex(new THREE.BufferAttribute(E,1))}}n.boundingBox||(d.equals(c)?n.computeBoundingBox():n.boundingBox=new THREE.Box3(d,c)),0===l&&null==n.attributes.normal&&n.computeVertexNormals(),!1===De.OES_element_index_uint&&0===l&&65535<a&&n.computeOffsets(),n.boundingSphere=null,t&&t()}i&&i()},$.prototype.readBIMBufferVersion1=function(e,t,r,i){for(var n,a,o,s,l,d,c,h,u,p,f,m,g,v,y,A,M,E,w=e.readInt32(),x=[],b=[],B=0;B<w;++B){for(x=[],b=[],(f=r[B]).faceVertexUvs[0]=[],m=e.readInt32(),g=e.readInt32(),v=e.readInt32(),y=e.readInt32(),A=m<=255?1:m<=65535?2:4,M=g<=255?1:g<=65535?2:4,E=v<=255?1:v<=65535?2:4,n=0;n<m;++n)(c=new THREE.Vector3).x=e.readFloat32(),c.y=e.readFloat32(),c.z=e.readFloat32(),f.vertices.push(c);for(n=0;n<g;++n)(p=new THREE.Vector2).x=e.readFloat32(),p.y=e.readFloat32(),b.push(p);for(n=0;n<v;++n)(u=new THREE.Vector3).x=e.readFloat32(),u.y=e.readFloat32(),u.z=e.readFloat32(),x.push(u);for(a=0;a<y;++a){if(s=(d=e.readByte())&8,l=d&16,d=d&32,h=new THREE.Face3,1==A?(h.a=e.readByte(),h.b=e.readByte(),h.c=e.readByte()):2==A?(h.a=e.readInt16(),h.b=e.readInt16(),h.c=e.readInt16()):(h.a=e.readInt32(),h.b=e.readInt32(),h.c=e.readInt32()),o=f.faces.length,0!=s)for(n=0;n<1;n++)f.faceVertexUvs[n][o]=[],1==M?(f.faceVertexUvs[n][o].push(b[e.readByte()]),f.faceVertexUvs[n][o].push(b[e.readByte()]),f.faceVertexUvs[n][o].push(b[e.readByte()])):2==M?(f.faceVertexUvs[n][o].push(b[e.readInt16()]),f.faceVertexUvs[n][o].push(b[e.readInt16()]),f.faceVertexUvs[n][o].push(b[e.readInt16()])):(f.faceVertexUvs[n][o].push(b[e.readInt32()]),f.faceVertexUvs[n][o].push(b[e.readInt32()]),f.faceVertexUvs[n][o].push(b[e.readInt32()]));l&&(h.normal=1==E?x[e.readByte()]:2==E?x[e.readInt16()]:x[e.readInt32()]),d&&(1==E?(h.vertexNormals.push(x[e.readByte()]),h.vertexNormals.push(x[e.readByte()]),h.vertexNormals.push(x[e.readByte()])):2==E?(h.vertexNormals.push(x[e.readInt16()]),h.vertexNormals.push(x[e.readInt16()]),h.vertexNormals.push(x[e.readInt16()])):(h.vertexNormals.push(x[e.readInt32()]),h.vertexNormals.push(x[e.readInt32()]),h.vertexNormals.push(x[e.readInt32()]))),f.faces.push(h)}this.computeGeometryFaceNormal(f),f.computeBoundingBox(),t&&t()}i&&i()},$.prototype.parseString=function(e,t,r){for(var i=new Uint8Array(e,t,r),n="",a=0;a<r;a++)n+=String.fromCharCode(i[t+a]);return n},$.prototype.parseUChar8=function(e,t){return new Uint8Array(e,t,1)[0]},$.prototype.parseUInt32=function(e,t){return new Uint32Array(e,t,1)[0]},$.prototype.parseUInt16=function(e,t){return new Uint16Array(e,t,1)[0]},$.prototype.parseInt32=function(e,t){e=new Uint8Array(e,t,4),t=255&e[0];return(t|=(255&e[1])<<8)|(255&e[2])<<16|(255&e[3])<<24},$.prototype.parseInt16=function(e,t){e=new Uint8Array(e,t,2);return 255&e[0]|(255&e[1])<<8},$.prototype.parseFloat32Lzma=function(e,t){e=new Uint8Array(e,t,4),t=255&e[0];return(t|=(255&e[1])<<8)|(255&e[2])<<16|(255&e[3])<<24},$.prototype.readUuid=function(e){for(var t=[e.readInt32()>>>0,e.readInt32()>>>0,e.readInt32()>>>0,e.readInt32()>>>0],r="",i=0,i=0;i<4;++i){var n=t[i].toString(16);n.length<8&&(r+="00000000".slice(0,8-n.length)),r+=n}return r=0!=De.ScenarioEditorid?Pe.addSceneID(r):r},$.prototype.readUuid3=function(e){e=(e.readInt32()>>>0).toString();return e=0!=De.ScenarioEditorid?Pe.addSceneID(e):e},$.prototype.readBvhV1=function(e,t,r){for(var i,n,a=e.readInt32(),o=(t&&t.setNumNodes(a),new Float32Array(6)),s=0,l=0;l<a;++l){for(var d=0;d<6;++d)o[d]=e.readFloat32();i=e.readInt32(),s=e.readInt32(),n=e.readInt32(),t&&t.setNode(l,o,i,s,n)}for(var c,h,s=e.readInt32(),u=new Int32Array(s),p=0;p<s;++p)u[p]=e.readInt32();t&&t.setMeshIds(u),r.setNumMeshes(s);for(p=0;p<s;++p){for(var f=this.readUuid(e),m=e.readInt32(),d=0;d<6;++d)o[d]=e.readFloat32();e.readInt32(),c=e.readInt32(),h=e.readInt32(),e.readInt32(),r.setMeshFromGeomUuid(p,o,f,m,c,h)}for(var g=e.readInt32(),v=new THREE.Matrix4,y=0;y<g;++y)v.set(e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32());for(var A,M=e.readInt32(),E=[],d=0;d<M;++d)A=this.readUuid(e),E.push(A);r.setMaterialUuids(E);for(var w,x=e.readInt32(),b=[],B=0;B<x;++B)w=this.readUuid(e),b.push(w);var I=e.readInt32();r.setNumLineSegments(I);for(var T=0;T<I;++T)f=this.readUuid(e),e.readInt32(),h=e.readInt32(),e.readInt32(),r.setLineSegmentsFromGeomUuid(T,f,h);r.setBodyUuids(b)},$.prototype.readBvhV2=function(e,t,r,i){for(var n,a,o=e.readInt32(),s=(t&&t.setNumNodes(o),new Float32Array(6)),l=0,d=0;d<o;++d){for(var c=0;c<6;++c)s[c]=e.readFloat32();n=e.readInt32(),l=e.readInt32(),a=e.readInt32(),t&&t.setNode(d,s,n,l,a)}for(var h,u,l=e.readInt32(),p=new Int32Array(l),f=0;f<l;++f)p[f]=e.readInt32();t&&t.setMeshIds(p),r.setNumMeshes(l);for(f=0;f<l;++f){for(var m=2<i?this.readUuid3(e):this.readUuid(e),g=e.readInt32(),c=0;c<6;++c)s[c]=e.readFloat32();e.readInt32(),h=e.readInt32(),u=e.readInt32(),e.readInt32(),r.setMeshFromGeomUuid(f,s,m,g,h,u)}for(var v=e.readInt32(),y=new THREE.Matrix4,A=0;A<v;++A)y.set(e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32());for(var M,E=e.readInt32(),w=[],c=0;c<E;++c)M=2<i?this.readUuid3(e):this.readUuid(e),w.push(M);r.setMaterialUuids(w);for(var x,b=e.readInt32(),B=[],I=0;I<b;++I)x=2<i?this.readUuid3(e):this.readUuid(e),B.push(x);var T=e.readInt32();r.setNumLineSegments(T);for(var S=0;S<T;++S)m=2<i?this.readUuid3(e):this.readUuid(e),e.readInt32(),h=e.readInt32(),u=e.readInt32(),e.readInt32(),r.setLineSegmentsFromGeomUuid(S,m,u,h);r.setBodyUuids(B)},$.prototype.readBvhV3=function(e,t){for(var r,i,n,a,o,s,l=e.readInt32(),d=(t.setNumNodes(l),new Float32Array(6)),c=0,h=0;h<l;++h){e.readInt32();for(var u=0;u<6;++u)d[u]=e.readFloat32();r=e.readInt32(),c=e.readInt32(),a=e.readInt32(),i=e.readInt32(),o=e.readInt32(),n=e.readInt32(),s=e.readInt32(),t.setNode(h,d,r,c,a,i,o,n,s)}for(var p,f=e.readInt32(),m=[],u=0;u<f;++u)p=0===this.materialIdType?this.readUuid3(e):this.readUuid(e),m.push(p);t.meshManager.setMaterialUuids(m);for(var g,v=e.readInt32(),y=[],A=0;A<v;++A)g=0===this.objectIdType?this.readUuid3(e):this.readUuid(e),y.push(g);for(var M,E,c=e.readInt32(),w=new Int32Array(c),x=0;x<c;++x)w[x]=x;t.setMeshIds(w),t.meshManager.setNumMeshes(c,!0,!1);for(var b=0;b<c;++b){for(var B=e.readInt32(),I=0===this.geomIdType?this.readUuid3(e):this.readUuid(e),T=e.readInt32(),u=0;u<6;++u)d[u]=e.readFloat32();M=e.readInt32(),E=e.readInt32(),e.readInt32(),t.meshManager.setMeshFromGeomUuid(b,d,I,T,M,E,B,-1)}var S=e.readInt32();t.meshManager.setNumLineSegments(S,!0,!1);for(var R=0;R<S;++R)B=e.readInt32(),I=0===this.geomIdType?this.readUuid3(e):this.readUuid(e),M=e.readInt32(),E=e.readInt32(),e.readInt32(),t.meshManager.setLineSegmentsFromGeomUuid(R,I,E,M,B,-1);var C=e.readInt32();t.meshManager.setNumTexts(C,!0,!1);for(var D=0;D<C;++D)B=e.readInt32(),I=0===this.geomIdType?this.readUuid3(e):this.readUuid(e),M=e.readInt32(),E=e.readInt32(),e.readInt32(),t.meshManager.setTextFromGeomUuid(D,I,E,M,B,-1);t.meshManager.setBodyUuids(y)},$.prototype.readBvhV4=function(e,t,r,i,n,a){void 0===i&&(i=null),void 0===n&&(n=0),void 0===a&&(a=null);for(var o,s,l,d,c,h,u=new THREE.Matrix4,p=new THREE.Box3,f=e.readInt32(),m=e.readByte(),g=(t&&t.setNumNodes(f),new Float32Array(6)),v=0,O=function(e){return!(e[0]>e[3]||e[1]>e[4]||e[2]>e[5])},F=function(){p.min.fromArray(g,0),p.max.fromArray(g,3),p.applyMatrix4(i),g[0]=p.min.x,g[1]=p.min.y,g[2]=p.min.z,g[3]=p.max.x,g[4]=p.max.y,g[5]=p.max.z},y=0;y<f;++y){e.readInt32();for(var A=0;A<6;++A)g[A]=e.readFloat32();i&&O(g)&&F(),o=e.readInt32(),v=e.readInt32(),d=e.readInt32(),s=e.readInt32(),c=e.readInt32(),l=e.readInt32(),h=e.readInt32(),t&&t.setNode(y,g,o,v,d,s,c,l,h)}var M=null;if(1===m)for(var U=e.readInt32(),M=new Float32Array(16*U),y=0;y<U;++y){for(A=0;A<16;++A){var N=e.readFloat32();M[16*y+A]=N,i&&(u.elements[A]=N)}i&&(u.premultiply(i),M.set(u.elements,offset))}for(var E,w=0,V=(1===m&&(w=r.expandMatrixes(M)),e.readInt32()),x=[],A=0;A<V;++A)E=0===this.materialIdType?this.readUuid3(e):this.readUuid(e),r.ndsModel.viewer.ndsModel.materialuuidOld2New[E]&&(E=r.ndsModel.viewer.ndsModel.materialuuidOld2New[E]),a&&a.uuidMaterialMap.has(E)?x.push(a.uuidMaterialMap.get(E).uuid):x.push(E);for(var b,B=r.expandMaterialUuids(x),G=e.readInt32(),k=[],j=0;j<G;++j)b=0===this.objectIdType?this.readUuid3(e):this.readUuid(e),0<n&&(b+="_"+n),k.push(b);for(var I,T,S,v=e.readInt32(),R=r.expandMeshes(v,!0,1===m),z=new Int32Array(v),C=0;C<v;++C)z[C]=R+C;t&&t.setMeshIds(z);for(var D=0;D<v;++D){for(var P=e.readInt32(),H=0===this.geomIdType?this.readUuid3(e):this.readUuid(e),W=e.readInt32(),A=0;A<6;++A)g[A]=e.readFloat32();i&&O(g)&&F(),I=e.readInt32(),B&&(I=B[I]),T=e.readInt32(),e.readInt32(),S=-1,1===m&&(S=e.readInt32()),r.setMeshFromGeomUuid(R+D,g,H,W,I,T,P,w+S)}for(var X=e.readInt32(),q=r.expandLineSegments(X,!0,1===m),_=0;_<X;++_)P=e.readInt32(),H=0===this.geomIdType?this.readUuid3(e):this.readUuid(e),I=e.readInt32(),B&&(I=B[I]),T=e.readInt32(),e.readInt32(),S=-1,1===m&&(S=e.readInt32()),r.setLineSegmentsFromGeomUuid(q+_,H,T,I,P,w+S);for(var Y=e.readInt32(),Q=r.expandTexts(Y,!0,1===m),L=0;L<Y;++L)P=e.readInt32(),H=0===this.geomIdType?this.readUuid3(e):this.readUuid(e),I=e.readInt32(),B&&(I=B[I]),T=e.readInt32(),e.readInt32(),S=-1,1===m&&(S=e.readInt32()),r.setTextFromGeomUuid(Q+L,H,T,I,P,w+S);r.expandBodyUuids(k,R,q,Q)},$.prototype.readBvh=function(e,t,r){e.readString();var i=e.readInt32();t.bvhVersion=i,t.bvh&&(t.bvh.version=i),5===i||4===i?this.readBvhV4(e,t.bvh,t.meshManager,t.worldMatrix,t.numRef,t.refModelContext):1==i?this.readBvhV1(e,t.bvh,t.meshManager):1<i&&this.readBvhV2(e,t.bvh,t.meshManager,i),r&&r()},$.prototype.readBrep=function(e,t,O){for(var r=e.readByte(),F=(t.version=r,e.readInt32()),i=new Array(F),n=0;n<F;++n){var U=e.readGuid(),a=(i[n]={geomUUID:U},e.readInt32());if(0<a){i[n].lines={ids:new Int32Array(a),indexRanges:new Int32Array(2*a),lengthes:new Float32Array(a)};for(var o=0;o<a;++o)i[n].lines.ids[o]=e.readInt32(),i[n].lines.indexRanges[2*o]=e.readInt32(),i[n].lines.indexRanges[2*o+1]=e.readInt32(),i[n].lines.lengthes[o]=e.readFloat32()}var s=e.readInt32();if(0<s){i[n].circles={ids:new Int32Array(s),indexRanges:new Int32Array(2*s),lengthes:new Float32Array(s),centers:new Float32Array(3*s),radiuses:new Float32Array(s)};for(var l=0;l<s;++l){i[n].circles.ids[l]=e.readInt32(),i[n].circles.indexRanges[2*l]=e.readInt32(),i[n].circles.indexRanges[2*l+1]=e.readInt32(),i[n].circles.lengthes[l]=e.readFloat32();for(var N=0;N<3;++N)i[n].circles.centers[3*l+N]=e.readFloat32();i[n].circles.radiuses[l]=e.readFloat32()}}var d=e.readInt32();if(0<d){i[n].ellipses={ids:new Int32Array(d),indexRanges:new Int32Array(2*d),lengthes:new Float32Array(d)};for(var c=0;c<d;++c)i[n].ellipses.ids[c]=e.readInt32(),i[n].ellipses.indexRanges[2*c]=e.readInt32(),i[n].ellipses.indexRanges[2*c+1]=e.readInt32(),i[n].ellipses.lengthes[c]=e.readFloat32()}var h=e.readInt32();if(0<h){i[n].nurbses={ids:new Int32Array(h),indexRanges:new Int32Array(2*h),lengthes:new Float32Array(h)};for(var u=0;u<h;++u)i[n].nurbses.ids[u]=e.readInt32(),i[n].nurbses.indexRanges[2*u]=e.readInt32(),i[n].nurbses.indexRanges[2*u+1]=e.readInt32(),i[n].nurbses.lengthes[u]=e.readFloat32()}var p=e.readInt32();if(0<p){i[n].others={ids:new Int32Array(p),indexRanges:new Int32Array(2*p),lengthes:new Float32Array(p)};for(var f=0;f<p;++f)i[n].others.ids[f]=e.readInt32(),i[n].others.indexRanges[2*f]=e.readInt32(),i[n].others.indexRanges[2*f+1]=e.readInt32(),i[n].others.lengthes[f]=e.readFloat32()}}for(var V=t.brepInfos.edgeGroups.length,G=(t.brepInfos.edgeGroups=t.brepInfos.edgeGroups.concat(i),e.readInt32()),m=new Array(G),g=0;g<G;++g){var k=e.readGuid(),v=(m[g]={geomUUID:k,loopPerimeters:[],loopStartEdgeId:[]},e.readInt32());if(0<v){m[g].planes={ids:new Int32Array(v),triIndexRanges:new Int32Array(2*v),areas:new(r<7?Float32Array:Float64Array)(v),origins:new Float32Array(3*v),normals:new Float32Array(3*v),loops:new Int32Array(2*v)};for(var y=0;y<v;++y){m[g].planes.ids[y]=e.readInt32(),m[g].planes.triIndexRanges[2*y]=e.readInt32(),m[g].planes.triIndexRanges[2*y+1]=e.readInt32(),m[g].planes.areas[y]=r<7?e.readFloat32():e.readFloat64();for(var j=e.readInt32(),z=m[g].loopPerimeters.length,A=0;A<j;++A)m[g].loopPerimeters[z+A]=e.readFloat32(),m[g].loopStartEdgeId[z+A]=e.readInt32();m[g].planes.loops[2*y]=z,m[g].planes.loops[2*y+1]=j;for(var W=0;W<3;++W)m[g].planes.origins[3*y+W]=e.readFloat32();for(var X=0;X<3;++X)m[g].planes.normals[3*y+X]=e.readFloat32()}}var M=e.readInt32();if(0<M){m[g].cylinders={ids:new Int32Array(M),triIndexRanges:new Int32Array(2*M),areas:new(r<7?Float32Array:Float64Array)(M),loops:new Int32Array(2*M),origins:new Float32Array(3*M),axis:new Float32Array(3*M),radiuses:new Float32Array(M)};for(var E=0;E<M;++E){m[g].cylinders.ids[E]=e.readInt32(),m[g].cylinders.triIndexRanges[2*E]=e.readInt32(),m[g].cylinders.triIndexRanges[2*E+1]=e.readInt32(),m[g].cylinders.areas[E]=r<7?e.readFloat32():e.readFloat64();for(var q=e.readInt32(),Y=m[g].loopPerimeters.length,w=0;w<q;++w)m[g].loopPerimeters[Y+w]=e.readFloat32(),m[g].loopStartEdgeId[Y+w]=e.readInt32();m[g].cylinders.loops[2*E]=Y,m[g].cylinders.loops[2*E+1]=q;for(var Q=0;Q<3;++Q)m[g].cylinders.axis[3*E+Q]=e.readFloat32();for(var K=0;K<3;++K)m[g].cylinders.origins[3*E+K]=e.readFloat32();m[g].cylinders.radiuses[E]=e.readFloat32()}}var x=e.readInt32();if(0<x){m[g].cones={ids:new Int32Array(x),triIndexRanges:new Int32Array(2*x),areas:new(r<7?Float32Array:Float64Array)(x),loops:new Int32Array(2*x),origins:new Float32Array(3*x),axis:new Float32Array(3*x),radiuses:new Float32Array(x)};for(var b=0;b<x;++b){m[g].cones.ids[b]=e.readInt32(),m[g].cones.triIndexRanges[2*b]=e.readInt32(),m[g].cones.triIndexRanges[2*b+1]=e.readInt32(),m[g].cones.areas[b]=r<7?e.readFloat32():e.readFloat64();for(var Z=e.readInt32(),J=m[g].loopPerimeters.length,B=0;B<Z;++B)m[g].loopPerimeters[J+B]=e.readFloat32(),m[g].loopStartEdgeId[J+B]=e.readInt32();m[g].cones.loops[2*b]=J,m[g].cones.loops[2*b+1]=Z;for(var $=0;$<3;++$)m[g].cones.axis[3*b+$]=e.readFloat32();for(var ee=0;ee<3;++ee)m[g].cones.origins[3*b+ee]=e.readFloat32();m[g].cones.radiuses[b]=e.readFloat32()}}var I=e.readInt32();if(0<I){m[g].spheres={ids:new Int32Array(I),triIndexRanges:new Int32Array(2*I),areas:new(r<7?Float32Array:Float64Array)(I),loops:new Int32Array(2*I)};for(var T=0;T<I;++T){m[g].spheres.ids[T]=e.readInt32(),m[g].spheres.triIndexRanges[2*T]=e.readInt32(),m[g].spheres.triIndexRanges[2*T+1]=e.readInt32(),m[g].spheres.areas[T]=r<7?e.readFloat32():e.readFloat64();for(var te=e.readInt32(),re=m[g].loopPerimeters.length,ie=0;ie<te;++ie)m[g].loopPerimeters[re+ie]=e.readFloat32(),m[g].loopStartEdgeId[re+ie]=e.readInt32();m[g].spheres.loops[2*T]=re,m[g].spheres.loops[2*T+1]=te}}var S=e.readInt32();if(0<S){m[g].toruses={ids:new Int32Array(S),triIndexRanges:new Int32Array(2*S),areas:new(r<7?Float32Array:Float64Array)(S),loops:new Int32Array(2*S)};for(var R=0;R<S;++R){m[g].toruses.ids[R]=e.readInt32(),m[g].toruses.triIndexRanges[2*R]=e.readInt32(),m[g].toruses.triIndexRanges[2*R+1]=e.readInt32(),m[g].toruses.areas[R]=r<7?e.readFloat32():e.readFloat64();for(var ne=e.readInt32(),ae=m[g].loopPerimeters.length,oe=0;oe<ne;++oe)m[g].loopPerimeters[ae+oe]=e.readFloat32(),m[g].loopStartEdgeId[ae+oe]=e.readInt32();m[g].toruses.loops[2*R]=ae,m[g].toruses.loops[2*R+1]=ne}}var C=e.readInt32();if(0<C){m[g].nurbses={ids:new Int32Array(C),triIndexRanges:new Int32Array(2*C),areas:new(r<7?Float32Array:Float64Array)(C),loops:new Int32Array(2*C)};for(var D=0;D<C;++D){m[g].nurbses.ids[D]=e.readInt32(),m[g].nurbses.triIndexRanges[2*D]=e.readInt32(),m[g].nurbses.triIndexRanges[2*D+1]=e.readInt32(),m[g].nurbses.areas[D]=r<7?e.readFloat32():e.readFloat64();for(var se=e.readInt32(),le=m[g].loopPerimeters.length,de=0;de<se;++de)m[g].loopPerimeters[le+de]=e.readFloat32(),m[g].loopStartEdgeId[le+de]=e.readInt32();m[g].nurbses.loops[2*D]=le,m[g].nurbses.loops[2*D+1]=se}}var P=e.readInt32();if(0<P){m[g].others={ids:new Int32Array(P),triIndexRanges:new Int32Array(2*P),areas:new(r<7?Float32Array:Float64Array)(P),loops:new Int32Array(2*P)};for(var H=0;H<P;++H){m[g].others.ids[H]=e.readInt32(),m[g].others.triIndexRanges[2*H]=e.readInt32(),m[g].others.triIndexRanges[2*H+1]=e.readInt32(),m[g].others.areas[H]=r<7?e.readFloat32():e.readFloat64();for(var ce=e.readInt32(),he=m[g].loopPerimeters.length,ue=0;ue<ce;++ue)m[g].loopPerimeters[he+ue]=e.readFloat32(),m[g].loopStartEdgeId[he+ue]=e.readInt32();m[g].others.loops[2*H]=he,m[g].others.loops[2*H+1]=ce}}}for(var pe=t.brepInfos.faceGroups.length,fe=(t.brepInfos.faceGroups=t.brepInfos.faceGroups.concat(m),e.readInt32()),me=new Uint32Array(fe),ge=new Float32Array(3*fe),ve=0;ve<fe;++ve){me[ve]=e.readInt32();for(var ye=0;ye<3;++ye)ge[3*ve+ye]=e.readFloat32()}t.brepInfos.vertices={ids:me,coords:ge};for(var Ae=e.readInt32(),_=new Array(Ae),L=0;L<Ae;++L){_[L]={},_[L].area=r<7?e.readFloat32():e.readFloat64(),_[L].volume=r<7?e.readFloat32():e.readFloat64();var Me=e.readInt32();if(0<Me){_[L].edgeGroups=new Int32Array(Me);for(var Ee=0;Ee<Me;++Ee)_[L].edgeGroups[Ee]=e.readInt32()+V}var we=e.readInt32();if(0<we){_[L].faceGroups=new Int32Array(we);for(var xe=0;xe<we;++xe)_[L].faceGroups[xe]=e.readInt32()+pe}var be=e.readInt32();if(0<be){_[L].vertices=new Int32Array(be);for(var Be=0;Be<be;++Be)_[L].vertices[Be]=e.readInt32()}}for(var Ie=t.brepInfos.breps.length,Te=(t.brepInfos.breps=t.brepInfos.breps.concat(_),e.readInt32()),Se=0;Se<Te;++Se){var Re=e.readGuid(),Ce=e.readInt32();t.brepInfos.bodies.set(Re,Ce+Ie)}},$.prototype.readBrep8=function(e,t,O){for(var r=e.readByte(),F=(t.version=r,e.readInt32()),i=new Array(F),n=0;n<F;++n){var U=e.readGuid(),a=(i[n]={geomUUID:U},e.readInt32());if(0<a){i[n].lines={ids:new Int32Array(a),indexRanges:new Int32Array(2*a),lengthes:new Float32Array(a),persist:[]};for(var o=0;o<a;++o)i[n].lines.ids[o]=e.readInt32(),i[n].lines.indexRanges[2*o]=e.readInt32(),i[n].lines.indexRanges[2*o+1]=e.readInt32(),i[n].lines.lengthes[o]=e.readFloat32(),i[n].lines.persist[o]=e.readGuid()}var s=e.readInt32();if(0<s){i[n].circles={ids:new Int32Array(s),indexRanges:new Int32Array(2*s),lengthes:new Float32Array(s),persist:[],centers:new Float32Array(3*s),radiuses:new Float32Array(s)};for(var l=0;l<s;++l){i[n].circles.ids[l]=e.readInt32(),i[n].circles.indexRanges[2*l]=e.readInt32(),i[n].circles.indexRanges[2*l+1]=e.readInt32(),i[n].circles.lengthes[l]=e.readFloat32(),i[n].circles.persist[l]=e.readGuid();for(var N=0;N<3;++N)i[n].circles.centers[3*l+N]=e.readFloat32();i[n].circles.radiuses[l]=e.readFloat32()}}var d=e.readInt32();if(0<d){i[n].ellipses={ids:new Int32Array(d),indexRanges:new Int32Array(2*d),lengthes:new Float32Array(d),persist:[]};for(var c=0;c<d;++c)i[n].ellipses.ids[c]=e.readInt32(),i[n].ellipses.indexRanges[2*c]=e.readInt32(),i[n].ellipses.indexRanges[2*c+1]=e.readInt32(),i[n].ellipses.lengthes[c]=e.readFloat32(),i[n].ellipses.persist[c]=e.readGuid()}var h=e.readInt32();if(0<h){i[n].nurbses={ids:new Int32Array(h),indexRanges:new Int32Array(2*h),lengthes:new Float32Array(h),persist:[]};for(var u=0;u<h;++u)i[n].nurbses.ids[u]=e.readInt32(),i[n].nurbses.indexRanges[2*u]=e.readInt32(),i[n].nurbses.indexRanges[2*u+1]=e.readInt32(),i[n].nurbses.lengthes[u]=e.readFloat32(),i[n].nurbses.persist[u]=e.readGuid()}var p=e.readInt32();if(0<p){i[n].others={ids:new Int32Array(p),indexRanges:new Int32Array(2*p),lengthes:new Float32Array(p),persist:[]};for(var f=0;f<p;++f)i[n].others.ids[f]=e.readInt32(),i[n].others.indexRanges[2*f]=e.readInt32(),i[n].others.indexRanges[2*f+1]=e.readInt32(),i[n].others.lengthes[f]=e.readFloat32(),i[n].others.persist[f]=e.readGuid()}}for(var V=t.brepInfos.edgeGroups.length,G=(t.brepInfos.edgeGroups=t.brepInfos.edgeGroups.concat(i),e.readInt32()),m=new Array(G),g=0;g<G;++g){var k=e.readGuid(),v=(m[g]={geomUUID:k,loopPerimeters:[],loopStartEdgeId:[]},e.readInt32());if(0<v){m[g].planes={ids:new Int32Array(v),triIndexRanges:new Int32Array(2*v),areas:new(r<7?Float32Array:Float64Array)(v),origins:new Float32Array(3*v),normals:new Float32Array(3*v),loops:new Int32Array(2*v),persist:[]};for(var y=0;y<v;++y){m[g].planes.ids[y]=e.readInt32(),m[g].planes.triIndexRanges[2*y]=e.readInt32(),m[g].planes.triIndexRanges[2*y+1]=e.readInt32(),m[g].planes.areas[y]=r<7?e.readFloat32():e.readFloat64();for(var j=e.readInt32(),z=m[g].loopPerimeters.length,A=0;A<j;++A)m[g].loopPerimeters[z+A]=e.readFloat32(),m[g].loopStartEdgeId[z+A]=e.readInt32();m[g].planes.persist[y]=e.readGuid(),m[g].planes.loops[2*y]=z,m[g].planes.loops[2*y+1]=j;for(var W=0;W<3;++W)m[g].planes.origins[3*y+W]=e.readFloat32();for(var X=0;X<3;++X)m[g].planes.normals[3*y+X]=e.readFloat32()}}var M=e.readInt32();if(0<M){m[g].cylinders={ids:new Int32Array(M),triIndexRanges:new Int32Array(2*M),areas:new(r<7?Float32Array:Float64Array)(M),persist:[],loops:new Int32Array(2*M),origins:new Float32Array(3*M),axis:new Float32Array(3*M),radiuses:new Float32Array(M)};for(var E=0;E<M;++E){m[g].cylinders.ids[E]=e.readInt32(),m[g].cylinders.triIndexRanges[2*E]=e.readInt32(),m[g].cylinders.triIndexRanges[2*E+1]=e.readInt32(),m[g].cylinders.areas[E]=r<7?e.readFloat32():e.readFloat64();for(var q=e.readInt32(),Y=m[g].loopPerimeters.length,w=0;w<q;++w)m[g].loopPerimeters[Y+w]=e.readFloat32(),m[g].loopStartEdgeId[Y+w]=e.readInt32();m[g].cylinders.persist[E]=e.readGuid(),m[g].cylinders.loops[2*E]=Y,m[g].cylinders.loops[2*E+1]=q;for(var Q=0;Q<3;++Q)m[g].cylinders.axis[3*E+Q]=e.readFloat32();for(var K=0;K<3;++K)m[g].cylinders.origins[3*E+K]=e.readFloat32();m[g].cylinders.radiuses[E]=e.readFloat32()}}var x=e.readInt32();if(0<x){m[g].cones={ids:new Int32Array(x),triIndexRanges:new Int32Array(2*x),areas:new(r<7?Float32Array:Float64Array)(x),persist:[],loops:new Int32Array(2*x),origins:new Float32Array(3*x),axis:new Float32Array(3*x),radiuses:new Float32Array(x)};for(var b=0;b<x;++b){m[g].cones.ids[b]=e.readInt32(),m[g].cones.triIndexRanges[2*b]=e.readInt32(),m[g].cones.triIndexRanges[2*b+1]=e.readInt32(),m[g].cones.areas[b]=r<7?e.readFloat32():e.readFloat64();for(var Z=e.readInt32(),J=m[g].loopPerimeters.length,B=0;B<Z;++B)m[g].loopPerimeters[J+B]=e.readFloat32(),m[g].loopStartEdgeId[J+B]=e.readInt32();m[g].cones.persist[b]=e.readGuid(),m[g].cones.loops[2*b]=J,m[g].cones.loops[2*b+1]=Z;for(var $=0;$<3;++$)m[g].cones.axis[3*b+$]=e.readFloat32();for(var ee=0;ee<3;++ee)m[g].cones.origins[3*b+ee]=e.readFloat32();m[g].cones.radiuses[b]=e.readFloat32()}}var I=e.readInt32();if(0<I){m[g].spheres={ids:new Int32Array(I),triIndexRanges:new Int32Array(2*I),areas:new(r<7?Float32Array:Float64Array)(I),persist:[],loops:new Int32Array(2*I)};for(var T=0;T<I;++T){m[g].spheres.ids[T]=e.readInt32(),m[g].spheres.triIndexRanges[2*T]=e.readInt32(),m[g].spheres.triIndexRanges[2*T+1]=e.readInt32(),m[g].spheres.areas[T]=r<7?e.readFloat32():e.readFloat64();for(var te=e.readInt32(),re=m[g].loopPerimeters.length,ie=0;ie<te;++ie)m[g].loopPerimeters[re+ie]=e.readFloat32(),m[g].loopStartEdgeId[re+ie]=e.readInt32();m[g].spheres.persist[T]=e.readGuid(),m[g].spheres.loops[2*T]=re,m[g].spheres.loops[2*T+1]=te}}var S=e.readInt32();if(0<S){m[g].toruses={ids:new Int32Array(S),triIndexRanges:new Int32Array(2*S),areas:new(r<7?Float32Array:Float64Array)(S),persist:[],loops:new Int32Array(2*S)};for(var R=0;R<S;++R){m[g].toruses.ids[R]=e.readInt32(),m[g].toruses.triIndexRanges[2*R]=e.readInt32(),m[g].toruses.triIndexRanges[2*R+1]=e.readInt32(),m[g].toruses.areas[R]=r<7?e.readFloat32():e.readFloat64();for(var ne=e.readInt32(),ae=m[g].loopPerimeters.length,oe=0;oe<ne;++oe)m[g].loopPerimeters[ae+oe]=e.readFloat32(),m[g].loopStartEdgeId[ae+oe]=e.readInt32();m[g].toruses.persist[R]=e.readGuid(),m[g].toruses.loops[2*R]=ae,m[g].toruses.loops[2*R+1]=ne}}var C=e.readInt32();if(0<C){m[g].nurbses={ids:new Int32Array(C),triIndexRanges:new Int32Array(2*C),areas:new(r<7?Float32Array:Float64Array)(C),loops:new Int32Array(2*C),persist:[]};for(var D=0;D<C;++D){m[g].nurbses.ids[D]=e.readInt32(),m[g].nurbses.triIndexRanges[2*D]=e.readInt32(),m[g].nurbses.triIndexRanges[2*D+1]=e.readInt32(),m[g].nurbses.areas[D]=r<7?e.readFloat32():e.readFloat64();for(var se=e.readInt32(),le=m[g].loopPerimeters.length,de=0;de<se;++de)m[g].loopPerimeters[le+de]=e.readFloat32(),m[g].loopStartEdgeId[le+de]=e.readInt32();m[g].nurbses.persist[D]=e.readGuid(),m[g].nurbses.loops[2*D]=le,m[g].nurbses.loops[2*D+1]=se}}var P=e.readInt32();if(0<P){m[g].others={ids:new Int32Array(P),triIndexRanges:new Int32Array(2*P),areas:new(r<7?Float32Array:Float64Array)(P),loops:new Int32Array(2*P),persist:[]};for(var H=0;H<P;++H){m[g].others.ids[H]=e.readInt32(),m[g].others.triIndexRanges[2*H]=e.readInt32(),m[g].others.triIndexRanges[2*H+1]=e.readInt32(),m[g].others.areas[H]=r<7?e.readFloat32():e.readFloat64();for(var ce=e.readInt32(),he=m[g].loopPerimeters.length,ue=0;ue<ce;++ue)m[g].loopPerimeters[he+ue]=e.readFloat32(),m[g].loopStartEdgeId[he+ue]=e.readInt32();m[g].others.persist[H]=e.readGuid(),m[g].others.loops[2*H]=he,m[g].others.loops[2*H+1]=ce}}}for(var pe=t.brepInfos.faceGroups.length,fe=(t.brepInfos.faceGroups=t.brepInfos.faceGroups.concat(m),e.readInt32()),me=new Uint32Array(fe),ge=new Float32Array(3*fe),ve=0;ve<fe;++ve){me[ve]=e.readInt32();for(var ye=0;ye<3;++ye)ge[3*ve+ye]=e.readFloat32()}t.brepInfos.vertices={ids:me,coords:ge};for(var Ae=e.readInt32(),_=new Array(Ae),L=0;L<Ae;++L){_[L]={},_[L].area=r<7?e.readFloat32():e.readFloat64(),_[L].volume=r<7?e.readFloat32():e.readFloat64();var Me=e.readInt32();if(0<Me){_[L].edgeGroups=new Int32Array(Me);for(var Ee=0;Ee<Me;++Ee)_[L].edgeGroups[Ee]=e.readInt32()+V}var we=e.readInt32();if(0<we){_[L].faceGroups=new Int32Array(we);for(var xe=0;xe<we;++xe)_[L].faceGroups[xe]=e.readInt32()+pe}var be=e.readInt32();if(0<be){_[L].vertices=new Int32Array(be);for(var Be=0;Be<be;++Be)_[L].vertices[Be]=e.readInt32()}}for(var Ie=t.brepInfos.breps.length,Te=(t.brepInfos.breps=t.brepInfos.breps.concat(_),e.readInt32()),Se=0;Se<Te;++Se){var Re=e.readGuid(),Ce=e.readInt32();t.brepInfos.bodies.set(Re,Ce+Ie)}},$.prototype.readBrep9=function(e,t,O){for(var r=e.readByte(),F=(t.version=r,e.readInt32()),i=new Array(F),n=0;n<F;++n){var U=e.readGuid(),a=(i[n]={geomUUID:U},e.readInt32());if(0<a){i[n].lines={ids:new Int32Array(a),indexRanges:new Int32Array(2*a),lengthes:new Float32Array(a),persist:[]};for(var o=0;o<a;++o)i[n].lines.ids[o]=e.readInt32(),i[n].lines.indexRanges[2*o]=e.readInt32(),i[n].lines.indexRanges[2*o+1]=e.readInt32(),i[n].lines.lengthes[o]=e.readFloat32(),i[n].lines.persist[o]=e.readGuid()}var s=e.readInt32();if(0<s){i[n].circles={ids:new Int32Array(s),indexRanges:new Int32Array(2*s),lengthes:new Float32Array(s),persist:[],normals:new Float32Array(3*s),centers:new Float32Array(3*s),radiuses:new Float32Array(s)};for(var l=0;l<s;++l){i[n].circles.ids[l]=e.readInt32(),i[n].circles.indexRanges[2*l]=e.readInt32(),i[n].circles.indexRanges[2*l+1]=e.readInt32(),i[n].circles.lengthes[l]=e.readFloat32(),i[n].circles.persist[l]=e.readGuid();for(var N=0;N<3;++N)i[n].circles.normals[3*l+N]=e.readFloat32();for(var V=0;V<3;++V)i[n].circles.centers[3*l+V]=e.readFloat32();i[n].circles.radiuses[l]=e.readFloat32()}}var d=e.readInt32();if(0<d){i[n].ellipses={ids:new Int32Array(d),indexRanges:new Int32Array(2*d),lengthes:new Float32Array(d),persist:[],normals:new Float32Array(3*d),centers:new Float32Array(3*d),axisX:new Float32Array(3*d),radiusX:new Float32Array(d),radiusY:new Float32Array(d)};for(var c=0;c<d;++c){i[n].ellipses.ids[c]=e.readInt32(),i[n].ellipses.indexRanges[2*c]=e.readInt32(),i[n].ellipses.indexRanges[2*c+1]=e.readInt32(),i[n].ellipses.lengthes[c]=e.readFloat32(),i[n].ellipses.persist[c]=e.readGuid();for(var G=0;G<3;++G)i[n].ellipses.normals[3*c+G]=e.readFloat32();for(var k=0;k<3;++k)i[n].ellipses.centers[3*c+k]=e.readFloat32();for(var j=0;j<3;++j)i[n].ellipses.axisX[3*c+j]=e.readFloat32();i[n].ellipses.radiusX[c]=e.readFloat32(),i[n].ellipses.radiusY[c]=e.readFloat32()}}var h=e.readInt32();if(0<h){i[n].nurbses={ids:new Int32Array(h),indexRanges:new Int32Array(2*h),lengthes:new Float32Array(h),persist:[]};for(var u=0;u<h;++u)i[n].nurbses.ids[u]=e.readInt32(),i[n].nurbses.indexRanges[2*u]=e.readInt32(),i[n].nurbses.indexRanges[2*u+1]=e.readInt32(),i[n].nurbses.lengthes[u]=e.readFloat32(),i[n].nurbses.persist[u]=e.readGuid()}var p=e.readInt32();if(0<p){i[n].others={ids:new Int32Array(p),indexRanges:new Int32Array(2*p),lengthes:new Float32Array(p),persist:[]};for(var f=0;f<p;++f)i[n].others.ids[f]=e.readInt32(),i[n].others.indexRanges[2*f]=e.readInt32(),i[n].others.indexRanges[2*f+1]=e.readInt32(),i[n].others.lengthes[f]=e.readFloat32(),i[n].others.persist[f]=e.readGuid()}}for(var z=t.brepInfos.edgeGroups.length,W=(t.brepInfos.edgeGroups=t.brepInfos.edgeGroups.concat(i),e.readInt32()),m=new Array(W),g=0;g<W;++g){var X=e.readGuid(),v=(m[g]={geomUUID:X,loopPerimeters:[],loopStartEdgeId:[]},e.readInt32());if(0<v){m[g].planes={ids:new Int32Array(v),triIndexRanges:new Int32Array(2*v),areas:new(r<7?Float32Array:Float64Array)(v),origins:new Float32Array(3*v),normals:new Float32Array(3*v),loops:new Int32Array(2*v),persist:[]};for(var y=0;y<v;++y){m[g].planes.ids[y]=e.readInt32(),m[g].planes.triIndexRanges[2*y]=e.readInt32(),m[g].planes.triIndexRanges[2*y+1]=e.readInt32(),m[g].planes.areas[y]=r<7?e.readFloat32():e.readFloat64();for(var q=e.readInt32(),Y=m[g].loopPerimeters.length,A=0;A<q;++A)m[g].loopPerimeters[Y+A]=e.readFloat32(),m[g].loopStartEdgeId[Y+A]=e.readInt32();m[g].planes.persist[y]=e.readGuid(),m[g].planes.loops[2*y]=Y,m[g].planes.loops[2*y+1]=q;for(var Q=0;Q<3;++Q)m[g].planes.origins[3*y+Q]=e.readFloat32();for(var K=0;K<3;++K)m[g].planes.normals[3*y+K]=e.readFloat32()}}var M=e.readInt32();if(0<M){m[g].cylinders={ids:new Int32Array(M),triIndexRanges:new Int32Array(2*M),areas:new(r<7?Float32Array:Float64Array)(M),persist:[],loops:new Int32Array(2*M),axis:new Float32Array(3*M),origins:new Float32Array(3*M),axisX:new Float32Array(3*M),radiuses:new Float32Array(M),heights:new Float32Array(M)};for(var E=0;E<M;++E){m[g].cylinders.ids[E]=e.readInt32(),m[g].cylinders.triIndexRanges[2*E]=e.readInt32(),m[g].cylinders.triIndexRanges[2*E+1]=e.readInt32(),m[g].cylinders.areas[E]=r<7?e.readFloat32():e.readFloat64();for(var Z=e.readInt32(),J=m[g].loopPerimeters.length,w=0;w<Z;++w)m[g].loopPerimeters[J+w]=e.readFloat32(),m[g].loopStartEdgeId[J+w]=e.readInt32();m[g].cylinders.persist[E]=e.readGuid(),m[g].cylinders.loops[2*E]=J,m[g].cylinders.loops[2*E+1]=Z;for(var $=0;$<3;++$)m[g].cylinders.axis[3*E+$]=e.readFloat32();for(var ee=0;ee<3;++ee)m[g].cylinders.origins[3*E+ee]=e.readFloat32();for(var te=0;te<3;++te)m[g].cylinders.axisX[3*E+te]=e.readFloat32();m[g].cylinders.radiuses[E]=e.readFloat32(),m[g].cylinders.heights[E]=e.readFloat32()}}var x=e.readInt32();if(0<x){m[g].cones={ids:new Int32Array(x),triIndexRanges:new Int32Array(2*x),areas:new(r<7?Float32Array:Float64Array)(x),persist:[],loops:new Int32Array(2*x),axis:new Float32Array(3*x),origins:new Float32Array(3*x),axisX:new Float32Array(3*x),radiuses:new Float32Array(x),halfAngles:new Float32Array(x)};for(var b=0;b<x;++b){m[g].cones.ids[b]=e.readInt32(),m[g].cones.triIndexRanges[2*b]=e.readInt32(),m[g].cones.triIndexRanges[2*b+1]=e.readInt32(),m[g].cones.areas[b]=r<7?e.readFloat32():e.readFloat64();for(var re=e.readInt32(),ie=m[g].loopPerimeters.length,B=0;B<re;++B)m[g].loopPerimeters[ie+B]=e.readFloat32(),m[g].loopStartEdgeId[ie+B]=e.readInt32();m[g].cones.persist[b]=e.readGuid(),m[g].cones.loops[2*b]=ie,m[g].cones.loops[2*b+1]=re;for(var ne=0;ne<3;++ne)m[g].cones.axis[3*b+ne]=e.readFloat32();for(var ae=0;ae<3;++ae)m[g].cones.origins[3*b+ae]=e.readFloat32();for(var oe=0;oe<3;++oe)m[g].cones.axisX[3*b+oe]=e.readFloat32();m[g].cones.radiuses[b]=e.readFloat32(),m[g].cones.halfAngles[b]=e.readFloat32()}}var I=e.readInt32();if(0<I){m[g].spheres={ids:new Int32Array(I),triIndexRanges:new Int32Array(2*I),areas:new(r<7?Float32Array:Float64Array)(I),persist:[],loops:new Int32Array(2*I),axisX:new Float32Array(3*I),axisZ:new Float32Array(3*I),origins:new Float32Array(3*I),radiuses:new Float32Array(I)};for(var T=0;T<I;++T){m[g].spheres.ids[T]=e.readInt32(),m[g].spheres.triIndexRanges[2*T]=e.readInt32(),m[g].spheres.triIndexRanges[2*T+1]=e.readInt32(),m[g].spheres.areas[T]=r<7?e.readFloat32():e.readFloat64();for(var se=e.readInt32(),le=m[g].loopPerimeters.length,de=0;de<se;++de)m[g].loopPerimeters[le+de]=e.readFloat32(),m[g].loopStartEdgeId[le+de]=e.readInt32();m[g].spheres.persist[T]=e.readGuid(),m[g].spheres.loops[2*T]=le,m[g].spheres.loops[2*T+1]=se;for(var ce=0;ce<3;++ce)m[g].spheres.axisX[3*T+ce]=e.readFloat32();for(var he=0;he<3;++he)m[g].spheres.axisZ[3*T+he]=e.readFloat32();for(var ue=0;ue<3;++ue)m[g].spheres.origins[3*T+ue]=e.readFloat32();m[g].spheres.radiuses[T]=e.readFloat32()}}var S=e.readInt32();if(0<S){m[g].toruses={ids:new Int32Array(S),triIndexRanges:new Int32Array(2*S),areas:new(r<7?Float32Array:Float64Array)(S),persist:[],loops:new Int32Array(2*S),normals:new Float32Array(3*S),origins:new Float32Array(3*S),axisX:new Float32Array(3*S),centerLineRadius:new Float32Array(S),sectionRadius:new Float32Array(S)};for(var R=0;R<S;++R){m[g].toruses.ids[R]=e.readInt32(),m[g].toruses.triIndexRanges[2*R]=e.readInt32(),m[g].toruses.triIndexRanges[2*R+1]=e.readInt32(),m[g].toruses.areas[R]=r<7?e.readFloat32():e.readFloat64();for(var pe=e.readInt32(),fe=m[g].loopPerimeters.length,me=0;me<pe;++me)m[g].loopPerimeters[fe+me]=e.readFloat32(),m[g].loopStartEdgeId[fe+me]=e.readInt32();m[g].toruses.persist[R]=e.readGuid(),m[g].toruses.loops[2*R]=fe,m[g].toruses.loops[2*R+1]=pe;for(var ge=0;ge<3;++ge)m[g].toruses.normals[3*R+ge]=e.readFloat32();for(var ve=0;ve<3;++ve)m[g].toruses.origins[3*R+ve]=e.readFloat32();for(var ye=0;ye<3;++ye)m[g].toruses.axisX[3*R+ye]=e.readFloat32();m[g].toruses.centerLineRadius[R]=e.readFloat32(),m[g].toruses.sectionRadius[R]=e.readFloat32()}}var C=e.readInt32();if(0<C){m[g].nurbses={ids:new Int32Array(C),triIndexRanges:new Int32Array(2*C),areas:new(r<7?Float32Array:Float64Array)(C),loops:new Int32Array(2*C),persist:[]};for(var D=0;D<C;++D){m[g].nurbses.ids[D]=e.readInt32(),m[g].nurbses.triIndexRanges[2*D]=e.readInt32(),m[g].nurbses.triIndexRanges[2*D+1]=e.readInt32(),m[g].nurbses.areas[D]=r<7?e.readFloat32():e.readFloat64();for(var Ae=e.readInt32(),Me=m[g].loopPerimeters.length,Ee=0;Ee<Ae;++Ee)m[g].loopPerimeters[Me+Ee]=e.readFloat32(),m[g].loopStartEdgeId[Me+Ee]=e.readInt32();m[g].nurbses.persist[D]=e.readGuid(),m[g].nurbses.loops[2*D]=Me,m[g].nurbses.loops[2*D+1]=Ae}}var P=e.readInt32();if(0<P){m[g].others={ids:new Int32Array(P),triIndexRanges:new Int32Array(2*P),areas:new(r<7?Float32Array:Float64Array)(P),loops:new Int32Array(2*P),persist:[]};for(var H=0;H<P;++H){m[g].others.ids[H]=e.readInt32(),m[g].others.triIndexRanges[2*H]=e.readInt32(),m[g].others.triIndexRanges[2*H+1]=e.readInt32(),m[g].others.areas[H]=r<7?e.readFloat32():e.readFloat64();for(var we=e.readInt32(),xe=m[g].loopPerimeters.length,be=0;be<we;++be)m[g].loopPerimeters[xe+be]=e.readFloat32(),m[g].loopStartEdgeId[xe+be]=e.readInt32();m[g].others.persist[H]=e.readGuid(),m[g].others.loops[2*H]=xe,m[g].others.loops[2*H+1]=we}}}for(var Be=t.brepInfos.faceGroups.length,Ie=(t.brepInfos.faceGroups=t.brepInfos.faceGroups.concat(m),e.readInt32()),Te=new Uint32Array(Ie),Se=new Float32Array(3*Ie),Re=0;Re<Ie;++Re){Te[Re]=e.readInt32();for(var Ce=0;Ce<3;++Ce)Se[3*Re+Ce]=e.readFloat32()}t.brepInfos.vertices={ids:Te,coords:Se};for(var De=e.readInt32(),_=new Array(De),L=0;L<De;++L){_[L]={},_[L].area=r<7?e.readFloat32():e.readFloat64(),_[L].volume=r<7?e.readFloat32():e.readFloat64();var Pe=e.readInt32();if(0<Pe){_[L].edgeGroups=new Int32Array(Pe);for(var He=0;He<Pe;++He)_[L].edgeGroups[He]=e.readInt32()+z}var _e=e.readInt32();if(0<_e){_[L].faceGroups=new Int32Array(_e);for(var Le=0;Le<_e;++Le)_[L].faceGroups[Le]=e.readInt32()+Be}var Oe=e.readInt32();if(0<Oe){_[L].vertices=new Int32Array(Oe);for(var Fe=0;Fe<Oe;++Fe)_[L].vertices[Fe]=e.readInt32()}}for(var Ue=t.brepInfos.breps.length,Ne=(t.brepInfos.breps=t.brepInfos.breps.concat(_),e.readInt32()),Ve=0;Ve<Ne;++Ve){var Ge=e.readGuid(),ke=e.readInt32();t.brepInfos.bodies.set(Ge,ke+Ue)}},$.prototype.readMorph=function(e){for(var t=new yt.Stream(e),r=(t.readString(),t.readInt32(),[]),i=t.readInt32(),n=0;n<i;n++){var a=t.readInt32(),o=t.readInt32(),s={position:null,normal:null};0<a&&(s.position=new Float32Array(a),t.readArrayFloat32(s.position)),0<o&&(s.normal=new Float32Array(o),t.readArrayFloat32(s.normal)),r.push(s)}return r},$.prototype.readModelObjects=function(e){var t,r;return 0===e.length||Pe.isMobileDevice()?null:(r=null,(r=1===(t=(e=new yt.Stream(e)).readInt32())?this.readModelObjectsV1(e):r)&&(r.version=t),r)},$.prototype.readModelObjectsV1=function(e){var t=new TextDecoder,r=e.readInt32();if(0<r)for(var i=new Array(r),n=0;n<r;n++){var a=e.readInt32(),a=new Uint8Array(a);e.readArrayUint8(a),i[n]=t.decode(a)}var o=e.readInt32();if(0<o){for(var s=function e(t){t.prims=new Array(4);for(var r=0;r<4;r++)t.prims[r]=new Map;if(t.objects)for(var i=0;i<t.objects.length;i++)for(var n=0;n<t.objects[i].length;n+=4){var a,o=t.objects[i][n],s=t.objects[i][n+1];t.prims[o].has(s)?t.prims[o].get(s).add(i):((a=new Set).add(i),t.prims[o].set(s,a))}t.children=[];for(var l=0;l<t.childArray.length;l++){var d=c[t.childArray[l]];d&&e(d),t.children.push(d)}delete t.childArray},c={},l=new ArrayBuffer(24*o),d=0;d<o;d++){var h=e.readInt32(),u=e.readInt32(),p=e.readInt32(),f=new Float32Array(l,24*d,6),m=(e.readArrayFloat32(f),e.readInt32()),m=new Int32Array(m),g=(e.readArrayInt32(m),e.readInt32());if(v=[],0<g){for(var v=new Array(g),y=0,A=new Array(g),M=0;M<g;M++){var E=e.readInt32();y+=A[M]=E}for(var w=new ArrayBuffer(16*y),x=0,b=0;b<g;b++){var B=4*A[b],I=new Int32Array(w,x,B);e.readArrayInt32(I),v[b]=I,x+=4*B}}c[h]={id:h,type:u,bbox:(new THREE.Box3).setFromArray(f),childArray:m,objects:v},2==u&&(c[h].name=i[p])}s(c[0])}return 0<o?c[0]:null},ht.prototype={constructor:ht,load:function(e,t,r,i){var n=this,a=new THREE.Texture,o=new THREE.FileLoader(this.manager);return o.setResponseType("arraybuffer"),o.load(e,function(e){a.image=n.parse(e),a.needsUpdate=!0,void 0!==t&&t(a)},r,i),a},parse:function(e){e.length<19&&console.error("TGALoader: Not enough data to contain header.");var t=new Uint8Array(e),r=0,Ce={id_length:t[r++],colormap_type:t[r++],image_type:t[r++],colormap_index:t[r++]|t[r++]<<8,colormap_length:t[r++]|t[r++]<<8,colormap_size:t[r++],origin:[t[r++]|t[r++]<<8,t[r++]|t[r++]<<8],width:t[r++]|t[r++]<<8,height:t[r++]|t[r++]<<8,pixel_size:t[r++],flags:t[r++]},i=Ce;switch(i.image_type){case 1:case 9:(256<i.colormap_length||24!==i.colormap_size||1!==i.colormap_type)&&console.error("TGALoader: Invalid type colormap data for indexed type.");break;case 2:case 3:case 10:case 11:i.colormap_type&&console.error("TGALoader: Invalid type colormap data for colormap type.");break;case 0:console.error("TGALoader: No data.");default:console.error('TGALoader: Invalid type "%s".',i.image_type)}(i.width<=0||i.height<=0)&&console.error("TGALoader: Invalid image size."),8!==i.pixel_size&&16!==i.pixel_size&&24!==i.pixel_size&&32!==i.pixel_size&&console.error('TGALoader: Invalid pixel size "%s".',i.pixel_size),Ce.id_length+18>e.length&&console.error("TGALoader: No data."),r+=Ce.id_length;var n=!1,a=!1,De=!1;switch(Ce.image_type){case 9:a=n=!0;break;case 1:a=!0;break;case 10:n=!0;break;case 2:break;case 11:De=n=!0;break;case 3:De=!0}e=function(e,t,r,i,n){var a,o=r.pixel_size>>3,s=r.width*r.height*o;if(t&&(a=n.subarray(i,i+=r.colormap_length*(r.colormap_size>>3))),e)for(var l,d,c,h=new Uint8Array(s),u=0,p=new Uint8Array(o);u<s;)if(d=1+(127&(l=n[i++])),128&l){for(c=0;c<o;++c)p[c]=n[i++];for(c=0;c<d;++c)h.set(p,u+c*o);u+=o*d}else{for(d*=o,c=0;c<d;++c)h[u+c]=n[i++];u+=d}else h=n.subarray(i,i+=t?r.width*r.height:s);return{pixel_data:h,palettes:a}}(n,a,Ce,r,t),r=function(e,t,r,O){var i,n,a,o,s,l,d=new Uint8Array(e*t*4);switch((48&Ce.flags)>>4){default:case 2:s=e,n=i=0,o=a=1,l=t;break;case 0:i=0,s=e,n=t-(a=1),l=o=-1;break;case 3:i=e-1,s=a=-1,n=0,o=1,l=t;break;case 1:i=e-1,n=t-1,l=o=s=a=-1}if(De)switch(Ce.pixel_size){case 8:for(var c,h,u=d,F=n,U=o,N=l,V=i,G=a,k=s,j=r,z=0,p=Ce.width,f=F;f!==N;f+=U)for(h=V;h!==k;h+=G,z++)c=j[z],u[4*(h+p*f)+0]=c,u[4*(h+p*f)+1]=c,u[4*(h+p*f)+2]=c,u[4*(h+p*f)+3]=255;break;case 16:for(var m,g=d,F=n,W=o,X=l,q=i,Y=a,Q=s,v=r,y=0,A=Ce.width,M=F;M!==X;M+=W)for(m=q;m!==Q;m+=Y,y+=2)g[4*(m+A*M)+0]=v[y+0],g[4*(m+A*M)+1]=v[y+0],g[4*(m+A*M)+2]=v[y+0],g[4*(m+A*M)+3]=v[y+1];break;default:console.error("TGALoader: Format not supported.")}else switch(Ce.pixel_size){case 8:for(var E,w,x=d,K=n,Z=o,J=l,$=i,ee=a,te=s,re=r,ie=O,ne=0,b=Ce.width,B=K;B!==J;B+=Z)for(w=$;w!==te;w+=ee,ne++)E=re[ne],x[4*(w+b*B)+3]=255,x[4*(w+b*B)+2]=ie[3*E+0],x[4*(w+b*B)+1]=ie[3*E+1],x[4*(w+b*B)+0]=ie[3*E+2];break;case 16:for(var I,T,S=d,K=n,ae=o,oe=l,se=i,le=a,de=s,ce=r,he=0,R=Ce.width,C=K;C!==oe;C+=ae)for(T=se;T!==de;T+=le,he+=2)I=ce[he+0]+(ce[he+1]<<8),S[4*(T+R*C)+0]=(31744&I)>>7,S[4*(T+R*C)+1]=(992&I)>>2,S[4*(T+R*C)+2]=(31&I)>>3,S[4*(T+R*C)+3]=32768&I?0:255;break;case 24:for(var D,ue=d,pe=n,fe=o,me=l,ge=i,ve=a,ye=s,Ae=r,Me=0,Ee=Ce.width,P=pe;P!==me;P+=fe)for(D=ge;D!==ye;D+=ve,Me+=3)ue[4*(D+Ee*P)+3]=255,ue[4*(D+Ee*P)+2]=Ae[Me+0],ue[4*(D+Ee*P)+1]=Ae[Me+1],ue[4*(D+Ee*P)+0]=Ae[Me+2];break;case 32:for(var H,we=d,pe=n,xe=o,be=l,Be=i,Ie=a,Te=s,Se=r,_=0,Re=Ce.width,L=pe;L!==be;L+=xe)for(H=Be;H!==Te;H+=Ie,_+=4)we[4*(H+Re*L)+2]=Se[_+0],we[4*(H+Re*L)+1]=Se[_+1],we[4*(H+Re*L)+0]=Se[_+2],we[4*(H+Re*L)+3]=Se[_+3];break;default:console.error("TGALoader: Format not supported.")}return d}(Ce.width,Ce.height,e.pixel_data,e.palettes);return{width:Ce.width,height:Ce.height,data:r,magFilter:THREE.NearestFilter,minFilter:THREE.NearestFilter}}},function(e){var o=this;this.is2DModel=e,this.metrics={},this.TextMaterial={},this.TextMaterialItalic={},this.TextMaterialBold={},this.TextMaterialIandB={},this.blendMaterial=null,this.newblendMaterial=null,this.shxMaterial=null,this.mappableUnit=4096,this.textSize=100,this.textUnit=parseInt(1.125*this.textSize),this.specialCodeArray=[],this.AddSpecialCode(),this.AttributeArray=[],this.HashTable=[],this.textString="",this.textPos=[],this.geometrytoRange=[],this.lines=[],this.objectuuidToGeo={},this.numTextGeom=0,this.ttfCompositeStride=6,this.ttfGeometryBuffers=[],this.shxCompositeStride=3,this.ttfMeshCompositeStride=3,this.shxGeometryBuffers=[],this.ttfMeshGeometryBuffers=[],this.ttfTotalBuffer=[],this.shxTotalBuffer=[],this.orgTotalBuffer={compositeIBuffer:new THREE.BufferAttribute(new Float32Array(3),3,0,!1),index:new THREE.BufferAttribute(this.MeshTextGetIndexArray(1),1),indexLine:new THREE.BufferAttribute(this.MeshTextGetIndexArray(2),1),bufferOffset:0,indexOffset:0},this.oldTextUpdateTexture=!0,this.genTTFGeometryBuffer=function(e){void 0===e&&(e=1024);e={compositeIBuffer:new THREE.InterleavedBuffer(new Float32Array(4*e*o.ttfCompositeStride),o.ttfCompositeStride),index:new THREE.Uint32BufferAttribute(new Uint32Array(6*e),1),bufferOffset:0,indexOffset:0};return e.compositePositionAttrib=new THREE.InterleavedBufferAttribute(e.compositeIBuffer,3,0,!1),e.compositeUvAttrib=new THREE.InterleavedBufferAttribute(e.compositeIBuffer,2,3,!1),e.compositeTextureAttrib=new THREE.InterleavedBufferAttribute(e.compositeIBuffer,1,5,!1),o.ttfGeometryBuffers[o.ttfGeometryBuffers.length]=e,o.ttfGeometryBuffers.length-1},this.getTTFGeometryBuffer=function(e){for(var t=-1,r=0,i=o.ttfGeometryBuffers.length;r<i;++r){var n=o.ttfGeometryBuffers[r];if(4*e*o.ttfCompositeStride<n.compositeIBuffer.array.length-n.bufferOffset){t=r;break}}return t<0&&(t=o.genTTFGeometryBuffer(o.mappableUnit)),o.ttfGeometryBuffers[t]},this.genSHXGeometryBuffer=function(e){void 0===e&&(e=65536);e={compositeIBuffer:new THREE.InterleavedBuffer(new Float32Array(e*o.shxCompositeStride),o.shxCompositeStride),index:new THREE.Uint32BufferAttribute(new Uint32Array(e),1),bufferOffset:0,indexOffset:0};return e.compositePositionAttrib=new THREE.InterleavedBufferAttribute(e.compositeIBuffer,3,0,!1),o.shxGeometryBuffers[o.shxGeometryBuffers.length]=e,o.shxGeometryBuffers.length-1},this.genMeshTTFGeometryBuffer=function(e){void 0===e&&(e=65536);e={compositeIBuffer:new THREE.InterleavedBuffer(new Float32Array(e*o.ttfMeshCompositeStride),o.ttfMeshCompositeStride),index:new THREE.Uint32BufferAttribute(new Uint32Array(e),1),indexLine:new THREE.Uint32BufferAttribute(new Uint32Array(2*e),1),bufferOffset:0,indexOffset:0};return e.compositePositionAttrib=new THREE.InterleavedBufferAttribute(e.compositeIBuffer,3,0,!1),o.ttfMeshGeometryBuffers[o.ttfMeshGeometryBuffers.length]=e,o.ttfMeshGeometryBuffers.length-1},this.getMeshTTFGeometryBuffer=function(e){for(var t=-1,r=0,i=o.ttfMeshGeometryBuffers.length;r<i;++r){var n=o.ttfMeshGeometryBuffers[r];if(e*o.ttfMeshCompositeStride<n.compositeIBuffer.array.length-n.bufferOffset){t=r;break}}return t<0&&(t=o.genMeshTTFGeometryBuffer(65536)),o.ttfMeshGeometryBuffers[t]},this.getSHXGeometryBuffer=function(e){for(var t=-1,r=0,i=o.shxGeometryBuffers.length;r<i;++r){var n=o.shxGeometryBuffers[r];if(e*o.shxCompositeStride<n.compositeIBuffer.array.length-n.bufferOffset){t=r;break}}return t<0&&(t=o.genSHXGeometryBuffer(65536)),o.shxGeometryBuffers[t]},this.textCompositeStride=9,this.textGeometryBuffers=[],this.genTextGeometryBuffer=function(e,t){void 0===t&&(t=1024);t={compositeIBuffer:new THREE.InterleavedBuffer(new Float32Array(4*t*o.textCompositeStride),o.textCompositeStride),index:new THREE.Uint32BufferAttribute(new Uint32Array(6*t),1),bufferOffset:0,indexOffset:0,uuidtorange:new Object};return t.compositePositionAttrib=new THREE.InterleavedBufferAttribute(t.compositeIBuffer,3,0,!1),t.compositeColorAttrib=new THREE.InterleavedBufferAttribute(t.compositeIBuffer,3,3,!1),t.compositeUvAttrib=new THREE.InterleavedBufferAttribute(t.compositeIBuffer,2,6,!1),t.compositeTextureAttrib=new THREE.InterleavedBufferAttribute(t.compositeIBuffer,1,8,!1),o.textGeometryBuffers[e][o.textGeometryBuffers[e].length]=t,o.textGeometryBuffers[e].length-1},this.getTextGeometryBuffer=function(e,t){var r=-1;o.textGeometryBuffers[e]||(o.textGeometryBuffers[e]=[]);for(var i=0,n=o.textGeometryBuffers[e].length;i<n;++i){var a=o.textGeometryBuffers[e][i];if(4*t*o.textCompositeStride<a.compositeIBuffer.array.length-a.bufferOffset){r=i;break}}return r<0&&(r=o.genTextGeometryBuffer(e,o.mappableUnit)),o.textGeometryBuffers[e][r]},this.SDFVerison=1,this.nametotextureID=[],this.textures=[],this.shxTextArray=[],this.ShxData=null,this.ttfTextArray=[],this.ttfData=null,this.needShxLoad=!1}),mt=(de.prototype={constructor:de,SetVersion:function(e){this.SDFVerison=e},IsChinese:function(e){return 19968<=e.charCodeAt(0)&&e.charCodeAt(0)<=40869},IsChinese2:function(e){return 255<e.charCodeAt(0)},IsSpecialCharacter:function(e){return 8709==e||216==e||63740==e||177==e||63741==e||176==e||63742==e},IsShxFont:function(e){return!!e&&".shx"==e.substring(e.length-4).toLowerCase()},GetTextScale:function(e,t){return 3<=this.SDFVerison||this.IsShxFont(t)?1:1.6},GetTextOffset:function(e,t,r){return r||1==this.SDFVerison||3<=this.SDFVerison?0:this.IsShxFont(t)?.05:.25},AddSpecialCode:function(){for(var e=[8982,9007],t=0;t<e.length;++t)this.specialCodeArray.push(String.fromCharCode(e[t]))},getFontType:function(e){return this.is2DModel&&1==this.SDFVerison?"N":new RegExp("fang","gi").test(e)?"F":new RegExp("kaiti","gi").test(e)?"K":new RegExp("arial","gi").test(e)?"A":new RegExp("yahei","gi").test(e)?"M":new RegExp("SimSun","gi").test(e)?"S":"N"},CreateImage:((pt=document.createElement("canvas")).width=4096,pt.height=4096,function(e,t,r){void 0===t&&(t=!0),void 0===r&&(r=!1);for(var i,n,a,o=this.mappableUnit-this.textUnit,s=pt.getContext("2d",{willReadFrequently:!0}),l=(s.clearRect(0,0,this.mappableUnit,this.mappableUnit),s.textBaseline="bottom",s.fillStyle="black",s.clearRect(0,0,pt.width,pt.height),2),d=0,c=1,h=(this.metrics[0]=new Object,this.metrics[1]=new Object,this.metrics[2]=new Object,this.metrics[3]=new Object,null),u=0;u<e.length;u++){var p=e[u],f=this.IsChinese(p.charAt(0));switch(p.charAt(2)){case"I":i="italic "+this.textSize+"px ",n=de.ITALIC;break;case"B":i="bold "+this.textSize+"px ",n=de.BOLD;break;case"D":i="italic bold "+this.textSize+"px ",n=de.ITALICANDBOLD;break;case"N":i="normal "+this.textSize+"px ",n=de.NORMAL}var h=this.metrics[n],m=void 0,m=p.charAt(3);switch(p.charAt(3)){case"F":i+="FangSong";break;case"A":i+="Arial";break;case"S":i+="SimSun";break;case"K":i+="KaiTi";break;case"M":i+="Microsoft YaHei";break;case"N":m=f?(i+="FangSong","F"):(i+="Arial","A")}p=p.charAt(0),a=!1,-1!=this.specialCodeArray.indexOf(p)&&(a=!0),s.font=i,s.clearRect(o,o,this.textUnit,this.textUnit),s.textAlign="center",s.fillText(p,o+this.textUnit/2,this.mappableUnit);var g=50,v=0;if(f)x=this.textSize,g=0,v=112;else{for(var y=s.getImageData(o-2,o-2,this.textUnit,this.textUnit),A=0;A<this.textUnit;A++){for(var M=0;M<this.textUnit;M++){var E=y.data[4*(A*this.textUnit+M)+3];if(0!=E&&M<g){g=M;break}}for(var w=this.textUnit-1;0<=w;w--){E=y.data[4*(A*this.textUnit+w)+3];if(0!=E&&v<w){v=w;break}}}var x=v-g;x<0&&(x=6)}var b=this.textUnit/2>g?this.textUnit/2-g:0,d=((l=l+d+b+28)+(x>>1)>this.mappableUnit&&(l=(l=14)+((d=0)>>1)+(x>>1)+28,c++),s.textAlign="center",s.fillText(p,l,this.textUnit*c),v>this.textUnit/2?v-this.textUnit/2:0),B=l,I=this.textUnit*c,b={height:1,width:f?1:(x+28)/this.textUnit,left:this.textUnit/2>g?(B-b-7)/this.mappableUnit:(B+g-this.textUnit/2-7)/this.mappableUnit,top:1-(I-this.textUnit+7)/this.mappableUnit,right:this.textUnit/2>g?(B-b+x+7)/this.mappableUnit:(B+g-this.textUnit/2+x+7)/this.mappableUnit,bottom:1-I/this.mappableUnit};r&&f&&(b.height=1.5,b.width=1.5),a&&(B=b.right-b.left,b.right-=(B*=.35)/2,b.left+=B/2,I=b.top-b.bottom,b.top-=(I*=.35)/2,b.bottom+=I/2),h[m]||(h[m]=new Object),h[m][p]=b}var T=null;return t&&((T=document.createElement("img")).src=pt.toDataURL("image/png")),T}),addHash:function(e){this.HashTable.push(e)},containHash:function(e){return-1!=this.HashTable.indexOf(e)},getHashKey:function(){return this.HashTable.concat()},SetTexture:function(e,t,r){this.textures=e;for(var i=0;i<this.textures.length;++i)this.textures[i].flipY=!1,this.textures[i].needsUpdate=!0,this.blendMaterial&&(this.blendMaterial.uniforms["uSampler"+i].value=this.textures[i],this.blendMaterial.uniforms["uSampler"+i].value.flipY=!1,this.blendMaterial.uniforms["uSampler"+i].value.needsUpdate=!0),this.newblendMaterial&&t<2&&(this.newblendMaterial.uniforms["uSampler"+i].value=this.textures[i],this.newblendMaterial.uniforms["uSampler"+i].value.flipY=!1,this.newblendMaterial.uniforms["uSampler"+i].value.needsUpdate=!0);r&&r()},SetFontsInfo:function(e){this.fontInfoMap=e},GetFontsInfo:function(e){return this.fontInfoMap.get(e)},CollectCharSet:function(o){if(!o.charSetCollected){var s=this,l=!1,d=new Map;if(o.fonts)for(var e=0,t=o.fonts.length;e<t;++e)d.set(o.fonts[e].uuid,o.fonts[e]);for(var r=0;r<o.bufferchunks.length;r++)o.bufferchunks[r].geometries.map(function(e,t){if("TextGeometry"===e.type)for(var r=e.textFont,i=(!r.style&&o.fonts&&(r=d.get(e.textFont)),s.getFontType(r.name)),n=0;n<e.text.length;n++){var a=e.text.charAt(n);"normal"!=r.style&&"normal"==r.weight?a+="_I":"normal"!=r.weight&&"normal"==r.style?a+="_B":"normal"!=r.style&&"normal"!=r.weight?a+="_D":"normal"==r.style&&"normal"==r.weight&&(a+="_N"),a+=i,s.containHash(a)||(l=!0,s.addHash(a))}});var i=this.getHashKey();0!==i.length&&l&&(this.CreateImage(i,!1),o.charSetCollected=!0)}},CreateOldMaterialFromImage:function(e){var t=this,r=new THREE.ShaderMaterial({vertexColors:!0,uniforms:{uSampler0:{type:"t",value:null},uSampler1:{type:"t",value:null},uSampler2:{type:"t",value:null},uSampler3:{type:"t",value:null},uSampler4:{type:"t",value:null},uGamma:{type:"f",value:4e-4}},vertexShader:["varying vec2 vUv;","varying vec3 vColor;","varying float vtextureid;","attribute float textureid;","void main() { ","vUv = uv;","vColor = color;","vtextureid = textureid;","gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join("\n"),fragmentShader:["#ifdef GL_ES","precision mediump float;","#endif","varying vec2 vUv;","varying vec3 vColor;","varying float vtextureid;","uniform sampler2D uSampler0;","uniform sampler2D uSampler1;","uniform sampler2D uSampler2;","uniform sampler2D uSampler3;","uniform sampler2D uSampler4;","uniform float uGamma;","const float cBuffer = 0.2;","void main(void) {","float dist = 0.0;","if( vtextureid > -0.5 && vtextureid < 0.5){","dist = texture2D(uSampler0, vUv).a;","}","if( vtextureid > 0.5 && vtextureid < 1.5){","dist = texture2D(uSampler1, vUv).a;","}","if( vtextureid > 1.5 && vtextureid < 2.5){","dist = texture2D(uSampler2, vUv).a;","}","if( vtextureid > 2.5 && vtextureid < 3.5){","dist = texture2D(uSampler3, vUv).a;","}","if( vtextureid > 3.5 && vtextureid < 4.5){","dist = texture2D(uSampler4, vUv).a;","}","float alpha = smoothstep(cBuffer - uGamma, cBuffer + uGamma, dist);","vec3 destColor = vColor;","if(destColor.r> 1.0){","destColor.r = 1.0;","alpha = 0.0;","}","if(destColor.g> 1.0){","destColor.r = 0.090;","destColor.g = 0.501;","destColor.b = 0.890;","}","gl_FragColor = vec4(destColor, alpha);","}"].join("\n")});if(1<t.SDFVerison)for(var i,n=0;n<e.length;++n)(i=e[n]).flipY=!1,i.needsUpdate=!0,r.uniforms["uSampler"+n].value=i;else(i=new THREE.Texture(e)).needsUpdate=!0,r.uniforms.uSampler0.value=i;r.side=THREE.DoubleSide,r.transparent=!0,r.depthWrite=!1,r.alphaTest=.4,De.StopPMIOcclusion&&(r.depthTest=!1),t.TextMaterial=r,t.TextMaterial.styleId=de.NORMAL,t.is2DModel&&1==t.SDFVerison&&(t.TextMaterialItalic=r,t.TextMaterialItalic.styleId=de.ITALIC,t.TextMaterialBold=r,t.TextMaterialBold.styleId=de.BOLD,t.TextMaterialIandB=r,t.TextMaterialIandB.styleId=de.ITALICANDBOLD)},CreateMaterial:function(o,e,t){function r(e,t,r,i){var n=new THREE.ShaderMaterial({vertexColors:!0,uniforms:{uSampler0:{type:"t",value:null},uSampler1:{type:"t",value:null},uSampler2:{type:"t",value:null},uSampler3:{type:"t",value:null},uSampler4:{type:"t",value:null},uGamma:{type:"f",value:4e-4},diffuse:{value:new THREE.Color(16777215)}},vertexShader:["varying vec2 vUv;","varying float vtextureid;","attribute float textureid;","void main() { ","vUv = uv;","vtextureid = textureid;","gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join("\n"),fragmentShader:["#ifdef GL_ES","precision mediump float;","#endif","varying vec2 vUv;","varying float vtextureid;","uniform sampler2D uSampler0;","uniform sampler2D uSampler1;","uniform sampler2D uSampler2;","uniform sampler2D uSampler3;","uniform sampler2D uSampler4;","uniform float uGamma;","uniform vec3 diffuse;","const float cBuffer = 0.2;","void main(void) {","float dist = 0.0;","if( vtextureid > -0.5 && vtextureid < 0.5){","dist = texture2D(uSampler0, vUv).a;","}","if( vtextureid > 0.5 && vtextureid < 1.5){","dist = texture2D(uSampler1, vUv).a;","}","if( vtextureid > 1.5 && vtextureid < 2.5){","dist = texture2D(uSampler2, vUv).a;","}","if( vtextureid > 2.5 && vtextureid < 3.5){","dist = texture2D(uSampler3, vUv).a;","}","if( vtextureid > 3.5 && vtextureid < 4.5){","dist = texture2D(uSampler4, vUv).a;","}","float alpha = smoothstep(cBuffer - uGamma, cBuffer + uGamma, dist);","vec3 destColor = diffuse;","if(destColor.r> 1.0){","destColor.r = 1.0;","alpha = 0.0;","}","if(destColor.g> 1.0){","destColor.r = 0.090;","destColor.g = 0.501;","destColor.b = 0.890;","}","gl_FragColor = vec4(destColor, alpha);","}"].join("\n")});if(1<e.SDFVerison)for(var a,o=0;o<t.length;++o)(a=t[o]).flipY=!1,a.needsUpdate=!0,n.uniforms["uSampler"+o].value=a;else(a=new THREE.Texture(t)).needsUpdate=!0,n.uniforms.uSampler0.value=a;switch(n.side=THREE.DoubleSide,n.transparent=!0,n.depthWrite=!1,n.alphaTest=.4,r){case de.ITALIC:e.TextMaterialItalic=n,e.TextMaterialItalic.styleId=r;break;case de.BOLD:e.TextMaterialBold=n,e.TextMaterialBold.styleId=r;break;case de.NORMAL:e.TextMaterial=n,e.TextMaterial.styleId=r;break;case de.ITALICANDBOLD:e.TextMaterialIandB=n,e.TextMaterialIandB.styleId=r;break;case de.BLEND:i?(e.newblendMaterial=n,e.newblendMaterial.styleId=r):(e.blendMaterial=n,e.blendMaterial.styleId=r)}}var s=new Map;if(o.fonts)for(var i=0,O=o.fonts.length;i<O;++i)s.set(o.fonts[i].uuid,o.fonts[i]);var l=this;if(4==e&&this.SDFVerison==e&&o){this.metrics[de.NORMAL]=new Object,this.metrics[de.BOLD]=new Object,this.metrics[de.ITALIC]=new Object,this.metrics[de.ITALICANDBOLD]=new Object;for(var n=0;n<o.length;n++){var a=o[n].name,d=o[n].str,c=!o[n].isTTF,h=o[n].isTTF,F=o[n].bVertical,u=(this.nametotextureID[a]=c?0:o[n].textureid,o[n].uvs),U=o[n].range,p=c?d&&u?u.length/d.length:7:6,f=new Object;if(d&&u)for(var m=0;m<d.length;m++){var g,N=d[m];c?(g=U[m],f[N]={advanceX:u[m*p],advanceY:u[m*p+1],left:u[m*p+2],right:u[m*p+3],top:u[m*p+4],bottom:u[m*p+5],fontScale:7==p?u[m*p+6]:1,shxRange:0==g.length?null:g,isShx:c,isTTF:h,isVertical:c&&F}):(g=U[m],f[N]={advanceX:u[m*p],advanceY:u[m*p+1],left:u[m*p+2],right:u[m*p+3],top:u[m*p+4],bottom:u[m*p+5],shxRange:0==g.length?null:g,isShx:c,isTTF:h,isVertical:c&&F})}switch(o[n].styleId){case 0:this.metrics[de.NORMAL][a]=f;break;case 1:this.metrics[de.BOLD][a]=f;break;case 2:this.metrics[de.ITALIC][a]=f;break;case 3:this.metrics[de.ITALICANDBOLD][a]=f}}this.shxMaterial=new THREE.ShaderMaterial({uniforms:{diffuse:{value:new THREE.Color(16777215)},max2:{value:new THREE.Vector2(0,0)},min2:{value:new THREE.Vector2(0,0)}},vertexShader:["varying vec2 posxy;","void main() { ","vec4 tmp = modelMatrix * vec4(position, 1.0);","posxy.xy= tmp.xy;","gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join("\n"),fragmentShader:["#ifdef GL_ES","precision mediump float;","#endif","uniform vec3 diffuse;","uniform vec2 max2;","uniform vec2 min2;","varying vec2 posxy;","void main(void) {","float alpha=1.0;","if(max2.x > min2.x && max2.y > min2.y && (posxy.x < min2.x || posxy.x > max2.x || posxy.y < min2.y || posxy.y > max2.y)){","alpha = 0.0;","}","gl_FragColor = vec4(diffuse, alpha);","}"].join("\n")}),this.shxMaterial.transparent=!0,this.shxMaterial.depthWrite=!1,this.blendMaterial=new THREE.ShaderMaterial({uniforms:{diffuse:{value:new THREE.Color(16777215)},max2:{value:new THREE.Vector2(0,0)},min2:{value:new THREE.Vector2(0,0)}},vertexShader:["varying vec2 posxy;","void main() { ","vec4 tmp = modelMatrix * vec4(position, 1.0);","posxy.xy= tmp.xy;","gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join("\n"),fragmentShader:["#ifdef GL_ES","precision mediump float;","#endif","uniform vec3 diffuse;","uniform vec2 max2;","uniform vec2 min2;","varying vec2 posxy;","void main(void) {","float alpha=1.0;","if(max2.x > min2.x && max2.y > min2.y && (posxy.x < min2.x || posxy.x > max2.x || posxy.y < min2.y || posxy.y > max2.y)){","alpha = 0.0;","}","gl_FragColor = vec4(diffuse, alpha);","}"].join("\n")}),this.blendMaterial.transparent=!0,this.blendMaterial.depthWrite=!1,this.TextMaterialItalic=this.blendMaterial,this.TextMaterial=this.blendMaterial,this.TextMaterialBold=this.blendMaterial,this.TextMaterialIandB=this.blendMaterial}else if(3==e&&this.SDFVerison==e&&o){for(var V=new Object,v=0;v<o.length;v++){var G=o[v].name,y=o[v].str,A=void 0===o[v].textureid,M=(this.nametotextureID[G]=A?0:o[v].textureid,o[v].uvs),k=o[v].range,E=A?2:10,w=new Object;if(y&&M)for(var x=0;x<y.length;x++){var b,j=y[x];A?(b=k[x],w[j]={advanceX:M[x*E],advanceY:M[x*E+1],shxRange:0==b.length?null:b,isShx:!0}):w[j]={top:M[x*E],bottom:M[x*E+1],left:M[x*E+2],right:M[x*E+3],bearingX:M[x*E+4],bearingY:M[x*E+5],advanceX:M[x*E+6],advanceY:M[x*E+7],width:M[x*E+8],height:M[x*E+9],shxRange:null,isShx:!1}}V[G]=w}this.metrics[de.BLEND]=V,r(this,this.textures,de.BLEND,!1),this.shxMaterial=new THREE.ShaderMaterial({uniforms:{diffuse:{value:new THREE.Color(16777215)}},vertexShader:["void main() { ","gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join("\n"),fragmentShader:["#ifdef GL_ES","precision mediump float;","#endif","uniform vec3 diffuse;","void main(void) {","gl_FragColor = vec4(diffuse, 1.0);","}"].join("\n")})}else if(2==e&&this.SDFVerison==e&&o){for(var z=new Object,B=0;B<o.length;B++){var W=o[B].name,I=o[B].uvs,T=o[B].str,X=(this.nametotextureID[W]=o[B].textureid,o[B].shapid),S=o[B].range,R={};if(S)for(var C=0;C<S.length;C++)R[S[C].char]=S[C].data;var D=new Object;if(T&&I)for(var P=0;P<T.length;P++){var q=T[P];D[q]={height:1,width:(I[4*P+3]-I[4*P+2])/(I[4*P+1]-I[4*P]),left:I[4*P+2],top:I[4*P],right:I[4*P+3],bottom:I[4*P+1],shxRange:null!=S?R[q]:null}}if(X)for(var H=X.split(","),_=0;_<H.length&&H[_];_++)D[H[_]]={height:2<=t?4:2,width:2<=t?4:2*(I[4*_+3]-I[4*_+2])/(I[4*_+1]-I[4*_]),left:I[4*_+2],top:I[4*_],right:I[4*_+3],bottom:I[4*_+1],shxRange:null!=S?R[String.fromCharCode(H[_])]:null},"131"==H[_]&&(D[H[_]].height=2<=t?4:1,D[H[_]].width=2<=t?4:2),"130"==H[_]&&2<=t&&(D[H[_]].height=4,D[H[_]].width=1);z[W]=D}this.metrics[de.BLEND]=z,1==t?(this.CreateOldMaterialFromImage(this.textures,de.BLEND),r(this,this.textures,de.BLEND,!0)):(r(this,this.textures,de.BLEND,!1),this.shxMaterial=new THREE.ShaderMaterial({uniforms:{diffuse:{value:new THREE.Color(16777215)}},vertexShader:["void main() { ","gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join("\n"),fragmentShader:["#ifdef GL_ES","precision mediump float;","#endif","uniform vec3 diffuse;","void main(void) {","gl_FragColor = vec4(diffuse, 1.0);","}"].join("\n")}))}else if(1==e&&this.SDFVerison==e&&o){for(var L=0;L<o.bufferchunks.length;L++)o.bufferchunks[L].geometries.map(function(e,t){if("TextGeometry"===e.type)for(var r=e.textFont,i=(!r.style&&o.fonts&&(r=s.get(e.textFont)),l.getFontType(r.name)),n=0;n<e.text.length;n++){var a=e.text.charAt(n);"normal"!=r.style&&"normal"==r.weight?a+="_I":"normal"!=r.weight&&"normal"==r.style?a+="_B":"normal"!=r.style&&"normal"!=r.weight?a+="_D":"normal"==r.style&&"normal"==r.weight&&(a+="_N"),a+=i,l.containHash(a)||l.addHash(a)}});0!==(e=this.getHashKey()).length&&(e=this.CreateImage(e,!0,this.is2DModel&&1==this.SDFVerison),this.CreateOldMaterialFromImage(e))}},GetMaterialStyleId:function(e,t,r){var i;return"normal"!=e&&"normal"!=t?i=de.ITALICANDBOLD:"normal"==e&&"normal"==t?i=de.NORMAL:"normal"!=e&&"normal"==t?i=de.ITALIC:"normal"==e&&"normal"!=t&&(i=de.BOLD),1<this.SDFVerison&&this.SDFVerison<4&&(i=de.BLEND),i=r?de.SHX:i},RegText:function(e){var t={text:e,underscode:!1,dash:!1,box:!1,superscript:!1,superscriptbegin:0,superscriptend:0,subscript:!1,subscriptbegin:0,subscriptend:0},r=new RegExp("%%145|%%144","gi"),r=(e=e.replace(r,""),(r=new RegExp("%%u","gi")).test(e)&&(e=e.replace(r,""),t.underscode=!0),(r=new RegExp("%%o","gi")).test(e)&&(e=e.replace(r,""),t.dash=!0),(r=new RegExp("%%nnn","gi")).test(e)&&(e=e.replace(r,""),t.box=!0),(r=new RegExp("%%140","gi")).test(e)&&(t.superscriptbegin=e.search(r),t.superscriptend=e.search("%%141"),t.superscriptend-=6,t.superscript=!0),(r=new RegExp("%%142","gi")).test(e)&&(t.subscriptbegin=e.search(r),t.subscriptend=e.search("%%143"),t.subscriptend-=6,t.subscript=!0),new RegExp("%%140|%%141|%%142|%%143","gi"));return t.text=e.replace(r,""),t.subscript&&-7==t.subscriptend&&(t.subscriptend=t.text.length),t},ParseSDFTextGeometry:function(e,t,r,i,n,a,o,s,l,d,c){void 0===o&&(o=!1),void 0===s&&(s=!1),void 0===d&&(d=!1),void 0===c&&(c=2);for(var h,O,u=0,p=0,f=(l=void 0===l?!1:l)?1:e.text.length,m=0,g=0,v=0,y=new((a=void 0===a?!1:a)?le:THREE.BufferGeometry),A=(y.textLoad="ttfLoad",this.GetMaterialStyleId(e.textFont.style,e.textFont.weight,!1)),M=this.RegText(e.text),E=(e.text=M.text,y.type="TextBufferGeometry",y.name=e.text,y.styleId=A,e.index&&(y.textIndex=e.index),null==e.subInd&&null==e.subInd||(y.subInd=e.subInd),0),w=0,x=[],b=0,B=0;B<e.text.length;B++){var I,T,S,R,C,D,P,H,_=l?e.text:e.text[B];if(!(I=this.GetDimensionsForSize(_,e.textFont.size,A,e.textFont.name,e.textFont.width,e.textFont.bigName)))return null;if(I.isShx||I.isTTF)return y.isShx=I.isShx,y.isTTF=I.isTTF,y.textLoad="unLoad",y.styleId=I.isShx?de.SHX:de.BLEND,T=new THREE.Euler,r&&T.setFromQuaternion(r),u=e.text.length*(2<c?I.advanceX:I.width),p<I.height+I.bearingY&&(p=I.height+I.bearingY),d&&((e.regResult=M).underscode&&((S=new THREE.LineBasicMaterial).color.setRGB(i.r,i.g,i.b),(R=new THREE.Geometry).vertices.push(new THREE.Vector3(0,0,0),new THREE.Vector3(u,0,0)),R.rotateZ(T.z),R.rotateY(T.y),R.rotateX(T.x),R.translate(t.x,t.y-.1*I.height,t.z),(C=new THREE.LineSegments(R,S)).name=n,C.color=S.color.clone(),this.AddLine(C)),M.box&&((S=new THREE.LineBasicMaterial).color.setRGB(i.r,i.g,i.b),(R=new THREE.Geometry).vertices.push(new THREE.Vector3(u,p,0),new THREE.Vector3(u,0,0),new THREE.Vector3(u,0,0),new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,0),new THREE.Vector3(0,p,0),new THREE.Vector3(0,p,0),new THREE.Vector3(u,p,0)),R.rotateZ(T.z),R.rotateY(T.y),R.rotateX(T.x),R.translate(t.x,t.y,t.z),(C=new THREE.LineSegments(R,S)).name=n,C.color=S.color.clone(),this.AddLine(C)),M.dash)&&((S=new THREE.LineBasicMaterial).color.setRGB(i.r,i.g,i.b),(R=new THREE.Geometry).vertices.push(new THREE.Vector3(0,p,0),new THREE.Vector3(u,p,0)),R.rotateZ(T.z),R.rotateY(T.y),R.rotateX(T.x),R.translate(t.x,t.y+.1*I.height,t.z),(C=new THREE.LineSegments(R,S)).name=n,C.color=S.color.clone(),this.AddLine(C)),y;if(0===B&&(g=(m=(L=this.getTTFGeometryBuffer(f)).bufferOffset)/6,D=L.compositePositionAttrib,P=L.compositeUvAttrib,H=L.compositeTextureAttrib,L.bufferOffset+=24*f,O=L.index,h=L.index.array,v=L.indexOffset,L.indexOffset+=6*f),2<c&&" "==_)E=E<(u+=I.advanceX)?u:E,w=I.height>w?I.height:w,b=I.bearingY<b?I.bearingY:b,x.push(2<c?I.advanceX:I.width,I.height);else{(M.superscript&&B>=M.superscriptbegin&&B<=M.superscriptend||M.subscript&&B>=M.subscriptbegin&&B<=M.subscriptend)&&(I.height*=.5,I.width*=.5,I.bearingX*=.5,I.bearingY*=.5,I.advanceX*=.5,I.advanceY*=.5),M.superscript&&B>=M.superscriptbegin&&B<=M.superscriptend&&(I.bearingY-=I.height),p<I.height+I.bearingY&&(p=I.height+I.bearingY);var L=e.textFont.rotate&&this.IsChinese(_);if(D.data.array[m+24*B]=u+I.bearingX,D.data.array[m+24*B+1]=I.height+I.bearingY,D.data.array[m+24*B+2]=0,P.data.array[m+24*B+3]=L?I.right:I.left,P.data.array[m+24*B+4]=I.top,H.data.array[m+24*B+5]=I.textureid,D.data.array[m+24*B+6]=u+I.bearingX+I.width,D.data.array[m+24*B+7]=I.height+I.bearingY,D.data.array[m+24*B+8]=0,P.data.array[m+24*B+9]=I.right,P.data.array[m+24*B+10]=L?I.bottom:I.top,H.data.array[m+24*B+11]=I.textureid,D.data.array[m+24*B+12]=u+I.bearingX,D.data.array[m+24*B+13]=I.bearingY,D.data.array[m+24*B+14]=0,P.data.array[m+24*B+15]=I.left,P.data.array[m+24*B+16]=L?I.top:I.bottom,H.data.array[m+24*B+17]=I.textureid,D.data.array[m+24*B+18]=u+I.bearingX+I.width,D.data.array[m+24*B+19]=I.bearingY,D.data.array[m+24*B+20]=0,P.data.array[m+24*B+21]=L?I.left:I.right,P.data.array[m+24*B+22]=I.bottom,H.data.array[m+24*B+23]=I.textureid,h[v+6*B]=g+4*B,h[v+6*B+1]=g+4*B+2,h[v+6*B+2]=g+4*B+1,h[v+6*B+3]=g+4*B+2,h[v+6*B+4]=g+4*B+3,h[v+6*B+5]=g+4*B+1,E=E<(u+=2<c?I.advanceX:I.width)?u:E,w=I.height>w?I.height:w,b=I.bearingY<b?I.bearingY:b,x.push(2<c?I.advanceX:I.width,I.height),l)break}}return"ttfLoad"==y.textLoad&&(y.addAttribute("position",D),y.addAttribute("uv",P),y.addAttribute("textureid",H),y.setIndex(O),y.drawRange.start=v,y.drawRange.count=6*f),y.characterWidthHeight=x,y.rectWidth=E,y.rectHeight=w,y.rectBearingY=b,y.rectBearingX=0,d&&(T=new THREE.Euler,r&&T.setFromQuaternion(r),c<2&&(y.rotateZ(T.z),y.rotateY(T.y),y.rotateX(T.x),y.translate(t.x,t.y,t.z),this.AddObject(y,A,n)),M.underscode&&((S=new THREE.LineBasicMaterial).color.setRGB(i.r,i.g,i.b),(R=new THREE.Geometry).vertices.push(new THREE.Vector3(0,0,0),new THREE.Vector3(u,0,0)),R.rotateZ(T.z),R.rotateY(T.y),R.rotateX(T.x),R.translate(t.x,t.y-.1*I.height,t.z),(C=new THREE.LineSegments(R,S)).name=n,C.color=S.color.clone(),this.AddLine(C)),M.box&&((S=new THREE.LineBasicMaterial).color.setRGB(i.r,i.g,i.b),(R=new THREE.Geometry).vertices.push(new THREE.Vector3(u,p,0),new THREE.Vector3(u,0,0),new THREE.Vector3(u,0,0),new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,0),new THREE.Vector3(0,p,0),new THREE.Vector3(0,p,0),new THREE.Vector3(u,p,0)),R.rotateZ(T.z),R.rotateY(T.y),R.rotateX(T.x),R.translate(t.x,t.y,t.z),(C=new THREE.LineSegments(R,S)).name=n,C.color=S.color.clone(),this.AddLine(C)),M.dash)&&((S=new THREE.LineBasicMaterial).color.setRGB(i.r,i.g,i.b),(R=new THREE.Geometry).vertices.push(new THREE.Vector3(0,p,0),new THREE.Vector3(u,p,0)),R.rotateZ(T.z),R.rotateY(T.y),R.rotateX(T.x),R.translate(t.x,t.y+.1*I.height,t.z),(C=new THREE.LineSegments(R,S)).name=n,C.color=S.color.clone(),this.AddLine(C)),y},AddShxTextInfo:function(e){this.shxTextArray.push(e)},AddTtfTextInfo:function(e){this.ttfTextArray.push(e)},ProcessShxText:function(e,t,r){null!=t&&(this.ShxData=t);for(var i=0;i<this.shxTextArray.length;i++){var n=this.shxTextArray[i],a=e.ndsModel.getGeomManager().getGeomFromUuid(n.geomuuid,n.id);a&&(this.SetShxTextGeometry(this.ShxData,a,n.jsonText,!1,r),a.needsUpdate=!0,a.textLoad="shxLoad")}},ProcessTtfText:function(e,t,r){null!=t&&(this.ttfData=t);for(var i=0;i<this.ttfTextArray.length;i++){var n=this.ttfTextArray[i],a=e.ndsModel.getGeomManager().getGeomFromUuid(n.geomuuid,n.id);a&&(this.SetTtfTextGeometry(this.ttfData,a,n.jsonText,!1,r),a.needsUpdate=!0,a.textLoad="ttfLoad")}},SetLineStyleShxTextGeometry:function(e,t,r,i,n){if(!e)return!1;for(var a=0,o=this.GetMaterialStyleId(r.textFont.style,r.textFont.weight,!1),s=this.RegText(r.text),l=(r.text=s.text,new THREE.Box3(new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,0))),d=new THREE.Box3(new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,0)),c=[],h=[],u=0,p=[],f=0,m=0,g=0,v=0;v<r.text.length;v++){d.set(new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,0));var y=i?r.text:r.text[v],A=this.GetDimensionsForSize(y,r.textFont.size,o,r.textFont.name,r.textFont.width,r.textFont.bigName);if(A&&A.shxRange){for(var M=A.height,E=A.width,w=A.shxRange[0],x=1;x<A.shxRange.length;x++){for(var b=w;b<A.shxRange[x]+w;b+=4)c.push(a+e[b]*E),c.push(e[b+1]*M),c.push(0),c.push(a+e[b+2]*E),c.push(e[b+3]*M),c.push(0),h[u]=u,h[++u]=u,u++,d.expandByPoint(new THREE.Vector3(a+e[b]*E,e[b+1]*M,0)),d.expandByPoint(new THREE.Vector3(a+e[b+2]*E,e[b+3]*M,0)),l.expandByPoint(new THREE.Vector3(a+e[b]*E,e[b+1]*M,0)),l.expandByPoint(new THREE.Vector3(a+e[b+2]*E,e[b+3]*M,0));w+=A.shxRange[x]}a+=2<n?A.advanceX:A.width;var f=l.min.y<f?l.min.y:f,g=l.min.x<g?l.min.x:g,B=l.max.x-l.min.x-m,m=l.max.x-l.min.x,I=d.max.y-d.min.y;if(p.push(B,I),i)break}else" "!=y&&console.log("LineStyle faild: ",y," info: ",r),a+=2<n?A.advanceX:A.width}s=new Float32Array(c),s=new THREE.InterleavedBuffer(s,3),s=new THREE.InterleavedBufferAttribute(s,3,0,!1);return t.addAttribute("position",s),t.setIndex(new(65536<c.length/3?THREE.Uint32BufferAttribute:256<c.length/3?THREE.Uint16BufferAttribute:THREE.Uint8BufferAttribute)(h,1)),t.characterWidthHeight=p,t.rectWidth=l.max.x-l.min.x,t.rectHeight=l.max.y-l.min.y,t.rectBearingY=f,t.rectBearingX=g,!0},SetLineStyleTtfTextGeometry:function(e,t,r,i,n){if(!e)return!1;for(var a=0,o=this.GetMaterialStyleId(r.textFont.style,r.textFont.weight,!1),s=this.RegText(r.text),l=(r.text=s.text,new THREE.Box3(new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,0))),d=new THREE.Box3(new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,0)),c=[],h=[],u=0,p=[],f=0,m=0,g=0,v=0;v<r.text.length;v++){d.set(new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,0));var y=i?r.text:r.text[v],A=this.GetDimensionsForSize(y,r.textFont.size,o,r.textFont.name,r.textFont.width,r.textFont.bigName);if(A&&A.shxRange){for(var M=A.height,E=A.width,w=A.shxRange[0],x=1;x<A.shxRange.length;x++){for(var b=w;b<A.shxRange[x]+w;b+=6)c[c.length]=a+e[b]*E,c[c.length]=e[b+1]*M+A.bearingY,c[c.length]=0,c[c.length]=a+e[b+2]*E,c[c.length]=e[b+3]*M+A.bearingY,c[c.length]=0,c[c.length]=a+e[b+4]*E,c[c.length]=e[b+5]*M+A.bearingY,c[c.length]=0,h[u]=u,h[++u]=u,h[++u]=u,u++,d.expandByPoint(new THREE.Vector3(a+e[b]*E,e[b+1]*M+A.bearingY,0)),d.expandByPoint(new THREE.Vector3(a+e[b+2]*E,e[b+3]*M+A.bearingY,0)),d.expandByPoint(new THREE.Vector3(a+e[b+4]*E,e[b+5]*M+A.bearingY,0)),l.expandByPoint(new THREE.Vector3(a+e[b]*E,e[b+1]*M+A.bearingY,0)),l.expandByPoint(new THREE.Vector3(a+e[b+2]*E,e[b+3]*M+A.bearingY,0)),l.expandByPoint(new THREE.Vector3(a+e[b+4]*E,e[b+5]*M+A.bearingY,0));w+=A.shxRange[x]}a+=2<n?A.advanceX:A.width;var f=l.min.y<f?l.min.y:f,g=l.min.x<g?l.min.x:g,B=l.max.x-l.min.x-m,m=l.max.x-l.min.x,I=d.max.y-d.min.y;if(p.push(B,I),i)break}else" "!=y&&console.log("LineStyle faild: ",y," info: ",r),a+=2<n?A.advanceX:A.width}s=new Float32Array(c),s=new THREE.InterleavedBuffer(s,3),s=new THREE.InterleavedBufferAttribute(s,3,0,!1);return t.addAttribute("position",s),t.setIndex(new(65536<c.length/3?THREE.Uint32BufferAttribute:256<c.length/3?THREE.Uint16BufferAttribute:THREE.Uint8BufferAttribute)(h,1)),t.characterWidthHeight=p,t.rectWidth=l.max.x-l.min.x,t.rectHeight=l.max.y-l.min.y,t.rectBearingY=f,t.rectBearingX=g,!0},SetTtfTextGeometry:function(e,t,r,i,n){for(var a=0,o=this.GetMaterialStyleId(r.textFont.style,r.textFont.weight,!1),s=this.RegText(r.text),l=(r.text=s.text,[]),d=[],c=[],h=0,u=new THREE.Box3,p=0;p<r.text.length;p++){var f=i?r.text:r.text[p],m=this.GetDimensionsForSize(f,r.textFont.size,o,r.textFont.name,r.textFont.width,r.textFont.bigName);if(m&&m.shxRange){r.regResult&&((r.regResult.superscript&&p>=r.regResult.superscriptbegin&&p<=r.regResult.superscriptend||r.regResult.subscript&&p>=r.regResult.subscriptbegin&&p<=r.regResult.subscriptend)&&(m.height*=.5,m.width*=.5,m.bearingX*=.5,m.bearingY*=.5,m.advanceX*=.5,m.advanceY*=.5),r.regResult.superscript)&&p>=r.regResult.superscriptbegin&&p<=r.regResult.superscriptend&&(m.bearingY+=m.height);for(var g=m.height,v=m.width,y=m.shxRange[0],A=1;A<m.shxRange.length;A++){for(var M=y;M<m.shxRange[A]+y;M+=6){var E=l.length;l[E]=a+e[M]*v,l[E+1]=e[M+1]*g+m.bearingY,l[E+2]=0,l[E+3]=a+e[M+2]*v,l[E+4]=e[M+3]*g+m.bearingY,l[E+5]=0,l[E+6]=a+e[M+4]*v,l[E+7]=e[M+5]*g+m.bearingY,l[E+8]=0,d[h]=h,d[++h]=h,d[++h]=h,h++,u.expandByPoint(new THREE.Vector3(l[E],l[E+1],l[E+2])),u.expandByPoint(new THREE.Vector3(l[E+3],l[E+4],l[E+5])),u.expandByPoint(new THREE.Vector3(l[E+6],l[E+7],l[E+8]))}y+=m.shxRange[A]}if(a+=2<n?m.advanceX:m.width,i)break}else" "!=f&&console.log("faild: ",f," info: ",r),a+=2<n?m.advanceX:m.width}var w=this.getMeshTTFGeometryBuffer(l.length/3);t.drawRange.start=w.indexOffset,t.drawRange.count=d.length;for(var x=0,b=d.length;x<b;x+=3)d[x]+=w.indexOffset,d[x+1]+=w.indexOffset,d[x+2]+=w.indexOffset,c[2*x]=d[x],c[2*x+1]=d[x+1],c[2*x+2]=d[x+1],c[2*x+3]=d[x+2],c[2*x+4]=d[x+2],c[2*x+5]=d[x];w.compositeIBuffer.array.set(l,w.bufferOffset),w.bufferOffset+=l.length,w.index.array.set(d,w.indexOffset),w.indexLine.array.set(c,2*w.indexOffset),w.indexOffset+=d.length;s=w.compositePositionAttrib;t.addAttribute("position",s),t.setIndex(w.index),t.boundingBox=u,t.textWireFrame=new THREE.BufferGeometry,t.textWireFrame.drawRange.start=2*t.drawRange.start,t.textWireFrame.drawRange.count=2*t.drawRange.count,t.textWireFrame.addAttribute("position",s),t.textWireFrame.setIndex(w.indexLine),t.textWireFrame.name="ttf wireframe",t.textWireFrame.needsUpdate=!0},SetShxTextGeometry:function(e,t,r,i,n){for(var a=0,o=this.GetMaterialStyleId(r.textFont.style,r.textFont.weight,!1),s=this.RegText(r.text),l=(r.text=s.text,[]),d=[],c=0,h=new THREE.Box3,u=0,p=0,f=[],m=0,g=0;g<r.text.length;g++){var v=i?r.text:r.text[g],y=this.GetDimensionsForSize(v,r.textFont.size,o,r.textFont.name,r.textFont.width,r.textFont.bigName);if(y&&y.shxRange){r.regResult&&((r.regResult.superscript&&g>=r.regResult.superscriptbegin&&g<=r.regResult.superscriptend||r.regResult.subscript&&g>=r.regResult.subscriptbegin&&g<=r.regResult.subscriptend)&&(y.height*=.5,y.width*=.5,y.bearingX*=.5,y.bearingY*=.5,y.advanceX*=.5,y.advanceY*=.5),r.regResult.superscript)&&g>=r.regResult.superscriptbegin&&g<=r.regResult.superscriptend&&(y.bearingY+=y.height);for(var A=y.height,M=y.width,E=y.shxRange[0],w=1;w<y.shxRange.length;w++){for(var x=E;x<y.shxRange[w]+E;x+=4){var b=l.length;l[b]=a+e[x]*M,l[b+1]=e[x+1]*A+y.bearingY,l[b+2]=0,l[b+3]=a+e[x+2]*M,l[b+4]=e[x+3]*A+y.bearingY,l[b+5]=0,d[c]=c,d[++c]=c,c++,h.expandByPoint(new THREE.Vector3(l[b],l[b+1],l[b+2])),h.expandByPoint(new THREE.Vector3(l[b+3],l[b+4],l[b+5]))}E+=y.shxRange[w]}if(u=a+=2<n?y.advanceX:y.width,p=y.height>p?y.height:p,m=y.bearingY<m?y.bearingY:m,f.push(2<n?y.advanceX:y.width,y.height),i)break}else" "!=v&&console.log("faild: ",v," info: ",r),u=a+=2<n?y.advanceX:y.width,p=y.height>p?y.height:p,m=y.bearingY<m?y.bearingY:m,f.push(2<n?y.advanceX:y.width,y.height)}var B=this.getSHXGeometryBuffer(l.length/3);t.characterWidthHeight=f,t.rectWidth=u,t.rectHeight=p,t.rectBearingY=m,t.rectBearingX=0,t.drawRange.start=B.indexOffset,t.drawRange.count=d.length;for(var I=0,T=d.length;I<T;++I)d[I]+=B.indexOffset;B.compositeIBuffer.array.set(l,B.bufferOffset),B.bufferOffset+=l.length,B.index.array.set(d,B.indexOffset),B.indexOffset+=d.length;s=B.compositePositionAttrib;t.addAttribute("position",s),t.setIndex(B.index),t.boundingBox=h},GetDimensionsForSize:function(e,t,r,i,n,a){var o,s=null,l=i,d="msyh.ttf",c="gbenor.shx",h="gbcbig.shx",c=(2<this.SDFVerison&&this.metrics[r]?(a&&this.metrics[r][a]&&(s=this.metrics[r][a][e],l=a),s&&this.IsShxFont(i)||!this.metrics[r][i]||(s=this.metrics[r][i][e],l=i),s||(this.IsShxFont(i)?(!s&&this.metrics[r][h]&&(s=this.metrics[r][h][e],l=h),!s&&this.metrics[r][c]&&(s=this.metrics[r][c][e],l=c)):!s&&this.metrics[r][d]&&(s=this.metrics[r][d][e],l=d))):2==this.SDFVerison&&this.metrics[r]?(this.metrics[r][i]&&(s=this.metrics[r][i][e],l=i),!s&&a&&this.metrics[r][a]&&(s=this.metrics[r][a][e],l=a),!s&&this.metrics[r][d]&&(s=this.metrics[r][d][e],l=d)):1==this.SDFVerison&&this.metrics[r]&&("N"==(h=this.getFontType(i))&&(h=this.IsChinese(e)?"F":"A"),s=this.metrics[r][h][e],l=d),!1),s=s||{height:1,width:1,left:0,top:0,right:1,bottom:1,textureid:0,shxRange:null,advanceX:0,advanceY:0,bearingX:0,bearingY:0,isShx:!(c=!0),isTTF:!1},a=1,i=1,r=1,h=0,d=0,u=0,p=0,f=5,m=!1,g=!1,v=!1;return 1==this.SDFVerison?(i=s.width*a*t,r=s.height*t,f=c?5:this.nametotextureID[l]):2==this.SDFVerison?(o=this.GetTextScale(e,l),i=s.width*o*(a=null==n?1:n)*t,r=s.height*o*t,f=c?5:this.nametotextureID[l],m=null!=s.shxRange," "===e&&!m&&this.IsShxFont(l)&&(m=!0),d=-r*this.GetTextOffset(null,l,m),a*=a<1.5?.95:1):3<=this.SDFVerison&&(u=s.advanceX*(a=null==n?1:n)*t,p=s.advanceY*t," "==e?s.isShx||s.isTTF?(r=i=u,m=s.isShx,g=s.isTTF,v=s.isVertical):(r=i=u,f=c?5:this.nametotextureID[l],h=s.bearingX*a*t,d=s.bearingY*t):s.isShx||s.isTTF?(i=i*a*t,r*=t,m=s.isShx,g=s.isTTF,v=s.isVertical):(i=s.width*a*t,r=s.height*t,f=c?5:this.nametotextureID[l],h=s.bearingX*a*t,d=s.bearingY*t)),{width:i,height:r,bearingX:h,bearingY:d,advanceX:u,advanceY:p,left:s.left,top:s.top,right:s.right,bottom:s.bottom,textureid:f||0,font:l,widthScale:a,discard:c,isShx:m,isTTF:g,isVertical:v,shxRange:s.shxRange,fontScale:s.fontScale||1}},AddTextGeometryBuffer:function(e,t,r,i,n){var a=this.AttributeArray[t];a&&!Array.isArray(a)?this.AttributeArray[t]=a=[a]:a||(this.AttributeArray[t]=a=[]),e.uuidtorange[r]={start:i,count:n},a.indexOf(e)<0&&(a[a.length]=e)},AddObject:function(e,t,r){var i=this.AttributeArray[t],n=(i||(i={propertyArray:new Array,IndexArray:new Array,ArrayLength:0,uuidtorange:new Object},this.AttributeArray[t]=i),e.getAttribute("position"));i.uuidtorange[r]={start:i.propertyArray.length/9,count:n.count};for(var a=0;a<n.array.length;++a)i.propertyArray.push(n.array[a]);for(var o=e.getIndex(),s=0;s<o.array.length;s++)i.IndexArray.push(o.array[s]+i.ArrayLength);i.ArrayLength+=n.count},AddLine:function(e){this.lines.push(e)},GetLines:function(){return this.lines},GetLineStyleMaterial:function(e,t){return t?this.shxMaterial:2<=e?this.blendMaterial:this.newblendMaterial},GetMaterial:function(e){switch(e){case de.ITALIC:return this.TextMaterialItalic;case de.NORMAL:return this.TextMaterial;case de.BOLD:return this.TextMaterialBold;case de.ITALICANDBOLD:return this.TextMaterialIandB;case de.BLEND:return this.blendMaterial;case de.SHX:return this.shxMaterial}},HaveSDF:function(){return this.AttributeArray.length},CreateMesh:function(){for(var e=new THREE.Group,t=0;t<this.AttributeArray.length;t++)if(this.AttributeArray[t])if(Array.isArray(this.AttributeArray[t]))for(var r=0,i=this.AttributeArray[t].length;r<i;++r){var n=this.AttributeArray[t][r],a=(n.compositeIBuffer,n.compositePositionAttrib),o=n.compositeColorAttrib,s=n.compositeUvAttrib,l=n.compositeTextureAttrib,a=((d=new THREE.BufferGeometry).addAttribute("position",a),d.addAttribute("color",o),d.addAttribute("uv",s),d.addAttribute("textureid",l),d.setIndex(n.index),new THREE.Mesh(d,this.GetMaterial(t)));a.name=t+"_"+r,e.add(a)}else{var d=new THREE.BufferGeometry,c=new Float32Array(this.AttributeArray[t].propertyArray),c=new THREE.InterleavedBuffer(c,9),h=new THREE.InterleavedBufferAttribute(c,3,0,!1),u=new THREE.InterleavedBufferAttribute(c,3,3,!1),p=new THREE.InterleavedBufferAttribute(c,2,6,!1),c=new THREE.InterleavedBufferAttribute(c,1,8,!1),h=(d.addAttribute("position",h),d.addAttribute("color",u),d.addAttribute("uv",p),d.addAttribute("textureid",c),d.setIndex(this.AttributeArray[t].IndexArray),new THREE.Mesh(d,this.GetMaterial(t)));h.name=t,e.add(h)}return e.name="TextGroup",this.ClearMemory(),e},ClearMemory:function(){for(var e=0;e<this.AttributeArray.length;++e)if(Array.isArray(this.AttributeArray[e]))for(var t=0;t<this.AttributeArray[e].length;++t)this.AttributeArray[e][t]&&(this.AttributeArray[e][t]=this.AttributeArray[e][t].uuidtorange);else this.AttributeArray[e]&&(this.AttributeArray[e]=this.AttributeArray[e].uuidtorange);this.specialCodeArray=[],this.HashTable=[]},clear:function(){null!=this.TextMaterial.dispose&&this.TextMaterial.dispose(),null!=this.TextMaterialItalic.dispose&&this.TextMaterialItalic.dispose(),null!=this.TextMaterialBold.dispose&&this.TextMaterialBold.dispose(),null!=this.TextMaterialIandB.dispose&&this.TextMaterialIandB.dispose();for(var e=0;e<this.textures.length;++e)this.textures[e].image.data=[],this.textures[e].dispose();this.shxMaterial&&this.shxMaterial.dispose()},MeshTextSetData:function(e,t){this.ShxData=e,this.ttfData=t},MeshTextParseGeometryTotal:function(e,O,F,U,N,V,G,t,r){void 0===t&&(t=!1),void 0===r&&(r=!1);for(var i=0,n=0,k=this.GetMaterialStyleId(e.textFont.style,e.textFont.weight,!1),a=this.RegText(e.text),o=(e.text=a.text,new(t?le:THREE.BufferGeometry)),s=(o.type="TextBufferGeometry",o.name=e.text,o.styleId=k,e.index&&(o.textIndex=e.index),null==e.subInd&&null==e.subInd||(o.subInd=e.subInd),[]),l=[],d=[],c=0,h=new THREE.Box3(new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,0)),u=new THREE.Box3(new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,0)),p=1,f=Math.tan(e.textFont.oblique),m=e.textFont.mirrorX,g=e.textFont.mirrorY,j=0,z=0,v=1,y=new THREE.Box3,W=[],X=[],q=0,Y=0,Q=0,K=0,A=0;A<e.text.length;A++){var M,E=r?e.text:e.text[A];if(!(M=this.GetDimensionsForSize(E,e.textFont.size,k,e.textFont.name,e.textFont.width,e.textFont.bigName)))return null;0==A&&(M.isShx||M.isTTF)&&(o.isShx=M.isShx,o.isTTF=M.isTTF,o.styleId=M.isShx?de.SHX:de.BLEND,M.isTTF)&&(Z=!1);var Z=e.textFont.vertical&&M.isVertical;if(Z?n+=0==A?-M.height:z:i+=j,M&&M.shxRange){(a.superscript&&A>=a.superscriptbegin&&A<=a.superscriptend||a.subscript&&A>=a.subscriptbegin&&A<=a.subscriptend)&&(M.height*=.5,M.width*=.5,M.bearingX*=.5,M.bearingY*=.5,M.advanceX*=.5,M.advanceY*=.5),a.superscript&&A>=a.superscriptbegin&&A<=a.superscriptend&&(M.bearingY+=M.height);var w=M.height,x=M.width,J=e.textFont.rotate&&this.IsChinese2(E),b=M.shxRange[0];if(u.set(new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,0)),y.makeEmpty(),o.isShx)for(var $=1;$<M.shxRange.length;$++){for(var B=b;B<M.shxRange[$]+b;B+=4){var I=s.length;m?(s[I+0]=i-this.ShxData[B]*x*v,s[I+3]=i-this.ShxData[B+2]*x*v):(s[I+0]=i+this.ShxData[B]*x*v,s[I+3]=i+this.ShxData[B+2]*x*v),g?(s[I+1]=n-(this.ShxData[B+1]*w+M.bearingY)*v,s[I+4]=n-(this.ShxData[B+3]*w+M.bearingY)*v):(s[I+1]=n+(this.ShxData[B+1]*w+M.bearingY)*v,s[I+4]=n+(this.ShxData[B+3]*w+M.bearingY)*v),s[I+2]=0,s[I+5]=0,l[c]=c,l[++c]=c,c++,m!=g?(s[I+0]-=s[I+1]*f,s[I+3]-=s[I+4]*f):(s[I+0]+=s[I+1]*f,s[I+3]+=s[I+4]*f),y.expandByPoint(new THREE.Vector3(s[I],s[I+1],s[I+2])),y.expandByPoint(new THREE.Vector3(s[I+3],s[I+4],s[I+5]))}b+=M.shxRange[$]}if(o.isTTF){M.top>p&&(p=M.top);for(var ee=1;ee<M.shxRange.length;ee++){for(var T=b;T<M.shxRange[ee]+b;T+=6){var S=s.length;J?(m?(s[S+0]=i-(M.top-this.ttfData[T+1])*w+M.bearingY,s[S+3]=i-(M.top-this.ttfData[T+3])*w+M.bearingY,s[S+6]=i-(M.top-this.ttfData[T+5])*w+M.bearingY):(s[S+0]=i+(M.top-this.ttfData[T+1])*w+M.bearingY,s[S+3]=i+(M.top-this.ttfData[T+3])*w+M.bearingY,s[S+6]=i+(M.top-this.ttfData[T+5])*w+M.bearingY),g?(s[S+1]=n-(p+this.ttfData[T]-M.right)*x,s[S+4]=n-(p+this.ttfData[T+2]-M.right)*x,s[S+7]=n-(p+this.ttfData[T+4]-M.right)*x):(s[S+1]=n+(p+this.ttfData[T]-M.right)*x,s[S+4]=n+(p+this.ttfData[T+2]-M.right)*x,s[S+7]=n+(p+this.ttfData[T+4]-M.right)*x)):(m?(s[S+0]=i-this.ttfData[T+0]*x,s[S+3]=i-this.ttfData[T+2]*x,s[S+6]=i-this.ttfData[T+4]*x):(s[S+0]=i+this.ttfData[T+0]*x,s[S+3]=i+this.ttfData[T+2]*x,s[S+6]=i+this.ttfData[T+4]*x),g?(s[S+1]=n-this.ttfData[T+1]*w+M.bearingY,s[S+4]=n-this.ttfData[T+3]*w+M.bearingY,s[S+7]=n-this.ttfData[T+5]*w+M.bearingY):(s[S+1]=n+this.ttfData[T+1]*w+M.bearingY,s[S+4]=n+this.ttfData[T+3]*w+M.bearingY,s[S+7]=n+this.ttfData[T+5]*w+M.bearingY)),s[S+2]=0,s[S+5]=0,s[S+8]=0,l[c]=c,l[++c]=c,l[++c]=c,c++,m!=g?(s[S+0]-=s[S+1]*f,s[S+3]-=s[S+4]*f,s[S+6]-=s[S+7]*f):(s[S+0]+=s[S+1]*f,s[S+3]+=s[S+4]*f,s[S+6]+=s[S+7]*f),y.expandByPoint(new THREE.Vector3(s[S],s[S+1],s[S+2])),y.expandByPoint(new THREE.Vector3(s[S+3],s[S+4],s[S+5])),y.expandByPoint(new THREE.Vector3(s[S+6],s[S+7],s[S+8]))}b+=M.shxRange[ee]}}u.union(y),h.union(y);var j=m?-M.advanceX*v:M.advanceX*v,z=-M.advanceY,q=h.min.y<q?h.min.y:q,Q=h.min.x<Q?h.min.x:Q,R=h.max.x-h.min.x-Y,C=(R<=0&&" "==E?K+=M.advanceX:K=0,Y=h.max.x-h.min.x+K,u.max.y-u.min.y);if(X.push(R<=0?M.advanceX:R,C<=0?M.advanceY:C),y.isEmpty()&&(R=new THREE.Vector3(i,n,0),C=Z?new THREE.Vector3(i+j,n+z,0):new THREE.Vector3(i+j,n+M.height,0),y.expandByPoint(R),y.expandByPoint(C)),W.push(y.min.x,y.min.y,y.max.x,y.max.y),r)break}else{R=i,C=n;" "!=E&&(1e-4<Math.abs(M.fontScale-1)?(n+=M.advanceY*v,v*=M.fontScale):console.log("faild: ",E," info: ",e)),Z?n-=M.advanceY:m?i-=M.advanceX*v:i+=M.advanceX*v,X.push(z=j=0,0),W.push(R,C,i,n)}}o.characterBoxs=W,o.characterWidthHeight=X,o.rectWidth=h.max.x-h.min.x,o.rectHeight=h.max.y-h.min.y,o.rectBearingY=q,o.rectBearingX=Q,o.mirrorX=m,o.mirrorY=g;for(var D=[],te=(a.underscode&&(t=s.length/3,s[s.length]=h.min.x,s[s.length]=h.min.y-.1*M.height,s[s.length]=0,s[s.length]=h.max.x,s[s.length]=h.min.y-.1*M.height,s[s.length]=0,D[D.length]=t,D[D.length]=1+t),a.box&&(t=s.length/3,s[s.length]=h.min.x,s[s.length]=h.min.y,s[s.length]=0,s[s.length]=h.min.x,s[s.length]=h.max.y,s[s.length]=0,s[s.length]=h.max.x,s[s.length]=h.max.y,s[s.length]=0,s[s.length]=h.max.x,s[s.length]=h.min.y,s[s.length]=0,D[D.length]=t,D[D.length]=1+t,D[D.length]=1+t,D[D.length]=2+t,D[D.length]=2+t,D[D.length]=3+t,D[D.length]=3+t,D[D.length]=t),a.dash&&(t=s.length/3,s[s.length]=h.min.x,s[s.length]=h.max.y+.1*M.height,s[s.length]=0,s[s.length]=h.max.x,s[s.length]=h.max.y+.1*M.height,s[s.length]=0,D[D.length]=t,D[D.length]=1+t),(new THREE.Matrix4).compose(O,F,new THREE.Vector3(1,1,1))),re=(te.multiply(U),new THREE.Vector3),P=0;P<s.length;P+=3)re.set(s[P],s[P+1],s[P+2]),re.applyMatrix4(te),s[P]=re.x,s[P+1]=re.y,s[P+2]=0;if(h.applyMatrix4(te),o.isShx){for(var H=this.MeshTextGetSHXBuffer(G),ie=0,ne=l.length;ie<ne;++ie)l[ie]+=H.indexOffset;for(var ae=0;ae<D.length;ae++)l[l.length]=D[ae]+H.indexOffset;o.drawRange.start=H.indexOffset,o.drawRange.count=l.length,H.compositeIBuffer.array.set(s,H.bufferOffset),H.bufferOffset+=s.length,H.index.array.set(l,H.indexOffset),H.indexOffset+=l.length,o.addAttribute("position",H.compositeIBuffer),o.setIndex(H.index),o.boundingBox=h,o.needsUpdate=!0,o.textLoad="shxLoad"}if(o.isTTF){var _=this.MeshTextGetTTFBuffer(G);o.drawRange.start=_.indexOffset,o.drawRange.count=l.length;for(var L=0,oe=l.length;L<oe;L+=3)l[L]+=_.indexOffset,l[L+1]+=_.indexOffset,l[L+2]+=_.indexOffset,d[2*L]=l[L],d[2*L+1]=l[L+1],d[2*L+2]=l[L+1],d[2*L+3]=l[L+2],d[2*L+4]=l[L+2],d[2*L+5]=l[L];for(var se=0;se<D.length;se++)d[d.length]=D[se]+_.indexOffset;_.compositeIBuffer.array.set(s,_.bufferOffset),_.bufferOffset+=s.length,_.index.array.set(l,_.indexOffset),_.indexLine.array.set(d,2*_.indexOffset),_.indexOffset+=s.length/3,o.addAttribute("position",_.compositeIBuffer),o.setIndex(_.index),o.boundingBox=h,o.textWireFrame=new THREE.BufferGeometry,o.textWireFrame.drawRange.start=2*o.drawRange.start,o.textWireFrame.drawRange.count=2*o.drawRange.count+D.length,o.textWireFrame.attributes.position=o.attributes.position,o.textWireFrame.setIndex(_.indexLine),o.textWireFrame.boundingBox=h,o.textWireFrame.name="ttf wireframe",o.textWireFrame.needsUpdate=!0,o.needsUpdate=!0,o.textLoad="ttfLoad"}return o},MeshTextCount:function(e,t,r){for(var i=0,n=0,a=!0,o=this.RegText(e.text),s=this.GetMaterialStyleId(e.textFont.style,e.textFont.weight,!1),l=0;l<e.text.length;l++){var d=t?e.text:e.text[l],c=this.GetDimensionsForSize(d,e.textFont.size,s,e.textFont.name,e.textFont.width,e.textFont.bigName);if(!c)break;if(1<r&&r<4&&!c.isShx)n+=4,a=!1;else if(c.shxRange)for(var h=1;h<c.shxRange.length;h++)c.shxRange[h],c.isShx?i+=c.shxRange[h]:c.isTTF&&(n+=c.shxRange[h],a=!1)}return o.underscode&&(a?i+=2:n+=2),o.box&&(a?i+=8:n+=8),o.dash&&(a?i+=2:n+=2),[i,n]},MeshTextGetSHXBuffer:function(e){var t;return 0<e.shxCount&&(t=e.shxCount/2*3,this.shxTotalBuffer.push({compositeIBuffer:new THREE.BufferAttribute(new Float32Array(t),3,0,!1),index:new THREE.BufferAttribute(this.MeshTextGetIndexArray(t/3),1),bufferOffset:0,indexOffset:0}),e.shxCount=0),0==this.shxTotalBuffer.length?this.orgTotalBuffer:this.shxTotalBuffer[this.shxTotalBuffer.length-1]},MeshTextGetTTFBuffer:function(e){var t;return 0<e.ttfCount&&(t=e.ttfCount/2*3,this.ttfTotalBuffer.push({compositeIBuffer:new THREE.BufferAttribute(new Float32Array(t),3,0,!1),index:new THREE.BufferAttribute(this.MeshTextGetIndexArray(t/3),1),indexLine:new THREE.BufferAttribute(this.MeshTextGetIndexArray(t/3*2),1),bufferOffset:0,indexOffset:0}),e.ttfCount=0),0==this.ttfTotalBuffer.length?this.orgTotalBuffer:this.ttfTotalBuffer[this.ttfTotalBuffer.length-1]},MeshTextGetIndexArray:function(e){return new(65535<=e?Uint32Array:256<=e?Uint16Array:Uint8Array)(e)},OldTextParseGeometryTotal:function(e,t,O,F,U,N,r,i,V,n,G,a){void 0===r&&(r=!1),void 0===i&&(i=!1),void 0===V&&(V=!1),void 0===n&&(n=!1),void 0===G&&(G=!1),void 0===a&&(a=2);for(var o=0,k=0,j=this.GetMaterialStyleId(e.textFont.style,e.textFont.weight,!1),s=this.RegText(e.text),l=(e.text=s.text,new(r?le:THREE.BufferGeometry)),d=(l.type="TextBufferGeometry",l.name=e.text,l.styleId=j,0),c=0,h=0,u=null,p=null,f=null,m=null,g=null,v=null,y=(e.index&&(l.textIndex=e.index),null==e.subInd&&null==e.subInd||(l.subInd=e.subInd),new THREE.Box3(new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,0))),A=0,M=0,E=[],w=0,x=0,b=0,B=0;B<e.text.length;B++){var I,T=n?e.text:e.text[B];if(!(I=this.GetDimensionsForSize(T,e.textFont.size,j,e.textFont.name,e.textFont.width,e.textFont.bigName)))return null;if(0===B&&(l.isShx=I.isShx,l.isTTF=!I.isShx,l.isShx?(v=this.MeshTextGetSHXBuffer(N),u=v.compositeIBuffer,m=v.index,d=v.bufferOffset,h=v.indexOffset,c=d/3):(g=this.OldTextGetTTFBuffer(N),d=g.bufferOffset,h=g.indexOffset,c=d/6,u=g.compositePositionAttrib,p=g.compositeUvAttrib,f=g.compositeTextureAttrib,m=g.index)),2<a&&" "==T||l.isShx&&!I.shxRange)o+=!l.isShx||2<a?I.advanceX:I.width,A=l.isShx||A<o?o:A,M=I.height>M?I.height:M,w=I.bearingY<w?I.bearingY:w,E.push(2<a?I.advanceX:I.width,I.height);else{(s.superscript&&B>=s.superscriptbegin&&B<=s.superscriptend||s.subscript&&B>=s.subscriptbegin&&B<=s.subscriptend)&&(I.height*=.5,I.width*=.5,I.bearingX*=.5,I.bearingY*=.5,I.advanceX*=.5,I.advanceY*=.5),s.superscript&&B>=s.superscriptbegin&&B<=s.superscriptend&&(I.bearingY-=I.height),k<I.height+I.bearingY&&(k=I.height+I.bearingY);T=e.textFont.rotate&&this.IsChinese(T);if(l.isTTF&&(u.data.array[d+24*x]=o+I.bearingX,u.data.array[d+24*x+1]=I.height+I.bearingY,u.data.array[d+24*x+2]=0,p.data.array[d+24*x+3]=T?I.right:I.left,p.data.array[d+24*x+4]=I.top,f.data.array[d+24*x+5]=I.textureid,u.data.array[d+24*x+6]=o+I.bearingX+I.width,u.data.array[d+24*x+7]=I.height+I.bearingY,u.data.array[d+24*x+8]=0,p.data.array[d+24*x+9]=I.right,p.data.array[d+24*x+10]=T?I.bottom:I.top,f.data.array[d+24*x+11]=I.textureid,u.data.array[d+24*x+12]=o+I.bearingX,u.data.array[d+24*x+13]=I.bearingY,u.data.array[d+24*x+14]=0,p.data.array[d+24*x+15]=I.left,p.data.array[d+24*x+16]=T?I.top:I.bottom,f.data.array[d+24*x+17]=I.textureid,u.data.array[d+24*x+18]=o+I.bearingX+I.width,u.data.array[d+24*x+19]=I.bearingY,u.data.array[d+24*x+20]=0,p.data.array[d+24*x+21]=T?I.left:I.right,p.data.array[d+24*x+22]=I.bottom,f.data.array[d+24*x+23]=I.textureid,m.array[h+6*x]=c+4*x,m.array[h+6*x+1]=c+4*x+2,m.array[h+6*x+2]=c+4*x+1,m.array[h+6*x+3]=c+4*x+2,m.array[h+6*x+4]=c+4*x+3,m.array[h+6*x+5]=c+4*x+1,y.expandByPoint(new THREE.Vector3(u.data.array[d+24*x+0],u.data.array[d+24*x+1],0)),y.expandByPoint(new THREE.Vector3(u.data.array[d+24*x+6],u.data.array[d+24*x+7],0)),y.expandByPoint(new THREE.Vector3(u.data.array[d+24*x+12],u.data.array[d+24*x+13],0)),y.expandByPoint(new THREE.Vector3(u.data.array[d+24*x+18],u.data.array[d+24*x+19],0)),x++),l.isShx)for(var z=I.height,W=I.width,S=I.shxRange[0],R=1;R<I.shxRange.length;R++){for(var C=S;C<I.shxRange[R]+S;C+=4)u.array[d+3*b+0]=o+this.ShxData[C]*W,u.array[d+3*b+1]=this.ShxData[C+1]*z+I.bearingY,u.array[d+3*b+2]=0,u.array[d+3*b+3]=o+this.ShxData[C+2]*W,u.array[d+3*b+4]=this.ShxData[C+3]*z+I.bearingY,u.array[d+3*b+5]=0,m.array[h+b]=c+b,m.array[h+b+1]=c+b+1,y.expandByPoint(new THREE.Vector3(u.array[d+3*b+0],u.array[d+3*b+1],0)),y.expandByPoint(new THREE.Vector3(u.array[d+3*b+3],u.array[d+3*b+4],0)),b+=2;S+=I.shxRange[R]}if(o+=2<a?I.advanceX:I.width,A=l.isShx||A<o?o:A,M=I.height>M?I.height:M,w=I.bearingY<w?I.bearingY:w,E.push(2<a?I.advanceX:I.width,I.height),n)break}}if(l.isTTF){for(var D=(new THREE.Matrix4).compose(t,O,new THREE.Vector3(1,1,1)),P=new THREE.Vector3,H=0;H<x;H++)P.set(u.data.array[d+24*H+0],u.data.array[d+24*H+1],0),P.applyMatrix4(D),u.data.array[d+24*H+0]=P.x,u.data.array[d+24*H+1]=P.y,P.set(u.data.array[d+24*H+6],u.data.array[d+24*H+7],0),P.applyMatrix4(D),u.data.array[d+24*H+6]=P.x,u.data.array[d+24*H+7]=P.y,P.set(u.data.array[d+24*H+12],u.data.array[d+24*H+13],0),P.applyMatrix4(D),u.data.array[d+24*H+12]=P.x,u.data.array[d+24*H+13]=P.y,P.set(u.data.array[d+24*H+18],u.data.array[d+24*H+19],0),P.applyMatrix4(D),u.data.array[d+24*H+18]=P.x,u.data.array[d+24*H+19]=P.y;y.applyMatrix4(D),l.addAttribute("position",u),l.addAttribute("uv",p),l.addAttribute("textureid",f),l.setIndex(m),l.drawRange.start=h,l.drawRange.count=6*x,l.boundingBox=y,l.needsUpdate=!0,l.textLoad="ttfLoad",g.bufferOffset+=24*x,g.indexOffset+=6*x}if(l.isShx){for(var i=function(e,t,r,i){u.array[d+3*b+0]=e,u.array[d+3*b+1]=t,u.array[d+3*b+2]=0,u.array[d+3*b+3]=r,u.array[d+3*b+4]=i,u.array[d+3*b+5]=0,m.array[h+b]=c+b,m.array[h+b+1]=c+b+1,b+=2},X=(s.underscode&&i(y.min.x,y.min.y-.1*I.height,y.max.x,y.min.y-.1*I.height),s.box&&(i(y.min.x,y.min.y,y.min.x,y.max.y),i(y.min.x,y.max.y,y.max.x,y.max.y),i(y.max.x,y.max.y,y.max.x,y.min.y),i(y.max.x,y.min.y,y.min.x,y.min.y)),s.dash&&i(y.min.x,y.max.y+.1*I.height,y.max.x,y.max.y+.1*I.height),(new THREE.Matrix4).compose(t,O,new THREE.Vector3(1,1,1))),_=new THREE.Vector3,L=0;L<b;L++)_.set(u.array[d+3*L+0],u.array[d+3*L+1],0),_.applyMatrix4(X),u.array[d+3*L+0]=_.x,u.array[d+3*L+1]=_.y;y.applyMatrix4(X),l.addAttribute("position",u),l.setIndex(m),l.drawRange.start=h,l.drawRange.count=b,l.boundingBox=y,l.needsUpdate=!0,l.textLoad="shxLoad",v.bufferOffset+=3*b,v.indexOffset+=b}return l.characterWidthHeight=E,l.rectWidth=A,l.rectHeight=M,l.rectBearingY=w,l.rectBearingX=0,l},OldTextSetData:function(e,t,r){this.ShxData=e||null,this.textures=t||null},OldTextUpdateTextures:function(e){if(this.textures&&this.oldTextUpdateTexture){for(var t=0;t<this.textures.length;++t)if(this.textures[t].flipY=!1,this.textures[t].needsUpdate=!0,e)for(var r=0;r<e.length;r++){var i=e[r];i.uniforms["uSampler"+t].value=this.textures[t],i.uniforms["uSampler"+t].value.flipY=!1,i.uniforms["uSampler"+t].value.needsUpdate=!0}this.oldTextUpdateTexture=!1}},OldTextGetTTFBuffer:function(e){var t;return 0<e.ttfCount&&(t=e.ttfCount,(t={compositeIBuffer:new THREE.InterleavedBuffer(new Float32Array(6*t),6),index:new THREE.BufferAttribute(this.MeshTextGetIndexArray(3*t/2),1),bufferOffset:0,indexOffset:0}).compositePositionAttrib=new THREE.InterleavedBufferAttribute(t.compositeIBuffer,3,0,!1),t.compositeUvAttrib=new THREE.InterleavedBufferAttribute(t.compositeIBuffer,2,3,!1),t.compositeTextureAttrib=new THREE.InterleavedBufferAttribute(t.compositeIBuffer,1,5,!1),this.ttfTotalBuffer.push(t),e.ttfCount=0),this.ttfTotalBuffer[this.ttfTotalBuffer.length-1]}},de.ITALIC=0,de.BOLD=1,de.NORMAL=2,de.ITALICANDBOLD=3,de.BLEND=4,de.SHX=5,function(e){this.viewer=e;this.lineTypeStyle=[],this.uuidToLineStyle={},this.geomUUidToLineInfo={},this.geomUUidToGeomInfo={},this.ttfMesh=new THREE.Mesh,this.shxMesh=new THREE.LineSegments,this.pointMesh=new THREE.Points,this.lineMesh=new THREE.LineSegments,this.lineMaterials=[],this.createLineStyle=function(e,t){var r=null;if(t)for(var r={},i=0;i<t.length;i++)r[t[i].uuid]=t[i];for(var n=0;n<e.length;n++){if(0===e[n].fPatternLength){for(var a=0;a<e[n].nDashes;a++){var o=e[n].lItem[a];e[n].fPatternLength+=Math.abs(o.fLength)}0===e[n].fPatternLength&&(e[n].fPatternLength=1)}for(var s,l=e[n].fScale,d={pattern:e[n].fPatternLength*l,pointPattern:[],linePattern:[],textPattern:[],textureArray:new Uint8Array(4096),textGeomArray:[],textOrPoint:!1,index:n},c={index:n,pattern:d.pattern,array:[],uuid:e[n].strId},h=0,u=0,p=0;p<e[n].nDashes;p++){var f,m,g,v,y=e[n].lItem[p];if(u+=Math.abs(y.fLength*l),c.array.push(y.fLength*l),0==y.fLength)d.pointPattern.push(u),d.textOrPoint=!0;else{for(s=Math.floor(u/d.pattern*1024),d.linePattern.push(y.fLength*l);h<s;)d.textureArray[4*h]=0<=y.fLength?0:255,h++;(0<y.nShapeId||null!=y.strText)&&(f={bigName:"",name:y.fontName,size:y.fScale*l,style:"normal",weight:"normal",width:1},r)&&y.fontUUid&&r[y.fontUUid]&&(f.bigName=r[y.fontUUid].bigName,f.name=r[y.fontUUid].name,f.style=r[y.fontUUid].style,f.weight=r[y.fontUUid].weight,f.width=r[y.fontUUid].width,m=this.viewer.SDFMaker.IsShxFont(f.name),v=y.strText,g=y.nShapeId,0<y.nShapeId&&(2<this.viewer.modelContentVersion?(v=String.fromCharCode(y.nShapeId),g=-1):v=y.nShapeId.toString()),(v={text:v,textFont:f,dash:u,rotation:y.fRotation,isShx:m,shapeId:g,offset:new THREE.Vector2}).offset.x=y.offset[0],v.offset.y=y.offset[1],d.textPattern.push(v),d.textOrPoint=!0)}}this.lineTypeStyle.push(c),this.uuidToLineStyle[e[n].strId]=d}},this.createTextGeometry=function(e,t,r){if(!(0<this.uuidToLineStyle[e].textGeomArray.length))for(var i=this.uuidToLineStyle[e].textPattern,n=0;n<i.length;n++){var a=i[n],o=a.textFont.size,s=(a.textFont.size=o*r,this.viewer.SDFMaker.ParseSDFTextGeometry(a,null,null,t,null,!1,!1,!1,0<a.shapeId,!0,this.viewer.modelContentVersion)),l=("unLoad"==s.textLoad&&(s.isTTF?(this.viewer.SDFMaker.SetLineStyleTtfTextGeometry(this.viewer.SDFMaker.ttfData,s,a,!1,this.viewer.modelContentVersion),s.textLoad="ttfLoad"):(this.viewer.SDFMaker.SetLineStyleShxTextGeometry(this.viewer.SDFMaker.ShxData,s,a,0<a.shapeId,this.viewer.modelContentVersion),s.textLoad="shxLoad")),s.characterWidthHeight&&(l=this.viewer.ndsModel.getMeshManager().lineTypeUuid2ParamsMap)&&l.set(e,{characterWidthHeight:s.characterWidthHeight,rectHeight:s.rectHeight,rectWidth:s.rectWidth,text:a.text,rectBearingX:s.rectBearingX,rectBearingY:s.rectBearingY,visible:!0}),a.textFont.size=o,s.computeBoundingBox(),{position:s.getAttribute("position"),index:s.getIndex(),color:t,drawRange:s.drawRange,translateX:s.boundingBox.max.x-s.boundingBox.min.x,translateY:(s.boundingBox.max.y-s.boundingBox.min.y)/this.viewer.SDFMaker.GetTextScale(null,a.textFont.name)});this.uuidToLineStyle[e].textGeomArray.push(l)}},this.setBackGroundColor=function(e){this.backColor=e},this.colorTest=function(e){return e?this.backColor&&this.backColor.equals(e)?new THREE.Color(16777215-e.getHex()):e:new THREE.Color},this.getLineTypeAlign=function(e,t,r,i){var n=Math.floor(r/t),a=e[0],o=e[0],s=1;return 1<i?(a=o=0,s=r/((n=1==(n=Math.floor(r/t+.5))&&2==e.length?2:n)*t)):0<a?o=(r-(t*n-a))/2:a<0?(o=(r-(t*n-a))/2)<0&&(o=2*a-o):o=-(r-(t*n-2*(o=(o=e[1])<0?-o:o)))/2,[n,o,a,s]},this.getLineStyleGeomInfoNew=function(M,e,E){var w=this,t=this.geomUUidToGeomInfo[M.uuid],x=this.lineTypeStyle[e],b=x.uuid,B=this.uuidToLineStyle[b],e={mesh:[],line:[],point:[]};if(!t&&B&&B.textOrPoint){var I=B.textPattern,T=B.pointPattern,S=B.pattern,R=(0<I.length&&this.createTextGeometry(b,new THREE.Color,1),M.getAttribute("position")),C=M.getAttribute("lineDistance");if(M.index){for(var D,P,H=0,_=0,L=1,O=new THREE.Vector3,F=new THREE.Vector3,U=new THREE.Vector3,N=new THREE.Vector3,V=new THREE.Vector3,G=new THREE.Vector3,k=new THREE.Vector3,j=new THREE.Vector3,z=new THREE.Vector3,W=[],X=[],q={data:[],index:[],length:0},Y={data:[],index:[],length:0},r=function(){D=M.index.getX(Q),P=M.index.getX(Q+1),O.fromBufferAttribute(R,D),F.fromBufferAttribute(R,P),U.subVectors(F,O),N.fromBufferAttribute(C,D),V.fromBufferAttribute(C,P);var e=N.y/E,t=(0===N.x&&(e=w.getLineTypeAlign(x.array,S,e,N.z),H=e[0],_=e[1],e[2],L=e[3]),0===_?0:Math.abs(x.array[0]));if(V.x<=0)return 0;if(0<T.length&&1e4<H||I.length&&1e3<H)return W.push(O.x,O.y,O.z,F.x,F.y,F.z),0;if(0<T.length)for(var r=0;r<T.length;r++){o=a=n=i=void 0;for(var i=T[r],n=X,a=0;a<H;a++){0===i&&(0===N.x&&n.push(O.x,O.y,O.z),V.x===V.y)&&n.push(F.x,F.y,F.z);var o=(i*L+a*S*L-t+Math.abs(_))*E;if(!(o<N.x+Math.abs(_))){if(o+Math.abs(_)>V.x)break;o=(o-N.x)/(V.x-N.x);G.copy(O),G.addScaledVector(U,o),n.push(G.x,G.y,G.z)}}}if(0<I.length){j.copy(U).normalize(),z.set(0,0,1),z.cross(j).normalize(),k.set(1,0,0);var s=k.angleTo(j),e=(k.cross(j).normalize(),0<=k.z?1:-1),l=s>Math.PI/2?(s-Math.PI)*e:s*e;k.set(0,0,1);for(var d=w.viewer.ndsModel.getMeshManager().lineTypeUuid2ParamsMap.get(b),c=[],h=0;h<I.length;h++){for(var u=I[h],p=B.textGeomArray[h].position,f=B.textGeomArray[h].index,m=B.textGeomArray[h].translateX,g=B.textGeomArray[h].translateY,v=B.textGeomArray[h].drawRange,y=0;y<H;y++){var A=(u.dash*L+y*S*L-t+Math.abs(_))*E;if(!(A<N.x)){if(A>V.x)break;A=(A-N.x)/(V.x-N.x),A=(G.copy(O),G.addScaledVector(U,A),s>Math.PI/2&&(G.addScaledVector(j,m*E),u.isShx||G.addScaledVector(z,g*E)),u.isShx&&u.shapeId<=0&&(z.y=Math.abs(z.y)),G.addScaledVector(j,u.offset.x*E),G.addScaledVector(z,u.offset.y*E),(130==u.shapeId||132==u.shapeId||133==u.shapeId)&&w.viewer.modelContentVersion<2&&G.addScaledVector(z,-z.y*g*.5),{x:G.x,y:G.y,z:G.z});c.push(A),u.isShx&&2<=w.viewer.modelContentVersion?w.addShxTextAttribute(Y,p,f,v,G,k,l+u.rotation,E):3<w.viewer.modelContentVersion?w.addMeshTextAttribute(q,p,f,v,G,k,l+u.rotation,E):w.addTextAttribute(q,p,f,v,G,k,l+u.rotation)}}d&&(d.vD=c)}}},Q=M.drawRange.start,i=M.drawRange.start+M.drawRange.count;Q<i;Q+=2)r();0<I.length&&(0<q.length&&(e.mesh=q.data,e.text=I[0].text,e.lineTypeId=b),0<Y.length)&&(e.line=Y.data),0<T.length&&(e.point=X),0<W.length&&(e.line=e.line.concat(W)),(0<(this.geomUUidToGeomInfo[M.uuid]=e).mesh.length||0<e.line.length)&&(this.geomUUidToLineInfo[M.uuid]={lineTypeID:b})}}return t||e},this.getLineStyleGeomInfo=function(e,t,r){var i=this.geomUUidToGeomInfo[e.uuid],n=this.lineTypeStyle[t].uuid,a=this.uuidToLineStyle[n],t={mesh:[],line:[],point:[]};if(!i&&a&&a.textOrPoint){var o=a.textPattern,s=a.pointPattern,l=a.pattern,d=(0<o.length&&this.createTextGeometry(n,new THREE.Color,r),e.getAttribute("position"));if(e.index){for(var c,h,u=new THREE.Vector3,p=new THREE.Vector3,f=new THREE.Vector3,m=new THREE.Vector3,g=new THREE.Vector3,v=(new THREE.Vector3,new THREE.Vector3),y=[],O=[],A={data:[],index:[],length:0},M={data:[],index:[],length:0},E=e.drawRange.start,F=e.drawRange.start+e.drawRange.count;E<F;E+=2){B=e.index.getX(E),c=e.index.getX(E+1),u.fromBufferAttribute(d,B),p.fromBufferAttribute(d,c),f.subVectors(p,u);var w=u.distanceTo(p);if(!(w<=0)){var x=Math.floor(w/(l*r))+1;if(0<s.length&&1e4<x||o.length&&1e3<x)console.log("lineStyle pattern repeat : ",x," use solid line"),y.push(u.x,u.y,u.z,p.x,p.y,p.z);else{h=f.clone().normalize(),v.set(0,0,1),v.cross(h).normalize(),g.set(1,0,0);var b=g.angleTo(h),B=(g.cross(h).normalize(),0<=g.z?1:-1),I=b>Math.PI/2?(b-Math.PI)*B:b*B;g.set(0,0,1);for(var T=0;T<s.length;T++)for(var S=0;S<x;S++){var U=(s[T]+S*l)*r/w;if(.999<=U)break;(m=u.clone()).addScaledVector(f,U),O.push(m.x,m.y,m.z)}for(var N=this.viewer.ndsModel.getMeshManager().lineTypeUuid2ParamsMap.get(n),V=[],R=0;R<o.length;R++){for(var C=o[R],D=a.textGeomArray[R].position,P=a.textGeomArray[R].index,G=a.textGeomArray[R].translateX,k=a.textGeomArray[R].translateY,H=a.textGeomArray[R].drawRange,_=0;_<x;_++){var L=(C.dash+_*l)*r/w;if(.999<=L)break;(m=u.clone()).addScaledVector(f,L),b>Math.PI/2&&(m.addScaledVector(h,G),C.isShx||m.addScaledVector(v,k)),C.isShx&&C.shapeId<=0&&(v.y=Math.abs(v.y)),m.addScaledVector(h,C.offset.x),m.addScaledVector(v,C.offset.y),(130==C.shapeId||132==C.shapeId||133==C.shapeId)&&this.viewer.modelContentVersion<2&&m.addScaledVector(v,-v.y*k*.5);L={x:m.x,y:m.y,z:m.z};V.push(L),C.isShx&&2<=this.viewer.modelContentVersion?this.addShxTextAttribute(M,D,P,H,m,g,I+C.rotation):3<this.viewer.modelContentVersion?this.addMeshTextAttribute(A,D,P,H,m,g,I+C.rotation):this.addTextAttribute(A,D,P,H,m,g,I+C.rotation)}N.vD=V}}}}0<o.length&&(0<A.length&&(t.mesh=A.data,t.text=o[0].text,t.lineTypeId=n),0<M.length)&&(t.line=M.data),0<s.length&&(t.point=O),0<y.length&&(t.line=t.line.concat(y)),this.geomUUidToGeomInfo[e.uuid]=t}}return i||t},this.getLineStyleInfo=function(e,t,r,i,n,a){if(!(this.viewer.SDFMaker.needShxLoad&&!this.viewer.SDFMaker.ShxData&&2<=this.viewer.modelContentVersion)){var o,s,l,d,c=this.geomUUidToLineInfo[e.uuid],h=this.uuidToLineStyle[t];if(!c&&h&&h.textOrPoint){var u=h.textPattern,p=h.pointPattern,f=h.pattern,O=(0<u.length&&this.createTextGeometry(t,i,r),e.getAttribute("position"));if(e.index){for(var F,m,g=new THREE.Vector3,v=new THREE.Vector3,y=new THREE.Vector3,A=new THREE.Vector3,M=new THREE.Vector3,E=(new THREE.Vector3,new THREE.Vector3),w=[],U=[],x={data:[],index:[],length:0},b={data:[],index:[],length:0},B=e.drawRange.start,N=e.drawRange.start+e.drawRange.count;B<N;B+=2){R=e.index.getX(B),F=e.index.getX(B+1),g.fromBufferAttribute(O,R),v.fromBufferAttribute(O,F),y.subVectors(v,g);var I=g.distanceTo(v);if(!(I<=0)){var T=Math.floor(I/(f*r))+1;if(0<p.length&&1e4<T||u.length&&1e3<T)console.log("lineStyle pattern repeat : ",T," use solid line"),w.push(g.x,g.y,g.z,v.x,v.y,v.z);else{m=y.clone().normalize(),E.set(0,0,1),E.cross(m).normalize(),M.set(1,0,0);var S=M.angleTo(m),R=(M.cross(m).normalize(),0<=M.z?1:-1),C=S>Math.PI/2?(S-Math.PI)*R:S*R;M.set(0,0,1);for(var D=0;D<p.length;D++)for(var P=0;P<T;P++){var V=(p[D]+P*f)*r/I;if(.999<=V)break;(A=g.clone()).addScaledVector(y,V),U.push(A.x,A.y,A.z)}for(var H=0;H<u.length;H++){for(var _=u[H],G=h.textGeomArray[H].position,k=h.textGeomArray[H].index,j=h.textGeomArray[H].translateX,z=h.textGeomArray[H].translateY,W=h.textGeomArray[H].drawRange,X=this.viewer.ndsModel.getMeshManager().lineTypeUuid2ParamsMap.get(t),q=[],Y=0;Y<T;Y++){var L=(_.dash+Y*f)*r/I;if(.999<=L)break;(A=g.clone()).addScaledVector(y,L),S>Math.PI/2&&(A.addScaledVector(m,j),_.isShx||A.addScaledVector(E,z)),_.isShx&&_.shapeId<=0&&(E.y=Math.abs(E.y)),A.addScaledVector(m,_.offset.x),A.addScaledVector(E,_.offset.y),(130==_.shapeId||132==_.shapeId||133==_.shapeId)&&this.viewer.modelContentVersion<2&&A.addScaledVector(E,-E.y*z*.5);L={x:A.x,y:A.y,z:A.z};q.push(L),_.isShx&&2<=this.viewer.modelContentVersion?this.addShxTextAttribute(b,G,k,W,A,M,C+_.rotation):3<this.viewer.modelContentVersion?this.addMeshTextAttribute(x,G,k,W,A,M,C+_.rotation):this.addTextAttribute(x,G,k,W,A,M,C+_.rotation)}X.vD=q}}}}this.geomUUidToLineInfo[e.uuid]={lineTypeID:t,textGeom:null,textIsShx:!1,pointGeom:null,lineGeom:null,color:i,linewidth:n},0<u.length&&(0<x.length&&(3<this.viewer.modelContentVersion?this.createMeshTextGeom(e.uuid,x,u[0].text,t):this.createTextGeom(e.uuid,x,u[0].text,t)),0<b.length)&&this.createShxTextGeom(e.uuid,b),0<p.length&&this.createPointGeom(e.uuid,U),0<w.length&&this.createLineGeom(e.uuid,w)}}return c?(i=this.getTextMaterial(),n=this.getShxTextMaterial(),o=this.getPointMaterial(),s=this.getLineMaterial(),i&&(i.uniforms.diffuse.value.copy(this.colorTest(a?De.selectedColor:c.color)),i.uniformsNeedUpdate=!0),n&&(n.uniforms.diffuse.value.copy(this.colorTest(a?De.selectedColor:c.color)),n.uniformsNeedUpdate=!0,1<c.linewidth?n.linewidthCopy=c.linewidth:delete n.linewidthCopy),o&&(o.uniforms.diffuse.value.copy(this.colorTest(a?De.selectedColor:c.color)),o.uniforms.linewidth.value=this.viewer.showLineWidth&&1.5<c.linewidth?c.linewidth*this.viewer.renderer.getPixelRatio():1.5,o.uniformsNeedUpdate=!0),s&&(s.uniforms.diffuse.value.copy(this.colorTest(a?De.selectedColor:c.color)),s.uniformsNeedUpdate=!0),d=l=a=null,c.textGeom&&(c.textIsShx?((a=this.shxMesh).geometry=c.textGeom,a.material=n,a.isShx=!0):((a=this.ttfMesh).geometry=c.textGeom,a.material=i,a.isShx=!1)),c.pointGeom&&((l=this.pointMesh).geometry=c.pointGeom,l.material=o),c.lineGeom&&((d=this.lineMesh).geometry=c.lineGeom,d.material=s),{textMesh:a,pointMesh:l,lineMesh:d}):null}},this.getLineStyleInfoForPDF=function(e,t,r,i){if(this.viewer.is2DModel&&!(this.viewer.SDFMaker.needShxLoad&&!this.viewer.SDFMaker.ShxData&&2<=this.viewer.modelContentVersion)){var n=this.uuidToLineStyle[t];if(n&&n.textOrPoint){var a=n.textPattern,o=n.pointPattern,s=n.pattern,l=(0<a.length&&this.createTextGeometry(t,i,r),e.getAttribute("position"));if(e.index){for(var d,c,h=new THREE.Vector3,u=new THREE.Vector3,p=new THREE.Vector3,f=new THREE.Vector3,m=new THREE.Vector3,g=(new THREE.Vector3,new THREE.Vector3),v={},y=[],A=[],M=e.drawRange.start,E=e.drawRange.start+e.drawRange.count;M<E;M+=2){B=e.index.getX(M),d=e.index.getX(M+1),h.fromBufferAttribute(l,B),u.fromBufferAttribute(l,d),p.subVectors(u,h);var w=h.distanceTo(u);if(!(w<=0)){var x=Math.floor(w/(s*r))+1;if(0<o.length&&1e4<x||a.length&&1e3<x)console.log("lineStyle pattern repeat : ",x," use solid line"),A.push(h.x,h.y,h.z,u.x,u.y,u.z);else{c=p.clone().normalize(),g.set(0,0,1),g.cross(c).normalize(),m.set(1,0,0);var b=m.angleTo(c),B=(m.cross(c).normalize(),0<=m.z?1:-1),I=b>Math.PI/2?(b-Math.PI)*B:b*B;m.set(0,0,1);for(var T=0;T<o.length;T++)for(var S=0;S<x;S++){var R=(o[T]+S*s)*r/w;if(.999<=R)break;(f=h.clone()).addScaledVector(p,R),y.push(f.x,f.y,f.z)}for(var C=0;C<a.length;C++){var D=a[C],P=n.textGeomArray[C].translateX,O=n.textGeomArray[C].translateY,H=v[D.text];H||(H={fontName:D.textFont.name,isShx:D.isShx,shapeId:D.shapeId,size:D.textFont.size,data:new Array},v[D.text]=H);for(var _=0;_<x;_++){var L=(D.dash+_*s)*r/w;if(.999<=L)break;(f=h.clone()).addScaledVector(p,L),b>Math.PI/2&&(f.addScaledVector(c,P),D.isShx||f.addScaledVector(g,O)),D.isShx&&0==D.shapeId&&(g.y=Math.abs(g.y)),f.addScaledVector(c,D.offset.x),f.addScaledVector(g,D.offset.y),H.data.push(f.x,f.y,I+D.rotation)}}}}}return{styleText:v,stylePoint:y,styleLine:A}}}return{styleText:null,stylePoint:null,styleLine:null}}},this.addTextAttribute=function(e,t,r,i,n,a,o){for(var s=new THREE.Vector3,l=i.start,d=Math.min(i.count,r.count),c=r.array[l],h=c,u=l;u<l+d;++u)c=c>r.array[u]?r.array[u]:c,h=h>r.array[u]?h:r.array[u];for(var p=c;p<=h;p++)s.fromArray(t.array,6*p),s.applyAxisAngle(a,o),s.add(n),e.data.push(s.x),e.data.push(s.y),e.data.push(s.z),e.data.push(t.array[6*p+3]),e.data.push(t.array[6*p+4]),e.data.push(t.array[6*p+5]);for(var f=l;f<l+d;++f)e.index.push(r.array[f]-c+e.length);e.length+=h-c+1},this.addMeshTextAttribute=function(e,t,r,i,n,a,o,s){for(var l=new THREE.Vector3,d=i.start,c=Math.min(i.count,r.count),h=r.array[d],u=h,p=d;p<d+c;++p)h=h>r.array[p]?r.array[p]:h,u=u>r.array[p]?u:r.array[p];for(var f=h;f<=u;f++)l.fromArray(t.array,3*f),l.multiplyScalar(s),l.applyAxisAngle(a,o),l.add(n),e.data.push(l.x),e.data.push(l.y),e.data.push(l.z);for(var m=d;m<d+c;++m)e.index.push(r.array[m]-h+e.length);e.length+=u-h+1},this.addShxTextAttribute=function(e,t,r,i,n,a,o,s){if(t){for(var l=new THREE.Vector3,d=i.start,c=Math.min(i.count,r.count),h=r.array[d],u=h,p=d;p<d+c;++p)h=h>r.array[p]?r.array[p]:h,u=u>r.array[p]?u:r.array[p];for(var f=h;f<=u;++f)l.fromArray(t.array,3*f),l.multiplyScalar(s),l.applyAxisAngle(a,o),l.add(n),e.data.push(l.x),e.data.push(l.y),e.data.push(l.z);for(var m=d;m<d+c;++m)e.index.push(r.array[m]-h+e.length);e.length+=u-h+1}},this.createTextGeom=function(e,t,r,i){var n=new THREE.BufferGeometry,a=new Float32Array(t.data),a=new THREE.InterleavedBuffer(a,6),o=new THREE.InterleavedBufferAttribute(a,3,0,!1),s=new THREE.InterleavedBufferAttribute(a,2,3,!1),a=new THREE.InterleavedBufferAttribute(a,1,5,!1);n.addAttribute("position",o),n.addAttribute("uv",s),n.addAttribute("textureid",a),n.setIndex(t.index),n.name="ttf",n.drawRange.start=0,n.drawRange.count=t.index.length,n.needsUpdate=!0,n.text=r,n.lineTypeId=i,this.geomUUidToLineInfo[e].textGeom=n,this.geomUUidToLineInfo[e].textIsShx=!1},this.createMeshTextGeom=function(e,t,r,i){for(var n=new THREE.BufferGeometry,a=new Float32Array(t.data),a=new THREE.InterleavedBuffer(a,3),a=new THREE.InterleavedBufferAttribute(a,3,0,!1),o=(n.addAttribute("position",a),n.setIndex(t.index),n.name="ttf",n.drawRange.start=0,n.drawRange.count=t.index.length,n.needsUpdate=!0,n.text=r,n.lineTypeId=i,this.geomUUidToLineInfo[e].textGeom=n,this.geomUUidToLineInfo[e].textIsShx=!1,[2*t.index.length]),s=0,l=t.index.length;s<l;s+=3)o[2*s]=t.index[s],o[2*s+1]=t.index[s+1],o[2*s+2]=t.index[s+1],o[2*s+3]=t.index[s+2],o[2*s+4]=t.index[s+2],o[2*s+5]=t.index[s];r=new THREE.BufferGeometry;r.addAttribute("position",a),r.setIndex(o),r.name="meshTtf wireframe",r.isTtfWire=!0,r.needsUpdate=!0,this.geomUUidToLineInfo[e].lineGeom=r},this.createShxTextGeom=function(e,t){var r=new THREE.BufferGeometry,i=new Float32Array(t.data),i=new THREE.InterleavedBuffer(i,3),i=new THREE.InterleavedBufferAttribute(i,3,0,!1);r.addAttribute("position",i),r.setIndex(t.index),r.name="shx",r.drawRange.start=0,r.drawRange.count=t.index.length,r.needsUpdate=!0,this.geomUUidToLineInfo[e].textGeom=r,this.geomUUidToLineInfo[e].textIsShx=!0},this.createPointGeom=function(e,t){for(var r=[],i=0;i<t.length/3;i++)r.push(i);var n=new THREE.BufferGeometry,a=new Float32Array(t),a=new THREE.InterleavedBuffer(a,3),a=new THREE.InterleavedBufferAttribute(a,3,0,!1);n.addAttribute("position",a),n.setIndex(r),n.drawRange.start=0,n.drawRange.count=r.length,n.name="point",n.needsUpdate=!0,this.geomUUidToLineInfo[e].pointGeom=n},this.createLineGeom=function(e,t){for(var r=[],i=0;i<t.length/3;i++)r.push(i);var n=new THREE.BufferGeometry,a=new Float32Array(t),a=new THREE.InterleavedBuffer(a,3),a=new THREE.InterleavedBufferAttribute(a,3,0,!1);n.addAttribute("position",a),n.setIndex(r),n.drawRange.start=0,n.drawRange.count=r.length,n.name="line",n.needsUpdate=!0,this.geomUUidToLineInfo[e].lineGeom=n},this.getMaterial=function(e){var e=this.uuidToLineStyle[e],t=null,r=1,e=(e?(t=new THREE.DataTexture(e.textureArray,1024,1,THREE.RGBAFormat),r=e.pattern):(t=new THREE.DataTexture(new Uint8Array(4096),1024,1,THREE.RGBAFormat),console.log("lineType map failded")),t.needsUpdate=!0,new THREE.ShaderMaterial({uniforms:{lineScale:{value:1},lineTypeId:{value:e.index},uSampler:{value:t},patternLength:{value:r},opacity:{value:.8},diffuse:{value:new THREE.Color(16711680)}},linewidth:1,transparent:!0,fragmentShader:["uniform vec3 diffuse;","uniform float opacity;","uniform float patternLength;","uniform float lineScale;","uniform sampler2D uSampler;","varying float vLineDistance;","void main() {","float newDistance = vLineDistance/lineScale;","float modSize = mod( newDistance, patternLength);","vec3 value = texture2D(uSampler,vec2(modSize/patternLength,0.0)).rgb;","if(value.r > 0.9){","discard;","}","vec3 outgoingLight = vec3( 0.0 );","vec4 diffuseColor = vec4( diffuse, opacity );","outgoingLight = diffuseColor.rgb;","gl_FragColor = vec4(outgoingLight, diffuseColor.a );","}"].join("\n"),vertexShader:["attribute float lineDistance;","varying float vLineDistance;","void main() {","vLineDistance =  lineDistance;","#ifdef USE_MODELMATRIXATTRIB\n\tmat4 ndsModelViewMatrix = viewMatrix * modelMatrixAttrib;\n\tgl_Position = projectionMatrix * ndsModelViewMatrix * vec4( position, 1.0 );\n#else\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n#endif\n","}"].join("\n")}));return this.lineMaterials.push(e),e},this.getTextMaterial=function(){return this.viewer.SDFMaker.GetLineStyleMaterial(this.viewer.modelContentVersion)},this.getShxTextMaterial=function(){return 2<=this.viewer.modelContentVersion?this.viewer.SDFMaker.GetMaterial(de.SHX):this.getTextMaterial()},this.getPointMaterial=function(){return this.pointMaterial||(this.pointMaterial=new THREE.ShaderMaterial({uniforms:{diffuse:{value:new THREE.Color(16711680)},linewidth:{value:1}},vertexShader:["uniform float linewidth;","void main() { ","gl_PointSize = linewidth;","#ifdef USE_MODELMATRIXATTRIB\n\tmat4 ndsModelViewMatrix = viewMatrix * modelMatrixAttrib;\n\tgl_Position = projectionMatrix * ndsModelViewMatrix * vec4( position, 1.0 );\n#else\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n#endif\n","}"].join("\n"),fragmentShader:["#ifdef GL_ES","precision mediump float;","#endif","uniform vec3 diffuse;","void main(void) {","gl_FragColor = vec4(diffuse, 1.0);","}"].join("\n")}),0==De.enableTextRenderingBothSide?this.pointMaterial.side=THREE.DoubleSide:this.pointMaterial.side=THREE.FrontSide),this.pointMaterial},this.getLineMaterial=function(){return this.lineMaterial||(this.lineMaterial=new THREE.ShaderMaterial({uniforms:{diffuse:{value:new THREE.Color(16711680)}},vertexShader:["void main() { ","#ifdef USE_MODELMATRIXATTRIB\n\tmat4 ndsModelViewMatrix = viewMatrix * modelMatrixAttrib;\n\tgl_Position = projectionMatrix * ndsModelViewMatrix * vec4( position, 1.0 );\n#else\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n#endif\n","}"].join("\n"),fragmentShader:["#ifdef GL_ES","precision mediump float;","#endif","uniform vec3 diffuse;","void main(void) {","gl_FragColor = vec4(diffuse, 1.0);","}"].join("\n")})),this.lineMaterial},this.getLineStyleArray=function(e){return this.uuidToLineStyle[e].linePattern},this.clearLineType=function(){for(var e=0;e<this.lineMaterials.length;e++)this.lineMaterials[e].dispose();this.lineMaterials=[]}});Ce.DASHTYPE={SOLID:0,DASH:1,DASHSPACE:2,LONGDASH_DOT:3,LONGDASH_DOUBLEDOT:4,LONGDASH_TRIPLEDOT:5,DOT0:6,LONGDASH_SHORTDASH:7,LONGDASH_DOUBLESHORTDASH:8,DASH_DOT:9,DOUBLEDASH_DOT:10,DASH_DOUBLEDOT:11,DOUBLEDASH_DOUBLEDOT:12,DASH_TRIPLEDOT:13,DOUBLEDASH_TRIPLEDOT:14,BATTING:15,BORDER:16,BORDER2:17,BORDERX2:18,CENTER:19,CENTER2:20,CENTERX2:21,DASHDOT:22,DASHDOT2:23,DASHDOTX2:24,DASHED:25,DASHED2:26,DASHEDX2:27,DIVIDE:28,DIVIDE2:29,DIVIDEX2:30,DOT:31,DOT2:32,DOTX2:33,FENCELINE1:34,FENCELINE2:35,GAS_LINE:36,HIDDEN:37,HIDDEN2:38,HIDDENX2:39,HOT_WATER_SUPPLY:40,JIS_02_07:41,JIS_02_10:42,JIS_02_12:43,JIS_02_20:44,JIS_02_40:45,JIS_08_11:46,JIS_08_15:47,JIS_08_25:48,JIS_08_37:49,JIS_08_50:50,JIS_09_08:51,JIS_09_15:52,JIS_09_29:53,JIS_09_50:54,PHANTOM:55,PHANTOM2:56,PHANTOMX2:57,TRACKS:58,ZIGZAG:59,CUSTOM:999};function gt(){gt=function(){return o};var l,o={},e=Object.prototype,d=e.hasOwnProperty,c=Object.defineProperty||function(e,t,r){e[t]=r.value},t="function"==typeof Symbol?Symbol:{},i=t.iterator||"@@iterator",r=t.asyncIterator||"@@asyncIterator",n=t.toStringTag||"@@toStringTag";function a(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{a({},"")}catch(l){a=function(e,t,r){return e[t]=r}}function s(e,t,r,i){var n,a,o,s,t=t&&t.prototype instanceof v?t:v,t=Object.create(t.prototype),i=new I(i||[]);return c(t,"_invoke",{value:(n=e,a=r,o=i,s=u,function(e,t){if(s===f)throw Error("Generator is already running");if(s===m){if("throw"===e)throw t;return{value:l,done:!0}}for(o.method=e,o.arg=t;;){var r=o.delegate;if(r){r=function e(t,r){var i=r.method,n=t.iterator[i];if(n===l)return r.delegate=null,"throw"===i&&t.iterator.return&&(r.method="return",r.arg=l,e(t,r),"throw"===r.method)||"return"!==i&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+i+"' method")),g;i=h(n,t.iterator,r.arg);if("throw"===i.type)return r.method="throw",r.arg=i.arg,r.delegate=null,g;n=i.arg;return n?n.done?(r[t.resultName]=n.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=l),r.delegate=null,g):n:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,g)}(r,o);if(r){if(r===g)continue;return r}}if("next"===o.method)o.sent=o._sent=o.arg;else if("throw"===o.method){if(s===u)throw s=m,o.arg;o.dispatchException(o.arg)}else"return"===o.method&&o.abrupt("return",o.arg);s=f;r=h(n,a,o);if("normal"===r.type){if(s=o.done?m:p,r.arg===g)continue;return{value:r.arg,done:o.done}}"throw"===r.type&&(s=m,o.method="throw",o.arg=r.arg)}})}),t}function h(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}o.wrap=s;var u="suspendedStart",p="suspendedYield",f="executing",m="completed",g={};function v(){}function y(){}function A(){}var t={},M=(a(t,i,function(){return this}),Object.getPrototypeOf),M=M&&M(M(T([]))),E=(M&&M!==e&&d.call(M,i)&&(t=M),A.prototype=v.prototype=Object.create(t));function w(e){["next","throw","return"].forEach(function(t){a(e,t,function(e){return this._invoke(t,e)})})}function x(o,s){var t;c(this,"_invoke",{value:function(r,i){function e(){return new s(function(e,t){!function t(e,r,i,n){var a,e=h(o[e],o,r);if("throw"!==e.type)return(r=(a=e.arg).value)&&"object"==typeof r&&d.call(r,"__await")?s.resolve(r.__await).then(function(e){t("next",e,i,n)},function(e){t("throw",e,i,n)}):s.resolve(r).then(function(e){a.value=e,i(a)},function(e){return t("throw",e,i,n)});n(e.arg)}(r,i,e,t)})}return t=t?t.then(e,e):e()}})}function b(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function B(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function I(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(b,this),this.reset(!0)}function T(t){if(t||""===t){var r,e=t[i];if(e)return e.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length))return r=-1,(e=function e(){for(;++r<t.length;)if(d.call(t,r))return e.value=t[r],e.done=!1,e;return e.value=l,e.done=!0,e}).next=e}throw new TypeError(typeof t+" is not iterable")}return c(E,"constructor",{value:y.prototype=A,configurable:!0}),c(A,"constructor",{value:y,configurable:!0}),y.displayName=a(A,n,"GeneratorFunction"),o.isGeneratorFunction=function(e){e="function"==typeof e&&e.constructor;return!!e&&(e===y||"GeneratorFunction"===(e.displayName||e.name))},o.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,A):(e.__proto__=A,a(e,n,"GeneratorFunction")),e.prototype=Object.create(E),e},o.awrap=function(e){return{__await:e}},w(x.prototype),a(x.prototype,r,function(){return this}),o.AsyncIterator=x,o.async=function(e,t,r,i,n){void 0===n&&(n=Promise);var a=new x(s(e,t,r,i),n);return o.isGeneratorFunction(t)?a:a.next().then(function(e){return e.done?e.value:a.next()})},w(E),a(E,n,"Generator"),a(E,i,function(){return this}),a(E,"toString",function(){return"[object Generator]"}),o.keys=function(e){var t,r=Object(e),i=[];for(t in r)i.push(t);return i.reverse(),function e(){for(;i.length;){var t=i.pop();if(t in r)return e.value=t,e.done=!1,e}return e.done=!0,e}},o.values=T,I.prototype={constructor:I,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=l,this.done=!1,this.delegate=null,this.method="next",this.arg=l,this.tryEntries.forEach(B),!e)for(var t in this)"t"===t.charAt(0)&&d.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=l)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(r){if(this.done)throw r;var i=this;function e(e,t){return a.type="throw",a.arg=r,i.next=e,t&&(i.method="next",i.arg=l),!!t}for(var t=this.tryEntries.length-1;0<=t;--t){var n=this.tryEntries[t],a=n.completion;if("root"===n.tryLoc)return e("end");if(n.tryLoc<=this.prev){var o=d.call(n,"catchLoc"),s=d.call(n,"finallyLoc");if(o&&s){if(this.prev<n.catchLoc)return e(n.catchLoc,!0);if(this.prev<n.finallyLoc)return e(n.finallyLoc)}else if(o){if(this.prev<n.catchLoc)return e(n.catchLoc,!0)}else{if(!s)throw Error("try statement without catch or finally");if(this.prev<n.finallyLoc)return e(n.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;0<=r;--r){var i=this.tryEntries[r];if(i.tryLoc<=this.prev&&d.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var n=i;break}}var a=(n=n&&("break"===e||"continue"===e)&&n.tryLoc<=t&&t<=n.finallyLoc?null:n)?n.completion:{};return a.type=e,a.arg=t,n?(this.method="next",this.next=n.finallyLoc,g):this.complete(a)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),g},finish:function(e){for(var t=this.tryEntries.length-1;0<=t;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),B(r),g}},catch:function(e){for(var t=this.tryEntries.length-1;0<=t;--t){var r,i,n=this.tryEntries[t];if(n.tryLoc===e)return"throw"===(r=n.completion).type&&(i=r.arg,B(n)),i}throw Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:T(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=l),g}},o}function vt(e,t,r,i,n,a,o){try{var s=e[a](o),l=s.value}catch(e){return r(e)}s.done?t(l):Promise.resolve(l).then(i,n)}ut.prototype={constructor:ut,crossOrigin:void 0,addStatusElement:function(){var e=document.createElement("div");return e.style.position="absolute",e.style.right="0px",e.style.top="0px",e.style.fontSize="0.8em",e.style.textAlign="left",e.style.background="rgba(0,0,0,0.25)",e.style.color="#fff",e.style.width="120px",e.style.padding="0.5em 0.5em 0.5em 0.5em",e.style.zIndex=1e3,e.innerHTML="Loading ...",e},updateProgress:function(e){var t="Loaded ";e.total?t+=(100*e.loaded/e.total).toFixed(0)+"%":t+=(e.loaded/1024).toFixed(2)+" KB",this.statusDomElement.innerHTML=t},extractUrlBase:function(e){e=e.split("/");return 1===e.length?"./":(e.pop(),e.join("/")+"/")},loadTexture:function(t,e,r,i,n,a){var o,s,l,d;return void 0!==e[r]?e[r]:(o=null,s=r,De.avoidCaching&&(s=r+"?time="+Date.now()),De.singleHTML&&this.viewer.ZIPData?(l=new THREE.Texture,(d=this).viewer.ZIPData.file(r)&&this.viewer.ZIPData.file(r).async("blob").then(function(e){(o=new THREE.ImageLoader(Ce.TextureLoadingManager)).crossOrigin=d.crossOrigin,o.crossOrigin="anonymous",o.load(window.URL.createObjectURL(e),function(e){l.image=e,l.needsUpdate=!0,n&&n(l)},void 0,function(){t.map=null,t.needsUpdate=!0,a&&a()})})):null!==o?l=o.load(s,n):-1<r.toLowerCase().indexOf(".tga")?((o=new ht).crossOrigin=this.crossOrigin,Ce.TextureLoadingManager.itemStart(),l=o.load(s,function(e){e.flipY=!0,e.needsUpdate=!0,n&&n(e),Ce.TextureLoadingManager.itemEnd()},void 0,function(){t.map=null,t.needsUpdate=!0,a&&a()})):(l=new THREE.Texture,(o=new THREE.ImageLoader(Ce.TextureLoadingManager)).crossOrigin=this.crossOrigin,o.crossOrigin="anonymous",o.load(s,function(e){l.image=e,l.needsUpdate=!0,n&&n(l)},void 0,function(){t.map=null,t.needsUpdate=!0,a&&a()})),void 0!==i&&(l.mapping=i),e[r]=l)},getTrueTexName:function(e){var t=e;if(this.viewer.trueMapList)for(var r in this.viewer.trueMapList)if(e.toLowerCase()===this.viewer.trueMapList[r].toLowerCase()){t=this.viewer.trueMapList[r];break}return t},getFullTextPath:function(e,t){return-1<t.indexOf(e)||-1<t.indexOf("/")?t:e+this.getTrueTexName(t)},createMaterialForBIM:function(e,t,r,i,n,a){var o,s,l,d,c={side:THREE.FrontSide};function h(e){return 1<e?e:1}if(void 0!==t.name&&(c.name=t.name),void 0!==t.uuid&&(c.uuid=t.uuid),void 0!==t.type&&"LineBasicMaterial"===t.type&&(null==t.lineStyle&&null==t.lineTypeId||t.lineStyle==Ce.DASHTYPE.SOLID||t.lineStyle==Ce.DASHTYPE.CUSTOM&&null==t.lineTypeId))return void 0!==t.color&&(c.color=(new THREE.Color).setHex(parseInt(t.color))),void 0!==t.doubleSided&&t.doubleSided&&(c.side=THREE.DoubleSide),void 0!==t.opacity&&(d=parseFloat(t.opacity))<1&&(c.transparent=!0,c.opacity=d),void 0!==De.lineColor&&void 0!==c.color&&c.color.setHex(De.lineColor),a?(void 0!==t.linewidth&&(c.linewidth=1.2<parseFloat(t.linewidth)?parseFloat(t.linewidth):1.2),c.worldUnits=!1,c.dashed=!1,o=new qe(c),a=this.viewer.renderer.getPixelRatio(),s=this.viewer.renderer.domElement.width/a,a=this.viewer.renderer.domElement.height/a,o.resolution.set(s,a)):(void 0!==t.linewidth&&(c.linewidth=h(parseFloat(t.linewidth))),o=new THREE.LineBasicMaterial(c)),o;if(void 0!==t.type&&"LineBasicMaterial"===t.type&&(t.lineStyle==Ce.DASHTYPE.CUSTOM&&null!=t.lineTypeId||null==t.lineStyle&&null!=t.lineTypeId)&&this.ndsModel.lineTypes)l=this.ndsModel.lineTypes.getMaterial(t.lineTypeId),void 0!==t.lineScale&&(l.uniforms.lineScale.value=parseFloat(t.lineScale)),void 0!==t.color&&l.uniforms.diffuse.value.setHex(parseInt(t.color)),void 0!==t.linewidth&&(l.linewidth=h(parseFloat(t.linewidth))),void 0!==t.opacity&&(d=parseFloat(t.opacity))<1&&(l.transparent=!0,l.uniforms.opacity.value=d),void 0!==De.lineColor&&void 0!==c.color&&l.uniforms.diffuse.value.setHex(De.lineColor);else{if(void 0===t.type||"LineBasicMaterial"!==t.type||null==t.lineStyle||t.lineStyle==Ce.DASHTYPE.SOLID)return void 0!==t.version&&"LineBasicMaterial"!=t.type?((s=this.parseJsonMaterial(t,c))&&(s.polygonOffset=!0,s.polygonOffsetFactor=1,s.polygonOffsetUnits=1),s):(l=null,"PointMaterial"==t.type&&(a=this.viewer.modelContentVersion,t.type=4<=a?"PointsMaterial":"MeshStandardMaterial"),"MeshStandardMaterial"==t.type&&(t.type="MeshPhongMaterial"),o="","MeshBasicMaterial"==t.type&&(l=new THREE.MeshBasicMaterial,void 0!==t.color&&(c.color=(new THREE.Color).setHex(parseInt(t.color))),void 0!==t.doubleSided&&t.doubleSided&&(c.side=THREE.DoubleSide),void 0!==t.opacity&&(d=parseFloat(t.opacity))<1&&(c.transparent=!0,c.opacity=d),void 0!==t.map&&null!==t.map&&this.viewer.is2DModel&&(o=this.getFullTextPath(r,t.map),c.map=this.loadTexture(l,e,o,void 0,void 0,Ce.TextureLoadingManager.onError),c.map.sourceFile=o,c.map.wrapS=THREE.RepeatWrapping,c.map.wrapT=THREE.RepeatWrapping),l.hatchId=-1,n.has(t.hatchType)&&(s=n.get(t.hatchType),l.hatchId=s.hatchId),l.setValues(c)),void 0===t.type||"MeshPhongMaterial"===t.type?(l=new THREE.MeshPhongMaterial,void 0!==t.color&&(c.color=(new THREE.Color).setHex(parseInt(t.color))),void 0!==t.wireframe&&(c.wireframe=t.wireframe),void 0!==t.emissive&&(c.emissive=(new THREE.Color).setHex(parseInt(t.emissive))),void 0!==t.specular&&(c.specular=(new THREE.Color).setHex(parseInt(t.specular))),void 0!==t.shininess&&(c.shininess=parseInt(t.shininess)),void 0!==t.doubleSided&&t.doubleSided&&(c.side=THREE.DoubleSide),void 0!==t.opacity&&(d=parseFloat(t.opacity))<1&&(c.transparent=!0,c.opacity=d),void 0!==t.mapDiffuse&&null!==t.mapDiffuse&&(o=this.getFullTextPath(r,t.mapDiffuse),c.map=this.loadTexture(l,e,o,void 0,void 0,Ce.TextureLoadingManager.onError),c.map.sourceFile=o,c.map.wrapS=THREE.RepeatWrapping,c.map.wrapT=THREE.RepeatWrapping),void 0!==t.map&&null!==t.map&&(o=this.getFullTextPath(r,t.map),c.map=this.loadTexture(l,e,o,void 0,void 0,Ce.TextureLoadingManager.onError),c.map.sourceFile=o,c.map.wrapS=THREE.RepeatWrapping,c.map.wrapT=THREE.RepeatWrapping),void 0!==t.mapBump&&null!==t.mapBump&&(o=this.getFullTextPath(r,t.mapBump),c.bumpMap=this.loadTexture(l,e,o,void 0,void 0,Ce.TextureLoadingManager.onError),c.bumpMap.sourceFile=o,c.bumpMap.wrapS=THREE.RepeatWrapping,c.bumpMap.wrapT=THREE.RepeatWrapping),void 0!==t.bumpMap&&null!==t.bumpMap&&(o=this.getFullTextPath(r,t.bumpMap),c.bumpMap=this.loadTexture(l,e,o,void 0,void 0,Ce.TextureLoadingManager.onError),c.bumpMap.sourceFile=o,c.bumpMap.wrapS=THREE.RepeatWrapping,c.bumpMap.wrapT=THREE.RepeatWrapping),void 0!==t.bumpScale&&(c.bumpScale=parseFloat(t.bumpScale)),void 0!==t.reflectivity&&(c.reflectivity=parseFloat(t.reflectivity)),void 0!==t.refractionRatio&&(c.refractionRatio=parseFloat(t.refractionRatio)),void 0!==t.emissiveIntensity&&(c.emissiveIntensity=parseFloat(t.emissiveIntensity)),void 0!==t.shading&&(0==t.shading||2==parseInt(t.shading)?c.flatShading=!1:c.flatShading=!0),l.setValues(c)):"MeshStandardMaterial"===t.type?(l=new THREE.MeshStandardMaterial,void 0!==t.color&&(c.color=(new THREE.Color).setHex(parseInt(t.color))),void 0!==t.wireframe&&(c.wireframe=t.wireframe),void 0!==t.emissive&&(c.emissive=(new THREE.Color).setHex(parseInt(t.emissive))),void 0!==t.doubleSided&&t.doubleSided&&(c.side=THREE.DoubleSide),void 0!==t.opacity&&(d=parseFloat(t.opacity))<1&&(c.transparent=!0,c.opacity=d),void 0!==t.mapDiffuse&&null!==t.mapDiffuse&&(o=this.getFullTextPath(r,t.mapDiffuse),c.map=this.loadTexture(l,e,o,void 0,void 0,Ce.TextureLoadingManager.onError),c.map.sourceFile=o,c.map.wrapS=THREE.RepeatWrapping,c.map.wrapT=THREE.RepeatWrapping),void 0!==t.map&&null!==t.map&&(o=this.getFullTextPath(r,t.map),c.map=this.loadTexture(l,e,o,void 0,void 0,Ce.TextureLoadingManager.onError),c.map.sourceFile=o,c.map.wrapS=THREE.RepeatWrapping,c.map.wrapT=THREE.RepeatWrapping),void 0!==t.mapBump&&null!==t.mapBump&&(o=this.getFullTextPath(r,t.mapBump),c.bumpMap=this.loadTexture(l,e,o,void 0,void 0,Ce.TextureLoadingManager.onError),c.bumpMap.sourceFile=o,c.bumpMap.wrapS=THREE.RepeatWrapping,c.bumpMap.wrapT=THREE.RepeatWrapping),void 0!==t.bumpMap&&null!==t.bumpMap&&(o=this.getFullTextPath(r,t.bumpMap),c.bumpMap=this.loadTexture(l,e,o,void 0,void 0,Ce.TextureLoadingManager.onError),c.bumpMap.sourceFile=o,c.bumpMap.wrapS=THREE.RepeatWrapping,c.bumpMap.wrapT=THREE.RepeatWrapping),void 0!==t.bumpScale&&(c.bumpScale=parseFloat(t.bumpScale)),void 0!==t.reflectivity&&(c.envMapIntensity=parseFloat(t.reflectivity)),void 0!==t.emissiveIntensity&&(c.emissiveIntensity=parseFloat(t.emissiveIntensity)),void 0!==t.envMapIntensity&&(c.envMapIntensity=parseFloat(t.envMapIntensity)),void 0!==t.refractionRatio&&(c.refractionRatio=parseFloat(t.refractionRatio)),void 0!==t.roughness&&(c.roughness=1,this.viewer.reflected)&&(c.roughness=.5),void 0!==t.metalness&&(c.metalness=.3,this.viewer.reflected)&&(c.metalness=.5),void 0===t.roughness&&void 0===t.metalness&&void 0!==t.shininess&&(0==t.shininess?(c.roughness=.8,c.metalness=.5):15<t.shininess&&(c.metalness=.65,c.roughness=.1)),void 0!==t.shading&&(0==t.shading||2==parseInt(t.shading)?c.flatShading=!1:c.flatShading=!0),l.setValues(c),l.polygonOffset=!0,l.polygonOffsetFactor=1,l.polygonOffsetUnits=1):"MeshPhysicalMaterial"==t.type?(this.viewer.hasPbrMaterial=!0,l=new THREE.MeshPhysicalMaterial,void 0!==t.color&&(c.color=(new THREE.Color).setHex(parseInt(t.color))),void 0!==t.wireframe&&(c.wireframe=t.wireframe),void 0!==t.emissive&&(c.emissive=(new THREE.Color).setHex(parseInt(t.emissive))),void 0!==t.specular&&(c.specularColor=(new THREE.Color).setHex(3158064)),void 0!==t.shininess&&(c.shininess=parseInt(t.shininess)),void 0!==t.doubleSided&&t.doubleSided&&(c.side=THREE.DoubleSide),void 0!==t.bumpScale&&(c.bumpScale=parseFloat(t.bumpScale)),void 0!==t.reflectivity&&(c.reflectivity=parseFloat(t.reflectivity)),void 0!==t.refractionRatio&&(c.refractionRatio=parseFloat(t.refractionRatio)),void 0!==t.emissiveIntensity&&(c.emissiveIntensity=parseFloat(t.emissiveIntensity)),void 0!==t.roughness&&(c.roughness=parseFloat(t.roughness)),void 0!==t.metalness&&(c.metalness=parseFloat(t.metalness)),void 0!==t.alphaTest&&(c.alphaTest=parseFloat(t.alphaTest)),void 0!==t.clearcoat&&(c.clearcoat=parseFloat(t.clearcoat)),void 0!==t.clearcoatRoughness&&(c.clearcoatRoughness=parseFloat(t.clearcoatRoughness)),void 0!==t.specularIntensity&&(c.specularIntensity=parseFloat(t.specularIntensity)),void 0!==t.ior&&(c.ior=parseFloat(t.ior)),void 0!==t.transmission&&Pe.isSupportCanvas2()&&(c.transmission=parseFloat(t.transmission)),void 0!==t.normalScale&&(a=parseFloat(t.normalScale),c.normalScale=new THREE.Vector2(a,a)),void 0!==t.opacity&&(n=parseFloat(t.opacity))<1&&(c.transparent=!0,c.opacity=n),void 0!==t.shading&&(0==t.shading||2==parseInt(t.shading)?c.flatShading=!1:c.flatShading=!0),void 0!==t.mapDiffuse&&null!==t.mapDiffuse&&(o=this.getFullTextPath(r,t.mapDiffuse),c.map=this.loadTexture(l,e,o,void 0,void 0,Ce.TextureLoadingManager.onError),c.map.sourceFile=o,c.map.wrapS=THREE.RepeatWrapping,c.map.wrapT=THREE.RepeatWrapping),void 0!==t.map&&null!==t.map&&(o=this.getFullTextPath(r,t.map),c.map=this.loadTexture(l,e,o,void 0,void 0,Ce.TextureLoadingManager.onError),c.map.sourceFile=o,c.map.wrapS=THREE.RepeatWrapping,c.map.wrapT=THREE.RepeatWrapping),void 0!==t.normalMap&&null!==t.normalMap&&(o=this.getFullTextPath(r,t.normalMap),c.normalMap=this.loadTexture(l,e,o,void 0,void 0,Ce.TextureLoadingManager.onError),c.normalMap.sourceFile=o,c.normalMap.wrapS=THREE.RepeatWrapping,c.normalMap.wrapT=THREE.RepeatWrapping),void 0!==t.emissiveMap&&null!==t.emissiveMap&&(o=this.getFullTextPath(r,t.emissiveMap),c.emissiveMap=this.loadTexture(l,e,o,void 0,void 0,Ce.TextureLoadingManager.onError),c.emissiveMap.sourceFile=o,c.emissiveMap.wrapS=THREE.RepeatWrapping,c.emissiveMap.wrapT=THREE.RepeatWrapping),void 0!==t.alphaMap&&null!==t.alphaMap&&(o=this.getFullTextPath(r,t.alphaMap),c.alphaMap=this.loadTexture(l,e,o,void 0,void 0,Ce.TextureLoadingManager.onError),c.alphaMap.sourceFile=o,c.alphaMap.wrapS=THREE.RepeatWrapping,c.alphaMap.wrapT=THREE.RepeatWrapping),void 0!==t.metalnessMap&&null!==t.metalnessMap&&(o=this.getFullTextPath(r,t.metalnessMap),c.metalnessMap=this.loadTexture(l,e,o,void 0,void 0,Ce.TextureLoadingManager.onError),c.metalnessMap.sourceFile=o,c.metalnessMap.wrapS=THREE.RepeatWrapping,c.metalnessMap.wrapT=THREE.RepeatWrapping),void 0!==t.roughnessMap&&null!==t.roughnessMap&&(o=this.getFullTextPath(r,t.roughnessMap),c.roughnessMap=this.loadTexture(l,e,o,void 0,void 0,Ce.TextureLoadingManager.onError),c.roughnessMap.sourceFile=o,c.roughnessMap.wrapS=THREE.RepeatWrapping,c.roughnessMap.wrapT=THREE.RepeatWrapping),l.setValues(c)):"PointsMaterial"===t.type&&(l=new THREE.PointsMaterial,void 0!==t.color&&(c.color=(new THREE.Color).setHex(parseInt(t.color))),l.setValues(c),l.linewidth=t.pointSize?h(parseFloat(t.pointSize)):1),i&&l&&(l.polygonOffset=!0,l.polygonOffsetFactor=1,l.polygonOffsetUnits=1),l);switch((l=De.dashedMaterial.clone()).uniforms.lineStyle.value=t.lineStyle,t.lineStyle){case Ce.DASHTYPE.DASH:l.uniforms.dashNum.value=1,l.uniforms.pointNum.value=0,l.uniforms.pointSize.value=0;break;case Ce.DASHTYPE.DASHSPACE:l.uniforms.dashNum.value=1,l.uniforms.grapSize.value*=6,l.uniforms.pointNum.value=0,l.uniforms.pointSize.value=0;break;case Ce.DASHTYPE.LONGDASH_DOT:l.uniforms.dashSize.value*=2;break;case Ce.DASHTYPE.LONGDASH_DOUBLEDOT:l.uniforms.dashSize.value*=2,l.uniforms.pointNum.value=2;break;case Ce.DASHTYPE.LONGDASH_TRIPLEDOT:l.uniforms.dashSize.value*=2,l.uniforms.pointNum.value=3;break;case Ce.DASHTYPE.DOT0:l.uniforms.dashNum.value=0;break;case Ce.DASHTYPE.LONGDASH_SHORTDASH:l.uniforms.dashSize.value*=2,l.uniforms.pointSize.value=6;break;case Ce.DASHTYPE.LONGDASH_DOUBLESHORTDASH:l.uniforms.dashSize.value*=2,l.uniforms.pointSize.value=6,l.uniforms.pointNum.value=2;break;case Ce.DASHTYPE.DASH_DOT:break;case Ce.DASHTYPE.DOUBLEDASH_DOT:l.uniforms.dashNum.value=2;break;case Ce.DASHTYPE.DASH_DOUBLEDOT:l.uniforms.pointNum.value=2;break;case Ce.DASHTYPE.DOUBLEDASH_DOUBLEDOT:l.uniforms.dashNum.value=2,l.uniforms.pointNum.value=2;break;case Ce.DASHTYPE.DASH_TRIPLEDOT:l.uniforms.pointNum.value=3;break;case Ce.DASHTYPE.DOUBLEDASH_TRIPLEDOT:l.uniforms.dashNum.value=2,l.uniforms.pointNum.value=3;break;case Ce.DASHTYPE.BATTING:break;case Ce.DASHTYPE.BORDER:l.uniforms.dashNum.value=2;break;case Ce.DASHTYPE.BORDER2:l.uniforms.dashSize.value*=.5,l.uniforms.dashNum.value=2;break;case Ce.DASHTYPE.BORDERX2:l.uniforms.dashNum.value=2,l.uniforms.dashSize.value*=2;break;case Ce.DASHTYPE.CENTER:l.uniforms.pointSize.value=6,l.uniforms.dashSize.value*=2,l.uniforms.grapSize.value=6;break;case Ce.DASHTYPE.CENTER2:l.uniforms.pointSize.value=3;break;case Ce.DASHTYPE.CENTERX2:l.uniforms.pointSize.value=6,l.uniforms.dashSize.value*=4,l.uniforms.grapSize.value=6;break;case Ce.DASHTYPE.DASHDOT:break;case Ce.DASHTYPE.DASHDOT2:l.uniforms.dashSize.value*=.5,l.uniforms.grapSize.value*=.5;break;case Ce.DASHTYPE.DASHDOTX2:l.uniforms.dashSize.value*=2,l.uniforms.grapSize.value*=2;break;case Ce.DASHTYPE.DASHED:l.uniforms.pointNum.value=0,l.uniforms.grapSize.value*=2;break;case Ce.DASHTYPE.DASHED2:l.uniforms.pointNum.value=0,l.uniforms.dashSize.value*=.5;break;case Ce.DASHTYPE.DASHEDX2:l.uniforms.pointNum.value=2,l.uniforms.dashSize.value*=2,l.uniforms.grapSize.value*=4;break;case Ce.DASHTYPE.DIVIDE:l.uniforms.pointNum.value=2,l.uniforms.grapSize.value*=2;break;case Ce.DASHTYPE.DIVIDE2:l.uniforms.pointNum.value=2,l.uniforms.dashSize.value*=.5;break;case Ce.DASHTYPE.DIVIDEX2:l.uniforms.pointNum.value=2,l.uniforms.dashSize.value*=2,l.uniforms.grapSize.value*=4;break;case Ce.DASHTYPE.DOT:l.uniforms.dashNum.value=0,l.uniforms.grapSize.value*=2;break;case Ce.DASHTYPE.DOT2:l.uniforms.dashNum.value=0;break;case Ce.DASHTYPE.DOTX2:l.uniforms.dashNum.value=0,l.uniforms.grapSize.value*=4;break;case Ce.DASHTYPE.FENCELINE1:case Ce.DASHTYPE.FENCELINE2:case Ce.DASHTYPE.GAS_LINE:break;case Ce.DASHTYPE.HIDDEN:l.uniforms.pointNum.value=0,l.uniforms.dashSize.value*=.5;break;case Ce.DASHTYPE.HIDDEN2:l.uniforms.pointNum.value=0,l.uniforms.dashSize.value*=.25,l.uniforms.grapSize.value*=.5;break;case Ce.DASHTYPE.HIDDENX2:l.uniforms.pointNum.value=0,l.uniforms.grapSize.value*=2;break;case Ce.DASHTYPE.HOT_WATER_SUPPLY:break;case Ce.DASHTYPE.JIS_02_07:l.uniforms.pointNum.value=0,l.uniforms.dashSize.value*=.07,l.uniforms.grapSize.value*=.17;break;case Ce.DASHTYPE.JIS_02_10:l.uniforms.pointNum.value=0,l.uniforms.dashSize.value*=.1,l.uniforms.grapSize.value*=.2;break;case Ce.DASHTYPE.JIS_02_12:l.uniforms.pointNum.value=0,l.uniforms.dashSize.value*=.12,l.uniforms.grapSize.value*=.22;break;case Ce.DASHTYPE.JIS_02_20:l.uniforms.pointNum.value=0,l.uniforms.dashSize.value*=.2,l.uniforms.grapSize.value*=.26;break;case Ce.DASHTYPE.JIS_02_40:l.uniforms.pointNum.value=0,l.uniforms.dashSize.value*=.4,l.uniforms.grapSize.value*=.5;break;case Ce.DASHTYPE.JIS_08_11:l.uniforms.pointSize.value=.7,l.uniforms.dashSize.value=11;break;case Ce.DASHTYPE.JIS_08_15:l.uniforms.pointSize.value=.7,l.uniforms.dashSize.value=15;break;case Ce.DASHTYPE.JIS_08_25:l.uniforms.pointSize.value=.7,l.uniforms.dashSize.value=25;break;case Ce.DASHTYPE.JIS_08_37:l.uniforms.pointSize.value=.7,l.uniforms.grapSize.value=1,l.uniforms.dashSize.value=37;break;case Ce.DASHTYPE.JIS_08_50:l.uniforms.pointSize.value=.7,l.uniforms.grapSize.value=1.4,l.uniforms.dashSize.value=50;break;case Ce.DASHTYPE.JIS_09_08:l.uniforms.pointNum.value=2,l.uniforms.pointSize.value=.5,l.uniforms.dashSize.value=8,l.uniforms.grapSize.value=.9;break;case Ce.DASHTYPE.JIS_09_15:l.uniforms.pointNum.value=2,l.uniforms.pointSize.value=.5,l.uniforms.dashSize.value=15,l.uniforms.grapSize.value=.9;break;case Ce.DASHTYPE.JIS_09_29:l.uniforms.pointNum.value=2,l.uniforms.pointSize.value=.5,l.uniforms.dashSize.value=29,l.uniforms.grapSize.value=.9;break;case Ce.DASHTYPE.JIS_09_50:l.uniforms.pointNum.value=2,l.uniforms.pointSize.value=.5,l.uniforms.dashSize.value=50,l.uniforms.grapSize.value=.9;break;case Ce.DASHTYPE.PHANTOM:l.uniforms.pointNum.value=2,l.uniforms.pointSize.value=6,l.uniforms.dashSize.value=31,l.uniforms.grapSize.value=6;break;case Ce.DASHTYPE.PHANTOM2:l.uniforms.pointNum.value=2,l.uniforms.pointSize.value=3,l.uniforms.dashSize.value=15,l.uniforms.grapSize.value=3;break;case Ce.DASHTYPE.PHANTOMX2:l.uniforms.pointNum.value=2,l.uniforms.pointSize.value=12,l.uniforms.dashSize.value=60,l.uniforms.grapSize.value=12;break;case Ce.DASHTYPE.TRACKS:case Ce.DASHTYPE.ZIGZAG:}void 0!==t.color&&l.uniforms.diffuse.value.setHex(parseInt(t.color)),void 0!==t.opacity&&(d=parseFloat(t.opacity))<1&&(l.transparent=!0,l.uniforms.opacity.value=d),void 0!==De.lineColor&&void 0!==c.color&&l.uniforms.diffuse.value.setHex(De.lineColor),void 0!==t.linewidth&&(l.linewidth=h(parseFloat(t.linewidth)))}return l.color=new THREE.Color(16777215),l.color.copy(l.uniforms.diffuse.value),l.setValues(c),l},parseJsonMaterial:function(e,t){return"MeshPhongMaterial"==e.type?this.parsePhongMaterial(e,t):"MeshPhysicalMaterial"==e.type?this.parsePhysicalMaterial(e,t):"MeshBasicMaterial"==e.type?this.parseBasicMaterial(e,t):"MeshStandardMaterial"==e.type?this.parseStandardMaterial(e,t):this.parsePhongMaterial(e,t)},parsePhongMaterial:function(e,t){var r,i=new THREE.MeshPhongMaterial;return void 0!==e.color&&(t.color=(new THREE.Color).setHex(parseInt(e.color))),void 0!==e.wireframe&&(t.wireframe=e.wireframe),void 0!==e.emissive&&(t.emissive=(new THREE.Color).setHex(parseInt(e.emissive))),void 0!==e.specular&&(t.specular=(new THREE.Color).setHex(parseInt(e.specular))),void 0!==e.shininess&&(t.shininess=parseFloat(e.shininess)),void 0!==e.doubleSided&&e.doubleSided&&(t.side=THREE.DoubleSide),void 0!==e.bumpScale&&(t.bumpScale=parseFloat(e.bumpScale)),void 0!==e.reflectivity&&(t.reflectivity=parseFloat(e.reflectivity)),void 0!==e.refractionRatio&&(t.refractionRatio=parseFloat(e.refractionRatio)),void 0!==e.emissiveIntensity&&(t.emissiveIntensity=parseFloat(e.emissiveIntensity)),void 0!==e.opacity&&(r=parseFloat(e.opacity))<1&&(t.transparent=!0,t.opacity=r),void 0!==e.shading&&(0==e.shading||2==parseInt(e.shading)?t.flatShading=!1:t.flatShading=!0),void 0!==e.normalScale&&(r=parseFloat(e.normalScale),t.normalScale=new THREE.Vector2(r,r)),e.map&&this.loadMapTexture(e,t,"map",e.map),e.normalMap&&this.loadMapTexture(e,t,"normalMap",e.normalMap),e.emissiveMap&&this.loadMapTexture(e,t,"emissiveMap",e.emissiveMap),e.normalMap&&this.loadMapTexture(e,t,"normalMap",e.normalMap),e.specularMap&&this.loadMapTexture(e,t,"specularMap",e.specularMap),e.alphaMap&&this.loadMapTexture(e,t,"alphaMap",e.alphaMap),e.alphaMap&&(t.transparent=!0),i.setValues(t),i},parsePhysicalMaterial:function(e,t){var r,i=new THREE.MeshPhysicalMaterial;return void 0!==e.color&&(t.color=(new THREE.Color).setHex(parseInt(e.color))),void 0!==e.wireframe&&(t.wireframe=e.wireframe),void 0!==e.emissive&&(t.emissive=(new THREE.Color).setHex(parseInt(e.emissive))),void 0!==e.specular&&(t.specularColor=(new THREE.Color).setHex(parseInt(e.specular))),void 0!==e.shininess&&(t.shininess=parseFloat(e.shininess)),void 0!==e.doubleSided&&e.doubleSided&&(t.side=THREE.DoubleSide),void 0!==e.bumpScale&&(t.bumpScale=parseFloat(e.bumpScale)),void 0!==e.reflectivity&&(t.reflectivity=parseFloat(e.reflectivity)),void 0!==e.refractionRatio&&(t.refractionRatio=parseFloat(e.refractionRatio)),void 0!==e.emissiveIntensity&&(t.emissiveIntensity=parseFloat(e.emissiveIntensity)),void 0!==e.roughness&&(t.roughness=parseFloat(e.roughness)),void 0!==e.metalness&&(t.metalness=parseFloat(e.metalness)),void 0!==e.alphaTest&&(t.alphaTest=parseFloat(e.alphaTest)),void 0!==e.clearcoat&&(t.clearcoat=parseFloat(e.clearcoat)),void 0!==e.clearcoatRoughness&&(t.clearcoatRoughness=parseFloat(e.clearcoatRoughness)),void 0!==e.specularIntensity&&(t.specularIntensity=parseFloat(e.specularIntensity)),void 0!==e.ior&&(t.ior=parseFloat(e.ior)),void 0!==e.transmission&&Pe.isSupportCanvas2()&&(t.transmission=parseFloat(e.transmission)),void 0!==e.normalScale&&(r=parseFloat(e.normalScale),t.normalScale=new THREE.Vector2(r,r)),void 0!==e.opacity&&(r=parseFloat(e.opacity))<1&&(t.transparent=!0,t.opacity=r),void 0!==e.shading&&(0==e.shading||2==parseInt(e.shading)?t.flatShading=!1:t.flatShading=!0),e.map&&this.loadMapTexture(e,t,"map",e.map),e.normalMap&&this.loadMapTexture(e,t,"normalMap",e.normalMap),e.emissiveMap&&this.loadMapTexture(e,t,"emissiveMap",e.emissiveMap),e.alphaMap&&this.loadMapTexture(e,t,"alphaMap",e.alphaMap),e.metalnessMap&&this.loadMapTexture(e,t,"metalnessMap",e.metalnessMap),e.roughnessMap&&this.loadMapTexture(e,t,"roughnessMap",e.roughnessMap),e.specularIntensityMap&&this.loadMapTexture(e,t,"specularIntensityMap",e.specularIntensityMap),e.mapSpecular&&this.loadMapTexture(e,t,"specularColorMap",e.mapSpecular),e.alphaMap&&(t.transparent=!0),i.setValues(t),i},parseBasicMaterial:function(e,t){var r,i=new THREE.MeshBasicMaterial;return void 0!==e.color&&(t.color=(new THREE.Color).setHex(parseInt(e.color))),void 0!==e.doubleSided&&e.doubleSided&&(t.side=THREE.DoubleSide),void 0!==e.opacity&&(r=parseFloat(e.opacity))<1&&(t.transparent=!0,t.opacity=r),e.map&&this.loadMapTexture(e,t,"map",e.map),e.alphaMap&&this.loadMapTexture(e,t,"alphaMap",e.alphaMap),i.setValues(t),e.alphaMap&&(t.transparent=!0),i},parseStandardMaterial:function(e,t){var r,i=new THREE.MeshStandardMaterial;return void 0!==e.color&&(t.color=(new THREE.Color).setHex(parseInt(e.color))),void 0!==e.wireframe&&(t.wireframe=e.wireframe),void 0!==e.emissive&&(t.emissive=(new THREE.Color).setHex(parseInt(e.emissive))),void 0!==e.doubleSided&&e.doubleSided&&(t.side=THREE.DoubleSide),void 0!==e.bumpScale&&(t.bumpScale=parseFloat(e.bumpScale)),void 0!==e.reflectivity&&(t.reflectivity=parseFloat(e.reflectivity)),void 0!==e.emissiveIntensity&&(t.emissiveIntensity=parseFloat(e.emissiveIntensity)),void 0!==e.envMapIntensity&&(t.envMapIntensity=parseFloat(e.envMapIntensity)),void 0!==e.refractionRatio&&(t.refractionRatio=parseFloat(e.refractionRatio)),void 0!==e.roughness&&(t.roughness=parseFloat(e.roughness)),void 0!==e.metalness&&(t.metalness=parseFloat(e.metalness)),void 0!==e.alphaTest&&(t.alphaTest=parseFloat(e.alphaTest)),void 0!==e.normalScale&&(r=parseFloat(e.normalScale),t.normalScale=new THREE.Vector2(r,r)),void 0!==e.opacity&&(r=parseFloat(e.opacity))<1&&(t.transparent=!0,t.opacity=r),void 0!==e.shading&&(0==e.shading||2==parseInt(e.shading)?t.flatShading=!1:t.flatShading=!0),e.map&&this.loadMapTexture(e,t,"map",e.map),e.normalMap&&this.loadMapTexture(e,t,"normalMap",e.normalMap),e.emissiveMap&&this.loadMapTexture(e,t,"emissiveMap",e.emissiveMap),e.alphaMap&&this.loadMapTexture(e,t,"alphaMap",e.alphaMap),e.metalnessMap&&this.loadMapTexture(e,t,"metalnessMap",e.metalnessMap),e.roughnessMap&&this.loadMapTexture(e,t,"roughnessMap",e.roughnessMap),e.alphaMap&&(t.transparent=!0),i.setValues(t),i},loadMapTexture:function(e,t,r,i){t[r]=(new THREE.TextureLoader).load(i),t[r].sourceFile=i,t[r].wrapS=THREE.RepeatWrapping,t[r].wrapT=THREE.RepeatWrapping},initMaterials:function(e,t,r,i,n,a){if(e){null!=r&&(this.ndsModel.lineTypes&&this.ndsModel.lineTypes.clearLineType(),this.ndsModel.lineTypes=new mt(this.viewer),this.ndsModel.lineTypes.createLineStyle(r,n));var o=new Map;if(null!=i&&0<i.length){for(var s=0;s<i.length;s++)o.set(i[s].uuid,{hatchType:i[s],hatchId:s});this.viewer.hatchTypes=o}for(var l=!1,d=0;d<e.length;++d)if(void 0!==(u=e[d]).type&&"LineBasicMaterial"===u.type){l=!0;break}for(var c=[],h={},d=0;d<e.length;++d){36===(u=e[d]).uuid.length&&(u.uuid=u.uuid.slice(0,8)+u.uuid.slice(9,13)+u.uuid.slice(14,18)+u.uuid.slice(19,23)+u.uuid.slice(24,36)),De.ScenarioEditor&&(m=Pe.addSceneID(u.uuid),u.uuid=THREE.Math.generateUUID(),u.uuid=u.uuid.slice(0,8)+u.uuid.slice(9,13)+u.uuid.slice(14,18)+u.uuid.slice(19,23)+u.uuid.slice(24,36),this.ndsModel.materialuuidOld2New[m]=u.uuid),u.jsonUrl&&(t=this.extractUrlBase(u.jsonUrl));var u,p,f="";for(p in u)"uuid"!=p&&(f+=u[p]);var m=null;(a.loadingPmi?(a.refModelContext.uniquePMIMaterialMap.has(f)?m=a.refModelContext.uniquePMIMaterialMap.get(f):(m=this.createMaterialForBIM(h,u,t,l,o,a.loadingPmi),a.refModelContext.uniquePMIMaterialMap.set(f,m)),c[u.uuid]={mat:m},a.refModelContext.uuidPMIMaterialMap):(a.refModelContext.uniqueMaterialMap.has(f)?m=a.refModelContext.uniqueMaterialMap.get(f):(m=this.createMaterialForBIM(h,u,t,l,o),a.refModelContext.uniqueMaterialMap.set(f,m),c[u.uuid]={mat:m,refCount:0}),a.refModelContext.uuidMaterialMap)).set(u.uuid,m)}return c}},needsTangents:function(e){for(var t=0,r=e.length;t<r;t++)if(e[t]instanceof THREE.ShaderMaterial)return!0;return!1},createMaterial:function(e,c){var h=this;function u(e){e=Math.log(e)/Math.LN2;return Math.pow(2,Math.round(e))}function t(e,t,r,i,n,a,o){var s=c+r,l=null,d=new THREE.Texture;(l=h.imageLoader).crossOrigin=h.crossOrigin,l.load(s,function(e){var t,r,i;!1===THREE.Math.isPowerOfTwo(e.width)||!1===THREE.Math.isPowerOfTwo(e.height)?(t=u(e.width),r=u(e.height),(i=document.createElement("canvas")).width=t,i.height=r,i.getContext("2d").drawImage(e,0,0,t,r),d.image=i):d.image=e,d.needsUpdate=!0}),d.sourceFile=r,i&&(d.repeat.set(i[0],i[1]),1!==i[0]&&(d.wrapS=THREE.RepeatWrapping),1!==i[1])&&(d.wrapT=THREE.RepeatWrapping),n&&d.offset.set(n[0],n[1]),a&&(void 0!==(l={repeat:THREE.RepeatWrapping,mirror:THREE.MirroredRepeatWrapping})[a[0]]&&(d.wrapS=l[a[0]]),void 0!==l[a[1]])&&(d.wrapT=l[a[1]]),o&&(d.anisotropy=o),e[t]=d}function r(e){return(255*e[0]<<16)+(255*e[1]<<8)+255*e[2]}var i,n,a="MeshLambertMaterial",o={color:15658734,opacity:1,map:null,lightMap:null,normalMap:null,bumpMap:null,wireframe:!1};return e.shading&&("phong"===(i=e.shading.toLowerCase())?a="MeshPhongMaterial":"basic"===i&&(a="MeshBasicMaterial")),void 0!==e.blending&&void 0!==THREE[e.blending]&&(o.blending=THREE[e.blending]),(void 0!==e.transparent||e.opacity<1)&&(o.transparent=e.transparent),void 0!==e.depthTest&&(o.depthTest=e.depthTest),void 0!==e.depthWrite&&(o.depthWrite=e.depthWrite),void 0!==e.visible&&(o.visible=e.visible),void 0!==e.flipSided&&(o.side=THREE.BackSide),void 0!==e.doubleSided&&(o.side=THREE.DoubleSide),void 0!==e.wireframe&&(o.wireframe=e.wireframe),void 0!==e.vertexColors&&(o.vertexColors=!0),e.colorDiffuse?o.color=r(e.colorDiffuse):e.DbgColor&&(o.color=e.DbgColor),e.colorSpecular&&(o.specular=r(e.colorSpecular)),e.colorAmbient&&(o.ambient=r(e.colorAmbient)),e.colorEmissive&&(o.emissive=r(e.colorEmissive)),e.transparency&&(o.opacity=e.transparency),e.specularCoef&&(o.shininess=e.specularCoef),e.mapDiffuse&&c&&t(o,"map",e.mapDiffuse,e.mapDiffuseRepeat,e.mapDiffuseOffset,e.mapDiffuseWrap,e.mapDiffuseAnisotropy),e.mapLight&&c&&t(o,"lightMap",e.mapLight,e.mapLightRepeat,e.mapLightOffset,e.mapLightWrap,e.mapLightAnisotropy),e.mapBump&&c&&t(o,"bumpMap",e.mapBump,e.mapBumpRepeat,e.mapBumpOffset,e.mapBumpWrap,e.mapBumpAnisotropy),e.mapNormal&&c&&t(o,"normalMap",e.mapNormal,e.mapNormalRepeat,e.mapNormalOffset,e.mapNormalWrap,e.mapNormalAnisotropy),e.mapSpecular&&c&&t(o,"specularMap",e.mapSpecular,e.mapSpecularRepeat,e.mapSpecularOffset,e.mapSpecularWrap,e.mapSpecularAnisotropy),e.mapAlpha&&c&&t(o,"alphaMap",e.mapAlpha,e.mapAlphaRepeat,e.mapAlphaOffset,e.mapAlphaWrap,e.mapAlphaAnisotropy),e.mapBumpScale&&(o.bumpScale=e.mapBumpScale),e.mapNormal?(i=THREE.ShaderLib.normalmap,(n=THREE.UniformsUtils.clone(i.uniforms)).tNormal.value=o.normalMap,e.mapNormalFactor&&n.uNormalScale.value.set(e.mapNormalFactor,e.mapNormalFactor),o.map&&(n.tDiffuse.value=o.map,n.enableDiffuse.value=!0),o.specularMap&&(n.tSpecular.value=o.specularMap,n.enableSpecular.value=!0),o.lightMap&&(n.tAO.value=o.lightMap,n.enableAO.value=!0),n.diffuse.value.setHex(o.color),n.specular.value.setHex(o.specular),n.ambient.value.setHex(o.ambient),n.shininess.value=o.shininess,void 0!==o.opacity&&(n.opacity.value=o.opacity),i={fragmentShader:i.fragmentShader,vertexShader:i.vertexShader,uniforms:n,lights:!0,fog:!0},n=new THREE.ShaderMaterial(i),o.transparent&&(n.transparent=!0)):n=new THREE[a](o),void 0!==e.DbgName&&(n.name=e.DbgName),n}},ut.ensurePowerOfTwo_=function(e){var t;return THREE.Math.isPowerOfTwo(e.width)&&THREE.Math.isPowerOfTwo(e.height)?e:((t=document.createElement("canvas")).width=ut.nextHighestPowerOfTwo_(e.width),t.height=ut.nextHighestPowerOfTwo_(e.height),t.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,t.width,t.height),t)},ut.nextHighestPowerOfTwo_=function(e){--e;for(var t=1;t<32;t<<=1)e|=e>>t;return e+1};var At=function(){function e(e,t,r){this.viewer=e,this.type=2,this.version=0,this.modelRequestor=t||null,this.ndsModel=r,this.brepInfos={},this.brepInfos.bodies=new Map,this.brepInfos.edgeGroups=[],this.brepInfos.faceGroups=[],this.brepInfos.breps=[],this._hasBrepInfo=!1,this._referenceMap=new Map,this._mapBodyToEdgesPoints={},this._brepFileUrls=[],this._loadedTags=[],this._reqTags=[],this._modelIds=[],this.filesToLoadCount=0,this.brepInfo={BfaceArea:!1,BbodyVolume:!1,BbodyArea:!1,BtotalArea:!1,BfacePerimeter:!1}}var t=e.prototype;return t.addRequest=function(){if(this.modelRequestor)for(var e=0;e<this._brepFileUrls.length;e++)this._loadedTags[e]||(this.modelRequestor.addRequest(this._brepFileUrls[e],1e5,"loadBrepData",{modelId:this._modelIds[e],keepSourceFile:!!NDSWebViewer.SETTING.ScenarioEditor,gobalReqHeader:this.viewer.gobalReqHeader}),this._reqTags[e]=!0)},t.addBrepFileUrl=function(e,t){this._brepFileUrls.push(e),this._loadedTags.push(!1),this._modelIds.push(t),this.modelRequestor&&this._reqTags.push(!1)},t.onLoad=function(e,t,r,i){this.filesToLoadCount--;for(var n=0;n<this._brepFileUrls.length;n++)this._brepFileUrls[n]===e&&(this._loadedTags[n]=!0,this._reqTags[n]=!1,this._hasBrepInfo=!0);NDSWebViewer.SETTING.singleHTML&&0==this._brepFileUrls.length&&(this._hasBrepInfo=!0),this.viewer.brepInfo.BfaceArea=i,this.viewer.brepInfo.BbodyVolume=t,this.viewer.brepInfo.BbodyArea=!!t&&r,this.viewer.brepInfo.BtotalArea=r,this.viewer.brepInfo.BfacePerimeter=!!(i&&1<this.version),this.filesToLoadCount<1&&this.viewer.dispatchBrepEvent(),NDSWebViewer.SETTING.enableBroadcast&&this.viewer.broadcastManager.broadcastInfo&&this.viewer.broadcastManager.setBroadcastInfo(this.viewer.broadcastManager.broadcastInfo),!0===this.showWaitCursor&&this.filesToLoadCount<1&&this.viewer.exitWaitProcedure()},t.onError=function(e){this.filesToLoadCount--,this.filesToLoadCount<1&&this.viewer.exitWaitProcedure()},t.bindReference=function(e,t){this._referenceMap.set(e,t)},t.loadBreps=function(e,t){if(!(this._loadedTags.length<1)){for(var r=this.filesToLoadCount=0;r<this._loadedTags.length;r++)0==this._loadedTags[r]&&0==this._reqTags[r]&&this.filesToLoadCount++;this.filesToLoadCount<1||(this.addRequest(),!0===e&&(this.showWaitCursor=!0,this.viewer.startWaitProcedure()))}},t.GetBrepInfo=function(){s=gt().mark(function e(t){return gt().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.brepInfos);case 1:case"end":return e.stop()}},e,this)});var s,t=function(){var e=this,o=arguments;return new Promise(function(t,r){var i=s.apply(e,o);function n(e){vt(i,t,r,n,a,"next",e)}function a(e){vt(i,t,r,n,a,"throw",e)}n(void 0)})};return function(e){return t.apply(this,arguments)}}(),t.scaleBrepValue=function(e,t){if(e){var t=this.ndsModel.bodyUuid2NodeMap[t],t=this.viewer.getBodyNodeFileUnit(t),r=this.viewer.modelUnit;if(t&&r){var i=this.viewer.getUnitTransfrom(r,t);if(e.length&&(e.length*=i),e.radius&&(e.radius*=i),e.area&&(e.area*=i*i),e.volume&&(e.volume*=i*i*i),e.radiusX&&(e.radiusX*=i),e.radiusY&&(e.radiusY*=i),e.edgeIDS)for(var n=0;n<e.edgeIDS.length;n++)e.edgeIDS[n].perimeter*=i}}},t.isLoad=function(){for(var e=0;e<this._brepFileUrls.length;e++)if(0==this._loadedTags[e])return!1;return!0},t.addEdgeFaceGroupInfo=function(e,t,r){this._hasBrepInfo=!0,this.brepInfos.bodies.set(e,this.brepInfos.breps.length),this.brepInfos.breps.push({area:-1,edgeGroups:new Int32Array([this.brepInfos.edgeGroups.length]),faceGroups:new Int32Array([this.brepInfos.faceGroups.length]),volume:-1}),this.brepInfos.edgeGroups.push(t),this.brepInfos.faceGroups.push(r)},t.clearBrepInfo=function(){this._hasBrepInfo=!1,this.brepInfos.bodies.clear(),this.brepInfos.edgeGroups=[],this.brepInfos.faceGroups=[],this.brepInfos.breps=[]},t.GetBodyVolumeAndAreaV1=function(e){e=this.brepInfos[e];return(e=e&&e.referenceBodyUuid?this.brepInfos[e.referenceBodyUuid]:e)&&null!=e.volume?{volume:parseFloat(e.volume),area:parseFloat(e.area)}:null},t.GetBodyVolumeAndAreaV2=function(e){return this.brepInfos.bodies.has(e)?{volume:(e=this.brepInfos.breps[this.brepInfos.bodies.get(e)]).volume,area:e.area}:null},t.GetBodyVolumeAndArea=function(e){var t,r;if(e&&1==this._hasBrepInfo)return t=this._referenceMap.has(e)?this._referenceMap.get(e):e,r=null,r=2===this.type?this.GetBodyVolumeAndAreaV2(t):this.GetBodyVolumeAndAreaV1(t),this.scaleBrepValue(r,e),r},t.GetEdegMeshIDfromIDV1=function(e,t){if(1===this.type){var r=this.brepInfos[e];r&&r.referenceBodyUuid&&(r=this.brepInfos[r.referenceBodyUuid]);for(var i=0;i<r.edgeGroups.length;++i)for(var n=r.edgeGroups[i],a=n.meshID,o=0;o<n.edges.length;++o)if(n.edges[o].id==t)return a}return null},t.GetEdegMeshIDfromIDV2=function(e,i){function t(e){for(var t=0,r=e.length;t<r;++t)if(e[t]===i)return 1}if(this.viewer.ndsModel&&this.brepInfos.bodies.has(e)){for(var r,n=this.brepInfos.breps[this.brepInfos.bodies.get(e)],a=0,o=n.edgeGroups.length;a<o;++a){var s=this.brepInfos.edgeGroups[n.edgeGroups[a]];!(r=!(r=!(r=!(r=s.lines&&t(s.lines.ids)?s.geomUUID:r)&&s.circles&&t(s.circles.ids)?s.geomUUID:r)&&s.ellipses&&t(s.ellipses.ids)?s.geomUUID:r)&&s.nurbses&&t(s.nurbses.ids)?s.geomUUID:r)&&s.others&&t(s.others.ids)&&(r=s.geomUUID)}if(r){e=this.viewer.ndsModel.getBodyNodeFromUuid(e);if(e)return this.viewer.ndsModel.meshManager.getBodyMeshIdFromGeomUUid(e,r)}}return null},t.GetEdegMeshIDfromID=function(e,t){if(e&&1==this._hasBrepInfo)return e=this._referenceMap.has(e)?this._referenceMap.get(e):e,2===this.type?this.GetEdegMeshIDfromIDV2(e,t):this.GetEdegMeshIDfromIDV1(e,t)},t.GetBrepInfoByUUidAndTopolIndex=function(e,t,r,i){if(!0===this._hasBrepInfo){if(!i)return this.GetFaceByUUidAndFaceIndex(e,t,r)||this.GetEdgeByUUidAndEdgeIndex(e,t,r);i.toLowerCase();var n=null,n="edge"===i?this.GetEdgeByUUidAndEdgeIndex(e,t,r):this.GetFaceByUUidAndFaceIndex(e,t,r);return this.scaleBrepValue(n,e),n}},t.GetBrepInfoByBodyUuidAndTopoIdV1=function(e,t,r){if(!0!==this._hasBrepInfo)return null;var i=this.brepInfos[e];if(!i)return null;if(i.referenceBodyUuid&&(i=this.brepInfos[i.referenceBodyUuid]),r.toLowerCase(),"face"===r){for(var n=0,a=i.faceGroups.length;n<a;n++){for(var o=i.faceGroups[n],s=o.faces,l=!1,d=null,c=0,h=s.length;c<h;c++)if(s[c].id==t){l=!0,d=Object.assign({},s[c]);break}if(l){o=o.meshID;if(this.viewer.ndsModel){var u=this.viewer.ndsModel.meshUuid2GeomUuidMap[o],p=this.viewer.ndsModel.getBodyNodeFromUuid(e);if(p){p=this.viewer.ndsModel.meshManager.getBodyMeshIdFromGeomUUid(p,u);if(-1<p){p=this.viewer.ndsModel.meshManager.getSingleMesh(p);if(p)return d.parentObj=p,d.bodyId=e,d.meshId=u,d}}}else{p=this.viewer.getObjectByUUID(o);if(p)return d.parentObj=p,d.bodyId=e,d.meshId=o,d}}}return null}if("edge"===r){for(var f=0,m=i.edgeGroups.length;f<m;f++){for(var g=i.edgeGroups[f],v=g.edges,y=!1,A=null,M=0,E=v.length;M<E;M++)if(v[M].id==t){y=!0,A=Object.assign({},v[M]);break}if(y){g=g.meshID;if(this.viewer.ndsModel){var w=this.viewer.ndsModel.meshUuid2GeomUuidMap[g],x=this.viewer.ndsModel.getBodyNodeFromUuid(e);if(x){x=this.viewer.ndsModel.meshManager.getBodyLineSegmentsFromGeomUUid(x,w);if(x)return A.parentObj=x,A.bodyId=e,A.meshId=w,A}}else{x=this.viewer.getObjectByUUID(g);if(x)return A.parentObj=x,A.bodyId=e,A.meshId=g,A}}}return null}if("vertex"===r){for(var b,B,I=0,T=i.vertices.length;I<T;I++)if(t===i.vertices[I].id)return b=null,b=(this.viewer.ndsModel?(B=this.viewer.ndsModel.getBodyNodeFromUuid(e),this.viewer.ndsModel.meshManager.getMeshInfor(B.id,B={}),B):this.viewer.getObjectByUUID(e)).matrixWorld,(B=new THREE.Vector3(i.vertices[I].coords[0],i.vertices[I].coords[1],i.vertices[I].coords[2])).applyMatrix4(b),{id:i.vertices[I].id,coords:[B.x,B.y,B.z],bodyId:e};return null}},t.GetFaceBrepInfo=function(e,t,r){function i(e,t,r,i){e.id=r.ids[t],e.geomUUID=i.geomUUID,e.indexRange=[r.triIndexRanges[2*t],r.triIndexRanges[2*t+1]],e.area=r.areas[t];var n=r.loops[2*t],a=r.loops[2*t+1];e.edgeIDS=[];for(var o=0;o<a;++o)e.edgeIDS[o]={perimeter:i.loopPerimeters[n+o],startID:i.loopStartEdgeId[n+o]};r.persist&&(e.persist=r.persist[t])}var n;return"plane"===t?i(n={type:"plane",origin:[e.planes.origins[3*r],e.planes.origins[3*r+1],e.planes.origins[3*r+2]],normal:[e.planes.normals[3*r],e.planes.normals[3*r+1],e.planes.normals[3*r+2]]},r,e.planes,e):"cylinder"===t?i(n={type:"cylinder",origin:[e.cylinders.origins[3*r],e.cylinders.origins[3*r+1],e.cylinders.origins[3*r+2]],axis:[e.cylinders.axis[3*r],e.cylinders.axis[3*r+1],e.cylinders.axis[3*r+2]],radius:e.cylinders.radiuses[r]},r,e.cylinders,e):"cone"===t?i(n={type:"cone",origin:[e.cones.origins[3*r],e.cones.origins[3*r+1],e.cones.origins[3*r+2]],axis:[e.cones.axis[3*r],e.cones.axis[3*r+1],e.cones.axis[3*r+2]],radius:e.cones.radiuses[r]},r,e.cones,e):"sphere"===t?i(n={type:"sphere"},r,e.spheres,e):"torus"===t?i(n={type:"torus"},r,e.toruses,e):"nurbs"===t?i(n={type:"nurbs"},r,e.nurbses,e):"other"===t&&i(n={type:"other"},r,e.others,e),n},t.GetEdgeBrepInfo=function(e,t,r){var i;return"line"===t?(i={id:e.lines.ids[r],geomUUID:e.geomUUID,indexRange:[e.lines.indexRanges[2*r],e.lines.indexRanges[2*r+1]],length:e.lines.lengthes[r],type:"line"},e.lines.persist&&(i.persist=e.lines.persist[r])):"circle"===t?(i={id:e.circles.ids[r],geomUUID:e.geomUUID,indexRange:[e.circles.indexRanges[2*r],e.circles.indexRanges[2*r+1]],length:e.circles.lengthes[r],center:[e.circles.centers[3*r],e.circles.centers[3*r+1],e.circles.centers[3*r+2]],radius:e.circles.radiuses[r],type:"circle"},e.circles.persist&&(i.persist=e.circles.persist[r])):"ellipse"===t?(i={id:e.ellipses.ids[r],geomUUID:e.geomUUID,indexRange:[e.ellipses.indexRanges[2*r],e.ellipses.indexRanges[2*r+1]],length:e.ellipses.lengthes[r],type:"ellipse"},e.ellipses.persist&&(i.persist=e.ellipses.persist[r]),e.ellipses.centers&&(i.center=[e.ellipses.centers[3*r],e.ellipses.centers[3*r+1],e.ellipses.centers[3*r+2]]),e.ellipses.normals&&(i.normal=[e.ellipses.normals[3*r],e.ellipses.normals[3*r+1],e.ellipses.normals[3*r+2]]),e.ellipses.radiusX&&(i.radiusX=e.ellipses.radiusX[r]),e.ellipses.radiusY&&(i.radiusY=e.ellipses.radiusY[r]),e.ellipses.axisX&&(i.axisX=[e.ellipses.axisX[3*r],e.ellipses.axisX[3*r+1],e.ellipses.axisX[3*r+2]])):"nurbs"===t?(i={id:e.nurbses.ids[r],geomUUID:e.geomUUID,indexRange:[e.nurbses.indexRanges[2*r],e.nurbses.indexRanges[2*r+1]],length:e.nurbses.lengthes[r],type:"nurbs"},e.nurbses.persist&&(i.persist=e.nurbses.persist[r])):"other"===t&&(i={id:e.others.ids[r],geomUUID:e.geomUUID,indexRange:[e.others.indexRanges[2*r],e.others.indexRanges[2*r+1]],length:e.others.lengthes[r],type:"other"},e.others.persist)&&(i.persist=e.others.persist[r]),i},t.GetBrepInfoByBodyUuidAndTopoIdV2=function(e,i,t){if(!0!==this._hasBrepInfo)return null;if(!this.brepInfos.bodies.has(e))return null;function r(e){for(var t=0,r=e.length;t<r;t++)if(e[t]==i)return t;return-1}var n=this.brepInfos.breps[this.brepInfos.bodies.get(e)];if(t.toLowerCase(),"face"===t&&n.faceGroups)for(var a=0,o=n.faceGroups.length;a<o;a++){var s=this.brepInfos.faceGroups[n.faceGroups[a]],l=!1,d=null;if(s.planes){var c=r(s.planes.ids);if(-1<c&&(l=!0,d=this.GetFaceBrepInfo(s,"plane",c)),!l&&s.cylinders&&-1<(c=r(s.cylinders.ids))&&(l=!0,d=this.GetFaceBrepInfo(s,"cylinder",c)),!l&&s.cones&&-1<(c=r(s.cones.ids))&&(l=!0,d=this.GetFaceBrepInfo(s,"cone",c)),!l&&s.spheres&&-1<(c=r(s.spheres.ids))&&(l=!0,d=this.GetFaceBrepInfo(s,"sphere",c)),!l&&s.toruses&&-1<(c=r(s.toruses.ids))&&(l=!0,d=this.GetFaceBrepInfo(s,"torus",c)),!l&&s.nurbses&&-1<(c=r(s.nurbses.ids))&&(l=!0,d=this.GetFaceBrepInfo(s,"nurbs",c)),!l&&s.others&&-1<(c=r(s.others.ids))&&(l=!0,d=this.GetFaceBrepInfo(s,"other",c)),l&&this.viewer.ndsModel){c=s.geomUUID,l=this.viewer.ndsModel.getBodyNodeFromUuid(e);if(l){s=this.viewer.ndsModel.meshManager.getBodyMeshIdFromGeomUUid(l,c);if(-1<s){l=this.viewer.ndsModel.meshManager.getSingleMesh(s);if(l)return d.parentObj=l,d.bodyId=e,d.meshId=c,d}}}}return null}else{if("edge"===t&&n.edgeGroups){for(var h=0,u=n.edgeGroups.length;h<u;h++){var p,f,m=this.brepInfos.edgeGroups[n.edgeGroups[h]],g=!1,v=null;if(m.lines&&-1<(p=r(m.lines.ids))&&(g=!0,v=this.GetEdgeBrepInfo(m,"line",p)),!g&&m.circles&&-1<(p=r(m.circles.ids))&&(g=!0,v=this.GetEdgeBrepInfo(m,"circle",p)),!g&&m.ellipses&&-1<(f=r(m.ellipses.ids))&&(g=!0,v=this.GetEdgeBrepInfo(m,"ellipse",f)),!g&&m.nurbses&&-1<(f=r(m.nurbses.ids))&&(g=!0,v=this.GetEdgeBrepInfo(m,"nurbs",f)),!g&&m.others&&-1<(y=r(m.others.ids))&&(g=!0,v=this.GetEdgeBrepInfo(m,"other",y)),g&&this.viewer.ndsModel){var y=m.geomUUID,g=this.viewer.ndsModel.getBodyNodeFromUuid(e);if(g){m=this.viewer.ndsModel.meshManager.getBodyLineSegmentsFromGeomUUid(g,y);if(m)return v.parentObj=m,v.bodyId=e,v.meshId=y,v}}}return null}if("vertex"===t&&n.vertices){for(var A=0,M=n.vertices.length;A<M;A++){var E,w,x=n.vertices[A];if(i===this.brepInfos.vertices.ids[x])return E=null,this.viewer.ndsModel&&(w=this.viewer.ndsModel.getBodyNodeFromUuid(e),this.viewer.ndsModel.meshManager.getMeshInfor(w.id,w={}),E=w.matrixWorld),(w=new THREE.Vector3(this.brepInfos.vertices.coords[3*x+0],this.brepInfos.vertices.coords[3*x+1],this.brepInfos.vertices.coords[3*x+2])).applyMatrix4(E),{id:i,coords:[w.x,w.y,w.z],bodyId:e}}return null}}},t.GetBrepInfoByBodyUuidAndTopoId=function(e,t,r){var i,n;if(e&&1==this._hasBrepInfo)return i=this._referenceMap.has(e)?this._referenceMap.get(e):e,n=null,n=2===this.type?this.GetBrepInfoByBodyUuidAndTopoIdV2(i,t,r):this.GetBrepInfoByBodyUuidAndTopoIdV1(i,t,r),this.scaleBrepValue(n,e),n},t.hasBrepInfo=function(){return this._hasBrepInfo},t.hasBrepFile=function(){return 0<this._brepFileUrls.length},t.GetEdgesExtremePointsByBodyUUIDV1=function(e){if(e&&1==this._hasBrepInfo){if(this._mapBodyToEdgesPoints[e])return this._mapBodyToEdgesPoints[e];var t=this.brepInfos[e];if((t=t&&(t.referenceBodyUuid?this.brepInfos[t.referenceBodyUuid]:t))&&t.edgeGroups){for(var r=[],i=0,n=t.edgeGroups.length;i<n;i++){var a=t.edgeGroups[i];if(a){var o=a.edges;if(o){var s,a=a.meshID,l=void 0;if(this.viewer.ndsModel){var a=this.viewer.ndsModel.meshUuid2GeomUuidMap[a],d=this.viewer.ndsModel.getBodyNodeFromUuid(e);if(!d)continue;l=this.viewer.ndsModel.meshManager.getBodyLineSegmentsFromGeomUUid(d,a)}else l=this.viewer.selectionManager.getLineObjectFromUUid(a);if(l&&(s=l.geometry)&&s.isBufferGeometry){var c=s.index;if(null!=c)for(var h=s.attributes.position.array,u=0,p=o.length;u<p;u++){var f=o[u],m=f.indexRange.concat(),g=(this.viewer.ndsModel&&(m[0]+=s.drawRange.start/2,m[1]+=s.drawRange.start/2),c.array),v=new THREE.Vector3,y=new THREE.Vector3;v.fromArray(h,3*g[2*m[0]]),y.fromArray(h,3*g[2*m[1]+1]),v.applyMatrix4(l.matrixWorld),y.applyMatrix4(l.matrixWorld),"circle"==f.type&&r.push(new THREE.Vector3(f.center[0],f.center[1],f.center[2]).applyMatrix4(l.matrixWorld)),r.push(v),r.push(y)}}}}}return this._mapBodyToEdgesPoints[e]=r}}},t.GetEdgesExtremePointsByBodyUUIDV2=function(e,t){var g=this;if(!e||1!=this._hasBrepInfo)return null;if(this._mapBodyToEdgesPoints[t])return this._mapBodyToEdgesPoints[t];if(!this.brepInfos.bodies.has(e))return null;var r=this.brepInfos.breps[this.brepInfos.bodies.get(e)];if(!r.edgeGroups)return null;for(var v=[],i=function(e,t,r,i){void 0===i&&(i={});var n=[];Array.isArray(t)?n=t:n[0]=t;for(var a=0,o=n.length;a<o;++a){var s=n[a],l=s.geometry;if(!l||!l.isBufferGeometry||!l.index)return;for(var d=l.attributes.position.array,c=0,h=e.length/2;c<h;c++){var u=[e[2*c],e[2*c+1]],p=(g.viewer.ndsModel&&(u[0]+=l.drawRange.start/2,u[1]+=l.drawRange.start/2),l.index.array),f=new THREE.Vector3,m=new THREE.Vector3;f.fromArray(d,3*p[2*u[0]]),m.fromArray(d,3*p[2*u[1]+1]),f.applyMatrix4(s.matrixWorld),m.applyMatrix4(s.matrixWorld),"circle"===r&&(v.push(new THREE.Vector3(i.centers[3*c+0],i.centers[3*c+1],i.centers[3*c+2]).applyMatrix4(s.matrixWorld)),v[v.length-1].viewportId=l.viewportId),f.viewportId=l.viewportId,m.viewportId=l.viewportId,v.push(f),v.push(m)}}},n=0,a=r.edgeGroups.length;n<a;n++){var o=this.brepInfos.edgeGroups[r.edgeGroups[n]],s=void 0;if(this.viewer.ndsModel){var l=this.ndsModel.getBodyNodeFromUuid(t);if(!l)continue;s=this.ndsModel.meshManager.getBodyLineSegmentsFromGeomUUid(l,o.geomUUID)}s&&(o.lines&&i(o.lines.indexRanges,s,"line"),o.circles&&i(o.circles.indexRanges,s,"circle",{centers:o.circles.centers}),o.ellipses&&i(o.ellipses.indexRanges,s,"ellipse"),o.nurbses&&i(o.nurbses.indexRanges,s,"nurbs"),o.others)&&i(o.others.indexRanges,s,"other")}return this._mapBodyToEdgesPoints[t]=v},t.clearBrepEdgesPoints=function(){this._mapBodyToEdgesPoints={}},t.GetEdgesExtremePointsByBodyUUID=function(e){var t;if(e&&1==this._hasBrepInfo)return t=this._referenceMap.has(e)?this._referenceMap.get(e):e,2===this.type?this.GetEdgesExtremePointsByBodyUUIDV2(t,e):this.GetEdgesExtremePointsByBodyUUIDV1(t)},t.GetCircleCenterFromLeafBodyNode=function(e){for(var t=[],r=0;r<e.length;r++){var i=e[r];if(this.brepInfos.bodies.has(i.uuid)){var n=this.brepInfos.breps[this.brepInfos.bodies.get(i.uuid)];if(n.edgeGroups)for(var a=0;a<n.edgeGroups.length;a++){var o=n.edgeGroups[a],s=this.brepInfos.edgeGroups[o];if(s.circles)for(var o=this.viewer.ndsModel.meshManager.getBodyLineSegmentsFromGeomUUid(i,s.geomUUID),l=[],d=(Array.isArray(o)?l=o:l[0]=o,s.circles.ids.length),c=new THREE.Vector3,h=0,u=l.length;h<u;++h){var p=l[h];if(p){var f=p.geometry;if(f&&f.isBufferGeometry&&f.index){for(var m=(new THREE.Box3).copy(f.boundingBox).applyMatrix4(p.matrixWorld),g=new Array(3*d),v=0;v<d;v++)c.fromArray(s.circles.centers,3*v).applyMatrix4(p.matrixWorld),g[3*v]=c.x,g[3*v+1]=c.y,g[3*v+2]=c.z;var y=new Array(d);if(this.viewer.viewprots&&-1<f.viewportId){var A=this.viewer.viewprots[f.viewportId];if(A)throw A.scale,void 0,A="viewScale",new TypeError('"'+A+'" is read-only')}for(var M=0,E=0;E<d;E++)y[E]=+s.circles.radiuses[E],y[E]>M&&(M=y[E]);var A=new THREE.Vector3(m.min.x-M,m.min.y-M,m.min.z),w=new THREE.Vector3(m.max.x+M,m.max.y+M,m.max.z);m.expandByPoint(A),m.expandByPoint(w),t.push({geomuuid:s.geomUUID,subId:f.subGeomId,box:m,matrixWorld:p.matrixWorld.clone(),centers:g,indexRanges:s.circles.indexRanges,radiuses:y})}}}}}}return t},t.GetVerticesByBodyUUIDV1=function(e){e=this.brepInfos[e];return(e=e&&(e.referenceBodyUuid?this.brepInfos[e.referenceBodyUuid]:e))&&e.vertices?e.vertices:null},t.GetVerticesByBodyUUIDV2=function(e){return null},t.GetVerticesByBodyUUID=function(e){if(e&&1==this._hasBrepInfo)return e=this._referenceMap.has(e)?this._referenceMap.get(e):e,2===this.type?this.GetVerticesByBodyUUIDV2(e):this.GetVerticesByBodyUUIDV1(e)},t.GetEdgeInfoFromFaceV1=function(e,t){if(e&&t){var r=this.brepInfos[e];if((r=r&&(r.referenceBodyUuid?this.brepInfos[r.referenceBodyUuid]:r))&&r.faceGroups){for(var i="Array"===t.constructor.name?t.slice():[t],n=[],a=0,o=r.edgeGroups.length;a<o;a++){var s=r.edgeGroups[a],l=s.edges,d=s.meshID;if(l){for(var c=0,h=l.length;c<h;c++){var u=l[c];if(-1!=i.indexOf(u.id)&&(n.push(u),i.splice(i.indexOf(u.id),1),0==i.length))break}if(0==i.length)break}}return{array:n,meshID:d}}}},t.GetEdgeInfoFromFaceV2=function(e,t){var a=this;if(e&&t&&this.brepInfos.bodies.has(e)){var r=this.brepInfos.breps[this.brepInfos.bodies.get(e)];if(r.faceGroups&&r.edgeGroups){var o="Array"===t.constructor.name?t.slice():[t],s=[];if(this.ndsModel.getBodyNodeFromUuid(e)){for(var i=function(e,t,r){for(var i=0,n=e.ids.length;i<n&&(-1===o.indexOf(e.ids[i])||(s.push(a.GetEdgeBrepInfo(r,t,i)),o.splice(o.indexOf(e.ids[i]),1),0!=o.length));++i);},n=0,l=r.edgeGroups.length;n<l;n++){var d=this.brepInfos.edgeGroups[r.edgeGroups[n]],c=d.geomUUID;if(d.lines&&i(d.lines,"line",d),d.circles&&i(d.circles,"circle",d),d.ellipses&&i(d.ellipses,"ellipse",d),d.nurbses&&i(d.nurbses,"nurbs",d),d.others&&i(d.others,"other",d),0==o.length)break}return{array:s,meshID:-1,geomUUID:c}}}}},t.GetEdgeInfoFromFace=function(e,t){if(e&&1==this._hasBrepInfo)return e=this._referenceMap.has(e)?this._referenceMap.get(e):e,2===this.type?this.GetEdgeInfoFromFaceV2(e,t):this.GetEdgeInfoFromFaceV1(e,t)},t.GetFaceByUUidAndFaceIndexV1=function(e,t,r){if(e&&t&&!(r<0)){var i=this.brepInfos[e];if((i=i&&(i.referenceBodyUuid?this.brepInfos[i.referenceBodyUuid]:i))&&i.faceGroups)for(var n=0,a=i.faceGroups.length;n<a;n++){var o=i.faceGroups[n],s=o.meshID;if(t===(s=this.viewer.ndsModel?this.viewer.ndsModel.meshUuid2GeomUuidMap[s]:s)){var l=o.faces;if(l)for(var d=0,c=l.length;d<c;d++){var h=l[d],u=h.indexRange[0],p=h.indexRange[1];if(u<=r&&r<=p)return Object.assign({},h)}}}}},t.GetFaceByUUidAndFaceIndexV2=function(e,t,a){if(e&&t&&!(a<0)&&this.viewer.ndsModel&&this.brepInfos.bodies.has(e)){var r=this.brepInfos.breps[this.brepInfos.bodies.get(e)];if(r.faceGroups){for(var i=function(e){for(var t=0,r=e.length/2;t<r;++t){var i=e[2*t],n=e[2*t+1];if(i<=a&&a<=n)return t}return-1},n=0,o=r.faceGroups.length;n<o;n++){var s=this.brepInfos.faceGroups[r.faceGroups[n]],l=s.geomUUID;if(t===l){var d,c,h,u,l=!1,p=void 0;if(s.planes&&-1<(d=i(s.planes.triIndexRanges))&&(l=!0,p=this.GetFaceBrepInfo(s,"plane",d)),!l&&s.cylinders&&-1<(d=i(s.cylinders.triIndexRanges))&&(l=!0,p=this.GetFaceBrepInfo(s,"cylinder",d)),!l&&s.cones&&-1<(c=i(s.cones.triIndexRanges))&&(l=!0,p=this.GetFaceBrepInfo(s,"cone",c)),!l&&s.spheres&&-1<(c=i(s.spheres.triIndexRanges))&&(l=!0,p=this.GetFaceBrepInfo(s,"sphere",c)),!l&&s.toruses&&-1<(h=i(s.toruses.triIndexRanges))&&(l=!0,p=this.GetFaceBrepInfo(s,"torus",h)),!l&&s.nurbses&&-1<(h=i(s.nurbses.triIndexRanges))&&(l=!0,p=this.GetFaceBrepInfo(s,"nurbs",h)),!l&&s.others&&-1<(u=i(s.others.triIndexRanges))&&(l=!0,p=this.GetFaceBrepInfo(s,"other",u)),l)return p}}return null}}},t.GetFaceByUUidAndFaceIndex=function(e,t,r){if(e&&1==this._hasBrepInfo)return e=this._referenceMap.has(e)?this._referenceMap.get(e):e,2===this.type?this.GetFaceByUUidAndFaceIndexV2(e,t,r):this.GetFaceByUUidAndFaceIndexV1(e,t,r)},t.GetEdgeByUUidAndEdgeIndexV1=function(e,t,r){if(e&&t&&!(r<0)){var i=this.brepInfos[e];if((i=i&&(i.referenceBodyUuid?this.brepInfos[i.referenceBodyUuid]:i))&&i.edgeGroups)for(var n=0,a=i.edgeGroups.length;n<a;n++){var o=i.edgeGroups[n],s=o.meshID;if(t===(s=this.ndsModel?this.ndsModel.meshUuid2GeomUuidMap[s]:s)){var l=o.edges;if(l)for(var d=0,c=l.length;d<c;d++){var h=l[d],u=h.indexRange[0],p=h.indexRange[1];if(u<=r&&r<=p)return Object.assign({},h)}}}}},t.GetEdgeByUUidAndEdgeIndexV2=function(e,t,a){if(e&&t&&!(a<0)&&this.viewer.ndsModel&&this.brepInfos.bodies.has(e)){var r=this.brepInfos.breps[this.brepInfos.bodies.get(e)];if(r.edgeGroups){for(var i=function(e){for(var t=0,r=e.length/2;t<r;++t){var i=e[2*t],n=e[2*t+1];if(i<=a&&a<=n)return t}return-1},n=0,o=r.edgeGroups.length;n<o;n++){var s=this.brepInfos.edgeGroups[r.edgeGroups[n]],l=s.geomUUID;if(t===l){var d,c,h,l=!1,u=void 0;if(s.lines&&-1<(d=i(s.lines.indexRanges))&&(l=!0,u=this.GetEdgeBrepInfo(s,"line",d)),!l&&s.circles&&-1<(d=i(s.circles.indexRanges))&&(l=!0,u=this.GetEdgeBrepInfo(s,"circle",d)),!l&&s.ellipses&&-1<(c=i(s.ellipses.indexRanges))&&(l=!0,u=this.GetEdgeBrepInfo(s,"ellipse",c)),!l&&s.nurbses&&-1<(c=i(s.nurbses.indexRanges))&&(l=!0,u=this.GetEdgeBrepInfo(s,"nurbs",c)),!l&&s.others&&-1<(h=i(s.others.indexRanges))&&(l=!0,u=this.GetEdgeBrepInfo(s,"other",h)),l)return u}}return null}}},t.GetEdgeByUUidAndEdgeIndex=function(e,t,r){if(e&&1==this._hasBrepInfo)return e=this._referenceMap.has(e)?this._referenceMap.get(e):e,2===this.type?this.GetEdgeByUUidAndEdgeIndexV2(e,t,r):this.GetEdgeByUUidAndEdgeIndexV1(e,t,r)},e}(),Mt=function(e){var c=this,s=(this.viewer=e,{}),r=[],i=null,d=new THREE.TextureLoader(new THREE.LoadingManager),h=(d.crossOrigin="anonymous",new ht),u=(h.crossOrigin="anonymous",null),a=!1,n=0;function o(e){var t,r=[];for(t in c.viewer.ndsModel.bodyNodeUUidToMaterial)if(e.uuid==c.viewer.ndsModel.bodyNodeUUidToMaterial[t].uuid){for(var i=c.viewer.ndsModel.getBodyNodeFromUuid(t),n=c.viewer.ndsModel.getLeafBodies(i),a=0;a<n.length;a++){var o=n[a].leafBodyAttri.bodyMeshIds;if(0<o.length)for(var s=0,l=o.length;s<l;++s){var d=c.viewer.ndsModel.meshManager.geomId[o[s]];-1<d&&r.push(c.viewer.ndsModel.geomManager.getGeomFromId(d))}}break}return r}function I(e){var e=e.boundingBox,t=e.min.x,r=e.min.y,i=e.min.z,n=e.max.x,a=e.max.y,e=e.max.z,o=[],n=(o.push(n-t),o.push(a-r),o.push(e-i),o.sort(function(e,t){return e-t}),o[1]);return 6/(n=n<1?1:n)}function l(e){if(null==e.getAttribute("position"))console.log("生成纹理坐标失败，无顶点数据,有可能geometry未加载完！！！");else if(void 0===e.getAttribute("uv"))if(null==e.getAttribute("normal"))console.log("生成纹理坐标失败无法线！！！");else{var a=e,o=1;if(a instanceof THREE.Geometry)a.faceVertexUvs[0]=[],o=I(a),a.faces.forEach(function(r){var e=["x","y","z"].sort(function(e,t){return Math.abs(r.normal[e])-Math.abs(r.normal[t])}),t=a.vertices[r.a],i=a.vertices[r.b],n=a.vertices[r.c];a.faceVertexUvs[0].push([new THREE.Vector2(t[e[0]]*o,t[e[1]]*o),new THREE.Vector2(i[e[0]]*o,i[e[1]]*o),new THREE.Vector2(n[e[0]]*o,n[e[1]]*o)])});else if(o=I(a),a.getAttribute("position")){var t=a.getAttribute("normal"),r=a.getAttribute("position"),i=a.index,n=0;if(i)if(n=3*i.count,d=new Float32Array(8*i.count),r instanceof THREE.InterleavedBufferAttribute)for(var s=0;s<i.count;s++)d[8*s]=r.array[i.array[s]*r.data.stride+r.offset],d[8*s+1]=r.array[i.array[s]*r.data.stride+r.offset+1],d[8*s+2]=r.array[i.array[s]*r.data.stride+r.offset+2],d[8*s+3]=t.array[i.array[s]*t.data.stride+t.offset],d[8*s+4]=t.array[i.array[s]*t.data.stride+t.offset+1],d[8*s+5]=t.array[i.array[s]*t.data.stride+t.offset+2];else for(var l=0;l<i.count;l++)d[8*l]=r.array[3*i.array[l]],d[8*l+1]=r.array[3*i.array[l]+1],d[8*l+2]=r.array[3*i.array[l]+2],d[8*l+3]=t.array[3*i.array[l]],d[8*l+4]=t.array[3*i.array[l]+1],d[8*l+5]=t.array[3*i.array[l]+2];else for(var n=r.count,d=new Float32Array(8*n),c=0;c<n/3;c++)d[8*c]=r.array[3*c],d[8*c+1]=r.array[3*c+1],d[8*c+2]=r.array[3*c+2],d[8*c+3]=t.array[3*c],d[8*c+4]=t.array[3*c+1],d[8*c+5]=t.array[3*c+2];for(var h=n/9,u=[],p=0;p<h;p++){var f=new THREE.Vector3,m=new THREE.Vector3,g=new THREE.Vector3,v=(f.x=d[8*p*3],f.y=d[8*p*3+1],f.z=d[8*p*3+2],m.x=d[8*p*3+8],m.y=d[8*p*3+9],m.z=d[8*p*3+10],g.x=d[8*p*3+16],g.y=d[8*p*3+17],g.z=d[8*p*3+18],new THREE.Vector3),y=new THREE.Vector3,m=(v.subVectors(m,f),y.subVectors(g,f),new THREE.Vector3);m.crossVectors(v,y),u.push(m)}for(var A=new Uint32Array(n/3),M=0;M<n/3;M++){new THREE.Vector3;var E=u[parseInt(M/3)].clone(),w=["x","y","z"].sort(function(e,t){return Math.abs(E[e])-Math.abs(E[t])}),x=new THREE.Vector3;x.x=d[8*M],x.y=d[8*M+1],x.z=d[8*M+2],d[8*M+6]=x[w[0]]*o,d[8*M+7]=x[w[1]]*o,A[M]=M}var e=new THREE.InterleavedBuffer(d,8),b=new THREE.InterleavedBufferAttribute(e,3,0,!1),B=new THREE.InterleavedBufferAttribute(e,3,3,!1),e=new THREE.InterleavedBufferAttribute(e,2,6,!1);a.addAttribute("position",b),a.addAttribute("normal",B),a.addAttribute("uv",e),a.setIndex(new THREE.BufferAttribute(A,1))}}}function p(e,t,r){var i,n,a,o,s,l;-1<(r=De.avoidCaching?r+"?time="+Date.now():r).toLowerCase().indexOf(".tga")?(o=e,s=t,l=r,Ce.TextureLoadingManager.itemStart(),h.load(l,function(e){e.flipY=!0,o[s]=e,o[s].sourceFile=l,o[s].wrapS=THREE.RepeatWrapping,o[s].wrapT=THREE.RepeatWrapping,e.needsUpdate=!0,Ce.TextureLoadingManager.itemEnd(),c.viewer.render()},void 0,function(){o[s]=null,o.needsUpdate=!0,c.viewer.render()})):(i=e,n=t,a=r,d.load(a,function(e){i[n]=e,i[n].sourceFile=a,i[n].wrapS=THREE.RepeatWrapping,i[n].wrapT=THREE.RepeatWrapping,i.needsUpdate=!0,"bumpMap"===n?(i.normalMap=null,u.normalMap=null):"normalMap"===n&&(i.bumpMap=null,u.bumpMap=null),c.viewer.render()},void 0,function(){i.needsUpdate=!0,i[n]=null,c.viewer.render()}))}function f(e,t,r){if(e&&void 0!==r)if(null===r||""===r){if(a)for(var i=o(e),n=0;n<i.length;n++)l(i[n]);e.needsUpdate=!0,e[t]=null}else{for(i=o(e),n=0;n<i.length;n++)l(i[n]);e[t]&&e[t].sourceFile===r&&!a||(e.needsUpdate=!0,p(e,t,r))}}function m(e){return null!=e&&""!==e?!0:!1}function g(e,t){m(t.color)&&e.color.set(t.color),m(t.linewidth)&&(e.linewidth=parseInt(t.linewidth)),m(t.opacity)&&(e.opacity=parseFloat(t.opacity),e.opacity<1?e.transparent=!0:e.transparent=!1)}function v(e,t,r){m(t.color)&&e.color.set(t.color),m(t.specular)&&e.specular.set(t.specular),m(t.emissive)&&e.emissive.set(t.emissive),m(t.skinning)&&(e.skinning=t.skinning),m(t.shininess)&&(e.shininess=parseInt(t.shininess),0==e.shininess?(e.initialSpecular=new THREE.Color,e.initialSpecular.copy(e.specular),e.specular.setRGB(0,0,0)):e.initialSpecular=void 0),m(t.opacity)&&(e.opacity=parseFloat(t.opacity),e.opacity<1?e.transparent=!0:e.transparent=!1),m(t.emissiveIntensity)&&(e.emissiveIntensity=parseFloat(t.emissiveIntensity)),m(t.reflectivity)&&(e.reflectivity=parseFloat(t.reflectivity)),m(t.refractionRatio)&&(e.refractionRatio=parseFloat(t.refractionRatio)),m(t.shading)&&(0==t.shading||2==parseInt(t.shading)?e.flatShading=!1:e.flatShading=!0),m(t.wireframe)&&(e.wireframe=t.wireframe),m(t.doubleSided)&&(t.doubleSided?e.side=THREE.DoubleSide:e.side=THREE.FrontSide),2==r?e.wireframe=!0:(e.wireframe=!1,1==r&&e.specular.setRGB(0,0,0)),m(t.bumpScale)&&(e.bumpScale=t.bumpScale),m(t.normalScale)&&(e.normalScale=new THREE.Vector2(t.normalScale,t.normalScale)),f(e,"map",t.map),f(e,"bumpMap",t.bumpMap),f(e,"normalMap",t.normalMap),f(e,"emissiveMap",t.emissiveMap),f(e,"alphaMap",t.alphaMap),f(e,"specularMap",t.specularMap)}function y(e,t,r){m(t.color)&&e.color.set(t.color),m(t.skinning)&&(e.skinning=t.skinning),m(t.emissive)&&e.emissive.set(t.emissive),m(t.metalness)&&(e.metalness=parseFloat(t.metalness)),m(t.roughness)&&(e.roughness=parseFloat(t.roughness)),m(t.opacity)&&(e.opacity=parseFloat(t.opacity),e.opacity<1?e.transparent=!0:e.transparent=!1),m(t.emissiveIntensity)&&(e.emissiveIntensity=parseFloat(t.emissiveIntensity)),m(t.envMapIntensity)&&(e.envMapIntensity=parseFloat(t.envMapIntensity)),m(t.refractionRatio)&&(e.refractionRatio=parseFloat(t.refractionRatio)),m(t.shading)&&(0==t.shading||2==parseInt(t.shading)?e.flatShading=!1:e.flatShading=!0),m(t.wireframe)&&(e.wireframe=t.wireframe),m(t.doubleSided)&&(t.doubleSided?e.side=THREE.DoubleSide:e.side=THREE.FrontSide),e.wireframe=2==r,m(t.bumpScale)&&(e.bumpScale=t.bumpScale),m(t.normalScale)&&(e.normalScale=new THREE.Vector2(t.normalScale,t.normalScale)),f(e,"map",t.map),f(e,"bumpMap",t.bumpMap),f(e,"normalMap",t.normalMap),f(e,"emissiveMap",t.emissiveMap),f(e,"alphaMap",t.alphaMap),f(e,"metalnessMap",t.metalnessMap),f(e,"roughnessMap",t.roughnessMap)}function A(e){var t,r=["map","bumpMap","normalMap","emissiveMap","alphaMap","specularMap","metalnessMap","roughnessMap"];for(t in r){var i,n=e[r[t]];!n||(i=!1,i=0<=n.indexOf("/")||i)||(i=function(e){var t=e;if(c.viewer.trueMapList)for(var r in c.viewer.trueMapList)if(e.toLowerCase()===c.viewer.trueMapList[r].toLowerCase()){t=c.viewer.trueMapList[r];break}return t}(n),e[r[t]]=(1===(n=(n=c.viewer.modelInfo[c.viewer.modelInfo.length-1].url).split("/")).length?"./":(n.pop(),n.join("/")+"/"))+i)}}function M(e,t,r,i){e[t]&&e[t].sourceFile===r&&((r={uuid:e.uuid})[t]=null,c.updateMaterialInfo(r,i),c.viewer.render())}function E(e,t,r){e[t]&&e[t]===r&&(e[t]=null)}function w(e,t,r){t[r]&&!function(e,t){for(var r=!1,i=0;i<e.length;i++)if(e[i]===t){r=!0;break}return r}(e,t=t[r].sourceFile)&&e.push(t)}this.setForceUpdateTex=function(e){a=e},this.getMaterialsMarkersMat=function(){return i},this.setMaterialsMarkersMat=function(e){i=e},this.setMaterialsMarkers=function(e){r=e},this.cleanMaterialsMarkers=function(){for(var e=0;e<r.length;e++){var t=r[e];t.parent.remove(t.marker)}r=[],i=null},this.forceUpdateAllMats=function(){c.setForceUpdateTex(!0);var e=c.getMaterialsInfo();c.updateAllMateriaslInfo(e,c.viewer.getRenderMode()),c.setForceUpdateTex(!1)},this.updateAllMateriaslInfo=function(e,t,r){if(e){var i,n,a=function(e){var t=null;if(e&&e.materials)for(var r in e.materials){r=e.materials[r];if("MeshPhongMaterial"===r.type){t=r.type;break}if("MeshStandardMaterial"===r.type){t=r.type;break}}return t}(e);for(n in a!==function(){var e,t=null;for(e in s){var r=s[e];if(r instanceof THREE.MeshPhongMaterial){t="MeshPhongMaterial";break}if(r instanceof THREE.MeshStandardMaterial){t="MeshStandardMaterial";break}}return t}()&&(i=c.getMaterialsInfo(),c.viewer.convertAllMaterialsInfo(i,a)),e.materials)c.updateMaterialInfo(e.materials[n],t,r)}c.removeAllObjectMaterials()},this.removeAllObjectMaterials=function(){this.viewer.ndsModel.removeAllBodyNodeMaterials()},this.removeObjectMaterial=function(e){this.viewer.ndsModel.removeBodyNodeMaterial(e)},this.getObjectMaterialInfo=function(e){var t,r;return this.viewer.ndsModel.bodyNodeUUidToMaterial[e]?(t=this.viewer.ndsModel.bodyNodeUUidToMaterial[e],s[t.uuid]=t):(e=this.viewer.ndsModel.getBodyNodeFromUuid(e),r=this.viewer.ndsModel.getLeafBodies(e)[0].leafBodyAttri.bodyMeshIds[0],r=this.viewer.ndsModel.meshManager.materialId[r],r=this.viewer.ndsModel.meshManager.materialUuids[r],(r=s[r])instanceof THREE.MeshPhongMaterial?t=new THREE.MeshPhongMaterial:r instanceof THREE.MeshStandardMaterial&&(t=new THREE.MeshStandardMaterial),t.uuid=t.uuid.replaceAll("-",""),t.uuid=t.uuid.toLowerCase(),t.copy(r),s[t.uuid]=t,this.viewer.ndsModel.setBodyNodeMaterial(e.uuid,t)),this.materialToJson(t)},this.getBodyNodeMaterialsInfo=function(){var e,t=this.viewer.ndsModel.getBodyNodeUUidToMaterial(),r={};for(e in t)r[e]=this.materialToJson(t[e]);return r},this.autoCreateMaterial=function(e){var t;return"MeshPhongMaterial"==e?t=new THREE.MeshPhongMaterial:"MeshStandardMaterial"==e&&(t=new THREE.MeshStandardMaterial),t.uuid=t.uuid.replaceAll("-",""),t.uuid=t.uuid.toLowerCase(),t},this.randColor=function(){var e=[Math.floor(240*Math.random()+15),Math.floor(240*Math.random()+15),Math.floor(240*Math.random()+15)];return 65536*e[0]+256*e[1]+e[2]},this.autoSetBodyNodeMaterial=function(e){for(var e=this.viewer.ndsModel.getBodyNodeFromUuid(e),t=this.viewer.ndsModel.getLeafBodies(e),r=0;r<t.length;r++){var i=void 0;(i=t[r].useBodyNodeMaterial?this.viewer.ndsModel.bodyNodeUUidToMaterial[t[r].uuid]:this.autoCreateMaterial("MeshStandardMaterial")).color.set(this.randColor()),i.needsUpdate=!0,s[i.uuid]=i,this.viewer.ndsModel.setBodyNodeMaterial(t[r].uuid,i)}this.viewer.render()},this.updateMaterialInfo=function(e,t,r){if(A(e),u=e,r){var i,n=e,a=["map","bumpMap","normalMap","emissiveMap","alphaMap","specularMap","metalnessMap","roughnessMap"];for(i in a)void 0===n[a[i]]&&(n[a[i]]=null)}e&&e.uuid&&(r=s[e.uuid])&&(r instanceof THREE.LineBasicMaterial?g(r,e):r instanceof THREE.MeshPhongMaterial?v(r,e,t):r instanceof THREE.MeshStandardMaterial&&y(r,e,t),r.needsUpdate=!0),c.viewer.render()},this.initMaterialsInfo=function(e){for(var t in e){var r=e[t];0<r.refCount&&(r.mat.wireframe=!1,s[t]=r.mat)}},this.removeMap=function(e,t,r){if(null==e||""===e)return!1;for(var i in e=e.replace(/ /g,"%20"),s){i=s[i];i.needsUpdate=!0,M(i,"map",e,r),M(i,"bumpMap",e,r),M(i,"normalMap",e,r),M(i,"emissiveMap",e,r),M(i,"alphaMap",e,r),M(i,"specularMap",e,r),M(i,"roughnessMap",e,r),M(i,"metalnessMap",e,r)}if(t){var n,a=e,o=t;for(n in o.materials){n=o.materials[n];E(n,"map",a),E(n,"bumpMap",a),E(n,"normalMap",a),E(n,"emissiveMap",a),E(n,"alphaMap",a),E(n,"specularMap",a),E(n,"roughnessMap",a),E(n,"metalnessMap",a),E(n,"specularMapOld",a),E(n,"roughnessMapOld",a),E(n,"metalnessMapOld",a)}}return!0},this.isMapWorking=function(e){for(var t=!1,r=(e=e.replace(/ /g,"%20"),c.getMapList()),i=0;i<r.length;i++)if(e===r[i]){t=!0;break}return t},this.getMapList=function(){var e,t=[];for(e in s){var r=s[e];w(t,r,"map"),w(t,r,"bumpMap"),w(t,r,"normalMap"),w(t,r,"emissiveMap"),w(t,r,"alphaMap"),w(t,r,"specularMap"),w(t,r,"roughnessMap"),w(t,r,"metalnessMap")}return t},this.getMaterialIndex=function(e){var t,r=[],i=-1;for(t in s)r.push(s[t]);for(var n=0,a=r.length;n<a;n++)if(r[n].uuid===e.uuid){i=n;break}return i},this.getMaterialsInfo=function(){var e,t={materials:[]};for(e in n=0,s){var r=this.materialToJson(s[e]);t.materials.push(r)}return t},this.materialToJson=function(e){var t,r,i={};return e instanceof THREE.LineBasicMaterial?i={version:"1.00",name:(r=e).name,type:r.type,uuid:r.uuid,color:r.color.getHex(),linewidth:r.linewidth,opacity:r.opacity}:e instanceof THREE.MeshPhongMaterial?(t={version:"1.00",name:(r=e).name,type:r.type,uuid:r.uuid,doubleSided:r.side===THREE.DoubleSide,shininess:r.shininess,reflectivity:r.reflectivity,refractionRatio:r.refractionRatio,opacity:r.opacity,color:r.color.getHex(),specular:r.specular.getHex(),emissive:r.emissive.getHex(),emissiveIntensity:r.emissiveIntensity,shading:r.flatShading,wireframe:r.wireframe,skinning:r.skinning},r.map?t.map=r.map.sourceFile:t.map=null,r.bumpMap?(t.bumpMap=r.bumpMap.sourceFile,t.bumpScale=r.bumpScale):(t.bumpScale=r.bumpScale,t.bumpMap=null),r.normalMap?t.normalMap=r.normalMap.sourceFile:t.normalMap=null,t.normalScale=r.normalScale.x,r.emissiveMap?t.emissiveMap=r.emissiveMap.sourceFile:t.emissiveMap=null,r.alphaMap?t.alphaMap=r.alphaMap.sourceFile:t.alphaMap=null,r.specularMap?t.specularMap=r.specularMap.sourceFile:t.specularMap=null,i=t):e instanceof THREE.MeshStandardMaterial&&(e={version:"1.00",name:(t=e).name,type:t.type,uuid:t.uuid,doubleSided:t.side===THREE.DoubleSide,envMapIntensity:t.envMapIntensity,refractionRatio:t.refractionRatio,opacity:t.opacity,color:t.color.getHex(),emissive:t.emissive.getHex(),emissiveIntensity:t.emissiveIntensity,shading:t.flatShading,roughness:t.roughness,metalness:t.metalness,wireframe:t.wireframe,skinning:t.skinning},t.map?e.map=t.map.sourceFile:e.map=null,t.bumpMap?e.bumpMap=t.bumpMap.sourceFile:e.bumpMap=null,e.bumpScale=t.bumpScale,t.normalMap?e.normalMap=t.normalMap.sourceFile:e.normalMap=null,e.normalScale=t.normalScale.x,t.emissiveMap?e.emissiveMap=t.emissiveMap.sourceFile:e.emissiveMap=null,t.alphaMap?e.alphaMap=t.alphaMap.sourceFile:e.alphaMap=null,t.metalnessMap?e.metalnessMap=t.metalnessMap.sourceFile:e.metalnessMap=null,t.roughnessMap?e.roughnessMap=t.roughnessMap.sourceFile:e.roughnessMap=null,i=e),""===i.name&&(i.name="Material_"+n.toString(),++n),i},this.jsonToMaterial=function(e){var t;return"LineBasicMaterial"==e.type?g(t=new THREE.LineBasicMaterial,e):"MeshPhongMaterial"==e.type?v(t=new THREE.MeshPhongMaterial,e):"MeshStandardMaterial"==e.type&&y(t=new THREE.MeshStandardMaterial,e),t.uuid=e.uuid,t},this.convertMaterialInfo=function(e,t,r){var i,n,a={matJson:null,matObj:null};return null!=e&&null!=t&&e.type!=t&&"LineBasicMaterial"!=e.type&&(i=s[e.uuid],n={},"MeshPhongMaterial"==t?(a.matObj=new THREE.MeshPhongMaterial,n={version:"1.00",name:e.name,type:"MeshPhongMaterial",uuid:e.uuid,doubleSided:e.doubleSided,reflectivity:e.envMapIntensity,refractionRatio:e.refractionRatio,opacity:e.opacity,color:e.color,skinning:e.skinning,emissive:e.emissive,emissiveIntensity:e.emissiveIntensity,shading:e.shading,wireframe:e.wireframe,roughnessOld:e.roughness,metalnessOld:e.metalness,metalnessMapOld:e.metalnessMap,roughnessMapOld:e.roughnessMap},null!=e.specularOld?n.specular=e.specularOld:n.specular=a.matObj.specular.getHex(),null!=e.shininessOld?n.shininess=e.shininessOld:n.shininess=a.matObj.shininess,e.map&&(n.map=e.map),e.bumpMap&&(n.bumpMap=e.bumpMap),e.bumpScale&&(n.bumpScale=e.bumpScale),e.normalMap&&(n.normalMap=e.normalMap),e.normalScale&&(n.normalScale=e.normalScale),e.emissiveMap&&(n.emissiveMap=e.emissiveMap),e.alphaMap&&(n.alphaMap=e.alphaMap),e.specularMapOld?n.specularMap=e.specularMapOld:n.specularMap=null):"MeshStandardMaterial"==t&&(a.matObj=new THREE.MeshStandardMaterial,n={version:"1.00",name:e.name,type:"MeshStandardMaterial",uuid:e.uuid,doubleSided:e.doubleSided,envMapIntensity:e.reflectivity,refractionRatio:e.refractionRatio,opacity:e.opacity,color:e.color,skinning:e.skinning,emissive:e.emissive,emissiveIntensity:e.emissiveIntensity,shading:e.shading,wireframe:e.wireframe,specularOld:e.specular,shininessOld:e.shininess,specularMapOld:e.specularMap},null!=e.roughnessOld?n.roughness=e.roughnessOld:n.roughness=a.matObj.roughness,null!=e.metalnessOld?n.metalness=e.metalnessOld:n.metalness=a.matObj.metalness,e.map&&(n.map=e.map),e.bumpMap&&(n.bumpMap=e.bumpMap),e.bumpScale&&(n.bumpScale=e.bumpScale),e.normalMap&&(n.normalMap=e.normalMap),e.normalScale&&(n.normalScale=e.normalScale),e.emissiveMap&&(n.emissiveMap=e.emissiveMap),e.alphaMap&&(n.alphaMap=e.alphaMap),e.metalnessMapOld?n.metalnessMap=e.metalnessMapOld:n.metalnessMap=null,e.roughnessMapOld?n.roughnessMap=e.roughnessMapOld:n.roughnessMap=null),i.map&&(a.matObj.map=i.map),i.bumpMap&&(a.matObj.bumpMap=i.bumpMap,a.matObj.bumpScale=i.bumpScale),i.normalMap&&(a.matObj.normalMap=i.normalMap,a.matObj.normalScale=i.normalScale),i.emissiveMap&&(a.matObj.emissiveMap=i.emissiveMap),i.alphaMap&&(a.matObj.alphaMap=i.alphaMap),i.envMap&&(a.matObj.envMap=i.envMap),a.matObj.name=e.name,a.matObj.uuid=e.uuid,s[e.uuid]=a.matObj,a.matJson=n,c.updateMaterialInfo(n,r)),a}},Et=function(e){this.isModelBvh=!0,this.version=0,this.parent=-1,this.bboxes=[],this.leftChild=[],this.nMeshes=[],this.startMesh=[],this.nLines=null,this.startLine=null,this.nTexts=null,this.startText=null,this.nNodes=0,this.meshIds=[],this.lineIds=null,this.textIds=null,this.meshManager=e,this.nodeId2MeshSetIdMap={}};function wt(e,t){return(wt=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}Et.prototype={constructor:Et,setNumNodes:function(e){this.nNodes=e,this.bboxes=new Float32Array(6*e),this.leftChild=new Int32Array(e),this.nMeshes=new Int32Array(e),this.startMesh=new Int32Array(e),4===this.version&&(this.nLines=new Int32Array(e),this.startLine=new Int32Array(e),this.nTexts=new Int32Array(e),this.startText=new Int32Array(e))},setNode:function(e,t,r,i,n,a,o,s,l){for(var d=0,d=0;d<6;++d)this.bboxes[6*e+d]=t[d];this.leftChild[e]=r,this.nMeshes[e]=i,this.startMesh[e]=n,this.nLines&&void 0!==a&&(this.nLines[e]=a,this.startLine[e]=o),this.nTexts&&void 0!==s&&(this.nTexts[e]=s,this.startText[e]=l)},buildMeshSets:function(){var e=[],t=0;if(4===this.version)for(t=0;t<this.nNodes;++t)(0<this.nMeshes[t]||0<this.nLines[t]||0<this.nTexts[t])&&(e.push(new nt(this,t)),this.nodeId2MeshSetIdMap[t]=e.length-1);else for(t=0;t<this.nNodes;++t)-1===this.leftChild[t]&&(e.push(new nt(this,t)),this.nodeId2MeshSetIdMap[t]=e.length-1);return e},getNodeBox:function(e,t){t=t||new THREE.Box3;return t.min.fromArray(this.bboxes,6*e),t.max.fromArray(this.bboxes,6*e+3),t},setMeshIds:function(e){this.meshIds=e},getNumMeshes:function(e){return this.nMeshes[e]},getMesh:function(e,t){e=this.startMesh[e]+t,t=this.meshIds?this.meshIds[e]:e;return this.meshManager.getMesh(t)},getMeshId:function(e,t){e=this.startMesh[e]+t;return this.meshIds?this.meshIds[e]:e},getNumTexts:function(e){return this.nTexts?this.nTexts[e]:-1},getTextId:function(e,t){return this.startText[e]+t},getText:function(e,t){return this.startText?(e=this.startText[e]+t,this.meshManager.getText(e)):null},getNumLineSegments:function(e){return this.nLines?this.nLines[e]:-1},getLineSegmentsId:function(e,t){return this.startLine[e]+t},getLineSegmentsWithState:function(e,t,r,i){return this.startLine?(e=this.startLine[e]+t,this.meshManager.getLineSegmentsWithState(e,r,i)):{state:-1,lineSegments:null}},getLineSegments:function(e,t,r,i){e=this.getLineSegmentsWithState(e,t,r,i);return 1===e.state?e.lineSegments:null},intersect:function(e){var t,r,i=[0],n=new THREE.Box3,a=[];if(0<this.nNodes)for(var o=0;o<i.length;++o)t=i[o],n.min.fromArray(this.bboxes,6*t),n.max.fromArray(this.bboxes,6*t+3),(this.meshManager.ndsModel.hasDraggedBodies()||1e-10<Math.abs(this.meshManager.ndsModel.explodeFactor)||1e-10<Math.abs(this.meshManager.ndsModel.explodeFactorX)||1e-10<Math.abs(this.meshManager.ndsModel.explodeFactorY)||1e-10<Math.abs(this.meshManager.ndsModel.explodeFactorZ)||De.MatrixChange||De.inBIMContext||De.ScenarioEditor||De.AnimationEdit||e.intersectsBox(n))&&(0<this.nMeshes[t]&&void 0!==(r=this.nodeId2MeshSetIdMap[t])&&a.push(r),-1!==this.leftChild[t])&&(i.push(this.leftChild[t]),i.push(this.leftChild[t]+1));return a}};var xt=function(n){function e(){var e=n.call(this)||this;return e.isLineGeometry=!0,e.type="LineGeometry",e}t=n,(r=e).prototype=Object.create(t.prototype),wt(r.prototype.constructor=r,t);var t,r=e.prototype;return r.setPositions=function(e){for(var t=e.length-3,r=new Float32Array(2*t),i=0;i<t;i+=3)r[2*i]=e[i],r[2*i+1]=e[i+1],r[2*i+2]=e[i+2],r[2*i+3]=e[i+3],r[2*i+4]=e[i+4],r[2*i+5]=e[i+5];return n.prototype.setPositions.call(this,r),this},r.setColors=function(e){for(var t=e.length-3,r=new Float32Array(2*t),i=0;i<t;i+=3)r[2*i]=e[i],r[2*i+1]=e[i+1],r[2*i+2]=e[i+2],r[2*i+3]=e[i+3],r[2*i+4]=e[i+4],r[2*i+5]=e[i+5];return n.prototype.setColors.call(this,r),this},r.fromLine=function(e){e=e.geometry;return this.setPositions(e.attributes.position.array),this},e}(Xe);function bt(e,t){return(bt=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}var Bt,Tt=function(r){function e(e,t){return void 0===e&&(e=new xt),void 0===t&&(t=new qe({color:16777215*Math.random()})),(e=r.call(this,e,t)||this).isLine2=!0,e.type="Line2",e}var t,i;return i=r,(t=e).prototype=Object.create(i.prototype),bt(t.prototype.constructor=t,i),e}(Ke),St=function(e,t,r,i){this.manager=e||THREE.DefaultLoadingManager,this.loader=null,this.linkMap={},this.linkWaitingArray={},this.linkDoneMap={},this.treeIndex=1e4,this.ndsModel=i,this.viewer=r,this.chunkRequestsTextNum=0,this.chunkRequestQueue=[],this.pmiChunkRequestQueue=[],this.maxRequestNum=7,(Pe.isIOSDevice()||Pe.isIpadDevice())&&(this.maxRequestNum=4),this.loadCanceled=!1,this.chunkRequestFiredNum=0,this.SDFMaker=t,this.geometryTOchild={},this.fixedPmiNum=0,this.referenceMap=new Map,r.SDFMaker=this.SDFMaker},Rt=(St.numObject=0,St.prototype={constructor:St,getRefUUID:function(e,t){return t&&0<t?e+"_"+t:e},parse:function(e,t,r,i,n,a,o){this.treeIndex=1e4;var s=this;if(this.ndsBinParser=new $({objectIdType:e.objectIdType,materialIdType:e.materialIdType,geomIdType:e.geomIdType,instanceIdType:e.instanceIdType}),s.viewer.materialIdType=e.materialIdType,s.viewer.objectIdType=e.objectIdType,s.viewer.modelContentVersion=e.modelContentVersion||1,e.sceneInfo&&s.viewer.ndsModel.models.length<=1&&!s.viewer.sceneInfo&&(s.viewer.sceneInfo=e.sceneInfo,s.viewer.sceneInfo.setScene=!0,De.AnimationEdit)&&(s.viewer.sceneInfo.renderMode=5,s.viewer.sceneInfo.cameraInfo)&&(s.viewer.sceneInfo.cameraInfo.isPerspective=!1),e.fileID){var l=e.fileID.slice(4);s.viewer.watermark="";for(var d=0;d<l.length/4;d++){var c=l.slice(4*d,4*(d+1));s.viewer.watermark+=String.fromCharCode(parseInt(c,16))}"Viewer版本过低，请升级"==s.viewer.watermark&&(s.viewer.watermark=null)}1==e.persistentId&&(s.viewer.HasPersistentId=!0),e.metadata&&e.metadata.format&&""!=e.metadata.format&&(s.viewer.ModelFormat=e.metadata.format),s.viewer.cameraInfoFile=e.cameraInfo,s.viewer.cameraInfoFile&&(s.viewer.cameraInfoFile.hasSet=!1);var h,u,p,f=s.parseModelContent(e.modelContent,t),m=null,g=!1,v=!!s.ndsModel.sptIndex,y=(e.bvhData?(s.viewer.modelneedLoad=!1,s.ndsModel.is2DModel=s.viewer.is2DModel,y={bvh:v?new Et(s.ndsModel.meshManager):null,meshManager:s.ndsModel.meshManager,worldMatrix:f.bodyNodeRoot.worldMatrix,refModelContext:t.refModelContext,numRef:t.numRef},s.ndsBinParser.parseBvh(e.bvhData,y,null),y.bvhVersion&&4<=y.bvhVersion&&(s.ndsModel.geomManager.enableMergeGeomChunk=!0),v&&(m=s.ndsModel.sptIndex.mergeSubTree(t.parentSptIndexNode,y.bvh)),g=!0):v&&(m=s.ndsModel.sptIndex.mergeSubTree(t.parentSptIndexNode,new at(null,null))),f.sptIndexRoot=m,t.basUri),v=!1,y=(e.pmiContent&&t.needsPMI&&(s.viewer.is2DModel?s.SDFMaker.CreateMaterial(e.pmiContent,1,s.viewer.modelContentVersion):s.SDFMaker.CollectCharSet(e.pmiContent),m=s.parseModelContentInner({loadingPmi:!0,basUri:t.basUri,refModelContext:t.refModelContext,numRef:t.numRef},e.pmiContent),f.pmiObjectRoot=m.objectRoot,v=!0),e.brepMemory&&t.needsBRep&&(s.viewer.brepMemory+=e.brepMemory),e.external&&t.needsSketchModel&&e.external.url.includes("../")&&(m=y.replace(/\/[^\/]+\/$/,"/")+e.external.url.split("../")[1],h=s.viewer.ndsModel.getModelById(t.modelId))&&(h.sketchFileUrl.push(m),t.parentNode?h.sketchFileBindNodeuuid.push(t.parentNode.uuid):h.sketchFileBindNodeuuid.push(-1)),1==s.viewer.ndsModel.models.length&&(e.animationFile&&t.needsAnimation?(e.animationFileData&&e.animationFileData.deformationShapes&&(e.animationMorphAttri=s.parseMorphAnimation(e.animationMorphData)),s.viewer.animationParams={relativePath:y,jsonMain:e},m=s.viewer.getExtension("NDSAnimationExtension"),(s.viewer.AnimationExtension=m)&&(m.animationData=e.animationFileData,m.relativePath=y,m.animationMorphAttri=e.animationMorphAttri,s.viewer.dispatchAsyncEvent({type:"AnimationLoaded",data:e.animationFileData}))):(s.viewer.animationParams=null,s.viewer.dispatchAsyncEvent({type:"NoAnimationLoaded"}))),null!=e.modelBrepData&&null!=e.modelBrepData&&t.needsBRep&&(h=y+e.modelBrepData,m=s.viewer.ndsModel.getModelById(t.refModelContext.modelId),null==s.ndsModel.brepManager&&(s.ndsModel.brepManager=t.modelRequestor.createBrepManager(s.viewer,t.modelRequestor,m)),"modelBrep.js.gz"==e.modelBrepData&&(s.ndsModel.brepManager.type=0),s.ndsModel.brepManager.addBrepFileUrl(h,t.modelId),De.enablePreSelectBrep||s.viewer.loadbrepDefault||De.ScenarioEditor||s.viewer.is2DModel)&&s.viewer.loadBrepInfo(!1),s.viewer.loadParams.get(t.modelUri));if(null!==s.viewer.Euler||!e.xyDirection||e.sceneInfo||y&&y[y.length-1]&&(y[y.length-1].position||y[y.length-1].matrix)||(m=e.xyDirection[0],h=e.xyDirection[1],2==m?De.modelUpDirection="posx":2==h?De.modelUpDirection="posy":3==m?De.modelUpDirection="negx":3==h?De.modelUpDirection="negy":1==h&&5==m?De.modelUpDirection="posz":0==h&&5==m?De.modelUpDirection="negz":5==h&&0==m&&(De.modelUpDirection="posz1")),void 0===f.bodyNodeRoot.area&&e.productData||s.viewer.useProductData?(s.viewer.useProductData=!0,u={},y=e.productData,p=t.numRef,function e(t){var r,i;if(t.uuid&&(r={area:t.area,volume:t.volume},i=s.getRefUUID(t.uuid,p),u[i]=r),0<t.children.length)for(var n=0;n<t.children.length;++n)e(t.children[n])}(y.datas[0].modelTree),function e(t){var r=u[t.uuid];t.area=r?r.area:0,t.volume=r?r.volume:0;for(var i=0;i<t.children.length;++i)e(t.children[i])}(f.bodyNodeRoot)):void 0!==f.bodyNodeRoot.area||s.viewer.is2DModel||s.viewer.loadBrepInfo(!1),e.productData&&e.productData.datas[0].matrixs){s.viewer.productDataMatrixMap||(s.viewer.productDataMatrixMap={}),s.viewer.productDataMatrixMapBuild=void 0;var A=e.productData.datas[0].matrixs;if(A)for(var M=0;M<A.length;M++){var E=s.getRefUUID(A[M].name,t.numRef);s.viewer.productDataMatrixMap[E]=A[M].matrix}}return s.viewer.is2DModel&&(s.ndsModel.modelObjectsData=e.modelObjectsData?s.ndsBinParser.readModelObjects(e.modelObjectsData):null),{rootObject:f,hasBVH:g,hasPMI:v,binResquester:{chunkRequests:s.chunkRequestQueue,pmiGeomRequests:s.pmiChunkRequestQueue,chunkRequestsTextNum:s.chunkRequestsTextNum}}},parseModelContent:function(e,t){var r,i=this;if(e.uv&&(i.SDFMaker.SetVersion(i.viewer.modelContentVersion),i.SDFMaker.CreateMaterial(e.uv,i.viewer.modelContentVersion,i.viewer.modelContentVersion),3<i.viewer.modelContentVersion?i.SDFMaker.MeshTextSetData(e.shxData,e.ttfData):(r=null,e.uvData&&(r=i.ndsBinParser.readTexture(e.uvData,null,i.viewer.modelContentVersion)),i.SDFMaker.OldTextSetData(e.shxData,r,i.viewer.modelContentVersion))),i.viewer.modelUnit||(i.viewer.modelUnit=e.unit),e.dwgScale?i.viewer.dwgScale=e.dwgScale:i.viewer.dwgScale=[1,1],e.viewprots){i.viewer.viewprots=[];for(var n=0;n<e.viewprots.length;n++){var a=(new THREE.Matrix4D).fromArray(e.viewprots[n].matrix),o=new THREE.Vector3,s=new THREE.Quaternion,l=new THREE.Vector3;a.decompose(o,s,l),i.viewer.viewprots.push({id:e.viewprots[n].id,matrix:a.invert(),box:(new THREE.Box3).setFromArray(e.viewprots[n].contours),scale:l.x})}}else i.viewer.viewprots&&delete i.viewer.viewprots;return e.blockTable?i.viewer.blockInfo={process:!1,blockTable:e.blockTable}:i.viewer.blockInfo&&delete i.viewer.blockInfo,t.materialsSetting&&(e.materials=t.materialsSetting.materials),i.parseModelContentInner({loadingPmi:!1,basUri:t.basUri,parentNode:t.parentNode,numRef:t.numRef,refModelContext:t.refModelContext,hasRefModel:t.hasRefModel},e)},setCrossOrigin:function(e){this.crossOrigin=e},extractUrlBase:function(e){e=e.split("/");return 1===e.length?"./":(e.pop(),e.join("/")+"/")},checkGeometries:function(e,t){if(this.needsTangents(t))for(var r=0,i=e.length;r<i;r++)e[r].computeTangents()},needsTangents:function(e){for(var t in e)if(e[t].mat instanceof THREE.ShaderMaterial)return!0;return!1},parseMorphing:function(e,t){if(t instanceof THREE.Geometry){if(null!=e.morphTargets&&0<e.morphTargets.length){this.viewer.animationsManager.bHasMorph=!0;for(var r=0,i=e.morphTargets.length;r<i;r++){t.morphTargets[r]={},t.morphTargets[r].name=e.morphTargets[r].name,t.morphTargets[r].vertices=[];for(var n=t.morphTargets[r].vertices,a=0,o=(c=e.morphTargets[r].vertices).length;a<o;a+=3){var s=new THREE.Vector3;s.x=+c[a],s.y=+c[a+1],s.z=+c[a+2],n.push(s)}}}}else if(t instanceof THREE.BufferGeometry&&null!=e.morphTargets&&0<e.morphTargets.length){this.viewer.animationsManager.bHasMorph=!0;var l=e.morphTargets.length,d=[];t.morphAttributes.position=d;for(r=0;r<l;r++){var c=e.morphTargets[r].vertices,h=new THREE.Float32BufferAttribute(c.length,3);h.name=e.morphTargets[r].name,d.push(h.copyArray(c))}}},parseGeometry:function(e){},parseTexGeometry:function(e){var t={size:e.textFont.size,height:0,weight:e.textFont.weight,font:this.viewer.fontsManager.Fonts.default,style:e.textFont.style,bevelEnabled:!1,curveSegments:12,steps:1},e=(0==t.size&&(t.size=1),e.isChina&&(t.font=this.viewer.fontsManager.Fonts.simfang),new THREE.TextBufferGeometry(e.text,t));return e.type="TextBufferGeometry",e},parseSDFTextGeometry:function(e,t,O,r,i,n,a,o){void 0===n&&(n=!1),void 0===a&&(a=!1),void 0===o&&(o=!1);for(var s=0,l=0,a=null,d=this.SDFMaker.GetMaterialStyleId(e.textFont.style,e.textFont.weight),c=this.SDFMaker.RegText(e.text),o=(e.text=c.text,e.text.length),h=this.SDFMaker.textCompositeStride,u=this.SDFMaker.getTextGeometryBuffer(d,o),p=(u.compositeIBuffer,u.compositePositionAttrib),f=u.compositeColorAttrib,m=u.compositeUvAttrib,g=u.compositeTextureAttrib,v=u.index.array,F=4*o*this.SDFMaker.textCompositeStride,y=u.bufferOffset,A=6*o,M=u.indexOffset,E=4*o,w=y/this.SDFMaker.textCompositeStride,U=(u.bufferOffset+=F,u.indexOffset+=A,0),x=0;x<e.text.length;x++){var b=e.text[x];if(!(P=this.SDFMaker.GetDimensionsForSize(b,e.textFont.size,d,e.textFont.name,e.textFont.width,e.textFont.bigName)))return null;U+=P.width}for(var B,I,T,S=1,o=(e.textLength&&(S=e.textLength/U),new THREE.Euler),R=new THREE.Matrix4,C=new THREE.Vector3,D=new THREE.Box3,N=[],x=0;x<e.text.length;x++){var P,H=new THREE.Box3,b=e.text[x];if(!(P=this.SDFMaker.GetDimensionsForSize(b,e.textFont.size,d,e.textFont.name,e.textFont.width,e.textFont.bigName)))return null;(c.superscript&&x>=c.superscriptbegin&&x<=c.superscriptend||c.subscript&&x>=c.subscriptbegin&&x<=c.subscriptend)&&(P.height*=.5,P.width*=.5),P.height*=S,P.width*=S;var _=P.height*this.SDFMaker.GetTextOffset(b,e.textFont.name),V=(c.superscript&&x>=c.superscriptbegin&&x<=c.superscriptend&&(_-=P.height),l<P.height-_&&(l=P.height-_),p.array[y+36*x]=s,p.array[y+36*x+1]=P.height-_,p.array[y+36*x+2]=0,f.array[y+36*x+3]=r.r,f.array[y+36*x+4]=r.g,f.array[y+36*x+5]=r.b,m.array[y+36*x+6]=P.left,m.array[y+36*x+7]=P.top,g.array[y+36*x+8]=P.textureid,p.array[y+36*x+9]=s+P.width,p.array[y+36*x+10]=P.height-_,p.array[y+36*x+11]=0,f.array[y+36*x+12]=r.r,f.array[y+36*x+13]=r.g,f.array[y+36*x+14]=r.b,m.array[y+36*x+15]=P.right,m.array[y+36*x+16]=P.top,g.array[y+36*x+17]=P.textureid,p.array[y+36*x+18]=s,p.array[y+36*x+19]=-_,p.array[y+36*x+20]=0,f.array[y+36*x+21]=r.r,f.array[y+36*x+22]=r.g,f.array[y+36*x+23]=r.b,m.array[y+36*x+24]=P.left,m.array[y+36*x+25]=P.bottom,g.array[y+36*x+26]=P.textureid,p.array[y+36*x+27]=s+P.width,p.array[y+36*x+28]=-_,p.array[y+36*x+29]=0,f.array[y+36*x+30]=r.r,f.array[y+36*x+31]=r.g,f.array[y+36*x+32]=r.b,m.array[y+36*x+33]=P.right,m.array[y+36*x+34]=P.bottom,g.array[y+36*x+35]=P.textureid,v[M+6*x]=w+4*x,v[M+6*x+1]=w+4*x+2,v[M+6*x+2]=w+4*x+1,v[M+6*x+3]=w+4*x+2,v[M+6*x+4]=w+4*x+3,v[M+6*x+5]=w+4*x+1,new THREE.Vector3(s,P.height-_,0)),G=new THREE.Vector3(s+P.width,P.height-_,0),k=new THREE.Vector3(s,-_,0),_=new THREE.Vector3(s+P.width,-_,0);s+=P.width,D.expandByPoint(V),D.expandByPoint(G),D.expandByPoint(k),D.expandByPoint(_),H.expandByPoint(V),H.expandByPoint(G),H.expandByPoint(k),H.expandByPoint(_),N.push(H)}if(this.viewer.is2DModel){if(o.setFromQuaternion(O),this.viewer.modelContentVersion<2){R.identity(),R.makeRotationFromEuler(o),R.setPosition(t);for(var L=0;L<E;++L)C.x=p.array[y+L*h],C.y=p.array[y+L*h+1],C.z=p.array[y+L*h+2],C.applyMatrix4(R),p.array[y+L*h]=C.x,p.array[y+L*h+1]=C.y,p.array[y+L*h+2]=C.z;this.SDFMaker.AddTextGeometryBuffer(u,d,i,w,E)}c.underscode&&((B=new THREE.LineBasicMaterial).color.setRGB(r.r,r.g,r.b),(I=new THREE.Geometry).vertices.push(new THREE.Vector3(0,0,0),new THREE.Vector3(s,0,0)),I.rotateZ(o.z),I.rotateY(o.y),I.rotateX(o.x),I.translate(t.x,t.y,t.z),(T=new THREE.LineSegments(I,B)).name=i,T.color=B.color.clone(),this.SDFMaker.AddLine(T)),c.box&&((B=new THREE.LineBasicMaterial).color.setRGB(r.r,r.g,r.b),(I=new THREE.Geometry).vertices.push(new THREE.Vector3(s,l,0),new THREE.Vector3(s,0,0),new THREE.Vector3(s,0,0),new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,0),new THREE.Vector3(0,l,0),new THREE.Vector3(0,l,0),new THREE.Vector3(s,l,0)),I.rotateZ(o.z),I.rotateY(o.y),I.rotateX(o.x),I.translate(t.x,t.y,t.z),(T=new THREE.LineSegments(I,B)).name=i,T.color=B.color.clone(),this.SDFMaker.AddLine(T)),c.dash&&((B=new THREE.LineBasicMaterial).color.setRGB(r.r,r.g,r.b),(I=new THREE.Geometry).vertices.push(new THREE.Vector3(0,l,0),new THREE.Vector3(s,l,0)),I.rotateZ(o.z),I.rotateY(o.y),I.rotateX(o.x),I.translate(t.x,t.y,t.z),(T=new THREE.LineSegments(I,B)).name=i,T.color=B.color.clone(),this.SDFMaker.AddLine(T))}else(a=new(n?le:THREE.BufferGeometry)).type="TextBufferGeometry",a.name=e.text,a._uuid=e.uuid,a.styleId=de.NORMAL,a.addAttribute("position",p),a.addAttribute("color",f),a.addAttribute("uv",m),a.addAttribute("textureid",g),a.setIndex(u.index),a.setDrawRange(M,A),this.SDFMaker.objectuuidToGeo[i]=a;return a&&(a.computeBoundingBox(),a.TextBox=D,a.charGeoBoxes=N),a},parseBufferGeometry:function(e){var t=new THREE.BufferGeometry,r=("LineSegmentsGeometry"==e._type?t=new Xe:"LineGeometry"==e._type&&(t=new xt),t._uuid=e.uuid,t.morphTargets=[],this.parseMorphing(e,t),t.bones=e.bones,[]),i=[];void 0!==e.animations&&null!=e.animations&&(e.animations.length?i=i.concat(e.animations):i.push(e.animations));for(var n=0;n<i.length;n++){var a=THREE.AnimationClip.parseAnimation(i[n],t.bones);a&&(this.viewer.animationsManager.bHasSkeletonAnimation=!0,a.animationUUID=i[n].uuid,r.push(a))}if(t.morphAttributes.position&&0<t.morphAttributes.position.length){var o=THREE.AnimationClip.CreateClipsFromMorphTargetSequences(t.morphAttributes.position,5);if(null!=o&&0<o.length)for(var r=r.concat(o),s=0;s<o.length;s++)o[s].uuid=e.morphInfos[s].uuid,o[s].ndsDuration=e.morphInfos[s].duration,o[s].ndsFps=e.morphInfos[s].fps}return 0<r.length&&(t.animations=r),t},parseNdsGeomBufferChunk:function(e,t){var r=0,i=e.bufferchunks.concat();if(i){for(var n=0;n<i.length;++n)(0<i[n].bufferlenth||0==i[n].bufferlenth&&null==i[n].buffer)&&(i[n].geometries.forEach(function(e){0!=De.ScenarioEditorid&&(e.uuid=Pe.addSceneID(e.uuid))}),e.bufferchunks[r]=i[n],r++);0<i.length-r&&e.bufferchunks.splice(r,i.length-r)}for(var a={},o=[],s=[],l=0;l<r;++l){for(var d,c,h,u=[],p={shxCount:0,ttfCount:0},f=0;f<e.bufferchunks[l].geometries.length;++f)"TextGeometry"===e.bufferchunks[l].geometries[f].type&&(c=e.bufferchunks[l].geometries[f],e.fonts&&(c.textFont=t.get(c.textFont.uuid||c.textFont)),c.textFont)&&(d=(c=this.SDFMaker.MeshTextCount(c,!1,this.viewer.modelContentVersion))[0],c=c[1],0<d&&0<c?(p.shxCount+=h=d+c,p.ttfCount+=h):(p.shxCount+=d,p.ttfCount+=c));for(f=0;f<e.bufferchunks[l].geometries.length;++f){var m=e.bufferchunks[l].geometries[f].type,g=(null!=e.bufferchunks[l].geometries[f].id&&null!=e.bufferchunks[l].geometries[f].id||(e.bufferchunks[l].geometries[f].id=0),e.bufferchunks[l].geometries[f].uuid);if(36===g.length&&(g=g.slice(0,8)+g.slice(9,13)+g.slice(14,18)+g.slice(19,23)+g.slice(24,36)),void 0===m||"BufferGeometry"===m){var v=this.ndsModel.getGeomManager().getGeomFromUuid(g,e.bufferchunks[l].geometries[f].id);v||((v=new le).geomType=e.bufferchunks[l].geometries[f].geomType,v.uuid=g,v.subGeomId=e.bufferchunks[l].geometries[f].id,v.bufferLength=e.bufferchunks[l].geometries[f].bufferLength,e.bufferchunks[l].geometries[f].box&&v.boundingBox.setFromArray(e.bufferchunks[l].geometries[f].box),e.bufferchunks[l].geometries[f].vertexColors&&(v.vertexColors=!0),null!=e.bufferchunks[l].geometries[f].viewport&&(v.viewportId=e.bufferchunks[l].geometries[f].viewport),this.ndsModel.getGeomManager().addGeom(v)),u.push(v),v.updateModelMatrix=!0,a[v.uuid]=v}else if("PointGeometry"===m){v=this.ndsModel.getGeomManager().getPointGeomFromUuid(g);v||((v=new NdsPointGeometry).uuid=g,this.ndsModel.getGeomManager().addPointGeom(v)),u.push(v)}else if("TextGeometry"===m){if(!(m=this.ndsModel.getGeomManager().getGeomFromUuid(g,e.bufferchunks[l].geometries[f].id))){var y=e.bufferchunks[l].geometries[f];if(e.fonts&&(y.textFont=t.get(y.textFont.uuid||y.textFont)),!y.textFont)continue;var A,M=new THREE.Vector3,E=(y.position&&(M.x=y.position.x,M.y=y.position.y,M.z=y.position.z),new THREE.Quaternion),w=(void 0!==y.angle&&E.setFromAxisAngle(new THREE.Vector3(0,0,1),y.angle),new THREE.Vector2(0,0)),x=new THREE.Vector2(0,0),b=(y.viewBox&&(x.set(y.viewBox[0],y.viewBox[1]),w.set(y.viewBox[2],y.viewBox[3])),new THREE.Matrix4),B=(y.normal&&(A=new THREE.Vector3(y.normal[0],y.normal[1],y.normal[2]),B=new THREE.Vector3,I=new THREE.Vector3,(Math.abs(A.x)<.015625&&Math.abs(A.y)<.015625?B.set(0,1,0):B.set(0,0,1)).cross(A),B.normalize(),I.copy(A).cross(B),b.makeBasis(B,I,A)),new THREE.Color),I=((m=3<this.viewer.modelContentVersion?this.SDFMaker.MeshTextParseGeometryTotal(y,M,E,b,B,e.bufferchunks[l].geometries[f].uuid,p,!0,!1):this.SDFMaker.OldTextParseGeometryTotal(y,M,E,B,e.bufferchunks[l].geometries[f].uuid,p,!0,y.isMirroredInX,y.isMirroredInY,!1,this.viewer.is2DModel,this.viewer.modelContentVersion)).text=y.text,m.font=y.textFont.uuid,m.loaded=!0,m.uuid=g,m.isTextGeometry=!0,m.subGeomId=e.bufferchunks[l].geometries[f].id,m.bufferLength=e.bufferchunks[l].geometries[f].bufferLength,m.position=M,m.quaternion=E,m.normalMatrix=b,m.needsUpdate=!0,y.viewBox&&(m.viewBox={max2:w,min2:x}),this.ndsModel.getGeomManager().addGeom(m),"text:"+m.styleId);this.ndsModel.getMeshManager().materials[I]||(this.ndsModel.getMeshManager().materials[I]={mat:this.SDFMaker.GetMaterial(m.styleId),refCount:0})}u.push(m),m.updateModelMatrix=!0,a[m.uuid]=m}null!=e.bufferchunks[l].urlIndex&&(a[e.bufferchunks[l].geometries[f].uuid].urlIndex=e.bufferchunks[l].urlIndex),1==e.bufferchunks[l].geometries[f].vertexColors&&(s[e.bufferchunks[l].geometries[f].uuid]=!0)}o.push(u)}return{nTotalBufferChunksCount:r,geometries:a,totalChunksNdsGeometries:o,geometriesVertexColorsUUIDs:s}},parseThreeGeomBufferChunk:function(e,t,r){var i=[],n=[];e.object&&e.object.children&&e.object.children.length&&!function t(e){Array.isArray(e)&&e.forEach(function(e){"LinePieces"==e.type?i.push(e.geometry):"LineStrip"==e.type&&n.push(e.geometry),e.children&&t(e.children)})}(e.object.children);var a=0,o=e.bufferchunks.concat();if(o){for(var s=0;s<o.length;++s)(0<o[s].bufferlenth||0==o[s].bufferlenth&&null==o[s].buffer)&&(o[s].geometries.forEach(function(e){0!=De.ScenarioEditorid&&(e.uuid=Pe.addSceneID(e.uuid))}),e.bufferchunks[a]=o[s],a++);0<o.length-a&&e.bufferchunks.splice(a,o.length-a)}for(var l={},d=[],c=[],h=0;h<a;++h){for(var u=[],p=0;p<e.bufferchunks[h].geometries.length;++p){var f=e.bufferchunks[h].geometries[p].type;if(null!=e.bufferchunks[h].geometries[p].id&&null!=e.bufferchunks[h].geometries[p].id||(e.bufferchunks[h].geometries[p].id=0),"BufferGeometry"===f){var m=e.bufferchunks[h].geometries[p],m=(i.includes(m.uuid)?m._type="LineSegmentsGeometry":n.includes(m.uuid)?m._type="LineGeometry":m._type="BufferGeometry",this.parseBufferGeometry(m));u.push(m)}else if("Geometry"===f){m=new THREE.Geometry;u.push(m)}else if("TextGeometry"===f){var g=this.geometryTOchild[e.bufferchunks[h].geometries[p].uuid];if(g)if(this.viewer.is2DModel)for(var v=0;v<g.length;++v){var y=t[(w=g[v]).material].mat.color,A=new THREE.Vector3,M=new THREE.Quaternion,E=(w.position?(A.set(w.position[0],w.position[1],w.position[2]),M.setFromAxisAngle(new THREE.Vector3(0,0,1),w.angle)):w.matrix&&((x=new THREE.Matrix4).fromArray(w.matrix),b=new THREE.Vector3,x.decompose(A,M,b)),e.bufferchunks[h].geometries[p]);e.fonts&&(E.textFont=r.get(E.textFont.uuid||E.textFont)),B=this.parseSDFTextGeometry(E,A,M,y,w.uuid),u.push(B)}else for(v=0;v<g.length;++v){(w=g[v]).material=Pe.getUUid32(w.material),w.material=Pe.addSceneID(w.material),De.ScenarioEditor&&this.ndsModel.materialuuidOld2New[w.material]&&(w.material=this.ndsModel.materialuuidOld2New[w.material]);var w,x,b,y=t[w.material].mat.color,A=new THREE.Vector3,M=new THREE.Quaternion,E=(w.position?(A.set(w.position[0],w.position[1],w.position[2]),M.setFromAxisAngle(new THREE.Vector3(0,0,1),w.angle)):w.matrix&&((x=new THREE.Matrix4).fromArray(w.matrix),b=new THREE.Vector3,x.decompose(A,M,b)),e.bufferchunks[h].geometries[p]);e.fonts&&(E.textFont=r.get(E.textFont.uuid||E.textFont)),B=this.parseSDFTextGeometry(E,A,M,y,w.uuid),0==v&&u.push(B)}else{var E=e.bufferchunks[h].geometries[p],A=(e.fonts&&(E.textFont=r.get(E.textFont)),new THREE.Vector3),M=(E.position&&(A.x=E.position.x,A.y=E.position.y,A.z=E.position.z),new THREE.Quaternion),y=(void 0!==E.angle&&M.setFromAxisAngle(new THREE.Vector3(0,0,1),E.angle),new THREE.Color),B=this.parseSDFTextGeometry(E,A,M,y,e.bufferchunks[h].geometries[p].uuid);u.push(B)}}l[e.bufferchunks[h].geometries[p].uuid]=u[p],null!=e.bufferchunks[h].urlIndex&&(l[e.bufferchunks[h].geometries[p].uuid].urlIndex=e.bufferchunks[h].urlIndex),u[p]&&(e.bufferchunks[h].geometries[p].box?(u[p].boundingBox=new THREE.Box3,u[p].boundingBox.setFromArray(e.bufferchunks[h].geometries[p].box)):u[p].computeBoundingBox()),1==e.bufferchunks[h].geometries[p].vertexColors&&(c[e.bufferchunks[h].geometries[p].uuid]=!0)}d.push(u)}return{nTotalBufferChunksCount:a,geometries:l,totalChunksGeometries:d,geometriesVertexColorsUUIDs:c}},getColorAndMatrix:function(e){null!=e.geometry&&(this.geometryTOchild[e.geometry]||(this.geometryTOchild[e.geometry]=new Array),this.geometryTOchild[e.geometry].push(e));var t=e.children;if(t&&0<t.length)for(var r=0;r<t.length;r++)this.getColorAndMatrix(t[r])},parseNdsModelNode:function(e,l){var d=this,t={},r={},i={};if(e.instances)for(var n=0,a=e.instances.length;n<a;++n)e.instances[n].geometries&&(i[e.instances[n].uuid]={geometries:e.instances[n].geometries,materials:e.instances[n].materials});var o,s,c={},h=this.parseNdsModelObject(e.object,t,r,i,0,c,l);if(l.parentNode&&((o=l.parentNode).unit&&(s=1,"meter"==e.unit?s=1e3:"centimeter"==e.unit?s=10:"millimeter"==e.unit?s=1:"inch"==e.unit?s=25.4:"feet"==e.unit?s=304.8:"um"==e.unit&&(s=.001),o.matrix||(o.matrix=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])),o.matrix[0]*=s,o.matrix[1]*=s,o.matrix[2]*=s,o.matrix[4]*=s,o.matrix[5]*=s,o.matrix[6]*=s,o.matrix[8]*=s,o.matrix[9]*=s,o.matrix[10]*=s),o.type=h.type,o.objectid=h.objectid,o.fileUnit=h.fileUnit,0<l.numRef&&function e(t){var r=d.getRefUUID(t.uuid,l.numRef),i=d.viewer.ndsModel.getModelById(l.refModelContext.modelId);"Body"===t.type&&i.brepManager&&i.brepManager.bindReference(r,t.uuid),c[t.uuid]&&(c[r]=c[t.uuid],delete c[t.uuid]),t.referenceNode=t.uuid,t.uuid=r,d.ndsModel.objectidTouuid[t.objectid]=t.uuid;for(var n=0,a=t.children.length;n<a;++n)e(t.children[n]);if(t.pmiuuid)for(var o=0,s=t.pmiuuid.length;o<s;++o)t.pmiuuid[o]=d.getRefUUID(t.pmiuuid[o],l.numRef)}(h),this.ndsModel.objectidTouuid[o.objectid]=o.uuid),e.layers&&(this.viewer.ndsModel.getModelById(l.refModelContext.modelId).layers=e.layers),e.layerGroups){for(var u=0;u<e.layerGroups.length;u++)e.layerGroups[u].layers.sort(function(e,t){return Number(e)-Number(t)});this.viewer.ndsModel.getModelById(l.refModelContext.modelId).layerGroups=e.layerGroups}return h=this.ndsModel.attachBodyNode(l.parentNode,h,t,r,c),l.parentNode&&l.parentNode.matrix&&(h.refMatrix=l.parentNode.matrix),h.fileUnit=e.unit,h},parsePMINode:function(e,t,r,i,n){var a=this,o=this,s=new THREE.Object3D,l=o.parseObject(e.object,t,r,n.basUri+"*",i,!1,!0);if(0<n.numRef&&function e(t){t.uuid=a.getRefUUID(t.uuid,n.numRef),t.views&&t.views.forEach(function(e){if(e.pmiuuid)for(var t=0;t<e.pmiuuid.length;t++)e.pmiuuid[t]=o.getRefUUID(e.pmiuuid[t],n.numRef)}),t.captures&&t.captures.forEach(function(e){if(e.pmiuuid)for(var t=0;t<e.pmiuuid.length;t++)e.pmiuuid[t]=o.getRefUUID(e.pmiuuid[t],n.numRef)});for(var r=0,i=t.children.length;r<i;++r)e(t.children[r])}(l),this.SDFMaker.HaveSDF()&&this.viewer.is2DModel&&this.viewer.modelContentVersion<2){l.add(this.SDFMaker.CreateMesh());for(var d=0;d<this.SDFMaker.lines.length;d++)l.add(this.SDFMaker.lines[d])}else this.SDFMaker.objectuuidToGeo={},l.updateMatrixWorld(!0);return s.add(l),s},parseNdsBufferChunk:function(e,t,r,i,n){var a,o=n.texturePath||n.basUri,s=(i?(a=this.parseNdsGeomBufferChunk(e,r),e.nTotalBufferChunksCount=a.nTotalBufferChunksCount):(this.getColorAndMatrix(e.object),a=this.parseThreeGeomBufferChunk(e,t,r),this.checkGeometries(a.geometries,t),e.threeGeometries=a.geometries,e.geometriesVertexColorsUUIDs=a.geometriesVertexColorsUUIDs),a.nTotalBufferChunksCount),l=a.totalChunksGeometries||[],d=a.totalChunksNdsGeometries||[];this.viewer.nBufferChunks+=s;for(var c,h,u,p,f=0;f<s;++f)null==e.bufferchunks[f].buffer?i&&(c=o+"/"+f,this.ndsModel.getGeomManager().bufferChunk[c]={bufferlenth:e.bufferchunks[f].bufferlenth,compress:!1,bufferIndex:f,geometriesArray:i?null:l[f],ndsGeometriesArray:i?d[f]:null,isDraco:!1},this.chunkRequestsTextNum++):(c=l[f],u=i?d[f]:null,p=(h=o+e.bufferchunks[f].buffer).lastIndexOf("."),p=h.substring(p+1,h.length),u={bufferlenth:e.bufferchunks[f].bufferlenth,compress:e.compress,bufferIndex:f,geometriesArray:i?null:c,ndsGeometriesArray:u,isDraco:"drc"==p},p=(null!=e.bufferchunks[f].compress&&(u.compress=e.bufferchunks[f].compress),e.bufferchunks[f].jsonUrl&&(h=this.extractUrlBase(e.bufferchunks[f].jsonUrl)+e.bufferchunks[f].buffer),{url:h=0==e.bufferchunks[f].isChunk?e.bufferchunks[f].buffer:h,parameters:u}),(n.loadingPmi?this.pmiChunkRequestQueue:this.chunkRequestQueue).push(p),i&&(this.ndsModel.getGeomManager().bufferChunk[h]=u));return a},parseModelContentInner:function(e,t){var r,i,n,a=0<e.numRef,o=e.texturePath||e.basUri,s=!!this.ndsModel,l=(e.loadingPmi&&(s=!1),null),d=null;if(a)l=t.materials,d=t._fonts;else{l=new ut(void 0,this.manager,this.viewer,this.ndsModel).initMaterials(t.materials,o,t.lineType,t.hatchType,t.fonts,e);if(t.materials=l,s&&this.ndsModel.getMeshManager().setMaterials(l),t.fonts){for(var d=new Map,c=0,h=t.fonts.length;c<h;++c)d.set(t.fonts[c].uuid,t.fonts[c]);t._fonts=d}}this.viewer.is2DModel&&this.SDFMaker.SetFontsInfo(d),a?s?t.nTotalBufferChunksCount&&this.chunkRequestQueue.push({url:o+"geom_*.bin."+e.numRef,isRefChunk:!0,parameters:{}}):(r=t.threeGeometries,i=t.geometriesVertexColorsUUIDs):(r=(a=this.parseNdsBufferChunk(t,l,d,s,e)).geometries,i=a.geometriesVertexColorsUUIDs),this.geometryTOchild={};o=null;if(s){var u,o=this.parseNdsModelNode(t,e);if(e.parentNode&&e.parentNode.refModelUri&&(u=e.parentNode.worldMatrix),(n=new THREE.Object3D).boundingBox=new THREE.Box3(new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,0)),t.bbox&&(this.viewer.is2DModel&&(t.bbox[2]=0,t.bbox[5]=0,this.ndsModel.originModelBBox=(new THREE.Box3).setFromArray(t.bbox)),n.boundingBox.min.fromArray(t.bbox,0),n.boundingBox.max.fromArray(t.bbox,3)),u&&n.boundingBox.applyMatrix4(u),this.modelContentVersion<4&&0<this.SDFMaker.lines.length){var p=new THREE.Group;p.name="dashLine";for(var f=0;f<this.SDFMaker.lines.length;f++)p.add(this.SDFMaker.lines[f]);this.viewer.scene.add(p)}}else n=this.parsePMINode(t,r,l,i,e);return n.isPmi=e.loadingPmi,t.solidAnimations&&0<(a=this.parseSolidAnimations(t.solidAnimations,r,l)).length&&this.viewer&&(this.viewer.animationsManager.bHasSolidAnimation=!0,this.viewer.animationsManager.initSolidAnimations(n,a)),this.viewer&&(this.viewer.materialsSetting||(this.viewer.materialsSetting=new Mt(this.viewer)),e.loadingPmi||this.viewer.materialsSetting.initMaterialsInfo(l)),{objectRoot:n,bodyNodeRoot:o}},parseSolidAnimations:function(e,t,r){if(e.length<=0)return null;for(var i,n,a,o=[],s=0;s<e.length;s++)null!=e[s].fps&&(e[s].fps=parseFloat(e[s].fps)),null!=e[s].duration&&(e[s].duration=parseFloat(e[s].duration)),null==e[s].fps||null==e[s].duration||e[s].fps<=0||e[s].duration<=0||(i=THREE.AnimationClip.parse(e[s]),null!=e[s].uuid&&(i.uuid=e[s].uuid),null!=e[s].fps&&(i.fps=parseFloat(e[s].fps)),e[s].animationObject&&(n=this.parseObject(e[s].animationObject,t,r,null),(a=new THREE.Object3D).add(n),i.animationScene=new THREE.Scene,i.animationScene.autoUpdate=!1,i.animationScene.add(a)),o.push(i));return o},parseDecals:function(e,t,r){if(void 0!==t&&void 0!==r){var i={},n={},a={},o=new THREE.Object3D;o.type="decals",r.add(o),r.updateMatrixWorld(!0);for(var s=0;s<t.length;++s){var l,d=void 0,d=new(void 0!==this.viewer.convertPhongToPBR&&this.viewer.convertPhongToPBR?THREE.MeshStandardMaterial:THREE.MeshPhongMaterial);i[t[s].uuid]=t[s],d.map=(new ut).loadTexture(d,n,e+t[s].textureFile,void 0,void 0,Ce.TextureLoadingManager.onError),a[t[s].uuid]=d,void 0!==t[s].opacity&&(l=parseFloat(t[s].opacity))<1&&(d.transparent=!0,d.opacity=l)}this.traverseDecals(o,r,a,i),o.matrixAutoUpdate=!1,o.matrixWorldNeedsUpdate=!1,o.updateMatrixWorld(!0)}},traverseDecals:function(e,t,r,i){if(null!=t&&t instanceof THREE.Object3D&&!(t instanceof THREE.Light))if(void 0!==t.decals)if(t.hasOwnProperty("geometry"))for(var n=0;n<t.decals.length;++n){var a=i[t.decals[n]],o=r[t.decals[n]],s=new THREE.Vector3(a.origin[0],a.origin[1],a.origin[2]),l=new THREE.Vector3(a.vecX[0],a.vecX[1],a.vecX[2]),d=new THREE.Vector3(a.vecY[0],a.vecY[1],a.vecY[2]);s.addScaledVector(l,.5),s.addScaledVector(d,.5),"MapPlanar"===a.mappingType&&(s=new ot(t,s,l,d,a.projectionType),(l=new THREE.Mesh(s,o)).matrixAutoUpdate=!1,l.matrixWorldNeedsUpdate=!1,l.updateMatrixWorld(!0),e.add(l))}else for(var c=t.children,h=0;h<c.length;++h)this.traverseChild(t.decals,e,t.children[h],r,i);else if(null!=t.children)for(c=t.children,h=0;h<c.length;++h)this.traverseDecals(e,t.children[h],r,i)},traverseChild:function(e,t,r,i,n){if(null!=r&&r instanceof THREE.Object3D&&!(r instanceof THREE.Light))if(void 0!==e){if(r.hasOwnProperty("geometry"))for(var a=0;a<e.length;++a){var o=n[e[a]],s=i[e[a]],l=new THREE.Vector3(o.origin[0],o.origin[1],o.origin[2]),d=new THREE.Vector3(o.vecX[0],o.vecX[1],o.vecX[2]),c=new THREE.Vector3(o.vecY[0],o.vecY[1],o.vecY[2]);l.addScaledVector(d,.5),l.addScaledVector(c,.5),"MapPlanar"===o.mappingType&&(l=new ot(r,l,d,c,o.projectionType),(d=new THREE.Mesh(l,s)).matrixAutoUpdate=!1,d.matrixWorldNeedsUpdate=!1,d.updateMatrixWorld(!0),t.add(d))}}else if(null!=r.children)for(var h=r.children,u=0;u<h.length;++u)this.traverseChild(e,t,r.children[u],i,n)},parseGeometries:function(e){var t={};if(void 0!==e)for(var r=new BIMJSONLoader,i=new THREE.BufferGeometryLoader,n=0,a=e.length;n<a;n++){var o,s=e[n];switch(s.type){case"PlaneGeometry":o=new THREE.PlaneGeometry(s.width,s.height,s.widthSegments,s.heightSegments);break;case"BoxGeometry":case"CubeGeometry":o=new THREE.BoxGeometry(s.width,s.height,s.depth,s.widthSegments,s.heightSegments,s.depthSegments);break;case"CircleGeometry":o=new THREE.CircleGeometry(s.radius,s.segments);break;case"CylinderGeometry":o=new THREE.CylinderGeometry(s.radiusTop,s.radiusBottom,s.height,s.radialSegments,s.heightSegments,s.openEnded);break;case"SphereGeometry":o=new THREE.SphereGeometry(s.radius,s.widthSegments,s.heightSegments,s.phiStart,s.phiLength,s.thetaStart,s.thetaLength);break;case"IcosahedronGeometry":o=new THREE.IcosahedronGeometry(s.radius,s.detail);break;case"TorusGeometry":o=new THREE.TorusGeometry(s.radius,s.tube,s.radialSegments,s.tubularSegments,s.arc);break;case"TorusKnotGeometry":o=new THREE.TorusKnotGeometry(s.radius,s.tube,s.radialSegments,s.tubularSegments,s.p,s.q,s.heightScale);break;case"BufferGeometry":o=i.parse(s.data);break;case"Geometry":o=r.parse(s.data).geometry}o.uuid=s.uuid,void 0!==s.name&&(o.name=s.name),t[s.uuid]=o}return t},parseMaterials:function(e){var t={};if(void 0!==e)for(var r=new THREE.MaterialLoader,i=0,n=e.length;i<n;i++){var a=e[i],o=r.parse(a);o.uuid=a.uuid,void 0!==a.name&&(o.name=a.name),t[a.uuid]=o}return t},parseLink:function(e,o,s,l,t){var d=this,c=this.extractUrlBase(t)+e.linkPath;this.manager.itemStart(),this.loader.load(d.viewer.gobalReqHeader,c,function(e){var t=JSON.parse(e);if(t.buffer){for(var r={},i=[],n=0;n<t.geometries.length;++n)"BufferGeometry"===t.geometries[n].type?i.push(new THREE.BufferGeometry):"Geometry"===t.geometries[n].type&&i.push(new THREE.Geometry),r[t.geometries[n].uuid]=i[n];var e=d.extractUrlBase(c)+t.buffer,a={useWorker:!0,bufferlenth:t.bufferlenth,compress:t.compress,geometriesArray:i},a=((new CTMLoader).load(d.viewer.gobalReqHeader,e,function(){d.manager.itemEnd()},a),d.checkGeometries(r,l),d.parseObject(t.object,r,l,c))}else a=d.parseObject(t.object,s,l,c);o.add(a),d.onLinkComplete(o.linkID)})},recordLink:function(e,t){return null==this.linkMap[e]&&(this.linkMap[e]=t,!(this.linkDoneMap[e]=!1))},addWaitingLink:function(e,t){var r=this.linkWaitingArray[e];null==r&&(this.linkWaitingArray[e]=r=[]),r.push(t)},cloneObject:function(e,t){var r=null;if(null!=e.linkID?((r=e.clone(void 0,t=!1)).linkID=e.linkID,this.isLinkComplete(r.linkID)?this.processLoadedLink(r,this.getCompleteLink(r.linkID)):this.addWaitingLink(r.linkID,r)):r=e.clone(void 0,!1),r.uuid=e.uuid,r.type=e.type,!0===t)for(var i=0;i<e.children.length;i++){var n=e.children[i];r.add(this.cloneObject(n,t))}return r},processLoadedLink:function(e,t){for(var r=0;r<t.children.length;r++)e.add(this.cloneObject(t.children[r],!0))},isLinkComplete:function(e){return this.linkDoneMap[e]},getCompleteLink:function(e){return this.linkMap[e]},onLinkComplete:function(e){this.linkDoneMap[e]=!0;for(var t=this.linkWaitingArray[e],r=0;r<t.length;r++)this.processLoadedLink(t[r],this.linkMap[e])},parseObject:(Bt=new THREE.Matrix4,function(e,t,r,i,n,a,o){void 0===o&&(o=!1);var s,l=i;switch(e.geometry&&(e.geometry=Pe.addSceneID(e.geometry)),e.material&&(e.material=Pe.addSceneID(e.material),De.ScenarioEditor)&&this.ndsModel.materialuuidOld2New[e.material]&&(e.material=this.ndsModel.materialuuidOld2New[e.material]),e.type){case"Scene":s=new THREE.Scene;break;case"PerspectiveCamera":s=new THREE.PerspectiveCamera(e.fov,e.aspect,e.near,e.far);break;case"OrthographicCamera":s=new THREE.OrthographicCamera(e.left,e.right,e.top,e.bottom,e.near,e.far);break;case"AmbientLight":s=new THREE.AmbientLight(e.color);break;case"DirectionalLight":s=new THREE.DirectionalLight(e.color,e.intensity);break;case"PointLight":s=new THREE.PointLight(e.color,e.intensity,e.distance);break;case"SpotLight":s=new THREE.SpotLight(e.color,e.intensity,e.distance,e.angle,e.exponent);break;case"HemisphereLight":s=new THREE.HemisphereLight(e.color,e.groundColor,e.intensity);break;case"Mesh":if(null==(c=t[e.geometry]))return null;if("TextBufferGeometry"!==c.type||this.viewer.is2DModel){if("TextBufferGeometry"===c.type&&this.viewer.is2DModel)return null;36===e.material.length&&(e.material=e.material.slice(0,8)+e.material.slice(9,13)+e.material.slice(14,18)+e.material.slice(19,23)+e.material.slice(24,36));var d=r[e.material];n&&n[e.geometry]&&d.mat&&(d.mat.vertexColors=!0),++d.refCount,void 0===c&&console.warn("BIMObjectLoader: Undefined geometry",e.geometry),void 0===d&&console.warn("BIMObjectLoader: Undefined material",e.material),d.mat.defines={NOCLIPPING:""},De.StopPMIOcclusion&&(d.mat.depthTest=!1),s=new THREE.Mesh(c,d.mat)}else{var d=this.SDFMaker.GetMaterial(c.styleId);this.SDFMaker.objectuuidToGeo[e.uuid]&&(c=this.SDFMaker.objectuuidToGeo[e.uuid]),d.defines={NOCLIPPING:""},De.StopPMIOcclusion&&(d.depthTest=!1),s=new THREE.Mesh(c,d)}null!=c.urlIndex&&(s.urlIndex=c.urlIndex);break;case"Line":var c=t[e.geometry];36===e.material.length&&(e.material=e.material.slice(0,8)+e.material.slice(9,13)+e.material.slice(14,18)+e.material.slice(19,23)+e.material.slice(24,36)),++(d=r[e.material]).refCount,void 0===c&&console.warn("BIMObjectLoader: Undefined geometry",e.geometry),void 0===d&&console.warn("BIMObjectLoader: Undefined material",e.material),d.mat.defines={NOCLIPPING:""},De.StopPMIOcclusion&&(d.mat.depthTest=!1),s=new THREE.Line(c,d.mat),null!=c.urlIndex&&(s.urlIndex=c.urlIndex),null!=e.tangentEdgeObject&&(s.tangentEdgeObject=!0,0==De.tangentEdgeVisible)&&(s.visible=!1);break;case"LineStrip":c=t[e.geometry];e.material&&36===e.material.length&&(e.material=e.material.slice(0,8)+e.material.slice(9,13)+e.material.slice(14,18)+e.material.slice(19,23)+e.material.slice(24,36)),(d=r[e.material])||(d={},o?(h=new qe({color:0,linewidth:1.2,worldUnits:!1}),u=this.viewer.renderer.getPixelRatio(),p=this.viewer.renderer.domElement.width/u,u=this.viewer.renderer.domElement.height/u,h.resolution.set(p,u),d.mat=h):(p=new THREE.LineBasicMaterial({color:0,linewidth:1}),d.mat=p)),o&&"MeshBasicMaterial"==d.mat.type&&(u={},r[e.material+"_Line"]?u=r[e.material+"_Line"]:((h=new qe).color.copy(d.mat.color),h.side=d.mat.side,h.opacity=d.mat.opacity,h.transparent=d.mat.transparent,h.linewidth=1.2,h.worldUnits=!1,h.dashed=!1,p=this.viewer.renderer.getPixelRatio(),f=this.viewer.renderer.domElement.width/p,p=this.viewer.renderer.domElement.height/p,h.resolution.set(f,p),u.mat=h,r[e.material+"_Line"]=u),d=u),++d.refCount,void 0===c&&console.warn("BIMObjectLoader: Undefined geometry",e.geometry),void 0===d&&console.warn("BIMObjectLoader: Undefined material",e.material),d.mat?(d.mat.defines={NOCLIPPING:""},De.StopPMIOcclusion&&(d.mat.depthTest=!1)):(d.defines={NOCLIPPING:""},De.StopPMIOcclusion&&(d.depthTest=!1)),s=new Tt(c,d.mat||d),null!=c.urlIndex&&(s.urlIndex=c.urlIndex),null!=e.tangentEdgeObject&&(s.tangentEdgeObject=!0,0==De.tangentEdgeVisible)&&(s.visible=!1);break;case"LinePieces":var h,u,p,f,c=t[e.geometry];e.material&&36===e.material.length&&(e.material=e.material.slice(0,8)+e.material.slice(9,13)+e.material.slice(14,18)+e.material.slice(19,23)+e.material.slice(24,36)),(d=r[e.material])||(d={},o?(f=new qe({color:0,linewidth:1.2,worldUnits:!1}),p=this.viewer.renderer.getPixelRatio(),h=this.viewer.renderer.domElement.width/p,u=this.viewer.renderer.domElement.height/p,f.resolution.set(h,u),d.mat=f):(p=new THREE.LineBasicMaterial({color:0,linewidth:1}),d.mat=p)),o&&"MeshBasicMaterial"==d.mat.type&&(h={},r[e.material+"_Line"]?h=r[e.material+"_Line"]:((u=new qe).color.copy(d.mat.color),u.side=d.mat.side,u.opacity=d.mat.opacity,u.transparent=d.mat.transparent,u.linewidth=1.2,u.worldUnits=!1,u.dashed=!1,f=this.viewer.renderer.getPixelRatio(),p=this.viewer.renderer.domElement.width/f,f=this.viewer.renderer.domElement.height/f,u.resolution.set(p,f),h.mat=u,r[e.material+"_Line"]=h),d=h),++d.refCount,void 0===c&&console.warn("BIMObjectLoader: Undefined geometry",e.geometry),void 0===d&&console.warn("BIMObjectLoader: Undefined material",e.material),d.mat?(d.mat.defines={NOCLIPPING:""},De.StopPMIOcclusion&&(d.mat.depthTest=!1)):(d.defines={NOCLIPPING:""},De.StopPMIOcclusion&&(d.depthTest=!1)),s=new Ke(c,d.mat||d),null!=c.urlIndex&&(s.urlIndex=c.urlIndex),null!=e.tangentEdgeObject&&(s.tangentEdgeObject=!0,0==De.tangentEdgeVisible)&&(s.visible=!1);break;case"Sprite":36===e.material.length&&(e.material=e.material.slice(0,8)+e.material.slice(9,13)+e.material.slice(14,18)+e.material.slice(19,23)+e.material.slice(24,36)),void 0===(d=r[e.material])&&console.warn("BIMObjectLoader: Undefined material",e.material),s=new THREE.Sprite(d.mat);break;case"Group":s=new THREE.Group;break;case"Link":(s=new THREE.Object3D).type="Link",s.linkID=e.linkID,this.recordLink(e.linkID,s)?this.parseLink(e,s,t,r,l):this.isLinkComplete(e.linkID)?this.processLoadedLink(s,this.getCompleteLink(e.linkID)):this.addWaitingLink(e.linkID,s);break;default:s=new THREE.Object3D,void 0!==e.type&&(s.type=e.type)}void 0!==e.uuid?s.uuid=e.uuid:(s.uuid=this.treeIndex.toString(),++this.treeIndex),void 0!==e.propertyfile&&(s.propertyfile=e.propertyfile,this.viewer.containProperty=!0);function m(e){for(var t=[],r=0;r<e.length;r++){var i,n=e[r],a={};for(i in n)a[i]=n[i];t.push(a)}return t}if(e.captures&&0<e.captures.length){s.captures=m(e.captures);for(var g=0;g<s.captures.length;g++)e.captures[g].pmiuuid&&(s.captures[g].pmiuuid=e.captures[g].pmiuuid.concat())}if(e.views&&0<e.views.length){s.views=m(e.views);for(var v=0;v<s.views.length;v++)e.views[v].pmiuuid&&(s.views[v].pmiuuid=e.views[v].pmiuuid.concat())}e.semanticPMI&&(s.semanticPMI=e.semanticPMI),e.linkedEntities&&(s.linkedEntities=e.linkedEntities),void 0!==e.name&&(s.name=e.name),void 0!==e.matrix?(Bt.fromArray(e.matrix),Bt.decompose(s.position,s.quaternion,s.scale)):(void 0!==e.position&&s.position.fromArray(e.position),void 0!==e.rotation&&s.rotation.fromArray(e.rotation),void 0!==e.scale&&s.scale.fromArray(e.scale)),s.updateMatrixWorld(!0),s.originMatrixWorld=s.matrixWorld.clone(),void 0!==e.visible&&(s.visible=e.visible),void 0!==e.userData&&(s.userData=e.userData),void 0!==e.decals&&(s.decals=e.decals),e.textOrSymbolObject&&(s.textOrSymbolObject=!0),a?s.followCamera=!0:void 0!==e.followCamera&&(s.followCamera=e.followCamera),void 0!==e.fixedPmi&&(s.fixedPmi=e.fixedPmi,s.followCamera=!0,s.fixedPmiNum=this.fixedPmiNum,this.fixedPmiNum++),null!=e.autoOrientation&&(s.autoOrientation=e.autoOrientation);var y=!1;if(void 0!==e.children){for(var A=0;A<e.children.length;++A){var M=this.parseObject(e.children[A],t,r,i,n,"Note"!==e.type&&s.followCamera,o);null!=M&&(!s.followCamera||"Note"!=s.type||"Mesh"===M.type&&"TextBufferGeometry"===M.geometry.type||M.textOrSymbolObject||(y=!0),(s.followCamera&&("Mesh"===M.type&&"TextBufferGeometry"===M.geometry.type||M.textOrSymbolObject)?"Note"!==s.type?(s.noteGroup||(s.noteGroup=new THREE.Group,s.noteGroup.type="Note",s.noteGroup.followCamera=s.followCamera,s.noteGroup.position.copy(M.position),s.noteGroup.updateMatrixWorld(!0),s.noteGroup.originMatrixWorld=s.matrixWorld.clone(),s.add(s.noteGroup)),M.position.sub(s.noteGroup.position),M.updateMatrix(),delete M.followCamera,s.noteGroup):(s.offset?s.offset.set(Math.min(s.offset.x,M.position.x),Math.max(s.offset.y,M.position.y),Math.min(s.offset.z,M.position.z)):(s.offset=new THREE.Vector3,s.offset.copy(M.position)),s):s).add(M),M.autoOrientation)&&"GeomTol"!=M.type&&!s.hasOrientation&&(s.hasOrientation=!0)}if(s.offset){s.position.add(s.offset);for(var E=0;E<s.children.length;++E)s.children[E].position.sub(s.offset),s.children[E].updateMatrix()}}return y&&(s.followCamera=!1),e.layerId&&(s.layerId=e.layerId),s.updateMatrix(),s.updateMatrixWorld(!0),s.matrixAutoUpdate=!1,s.matrixWorldNeedsUpdate=!1,s}),setVisibleOfChild:function(e){for(var t in e.children)e.children[t].visible=!1,this.setVisibleOfChild(e.children[t])},parseNdsModelObject:function(e,t,r,i,n,a,o){a=a||{};var s,l,d=new _e;if(d._originalVisible=d.visible,d.unload=!1,void 0!==e.uuid?(d.uuid=e.uuid,36===d.uuid.length&&"-"==d.uuid.charAt(8)&&"-"==d.uuid.charAt(13)&&"-"==d.uuid.charAt(18)&&"-"==d.uuid.charAt(23)&&(d.uuid=d.uuid.slice(0,8)+d.uuid.slice(9,13)+d.uuid.slice(14,18)+d.uuid.slice(19,23)+d.uuid.slice(24,36)),d.uuid=d.uuid.toLowerCase()):(d.uuid=this.treeIndex.toString(),++this.treeIndex),De.ScenarioEditor&&(l=Pe.addSceneID(d.uuid),d.uuid=THREE.Math.generateUUID(),d.uuid=d.uuid.slice(0,8)+d.uuid.slice(9,13)+d.uuid.slice(14,18)+d.uuid.slice(19,23)+d.uuid.slice(24,36),this.ndsModel.bodyuuidOld2New[l]=d.uuid),void 0!==e.objectid?(d.objectid=e.objectid+"_"+St.numObject++,this.ndsModel.objectidTouuid[d.objectid]=d.uuid):this.ndsModel.objectidTouuid&&(this.ndsModel.objectidTouuid=null),void 0!==e.name?(d.name=e.name,this.viewer._CATIA&&e.referenceName&&(o.parentNode&&o.parentNode.name?d.name=e.referenceName+"("+o.parentNode.name+")":d.name=e.referenceName+"("+e.name+")",d.oriName=e.name)):d.name=d.uuid,e.referenceName?d.referencename=e.referenceName:d.referencename=d.name,e.unit&&(d.unit=e.unit),e.persistentId&&(d.persistentId=e.persistentId),e.externalRefUuid&&(d.externalRefUuid=e.externalRefUuid),e.material&&(l=e.material,o.refModelContext)&&o.refModelContext.uuidMaterialMap.has(e.material)&&(l=o.refModelContext.uuidMaterialMap.get(e.material),a)&&l&&(a[d.uuid]=l,d.useBodyNodeMaterial=!0),e.referenceCount&&(1==e.referenceCount&&((l={})[d.name]={count:1,refNode:d},this.referenceMap.set(e.uuid,l)),this.referenceMap.has(e.referenceModel))&&((s=(l=this.referenceMap.get(e.referenceModel))[d.name])?(1==s.count&&(s.refNode.refNum=1),s.count+=1,d.refNum=s.count):l[d.name]={count:1,refNode:d}),o.hasRefModel&&e.referenceModel&&(d.refModelUri=e.referenceModel,null!==e.configName&&void 0!==e.configName?d.configName=e.configName:d.configName="0"),void 0!==e.propertyfile&&(d.propertyfile=e.propertyfile,this.viewer.containProperty=!0,De.ScenarioEditor?(s=this.extractUrlBase(this.ndsModel.modelUri)+d.propertyfile,this.viewer.propertyFielSet||(this.viewer.propertyFielSet=new Set),this.viewer.propertyFielSet.has(s)||(this.viewer.modelRequestor.addRequest(s,1e4,"propertyfile",{modelId:this.ndsModel.id,keepSourceFile:!0}),this.viewer.propertyFielSet.add(s))):(l=this.extractUrlBase(this.ndsModel.modelUri)+d.propertyfile,this.viewer.propertyFielSet||(this.viewer.propertyFielSet=new Set),this.viewer.propertyFielSet.has(l)||this.viewer.propertyFielSet.add(l))),this.viewer.useUnvisibleList||void 0===e.visible||(d.visible=e.visible,d._originalVisible=e.visible),void 0!==e.fixed&&(d.fixed=e.fixed),null!=e.area&&(d.area=isNaN(Number(e.area))?0:Number(e.area)),null!=e.volume&&(d.volume=isNaN(Number(e.volume))?0:Number(e.volume)),void 0!==e.matrix&&null!==e.matrix&&(d.matrix=e.matrix.slice(0),d._originalMatrix=e.matrix.slice(0)),void 0!==e.worldMatrix&&(d.worldMatrix=e.worldMatrix.clone()),d.type=e.type,null!=e.pmiuuid&&("Body"===e.type?d.bodyPmiuuid=e.pmiuuid.concat():d.pmiuuid=e.pmiuuid.concat()),void 0!==e.children){"Body"===e.children[0].type&&(n=0);for(var c,h=!1,u=!1,p=!1,f=0;f<e.children.length;f++)if("Body"===(m=e.children[f]).type){if(u=u||!0,p){h=!0;break}}else if(p=p||!0,u){h=!0;break}h&&((c=new _e).uuid=d.uuid+"_"+Math.floor(101*Math.random()),c.name=d.name,d.type="Assembly",c.type="Part",c.parent=d,c.isVirtualNode=!0,d.children.push(c),d.VirtualNode=c);for(f=0;f<e.children.length;f++){var m=e.children[f];if(0!=De.ScenarioEditorid&&(m.geometry=Pe.addSceneID(m.geometry)),"Mesh"===m.type||"Surface"===m.type||"Line"===m.type||"LinePieces"===m.type)"Line"!==m.type&&"LinePieces"!==m.type||!m.tangentEdgeObject||(r[m.geometry]=!0),"Surface"===m.type&&(m.type="Mesh",d.hasSurface=!0),36===m.material.length&&"-"==m.material.charAt(8)&&"-"==m.material.charAt(13)&&"-"==m.material.charAt(18)&&"-"==m.material.charAt(23)&&(m.material=m.material.slice(0,8)+m.material.slice(9,13)+m.material.slice(14,18)+m.material.slice(19,23)+m.material.slice(24,36)),m.material=Pe.addSceneID(m.material),De.ScenarioEditor&&this.ndsModel.materialuuidOld2New[m.material]&&(m.material=this.ndsModel.materialuuidOld2New[m.material]),o.refModelContext&&o.refModelContext.uuidMaterialMap.has(m.material)&&(m.material=o.refModelContext.uuidMaterialMap.get(m.material).uuid),this.ndsModel.getMeshManager().materials[m.material],"Mesh"===m.type&&"LineBasicMaterial"===this.ndsModel.getMeshManager().materials[m.material].mat.type&&(this.ndsModel.getMeshManager().materials[m.material].mat=new THREE.MeshPhongMaterial),this.ndsModel.getMeshManager().materials[m.material].refCount++,De.ScenarioEditor?(g=Pe.addSceneID(m.uuid),m.uuid=THREE.Math.generateUUID(),m.uuid=Pe.getUUid32(m.uuid),this.ndsModel.bodyuuidOld2New[g]=m.uuid):m.uuid=Pe.addSceneID(m.uuid),t[m.uuid]=m.geometry;else if("RefPoint"===m.type||"RefAxis"===m.type||"RefPlane"===m.type){var g={parentNode:d,uuid:m.uuid,type:m.type,name:m.name,visible:m.visible,coords:m.points};this.ndsModel.addReferenceEntity(g),"RefAxis"===m.type&&m.visible&&d.setComponentRefAxisVisibility(!0),"RefPlane"===m.type&&m.visible&&d.setComponentRefPlaneVisibility(!0)}else{"Meshes"==e.type&&"Object3D"===m.type&&(m.type="Body"),m.children&&m.children[0]&&m.children[0].geometry&&"Object3D"===m.type&&(m.type="Body");var v=this.parseNdsModelObject(m,t,r,i,n,a,o);if(v.parent=d,"Body"===m.type&&n++,"Body"===v.type&&h)c.children.push(v),v.parent=c;else if("Body"===m.type||!De.inBIMContext||v.children&&0!=v.children.length){if(void 0!==d.visible&&0==d.visible&&(v.visible=!1,v._originalVisible=!1,this.setVisibleOfChild(v)),"Root"===v.type||"Geometry"===v.type||"Meshes"===v.type||"Group"===v.type)for(var y=0;y<v.children.length;y++)d.children.push(v.children[y]),v.children[y].parent=d;else d.children.push(v);"CoordSystem"===m.type&&m.visible&&d.setComponentCoordinateSysVisibility(!0)}}}}return 0==d.children.length&&"Model"==d.type?((c=new _e).uuid=d.uuid+"_1",d.objectid&&(c.objectid=d.objectid+"_1",this.viewer.ndsModel.objectidTouuid)&&(this.viewer.ndsModel.objectidTouuid[c.objectid]=c.uuid),c.name=d.name,d.type="Body",c.type="Part",(d.parent=c).children.push(d),c):("Body"!=e.type?void 0!==e.fileguid&&(d.fileguid=e.fileguid,this.ndsModel.fileguidTouuid[d.fileguid]||(this.ndsModel.fileguidTouuid[d.fileguid]=[]),"Model"==e.type&&1==e.children.length&&"Part"==e.children[0].type?this.ndsModel.fileguidTouuid[d.fileguid].push(e.children[0].uuid):this.ndsModel.fileguidTouuid[d.fileguid].push(d.uuid)):(d.BodyfileID=n,e.layerId&&(d.layerId=e.layerId)),d)},parseMorphAnimation:function(e){return e?(new $).readMorph(e):null}},function(e){this.manager=void 0!==e?e:THREE.DefaultLoadingManager}),Ct=(Rt.prototype={constructor:Rt,load:function(e,t,r,i,n,a){var o=this,s="?time=",l=(0<t.indexOf("?")&&(s="&time="),null!=a?0==a&&(t=t+s+Date.now()):De.avoidCaching&&(t=t+s+Date.now()),new XMLHttpRequest);if(l.open("GET",t,!0),e)for(var d in e)l.setRequestHeader(d,e[d]);l.addEventListener("load",function(e){404==this.status&&n?n():(r&&r(this.response,o.attribute),o.manager.itemEnd(t))},!1),void 0!==i&&l.addEventListener("progress",function(e){i(e)},!1),void 0!==n&&l.addEventListener("error",function(e){n(e)},!1),void 0!==this.crossOrigin&&(l.crossOrigin=this.crossOrigin),void 0!==this.responseType&&(l.responseType=this.responseType),null!=this.timeout&&(l.timeout=this.timeout),l.send(null),o.manager.itemStart(t)},setResponseType:function(e){this.responseType=e},setCrossOrigin:function(e){this.crossOrigin=e},setTimeout:function(e){this.timeout=e}},function(){function e(e){this.viewer=e;var t=void 0,r=void 0,i=new THREE.LoadingManager;Object.defineProperties(this,{cachedProperties:{get:function(){return t},set:function(e){t=e}},cachedPropertyFileName:{get:function(){return r},set:function(e){r=e}},loadingManager:{get:function(){return i}}})}var t=e.prototype;return t.getObjectProperty=function(e,a,o){function t(e){return 1===(e=e.split("/")).length?"./":(e.pop(),e.join("/")+"/")}var n=function(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")},s=function(r){for(var i=0;i<Pe.ExternalStringTable.keys.length;i++)!function(){var e=Pe.ExternalStringTable.keys[i],t=Pe.ExternalStringTable.tables[e];e&&t&&(e=n(e),r=r.replace(new RegExp("^"+e+"$","gi"),function(){return""+t}))}();return r},i=function(e){var t=e,r={};if(!Pe.ExternalStringTable||!Pe.ExternalStringTable.keys)return e;for(i in t){var i,n=i;r[i=s(n)]=t[n];for(var a=0;a<r[i].length;a+=2){var o=r[i][a],o=s(o);r[i][a]=o}}return r},l=e.uuid;if((e=this.viewer.getObjectByUUID(l,e.ndsModel.id)).propertyList){for(var r=[],d=0;d<e.propertyList.length;d++){var c=e.propertyList[d];r[d]=i(c)}null!=a&&a({PropertyCategories:r},o)}else{e.refModelUri&&this.referenceMap&&this.referenceMap.has(l)&&(l=this.referenceMap.get(l));var h=e.propertyfile;if(null==h)null!=a&&a(null,o);else if(void 0!==this.cachedProperties&&this.cachedPropertyFileName==h)null!=this.cachedProperties[l]&&null!=a?null!=a&&a(this.cachedProperties[l],o):null!=a&&a(null,o);else{var u=new Rt(this.loadingManager),p=(u.setCrossOrigin("anonymous"),u.setResponseType("arraybuffer"),e.getModel()),f=t(p.modelUri);if(e.refModelUri&&this.referenceMap&&0<e.refModelUri.indexOf("/")){var m=e.refModelUri+"/Configurations.json",g=e.configName;if(this.viewer.configurations&&this.viewer.configurations.has(m))for(var v=this.viewer.configurations.get(m).Configurations,y=0,A=v.length;y<A;++y)if(v[y].Name===e.configName||v[y].Name.replace(/\"/g,"")===e.configName){g=v[y].Folder;break}f=e.refModelUri+"/"+g+"/"}p.rootBodyNode.uuid==e.uuid&&(f=t(p.modelUri));var M,E=this,m=f+h;De.singleHTML?(M=function(e){var t;try{t=pako.inflate(e,{to:"string"}),E.cachedProperties=JSON.parse(t),null!=E.cachedProperties&&(E.cachedPropertyFileName=h,Object.values(E.cachedProperties).forEach(function(e){for(var t=0;t<e.PropertyCategories.length;t++){var r=e.PropertyCategories[t];e.PropertyCategories[t]=i(r)}}),null!=a)&&(null!=E.cachedProperties[l]?a(E.cachedProperties[l],o):a(null,o))}catch(e){null!=a&&a(null,o)}},E.viewer.modelRequestor.propertys.has(p.id)?((!(f=E.viewer.modelRequestor.propertys.get(p.id).get(m))||f.byteLength<1)&&console.error("缺少属性数据"),p=new Uint8Array(f.content),M(p)):(E.viewer.zipMutiModel&&(m=m.replace(/^\.\/|^\//,"")),f=E.viewer.ZIPData.files[m],E.viewer.ZIPData.file(f.name).async("uint8array").then(function(e){M(e)}))):u.load(this.viewer.gobalReqHeader,m,function(e){var t,r;try{t=pako.inflate(e,{to:"string"});try{var i=/\\"/g,n=t.replace(i,""),i=/\\(?!(\u[0-9a-fA-F]{4}|\\$|\\\/))/g,n=n.replace(i,"-");E.cachedProperties=JSON.parse(n)}catch(e){E.cachedProperties=JSON.parse(t)}null!=E.cachedProperties&&(E.cachedPropertyFileName=h,null!=a)&&(null!=E.cachedProperties[l]?a(E.cachedProperties[l],o):(r=l.split("_"),null!=E.cachedProperties[r[0]]?a(E.cachedProperties[r[0]],o):a(null,o)))}catch(e){null!=a&&a(null,o)}},void 0,function(e){null!=a&&a(null,o)},!0)}}},t.bindReference=function(e,t){this.referenceMap||(this.referenceMap=new Map),this.referenceMap.set(e,t)},e}()),Dt=function(){function e(e){this.viewer=e,this.requests=[],this.name="ModelRequestor",this.workUrl=null,this.params={}}var t=e.prototype;return t.loadModel=function(e){},t.addRequest=function(e,t,r,i){this.requests.push({weight:t,uri:e,operate:r,params:i=void 0===i?{}:i})},t.request=function(){},t.createWorker=function(){var e=new Worker(this.workUrl);return e.onmessage=function(e){"loadModelInfo"!==e.data.operate&&"getModelData"!==e.data.operate&&"loadBrepData"!==e.data.operate&&"loadChunkBuffer"!==e.data.operate&&e.data.operate},e.addTask=function(e){this.workingRequestCount++,this.postMessage(e),e.operate,"loadModelInfo"!==e.operate&&e.operate},e},t.createBrepManager=function(e,t,r){return null},t.createPropertyManager=function(e){return null},e}(),Pt=function(){function e(e){this.viewer=e,this.modelRequestorsMap=new Map}var t=e.prototype;return t.registerModelRequestor=function(e){this.modelRequestorsMap.has(e.name)||this.modelRequestorsMap.set(e.name,e)},t.unRegisterModelRequestor=function(e){if(this.modelRequestorsMap.has(e.name))return this.modelRequestorsMap.delete(e.name)},t.createModelRequestor=function(e,t){return void 0===t&&(t={}),void 0===e&&(e=this.viewer.isDisaModel?"DISAModelRequestor":"NdsModelRequestor"),this.modelRequestorsMap.has(e)?((e=this.modelRequestorsMap.get(e)).params=t,e):null},e}();function Ht(e,t){var r,i="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(i)return(i=i.call(e)).next.bind(i);if(Array.isArray(e)||(i=function(e,t){{var r;if(e)return"string"==typeof e?_t(e,t):"Map"===(r="Object"===(r={}.toString.call(e).slice(8,-1))&&e.constructor?e.constructor.name:r)||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_t(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length)return i&&(e=i),r=0,function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}};throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _t(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,i=Array(t);r<t;r++)i[r]=e[r];return i}function Lt(e,t){return(Lt=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}function Ot(e,t){return t&&t.needs&&0<t.needs.length&&t.ignores&&(t.ignores=null),{modelId:e,hasRefModel:!1,filter:{needs:t&&t.needs&&0<t.needs.length?new Set(t.needs):null,ignores:t&&t.ignores&&0<t.ignores.length?new Set(t.ignores):null},configurations:new Map,bodyNode_sptIndexNode:new WeakMap,modelCaches:new Map,uniqueMaterialMap:new Map,uuidMaterialMap:new Map,uniquePMIMaterialMap:new Map,uuidPMIMaterialMap:new Map,allModelLoaded:!1}}var Ft=function(r){function e(e,_){function E(e){return 1===(e=e.split("/")).length?"./":(e.pop(),e.join("/")+"/")}function L(e,t){void 0===e&&(e=10);var r=null;if(F.zipModelWorker){if(K.zipModelWorker.has(t))return K.zipModelWorker.get(t);if(0!=K.zipModelWorker.size)return K.zipModelWorker.entries().next().value[1]}return 0<h.length&&(h.sort(function(e,t){return e.workingRequestCount-t.workingRequestCount}),0===h[0].workingRequestCount)?h[0]:(h.length<i?(r=n(),h.push(r)):h[0].workingRequestCount<e&&(r=h[0]),r)}function w(e,t,a,r,d){var c=new St(null,d.SDFMaker,F.viewer,d).parse(e,{basUri:t,modelId:a,keepSourceFile:r,modelRequestor:F,StoploadBrep:!0,refModelContext:O});if(c.rootObject.bodyNodeRoot&&c.rootObject.sptIndexRoot&&O.bodyNode_sptIndexNode.set(c.rootObject.bodyNodeRoot,c.rootObject.sptIndexRoot),d.isSketchModel||F.viewer.loadCallback(c.rootObject.objectRoot,e.modelContent.lightsPreset),c.rootObject.pmiObjectRoot&&d.addPMIObject(c.rootObject.pmiObjectRoot),c.binResquester.chunkRequests&&0<c.binResquester.chunkRequests.length)for(var i=0;i<c.binResquester.chunkRequests.length;++i)!function(i){c.binResquester.chunkRequests[i].parameters.modelId=a,c.binResquester.chunkRequests[i].parameters.keepSourceFile=r;var n=c.binResquester.chunkRequests[i].url;K.viewer.ZIPData.file(n).async("uint8array").then(function(e){var t={isPMI:!1,keepSourceFile:!1,modelId:a,operate:"loadChunkBuffer",state:"successed",url:n},e=new Uint8Array(e),r=new ArrayBuffer(c.binResquester.chunkRequests[i].parameters.bufferlenth),e=new yt.Stream(e),r=(e.readInt32(),new Uint8Array(r)),r=new yt.BIMStream(r,0,1);y.decompress(e,e,r,r.data.length),t.chunkData=r.data,t.bufferlenth=c.binResquester.chunkRequests[i].parameters.bufferlenth,j.push(t),G.set(n,c.binResquester.chunkRequests[i])})}(i);if(c.binResquester.pmiGeomRequests&&0<c.binResquester.pmiGeomRequests.length)for(var n=0;n<c.binResquester.pmiGeomRequests.length;++n)!function(s){c.binResquester.pmiGeomRequests[s].isPMI=!0,c.binResquester.pmiGeomRequests[s].parameters.modelId=a,c.binResquester.pmiGeomRequests[s].parameters.keepSourceFile=r;var l=c.binResquester.pmiGeomRequests[s].url;K.viewer.ZIPData.file(l).async("uint8array").then(function(e){var e=new Uint8Array(e),t=new ArrayBuffer(c.binResquester.pmiGeomRequests[s].parameters.bufferlenth),t=((e=new yt.Stream(e)).readInt32(),new Uint8Array(t)),t=new yt.BIMStream(t,0,1),r=(y.decompress(e,e,t,t.data.length),c.binResquester.pmiGeomRequests[s]),i=!r.parameters.geometriesArray,n=i?r.parameters.ndsGeometriesArray:r.parameters.geometriesArray,e=new yt.Stream(t.data),a=((new $).readBIMBuffer(e,null,n,null,d.is2DModel),n.length);if(r.parameters.ndsGeometriesArray)for(var o=0;o<a;++o)i||r.parameters.ndsGeometriesArray[o].copy(r.parameters.geometriesArray[o]),r.parameters.ndsGeometriesArray[o].loaded=!0,r.parameters.ndsGeometriesArray[o].bufferChunkUrl=l})}(n)}var O,F=r.call(this,e)||this,t=(F.viewer=e,F.name="NdsModelRequestor",new Map),U=[],N=new Map,V=[],G=new Map,k=new Map,j=[],z=[],A=0,i=Pe.isMobileDevice()&&(Pe.isIOSDevice()||Pe.isIpadDevice())?6:7,W=new Map,X=new Map,q=-1,Y=null,Q=-1,M=new Map,K=F,Z=(F.pauseRequest=new Set,F.zipModelWorker=new Map,F.propertys=new Map,F.loadModel=function(e){t.has(e)?F.viewer.__addModel(t.get(e)):F.addRequest(e,999999,"loadModelInfo")},F.addRequest=function(e,t,r,i){U.push({weight:t,uri:e,operate:r,params:i=void 0===i?{}:i})},function(e,t,r){var i=r=void 0===r?"0":r;if(t.configName&&"0"!==t.configName&&O.configurations.has(e)&&(n=O.configurations.get(e))){if(!n.loaded)return null;for(var n,a=0,o=(n=n.Configurations).length;a<o;++a)if(n[a].Name===t.configName||n[a].Name.replace(/\"/g,"")===t.configName){i=n[a].Folder;break}}return t.path+"/"+i+"/model.js"}),n=function(){var e,t,r;return(e=K.viewer.serverUrl?(t=new Blob(['importScripts("'+De.NdsLoadWorkerUrl+'")'],{type:"application/javascript"}),r=window.URL.createObjectURL(t),new Worker(r)):De.singleHTML?(e=K.viewer.workerString,t=new Blob([e],{type:"application/javascript"}),r=window.URL.createObjectURL(t),new Worker(r)):new Worker(De.NdsLoadWorkerUrl)).workingRequestCount=0,e.onmessage=function(a){if("loadModelInfo"===a.data.operate)this.workingRequestCount--,K.viewer.__addModel(a.data.res);else if("getModelData"===a.data.operate)"successed"===a.data.res.state?(e=a.data.res,N.set(a.data.url,e),this.workingRequestCount--,O.modelCaches.get(a.data.url).state="prepared",e.keepSourceFile&&!M.has(e.modelId)&&M.set(e.modelId,{url:a.data.url,modelSourceData:e.jsonMain.modelSourceData,modelContentSourceData:e.jsonMain.modelContentSourceData,bvhSourceData:e.jsonMain.bvhSourceData,pmiContentSourceData:e.jsonMain.pmiContentSourceData,animationSourceData:e.jsonMain.animationFileSourceData,geomBins:[],PropertyFile:[]})):"loading"===a.data.res.state?N.get(a.data.url).state="loading":(N.get(a.data.url).state="failed",this.workingRequestCount--,O.modelCaches.get(a.data.url).state="failed");else if("loadBrepData"===a.data.operate){var t;this.workingRequestCount--,K.viewer.ndsModel.setActiveModelByModelId(a.data.modelId),"successed"!==a.data.state?(console.log("load "+a.data.url+" failed"),K.viewer.ndsModel.activeModel.brepManager.onError(a.data.url.uri)):(e=new $,t=null,e=(K.viewer.ndsModel.models.forEach(function(e){e.id==a.data.modelId&&(t=e.brepManager)}),e.parseBrep(a.data.brepData,{brepManager:t},null)),a.data.keepSourceFile&&(s=M.get(a.data.modelId))&&(s.brepSourceData={url:a.data.url,data:a.data.brepSourceData}),K.viewer.ndsModel.activeModel.brepManager.onLoad(a.data.url,e.BbodyVolume,e.BbodyVolume,e.BfaceArea))}else if("loadChunkBuffer"===a.data.operate){var e;this.workingRequestCount--,"successed"!==a.data.state?console.log("load "+a.data.url+" failed"):a.data.isPMI?(z.push(a.data),a.data.keepSourceFile&&(s=M.get(a.data.modelId))&&(s.pmiGeomBin={url:a.data.url,data:a.data.chunkSourceData})):(j.push(a.data),a.data.keepSourceFile&&(e=M.get(a.data.modelId))&&e.geomBins.push({url:a.data.url,data:a.data.chunkSourceData}))}else if("propertyfile"===a.data.operate)if(this.workingRequestCount--,"successed"!==a.data.state)console.log("load "+a.data.url+" failed");else{if(a.data.keepSourceFile){var r=M.get(a.data.modelId);if(r){for(var i=!0,n=0;n<r.PropertyFile.length;n++)if(r.PropertyFile[n].uri==a.data.url){i=!1;break}i&&r.PropertyFile.push({url:a.data.url,data:a.data.PropertySourceData})}}if(a.data.propertyBindNode){var o,s=pako.inflate(a.data.PropertySourceData,{to:"string"}),l=JSON.parse(s),d=K.viewer.ndsModel.getModelById(a.data.modelId);for(o in l){var c,h=o.split("-"),u=K.viewer.getBodyNodeFromUuid(h[0],a.data.modelId);u&&(1===h.length?(c=l[o].PropertyCategories)&&(u.propertyList=c):(u.propertyList=u.propertyList||[],c=h[1],(h=l[o].PropertyCategories)&&(u.propertyList[c]=h[0])),d.bodyUuid2ClonedNodeMap[u.uuid])&&(d.bodyUuid2ClonedNodeMap[u.uuid].propertyList=u.propertyList)}++A===K.viewer.propertyFielSet.size&&K.viewer.dispatchEvent({type:"loadedPropertyEnd"})}}else if("requestRefModel"===a.data.operate){var p=function(e,t,r){(r=void 0===r?!1:r)?U.push({weight:a.data.weight,path:e,operate:"loadModelData",needsConfName:!0,params:{keepSourceFile:a.data.keepSourceFile,modelId:a.data.modelId,refUUID:t}}):(O.modelCaches.has(e)||O.modelCaches.set(e,{state:"waiting",numRef:0,numRefParsedMap:new Map,numRequest:0}),U.push({weight:a.data.weight,uri:e,operate:"loadModelData",params:{keepSourceFile:a.data.keepSourceFile,modelId:a.data.modelId,refUUID:t}}))};if(De.singleHTML)for(var f=0;f<a.data.refModelConfigurations.length;++f){var m=a.data.refModelConfigurations[f],g=a.data.refModelPathes[f].path+"/Configurations.json";O.configurations.has(g)||(m.loaded=!0,O.configurations.set(g,m))}O.filter.ignores&&(a.data.refUUID&&O.filter.ignores.has(a.data.refUUID)||a.data.fileUUID&&O.filter.ignores.has(a.data.fileUUID))?(O.filter.ignores.add(a.data.uuid),a.data.refUUID&&O.filter.ignores.add(a.data.refUUID),a.data.refModelPathes.length=0):O.filter.needs&&a.data.uuid&&O.filter.needs.add(a.data.uuid);for(var v=0;v<a.data.refModelPathes.length;++v)!function(){var e=a.data.refModelPathes[v];if(O.filter.needs&&("Part"!==e.type||a.data.fileUUID&&O.filter.needs.has(a.data.fileUUID))&&O.filter.needs.add(e.uuid),O.filter.ignores&&((O.filter.ignores.has(a.data.refUUID)||a.data.fileUUID&&O.filter.ignores.has(a.data.fileUUID))&&O.filter.ignores.add(e.uuid),O.filter.ignores.has(e.uuid)))return O.filter.needs&&O.filter.needs.has(e.uuid)&&O.filter.needs.delete(e.uuid);if("0"===e.configName){var t=e.path+"/0/model.js";p(t,e.uuid)}else{var r=e.path+"/Configurations.json";if(O.configurations.has(r)){t=Z(r,e);t?p(t,e.uuid):p(e,e.uuid,!0)}else{O.configurations.set(r,{loaded:!1});var i=new Headers;if(K.viewer.gobalReqHeader)for(var n in K.viewer.gobalReqHeader)i.append(n,K.viewer.gobalReqHeader[n]);fetch(r,{headers:i}).then(function(e){return e.json()}).then(function(e){e.loaded=!0,O.configurations.set(r,e)}).catch(function(e){O.configurations.set(r,{loaded:!0,Configurations:[]})}),p(e,e.uuid,!0)}}}();O.hasRefModel=!0}else{var y;"loadModelZip"===a.data.operate?(this.workingRequestCount--,K.pauseRequest.delete(a.data.modelID)):"loadModelPropertys"===a.data.operate&&(this.workingRequestCount--,y=new Map,Object.keys(a.data.propertys).forEach(function(e){y.set(e,a.data.propertys[e])}),K.propertys.set(a.data.modelID,y))}},e.addTask=function(e){this.workingRequestCount++,this.postMessage(e),"loadModelData"===e.operate&&0,"loadModelInfo"===e.operate?X.set(e.url,this):"loadChunkBuffer"!==e.operate&&W.set(e.url,this)},e},h=[],J=(F.releaseWorker=function(e,t){if(void 0===t&&(t=!1),!0===(e=void 0===e?!0:e)){for(var r=!0,i=0;i<h.length;++i)if(0<h[i].workingRequestCount){r=!1;break}if(r||t){for(var n=0;n<h.length;++n)h[n].terminate();h=[],X.clear(),W.clear()}}else{for(var a=new Set,o=Ht(K.zipModelWorker.values());!(s=o()).done;){var s=s.value;a.add(s)}for(var l=0;l<h.length;++l)a.has(h[l])||h[l].terminate();h=[];for(var d=Ht(a.values());!(c=d()).done;){var c=c.value;h.push(c)}}},F.setZipData=function(a,t){var i=E(a);F.viewer.ZIPData.file(a).async("string").then(function(e){e={jsonMain:JSON.parse(e),keepSourceFile:!1,modelId:t,state:"zipfile",type:"zip"};N.set(a,e)}).then(function(){var e,n=N.get(a).jsonMain;n.modelContentFile?(e=i+n.modelContentFile,K.viewer.ZIPData.file(e).async("uint8array").then(function(t){if(t&&0!==t.byteLength){t=pako.inflate(t,{to:"string"});try{var e=/\\"/g,r=t.replace(e,""),e=/\\(?!\u[0-9a-fA-F]{4})/g,r=r.replace(e,"-"),i=JSON.parse(r)}catch(e){i=JSON.parse(t)}i.objectIdType=n.objectIdType,i.materialIdType=n.materialIdType,i.geomIdType=n.geomIdType,i.instanceIdType=n.instanceIdType,n.modelContent=i,n.modelContentState=1,(n.pmiContentState=1==n.bvhDataState&&1==n.modelContentState)&&(N.get(a).state="successed")}else n.modelContentState=-1})):(n.modelContentState=1,(n.pmiContentState=1==n.bvhDataState&&1==n.modelContentState)&&(N.get(a).state="successed"))}).then(function(){var e,r=N.get(a).jsonMain;r.bvh?(r.bvhDataState=0,e=i+r.bvh,K.viewer.ZIPData.file(e).async("uint8array").then(function(e){var t;e&&0!==e.byteLength?(e=new Uint8Array(e),t=new ArrayBuffer(r.bvhBufferLength),(e=new yt.Stream(e)).readInt32(),t=new Uint8Array(t),t=new yt.BIMStream(t,0,1),y.decompress(e,e,t,t.data.length),r.bvhData=t.data,(r.bvhDataState=1)===r.pmiContentState&&1===r.bvhDataState&&1===r.modelContentState&&(N.get(a).state="successed")):r.bvhDataState=-1})):(r.bvhDataState=1)===r.pmiContentState&&1===r.bvhDataState&&1===r.modelContentState&&(N.get(a).state="successed")}).then(function(){var e,t=N.get(a).jsonMain;t.pmiContentFile?(t.pmiContentState=0,e=i+t.pmiContentFile,K.viewer.ZIPData.file(e).async("uint8array").then(function(e){e&&0!==e.byteLength?(e=pako.inflate(e,{to:"string"}),e=JSON.parse(e),t.pmiContent=e,(t.pmiContentState=1)===t.pmiContentState&&1===t.bvhDataState&&1===t.modelContentState&&(N.get(a).state="successed")):t.pmiContentState=-1})):(t.pmiContentState=1)===t.pmiContentState&&1===t.bvhDataState&&1===t.modelContentState&&(N.get(a).state="successed")}).then(function(){var r,e=N.get(a).jsonMain;e.modelBrepData&&(r=i+e.modelBrepData,K.viewer.ZIPData.file(r).async("uint8array").then(function(e){var t;e&&0!==e.byteLength&&(e=pako.inflate(e),t=new $,null==K.viewer.ndsModel.activeModel.brepManager&&(K.viewer.ndsModel.activeModel.brepManager=new At(K.viewer,K,K.viewer.ndsModel.activeModel)),t=t.parseBrep(e,{brepManager:K.viewer.ndsModel.activeModel.brepManager},null),K.viewer.ndsModel.activeModel.brepManager.onLoad(r,t.BbodyVolume,t.BbodyVolume,t.BfaceArea))}))})},F.afterModelLoaded=function(e){var t;O.allModelLoaded=!0,e.isSketchModel||(K.viewer.configurations=O.configurations),(t=O).configurations=new Map,t.bodyNode_sptIndexNode=new WeakMap,t.filter={needs:null,ignores:null},t.modelCaches.forEach(function(e,t,r){e.node&&(e.node.jsonMain.bvhData=null,e.node.jsonMain.modelContent=null,e.node.jsonMain.productData=null,e.node.jsonMain.pmiContent=null,e.node.jsonMain=null,e.node=null)}),t.modelCaches=new Map,t.uniqueMaterialMap=new Map,t.uuidMaterialMap=new Map,t.uniquePMIMaterialMap=new Map,t.uuidPMIMaterialMap=new Map,e.isSketchModel||K.viewer.dispatchModelEvent({type:"BVHInfoEvent",hasbvh:!1})},new Map);F.request=function(){for(;U.length&&0!==function(){if(De.singleHTML&&K.pauseRequest&&K.pauseRequest.has(U[0].params.modelId))return 0;if(U[0].needsConfName){var e=U[0].path.path+"/Configurations.json";if(O.configurations.has(e)){e=Z(e,U[0].path);if(!e)return 0;U[0].uri=e,U[0].needsConfName=!1,O.modelCaches.has(e)||O.modelCaches.set(e,{state:"waiting",numRef:0,numRefParsedMap:new Map,numRequest:0})}}if(De.singleHTML&&!K.viewer.zipMutiModel){e=U.shift();q!==e.params.modelId&&(q=e.params.modelId,O=Ot(q),Y=null),"zip"===e.params.type&&F.setZipData(e.uri,e.params.modelId)}else{var t=null;if(!(t="loadModelData"===U[0].operate?X.has(U[0].uri)?X.get(U[0].uri):W.has(U[0].uri)?W.get(U[0].uri):U[0].params.isProxy?1:L(10,U[0].params.modelId):L(10,U[0].params.modelId)))return 0;var r,i=U.shift();if("js_zip"===i.params.type)return q!==i.params.modelId&&(q=i.params.modelId,O=Ot(q,i.params.filter),Y=null),i.params.type="js",U.push(i),r={operate:"loadModelZip",modelID:i.params.modelId,gobalReqHeader:K.viewer.gobalReqHeader},F.viewer.ZIPData?F.viewer.ZIPData.generateAsync({type:"blob"}).then(function(e){r.zip=e,t.addTask(r)}).catch(function(e){console.error("创建失败：",e)}):(r.url=F.viewer.zipModelURLs.get(i.uri),t.addTask(r)),K.pauseRequest.add(i.params.modelId),K.zipModelWorker.set(i.params.modelId,t),1;if("loadModelData"===i.operate){if(q!==i.params.modelId&&(q=i.params.modelId,O=Ot(q,i.params.filter)),Y=null,i.params.isProxy){Y=F.viewer.ndsModel.getModelById(i.params.modelId);for(var n=0;n<i.params.urls.length;++n){var a=i.params.urls[n]+"/model.js";O.modelCaches.has(a)||O.modelCaches.set(a,{state:"waiting",numRef:0,numRefParsedMap:new Map,numRequest:0}),U.push({weight:1e4,uri:a,operate:"loadModelData",params:{keepSourceFile:i.params.keepSourceFile,modelId:i.params.modelId}})}return 1}if(O.modelCaches.has(i.uri)){e=O.modelCaches.get(i.uri);if(0<e.numRequest)return e.numRequest++,1;e.numRequest++,e.state="requesting"}else O.modelCaches.set(i.uri,{state:"requesting",numRef:0,numRefParsedMap:new Map,numRequest:1})}else if("loadModelPropertys"===i.operate)return K.propertys&&K.propertys.has(modelId)||t.addTask({operate:i.operate,modelID:i.params.modelId}),1;t.addTask({operate:i.operate,url:i.uri,refUUID:i.params.refUUID,keepSourceFile:!!i.params.keepSourceFile,modelId:i.params.modelId,gobalReqHeader:K.viewer.gobalReqHeader,propertyBindNode:!!i.params.propertyBindNode})}}(););for(O&&O.modelCaches.forEach(function(e,t,r){"requesting"===e.state&&(e=W.get(t))&&(e.postMessage({operate:"getModelData",url:t}),N.set(t,{state:"asking"}))});V.length;)if(V[0].isRefChunk){var e=V.shift();G.set(e.url,e),j.push({url:e.url,modelId:e.parameters.modelId})}else{e=L(5,V[0].parameters.modelId);if(!e)break;var t=V.shift();e.addTask({operate:"loadChunkBuffer",url:t.url,isPMI:!!t.isPMI,bufferlenth:t.parameters.bufferlenth,modelId:t.parameters.modelId,keepSourceFile:!!t.parameters.keepSourceFile,gobalReqHeader:K.viewer.gobalReqHeader,isDraco:!!t.parameters.isDraco}),t.state="loading",(t.isPMI?k:G).set(t.url,t)}if(O&&O.allModelLoaded){for(var r=0,i=j.length;r<i;++r){var n=F.viewer.ndsModel.getModelById(j[0].modelId);if(!(n.state<ee.StateType.RENDERING_PREPARED)){var a=j.shift(),o=G.get(a.url);if(G.delete(a.url),!o.isRefChunk)if(void 0===o.parameters.geomChunkGroup||1===o.parameters.geomChunkGroup.geomChunkUrl.length){var s=(b=!o.parameters.geometriesArray)?o.parameters.ndsGeometriesArray:o.parameters.geometriesArray;if(o.parameters.compress){var l=new yt.Stream(a.chunkData),d=new $({ndsModel:n}),c=(o.parameters.isDraco?d.readBIMBufferDraco(l,function(){},s,null,o.parameters.needsLineType):d.readBIMBuffer(l,null,s,null,o.parameters.needsLineType),s.length);if(o.parameters.ndsGeometriesArray)for(var h=0;h<c;++h)b||o.parameters.ndsGeometriesArray[h].copy(o.parameters.geometriesArray[h]),o.parameters.ndsGeometriesArray[h].loaded=!0,o.parameters.ndsGeometriesArray[h].bufferChunkUrl=a.url}}else{J.set(a.url,{chunkData:a,chunkInfo:o});var u=o.parameters.geomChunkGroup,p=[],f=!0;if(!u.isProcessed){for(var m=0;m<u.geomChunkUrl.length;++m){var g=u.geomChunkUrl[m];if(!J.has(g)){f=!1;break}p.push(J.get(g))}if(f){u.isProcessed=!0;for(var v=[],y=[],A=void 0,M=void 0,E=0;E<p.length;++E){a=p[E].chunkData,o=p[E].chunkInfo,J.delete(a.url);var w,s=(b=!o.parameters.geometriesArray)?o.parameters.ndsGeometriesArray:o.parameters.geometriesArray;o.parameters.compress&&(w=new yt.Stream(a.chunkData),v.push(w),y.push(s),A=o.parameters.needsLineType,M=o.parameters.isDraco)}d=new $({ndsModel:n});M||d.readMultipleBIMBuffer(v,null,y,null,A);for(var x=0;x<p.length;++x){var b,a=p[x].chunkData,s=(b=!(o=p[x].chunkInfo).parameters.geometriesArray)?o.parameters.ndsGeometriesArray:o.parameters.geometriesArray;if(o.parameters.compress){c=s.length;if(o.parameters.ndsGeometriesArray)for(h=0;h<c;++h)b||o.parameters.ndsGeometriesArray[h].copy(o.parameters.geometriesArray[h]),o.parameters.ndsGeometriesArray[h].loaded=!0,o.parameters.ndsGeometriesArray[h].bufferChunkUrl=a.url}}}}}}}for(var B=z.length;r<B;++r){var I=z.shift(),T=k.get(I.url),S=(k.delete(I.url),!T.parameters.geometriesArray),R=S?T.parameters.ndsGeometriesArray:T.parameters.geometriesArray,C=new yt.Stream(I.chunkData),c=((new $).readBIMBuffer(C,null,R,null,!1),R.length);if(T.parameters.ndsGeometriesArray)for(h=0;h<c;++h)S||T.parameters.ndsGeometriesArray[h].copy(T.parameters.geometriesArray[h]),T.parameters.ndsGeometriesArray[h].loaded=!0,T.parameters.ndsGeometriesArray[h].bufferChunkUrl=I.url}if(0<r)_.onBufferChunkCallback&&Y&&(D=!0,(!O.allModelLoaded||0<V.length||0<G.size||0<k.size)&&(D=!1),Y.isSketchModel?D&&(Y.state=ee.StateType.PREPARED,Y=null):(_.onBufferChunkCallback(D,!0),D&&(Y.afterAllGeomLoaded(),Y=null)));else{var D=!0;if((D=!O.allModelLoaded||0<V.length||0<G.size||0<k.size?!1:D)&&F.viewer.ndsModel&&F.viewer.ndsModel.activeModel){for(var P=0,H=0;H<F.viewer.ndsModel.models.length;H++)P+=F.viewer.ndsModel.models[H].meshManager.geomManager.geoms.length;Y&&0===Y.meshManager.geomManager.geoms.length&&Y.state<ee.StateType.ALL_GEOM_LOADED&&(Y.afterAllGeomLoaded(),F.viewer.dispatchModelEvent({type:"geometryAllLoadedEvent",modelLoadedTime:0,wholeModelLoadedTime:0,modelInfo:{}}),F.viewer.loadRemainExtension(),Y=null),0!==P||F.viewer.GeomEmpty?0<P&&F.viewer.GeomEmpty&&(F.viewer.GeomEmpty=!1):(F.viewer.dispatchEvent({type:"GeomEmpty"}),F.viewer.dispatchEvent({type:"loadBegin"}),F.viewer.dispatchAsyncEvent({type:"geometryLoadedEvent"}),F.viewer.GeomEmpty=!0)}D&&F.viewer.ndsModel&&F.viewer.ndsModel.activeModel&&0<F.viewer.ndsModel.meshManager.geomManager.geoms.length&&0<Q&&(_.onBufferChunkCallback(D,!0),Y&&(Y.afterAllGeomLoaded(),Y=null),Q=-1)}}},F.initRequest=function(){q=-1,O=null,W=new Map};return F.tryMergeNode=function(e,t,r,i){var n;if(Y=Y||t,!(n=e.configName?(n=e.path+"/Configurations.json",Z(n,e,t.isProxyModel?e.configName:"0")):e))return!1;if(r&&O.filter.ignores&&O.filter.ignores.has(r.uuid))return r.ignored=!0;var e=!1,a=N.get(n),o=0;if(!a&&O.modelCaches&&O.modelCaches.has(n)&&"loaded"===(l=O.modelCaches.get(n)).state&&(a=l.node,o=++l.numRef,i)&&r&&((s=l.numRefParsedMap.get(r.refModelUri))?(null==s.count&&(s.count=0),++s.count,r.refNum=s.count+1,1==s.count&&s.firstParseNode&&(s.firstParseNode.refNum=1)):l.numRefParsedMap.set(r.refModelUri,{firstParseNode:r})),a&&"successed"===a.state&&"zip"===a.type){var s=E(n);w(a.jsonMain,s,a.modelId,a.keepSourceFile,t),N.delete(n),e=!0}else if(a&&"successed"===a.state&&i){var l=E(n);if(-1===t.dataVersion&&(t.dataVersion=Number(a.jsonMain.metadata.version)),O.filter.needs&&r&&"Part"===r.type?a.jsonMain.modelContent.object.externalRefUuid&&!O.filter.needs.has(a.jsonMain.modelContent.object.externalRefUuid)&&r.parent&&r.parent.externalRefUuid&&!O.filter.needs.has(r.parent.externalRefUuid)&&!O.filter.needs.has(a.jsonMain.modelContent.object.uuid)&&(r.ignored=!0):O.filter.ignores&&r&&(a.jsonMain.modelContent.object.externalRefUuid&&O.filter.ignores.has(a.jsonMain.modelContent.object.externalRefUuid)||O.filter.ignores.has(a.jsonMain.modelContent.object.uuid))&&(r.ignored=!0),!r||!r.ignored){var s=a.jsonMain,i=l,d=a.modelId,c=a.keepSourceFile,h=t,l=r,t=o,u=(s.metadata&&"CATIA"==s.metadata.format&&(F.viewer._CATIA=!0),F.viewer.getExtension("NDSAnimationEditExtension")&&1==F.viewer.ndsModel.models.length&&F.viewer.getExtension("NDSAnimationEditExtension").setModelSourceData(s.modelSourceData),new St(null,h.SDFMaker,F.viewer,h).parse(s,{basUri:i,modelId:d,numRef:t,needsPMI:h.needsPMI,needsAnimation:h.needsAnimation,needsSketchModel:h.needsSketchModel,needsProperty:h.needsProperty,needsBRep:h.needsBRep,keepSourceFile:c,modelRequestor:F,parentNode:l,parentSptIndexNode:null,refModelContext:O,hasRefModel:!!s.hasRefModel,modelUri:h.modelUri}));if(u.rootObject.bodyNodeRoot&&u.rootObject.sptIndexRoot&&O.bodyNode_sptIndexNode.set(u.rootObject.bodyNodeRoot,u.rootObject.sptIndexRoot),l||(h.hasRefModel=O.hasRefModel),h.isSketchModel||s.modelContent.lightsPreset,u.rootObject.pmiObjectRoot&&h.addPMIObject(u.rootObject.pmiObjectRoot),u.binResquester.chunkRequests&&0<u.binResquester.chunkRequests.length){for(var p=0;p<u.binResquester.chunkRequests.length;++p)u.binResquester.chunkRequests[p].parameters.modelId=d,u.binResquester.chunkRequests[p].parameters.needsLineType=!h.isECAD2DModel&&(h.is2DModel||h.isSketchModel),u.binResquester.chunkRequests[p].parameters.keepSourceFile=c;V=V.concat(u.binResquester.chunkRequests)}else Q=F.viewer.is2DModel?u.binResquester.chunkRequestsTextNum:-1;if(u.binResquester.pmiGeomRequests&&0<u.binResquester.pmiGeomRequests.length){for(var f=0;f<u.binResquester.pmiGeomRequests.length;++f)u.binResquester.pmiGeomRequests[f].isPMI=!0,u.binResquester.pmiGeomRequests[f].parameters.modelId=d,u.binResquester.pmiGeomRequests[f].parameters.keepSourceFile=c;V=V.concat(u.binResquester.pmiGeomRequests)}if(N.delete(n),r&&"Assembly"===r.type)if(O.filter.needs&&r.parent&&O.filter.needs.has(r.parent.externalRefUuid)&&O.filter.needs.add(r.externalRefUuid),O.filter.needs&&O.filter.needs.has(r.externalRefUuid))for(var m=0,g=r.children.length;m<g;++m){var v=r.children[m];O.filter.ignores&&O.filter.ignores.has(v.uuid)||O.filter.needs.add(v.uuid)}else if(O.filter.ignores&&O.filter.ignores.has(r.externalRefUuid))for(var y=0,A=r.children.length;y<A;++y){var M=r.children[y];O.filter.ignores.add(M.uuid)}}a.cached||(o=O.modelCaches.get(n))&&(o.state="loaded",a.cached=!0,o.node=a,r)&&!o.numRefParsedMap.has(r.refModelUri)&&o.numRefParsedMap.set(r.refModelUri,{firstParseNode:r}),e=!0}else a&&"loading"!==a.state?a&&"failed"===a.state&&(O.modelCaches.get(n).state="failed",F.viewer.loadErrorCallback(n+" load failed",O.hasRefModel),e=!0):(i=W.get(n))&&(i.postMessage({operate:"getModelData",url:n}),N.set(n,{state:"asking"}));return e},F.getModelSourceFile=function(){return M},F.createBrepManager=function(e,t,r){return new At(e,t,r)},F.createPropertyManager=function(e){return new Ct(e)},F}var t,i;return i=r,(t=e).prototype=Object.create(i.prototype),Lt(t.prototype.constructor=t,i),e}(Dt);function Ut(e,t){return e.z-t.z}function Nt(e,t,r){void 0===r&&(r=0),this.id=e,this.z=t,this.t=r}Ce.globalModelId=0;var ee=function n(e,t,r){var a,o,s,l,d,c=this;if(void 0===r&&(r={}),this.viewer=e,this.params=r,this.id=void 0!==r.modelId&&null!==r.modelId?r.modelId:Ce.globalModelId++,this.id>Ce.globalModelId&&(Ce.globalModelId=this.id+1),this.typeName="NDSModel",this.dataVersion=-1,this.keepSourceFile=!!r.keepSourceFile,this.type=r.type,this.filter=r.filter,this.layersMask=new THREE.Layers,this.nodeRequestor=r.nodeRequestor||new Ft(this,{loadingManager:r.loadingManager,onLoadCallback:r.onLoadCallback,onRenderSettingCallback:r.onRenderSettingCallback,onBufferChunkCallback:r.onBufferChunkCallback,onLoadErrorCallback:r.onLoadErrorCallback}),this.modelUri=t,this.geomManager=new O(e),this.meshManager=new rt(this.geomManager,this),this.brepManager=new At(this.viewer,this.nodeRequestor,this),this.referenceEntityDispManager=new Ze(this),this.sptIndex=new at(null,this.meshManager),this.position=new THREE.Vector3(0,0,0),this.rotation=new THREE.Quaternion,this.scale=new THREE.Vector3(1,1,1),r.position&&(this.position.x=r.position.x,this.position.y=r.position.y,this.position.z=r.position.z),r.rotation&&this.rotation.setFromEuler(new THREE.Euler(r.rotation.x,r.rotation.y,r.rotation.z)),r.scale&&(this.scale.x=r.scale.x,this.scale.y=r.scale.y,this.scale.z=r.scale.z),r.matrix){for(var i=new THREE.Matrix4,h=0;h<16;++h)i.elements[h]=r.matrix[h];i.decompose(this.position,this.rotation,this.scale)}this.meshSets=[],this.lineSegmentsSet=new U(this.meshManager),this.SHADED_WITH_EDGES=1,this.SHADED=2,this.WIREFRAME=3,this.HIDDEN_LINE_REMOVE=4,this.HIDDEN_LINE_VISIBLE=5,this.TRANSPARENT=6,this.drawMode=1,this.renderOnce=!1,this.renderMeshSetCount=0,this.spriteDirty=!0,this.rootBodyNode=null,this.bodyUuid2NodeMap={},this.bodyUuid2ClonedNodeMap={isEmpty:!0},this.PMIUUIDtoPMIObject={},this.meshUuid2GeomUuidMap={},this.assamblyNodes=[],this.fileguidTouuid={},this.objectidTouuid={},this.is2DModel=!1,this.needsAnimation=void 0===r.needsAnimation||r.needsAnimation,this.needsProperty=void 0===r.needsProperty||r.needsProperty,this.needsBRep=void 0===r.needsBRep||r.needsBRep,this.state=n.StateType.UNLOAD,this.loadedProperty=!1,this.forceRenderAll=!1,this.wholeLeafBodyNodes=[],this.wholeRefEntityNodes=[],this.wholeCoordinateNodes=[],this.emptyBodyNodes=[],this.hasRawMesh=!1,this.transparentBodies=[],this.transparentBodiesDirty=!1,this.transparentBodyChanged=!1,this.containsOriginalTransparentBodies=!1,this.transparentizedBodies=[],this.transparentModeBodiesMap=new Map,this.selectedBodies=[],this.selectedBodiesDirty=!1,this.draggedBodies=[],this.hideBodies=[],this.UnloadNodes=[],this.pureLineBody=[],this.preselectedObject=null,this.hasHiddenBodies=!1,this.referenceEntityDirty=!1,this.LeafbodyToFirstBodyMap=new Map,this.leafNodeCount=0,this.tempCenterBox=new THREE.Vector3,this.bodyNodeUUidToMaterial={},this.ModelUpMatrix4=[],this.layers=null,this.layerGroups=null,this.NeedsMergeBodyNode=!1,this.useTransparentList=e.useTransparentList,this.transparentList=e.transparentList,this.useUnvisibleList=e.useUnvisibleList,this.unvisibleList=e.unvisibleList,this.sketchFileUrl=[],this.sketchFileBindNodeuuid=[],this.sortMeshSets=(a=[],o=new THREE.Vector3,s=new THREE.Box3,l=new THREE.Vector3,d=new THREE.Vector3,function(e,t){for(var r=a.length=0,i=e.length;r<i;++r){c.sptIndex.getNodeBox(c.meshSets[e[r]].node,s),s.getCenter(l),s.getSize(d);var n=.5*d.length(),n=Math.abs(n/(o.dot(t.pixelSizeVector)+t.pixelSizeVector.w));a.push(new Nt(e[r],n,c.meshSets[e[r]].bufferId))}a.sort(function(e,t){return 250<=t.z||250<=e.z?t.z-e.z:t.t-e.t});for(r=0,i=e.length;r<i;++r)e[r]=a[r].id}),this.needsFastRendering=!1,this.setDirty=function(e){var r=e=void 0===e?this:e;return function(){for(e=0,t=r.meshSets.length;e<t;++e)r.meshSets[e].visualStates.dirty=!0,r.meshSets[e].visualStates.visible=!0;for(r.transparentBodiesDirty=!0,r.referenceEntityDirty=!0,e=0,t=r.geomManager.geoms.length;e<t;++e)r.geomManager.geoms[e].dirty=!0;for(r.lineSegmentsSet.dirty=!0,r.meshManager.dirty=!0,e=0,t=r.meshManager.instancedMeshIds.length;e<t;++e)r.meshManager.instancedMeshDirtyFlags[e]=!0;for(var e=0,t=r.meshManager.instancedLineSegs.size;e<t;++e)r.meshManager.instancedLineDirtyFlags[e]=!0;r.spriteDirty=!0}}(this),this.backupDirty=function(){for(var e=0,t=this.meshSets.length;e<t;++e)this.meshSets[e].oldVisualStates={},this.meshSets[e].oldVisualStates.oldDirty=this.meshSets[e].visualStates.dirty,this.meshSets[e].oldVisualStates.oldVisible=this.meshSets[e].visualStates.visible,void 0!==this.meshSets[e].visualStates.opaqueDrawCount&&(this.meshSets[e].oldVisualStates.oldOpaqueDrawCount=this.meshSets[e].visualStates.opaqueDrawCount,this.meshSets[e].oldVisualStates.oldTransparentDrawCount=this.meshSets[e].visualStates.transparentDrawCount,this.meshSets[e].oldVisualStates.oldLineDrawCount=this.meshSets[e].visualStates.lineDrawCount,this.meshSets[e].oldVisualStates.oldLineDrawPass=this.meshSets[e].visualStates.lineDrawPass);for(this.oldSelectedBodiesDirty=this.selectedBodiesDirty,this.oldTransparentBodiesDirty=this.transparentBodiesDirty,this.oldReferenceEntityDirty=this.referenceEntityDirty,e=0,t=this.geomManager.geoms.length;e<t;++e)this.geomManager.geoms[e].oldDirty=this.geomManager.geoms[e].dirty;this.lineSegmentsSet.oldDirty=this.lineSegmentsSet.dirty,this.meshManager.oldDirty=this.meshManager.dirty,this.oldSpriteDirty=this.spriteDirty},this.resetDirty=function(){for(var e=0,t=this.meshSets.length;e<t;++e)null!=this.meshSets[e].oldVisualStates.oldDirty&&(this.meshSets[e].visualStates.dirty=this.meshSets[e].oldVisualStates.oldDirty),null!=this.meshSets[e].oldVisualStates.oldVisible&&(this.meshSets[e].visualStates.visible=this.meshSets[e].oldVisualStates.oldVisible),void 0!==this.meshSets[e].oldVisualStates.oldOpaqueDrawCount&&(this.meshSets[e].visualStates.opaqueDrawCount=this.meshSets[e].oldVisualStates.oldOpaqueDrawCount,this.meshSets[e].visualStates.transparentDrawCount=this.meshSets[e].oldVisualStates.oldTransparentDrawCount,this.meshSets[e].visualStates.lineDrawCount=this.meshSets[e].oldVisualStates.oldLineDrawCount,this.meshSets[e].visualStates.lineDrawPass=this.meshSets[e].oldVisualStates.oldLineDrawPass),this.meshSets[e].oldVisualStates=void 0;for(this.selectedBodiesDirty=this.oldSelectedBodiesDirty,this.transparentBodiesDirty=this.oldTransparentBodiesDirty,this.referenceEntityDirty=this.oldReferenceEntityDirty,e=0,t=this.geomManager.geoms.length;e<t;++e)null!=this.geomManager.geoms[e].oldDirty&&(this.geomManager.geoms[e].dirty=this.geomManager.geoms[e].oldDirty);this.lineSegmentsSet.dirty=this.lineSegmentsSet.oldDirty,this.meshManager.dirty=this.meshManager.oldDirty,this.spriteDirty=this.oldSpriteDirty},this.dispose=function(){c.meshManager.dispose(),c.geomManager.dispose()},this._numUnLoadedNodes=0,this._enableParseNode=!0,this.SetBodyNodePropertyList=function(){var t=this;return this.viewer.propertyFielSet&&this.viewer.propertyFielSet.forEach(function(e){t.viewer.modelRequestor.addRequest(e,1e4,"propertyfile",{modelId:t.id,keepSourceFile:!1,propertyBindNode:!0})}),!0},this.copyFrom=function(e){e.geomManager.isRefGeometryManager||(e.geomManager=new F(e.geomManager,!0),e.meshManager.geomManager=e.geomManager),c.geomManager=new F(e.geomManager.geometryManager,!1),c.meshManager=new rt(c.geomManager,c);var o=c,r=function(e,t){if(t.name=e.name,t.up.copy(e.up),"pmiobject"===e.parent.name?t.matrix.identity():(t.matrix.copy(e.matrix),t.position.copy(e.position),t.rotation.order=e.rotation.order,t.quaternion.copy(e.quaternion),t.scale.copy(e.scale)),t.matrixWorld.copy(e.matrixWorld),t.matrixAutoUpdate=e.matrixAutoUpdate,t.matrixWorldNeedsUpdate=e.matrixWorldNeedsUpdate,t.matrixWorldAutoUpdate=e.matrixWorldAutoUpdate,t.layers.mask=e.layers.mask,t.visible=e.visible,e.version&&(t.version=e.version),e.fixedBox&&(t.fixedBox=e.fixedBox),e.views){t.views=[];for(var r=0;r<e.views.length;r++)t.views[r]={},e.views[r].pmiuuid&&(t.views[r].pmiuuid=e.views[r].pmiuuid.concat()),t.views[r].name=e.views[r].name,t.views[r].type=e.views[r].type,t.views[r].matrix=e.views[r].matrix}if(e.captures){t.captures=[];for(var i=0;i<e.captures.length;i++)t.captures[i]={},e.captures[i].pmiuuid&&(t.captures[i].pmiuuid=e.captures[i].pmiuuid.concat()),t.captures[i].name=e.captures[i].name,t.captures[i].type=e.captures[i].type,t.captures[i].matrix=e.captures[i].matrix}t.castShadow=e.castShadow,t.receiveShadow=e.receiveShadow,t.frustumCulled=e.frustumCulled,t.renderOrder=e.renderOrder,t.animations=e.animations,t.userData=JSON.parse(JSON.stringify(e.userData)),o.pmiuuidMap.set(e.uuid,t.uuid);for(var n=0;n<e.children.length;n++){var a=e.children[n];t.add(s(a))}},s=function(e){var t=null,t=e.geometry?new e.constructor(e.geometry,e.material):new e.constructor;return r(e,t),t};e.pmiObject&&(o.pmiuuidMap=new Map,c.pmiObject=s(e.pmiObject)),c.meshManager.copyFrom(e.meshManager),c.sptIndex=new at(null,c.meshManager),e.sptIndex&&c.sptIndex.copyFrom(e.sptIndex),c.brepManager=e.brepManager,c.lineSegmentsSet=new U(c.meshManager);for(var t=0,i=e.meshSets.length;t<i;++t)c.meshSets[t]=new nt(c.sptIndex),c.meshSets[t].copyFrom(e.meshSets[t]);c.rootBodyNode=new _e,c.rootBodyNode.copyFrom(e.rootBodyNode,c),c.objectidTouuid=e.objectidTouuid,c.bodyNodeUUidToMaterial=function(e){var t,r={};for(t in e)r[t]=e[t];return r}(e.bodyNodeUUidToMaterial),c.meshState.globalMtlUniformBlock=e.meshState.globalMtlUniformBlock,c.meshState.globalMtlTexture=e.meshState.globalMtlTexture,c.meshState.globalMtlTextureSize=e.meshState.globalMtlTextureSize,c.needsSketchModel&&(c.sketchFileUrl=e.sketchFileUrl),c.state=n.StateType.RENDERING_PREPARED,c.prepareForRendering(c.viewer.renderer.supportInstancedArrays(),c.viewer)}};function Vt(e,t){return e.z-t.z}function Gt(e,t){return t.z-e.z}ee.StateType={UNLOAD:0,CONTENT_LOADING:1,CONTENT_LOADED:2,RENDERING_PREPARED:3,ALL_GEOM_LOADED:4,PREPARED:5};new THREE.Box3,new THREE.Matrix4;ee.prototype={constructor:ee,handelUnloadState:function(){this.nodeRequestor.addRequest(this.modelUri,1e5,"loadModelData",{modelId:this.id,keepSourceFile:this.keepSourceFile,type:this.type,filter:this.filter}),this.state=ee.StateType.CONTENT_LOADING},updateRefModel:function(e){for(var t=0;t<e.children.length;++t){var r=e.children[t];if(r.refModelUri&&!r.loaded&&(r.loaded=this.nodeRequestor.tryMergeNode({path:r.refModelUri,configName:r.configName},this,r,this._enableParseNode),!r.loaded))return this._numUnLoadedNodes++,void(this._enableParseNode=!1);this.updateRefModel(r)}},handleContentLoadingState:function(){this._numUnLoadedNodes=0,this._enableParseNode=!0,this.rootBodyNode||this.nodeRequestor.tryMergeNode(this.modelUri,this,null,this._enableParseNode)?this.hasRefModel&&this.updateRefModel(this.rootBodyNode):this._numUnLoadedNodes++,0===this._numUnLoadedNodes&&(this.state=ee.StateType.CONTENT_LOADED)},removeIgnoredNodes:function(){function a(e){for(var t=[],r=0,i=e.children.length;r<i;++r){var n=e.children[r];n.ignored||a(t[t.length]=n)}e.children=t}this.filter.needs&&function e(t){if("Assembly"===t.type){for(var r=!1,i=0,n=t.children.length;i<n;++i)"Part"===t.children[i].type&&0<t.children[i].children.length?r=!0:"Assembly"===t.children[i].type&&(e(t.children[i]),r=r||!t.children[i].ignored);r||(t.ignored=!0)}}(this.rootBodyNode),a(this.rootBodyNode)},handleContentLoadedState:function(){var e,t;if(this.filter&&(this.filter.needs||this.filter.ignores)&&this.removeIgnoredNodes(),this.prepareForRendering(this.viewer.renderer.supportInstancedArrays(),this.viewer),this.setBodyNodeMaterialsInfo(this.viewer.bodyNodeUUidToMaterial),0===this.position.x&&0===this.position.y&&0===this.position.z&&0===this.rotation.x&&0===this.rotation.y&&0===this.rotation.z&&1===this.scale.x&&1===this.scale.y&&1===this.scale.z&&this.rootBodyNode.fileUnit==this.viewer.modelUnit||(this.updateMatrixByModelUnit(),(e=new THREE.Matrix4).compose(this.position,this.rotation,this.scale),this.rootBodyNode.matrix&&((t=new THREE.Matrix4).fromArray(this.rootBodyNode.matrix),e=e.multiply(t)),this.updateNodeMatrix(this.rootBodyNode.uuid,e.elements),this.needsRecalculateMeshBBox=!0),this.useTransparentList&&this.transparentList){for(var r=[],i=0;i<this.transparentList.length;++i){var n=(n=this.meshManager.bodyUuids[this.transparentList[i]])||this.objectidTouuid[this.transparentList[i]];this.bodyUuid2NodeMap[n]&&r.push(this.bodyUuid2NodeMap[n])}8===this.viewer.getRenderMode()?(this.isolateBodiesOnly([this.rootBodyNode]),this.transparentModeBodiesMap.clear(),this.transparentizeBodiesOnly(r),this.transparentModeBodiesMap.clear()):0<r.length&&this.transparentizeBodies(r)}this.viewer.ndsModel.setActiveModelByModelId(this.id),this.viewer.modelRootObject||(this.viewer.modelRootObject=new THREE.Object3D,this.viewer.modelRootObject.boundingBox=new THREE.Box3,this.viewer.is2DModel?this.viewer.modelRootObject.boundingBox.copy(this.originModelBBox):this.rootBodyNode.getBoundingBox(this.viewer.modelRootObject.boundingBox,!1)),this.viewer.prepareModelForRendering(),this.nodeRequestor.afterModelLoaded(this),this.state=ee.StateType.RENDERING_PREPARED},updateMatrixByModelUnit:function(){var e;this.rootBodyNode.fileUnit!=this.viewer.modelUnit&&(e=this.viewer.getUnitTransfrom(this.viewer.modelUnit,this.rootBodyNode.fileUnit),this.rootBodyNode.matrix||(this.rootBodyNode.matrix=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this.rootBodyNode.matrix[0]*=e,this.rootBodyNode.matrix[1]*=e,this.rootBodyNode.matrix[2]*=e,this.rootBodyNode.matrix[4]*=e,this.rootBodyNode.matrix[5]*=e,this.rootBodyNode.matrix[6]*=e,this.rootBodyNode.matrix[8]*=e,this.rootBodyNode.matrix[9]*=e,this.rootBodyNode.matrix[10]*=e)},handleAllGeomLoadedState:function(){!this.loadedProperty&&this.viewer.allLoaded&&this.needsProperty&&(this.loadedProperty=this.SetBodyNodePropertyList()),this.needsRecalculateMeshBBox&&(this.meshManager.reCalculateMeshBBox(),this.needsRecalculateMeshBBox=!1),this.params.resetCamera&&(this.viewer.camera.setOrginalCameraInfo(void 0),this.viewer.controls.SetBoundingBoxUpdated(!1),this.viewer.resetCamera({smoothTranslation:!1})),0==this.params.visible&&this.viewer.hideObject(this.rootBodyNode),this.state=ee.StateType.PREPARED},handlePreparedState:function(){this.rootBodyNode.updateMatrixWorld(!1)},loadSketch:function(){this.sketchFileUrl&&this.sketchFileUrl.length?this.viewer.loadMultiModel(this.sketchFileUrl,{proxyName:this.rootBodyNode.name+"_sketch",isSketchModel:!0,parentModelId:this.id,parentModelUrl:this.isProxy?this.rootBodyNode.name:this.modelUri}):this.sketchFileUrl=null},update:function(e){return He.onBeforeNdsModelUpdate(this,e=void 0===e?{}:e),this.state===ee.StateType.UNLOAD?this.handelUnloadState():this.state===ee.StateType.CONTENT_LOADING?this.handleContentLoadingState():this.state===ee.StateType.CONTENT_LOADED?this.handleContentLoadedState():this.state===ee.StateType.ALL_GEOM_LOADED?(this.handleAllGeomLoadedState(),this.loadSketch()):this.state===ee.StateType.PREPARED&&this.handlePreparedState(),He.onAfterNdsModelUpdate(this,e),this.state},getGeomManager:function(){return this.geomManager},getMeshManager:function(){return this.meshManager},getMeshSets:function(){return this.meshSets},buildMeshSets:function(){this.meshSets=this.sptIndex.buildMeshSets(),this.rootBodyNode.updateMatrixWorld(!0,!1)},sortMeshSets2:function(e){for(var t,r,i,n=[],a=new THREE.Box3,o=0,s=e.length;o<s;++o)a.min.fromArray(this.sptIndex.bboxes,6*this.meshSets[e[o]].node),a.max.fromArray(this.sptIndex.bboxes,6*this.meshSets[e[o]].node+3),t=a.max.x-a.min.x,r=a.max.y-a.min.y,i=a.max.z-a.min.z,n.push(new Nt(e[o],t*r*i));n.sort(Ut);for(o=0,s=e.length;o<s;++o)e[o]=n[o].id},getRightBodyuuid:function(e,t){for(var r=0;r<t.length;++r)for(var i=this.bodyUuid2NodeMap[t[r]];i.parent;){if(i.parent.fileguid==e)return t[r];i=i.parent}return t[0]},getLineSegmentsSet:function(){return this.lineSegmentsSet},afterAllGeomLoaded:function(){0<this.transparentBodies.length&&(this.containsOriginalTransparentBodies=!0),this.state=ee.StateType.ALL_GEOM_LOADED},prepareForRendering:function(O,F){function i(e,t){if(t&&(e.unload=!0),e.visible=!1,N.has(e)||(t&&U.UnloadNodes.push(e),N.add(e)),0<e.children.length)for(var r=0;r<e.children.length;++r)i(e.children[r],t)}var U=this,N=new WeakSet;if(!De.HideLeafBody||"Part"!==this.rootBodyNode.type&&"Model"!==this.rootBodyNode.type||1!==this.rootBodyNode.children.length||"Part"!==this.rootBodyNode.children[0].type||1<this.rootBodyNode.children[0].children.length&&(De.HideLeafBody=!1),De.HideLeafBody&&(0===this.rootBodyNode.children.length||1<this.rootBodyNode.children.length)&&("Part"===this.rootBodyNode.type||"Model"===this.rootBodyNode.type)&&(0<this.rootBodyNode.children.length&&"Body"===this.rootBodyNode.children[0].type||0===this.rootBodyNode.children.length)&&(De.HideLeafBody=!1),(1<this.viewer.ndsModel.getAllNoSketchModel().length&&!De.AnimationEdit&&!this.is2DModel||null!=this.viewer.rootBodyNodeName)&&(De.HideLeafBody=!0),this.NeedsMergeBodyNode)throw new Error("System Error: [NeedsMergeBodyNode] can not be True when NdsModel object prepare for rendering");for(var V=0,e={},t=[this.rootBodyNode],G=0,r=0;r<t.length;++r){var n=t[r],a=(n.ndsModel=this,n.globalIndex=V++,(this.bodyUuid2NodeMap[n.uuid]=n).type.toLowerCase());"assembly"===a&&(this.assamblyNodes.push(n),n.isAssamblyNode=!0),0===n.children.length&&(++G,"part"!==a&&"assembly"!==a&&(n.id=this.meshManager.bodyUuid2IdMap[n.uuid],void 0===n.id||n.id<0)&&(!0===De.inAssemblyContext?n.id=this.leafNodeCount++:(this.meshManager.bodyUuid2IdMap[n.uuid]=this.meshManager.bodyUuids.length,this.meshManager.bodyUuids.push(n.uuid),n.id=this.meshManager.bodyUuid2IdMap[n.uuid])),n.isReferenceEntity()?this.wholeRefEntityNodes.push(n):n.isCoordinate()?(this.wholeCoordinateNodes.push(n),null==n.leafBodyAttri&&(n.leafBodyAttri=new ce,n.visible||n.hide())):"part"!==a&&"assembly"!==a&&(this.wholeLeafBodyNodes.push(n),n.layerId)&&(e[n.layerId]||(e[n.layerId]={count:0,visible:!1}),e[n.layerId].count=++e[n.layerId].count,e[n.layerId].visible=e[n.layerId].visible||n.visible),this.hasRawMesh||"rawmesh"!==a||(this.hasRawMesh=!0)),this.objectidTouuid?this.useUnvisibleList&&this.unvisibleList&&-1!==this.unvisibleList.indexOf(n.objectid)&&i(n,!De.singleHTML):(void 0===(a=this.meshManager.bodyUuid2IdMap[n.uuid])&&(this.meshManager.bodyUuid2IdMap[n.uuid]=this.meshManager.bodyUuids.length,this.meshManager.bodyUuids.push(n.uuid),a=this.meshManager.bodyUuid2IdMap[n.uuid]),this.useUnvisibleList&&this.unvisibleList&&-1!==this.unvisibleList.indexOf(a)&&i(n,!De.singleHTML));for(var o=0,k=n.children.length;o<k;++o)t.push(n.children[o])}if(this.layers)for(var s=0,j=this.layers.length;s<j;++s){var l=e[this.layers[s].id];this.layers[s].count=0,this.layers[s].visible=!0,this.layers[s].selected=!1,l&&(this.layers[s].count=l.count,this.layers[s].visible=l.visible)}if(this.layerGroups)for(var d=0,z=this.layerGroups.length;d<z;++d){var c=this.layerGroups[d].layers,h=[];this.layerGroups[d].count=0,this.layerGroups[d].visible=!1,this.layerGroups[d].selected=!1;for(var u=0;u<c.length;++u){var p=e[c[u]];p?(this.layerGroups[d].count+=p.count,this.layerGroups[d].visible=this.layerGroups[d].visible||p.visible,(p=this.getLayerFromId(c[u]))&&h.push(p)):(p=this.getLayerFromId(c[u]))&&h.push(p)}this.layerGroups[d].layers=h}this._bodyNodeBoxBuffer=new Float64Array(6*G);for(var f=oe=0;f<this.meshManager.nMeshes;++f){var m=this.meshManager.bodyUuids[f],g=this.bodyUuid2NodeMap[m];if(g&&(this.meshManager.bodyNodes[f]=this.bodyUuid2NodeMap[m],!g.unload))if(this.meshManager.bodyNodes[f]=this.bodyUuid2NodeMap[m],null==g._leafBodyAttri){g._leafBodyAttri=new se(g),g._leafBodyAttri._bodyBbox=new Float64Array(this._bodyNodeBoxBuffer.buffer,6*g._leafBodyAttri.id*8,6),this.inIsolate()&&g.isolate(),g._leafBodyAttri._bodyMeshIds.push(f);for(var v=0;v<6;++v)g._leafBodyAttri._bodyBbox[v]=this.meshManager._meshBoxes_[6*f+v]}else if(-1===g._leafBodyAttri._bodyMeshIds.indexOf(f)){g._leafBodyAttri._bodyMeshIds.push(f);for(var y=0;y<3;++y)this.meshManager._meshBoxes_[6*f+y]<g.leafBodyAttri.bodyBbox[y]&&(g._leafBodyAttri._bodyBbox[y]=this.meshManager._meshBoxes_[6*f+y]),this.meshManager._meshBoxes_[6*f+3+y]>g._leafBodyAttri._bodyBbox[3+y]&&(g._leafBodyAttri._bodyBbox[3+y]=this.meshManager._meshBoxes_[6*f+3+y])}}for(var A=[],M=0;M<this.meshManager.nLineSegments;++M){var W=this.meshManager.lineSegBodyUuids[M],E=this.bodyUuid2NodeMap[W];E&&(this.meshManager.lineSegBodyNodes[M]=this.bodyUuid2NodeMap[W],E.unload||(null==E._leafBodyAttri?(E._leafBodyAttri=new se(E),E._leafBodyAttri._bodyBbox=new Float64Array(this._bodyNodeBoxBuffer.buffer,6*E._leafBodyAttri.id*8,6),E._leafBodyAttri._bodyLineSegIds.push(M),A.push(E)):-1===E._leafBodyAttri._bodyLineSegIds.indexOf(M)&&E._leafBodyAttri._bodyLineSegIds.push(M)))}for(var w=0;w<this.meshManager.nTexts;++w){var x=this.meshManager.textBodyUuids[w],x=this.bodyUuid2NodeMap[x];null==(this.meshManager.textBodyNodes[w]=x)._leafBodyAttri?(x._leafBodyAttri=new se(x),x._leafBodyAttri.bodyTextIds.push(w)):-1===x._leafBodyAttri.bodyTextIds.indexOf(w)&&x._leafBodyAttri.bodyTextIds.push(w)}this.meshManager.supportInstancedArrays=O,this.meshManager.supportInstancedArraysCopy=O,this.meshManager.mapGeomUuidToGeomId(),this.transparentBodyChanged=!0;for(var b=0;b<t.length;++b){var B=t[b];B.isEmptyNode()&&!B.IsMergedNode&&this.emptyBodyNodes.push(B),B.visible||B.parent&&!B.parent.visible||this.hideBody(B)}He.onNdsModelPrepareForRendering(this),this.meshManager.setMaterialInfor(),U.buildMeshSets();for(var I=0;I<this.meshManager.nTexts;++I)if(!(this.meshManager.textGeomId[I]<0)){var X=this.meshManager.textBodyNodes[I],q=this.meshManager.geomManager.getGeomFromId(this.meshManager.textGeomId[I]),T=this.viewer.scene.getObjectByName("dashLine");if(T){T=T.getObjectByName(q.uuid);if(T){var q=this.meshManager.mats[this.meshManager.textMaterialId[I]],Y=(T.material.color.copy(q.color),new THREE.Matrix4);if(this.meshManager.matrixes)for(var S=0;S<16;++S)Y.elements[S]=this.meshManager.matrixes[16*this.meshManager.textMatrixId[I]+S];else Y.copy(X.worldMatrix);T.applyMatrix(Y)}}}if(0<(this.pureLineBody=A).length)for(var R=0;R<A.length;R++)6!==A[R]._leafBodyAttri._bodyBbox.length&&A[R].updateBoundingBox();if(!this.isSketchModel&&!this.is2DModel){for(var Q=0;Q<t.length;++Q){var K,C=t[Q],D=-1,P=-1;if(C.children&&0<C.children.length&&"Body"===C.children[0].type){for(var Z=C.children[0].visible,H=0,J=C.children.length;H<J;++H)C.children[H].visible&&!C.children[H].isEmptyNode()&&(-1===D&&(D=H),-1===P)&&C.children[H]._leafBodyAttri&&0<C.children[H]._leafBodyAttri._bodyMeshIds.length&&(P=H),C.children[H].visible!=Z&&(C.DiffVisible=!0);-1===D&&-1===P&&(C.FirstVisibleNode=0)}0<=P?C.FirstVisibleNode=P:0<=D&&(C.FirstVisibleNode=D),C._leafBodyAttri&&!C.unload&&C.parent&&(K=C.parent.FirstVisibleNode||0,C.parent.children[K].uuid===C.uuid||C.IsMergedNode||(C.IsMergedNode=!0,C.responsNode=C.parent.children[K]),!C.visible)&&C.parent.DiffVisible&&De.HideLeafBody&&i(C,!0)}De.HideLeafBody?(this.viewer.selectionManager.setSelectType("part"),this.viewer.controls.getOperator().oldSelectType="part",this.mergeNode()):(this.viewer.selectionManager.setSelectType("body"),this.viewer.controls.getOperator().oldSelectType="body")}for(var $=0;$<this.wholeCoordinateNodes.length;++$){var _,L=this.wholeCoordinateNodes[$];L.visible&&(L.leafBodyAttri.renderObject?L.leafBodyAttri.renderObject.attach(L):(_=null,_=this.viewer.canvas2D||this.viewer.canvas3D,(_=new ae(this.viewer.camera,_)).attach(L),L.leafBodyAttri.renderObject=_,this.viewer.scene.add(_)))}this.isSketchModel||(0<this.getAllTransparentBodies(!0).length?(this.viewer.hasTransparentBody=!0,"NX"!==this.viewer.ModelFormat&&"NXDirect"!==this.viewer.ModelFormat||this.viewer.enableTransparent(!1)):this.viewer.hasTransparentBody=!1),this.viewer.prepareModelCallBack&&this.viewer.prepareModelCallBack(this.rootBodyNode)},mergeNode:function(){this.NeedsMergeBodyNode=!0,this.transparentBodyChanged=!0,this.getAllTransparentBodies(!0)},unmergeNode:function(){this.NeedsMergeBodyNode=!1,this.transparentBodyChanged=!0,this.getAllTransparentBodies(!0)},backupAllBodyFlag:function(){for(var e=0,t=this.wholeLeafBodyNodes.length;e<t;++e)this.wholeLeafBodyNodes[e].leafBodyAttri&&(this.wholeLeafBodyNodes[e].leafBodyAttri.bodyFlagBackup=this.wholeLeafBodyNodes[e].leafBodyAttri.bodyFlag)},resetAllBodyFlag:function(){for(var e=0,t=this.wholeLeafBodyNodes.length;e<t;++e)this.wholeLeafBodyNodes[e].leafBodyAttri&&null!=this.wholeLeafBodyNodes[e].leafBodyAttri.bodyFlagBackup&&(this.wholeLeafBodyNodes[e].leafBodyAttri.bodyFlag=this.wholeLeafBodyNodes[e].leafBodyAttri.bodyFlagBackup,this.wholeLeafBodyNodes[e].leafBodyAttri.bodyFlagBackup=void 0)},backupEmptyBodyNodeVisibleState:function(){for(var e=0,t=this.emptyBodyNodes.length;e<t;++e)this.emptyBodyNodes[e].oldVisible=this.emptyBodyNodes[e].visible},resetEmptyBodyNodeVisibleState:function(){for(var e=0,t=this.emptyBodyNodes.length;e<t;++e)null!=this.emptyBodyNodes[e].oldVisible&&(this.emptyBodyNodes[e].visible=this.emptyBodyNodes[e].oldVisible)},requireContinueLoading:function(){return 0<this.geomManager.bufferChunksToLoad.length},hasEnoughAvailableMemory:function(){return 10485760<=this.geomManager.maxMemory-this.geomManager.usedMemory||this.geomManager.usedMemory<.9*this.geomManager.maxMemory},setDrawMode:function(e){this.drawMode=e},getDrawModeFace:function(){return this.drawMode===this.SHADED_WITH_EDGES||this.drawMode===this.SHADED||this.drawMode===this.HIDDEN_LINE_REMOVE||this.drawMode===this.HIDDEN_LINE_VISIBLE||this.drawMode===this.TRANSPARENT},getDrawModeFaceColorMask:function(){return this.drawMode!==this.HIDDEN_LINE_REMOVE&&this.drawMode!==this.HIDDEN_LINE_VISIBLE},getDrawModeEdge:function(){return this.drawMode===this.SHADED_WITH_EDGES||this.drawMode===this.WIREFRAME||this.drawMode===this.HIDDEN_LINE_REMOVE||this.drawMode===this.HIDDEN_LINE_VISIBLE},getDrawModeHiddenEdge:function(){return this.drawMode===this.HIDDEN_LINE_VISIBLE},setOverrideMaterial:function(e,t,r){this.meshManager.overrideMaterial=e,this.meshManager.overrideMaterialCopy=t,this.meshManager.useBodyIdMaterial=r,this.referenceEntityDispManager.overrideMaterial=e,this.referenceEntityDispManager.overrideMaterialCopy=t,this.referenceEntityDispManager.useBodyIdMaterial=r,e?r&&(this.meshManager.supportInstancedArrays=!1):this.meshManager.supportInstancedArrays=this.meshManager.supportInstancedArraysCopy},setRootBodyNode:function(e,t,r){if(this.rootBodyNode)if("assembly"==e.type.toLowerCase())this.rootBodyNode.children.push(e),e.parent=this.rootBodyNode;else for(var i=0;i<e.children.length;i++)this.rootBodyNode.children.push(e.children[i]),e.children[i].parent=this.rootBodyNode;else this.rootBodyNode=e;for(var n in this.rootBodyNode.ndsModel=this,t)this.meshUuid2GeomUuidMap[n]=t[n];for(var a=0,o=this.geomManager.geoms.length;a<o;++a){var s=this.geomManager.geoms[a];r[s.uuid]&&(s.tangentEdgeObject=!0)}},setBodyNodeMaterials:function(e){for(var t in Object.assign(this.bodyNodeUUidToMaterial,e),this.bodyNodeUUidToMaterial){var r=this.getBodyNodeFromUuid(t),t=this.bodyNodeUUidToMaterial[t];r&&t&&(r.useBodyNodeMaterial=!0)}},getBodyNodeUUidToMaterial:function(){return this.bodyNodeUUidToMaterial},setBodyNodeMaterialsInfo:function(e){if(e){var t,r={};for(t in r){var i=r[t],i=this.viewer.materialsSetting.jsonToMaterial(i);i&&(r[t]=i)}this.setBodyNodeMaterials(r)}},setBodyNodeMaterial:function(e,t){e=this.getBodyNodeFromUuid(e);this.bodyNodeUUidToMaterial[e.uuid]=t,e.useBodyNodeMaterial=!0,this.meshMtlNeedsUpdate=!0},removeAllBodyNodeMaterials:function(){for(var e in this.bodyNodeUUidToMaterial){var t=this.getBodyNodeFromUuid(e);t&&this.bodyNodeUUidToMaterial[e]&&(t.useBodyNodeMaterial=!1)}this.bodyNodeUUidToMaterial={},this.meshMtlNeedsUpdate=!0},removeBodyNodeMaterial:function(e){var t=this.getBodyNodeFromUuid(e);t&&this.bodyNodeUUidToMaterial[e]&&(delete this.bodyNodeUUidToMaterial[e],t.useBodyNodeMaterial=!1,this.meshMtlNeedsUpdate=!0)},getBodyNode:function(e){for(var t=0,r=this.wholeLeafBodyNodes.length;t<r;t++)if(this.wholeLeafBodyNodes[t].id===e)return this.wholeLeafBodyNodes[t];for(var i=0,n=this.wholeRefEntityNodes.length;i<n;i++)if(this.wholeRefEntityNodes[i].id===e)return this.wholeRefEntityNodes[i];for(var a=0,o=this.wholeCoordinateNodes.length;a<o;a++)if(this.wholeCoordinateNodes[a].id===e)return this.wholeCoordinateNodes[a];return null},getBodyNodeFromUuid:function(e){return this.bodyUuid2NodeMap[e]},getSelectedLeafBodyNodes:function(e){for(var t=[],r=this.getLeafBodies(e),i=0,n=r.length;i<n;i++)r[i].leafBodyAttri&&r[i].isSelected()&&t.push(r[i]);return t},getLeafBodies:function(e){var t=[];if(0==e.children.length)0<=e.id&&!e.isReferenceEntity()&&!e.isCoordinate()&&!e.isOtherNode()&&e._leafBodyAttri&&(0<e._leafBodyAttri._bodyMeshIds.length||0<e._leafBodyAttri.bodyLineSegIds.length||0<e._leafBodyAttri.bodyTextIds.length)&&t.push(e);else for(var r=[e],i=0;i<r.length;++i)if(0==r[i].children.length)0<=r[i].id&&!r[i].isReferenceEntity()&&!r[i].isCoordinate()&&!r[i].isOtherNode()&&r[i]._leafBodyAttri&&(0<r[i]._leafBodyAttri._bodyMeshIds.length||0<r[i]._leafBodyAttri.bodyLineSegIds.length||0<r[i]._leafBodyAttri.bodyTextIds.length)&&t.push(r[i]);else for(var n=0,a=r[i].children.length;n<a;++n)r.push(r[i].children[n]);return t},getPartBodies:function(e){for(var t=[],r=[e],i=0;i<r.length;++i)if("Part"==r[i].type&&0<r[i].children.length&&"Body"==r[i].children[0].type)t.push(r[i]);else if(0<r[i].children.length)for(var n=0,a=r[i].children.length;n<a;++n)r.push(r[i].children[n]);return t},getLayerBodies:function(e){var t=[];if("AcDbLayerTableRecord"===e.type)t.push(e);else for(var r=[e],i=0;i<r.length;++i)if("AcDbLayerTableRecord"===r[i].type)t.push(r[i]);else for(var n=0,a=r[i].children.length;n<a;++n)r.push(r[i].children[n]);return t},getLeafReferenceEntities:function(e){var t=[];if(0==e.children.length)e.isReferenceEntity()&&t.push(e);else for(var r=[e],i=0;i<r.length;++i)if(0==r[i].children.length)r[i].isReferenceEntity()&&t.push(r[i]);else for(var n=0,a=r[i].children.length;n<a;++n)r.push(r[i].children[n]);return t},getLeafCoordinate:function(e){var t=[];if(0==e.children.length)e.isCoordinate()&&t.push(e);else for(var r=[e],i=0;i<r.length;++i)if(0==r[i].children.length)r[i].isCoordinate()&&t.push(r[i]);else for(var n=0,a=r[i].children.length;n<a;++n)r.push(r[i].children[n]);return t},getAllLeafNodes:function(e){var t=[];if(0==e.children.length)t.push(e);else for(var r=[e],i=0;i<r.length;++i)if(0==r[i].children.length)t.push(r[i]);else for(var n=0,a=r[i].children.length;n<a;++n)r.push(r[i].children[n]);return t},updateSubSketchNodeMatrix:function(e){for(var e=this.bodyUuid2NodeMap[e],t=this.getLeafBodies(e),r=0,i=t.length;r<i;r++)if(t[r].worldMatrix=this.calculateNodeWorldMatrix(t[r],t[r].worldMatrix),t[r].leafBodyAttri){var n=t[r].leafBodyAttri.bodyMeshIds;if(0<n.length){for(var a=new THREE.Box3,o=null,s=0,l=n.length;s<l;++s){var d=n[s];-1<this.meshManager.geomId[d]&&(this.geomManager.getGeomFromId(this.meshManager.geomId[d]).updateModelMatrix=!0,this.meshManager.updateMeshBBox(d)),this.meshManager.getMeshBBox(d,a),this.bvhCreater&&this.bvhCreater.m_boxes[d].SetMinMaxPointFromArray([a.min.x,a.min.y,a.min.z,a.max.x,a.max.y,a.max.z]),0==s?o=a.clone():o.union(a)}o&&(t[r].leafBodyAttri.bodyBbox[0]=o.min.x,t[r].leafBodyAttri.bodyBbox[1]=o.min.y,t[r].leafBodyAttri.bodyBbox[2]=o.min.z,t[r].leafBodyAttri.bodyBbox[3]=o.max.x,t[r].leafBodyAttri.bodyBbox[4]=o.max.y,t[r].leafBodyAttri.bodyBbox[5]=o.max.z)}else t[r].updateBoundingBox()}},updateNodeMatrix:(qt=new THREE.Matrix4,Yt=new THREE.Matrix4,Qt=new THREE.Matrix4,new THREE.Matrix4,Kt=new THREE.Vector3,function(e,t){e=this.bodyUuid2NodeMap[e];if(e){!e.originalPosition&&(e.originalPosition=new THREE.Vector3,r=this.viewer.ndsModel.getBodyBoundingBox(e))&&e.originalPosition.copy(r.getCenter(Kt)),qt.copy(e.worldMatrix),e.matrix=t.slice(0),e.updateMatrixWorld(!0),Yt.copy(e.worldMatrix);var r,i=this.getLeafBodies(e);Xt=Yt.multiply(Qt.getInverse(qt));for(var n=0,a=i.length;n<a;n++)i[n]._leafBodyAttri&&(0<i[n]._leafBodyAttri._bodyMeshIds.length||i[n].updateBoundingBox(),this.viewer.controls.staticAnnotation&&this.viewer.controls.staticAnnotation.updateTextPos(i[n],Xt),this.viewer.annotationsManager)&&this.viewer.annotationsManager.updateAnnotaion(i[n],Xt);for(var o=this.getLeafReferenceEntities(e),n=0,a=o.length;n<a;n++)o[n].worldMatrix=this.calculateNodeWorldMatrix(o[n],o[n].worldMatrix),o[n].leafBodyAttri&&(o[n].leafBodyAttri.bbox.setFromArray(o[n].leafBodyAttri.coords),o[n].leafBodyAttri.bbox.applyMatrix4(o[n].worldMatrix),"RefPlane"==o[n].type?this.referenceEntityDispManager.needUpdateRefPlaneVertexBuffer=!0:"RefAxis"==o[n].type&&(this.referenceEntityDispManager.needUpdateRefAxisVertexBuffer=!0));for(var s=this.getLeafCoordinate(e),n=0,a=s.length;n<a;n++)s[n].worldMatrix=this.calculateNodeWorldMatrix(s[n],s[n].worldMatrix);return{bodyNode:e,offsetMatrix:Xt}}return{bodyNode:null}}),calculateNodeWorldMatrix:(Wt=new THREE.Matrix4,function(e){var t=e.worldMatrix,r=e,i=[];for(i.push(r);r.parent;)r=r.parent,i.push(r);t&&t.identity();for(var n=t||new THREE.Matrix4,a=i.length-1;0<=a;a--)null!=i[a].matrix&&(Wt.fromArray(i[a].matrix),n.multiply(Wt));return e.worldMatrix||(e.worldMatrix=n),n}),calculateNodeWorldMatrix4D:(zt=new THREE.Matrix4D,function(e,t){var r=e,i=[];for(i.push(r);r.parent;)r=r.parent,i.push(r);t&&t.identity();for(var n=t||new THREE.Matrix4D,a=i.length-1;0<=a;a--)null!=i[a].matrix&&(zt.fromArray(i[a].matrix),n.multiply(zt));return n}),intersectPolytope:function(e){var t=this.sptIndex.intersect(e);if(!t||0===t.length)return null;for(var r=[],i=0,n=0,i=0,n=t.length;i<n;++i){var a=t[i];this.meshSets[a].intersect(e,r)}var o=[],s=[];for(i=0,n=r.length;i<n;++i){var l,a=r[i];(l=this.meshManager.intersectPolytope(a,e))&&!s.includes(l.bodyUuid)&&(o.push(l),s.push(l.bodyUuid))}return o},doIntersectByLeafBodyDirect:function(e,t,r){void 0===r&&(r=!1);for(var i=this.wholeLeafBodyNodes.length,n=new THREE.Box3,a=[],o=0;o<i;++o){var s=this.wholeLeafBodyNodes[o];s.leafBodyAttri&&!s.isHidden()&&(s.getBoundingBox(n),Math.abs(n.min.x-n.max.x)<t&&(n.min.x-=t/2,n.max.x+=t/2),Math.abs(n.min.y-n.max.y)<t&&(n.min.y-=t/2,n.max.y+=t/2),!1!==e.intersectsBox(n))&&(a[a.length]={bodyNode:s})}var l=[];if(0<t){for(var d=0;d<a.length;++d)for(var c=a[d].bodyNode.leafBodyAttri.bodyLineSegIds,h=0;h<c.length;++h){var u=this.meshManager.intersectLineSegments(c[h],e,1/0,t,this.is2DModel);u&&this.meshManager.getLineSegments(u.lineSegId)&&l.push(u)}if(0<l.length){for(var p=0,f=l[0].distance,m=1,g=l.length;m<g;++m)l[m].distance<f&&(f=l[m].distance,p=m);l[p].bodyNode=this.bodyUuid2NodeMap[l[p].bodyUuid],l[p].object=l[p].bodyNode,0!==p&&(l[0]=l[p]),l.length=1}}for(var v=[],y=0;y<a.length;++y)for(var A=a[y].bodyNode.leafBodyAttri.bodyMeshIds,M=0;M<A.length;++M){var E=this.meshManager.intersectMesh(A[M],e);E&&v.push(E)}if(0<v.length){for(var w=0,x=v[0].distance,b=1,B=v.length;b<B;++b)v[b].distance<x&&(x=v[b].distance,w=b);v[w].bodyNode=this.bodyUuid2NodeMap[v[w].bodyUuid],v[w].object=v[w].bodyNode,0!==w&&(v[0]=v[w]),v.length=1}return!this.is2DModel&&0<v.length&&0<l.length&&l[0].distance>v[0].distance+2*t&&(l.length=0),0<l.length?[l[0]]:0<v.length?[v[0]]:null},intersectBodyNode:function(e,t,r,i,n,a){return i||n||(i=[],n=[]),this.is2DModel?(e.intersect2D(t,r,i,n,a),a?i:0<i.length?[i[0]]:null):(e.intersect(t,r,i,n),0<n.length&&0<i.length&&i[0].distance>n[0].distance+2*r&&(i.length=0),0<i.length?[i[0]]:0<n.length?[n[0]]:null)},intersect:function(e,t,r){void 0===r&&(r=!1);var i=this.intersectReferenceEntity(e,t);return i&&"RefAxis"==i.bodyNode.type?[i]:this.intersectBodyNode(this.rootBodyNode,e,t,[],[],r)},intersectReferenceEntity:function(e,t){var r=new THREE.Matrix4,i=new THREE.Ray,n=new THREE.Vector3,a=new THREE.Vector3,o=new THREE.Vector3,s=new THREE.Vector3,l=new THREE.Vector3,d=new THREE.Vector3,c=new THREE.Vector3,h=null,u=null;if(0<t)for(var p=t*t,f=0,m=this.wholeRefEntityNodes.length;f<m;++f)(g=this.wholeRefEntityNodes[f]).isHidden()||"RefAxis"==g.type&&(y=g.worldMatrix,v=g.leafBodyAttri.coords,n.fromArray(v,0),a.fromArray(v,3),n.applyMatrix4(y),a.applyMatrix4(y),e.distanceSqToSegment(n,a,c,d)<p)&&(A=e.origin.distanceTo(c),null==h?((h={}).distance=A,h.point=d.clone(),h.bodyNode=g,h.bodyUuid=g.uuid):A<h.distance&&(h.distance=A,h.point=d.clone(),h.bodyNode=g,h.bodyUuid=g.uuid));if(null==h)for(var g,v,y,A,f=0,m=this.wholeRefEntityNodes.length;f<m;++f)(g=this.wholeRefEntityNodes[f]).isHidden()||"RefPlane"==g.type&&e.intersectsBox(g.leafBodyAttri.bbox)&&(v=g.leafBodyAttri.coords,y=g.worldMatrix,r.getInverse(y),i.copy(e).applyMatrix4(r),n.fromArray(v,0),a.fromArray(v,3),o.fromArray(v,6),s.fromArray(v,9),i.intersectTriangle(n,a,o,!1,l)||i.intersectTriangle(o,s,n,!1,l))&&(l.applyMatrix4(y),A=e.origin.distanceTo(l),null==u?((u={}).distance=A,u.point=l.clone(),u.bodyNode=g,u.bodyUuid=g.uuid):A<u.distance&&(u.distance=A,u.point=l.clone(),u.bodyNode=g,u.bodyUuid=g.uuid));return h||u},getBodyTransform:(kt=new THREE.Matrix4,jt=new THREE.Vector3,function(e){this.NeedsMergeBodyNode&&e.IsMergedNode&&(t=void 0!==e.parent.FirstVisibleNode?e.parent.FirstVisibleNode:0,e=e.parent.children[t]),kt.identity(),jt.set(0,0,0);for(var t,r=He.getExtensionWithFlags(H.FLAG_ENABLE_NODE_TRANSFORM),i=0;i<r.length;++i){var n=r[i].getBodyTransform(e);jt.x+=n.elements[12],jt.y+=n.elements[13],jt.z+=n.elements[14],n.elements[12]=0,n.elements[13]=0,n.elements[14]=0,kt.premultiply(r[i].getBodyTransform(e))}return kt.elements[12]=jt.x,kt.elements[13]=jt.y,kt.elements[14]=jt.z,kt}),getLeafBodyBoundingBox:function(e){var t=new THREE.Box3;return e.getBoundingBox(t,!0)},getBodyBoundingBox:function(e,t,r){return t=t||new THREE.Box3,e.getBoundingBox(t,r)},RemoveElement:function(e,t){for(var r=1;-1<r;)-1<(r=e.indexOf(t))&&e.splice(r,1)},changeBodyOpactiy:function(e,i){var n=this,a=this.getLeafBodies(e),t=a.length;if(0<t){if(null!=i){for(var o,s,l=new Map,d=0;d<t;++d)(function(){var e=a[d].getUserMaterial();if(a[d].isTransparent()||(a[d].transparent(),n.transparentBodies.push(a[d]),n.transparentBodyChanged=!0),e)Array.isArray(i)?e.opacities=i:(e.opacity=i,e.opacities=null),a[d].setUserMaterial(e),e.transparent=1!=i,e.transmission=0;else{o=a[d].leafBodyAttri.bodyMeshIds,s=n.meshManager.materialId[o[0]];var e=n.meshManager.mats[s],r=[];if(o.forEach(function(e){var t=n.viewer.ndsModel.meshManager.materialId[e],t=n.viewer.ndsModel.meshManager.mats[t];t&&(t=t.color.clone(),r.push({meshId:e,value:t}))}),!e)return;if(l.has(e.uuid))a[d].setUserMaterial(l.get(e.uuid));else{var t=e;if(t.opacity==i)return t.opacities=null,l.set(e.uuid,t);t=e.clone(),Array.isArray(i)?t.opacities=i:(t.opacity=i,t.opacities=null),l.set(e.uuid,t),t.transparent=1!=i,t.colors=r,a[d].setUserMaterial(t)}}})();l.clear()}else for(d=0;d<t;++d)a[d].setUserMaterial(null);this.meshMtlNeedsUpdate=!0}},changeBodyColor:function(e,r,t){var a=this,o=this.getLeafBodies(e),i=o.length;if(0<i){if(null!=r)if(t)for(var s,l=0;l<i;++l)(function(){var e,i,n;!o[l].leafBodyAttri||(d=o[l].leafBodyAttri.bodyMeshIds,c=a.meshManager.materialId[d[0]],!(s=a.meshManager.mats[c]))||s.color.equals(r)||((e=s.clone()).color.setHex(r),i=[],n=new Map,d.forEach(function(e){var t,r=a.viewer.ndsModel.meshManager.materialId[e],r=a.viewer.ndsModel.meshManager.mats[r];r&&(t=r.opacity,i.push({meshId:e,value:t}),r.OriginTransparent)&&r.OriginOpacity<1&&n.set(e,{originalTransparent:r.OriginTransparent,originalOpacity:r.OriginOpacity})}),e.opacities=i,e.originalTransparentInfo=n,o[l].setUserMaterial(e),16777215<(r+=1000335)&&(r-=16777215))})();else for(var d,c,l=0;l<i;++l)(function(){var e,i,n,t;o[l].leafBodyAttri&&((e=o[l].getUserMaterial())?(Array.isArray(r)?e.colors=r:(e.color.setHex(r),e.colors=null,e.backMaterial&&e.backMaterial.color&&e.backMaterial.color.setHex(r)),o[l].setUserMaterial(e)):(d=o[l].leafBodyAttri.bodyMeshIds,c=a.meshManager.materialId[d[0]],(e=a.meshManager.mats[c])&&(i=[],n=new Map,d.forEach(function(e){var t,r=a.viewer.ndsModel.meshManager.materialId[e],r=a.viewer.ndsModel.meshManager.mats[r];r&&(t=r.opacity,i.push({meshId:e,value:t}),r.OriginTransparent)&&r.OriginOpacity<1&&n.set(e,{originalTransparent:r.OriginTransparent,originalOpacity:r.OriginOpacity})}),(t=e).color.equals(r)?t.colors=null:(t=e.clone(),Array.isArray(r)?t.colors=r:(t.color.setHex(r),t.colors=null),t.opacities=i,t.originalTransparentInfo=n,o[l].setUserMaterial(t)))))})();else for(l=0;l<i;++l)o[l].setUserMaterial(null);this.meshMtlNeedsUpdate=!0}},hasTransparentBodies:function(){return 0<this.transparentBodies.length||0<this.transparentizedBodies.length},transparentBody:function(e,t,r){t=t||De.bodyOpacity,r=r||De.lineOpacity;for(var i=this.getLeafBodies(e),n=0,a=i.length;n<a;++n){var o=i[n];o.leafBodyAttri&&(o.transparent(),o.leafBodyAttri.bodyOpacity=t,this.transparentModeBodiesMap.set(o.uuid,!0),this.transparentizedBodies.push(o),this.transparentBodyChanged=!0)}if(!this.meshManager.lineSegMaterial){for(var s in this.meshManager.materials)if("LineBasicMaterial"===this.meshManager.materials[s].mat.type){this.meshManager.lineSegMaterial=this.meshManager.materials[s].mat;break}this.meshManager.lineSegMaterial||(this.meshManager.lineSegMaterial=new THREE.LineBasicMaterial({color:0,linewidth:1}))}this.meshManager.lineSegMaterialCopy||(this.meshManager.lineSegMaterialCopy=this.meshManager.lineSegMaterial.clone(),this.meshManager.lineSegMaterialCopy.uuid=this.meshManager.lineSegMaterial.uuid,this.meshManager.lineSegMaterialCopy.program=this.meshManager.lineSegMaterial.program,this.meshManager.lineSegMaterialCopy.needsUpdate=this.meshManager.lineSegMaterial.needsUpdate,this.meshManager.lineSegMaterialCopy.opacity=null!=r?r:t,this.meshManager.lineSegMaterialCopy.transparent=!0),this.meshMtlNeedsUpdate=!0},opaqueBody:function(e){for(var t=this.getLeafBodies(e),r=0,i=t.length;r<i;++r){var n,a=t[r];a.leafBodyAttri&&a.isTransparent()&&(a.opaque(),-(a.leafBodyAttri.bodyOpacity=1)<(n=this.transparentizedBodies.indexOf(a)))&&(this.transparentModeBodiesMap.delete(a.uuid),this.transparentizedBodies.splice(n,1),this.transparentBodyChanged=!0)}this.meshMtlNeedsUpdate=!0},transparentizeBodies:function(e){if(e&&e.length){this.transparentizedBodies=[];for(var t=0;t<e.length;++t){var r=this.getLeafBodies(e[t]);if(r&&0<r.length)for(var i=0,n=r.length;i<n;++i){var a=r[i];this.transparentModeBodiesMap.set(a.uuid,!0),a.isTransparent()||(a.transparent(),a.deIsolate(),this.transparentizedBodies.push(a),this.transparentBodyChanged=!0)}}for(t=0;t<this.wholeLeafBodyNodes.length;++t){var o=this.wholeLeafBodyNodes[t];o.isTransparent()||o.isolate()}if(!this.meshManager.matsCopy||0===this.meshManager.matsCopy.length)for(i=0,n=this.meshManager.mats.length;i<n;++i)this.meshManager.mats[i]&&(this.meshManager.matsCopy[i]=this.meshManager.mats[i].clone(),this.meshManager.matsCopy[i].uuid=this.meshManager.mats[i].uuid,this.meshManager.matsCopy[i].program=this.meshManager.mats[i].program,this.meshManager.matsCopy[i].needsUpdate=this.meshManager.mats[i].needsUpdate,this.meshManager.matsCopy[i].opacity=De.bodyOpacity,this.meshManager.matsCopy[i].transparent=!0);if(!this.meshManager.lineSegMaterial){for(var s in this.meshManager.materials)if("LineBasicMaterial"===this.meshManager.materials[s].mat.type){this.meshManager.lineSegMaterial=this.meshManager.materials[s].mat;break}this.meshManager.lineSegMaterial||(this.meshManager.lineSegMaterial=new THREE.LineBasicMaterial({color:0,linewidth:1}))}this.meshManager.lineSegMaterialCopy||(this.meshManager.lineSegMaterialCopy=this.meshManager.lineSegMaterial.clone(),this.meshManager.lineSegMaterialCopy.uuid=this.meshManager.lineSegMaterial.uuid,this.meshManager.lineSegMaterialCopy.program=this.meshManager.lineSegMaterial.program,this.meshManager.lineSegMaterialCopy.needsUpdate=this.meshManager.lineSegMaterial.needsUpdate,this.meshManager.lineSegMaterialCopy.opacity=De.lineOpacity,this.meshManager.lineSegMaterialCopy.transparent=!0),this.meshMtlNeedsUpdate=!0}},transparentizeBodiesOnly:function(e,t){for(var r=0;r<e.length;++r){var i=this.getLeafBodies(e[r]);if(i&&0<i.length)for(var n=0,a=i.length;n<a;++n){var o=i[n];o.isTransparent()||(o.transparent(),o.deIsolate(),this.transparentModeBodiesMap.set(o.uuid,!0),this.transparentizedBodies.push(o),this.transparentBodyChanged=!0)}}if(!this.meshManager.matsCopy||0===this.meshManager.matsCopy.length)for(n=0,a=this.meshManager.mats.length;n<a;++n)this.meshManager.mats[n]&&(this.meshManager.matsCopy[n]=this.meshManager.mats[n].clone(),this.meshManager.matsCopy[n].uuid=this.meshManager.mats[n].uuid,this.meshManager.matsCopy[n].program=this.meshManager.mats[n].program,this.meshManager.matsCopy[n].needsUpdate=this.meshManager.mats[n].needsUpdate,this.meshManager.matsCopy[n].opacity=De.bodyOpacity,this.meshManager.matsCopy[n].transparent=!0);if(!this.meshManager.lineSegMaterial){for(var s in this.meshManager.materials)if("LineBasicMaterial"===this.meshManager.materials[s].mat.type){this.meshManager.lineSegMaterial=this.meshManager.materials[s].mat;break}this.meshManager.lineSegMaterial||(this.meshManager.lineSegMaterial=new THREE.LineBasicMaterial({color:0,linewidth:1}))}this.meshManager.lineSegMaterialCopy||(this.meshManager.lineSegMaterialCopy=this.meshManager.lineSegMaterial.clone(),this.meshManager.lineSegMaterialCopy.uuid=this.meshManager.lineSegMaterial.uuid,this.meshManager.lineSegMaterialCopy.program=this.meshManager.lineSegMaterial.program,this.meshManager.lineSegMaterialCopy.needsUpdate=this.meshManager.lineSegMaterial.needsUpdate,this.meshManager.lineSegMaterialCopy.opacity=De.lineOpacity,this.meshManager.lineSegMaterialCopy.transparent=!0),this.meshMtlNeedsUpdate=!0},getTransparentizedBodies:function(){return this.transparentizedBodies},getAllTransparentBodies:function(e){if(this.transparentBodyChanged){for(var t=this.transparentBodies.length=0,r=this.wholeLeafBodyNodes.length;t<r;++t){var i=this.wholeLeafBodyNodes[t];if(!this.NeedsMergeBodyNode||!i.IsMergedNode)if(i.isTransparent())this.transparentBodies.push(this.wholeLeafBodyNodes[t]);else for(var n=this.meshManager.getNumBodyMeshs(i),a=0;a<n;++a){var o=this.meshManager.getBodyMeshId(i,a),o=this.meshManager.getMeshOriginalMaterial(o);if(o&&o.transparent&&(o.opacity<=.99||o.alphaMap)){this.transparentBodies.push(i);break}}}this.transparentBodyChanged=!1,e&&this.sortBodiesByVolume(this.transparentBodies)}return this.transparentBodies},inIsolate:function(){return 0<this.transparentizedBodies.length},exitIsolate:function(){for(var e=0;e<this.wholeLeafBodyNodes.length;++e){var t=this.wholeLeafBodyNodes[e];t.deIsolate(),t.opaque()}this.transparentizedBodies.length=0,this.transparentBodyChanged=!0,this.meshMtlNeedsUpdate=!0},isolateBodiesOnly:function(e){for(var t=0;t<e.length;++t){var r=e[t],i=this.getLeafBodies(r);if(i&&0<i.length)for(var n=0,a=i.length;n<a;++n)i[n].leafBodyAttri&&(i[n].isolate(),i[n].opaque(),this.transparentModeBodiesMap.delete(i[n].uuid),this.RemoveElement(this.transparentizedBodies,i[n]),this.transparentBodyChanged=!0)}0==this.transparentizedBodies.length&&this.exitIsolate(),this.meshMtlNeedsUpdate=!0},isolateBodyOnly:function(e){var t=this.getLeafBodies(e);if(t&&0<t.length)for(var r=0,i=t.length;r<i;++r)t[r].leafBodyAttri&&(t[r].isolate(),t[r].opaque(),this.transparentModeBodiesMap.set(t[r].uuid,!0),this.RemoveElement(this.transparentizedBodies,t[r]),this.transparentBodyChanged=!0);this.meshMtlNeedsUpdate=!0},isolateBodies:function(e,t,r){if(e){for(var i=0,n=e.length;i<n;++i){var a=this.getLeafBodies(e[i]);if(a&&0<a.length)for(var o=0,s=a.length;o<s;++o)a[o].leafBodyAttri&&(a[o].isolate(),a[o].opaque())}this.transparentizedBodies=[];for(i=0;i<this.wholeLeafBodyNodes.length;++i){var l=this.wholeLeafBodyNodes[i];this.transparentModeBodiesMap.set(l.uuid,!0),l.isIsolated()||(l.transparent(),this.transparentizedBodies.push(l))}if(this.transparentBodyChanged=!0,!this.meshManager.matsCopy||0===this.meshManager.matsCopy.length)for(o=0,s=this.meshManager.mats.length;o<s;++o)this.meshManager.mats[o]&&(this.meshManager.matsCopy[o]=this.meshManager.mats[o].clone(),this.meshManager.matsCopy[o].uuid=this.meshManager.mats[o].uuid,this.meshManager.matsCopy[o].program=this.meshManager.mats[o].program,this.meshManager.matsCopy[o].needsUpdate=this.meshManager.mats[o].needsUpdate,this.meshManager.matsCopy[o].opacity=t,this.meshManager.matsCopy[o].transparent=!0);if(!this.meshManager.lineSegMaterial){for(var d in this.meshManager.materials)if("LineBasicMaterial"===this.meshManager.materials[d].mat.type){this.meshManager.lineSegMaterial=this.meshManager.materials[d].mat;break}this.meshManager.lineSegMaterial||(this.meshManager.lineSegMaterial=new THREE.LineBasicMaterial({color:0,linewidth:1}))}this.meshManager.lineSegMaterialCopy||(this.meshManager.lineSegMaterialCopy=this.meshManager.lineSegMaterial.clone(),this.meshManager.lineSegMaterialCopy.uuid=this.meshManager.lineSegMaterial.uuid,this.meshManager.lineSegMaterialCopy.program=this.meshManager.lineSegMaterial.program,this.meshManager.lineSegMaterialCopy.needsUpdate=this.meshManager.lineSegMaterial.needsUpdate,this.meshManager.lineSegMaterialCopy.opacity=null!=r?r:t,this.meshManager.lineSegMaterialCopy.transparent=!0),0==this.transparentizedBodies.length&&this.exitIsolate(),this.meshMtlNeedsUpdate=!0}},hideBody:function(e){if(!(this.state<ee.StateType.CONTENT_LOADED)){for(var t=[e],r=0;r<t.length;++r)if(0===t[r].children.length){if(t[r].leafBodyAttri||(t[r].visible=!1),0<=t[r].id&&!t[r].isReferenceEntity()&&!t[r].isCoordinate()){var i=t[r];if(i.leafBodyAttri){if(this.hasHiddenBodies=!0,i.hide(),this.hideBodies.push(i),i.leafBodyAttri&&i.leafBodyAttri.bodyTextIds&&0<i.leafBodyAttri.bodyTextIds.length)for(var n=0;n<i.leafBodyAttri.bodyTextIds.length;++n){var a,o=i.leafBodyAttri.bodyTextIds[n];this.meshManager.textGeomId[o]<0||((o=this.meshManager.geomManager.getGeomFromId(this.meshManager.textGeomId[o]))._visible=!1,(a=this.viewer.scene.getObjectByName("dashLine"))&&(M=a.getObjectByName(o.uuid))&&(M.visible=!1))}if(i.leafBodyAttri&&i.leafBodyAttri.bodyLineSegIds&&0<i.leafBodyAttri.bodyLineSegIds.length)for(var s=0;s<i.leafBodyAttri.bodyLineSegIds.length;++s){var l=i.leafBodyAttri.bodyLineSegIds[s];this.meshManager.lineSegGeomId[l]<0||(l=this.meshManager.geomManager.getGeomFromId(this.meshManager.lineSegGeomId[l]),(l=this.lineTypes?this.lineTypes.geomUUidToLineInfo[l.uuid]:null)&&l.lineTypeID&&(l._visible=!1,l=this.meshManager.lineTypeUuid2ParamsMap.get(l.lineTypeID))&&(l.visible=!1))}}}}else{t[r].visible=!1;for(var d=0,c=t[r].children.length;d<c;++d)t.push(t[r].children[d])}(e.isReferenceEntity()||e.isCoordinate())&&(e.hide(),this.hideBodies.push(e));for(var h=this.getLeafReferenceEntities(e),u=0,p=h.length;u<p;u++)h[u].leafBodyAttri&&(h[u].hide(),this.hideBodies.push(h[u]));for(var f=this.getLeafCoordinate(e),u=0,p=f.length;u<p;u++)f[u].hide(),this.hideBodies.push(f[u]);if(this.viewer.is2DModel&&this.viewer.pmiObject)for(var m=this.getLayerBodies(e),g=0,p=m.length;g<p;++g){var v=m[g];if(v.pmiuuid){for(var y=this.viewer,A=y.pmiObject.getObjectByName("TextGroup"),d=0;d<v.pmiuuid.length;++d){for(var M,E=v.pmiuuid[d],u=0;u<y.SDFMaker.AttributeArray.length;++u)y.SDFMaker.AttributeArray[u]&&y.SDFMaker.AttributeArray[u].forEach(function(e,t){var r=e[E];if(r){for(var e=u+"_"+t,i=A.getObjectByName(e).geometry.attributes.position.data,n=r.start;n<r.start+r.count;n++)i.array[n*i.stride+3]<=1&&(i.array[n*i.stride+3]+=1.25);i.needsUpdate=!0,i.updateRange.count=i.count*i.stride}});(M=y.pmiObject.getObjectByProperty("uuid",E))&&(M.visible=!1)}v.visible=!1}}this.viewer.render()}},showBody:function(e){if(!(this.state<ee.StateType.RENDERING_PREPARED)){for(var t=[e],a=0;a<t.length;++a)if(!t[a].unload)if(0==t[a].children.length){if(t[a].leafBodyAttri||(t[a].visible=!0),0<=t[a].id&&!t[a].isReferenceEntity()&&!t[a].isCoordinate())if((p=t[a]).leafBodyAttri){if(p.show(),this.RemoveElement(this.hideBodies,p),p.leafBodyAttri&&p.leafBodyAttri.bodyTextIds&&0<p.leafBodyAttri.bodyTextIds.length)for(var r=0;r<p.leafBodyAttri.bodyTextIds.length;++r){var i,n=p.leafBodyAttri.bodyTextIds[r];this.meshManager.textGeomId[n]<0||((n=this.meshManager.geomManager.getGeomFromId(this.meshManager.textGeomId[n]))._visible=!0,(i=this.viewer.scene.getObjectByName("dashLine"))&&(y=i.getObjectByName(n.uuid))&&(y.visible=!0))}if(p.leafBodyAttri&&p.leafBodyAttri.bodyLineSegIds&&0<p.leafBodyAttri.bodyLineSegIds.length)for(var o=0;o<p.leafBodyAttri.bodyLineSegIds.length;++o){var s=p.leafBodyAttri.bodyLineSegIds[o];this.meshManager.lineSegGeomId[s]<0||(s=this.meshManager.geomManager.getGeomFromId(this.meshManager.lineSegGeomId[s]),(s=this.lineTypes?this.lineTypes.geomUUidToLineInfo[s.uuid]:null)&&s.lineTypeID&&(s._visible=!0,s=this.meshManager.lineTypeUuid2ParamsMap.get(s.lineTypeID))&&(s.visible=!0))}}}else{t[a].visible=!0;for(var l=0,d=t[a].children.length;l<d;++l)t.push(t[a].children[l])}(e.isReferenceEntity()||e.isCoordinate())&&(e.show(),this.RemoveElement(this.hideBodies,e));for(var c=this.getLeafReferenceEntities(e),a=0,h=c.length;a<h;a++)c[a].leafBodyAttri&&(c[a].parent.isComponentRefPlaneVisible()&&"RefPlane"==c[a].type||c[a].parent.isComponentRefAxisVisible()&&"RefAxis"==c[a].type)&&(c[a].show(),this.RemoveElement(this.hideBodies,c[a]));for(var u=this.getLeafCoordinate(e),a=0,h=u.length;a<h;a++)u[a].parent.isComponentCoordinateSysVisible()&&(u[a].show(),this.RemoveElement(this.hideBodies,u[a]));if(this.viewer.is2DModel&&this.viewer.pmiObject){for(var p,f=this.getLayerBodies(e),m=0,h=f.length;m<h;++m)if((p=f[m]).pmiuuid){for(var g=this.viewer,v=g.pmiObject.getObjectByName("TextGroup"),l=0;l<p.pmiuuid.length;++l){for(var y,A=p.pmiuuid[l],a=0;a<g.SDFMaker.AttributeArray.length;++a)g.SDFMaker.AttributeArray[a]&&g.SDFMaker.AttributeArray[a].forEach(function(e,t){var r=e[A];if(r){for(var e=a+"_"+t,i=v.getObjectByName(e).geometry.attributes.position.data,n=r.start;n<r.start+r.count;n++)1<i.array[n*i.stride+3]&&(i.array[n*i.stride+3]-=1.25);i.needsUpdate=!0,i.updateRange.count=i.count*i.stride}});(y=g.pmiObject.getObjectByProperty("uuid",A))&&(y.visible=!0)}p.visible=!0}e="0x"+this.viewer.renderer.getClearColor(this.viewer.oldClearColor).getHexString();this.viewer.setBackGroundColor(e)}0==this.hideBodies.length&&(this.hasHiddenBodies=!1)}},showBodyReversed:function(e){if(!(this.state<ee.StateType.RENDERING_PREPARED))for(var t=this.getLeafBodies(e),r=0,i=t.length;r<i;++r){var n=t[r];n.leafBodyAttri&&(n.isHidden()?(n.show(),this.RemoveElement(this.hideBodies,n)):(n.hide(),this.hideBodies.push(n)),n.isHidden())&&(this.hasHiddenBodies=!0)}},showAllBodies:function(){if(!(this.state<ee.StateType.RENDERING_PREPARED)){this.hasHiddenBodies=!1,this.hideBodies=[];for(var e=0,t=this.wholeLeafBodyNodes.length;e<t;++e)this.wholeLeafBodyNodes[e].leafBodyAttri&&this.wholeLeafBodyNodes[e].show();for(var r=0,i=this.emptyBodyNodes.length;r<i;++r)this.emptyBodyNodes[r].show()}},hideAllBodies:function(e){if(!(this.state<ee.StateType.RENDERING_PREPARED)){this.hasHiddenBodies=!0,e&&(this.hideBodies=[]);for(var t=0,r=this.wholeLeafBodyNodes.length;t<r;++t)this.wholeLeafBodyNodes[t].leafBodyAttri&&(this.wholeLeafBodyNodes[t].hide(),e)&&this.hideBodies.push(this.wholeLeafBodyNodes[t]);for(var i=0,n=this.emptyBodyNodes.length;i<n;++i)this.emptyBodyNodes[i].hide(),e&&this.hideBodies.push(this.emptyBodyNodes[i])}},reverseBodyVisibility:function(){if(!(this.state<ee.StateType.RENDERING_PREPARED)){this.hasHiddenBodies=!1,this.hideBodies=[];for(var e=0,t=this.wholeLeafBodyNodes.length;e<t;++e)this.wholeLeafBodyNodes[e].leafBodyAttri&&(this.wholeLeafBodyNodes[e].isHidden()?this.wholeLeafBodyNodes[e].show():(this.wholeLeafBodyNodes[e].hide(),this.hideBodies.push(this.wholeLeafBodyNodes[e]),this.hasHiddenBodies=!0))}},isBodyAllChildHidden:function(e){for(var t=this.getLeafBodies(e),r=0,i=t.length;r<i;++r)if(!t[r].isHidden())return!1;return!(e.isReferenceEntity()&&!e.isHidden()||e.isCoordinate()&&!e.isHidden())},isBodyAllChildSelected:function(e){for(var t=this.getLeafBodies(e),r=0,i=t.length;r<i;++r)if(!t[r].isSelected())return!1;return!(e.isReferenceEntity()&&!e.isSelected()||e.isCoordinate()&&!e.isSelected())},isBodyAllChildShow:function(e){for(var t=this.getLeafBodies(e),r=0,i=t.length;r<i;++r)if(t[r].isHidden())return!1;return!0},isBodyOrSomeChildHidden:function(e){if(e.isHidden())return!0;for(var t=this.getLeafBodies(e),r=0,i=t.length;r<i;++r){var n=t[r];if(n.leafBodyAttri&&(n.isHidden()&&!n.unload))return!0}for(var a=[e],r=0;r<a.length;++r){if(0==a[r].children.length&&!a[r].leafBodyAttri&&"Body"!=a[r].type&&!a[r].visible)return!0;for(var o=0,s=a[r].children.length;o<s;++o)a.push(a[r].children[o])}if(this.viewer.is2DModel&&this.viewer.pmiObject)for(var l=this.getLayerBodies(e),d=0,i=l.length;d<i;++d)if((n=l[d]).pmiuuid&&!n.visible)return!0;return!1},getBodyOrSomeChildVisibleStatus:function(e){if(e.isHidden())return 0;for(var t=function(e,t){return 0==t?1:0<e&&e<t?2:e==t?0:0==e?1:void 0},r=this.getLeafBodies(e),i=0,n=0,a=0,o=r.length;a<o;++a){var s=r[a];if(s.leafBodyAttri&&(s.unload||(n++,s.isHidden()&&i++),2==t(i,n)))return 2}for(var l=[e],a=0;a<l.length;++a){if(0!=l[a].children.length||l[a].leafBodyAttri||"Body"==l[a].type)for(var d=0,c=l[a].children.length;d<c;++d)l.push(l[a].children[d]);else n++,l[a].visible||i++;if(2==t(i,n))return 2}if(this.viewer.is2DModel&&this.viewer.pmiObject)for(var h=this.getLayerBodies(e),u=0,o=h.length;u<o;++u)if((s=h[u]).pmiuuid&&(n++,s.visible||i++),2==t(i,n))return 2;return t(i,n)},isBodyAllChildTransparent:function(e){for(var t=this.getLeafBodies(e),r=0,i=t.length;r<i;++r)if(!t[r].isTransparent())return!1;return!0},getSelectedBodies:function(){return this.selectedBodies},clearSelection:function(){for(var a=0,e=this.selectedBodies.length;a<e;++a)this.selectedBodies[a].deSelect();this.selectedBodies.length=0;var t=this.viewer.ndsModel.rootBodyNode;if(this.viewer.pmiObject&&!this.viewer._clearSelectedPmi&&this.deselectPMIObject(this.viewer.pmiObject),this.viewer.is2DModel&&this.viewer.pmiObject)for(var r=this.getLayerBodies(t),i=0,e=r.length;i<e;++i)if((d=r[i]).pmiuuid)for(var n=this.viewer,o=n.pmiObject.getObjectByName("TextGroup"),s=0;s<d.pmiuuid.length;++s){for(var l=d.pmiuuid[s],a=0;a<n.SDFMaker.AttributeArray.length;++a)n.SDFMaker.AttributeArray[a]&&n.SDFMaker.AttributeArray[a].forEach(function(e,t){var r=e[l];if(r){for(var e=a+"_"+t,i=o.getObjectByName(e).geometry.attributes.position.data,n=r.start;n<r.start+r.count;n++)1<i.array[n*i.stride+4]&&(i.array[n*i.stride+4]-=1.25);i.needsUpdate=!0,i.updateRange.count=i.count*i.stride}});(m=n.pmiObject.getObjectByProperty("uuid",l))&&m.material&&m.material.color.copy(m.color)}for(var d,c=this.getLeafBodies(t),h=0,u=c.length;h<u;h++)if((d=c[h]).leafBodyAttri&&d.leafBodyAttri.bodyTextIds&&0<d.leafBodyAttri.bodyTextIds.length)for(var p=0;p<d.leafBodyAttri.bodyTextIds.length;++p){var f,m,g,v=d.leafBodyAttri.bodyTextIds[p];this.meshManager.textGeomId[v]<0||(f=this.meshManager.geomManager.getGeomFromId(this.meshManager.textGeomId[v]),(g=this.viewer.scene.getObjectByName("dashLine"))&&(m=g.getObjectByName(f.uuid))&&(g=this.meshManager.mats[this.meshManager.textMaterialId[v]],m.material.color.copy(g.color)))}for(a=0,e=this.wholeRefEntityNodes.length;a<e;++a)this.wholeRefEntityNodes[a].deSelect();for(a=0,e=this.wholeCoordinateNodes.length;a<e;++a)this.wholeCoordinateNodes[a].deSelect();this.viewer.is2DModel&&(t="0x"+this.viewer.renderer.getClearColor(this.viewer.oldClearColor).getHexString(),this.viewer.setBackGroundColor(t))},addSelection:function(e){for(var t=this.getLeafBodies(e),a=0,r=t.length;a<r;++a){var i=t[a];if(i.leafBodyAttri&&(!i.isSelected()&&(i.select(),this.selectedBodies.push(i),i.leafBodyAttri)&&i.leafBodyAttri.bodyTextIds&&0<i.leafBodyAttri.bodyTextIds.length))for(var n=0;n<i.leafBodyAttri.bodyTextIds.length;++n){var o,s=i.leafBodyAttri.bodyTextIds[n];this.meshManager.textGeomId[s]<0||(s=this.meshManager.geomManager.getGeomFromId(this.meshManager.textGeomId[s]),(o=this.viewer.scene.getObjectByName("dashLine"))&&(f=o.getObjectByName(s.uuid))&&f.material.color.copy(De.selectedColor))}}for(var l=this.getLeafReferenceEntities(e),a=0,r=l.length;a<r;a++)l[a].leafBodyAttri&&l[a].select();if(this.viewer.is2DModel&&this.viewer.pmiObject)for(var d=this.getLayerBodies(e),c=0,r=d.length;c<r;++c)if((i=d[c]).pmiuuid)for(var h=this.viewer,u=h.pmiObject.getObjectByName("TextGroup"),p=0;p<i.pmiuuid.length;++p){for(var f,m=i.pmiuuid[p],a=0;a<h.SDFMaker.AttributeArray.length;++a)h.SDFMaker.AttributeArray[a]&&h.SDFMaker.AttributeArray[a].forEach(function(e,t){var r=e[m];if(r){for(var e=a+"_"+t,i=u.getObjectByName(e).geometry.attributes.position.data,n=r.start;n<r.start+r.count;n++)i.array[n*i.stride+4]<=1&&(i.array[n*i.stride+4]+=1.25);i.needsUpdate=!0,i.updateRange.count=i.count*i.stride}});(f=h.pmiObject.getObjectByProperty("uuid",m))&&f.material&&f.material.color&&f.material.color.set(16776960)}},selectPMIObject:function(a,e){null==e&&(e=!0),(a="NoteNDS"==a.type?a.parent:a).visible||(this.viewer.setPMIObjectVisible(a,!0),a.SelectVisible=!0),a.select=!0,a.traverse(function(e){if(e.select=!0,a.SelectVisible&&(e.SelectVisible=!0),e.geometry){var t=null;if(t="ShaderMaterial"==e.material.type?e.geometry.attributes.position.data:t){if(Number.isFinite(e.geometry.drawRange.count))for(var r=e.geometry.drawRange.count,i=e.geometry.drawRange.start;i<e.geometry.drawRange.start+r;++i){var n=e.geometry.index.array[i];t.array[n*t.stride+4]<=1&&(t.array[n*t.stride+4]+=1.25)}else for(i=0;i<e.geometry.index.array.length;++i){n=e.geometry.index.array[i];t.array[n*t.stride+4]<=1&&(t.array[n*t.stride+4]+=1.25)}t.needsUpdate=!0,t.updateRange.count=t.count*t.stride}else e.material.selectMaterial||(e.material.selectMaterial=e.material.clone(),e.material.selectMaterial.color.setRGB(.09,.501,.89),e.material.selectMaterial.originMateial=e.material),e.material.originMateial||(e.material=e.material.selectMaterial)}});var t=He.getExtension("NDSSketchPMIExtension");t&&this.viewer.isPmiVisible()&&t.selectFaceAndLineByPMIObject(a),e&&this.viewer.dispatchEvent({type:"selPMI",object:a})},deselectPMIObject:function(e,t){void 0===t&&(t=!0),(e="NoteNDS"==e.type?e.parent:e).SelectVisible&&(e.SelectVisible=!1,this.viewer.setPMIObjectVisible(e,!1));var a=e.select=!1,o=this,s=He.getExtension("NDSSketchPMIExtension");e.traverse(function(e){if(e.select&&(a=!0),e.select=!1,e.SelectVisible&&(e.SelectVisible=!1,o.viewer.setPMIObjectVisible(e,!1)),e.children&&0<e.children.length&&e.NdsBodyNode&&("Mesh"==e.children[0].type||"Line"==e.children[0].type||"Line2"==e.children[0].type||"LineSegments"==e.children[0].type||"LineSegments2"==e.children[0].type||"Note"==e.children[0].type)&&s&&s.deselectFaceAndLineByPMIObject(e),e.geometry){var t=null;if(t="ShaderMaterial"==e.material.type?e.geometry.attributes.position.data:t){if(Number.isFinite(e.geometry.drawRange.count))for(var r=e.geometry.drawRange.count,i=e.geometry.drawRange.start;i<e.geometry.drawRange.start+r;++i){var n=e.geometry.index.array[i];1<t.array[n*t.stride+4]&&(t.array[n*t.stride+4]-=1.25)}else for(i=0;i<e.geometry.index.array.length;++i){n=e.geometry.index.array[i];1<t.array[n*t.stride+4]&&(t.array[n*t.stride+4]-=1.25)}t.needsUpdate=!0,t.updateRange.count=t.count*t.stride}else e.material.originMateial&&(e.material=e.material.originMateial)}}),s&&s.deselectFaceAndLineByPMIObject(e),t&&(e.uuid==this.viewer.pmiObject.uuid&&a?this.viewer.dispatchAsyncEvent({type:"clearSelPMI"}):this.viewer.dispatchAsyncEvent({type:"deselPMI",object:e}))},removeSelection:function(e){var t=this.getLeafBodies(e);if(0<t.length)for(var a=0,r=t.length;a<r;++a){var i=t[a];if(i.leafBodyAttri&&i.isSelected()){i.deSelect();var n=this.selectedBodies.indexOf(i);if(-1<n&&this.selectedBodies.splice(n,1),i.leafBodyAttri&&i.leafBodyAttri.bodyTextIds&&0<i.leafBodyAttri.bodyTextIds.length)for(var o=0;o<i.leafBodyAttri.bodyTextIds.length;++o){var s,l,d=i.leafBodyAttri.bodyTextIds[o];this.meshManager.textGeomId[d]<0||(s=this.meshManager.geomManager.getGeomFromId(this.meshManager.textGeomId[d]),(l=this.viewer.scene.getObjectByName("dashLine"))&&(v=l.getObjectByName(s.uuid))&&(l=this.meshManager.mats[this.meshManager.textMaterialId[d]],v.material.color.copy(l.color)))}}}for(var c=this.getLeafReferenceEntities(e),a=0,h=c.length;a<h;a++)c[a].leafBodyAttri&&c[a].deSelect();if(this.viewer.is2DModel&&this.viewer.pmiObject){for(var u=this.getLayerBodies(e),p=0,h=u.length;p<h;++p)if((i=u[p]).pmiuuid)for(var f=this.viewer,m=f.pmiObject.getObjectByName("TextGroup"),g=0;g<i.pmiuuid.length;++g){for(var v,y=i.pmiuuid[g],a=0;a<f.SDFMaker.AttributeArray.length;++a)f.SDFMaker.AttributeArray[a]&&f.SDFMaker.AttributeArray[a].forEach(function(e,t){var r=e[y];if(r){for(var e=a+"_"+t,i=m.getObjectByName(e).geometry.attributes.position.data,n=r.start;n<r.start+r.count;n++)1<i.array[n*i.stride+4]&&(i.array[n*i.stride+4]-=1.25);i.needsUpdate=!0,i.updateRange.count=i.count*i.stride}});(v=f.pmiObject.getObjectByProperty("uuid",y))&&v.material&&v.material.color&&v.material.color.copy(v.color)}this.viewer.is2DModel&&(e="0x"+this.viewer.renderer.getClearColor(this.viewer.oldClearColor).getHexString(),this.viewer.setBackGroundColor(e))}},preSelectObject:function(e){if(!this.preselectedObject||this.preselectedObject.uuid!=e.uuid){if(this.preselectedObject)for(var t=0,r=(i=this.getAllLeafNodes(this.preselectedObject)).length;t<r;++t)i[t].leafBodyAttri&&i[t].dePreSelect();this.preselectedObject=e;for(var i,t=0,r=(i=this.getAllLeafNodes(e)).length;t<r;++t)i[t].leafBodyAttri&&i[t].preSelect()}},clearPreSelection:function(){if(this.preselectedObject){for(var e=this.getAllLeafNodes(this.preselectedObject),t=0,r=e.length;t<r;++t)e[t].leafBodyAttri&&e[t].dePreSelect();return!(this.preselectedObject=null)}return!1},sortBodies:function(e){for(var t,r=[],i=new THREE.Box3,n=0,a=e.length;n<a;++n)e[n].leafBodyAttri&&(t=(i=this.getBodyBoundingBox(e[n],i)).distanceToPoint(this.viewer.camera.position),r.push({body:e[n],z:t}));r.sort(Gt);for(n=0,a=e.length;n<a;++n)e[n]=r[n].body},sortBodiesByVolume:function(e){for(var t,r,i,n=[],a=[],o=new THREE.Box3,s=0,l=e.length;s<l;++s)e[s].leafBodyAttri?(t=(o=this.getBodyBoundingBox(e[s],o)).max.x-o.min.x,r=o.max.y-o.min.y,i=o.max.z-o.min.z,n.push({body:e[s],z:t*r*i})):a.push(e[s]);n.sort(Vt);for(s=0,l=n.length;s<l;++s)e[s]=n[s].body;if(0<a.length)for(var d=n.length,c=e.length;d<c;++d)e[d]=a[d-n.length]},getGeometriesCount:function(){var e={Mesh:{count:0,triangles:0,points:0},Line:{count:0,points:0}};e.Mesh.count=this.wholeLeafBodyNodes.length;for(var t=0,r=this.geomManager.geoms.length;t<r;++t){var i,n,a=this.geomManager.geoms[t];null!=a&&null!=a.index&&(i=a.refMeshes.length,n=a.refLineSegs.length,0<i?(e.Mesh.triangles+=a.drawRange.count/3*i,a.index.count===a.drawRange.start+a.drawRange.count&&(a.attributes.position.isInterleavedBufferAttribute?e.Mesh.points+=a.attributes.position.data.count:e.Mesh.points+=a.attributes.position.count)):0<n&&(e.Line.count+=n,a.index.count===a.drawRange.start+a.drawRange.count)&&(a.attributes.position.isInterleavedBufferAttribute?e.Line.points+=a.attributes.position.data.count:e.Line.points+=a.attributes.position.count))}return e},updateBodyMeshIds:function(){for(var e=0,t=this.wholeLeafBodyNodes.length;e<t;++e)this.wholeLeafBodyNodes[e].leafBodyAttri&&(this.wholeLeafBodyNodes[e].leafBodyAttri.bodyMeshIds.length=0,this.wholeLeafBodyNodes[e].leafBodyAttri.bodyLineSegIds.length=0);for(e=0;e<this.meshManager.nMeshes;++e)this.meshManager.bodyNodes[e].leafBodyAttri.bodyMeshIds.push(e);for(e=0;e<this.meshManager.nLineSegments;++e)this.meshManager.lineSegBodyNodes[e].leafBodyAttri.bodyLineSegIds.push(e)},delete:function(e){var t=e.parent;if(null!=t){for(var r=0;r<t.children.length;++r)if(t.children[r]===e){t.children.splice(r,1);break}for(var i=[e],n=0;n<i.length;++n){var a=i[n];delete this.bodyUuid2NodeMap[a.uuid];for(var o=0,s=a.children.length;o<s;++o)i.push(a.children[o])}var l=this.getLeafBodies(e);if(0<l.length){for(var d=[],c=[],n=0,h=l.length;n<h;++n){var u=l[n];u.leafBodyAttri&&(d.extend(u.leafBodyAttri.bodyMeshIds),c.extend(u.leafBodyAttri.bodyLineSegIds),u.leafBodyAttri=null),-1<(f=this.wholeLeafBodyNodes.indexOf(u))&&this.wholeLeafBodyNodes.splice(f,1),0<this.transparentBodies.length&&-1<(f=this.transparentBodies.indexOf(u))&&(this.transparentBodies.splice(f,1),this.transparentBodiesDirty=!0),0<this.transparentizedBodies.length&&-1<(f=this.transparentizedBodies.indexOf(u))&&(this.transparentModeBodiesMap.delete(u.uuid),this.transparentizedBodies.splice(f,1),this.transparentBodiesDirty=!0),0<this.selectedBodies.length&&-1<(f=this.selectedBodies.indexOf(u))&&(this.selectedBodies.splice(f,1),this.selectedBodiesDirty=!0),0<this.draggedBodies.length&&-1<(f=this.draggedBodies.indexOf(u))&&this.draggedBodies.splice(f,1),0<this.hideBodies.length&&-1<(f=this.hideBodies.indexOf(u))&&this.hideBodies.splice(f,1)}this.bvhCreater.delete(d,c),this.meshManager.instancedMeshIds.length=0,this.updateBodyMeshIds(),this.meshManager.collectGeomRefEntities(),this.meshManager.setMaterialInfor(),this.viewer.modelRootObject.boundingBox.copy(this.sptIndex.root.boundingBox),this.viewer.controls.setBoundingBox(this.viewer.modelRootObject.boundingBox.min,this.viewer.modelRootObject.boundingBox.max)}var p=this.getLeafReferenceEntities(e);if(0<p.length){for(n=0,h=p.length;n<h;++n)p[n].leafBodyAttri=null,-1<(f=this.wholeRefEntityNodes.indexOf(p[n]))&&this.wholeRefEntityNodes.splice(f,1),this.referenceEntityDispManager.removeRefEntity(p[n]);this.referenceEntityDirty=!0}for(var f,m=this.getLeafCoordinate(e),n=0,g=m.length;n<g;n++)m[n].leafBodyAttri.renderObject&&(this.viewer.scene.remove(m[n].leafBodyAttri.renderObject),m[n].leafBodyAttri.renderObject.detach(),m[n].leafBodyAttri.renderObject=null),-1<(f=this.wholeCoordinateNodes.indexOf(m[n]))&&this.wholeCoordinateNodes.splice(f,1)}},addReferenceEntity:function(e){var t,r=null;!(r=e.parentNode||this.getBodyNodeFromUuid(e.parentUuid))||(t=this.getBodyNodeFromUuid(e.uuid))||((t=new _e).uuid=e.uuid,t.name=e.name,void 0!==e.visible?t.visible=e.visible:t.visible=!1,t.type=e.type,(t.parent=r).children.push(t),t.worldMatrix=this.calculateNodeWorldMatrix(t),t.id=this.leafNodeCount++,this.bodyUuid2NodeMap[t.uuid]=t,this.wholeRefEntityNodes.push(t),r=new R,t.visible||(r.bodyFlag|=Ce.BODYFLAG.HIDDEN_FLAG),r.coords=e.coords.slice(0),r.bbox.setFromArray(r.coords),r.bbox.applyMatrix4(t.worldMatrix),t.leafBodyAttri=r,this.referenceEntityDispManager.addRefEntity(t),this.referenceEntityDirty=!0)},addReferenceEntities:function(e){for(var t=0;t<e.length;t++)this.addReferenceEntity(e[t])},getLayerGroups:function(){return this.layerGroups},getAllLayers:function(){return this.layers},setLayerVisible:function(n,a,e,o){for(var s=this,l=(void 0===e&&(e=!0),void 0===o&&(o=!1),this.viewer.ndsModel.sketchModel),d=0;d<n.length;++d)!function(){var t=n[d];if(s.wholeLeafBodyNodes.forEach(function(e){e.layerId==t&&(a?(e.ndsModel.showBody(e),o||(e.checkVisible=!0)):(e.ndsModel.hideBody(e),o||(e.checkVisible=!1)))}),l&&s.viewer.AuxiliaryLineVisible&&l.wholeLeafBodyNodes.forEach(function(e){e.layerId==t&&(a?e.show():e.hide())}),s.PMIUUIDtoPMIObject)for(var e in s.PMIUUIDtoPMIObject){e=s.PMIUUIDtoPMIObject[e];e.layerId==t&&(a?s.viewer.setPMIObjectVisible(e,!0):s.viewer.setPMIObjectVisible(e,!1))}if(s.layers)for(var r=0,i=s.layers.length;r<i;++r)s.layers[r].id==t&&(s.layers[r].visible=a)}();e&&(this.reCaculateLayerGroupsVisibleAndSelect(),this.viewer.renderAllViews())},setLayerGroupVisible:function(e,i){var n=this,a=e;Array.isArray(e)||(a=[e]),this.layerGroups.forEach(function(e){if(-1!==a.indexOf(e.name)){for(var t=[],r=0;r<e.layers.length;r++)t.push(e.layers[r].id);n.setLayerVisible(t,i,!1)}}),this.reCaculateLayerGroupsVisibleAndSelect(),this.viewer.renderAllViews()},setLayerHighLight:function(n,a,e){for(var o=this,s=(void 0===e&&(e=!0),this.viewer.ndsModel.sketchModel),l=[],d=[],c=!1,h=0;h<n.length;++h)!function(){var t=n[h];if(o.wholeLeafBodyNodes.forEach(function(e){e.layerId==t&&(a?l:d).push(e)}),s&&o.viewer.AuxiliaryLineVisible&&s.wholeLeafBodyNodes.forEach(function(e){e.layerId==t&&(a?o.viewer.selectionManager.selectObject(e):o.viewer.selectionManager.deselectObject(e))}),o.PMIUUIDtoPMIObject)for(var e in o.PMIUUIDtoPMIObject){e=o.PMIUUIDtoPMIObject[e];e.layerId==t&&(a?o.viewer.selectPMIObject(e,!1):o.viewer.deselectPMIObject(e,!1),c=!0)}if(o.layers)for(var r=0,i=o.layers.length;r<i;++r)o.layers[r].id==t&&(o.layers[r].selected=a)}();c&&this.viewer.dispatchEvent({type:"selPMI",object:null}),0<l.length&&this.viewer.selectionManager.selectObjectList(l),0<d.length&&this.viewer.selectionManager.deselectObjectList(d),e&&(this.reCaculateLayerGroupsVisibleAndSelect(),this.viewer.renderAllViews())},setLayerGroupHighLight:function(e,i){var n=this,a=e;Array.isArray(e)||(a=[e]),this.layerGroups.forEach(function(e){if(-1!==a.indexOf(e.name)){for(var t=[],r=0;r<e.layers.length;r++)t.push(e.layers[r].id);n.setLayerHighLight(t,i,!1)}}),this.reCaculateLayerGroupsVisibleAndSelect(),this.viewer.renderAllViews()},getLayerGroupsWithItems:function(){var r=this,i=new Set;if(this.layers)for(var e=0,t=this.layers.length;e<t;++e)this.layers[e].count&&i.add(this.layers[e].id);var n=[];if(this.layerGroups)for(var a=0,o=this.layerGroups.length;a<o;++a)!function(){var t,e=r.layerGroups[a];e.count&&(t={name:e.name,count:e.count,visible:e.visible,selected:e.selected,layers:[]},e.layers.forEach(function(e){i.has(e.id)&&t.layers.push(e)}),n.push(t))}();return n},reCaculateLayerGroupsVisibleAndSelect:function(){var e=this,i=new Set,n=new Set;if(this.layers)for(var t=0,r=this.layers.length;t<r;++t)this.layers[t].visible&&i.add(this.layers[t].id),this.layers[t].selected&&n.add(this.layers[t].id);if(this.layerGroups)for(var a=0,o=this.layerGroups.length;a<o;++a)!function(){var t=!0,r=!0;e.layerGroups[a].layers.forEach(function(e){t=t&&i.has(e.id),r=r&&n.has(e.id)}),0==e.layerGroups[a].layers.length&&(r=!1),e.layerGroups[a].visible=t}()},restoreLayerSatus:function(e){var t=new Set,r=new Set,i=new Set,n=new Set;if(e)for(var a=0,o=e.length;a<o;++a)(e[a].visible?t:i).add(e[a].id),(e[a].selected?r:n).add(e[a].id);this.setLayerHighLight(Array.from(r),!0),this.setLayerHighLight(Array.from(n),!1),this.setLayerVisible(Array.from(t),!0,!0,!0),this.setLayerVisible(Array.from(i),!1,!0,!0),this.reCaculateLayerGroupsVisibleAndSelect(),this.viewer.renderAllViews()},clearAllLayerSelect:function(){var e=[];if(this.layers)for(var t=0,r=this.layers.length;t<r;++t)this.layers[t].selected&&e.push(this.layers[t].id);if(this.setLayerHighLight(e,!1),this.reCaculateLayerGroupsVisibleAndSelect(),this.layers)for(var i=0,n=this.layers.length;i<n;++i)this.layers[i].selected=!1;if(this.layerGroups)for(var a=0,o=this.layerGroups.length;a<o;++a)this.layerGroups[a].selected=!1;this.viewer.renderAllViews()},getLayerFromId:function(e){if(this.layers)for(var t=0,r=this.layers.length;t<r;++t)if(this.layers[t].id==e)return this.layers[t];return null}};var kt,jt,zt,Wt,Xt,qt,Yt,Qt,Kt,Zt=new THREE.Box3,Jt=new Map,$t=0,er=function(){function i(e,t){var r=this;void 0===t&&(t=!1),this.__id=$t++,this.activeModel=null,this.isReadOnly=t,this.viewer=e,this.models=[],this.bodyuuidOld2New={},this.materialuuidOld2New={},this.__needsFastRendering=!1,this.__forceRenderAll=!1,this.__grouped_modelset=null,t||(Jt.set(this.__id,new Map),this.__grouped_modelset=Jt.get(this.__id)),this.setDirty=function(e){void 0===e&&(e=r),r.models.forEach(function(e){e.setDirty(0)})}}var e=i.prototype;return e.isEmpty=function(){return!(0<this.models.length)},e.getgeoIds=function(t){var r=[],i=this;return this.models.forEach(function(e){null!=e.geomManager.uuidToIdMap[t]&&(r=e.geomManager.uuidToIdMap[t],i.activeModel=e)}),r},e.addModel=function(e){if(!this.isReadOnly){for(var t in this.staticModel=this.models[0],this.activeModel||(this.activeModel=e),e)null==this[t]&&(this[t]=e[t]);if(De.AnimationEdit||this.viewer.CADViewer)for(var r=0;r<this.models.length;++r)if(this.models[r].modelUri===e.modelUri){e.refModel=this.models[r];break}this.models.push(e),this.__grouped_modelset.has(e.typeName)||this.__grouped_modelset.set(e.typeName,new i(this.viewer,!0)),this.__grouped_modelset.get(e.typeName).models.push(e),De.ScenarioEditor&&(De.ScenarioEditorid++,this.viewer.ScenarioEditorInfo.folderArray[De.ScenarioEditorid]=1),1<this.getAllNoSketchModel().length&&!De.AnimationEdit&&!this.is2DModel&&(this.resetEnableFlip(),this.mergeNode())}},e.resetEnableFlip=function(){this.viewer.enableFlip&&(this.viewer.enableFlip=!1)},e.mergeNode=function(){for(var e=0;e<this.models.length;++e)this.models[e].isSketchModel||this.models[e].state<ee.StateType.PREPARED||!0===this.models[e].NeedsMergeBodyNode||this.models[e].mergeNode()},e.unmergeNode=function(){for(var e=0;e<this.models.length;++e)this.models[e].unmergeNode()},e.setActiveModel=function(e){this.isReadOnly||e<this.models.length&&(this.activeModel=this.models[e])},e.setStaticModel=function(e){this.isReadOnly||e<this.models.length&&(this.staticModel=this.models[e])},e.getActiveModel=function(){return this.isReadOnly||!this.activeModel?null:this.activeModel.isSketchModel?this.activeModel.parentModel:this.activeModel},e.getModelById=function(e){for(var t=0;t<this.models.length;++t)if(this.models[t].id===e)return this.models[t]},e.getSubModelSet=function(e){return this.isReadOnly?null:this.__grouped_modelset.get(e)},e.release=function(){for(var e=this.models.length-1;-1<e;--e)this.unloadModel(e);this.__grouped_modelset.clear()},e.update=function(t){var r=!0,i=!0;this.models.forEach(function(e){r&&(e.update(t),e.state<ee.StateType.ALL_GEOM_LOADED&&(r=!1),e.state!==ee.StateType.PREPARED)&&(i=!1)}),i&&(De.singleHTML?this.viewer.modelRequestor.releaseWorker(!1):this.viewer.modelRequestor.releaseWorker())},e.getMeshManager=function(){if(this.activeModel)return this.activeModel.getMeshManager()},e.getGeomManager=function(){if(this.activeModel)return this.activeModel.getGeomManager()},e.getMeshSets=function(){return this.activeModel?this.activeModel.getMeshSets():1===this.models.length?this.models[0].getMeshSets():void 0},e.getStaticMeshSets=function(){if(this.staticModel)return this.staticModel.getMeshSets()},e.buildMeshSets=function(){if(this.activeModel)return this.activeModel.buildMeshSets()},e.setGlobalModelId=function(e){Ce.globalModelId=e},e.setGlobalObjectId=function(e){St.numObject=e},e.sortMeshSets2=function(e){if(this.activeModel)return this.activeModel.sortMeshSets2(e)},e.getRightBodyuuid=function(e,t){if(this.activeModel)return this.activeModel.getRightBodyuuid(e,t)},e.getLineSegmentsSet=function(){if(this.activeModel)return this.activeModel.getLineSegmentsSet()},e.prepareForRendering=function(e,t){if(this.activeModel)return this.activeModel.prepareForRendering(e,t)},e.backupAllBodyFlag=function(){if(this.activeModel)return this.activeModel.backupAllBodyFlag()},e.backupAllBodiesFlag=function(){this.models.forEach(function(e){e.backupAllBodyFlag()})},e.resetAllBodyFlag=function(){if(this.activeModel)return this.activeModel.resetAllBodyFlag()},e.resetAllBodiesFlag=function(){this.models.forEach(function(e){e.resetAllBodyFlag()})},e.backupEmptyBodyNodeVisibleState=function(){this.isReadOnly||this.models.forEach(function(e){e.backupEmptyBodyNodeVisibleState()})},e.resetEmptyBodyNodeVisibleState=function(){this.isReadOnly||this.models.forEach(function(e){e.resetEmptyBodyNodeVisibleState()})},e.requireContinueLoading=function(){if(this.activeModel)return this.activeModel.requireContinueLoading()},e.hasEnoughAvailableMemory=function(){if(this.activeModel)return this.activeModel.hasEnoughAvailableMemory()},e.setDrawMode=function(t){this.isReadOnly||this.models.forEach(function(e){if(e.isSketchModel)return!0;e.setDrawMode(t)})},e.getDrawModeFace=function(){if(this.activeModel)return this.activeModel.getDrawModeFace()},e.getDrawModeFaceColorMask=function(){if(this.activeModel)return this.activeModel.getDrawModeFaceColorMask()},e.getDrawModeEdge=function(){if(this.activeModel)return this.activeModel.getDrawModeEdge()},e.getDrawModeHiddenEdge=function(){if(this.activeModel)return this.activeModel.getDrawModeHiddenEdge()},e.setOverrideMaterial=function(t,r,i){this.models.forEach(function(e){e.setOverrideMaterial(t,r,i)})},e.attachBodyNode=function(e,t,r,i,n){if(this.activeModel)return this.activeModel.attachBodyNode(e,t,r,i,n)},e.setBodyNodeMaterials=function(e){if(this.activeModel)return this.activeModel.setBodyNodeMaterials(e)},e.getBodyNodeUUidToMaterial=function(){if(this.activeModel)return this.activeModel.getBodyNodeUUidToMaterial()},e.setBodyNodeMaterial=function(e,t){if(this.activeModel)return this.activeModel.setBodyNodeMaterial(e,t)},e.removeAllBodyNodeMaterials=function(){if(this.activeModel)return this.activeModel.removeAllBodyNodeMaterials()},e.removeBodyNodeMaterial=function(e){return this.removeBodyNodeMaterial(e)},e.getBodyNode=function(e){if(this.activeModel)return this.activeModel.getBodyNode(e)},e.getBodyNodeFromUuid=function(t,e){var r=null;return 0<=(e=void 0===e?-1:e)?(e=this.getModelById(e))&&(e=e.getBodyNodeFromUuid(t))&&(r=e):this.models.forEach(function(e){e=e.getBodyNodeFromUuid(t);e&&(r=e)}),r},e.getSelectedLeafBodyNodes=function(e){if(this.activeModel)return this.activeModel.getSelectedLeafBodyNodes(e)},e.getLeafBodies=function(e){if(this.activeModel)return this.activeModel.getLeafBodies(e)},e.getLeafPMIuuid=function(e){if(this.activeModel)return this.activeModel.getLeafPMIuuid(e)},e.getLayerBodies=function(e){if(this.activeModel)return this.activeModel.getLayerBodies(e)},e.getLeafReferenceEntities=function(e){if(this.activeModel)return this.activeModel.getLayerBodies(e)},e.getLeafCoordinate=function(e){if(this.activeModel)return this.activeModel.getLeafCoordinate(e)},e.getAllLeafNodes=function(t){var r=[],i=this;return"parentNode"==t.type?t.children.forEach(function(e){r=r.concat(i.getAllLeafNodes(e))}):this.models.forEach(function(e){e.rootBodyNode.uuid==t.getModel().rootBodyNode.uuid&&(r=r.concat(e.getAllLeafNodes(t)))}),r},e.updateNodeMatrix=function(t,r,e){var i=this.getBodyNodeFromUuid(t,e),n=this;"parentNode"==i.type?i.children.forEach(function(e){n.updateNodeMatrix(e.uuid,r)}):this.models.forEach(function(e){e.id==i.getModel().id&&e.updateNodeMatrix(t,r)})},e.updateBvh=function(){if(this.activeModel)return this.activeModel.updateBvh()},e.calculateNodeWorldMatrix=function(e){if(this.activeModel)return this.activeModel.calculateNodeWorldMatrix(e)},e.intersectPolytope=function(t){var r=[];return this.models.forEach(function(e){e=e.intersectPolytope(t);e&&0<e.length&&(r=r.concat(e))}),r},e.intersect=function(r,i,n){var a=[],o=this;return this.models.forEach(function(e){if(e.isSketchModel)return!0;var t=e.intersect(r,i,n);t&&0<t.length&&(n?a=a.concat(t):0==a.length?(a=a.concat(t),o.activeModel=e):a[0].distance>t[0].distance&&(a[0]=t[0],o.activeModel=e))}),a},e.intersectReferenceEntity=function(e,t){if(this.activeModel)return this.activeModel.intersectReferenceEntity(e,t)},e.setExplodeFactor=function(t,r){this.models.forEach(function(e){if(e.isSketchModel)return!0;e.setExplodeFactor(t,r)})},e.getExplodeTranslate=function(e,t){if(this.getActiveModel())return this.getActiveModel().getExplodeTranslate(e,t)},e.getBodyTranslate=function(a){var o=[];return this.models.forEach(function(e){if(e.isSketchModel)return!0;if(e.rootBodyNode&&e.rootBodyNode.uuid==a.getModel().rootBodyNode.uuid){for(var t=new THREE.Vector3(0,0,0),r=He.getExtensionWithFlags(H.FLAG_ENABLE_NODE_TRANSFORM),i=0,n=r.length;i<n;++i)t.add(r[i].getBodyNodeTranslate(a));o=[t.x,t.y,t.z]}}),o},e.getBodyTranslateWithoutExplode=function(e){if(this.getActiveModel())return this.getActiveModel().getBodyTranslateWithoutExplode(e)},e.getBodyTransform=function(e){if(this.activeModel)return this.activeModel.getBodyTransform(e)},e.getLeafBodyBoundingBox=function(e){if(this.activeModel)return this.activeModel.getLeafBodyBoundingBox(e)},e.calculateMeshBodyBoundingBox=function(e){if(this.activeModel)return this.activeModel.calculateMeshBodyBoundingBox(e)},e.getBodyBoundingBox=function(t,r){var i=new THREE.Box3,n=this;return"parentNode"==t.type?t.children.forEach(function(e){i.union(n.getBodyBoundingBox(e,r))}):this.models.forEach(function(e){if(e.isSketchModel)return!0;e.rootBodyNode&&e.rootBodyNode.uuid==t.getModel().rootBodyNode.uuid&&(t.__setBoundingBoxDirty__(),i=e.getBodyBoundingBox(t,null,r))}),i},e.getVisibleBodyBoundingBox=function(t,r){var i=new THREE.Box3,n=this;return r&&!t.visible||("parentNode"==t.type?t.children.forEach(function(e){r?e.visible&&i.union(n.getVisibleBodyBoundingBox(e)):i.union(n.getBodyBoundingBox(e))}):this.models.forEach(function(e){if(e.isSketchModel)return!0;e.rootBodyNode.uuid==t.getModel().rootBodyNode.uuid&&(r?child.visible&&(i=e.getVisibleBodyBoundingBox(t,r)):i=e.getBodyBoundingBox(t,r))})),i},e.getTotalBodyBoundingBox=function(t,r){return t=t||new THREE.Box3,this.models.forEach(function(e){if(e.isSketchModel)return!0;e.state>=ee.StateType.RENDERING_PREPARED&&e.rootBodyNode&&(e.getBodyBoundingBox(e.rootBodyNode,Zt,r),t.union(Zt))}),t},e.RemoveElement=function(e,t){if(this.activeModel)return this.activeModel.RemoveElement(e,t)},e.hasDraggedBodies=function(){var t=!1;return this.models.forEach(function(e){e.hasDraggedBodies()&&(t=!0)}),t},e.dragBody=function(t,r,i){void 0===i&&(i=null),this.models.forEach(function(e){e.id==t.getModel().id&&e.dragBody(t,r,i)})},e.restoreDraggedBody=function(t){this.models.forEach(function(e){e.rootBodyNode.uuid==t.getModel().rootBodyNode.uuid&&e.restoreDraggedBody(t)})},e.changeBodyColor=function(t,r,i){this.models.forEach(function(e){e.id===t.getModel().id&&e.changeBodyColor(t,r,i)})},e.hasTransparentBodies=function(){var t=!1;return this.models.forEach(function(e){e.hasTransparentBodies()&&(t=!0)}),t},e.transparentBody=function(t,r,i){var n=this;"parentNode"==t.type?t.children.forEach(function(e){n.transparentBody(e,r,i)}):this.models.forEach(function(e){e.rootBodyNode.uuid==t.getModel().rootBodyNode.uuid&&e.transparentBody(t,r,i)})},e.opaqueBody=function(t){var r=this;"parentNode"==t.type?t.children.forEach(function(e){r.opaqueBody(e)}):this.models.forEach(function(e){e.rootBodyNode.uuid==t.getModel().rootBodyNode.uuid&&e.opaqueBody(t)})},e.transparentizeBodies=function(n){var t=this;1==n.length&&"parentNode"==n[0].type?body.children.forEach(function(e){t.transparentizeBodies([e])}):this.models.forEach(function(e){for(var t=[],r=0;r<n.length;r++){var i=n[r];e.rootBodyNode.uuid==i.getModel().rootBodyNode.uuid&&t.push(i)}e.transparentizeBodies(t)})},e.transparentizeBodiesOnly=function(n,a){var t=this;1==n.length&&"parentNode"==n[0].type?n[0].children.forEach(function(e){t.transparentizeBodiesOnly([e],a)}):this.models.forEach(function(e){for(var t=[],r=0;r<n.length;r++){var i=n[r];e.rootBodyNode.uuid==i.getModel().rootBodyNode.uuid&&t.push(i)}0<t.length&&e.transparentizeBodiesOnly(t,a)})},e.getTransparentizedBodies=function(){var t=[];return this.models.forEach(function(e){e=e.getTransparentizedBodies();e&&0<e.length&&(t=t.concat(e))}),t},e.getAllTransparentBodies=function(t){var r=[];return this.models.forEach(function(e){e=e.getAllTransparentBodies(t);e&&0<e.length&&(r=r.concat(e))}),r},e.inIsolate=function(){var t=!1;return this.models.forEach(function(e){e.hasTransparentBodies()&&(t=!0)}),t},e.exitIsolate=function(){this.models.forEach(function(e){e.exitIsolate()})},e.isolateBodiesOnly=function(n){var t=this;1==n.length&&"parentNode"==n[0].type?n[0].children.forEach(function(e){t.isolateBodiesOnly([e])}):this.models.forEach(function(e){for(var t=[],r=0;r<n.length;r++){var i=n[r];i.ndsModel.id===e.id&&e.rootBodyNode.uuid==i.getModel().rootBodyNode.uuid&&t.push(i)}0<t.length&&e.isolateBodiesOnly(t)})},e.isolateBodyOnly=function(t){var r=this;"parentNode"==t.type?t.children.forEach(function(e){r.isolateBodyOnly(e)}):this.models.forEach(function(e){t.ndsModel.id===e.id&&e.rootBodyNode.uuid==t.getModel().rootBodyNode.uuid&&e.isolateBodyOnly(t)})},e.isolateBodies=function(n,a,o){var t=this;1==n.length&&"parentNode"==n[0].type?body.children.forEach(function(e){t.isolateBodies([e],a,o)}):this.models.forEach(function(e){if(e.isSketchModel)return!0;for(var t=[],r=0;r<n.length;r++){var i=n[r];i.ndsModel.id===e.id&&e.rootBodyNode.uuid==i.getModel().rootBodyNode.uuid&&t.push(i)}e.isolateBodies(t,a,o)})},e.hideBody=function(t){var e,r=this;"parentNode"==t.type?t.children.forEach(function(e){r.hideBody(e)}):(this.models.forEach(function(e){t.ndsModel.id===e.id&&e.rootBodyNode.uuid==t.getModel().rootBodyNode.uuid&&e.hideBody(t)}),(e=He.getExtension("ClipExtension"))&&e.isSectionViewEnabled()&&e.updateClipPlane())},e.showBody=function(t){var e,r=this;"parentNode"==t.type?t.children.forEach(function(e){r.showBody(e)}):(this.models.forEach(function(e){t.ndsModel.id===e.id&&e.rootBodyNode.uuid==t.getModel().rootBodyNode.uuid&&e.showBody(t)}),(e=He.getExtension("ClipExtension"))&&e.isSectionViewEnabled()&&e.updateClipPlane())},e.showBodyReversed=function(t){var r=this;"parentNode"==t.type?t.children.forEach(function(e){r.showBodyReversed(e)}):this.models.forEach(function(e){t.ndsModel.id===e.id&&e.rootBodyNode.uuid==t.getModel().rootBodyNode.uuid&&e.showBodyReversed(t)})},e.showAllBodies=function(){this.models.forEach(function(e){if(e.isSketchModel)return!0;e.showAllBodies()})},e.hideAllBodies=function(t){void 0===t&&(t=!0),this.models.forEach(function(e){if(e.isSketchModel&&e.outCall)return!(e.outCall=!1);e.hideAllBodies(t)})},e.reverseBodyVisibility=function(){this.models.forEach(function(e){e.reverseBodyVisibility()})},e.isBodyAllChildHidden=function(t){var r=!1,i=this;return"parentNode"==t.type?t.children.forEach(function(e){i.isBodyAllChildHidden(e)}):this.models.forEach(function(e){t.ndsModel.id===e.id&&e.rootBodyNode&&e.rootBodyNode.uuid==t.getModel().rootBodyNode.uuid&&(r=e.isBodyAllChildHidden(t))}),r},e.isBodyAllChildSelected=function(t){var r=!1,i=this;return"parentNode"==t.type?t.children.forEach(function(e){i.isBodyAllChildSelected(e)}):this.models.forEach(function(e){t.ndsModel.id===e.id&&e.rootBodyNode.uuid==t.getModel().rootBodyNode.uuid&&(r=e.isBodyAllChildSelected(t))}),r},e.isBodyAllChildShow=function(t){var r=!1,i=this;return"parentNode"==t.type?t.children.forEach(function(e){i.isBodyAllChildShow(e)}):this.models.forEach(function(e){t.ndsModel.id===e.id&&e.rootBodyNode.uuid==t.getModel().rootBodyNode.uuid&&(r=e.isBodyAllChildShow(t))}),r},e.isBodyOrSomeChildHidden=function(t){var r=!1,i=this;return"parentNode"==t.type?t.children.forEach(function(e){i.isBodyOrSomeChildHidden(e)&&(r=!0)}):this.models.forEach(function(e){e.rootBodyNode&&e.rootBodyNode.uuid==t.getModel().rootBodyNode.uuid&&(r=e.isBodyOrSomeChildHidden(t))}),r},e.unloadModel=function(e){if(!this.isReadOnly){this.viewer.annotationsManager&&this.viewer.annotationsManager.unloadAnnotation(this.models[e].rootBodyNode.uuid,this.models[e].id),this.viewer.controls.staticAnnotation&&this.viewer.controls.staticAnnotation.unloadAnnotation(this.models[e].id);var t=He.getExtension("MeasureExtension");if(t){var r=this.models[e].id,i=t.getMeasureListContent();if(i)for(var n=0;n<i.length;n++){var a=i[n];if(a.measureContent.ndsModelid1==r||a.measureContent.ndsModelid2==r){var o=a.measureList;if(o)for(var s=0;s<o.length;++s){var l=o[s];this.viewer.dispatchEvent({type:"measureDelete",uuid:a.measureId,radiusType:l.radiusType}),t.deleteMeasureInfo(a.measureId,l.radiusType)}}}}this.activeModel.id===this.models[e].id&&(this.activeModel=null);for(var d=this.__grouped_modelset.get(this.models[e].typeName),c=0,h=d.models.length;c<h;++c)if(d.models[c].id===this.models[e].id){d.models.splice(c,1);break}this.models[e].dispose(),this.models.splice(e,1),0<this.models.length&&!this.activeModel&&(this.activeModel=this.models[0]),0===this.models.length&&(this.viewer.annotationsManager&&this.viewer.annotationsManager.removeAllAnnotations(),this.viewer.controls.staticAnnotation&&this.viewer.controls.staticAnnotation.clearAnnotation(),t)&&t.OpMeasureRelease(),this.viewer.dispatchEvent({type:"UnloadModel",userData:{Number:this.models.length}})}},e.getAllNoSketchModel=function(){var t=[];return this.models.forEach(function(e){e.isSketchModel||t.push(e)}),t},e.unloadModelById=function(e){if(!this.isReadOnly)for(var t=0;t<this.models.length;++t)if(this.models[t].id===e)return void this.unloadModel(t)},e.getSelectedBodies=function(){var t=[];return this.models.forEach(function(e){e=e.getSelectedBodies();e&&0<e.length&&(t=t.concat(e))}),t},e.clearSelection=function(){this.models.forEach(function(e){e.clearSelection()})},e.addSelection=function(t){var r=this;"parentNode"==t.type?t.children.forEach(function(e){r.addSelection(e)}):this.models.forEach(function(e){t.ndsModel.id===e.id&&e.rootBodyNode.uuid==t.getModel().rootBodyNode.uuid&&e.addSelection(t)})},e.selectPMIObject=function(e,t){if(this.activeModel)return De.enableBroadcast&&De.broadcastMajor&&He.updateBroadcastInfo("PMIState"),this.activeModel.selectPMIObject(e,t)},e.deselectPMIObject=function(e,t){if(void 0===t&&(t=!0),this.activeModel)return De.enableBroadcast&&De.broadcastMajor&&He.updateBroadcastInfo("PMIState"),this.activeModel.deselectPMIObject(e,t)},e.removeSelection=function(t){var r=this;"parentNode"==t.type?t.children.forEach(function(e){r.removeSelection(e)}):this.models.forEach(function(e){t.ndsModel.id===e.id&&e.rootBodyNode.uuid==t.getModel().rootBodyNode.uuid&&e.removeSelection(t)})},e.preSelectObject=function(e){if(this.activeModel)return this.activeModel.preSelectObject(e)},e.clearPreSelection=function(){if(this.activeModel)return this.activeModel.clearPreSelection()},e.sortBodies=function(e){if(this.activeModel)return this.activeModel.sortBodies(e)},e.sortBodiesByVolume=function(e){if(this.activeModel)return this.activeModel.sortBodiesByVolume(e)},e.getGeometriesCount=function(){if(this.activeModel)return this.activeModel.getGeometriesCount()},e.getStaticGeometriesCount=function(){if(this.staticModel)return this.staticModel.getGeometriesCount()},e.updateBodyMeshIds=function(){if(this.activeModel)return this.activeModel.updateBodyMeshIds()},e.delete=function(e){if(this.activeModel)return this.activeModel.delete(e)},e.addReferenceEntity=function(e){if(this.activeModel)return this.activeModel.addReferenceEntity(e)},e.addReferenceEntities=function(e){if(this.activeModel)return this.activeModel.addReferenceEntities(e)},e.sortMeshSets=function(e,t){if(this.activeModel)return this.activeModel.sortMeshSets(e,t)},e.backupDirty=function(){this.models.forEach(function(e){e.backupDirty()})},e.resetDirty=function(){this.models.forEach(function(e){e.resetDirty()})},e.dispose=function(){this.models.forEach(function(e){e.dispose()})},e.setActiveModelByModelId=function(e){for(var t=0;t<this.models.length;++t)this.models[t].id==e&&(this.activeModel=this.models[t])},i}();function tr(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,function(e){e=function(e,t){if("object"!=typeof e||!e)return e;var r=e[Symbol.toPrimitive];if(void 0===r)return("string"===t?String:Number)(e);r=r.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}(e,"string");return"symbol"==typeof e?e:e+""}(i.key),i)}}function rr(e,t){return(rr=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}Object.defineProperties(er.prototype,{id:{get:function(){return this.activeModel?this.activeModel.id:-1}},needsFastRendering:{get:function(){return this.__needsFastRendering},set:function(i){this.__needsFastRendering=i,this.models.forEach(function(e){e.needsFastRendering=i}),this.isReadOnly||this.__grouped_modelset.forEach(function(e,t,r){e.__needsFastRendering=i})}},leafNodeCount:{get:function(){return this.activeModel?this.activeModel.leafNodeCount:0},set:function(e){this.activeModel&&(this.activeModel.leafNodeCount=e)}},sptIndex:{get:function(){return this.activeModel?this.activeModel.sptIndex:null},set:function(e){this.activeModel&&(this.activeModel.sptIndex=e)}},drawMode:{get:function(){return this.activeModel?this.activeModel.drawMode:0},set:function(e){this.activeModel&&(this.activeModel.drawMode=e)}},renderOnce:{get:function(){return!!this.activeModel&&this.activeModel.renderOnce},set:function(e){this.activeModel&&(this.activeModel.renderOnce=e)}},renderMeshSetCount:{get:function(){return this.activeModel?this.activeModel.renderMeshSetCount:0},set:function(e){this.activeModel&&(this.activeModel.renderMeshSetCount=e)}},spriteDirty:{get:function(){return!!this.activeModel&&this.activeModel.spriteDirty},set:function(e){this.activeModel&&(this.activeModel.spriteDirty=e)}},rootBodyNode:{get:function(){return this.activeModel?this.activeModel.rootBodyNode:null},set:function(e){this.activeModel&&(this.activeModel.rootBodyNode=e)}},is2DModel:{get:function(){return!!this.activeModel&&this.activeModel.is2DModel},set:function(e){this.activeModel&&(this.activeModel.is2DModel=e)}},hasRawMesh:{get:function(){return!!this.activeModel&&this.activeModel.hasRawMesh},set:function(e){this.activeModel&&(this.activeModel.hasRawMesh=e)}},bvhCreater:{get:function(){return this.activeModel?this.activeModel.bvhCreater:null},set:function(e){this.activeModel&&(this.activeModel.bvhCreater=e)}},transparentBodiesDirty:{get:function(){return!!this.activeModel&&this.activeModel.transparentBodiesDirty},set:function(e){this.activeModel&&(this.activeModel.transparentBodiesDirty=e)}},transparentBodyChanged:{get:function(){return!!this.activeModel&&this.activeModel.transparentBodyChanged},set:function(e){this.activeModel&&(this.activeModel.transparentBodyChanged=e)}},selectedBodiesDirty:{get:function(){return!!this.activeModel&&this.activeModel.selectedBodiesDirty},set:function(e){this.activeModel&&(this.activeModel.selectedBodiesDirty=e)}},preselectedObject:{get:function(){return this.activeModel?this.activeModel.preselectedObject:null},set:function(e){this.activeModel&&(this.activeModel.preselectedObject=e)}},modelUri:{get:function(){return this.activeModel?this.activeModel.modelUri:null},set:function(e){this.activeModel&&(this.activeModel.modelUri=e)}},referenceEntityDirty:{get:function(){return this.activeModel?this.activeModel.referenceEntityDirty:null},set:function(e){this.activeModel&&(this.activeModel.referenceEntityDirty=e)}},hasHiddenBodies:{get:function(){return this.activeModel?this.activeModel.hasHiddenBodies:null},set:function(e){this.activeModel&&(this.activeModel.hasHiddenBodies=e)}},explodeFactor:{get:function(){return this.getActiveModel().explodeFactor},set:function(t){this.models.forEach(function(e){if(e.isSketchModel)return!0;e.explodeFactor=t})}},explodeFactorX:{get:function(){return this.getActiveModel().explodeFactorX},set:function(t){this.models.forEach(function(e){if(e.isSketchModel)return!0;e.explodeFactorX=t})}},explodeFactorY:{get:function(){return this.getActiveModel().explodeFactorY},set:function(t){this.models.forEach(function(e){if(e.isSketchModel)return!0;e.explodeFactorY=t})}},explodeFactorZ:{get:function(){return this.getActiveModel().explodeFactorZ},set:function(t){this.models.forEach(function(e){if(e.isSketchModel)return!0;e.explodeFactorZ=t})}},meshManager:{get:function(){return this.activeModel?this.activeModel.meshManager:null},set:function(e){this.activeModel&&(this.activeModel.meshManager=e)}},explodeMode:{get:function(){return this.getActiveModel().explodeMode},set:function(t){this.models.forEach(function(e){if(e.isSketchModel)return!0;e.explodeMode=t})}},bodyUuid2NodeMap:{get:function(){return this.getActiveModel().bodyUuid2NodeMap},set:function(t){this.models.forEach(function(e){if(e.isSketchModel)return!0;e.bodyUuid2NodeMap=t})}},bodyUuid2ClonedNodeMap:{get:function(){return this.getActiveModel().bodyUuid2ClonedNodeMap},set:function(e){this.getActiveModel().bodyUuid2ClonedNodeMap=e}},explodeLevel:{get:function(){return this.getActiveModel().explodeLevel},set:function(t){this.models.forEach(function(e){if(e.isSketchModel)return!0;e.explodeLevel=t})}},explodeObject:{get:function(){return this.getActiveModel().explodeObject},set:function(t){this.models.forEach(function(e){if(e.isSketchModel)return!0;e.explodeObject=t})}},wholeLeafBodyNodes:{get:function(){return this.activeModel?this.activeModel.wholeLeafBodyNodes:null},set:function(e){this.activeModel&&(this.activeModel.wholeLeafBodyNodes=e)}},geomManager:{get:function(){return this.activeModel?this.activeModel.geomManager:null},set:function(e){this.activeModel&&(this.activeModel.geomManager=e)}},pureLineBody:{get:function(){return this.activeModel?this.activeModel.pureLineBody:null},set:function(e){this.activeModel&&(this.activeModel.pureLineBody=e)}},ModelUpMatrix4:{get:function(){return this.activeModel?this.activeModel.ModelUpMatrix4:null},set:function(e){this.activeModel&&(this.activeModel.ModelUpMatrix4=e)}},hideBodies:{get:function(){var t=[];return this.models.forEach(function(e){t=t.concat(e.hideBodies)}),t}},UnloadNodes:{get:function(){var t=[];return this.models.forEach(function(e){t=t.concat(e.UnloadNodes)}),t}},forceRenderAll:{get:function(){return this.__forceRenderAll},set:function(i){this.__forceRenderAll=i,this.models.forEach(function(e){e.forceRenderAll=i}),this.isReadOnly||this.__grouped_modelset.forEach(function(e,t,r){e.__forceRenderAll=i})}},lineTypes:{get:function(){return this.activeModel?this.activeModel.lineTypes:null}}}),THREE.UniformsLib.NdsBatchedPhong={bodyWorldMatrixOffset:{value:0},meshId:{value:new THREE.Vector2},meshId2BodyIdParam:{value:new THREE.Vector2},meshId2BodyIdMap:{value:null},bodyNodeWorldMatrixMap:{value:null},bodyNodeWorldMatrixMapSize:{value:1},globalMtlMap:{value:null},globalMtlMapSize:{value:1},meshMtlParam:{value:new THREE.Vector2},meshMtlMap:{value:null}},THREE.ShaderLib.NdsBatchedPhong={uniforms:THREE.UniformsUtils.merge([{map:{value:null},mapTransform:{value:new THREE.Matrix3},alphaMap:{value:null},alphaMapTransform:{value:new THREE.Matrix3},alphaTest:{value:0}},THREE.UniformsLib.specularmap,THREE.UniformsLib.envmap,THREE.UniformsLib.aomap,THREE.UniformsLib.lightmap,THREE.UniformsLib.emissivemap,THREE.UniformsLib.bumpmap,THREE.UniformsLib.normalmap,THREE.UniformsLib.displacementmap,THREE.UniformsLib.fog,THREE.UniformsLib.lights,THREE.UniformsLib.NdsBatchedPhong]),vertexShader:"\n    #define PHONG\n\n  #ifdef BATCHED_MESH\n    int meshId = 0;\n    int color_opacity = 0;\n  #else\n  #ifdef INSTANCE_MESH\n    attribute int meshId;\n  #else\n    uniform ivec2 meshId;\n  #endif\n  #endif\n    //\n    varying vec3 vViewPosition;\n    \n    #include <common>\n    #include <uv_pars_vertex>\n    #include <displacementmap_pars_vertex>\n    #include <envmap_pars_vertex>\n    #include <color_pars_vertex>\n    #include <fog_pars_vertex>\n    #include <normal_pars_vertex>\n    #include <morphtarget_pars_vertex>\n    #include <skinning_pars_vertex>\n    #include <shadowmap_pars_vertex>\n    #include <logdepthbuf_pars_vertex>\n    #include <clipping_planes_pars_vertex>\n    #include <mesh_modelMatrix_map_vertex>\n    \n    void main() {\n    \n        mat4 modelViewMatrix = viewMatrix * getModelMatrix();\n        mat3 normalMatrix = mat3(modelViewMatrix);  \n        \n        #include <uv_vertex>\n        #include <color_vertex>\n        #include <morphcolor_vertex>\n    \n        #include <beginnormal_vertex>\n        #include <morphnormal_vertex>\n        #include <skinbase_vertex>\n        #include <skinnormal_vertex>\n        //#include <defaultnormal_vertex>\n        vec3 transformedNormal = objectNormal;\n        transformedNormal = normalMatrix * transformedNormal;\n        #include <normal_vertex>\n    \n        #include <begin_vertex>\n        #include <morphtarget_vertex>\n        #include <skinning_vertex>\n        #include <displacementmap_vertex>\n        //#include <project_vertex>\n        \n        vec4 mvPosition = vec4( transformed, 1.0 );\n        mvPosition = modelViewMatrix * mvPosition;\n        gl_Position = projectionMatrix * mvPosition;\n        \n        #include <logdepthbuf_vertex>\n        #include <clipping_planes_vertex>\n    \n        vViewPosition = - mvPosition.xyz;\n    \n        #include <worldpos_vertex>\n        #include <envmap_vertex>\n        #include <shadowmap_vertex>\n        #include <fog_vertex>\n        \n        #ifdef BATCHED_MESH\n           _mesh_id_ = float(meshId);\n           ivec2 meshColorOpacity = getMtlColorOpacity(color_opacity);\n          _color_ = float(meshColorOpacity.x);\n          _opacity_ = float(meshColorOpacity.y);\n        #else\n        #ifdef INSTANCE_MESH\n           _mesh_id_ = float(meshId);\n           _color_ = -1.0;\n        #else\n           _mesh_id_ = float(meshId.x);\n           ivec2 meshColorOpacity = getMtlColorOpacity(meshId.y);\n          _color_ = float(meshColorOpacity.x);\n          _opacity_ = float(meshColorOpacity.y);\n        #endif\n        #endif\n    }\n    ",fragmentShader:"\n    #define PHONG\n    \n    #include <common>\n    #include <packing>\n    #include <mesh_mtl_map_fragment>\n    #include <dithering_pars_fragment>\n    #include <color_pars_fragment>\n    #include <uv_pars_fragment>\n    #include <map_pars_fragment>\n    #include <alphamap_pars_fragment>\n    #include <alphatest_pars_fragment>\n    #include <aomap_pars_fragment>\n    #include <lightmap_pars_fragment>\n    #include <emissivemap_pars_fragment>\n    #include <envmap_common_pars_fragment>\n    #include <envmap_pars_fragment>\n    #include <fog_pars_fragment>\n    #include <bsdfs>\n    #include <lights_pars_begin>\n    #include <normal_pars_fragment>\n    #include <lights_phong_pars_fragment>\n    #include <shadowmap_pars_fragment>\n    #include <bumpmap_pars_fragment>\n    #include <normalmap_pars_fragment>\n    #include <specularmap_pars_fragment>\n    #include <logdepthbuf_pars_fragment>\n    #include <clipping_planes_pars_fragment>\n\n    void main() {\n        mesh_id = int(_mesh_id_ + 0.1);\n        mesh_color = int(_color_);\n        mesh_opacity = int(_opacity_);\n        //\n        ivec4 meshMtl = getMeshMtl();\n        ivec2 faceMtl = mesh_color >= 0 ? ivec2(mesh_color, mesh_opacity) : ivec2(0,0);\n        int globalMtlIndex = meshMtl.x;\n        //\n        int color_hex = mesh_color < 0 ? meshMtl.y : faceMtl.x;\n        vec3 diffuse = getColorFromHex(color_hex);\n        float opacity = mesh_color < 0 ? float(meshMtl.z)/1000.0 : float(faceMtl.y)/15.0;\n        //\n        // Global material property\n        #ifdef SUPPORT_GLOBAL_MTL_BLOCK\n            int specular_hex = globalMtl[globalMtlIndex].x;\n            vec3 specular = getColorFromHex(specular_hex);\n            //\n            //当globalMtl[globalMtlIndex].y cpu端设置为0时可能会引发计算的D_BlinnPhone 为负值。\n            //给shininess 加一很小的值0.001 可以解决这个问题\n            float shininess = float(globalMtl[globalMtlIndex].y) + 0.001;\n            //\n            int emissive_hex = globalMtl[globalMtlIndex].z;\n            vec3 emissive = getColorFromHex(emissive_hex);\n            float emissiveIntensity = float(globalMtl[globalMtlIndex].w) / 1000.0;\n        #else\n            int globalMtlX = (globalMtlIndex * 4) % globalMtlMapSize;\n            int globalMtlY = (globalMtlIndex * 4) / globalMtlMapSize;\n            ivec4 globalProperty = ivec4(texelFetch( globalMtlMap, ivec2( globalMtlX, globalMtlY ), 0 ).r, \n                                        texelFetch( globalMtlMap, ivec2( globalMtlX + 1, globalMtlY ), 0 ).r, \n                                        texelFetch( globalMtlMap, ivec2( globalMtlX + 2, globalMtlY ), 0 ).r, \n                                        texelFetch( globalMtlMap, ivec2( globalMtlX + 3, globalMtlY ), 0 ).r);\n            vec3 specular = getColorFromHex(globalProperty.x);\n            float shininess = float(globalProperty.y) + 0.001;\n\n            int emissive_hex = globalProperty.z;\n            vec3 emissive = getColorFromHex(emissive_hex);\n            float emissiveIntensity = float(globalProperty.w) / 1000.0;\n        #endif\n    \n        #include <clipping_planes_fragment>\n    \n        vec4 diffuseColor = vec4( diffuse, opacity );\n        ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n        vec3 totalEmissiveRadiance = emissive * emissiveIntensity;\n    \n        #include <logdepthbuf_fragment>\n        #include <map_fragment>\n        #include <color_fragment>\n        #include <alphamap_fragment>\n        #include <alphatest_fragment>\n\n        #include <specularmap_fragment>\n        #include <normal_fragment_begin>\n        #include <normal_fragment_maps>\n        #include <emissivemap_fragment>\n    \n        // accumulation\n        #include <lights_phong_fragment>\n        #include <lights_fragment_begin>\n        #include <lights_fragment_maps>\n        #include <lights_fragment_end>\n    \n        // modulation\n        #include <aomap_fragment>\n    \n        vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\n    \n        #include <envmap_fragment>\n        #include <output_fragment>\n        #include <tonemapping_fragment>\n        #include <encodings_fragment>\n        #include <fog_fragment>\n        #include <premultiplied_alpha_fragment>\n        #include <dithering_fragment>\n \n    }\n    "};var I=function(o){function e(e,t,r,i,n){var a;return void 0===t&&(t=!1),void 0===r&&(r=!1),void 0===i&&(i=!0),void 0===n&&(n=!0),(a=o.call(this,{type:"NdsBatchedPhongMaterial",uniforms:THREE.UniformsUtils.clone(THREE.ShaderLib.NdsBatchedPhong.uniforms),vertexShader:THREE.ShaderLib.NdsBatchedPhong.vertexShader,fragmentShader:THREE.ShaderLib.NdsBatchedPhong.fragmentShader,clipping:!0})||this).isNdsBatchedPhongMaterial=!0,a.lights=!0,a.map=null,a.alphaMap=null,a.emissivemap=null,a.specularmap=null,a.normalMap=null,a.flatShading=!1,t&&(a.defines={INSTANCE_MESH:""}),r&&(a.defines={BATCHED_MESH:""},a.extensions={multiDraw:!0}),i&&(a.defines.SUPPORT_UNIFORM_BLOCK=""),n&&(a.defines.SUPPORT_GLOBAL_MTL_BLOCK=""),a.setValues(e),a}var t,r,i;return r=o,(t=e).prototype=Object.create(r.prototype),rr(t.prototype.constructor=t,r),t=e,(r=[{key:"needsLightsUpdate",set:function(e){this.uniforms.ambientLightColor.needsUpdate=e,this.uniforms.lightProbe.needsUpdate=e,this.uniforms.directionalLights.needsUpdate=e,this.uniforms.hemisphereLights.needsUpdate=e}}])&&tr(t.prototype,r),i&&tr(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}(THREE.ShaderMaterial);function ir(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,function(e){e=function(e,t){if("object"!=typeof e||!e)return e;var r=e[Symbol.toPrimitive];if(void 0===r)return("string"===t?String:Number)(e);r=r.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}(e,"string");return"symbol"==typeof e?e:e+""}(i.key),i)}}function nr(e,t){return(nr=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}THREE.UniformsLib.NdsBatchedPhysical={bodyWorldMatrixOffset:{value:0},meshId:{value:new THREE.Vector2},meshId2BodyIdParam:{value:new THREE.Vector2},meshId2BodyIdMap:{value:null},bodyNodeWorldMatrixMap:{value:null},bodyNodeWorldMatrixMapSize:{value:1},globalMtlMap:{value:null},globalMtlMapSize:{value:1},meshMtlParam:{value:new THREE.Vector2},meshMtlMap:{value:null}},THREE.ShaderLib.NdsBatchedPhysical={uniforms:THREE.UniformsUtils.merge([THREE.ShaderLib.standard.uniforms,{clearcoat:{value:0},clearcoatMap:{value:null},clearcoatMapTransform:{value:new THREE.Matrix3},clearcoatNormalMap:{value:null},clearcoatNormalMapTransform:{value:new THREE.Matrix3},clearcoatNormalScale:{value:new THREE.Vector2(1,1)},clearcoatRoughness:{value:0},clearcoatRoughnessMap:{value:null},clearcoatRoughnessMapTransform:{value:new THREE.Matrix3},iridescence:{value:0},iridescenceMap:{value:null},iridescenceMapTransform:{value:new THREE.Matrix3},iridescenceIOR:{value:1.3},iridescenceThicknessMinimum:{value:100},iridescenceThicknessMaximum:{value:400},iridescenceThicknessMap:{value:null},iridescenceThicknessMapTransform:{value:new THREE.Matrix3},sheen:{value:0},sheenColor:{value:new THREE.Color(0)},sheenColorMap:{value:null},sheenColorMapTransform:{value:new THREE.Matrix3},sheenRoughness:{value:1},sheenRoughnessMap:{value:null},sheenRoughnessMapTransform:{value:new THREE.Matrix3},transmission:{value:0},transmissionMap:{value:null},transmissionMapTransform:{value:new THREE.Matrix3},transmissionSamplerSize:{value:new THREE.Vector2},transmissionSamplerMap:{value:null},thickness:{value:0},thicknessMap:{value:null},thicknessMapTransform:{value:new THREE.Matrix3},attenuationDistance:{value:0},attenuationColor:{value:new THREE.Color(0)},specularColor:{value:new THREE.Color(1,1,1)},specularColorMap:{value:null},specularColorMapTransform:{value:new THREE.Matrix3},specularIntensity:{value:1},specularIntensityMap:{value:null},specularIntensityMapTransform:{value:new THREE.Matrix3},anisotropyVector:{value:new THREE.Vector2},anisotropyMap:{value:null},anisotropyMapTransform:{value:new THREE.Matrix3},map:{value:null},mapTransform:{value:new THREE.Matrix3},alphaMap:{value:null},alphaMapTransform:{value:new THREE.Matrix3},alphaTest:{value:0}},THREE.UniformsLib.NdsBatchedPhysical]),vertexShader:"\n    #define STANDARD\n\n    varying vec3 vViewPosition;\n\n    #ifdef USE_TRANSMISSION\n\n        varying vec3 vWorldPosition;\n\n    #endif\n\n    #ifdef BATCHED_MESH\n        int meshId = 0;\n        int color_opacity = 0;\n    #else\n    #ifdef INSTANCE_MESH\n        attribute int meshId;\n    #else\n        uniform ivec2 meshId;\n    #endif\n    #endif\n\n    #include <common>\n    #include <uv_pars_vertex>\n    #include <displacementmap_pars_vertex>\n    #include <color_pars_vertex>\n    #include <fog_pars_vertex>\n    #include <normal_pars_vertex>\n    #include <morphtarget_pars_vertex>\n    #include <skinning_pars_vertex>\n    #include <shadowmap_pars_vertex>\n    #include <logdepthbuf_pars_vertex>\n    #include <clipping_planes_pars_vertex>\n    #include <mesh_modelMatrix_map_vertex>\n\n    void main() {\n        //\n        mat4 modelViewMatrix = viewMatrix * getModelMatrix();\n        mat3 normalMatrix = mat3(modelViewMatrix);\n\n        #include <uv_vertex>\n        #include <color_vertex>\n        #include <morphcolor_vertex>\n\n        #include <beginnormal_vertex>\n        #include <morphnormal_vertex>\n        #include <skinbase_vertex>\n        #include <skinnormal_vertex>\n        // #include <defaultnormal_vertex>\n        vec3 transformedNormal = objectNormal;\n        transformedNormal = normalMatrix * transformedNormal;\n        #include <normal_vertex>\n\n        #include <begin_vertex>\n        #include <morphtarget_vertex>\n        #include <skinning_vertex>\n        #include <displacementmap_vertex>\n        // #include <project_vertex>\n\n        vec4 mvPosition = vec4( transformed, 1.0 );\n        mvPosition = modelViewMatrix * mvPosition;\n        gl_Position = projectionMatrix * mvPosition;\n\n        #include <logdepthbuf_vertex>\n        #include <clipping_planes_vertex>\n\n        vViewPosition = - mvPosition.xyz;\n\n        #include <worldpos_vertex>\n        #include <shadowmap_vertex>\n        #include <fog_vertex>\n\n    #ifdef USE_TRANSMISSION\n\n        vWorldPosition = worldPosition.xyz;\n\n    #endif\n\n    #ifdef BATCHED_MESH\n        _mesh_id_ = float(meshId);\n        ivec2 meshColorOpacity = getMtlColorOpacity(color_opacity);\n        _color_ = float(meshColorOpacity.x);\n        _opacity_ = float(meshColorOpacity.y);\n    #else\n    #ifdef INSTANCE_MESH\n        _mesh_id_ = float(meshId);\n        _color_ = -1.0;\n    #else\n        _mesh_id_ = float(meshId.x);\n        ivec2 meshColorOpacity = getMtlColorOpacity(meshId.y);\n        _color_ = float(meshColorOpacity.x);\n        _opacity_ = float(meshColorOpacity.y);\n    #endif\n    #endif\n    }\n    ",fragmentShader:"\n    #define STANDARD\n\n    #ifdef PHYSICAL\n        #define IOR\n        #define USE_SPECULAR\n    #endif\n\n    uniform vec3 diffuse;\n    uniform vec3 emissive;\n    uniform float roughness;\n    uniform float metalness;\n    uniform float opacity;\n\n    #ifdef IOR\n        uniform float ior;\n    #endif\n\n    #ifdef USE_SPECULAR\n        uniform float specularIntensity;\n        uniform vec3 specularColor;\n\n        #ifdef USE_SPECULAR_COLORMAP\n            uniform sampler2D specularColorMap;\n        #endif\n\n        #ifdef USE_SPECULAR_INTENSITYMAP\n            uniform sampler2D specularIntensityMap;\n        #endif\n    #endif\n\n    #ifdef USE_CLEARCOAT\n        uniform float clearcoat;\n        uniform float clearcoatRoughness;\n    #endif\n\n    #ifdef USE_IRIDESCENCE\n        uniform float iridescence;\n        uniform float iridescenceIOR;\n        uniform float iridescenceThicknessMinimum;\n        uniform float iridescenceThicknessMaximum;\n    #endif\n\n    #ifdef USE_SHEEN\n        uniform vec3 sheenColor;\n        uniform float sheenRoughness;\n\n        #ifdef USE_SHEEN_COLORMAP\n            uniform sampler2D sheenColorMap;\n        #endif\n\n        #ifdef USE_SHEEN_ROUGHNESSMAP\n            uniform sampler2D sheenRoughnessMap;\n        #endif\n    #endif\n\n    #ifdef USE_ANISOTROPY\n        uniform vec2 anisotropyVector;\n\n        #ifdef USE_ANISOTROPYMAP\n            uniform sampler2D anisotropyMap;\n        #endif\n    #endif\n\n    varying vec3 vViewPosition;\n\n    #include <common>\n    #include <packing>\n    #include <mesh_mtl_map_fragment>\n    #include <mesh_physical_mtl_ext_map_fragment>\n    #include <dithering_pars_fragment>\n    #include <color_pars_fragment>\n    #include <uv_pars_fragment>\n    #include <map_pars_fragment>\n    #include <alphamap_pars_fragment>\n    #include <alphatest_pars_fragment>\n    #include <aomap_pars_fragment>\n    #include <lightmap_pars_fragment>\n    #include <emissivemap_pars_fragment>\n    #include <iridescence_fragment>\n    #include <cube_uv_reflection_fragment>\n    #include <envmap_common_pars_fragment>\n    #include <envmap_physical_pars_fragment>\n    #include <fog_pars_fragment>\n    #include <lights_pars_begin>\n    #include <normal_pars_fragment>\n    #include <lights_physical_pars_fragment>\n    #include <transmission_pars_fragment>\n    #include <shadowmap_pars_fragment>\n    #include <bumpmap_pars_fragment>\n    #include <normalmap_pars_fragment>\n    #include <clearcoat_pars_fragment>\n    #include <iridescence_pars_fragment>\n    #include <roughnessmap_pars_fragment>\n    #include <metalnessmap_pars_fragment>\n    #include <logdepthbuf_pars_fragment>\n    #include <clipping_planes_pars_fragment>\n\n    void main() {\n        mesh_id = int(_mesh_id_ + 0.1);\n        mesh_color = int(_color_);\n        mesh_opacity = int(_opacity_);\n        //\n        ivec4 meshMtl = getMeshMtl();\n        ivec2 faceMtl = mesh_color >= 0 ? ivec2(mesh_color, mesh_opacity) : ivec2(0,0);\n        int globalMtlIndex = meshMtl.x;\n        //\n        int color_hex = mesh_color < 0 ? meshMtl.y : faceMtl.x;\n        vec3 diffuse = getColorFromHex(color_hex);\n\n        // 可变属性\n        // opacity | metalness | roughness | reflectivity\n        ivec4 encodedProperty = getFourChannelProperty(meshMtl.z);\n        float opacity = mesh_color < 0 ? float(encodedProperty.x) / 255.0 : float(faceMtl.y)/15.0;\n        float metalness = float(encodedProperty.y) / 255.0;\n        float roughness = float(encodedProperty.z) / 15.0;\n        // float reflectivity = float(encodedProperty.w) / 15.0; // Not used. Given reflectivity only affects ior. Relies on ior directly.\n        // float ior = ( 1.0 + 0.4 * reflectivity ) / ( 1.0 - 0.4 * reflectivity );\n\n        // clearCoat | iridescence | clearCoatRoughness | iridesceneIOR\n        encodedProperty = getFourChannelProperty(meshMtl.w);\n        float clearcoat = float(encodedProperty.x) / 255.0;\n        float iridescence = float(encodedProperty.y) / 255.0;;\n        float clearcoatRoughness = float(encodedProperty.z) / 15.0;\n        float iridescenceIOR = float(encodedProperty.w) / 10.0 + 1.0; // convert back to range [1.0, 2.33]\n        //\n\n        // 全局属性\n        #ifdef SUPPORT_GLOBAL_MTL_BLOCK\n            // vec3 attenuationColor = getColorFromHex( globalMtl[globalMtlIndex].z );\n            // float attenuationDistance = getEncodedFloatValue( globalMtl[globalMtlIndex].w );\n\n            vec3 specularColor = getColorFromHex( globalMtl[globalMtlIndex + 1].x );\n            float specularIntensity = getEncodedFloatValue( globalMtl[globalMtlIndex + 1].y );\n            vec3 emissive = getColorFromHex( globalMtl[globalMtlIndex + 1].z );\n            float emissiveIntensity = getEncodedFloatValue( globalMtl[globalMtlIndex + 1].w );\n\n            float ior = getEncodedFloatValue( globalMtl[globalMtlIndex + 2].y );\n            float sheen = getEncodedFloatValue( globalMtl[globalMtlIndex + 2].z );\n            vec3 sheenColor = getColorFromHex( globalMtl[globalMtlIndex + 2].w );\n\n            float sheenRoughness = getEncodedFloatValue( globalMtl[globalMtlIndex + 3].x );\n            float transmission = getEncodedFloatValue( globalMtl[globalMtlIndex + 3].y );\n        #else\n            int globalMtlX = (globalMtlIndex * 16) % globalMtlMapSize;\n            int globalMtlY = (globalMtlIndex * 16) / globalMtlMapSize;\n\n            vec3 specularColor = getColorFromHex( texelFetch( globalMtlMap, ivec2( globalMtlX + 4, globalMtlY ), 0 ).r );\n            float specularIntensity = getEncodedFloatValue( texelFetch( globalMtlMap, ivec2( globalMtlX + 5, globalMtlY ), 0 ).r );\n            vec3 emissive = getColorFromHex( texelFetch( globalMtlMap, ivec2( globalMtlX + 6, globalMtlY ), 0 ).r );\n            float emissiveIntensity = getEncodedFloatValue( texelFetch( globalMtlMap, ivec2( globalMtlX + 7, globalMtlY ), 0 ).r );\n\n            float ior = getEncodedFloatValue( texelFetch( globalMtlMap, ivec2( globalMtlX + 9, globalMtlY ), 0 ).r );\n            float sheen = getEncodedFloatValue( texelFetch( globalMtlMap, ivec2( globalMtlX + 10, globalMtlY ), 0 ).r );\n            vec3 sheenColor = getColorFromHex( texelFetch( globalMtlMap, ivec2( globalMtlX + 11, globalMtlY ), 0 ).r );\n\n            float sheenRoughness = getEncodedFloatValue( texelFetch( globalMtlMap, ivec2( globalMtlX + 12, globalMtlY ), 0 ).r );\n            float transmission = getEncodedFloatValue( texelFetch( globalMtlMap, ivec2( globalMtlX + 13, globalMtlY ), 0 ).r );\n\n        #endif\n\n        #include <clipping_planes_fragment>\n\n        vec4 diffuseColor = vec4( diffuse, opacity );\n        ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n        vec3 totalEmissiveRadiance = emissive * emissiveIntensity;\n\n        #include <logdepthbuf_fragment>\n        #include <map_fragment>\n        #include <color_fragment>\n        #include <alphamap_fragment>\n        #include <alphatest_fragment>\n        #include <roughnessmap_fragment>\n        #include <metalnessmap_fragment>\n        #include <normal_fragment_begin>\n        #include <normal_fragment_maps>\n        #include <clearcoat_normal_fragment_begin>\n        #include <clearcoat_normal_fragment_maps>\n        #include <emissivemap_fragment>\n\n        // accumulation\n        #include <lights_physical_fragment>\n        #include <lights_fragment_begin>\n        #include <lights_fragment_maps>\n        #include <lights_fragment_end>\n\n        // modulation\n        #include <aomap_fragment>\n\n        vec3 totalDiffuse = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse;\n        vec3 totalSpecular = reflectedLight.directSpecular + reflectedLight.indirectSpecular;\n\n        #include <transmission_fragment>\n\n        vec3 outgoingLight = totalDiffuse + totalSpecular + totalEmissiveRadiance;\n\n        #ifdef USE_SHEEN\n\n            // Sheen energy compensation approximation calculation can be found at the end of\n            // https://drive.google.com/file/d/1T0D1VSyR4AllqIJTQAraEIzjlb5h4FKH/view?usp=sharing\n            float sheenEnergyComp = 1.0 - 0.157 * max3( material.sheenColor );\n\n            outgoingLight = outgoingLight * sheenEnergyComp + sheenSpecular;\n\n        #endif\n\n        #ifdef USE_CLEARCOAT\n\n            float dotNVcc = saturate( dot( geometry.clearcoatNormal, geometry.viewDir ) );\n\n            vec3 Fcc = F_Schlick( material.clearcoatF0, material.clearcoatF90, dotNVcc );\n\n            outgoingLight = outgoingLight * ( 1.0 - material.clearcoat * Fcc ) + clearcoatSpecular * material.clearcoat;\n\n        #endif\n\n        #include <output_fragment>\n        #include <tonemapping_fragment>\n        #include <encodings_fragment>\n        #include <fog_fragment>\n        #include <premultiplied_alpha_fragment>\n        #include <dithering_fragment>\n\n    }\n    "};var T=function(o){function e(e,t,r,i,n){var a;return void 0===t&&(t=!1),void 0===r&&(r=!1),void 0===i&&(i=!0),void 0===n&&(n=!0),(a=o.call(this,{type:"NdsBatchedPhysicalMaterial",uniforms:THREE.UniformsUtils.clone(THREE.ShaderLib.NdsBatchedPhysical.uniforms),vertexShader:THREE.ShaderLib.NdsBatchedPhysical.vertexShader,fragmentShader:THREE.ShaderLib.NdsBatchedPhysical.fragmentShader,clipping:!0})||this).isNdsBatchedPhysicalMaterial=!0,a.isMeshStandardMaterial=!0,a.map=null,a.alphaMap=null,a.envMap=null,a.envMapIntensity=1,a.emissivemap=null,a.specularColorMap=null,a.specularIntensityMap=null,a.normalMap=null,a.normalMapType=THREE.TangentSpaceNormalMap,a.normalScale=new THREE.Vector2(1,1),a.roughnessMap=null,a.metalnessMap=null,a.flatShading=!1,a.lights=!0,t&&(a.defines={INSTANCE_MESH:"",PHYSICAL:"",USE_CLEARCOAT:""}),r&&(a.defines={BATCHED_MESH:"",PHYSICAL:"",USE_CLEARCOAT:""},a.extensions={multiDraw:!0}),a.defines.USE_TRANSMISSION="",i&&(a.defines.SUPPORT_UNIFORM_BLOCK=""),n&&(a.defines.SUPPORT_GLOBAL_MTL_BLOCK=""),a.setValues(e),a}var t,r,i;return r=o,(t=e).prototype=Object.create(r.prototype),nr(t.prototype.constructor=t,r),t=e,(r=[{key:"needsLightsUpdate",set:function(e){this.uniforms.ambientLightColor.needsUpdate=e,this.uniforms.lightProbe.needsUpdate=e,this.uniforms.directionalLights.needsUpdate=e,this.uniforms.hemisphereLights.needsUpdate=e}}])&&ir(t.prototype,r),i&&ir(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}(THREE.ShaderMaterial);function ar(e,t){return(ar=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}THREE.UniformsLib.NdsBatchedLineBasic={bodyWorldMatrixOffset:{value:0},meshId:{value:new THREE.Vector2},meshId2BodyIdParam:{value:new THREE.Vector2},meshId2BodyIdMap:{value:null},bodyNodeWorldMatrixMap:{value:null},bodyNodeWorldMatrixMapSize:{value:1},lineMtlParam:{value:new THREE.Vector2},lineMtlMap:{value:null},overrideColor:{value:new THREE.Vector4(0,0,0,-1)},opacityScale:{value:1}},THREE.ShaderLib.NdsBatchedLineBasic={uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib.common,THREE.UniformsLib.specularmap,THREE.UniformsLib.envmap,THREE.UniformsLib.aomap,THREE.UniformsLib.lightmap,THREE.UniformsLib.fog,THREE.UniformsLib.NdsBatchedLineBasic]),vertexShader:"\n  #ifdef BATCHED_MESH\n    int meshId = 0;\n    int color_opacity = 0;\n  #else\n  #ifdef INSTANCE_MESH\n    attribute int meshId;\n  #else\n    uniform ivec2 meshId;\n  #endif\n  #endif\n    //\n    #include <common>\n    #include <uv_pars_vertex>\n    #include <envmap_pars_vertex>\n    #include <color_pars_vertex>\n    #include <fog_pars_vertex>\n    #include <morphtarget_pars_vertex>\n    #include <skinning_pars_vertex>\n    #include <logdepthbuf_pars_vertex>\n    #include <clipping_planes_pars_vertex>\n    #include <mesh_modelMatrix_map_vertex>\n    \n    void main() {\n    \n        mat4 modelViewMatrix = viewMatrix * getModelMatrix();\n        \n        #include <uv_vertex>\n\t    #include <color_vertex>\n\t    #include <morphcolor_vertex>\n    \n    \n        #include <begin_vertex>\n        #include <morphtarget_vertex>\n        #include <skinning_vertex>\n        //#include <project_vertex>\n        \n        vec4 mvPosition = vec4( transformed, 1.0 );\n        mvPosition = modelViewMatrix * mvPosition;\n        gl_Position = projectionMatrix * mvPosition;\n        \n        #include <logdepthbuf_vertex>\n        #include <clipping_planes_vertex>\n    \n        #include <worldpos_vertex>\n        #include <envmap_vertex>\n        #include <fog_vertex>\n        \n        #ifdef BATCHED_MESH\n          _mesh_id_ = float(meshId);\n          ivec2 lineColorOpacity = getMtlColorOpacity(color_opacity);\n          _color_ = float(lineColorOpacity.x);\n          _opacity_ = float(lineColorOpacity.y);\n        #else\n        #ifdef INSTANCE_MESH\n          _mesh_id_ = float(meshId);\n          _color_ = -1.0;\n        #else\n          _mesh_id_ = float(meshId.x);\n          ivec2 lineColorOpacity = getMtlColorOpacity(meshId.y);\n          _color_ = float(lineColorOpacity.x);\n          _opacity_ = float(lineColorOpacity.y);\n        #endif\n        #endif\n    }\n    ",fragmentShader:"\n    uniform vec4 overrideColor;\n    uniform float opacityScale;\n    //\n    #include <common>\n    #include <line_mtl_map_fragment>\n    #include <dithering_pars_fragment>\n    #include <color_pars_fragment>\n    #include <uv_pars_fragment>\n    #include <map_pars_fragment>\n    #include <alphamap_pars_fragment>\n    #include <alphatest_pars_fragment>\n    #include <aomap_pars_fragment>\n    #include <lightmap_pars_fragment>\n    #include <envmap_common_pars_fragment>\n    #include <envmap_pars_fragment>\n    #include <fog_pars_fragment>\n    #include <specularmap_pars_fragment>\n    #include <logdepthbuf_pars_fragment>\n    #include <clipping_planes_pars_fragment>\n    void main() {\n        mesh_id = int(_mesh_id_ + 0.1);\n        line_color = int(_color_);\n        line_opacity = int(_opacity_);\n        //\n        #include <clipping_planes_fragment>\n\n        ivec2 lineMtl = line_color >= 0 ? ivec2(line_color, line_opacity) : (overrideColor.a < 0.0 ? getLineMtl() : ivec2(0,0));\n        float opacity = line_color >= 0 ? float(lineMtl.y)/15.0 : float(lineMtl.y)/1000.0;\n        vec4 diffuseColor = (line_color >= 0 || overrideColor.a < 0.0) ? vec4( getColorFromHex(lineMtl.x), opacity) : overrideColor;\n        diffuseColor.a *= opacityScale;\n    \n        #include <logdepthbuf_fragment>\n        #include <map_fragment>\n        #include <color_fragment>\n        #include <alphamap_fragment>\n        #include <alphatest_fragment>\n        #include <specularmap_fragment>\n    \n        ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n    \n        // accumulation (baked indirect lighting only)\n        #ifdef USE_LIGHTMAP\n    \n            vec4 lightMapTexel = texture2D( lightMap, vLightMapUv );\n            reflectedLight.indirectDiffuse += lightMapTexel.rgb * lightMapIntensity * RECIPROCAL_PI;\n    \n        #else\n    \n            reflectedLight.indirectDiffuse += vec3( 1.0 );\n    \n        #endif\n    \n        // modulation\n        #include <aomap_fragment>\n    \n        reflectedLight.indirectDiffuse *= diffuseColor.rgb;\n    \n        vec3 outgoingLight = reflectedLight.indirectDiffuse;\n    \n        #include <envmap_fragment>\n    \n        #include <output_fragment>\n        #include <tonemapping_fragment>\n        #include <encodings_fragment>\n        #include <fog_fragment>\n        #include <premultiplied_alpha_fragment>\n        #include <dithering_fragment>\n \n    }\n    "};var S=function(a){function e(e,t,r,i){var n;return void 0===t&&(t=!1),void 0===r&&(r=!1),void 0===i&&(i=!0),(n=a.call(this,{type:"NdsBatchedLineBasicMaterial",uniforms:THREE.UniformsUtils.clone(THREE.ShaderLib.NdsBatchedLineBasic.uniforms),vertexShader:THREE.ShaderLib.NdsBatchedLineBasic.vertexShader,fragmentShader:THREE.ShaderLib.NdsBatchedLineBasic.fragmentShader,clipping:!0})||this).isNdsBatchedLineBasicMaterial=!0,t&&(n.defines={INSTANCE_MESH:""}),r&&(n.defines={BATCHED_MESH:""},n.extensions={multiDraw:!0}),i&&(n.defines.SUPPORT_UNIFORM_BLOCK=""),n.setValues(e),n}var t,r;return r=a,(t=e).prototype=Object.create(r.prototype),ar(t.prototype.constructor=t,r),e}(THREE.ShaderMaterial);function or(e,t){return(or=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}THREE.UniformsLib.NdsBatchedDepth={bodyWorldMatrixOffset:{value:0},meshId:{value:0},meshId2BodyIdParam:{value:new THREE.Vector2},meshId2BodyIdMap:{value:null},bodyNodeWorldMatrixMap:{value:null},bodyNodeWorldMatrixMapSize:{value:1}},THREE.ShaderLib.NdsBatchedDepth={uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib.common,THREE.UniformsLib.NdsBatchedDepth]),vertexShader:"\n    #ifdef BATCHED_MESH\n        int meshId;\n    #else\n        #ifdef INSTANCE_MESH\n            attribute int meshId;\n        #else\n            uniform int meshId;\n        #endif\n    #endif\n\n    // from meshbasic.glsl.js\n    #include <common>\n    #include <morphtarget_pars_vertex>\n    #include <logdepthbuf_pars_vertex>\n    #include <clipping_planes_pars_vertex>\n    #include <mesh_modelMatrix_map_vertex>\n\n    void main() {\n        mat4 modelViewMatrix = viewMatrix * getModelMatrix();\n\n\t    #include <begin_vertex>\n\t    #include <morphtarget_vertex>\n        \n        vec4 mvPosition = vec4( transformed, 1.0 );\n        mvPosition = modelViewMatrix * mvPosition;\n        gl_Position = projectionMatrix * mvPosition;\n\n\t    #include <logdepthbuf_vertex>\n\t    #include <clipping_planes_vertex>\n    }\n    ",fragmentShader:"\n    #include <clipping_planes_pars_fragment>\n\n    void main() {\n        #include <clipping_planes_fragment>\n    }\n    "};var sr=function(a){function e(e,t,r,i){var n;return void 0===t&&(t=!1),void 0===r&&(r=!1),void 0===i&&(i=!0),(n=a.call(this,{type:"NdsBatchedDepthMaterial",uniforms:THREE.UniformsUtils.clone(THREE.ShaderLib.NdsBatchedDepth.uniforms),vertexShader:THREE.ShaderLib.NdsBatchedDepth.vertexShader,fragmentShader:THREE.ShaderLib.NdsBatchedDepth.fragmentShader,clipping:!0})||this).isNdsBatchedDepthMaterial=!0,t&&(n.defines={INSTANCE_MESH:""}),r&&(n.defines={BATCHED_MESH:""},n.extensions={multiDraw:!0}),n.defines.DEPTH_ONLY="",i&&(n.defines.SUPPORT_UNIFORM_BLOCK=""),n.setValues(e),n.colorWrite=!1,n}var t,r;return r=a,(t=e).prototype=Object.create(r.prototype),or(t.prototype.constructor=t,r),e}(THREE.ShaderMaterial);function lr(e){var r="function"==typeof Map?new Map:void 0;return function(e){if(null===e||!function(t){try{return-1!==Function.toString.call(t).indexOf("[native code]")}catch(e){return"function"==typeof t}}(e))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==r){if(r.has(e))return r.get(e);r.set(e,t)}function t(){return function(e,t,r){var i;return dr()?Reflect.construct.apply(null,arguments):((i=[null]).push.apply(i,t),t=new(e.bind.apply(e,i)),r&&cr(t,r.prototype),t)}(e,arguments,hr(this).constructor)}return t.prototype=Object.create(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),cr(t,e)}(e)}function dr(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(dr=function(){return!!e})()}function cr(e,t){return(cr=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}function hr(e){return(hr=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function ur(e){function a(B,e,I,T,S){for(var R=function(){return!(!q.enableProgressiveRender||!(S<=0||S<300&&!B.viewer.clipDataManager.isPartClipEnabled()&&q.info.render.triangles+q.info.render.lines>q.maxPrimitivesPerFrame))&&(S=0,q.stopRenderingEarly=!0)},t=function(e,t,r,i,n,a){if(t&&0<S){r||(q.renderContext.state.buffers.color.setMask(!1),q.renderContext.state.buffers.color.setLocked(!0));for(var o=!0,s=q.enableProgressiveRender?0:1e4;;){for(var o=!0,l=0,d=a.length;l<d;++l){var c=a[l];if(c.visualStates.opaqueDrawCount===c.opaqueMeshes.length)c.visualStates.dirty=!1;else if(c.visualStates.dirty&&c.applyCull(),!c.isCulled()&&(S=(q.supportMultiDraw&&c.supportMultiDraw&&!c.meshSetHasMaterialWithMap&&!c.meshSetHasCW?H:C)(c,c.ndsModel,I,T,S,s,e,t,r,n,"opaque",!r),c.visualStates.opaqueDrawCount<c.opaqueMeshes.length&&(o=!1),c.ndsModel.renderMeshSetCount+=1,c.ndsModel.hasrenderMesh=!0,c.renderOnce=!0,c.visualStates.dirty=!1,c.lineDirty=!0,R()))break}if(l===d&&++s,o||S<=0)break}if(o&&0<S)for(var h=!0,s=q.enableProgressiveRender?0:1e4;;){for(var h=!0,u=0,p=a.length;u<p;++u){var f=a[u];if(f.visualStates.transparentDrawCount===f.transparentMeshes.length)f.visualStates.dirty=!1;else if(f.visualStates.dirty&&f.applyCull(),!f.isCulled()&&(S=(q.supportMultiDraw&&f.supportMultiDraw&&!f.meshSetHasMaterialWithMap&&!f.meshSetHasCW?H:C)(f,f.ndsModel,I,T,S,s,e,t,r,n,"transparent"),f.visualStates.transparentDrawCount<f.transparentMeshes.length&&(h=!1),f.ndsModel.renderMeshSetCount+=1,f.ndsModel.hasrenderMesh=!0,f.renderOnce=!0,f.visualStates.dirty=!1,f.lineDirty=!0,R()))break}if(u===p&&++s,h||S<=0)break}r||(q.renderContext.state.buffers.color.setLocked(!1),q.renderContext.state.buffers.color.setMask(!0))}if(i&&0<S)for(var m=0,g=n?2:1;m<g;++m){for(var v=2,y=!0;;){for(var y=!0,A=0,M=a.length;A<M;++A){var E=a[A];if(!B.viewer.customEdgeDetectPassBodyPart||!(E.renderMode&Ce.RENDER_BIT.WIREFRAME==Ce.RENDER_BIT.WIREFRAME||E.renderMode&Ce.RENDER_BIT.HIDDEN_LINE_REMOVE==Ce.RENDER_BIT.HIDDEN_LINE_REMOVE||E.renderMode&Ce.RENDER_BIT.HIDDEN_LINE_VISIBLE==Ce.RENDER_BIT.HIDDEN_LINE_VISIBLE)){if(q.inOutlinePass){if(0===E.selectedDrawingLines.length)continue}else if(!E.needsLineDraw(t))continue;if((q.inOutlinePass||(n&&0!==v||1!==E.visualStates.lineDrawPass)&&(!n||2!==E.visualStates.lineDrawPass))&&(E.visualStates.dirty&&E.applyCull(),!E.isCulled())&&(S=(q.supportMultiDraw&&E.supportMultiDraw?P:D)(E,E.ndsModel,I,T,S,e,r,n,E.visualStates.lineDrawPass),E.visualStates.lineDrawCount<E.drawingLines.length?y=!1:E.visualStates.lineDrawPass++,E.visualStates.lineDrawCount,E.visualStates.dirty=!1,v>E.visualStates.lineDrawPass&&(v=E.visualStates.lineDrawPass),R()))break}}if(y||S<=0)break}if(y&&n&&2!==v)for(var w=0,x=a.length;w<x;++w)for(var b=a[w].visualStates.lineDrawCount=0;b<a[w].drawingLines.length;++b)a[w].drawingLines[b].rendered=!1}},r=function(e,t,r,i,n,a){for(var o=0;o<e.length;++o)(f||e[o].visualStates.dirty||e[o]._last_render_pass_!==a)&&(e[o]._last_render_pass_=a,r||!t&&0==(e[o].renderMode&Ce.RENDER_BIT.HIDDEN_LINE_REMOVE)&&0==(e[o].renderMode&Ce.RENDER_BIT.HIDDEN_LINE_VISIBLE)||(e[o].visualStates.lineDrawCount=0,e[o].visualStates.lineDrawPass=0,e[o].visualStates.opaqueDrawCount=0,e[o].visualStates.transparentDrawCount=0),i&&(t||e[o].renderMode===Ce.RENDER_BIT.NORMAL)&&(e[o].visualStates.opaqueDrawCount=0,e[o].visualStates.transparentDrawCount=0),n)&&(t||e[o].renderMode===Ce.RENDER_BIT.NORMAL||0!=(e[o].renderMode&Ce.RENDER_BIT.WIREFRAME))&&(e[o].visualStates.lineDrawCount=0,e[o].visualStates.lineDrawPass=0)},i=S,n=0;n<3&&!q.inOutlinePass;++n){var a=e[n];if(0!==a.length){var o=a.isGlobalPass,s=1<n,l=!!B.viewer.singlePartMode||0!==n&&1!==n,d=!s,c=1===n;if(r(a,o,s,l,d,n),S<=0&&!q.stopRenderingEarly){q.stopRenderingEarly=!0;break}n<=1?(i=S,S=5e3):(B.needsFastRendering&&(S/=1.2),B.forceRenderAll&&(S=1e3,B.forceRenderAll=!1)),t(o,l,s,d,c,a),n<=1&&(S=i-(5e3-S))}}0<S&&B.viewer.selectionManager.shouldDrawSelectedMeshesIn3DViewer()&&!B.viewer.customEdgeDetectPassGlobal&&!B.viewer.customEdgeDetectPassBodyPart&&(B.models.forEach(function(e){T.layers.test(e.layersMask)&&!e.isSketchModel&&e.getDrawModeFace()&&q.drawSelectedBodyMeshes(e,I,T,e.getDrawModeFaceColorMask())}),S=1e3);for(var h=3;h<4&&!(B.needsFastRendering||S<=0);++h){var u,p=e[h];0!==p.length&&(u=p.isGlobalPass,B.forceRenderAll&&(S=1e3,B.forceRenderAll=!1),q.inOutlinePass||r(p,u,!0,!1,!0,h),t(u,!1,!0,!0,!1,p))}return S}var X=this,q=this.baseRenderer=e,e=(this.supportLargeUniformBuffer=65536<=q.maxSupportUniformBufferSize,Pe.getOSInfo()),G=(this.supportGlobalMtlUBO=this.supportLargeUniformBuffer||!("IOS"===e.os&&e.version<"17.0.0"),console.log("Support large uniform buffer? "+this.supportLargeUniformBuffer),console.log("Support global material uniform buffer? "+this.supportGlobalMtlUBO),new pr(512)),Y=[new pr(512),new pr(512)],Q=function(e,t,r,i,n,a,o,s){n.geometry=a[0].geometry,n.geometry.aniMorphInfluences&&n.geometry.aniMorphDictionary?(n.morphTargetInfluences=n.geometry.aniMorphInfluences,n.morphTargetDictionary=n.geometry.aniMorphDictionary):n.morphTargetInfluences&&(delete n.morphTargetInfluences,delete n.morphTargetDictionary);var a=!0===a[0].material.isMeshPhysicalMaterial,l=void 0,e=(e?(l=o?X.instancedDepthMtl:a?s.shouldDrawDoubleSide?X.instancedDoubleSidePhysicalMtl:X.instancedPhysicalMtl:s.shouldDrawDoubleSide?X.instancedDoubleSidePhongMtl:X.instancedPhongMtl,o||i||(l=a?X.instancedTransparentPhysicalMtl:X.instancedTransparentPhongMtl)):(l=o?X.depthMtl:a?s.shouldDrawDoubleSide?X.doubleSidePhysicalMtl:X.physicalMtl:s.shouldDrawDoubleSide?X.doubleSidePhongMtl:X.phongMtl,o||i||(l=a?X.transparentPhysicalMtl:X.transparentMtl)),l.needsLightsUpdate=q.__lightsChanged,l.uniforms.meshId2BodyIdParam.value.x=t.meshOffset,l.uniforms.meshId2BodyIdParam.value.y=r.meshId2BodyIdTexSize,l.uniforms.meshId2BodyIdMap.value=r.meshId2BodyIdTexture,o||(l.uniforms.meshMtlParam.value.x=t.meshOffset,l.uniforms.meshMtlParam.value.y=r.meshState.meshMtlTexSize,l.uniforms.meshMtlMap.value=r.meshState.meshMtlTexture),[]);X.supportLargeUniformBuffer?e=o?[t.bodyWorldMatrixUniformBlock]:[t.ndsModel.meshState.globalMtlUniformBlock,t.bodyWorldMatrixUniformBlock]:(l.uniforms.bodyNodeWorldMatrixMap.value=t.bodyWorldMatrixUniformMap,l.uniforms.bodyNodeWorldMatrixMapSize.value=t.bodyWorldMatrixUniformMapSize,X.supportGlobalMtlUBO?o||(e=[t.ndsModel.meshState.globalMtlUniformBlock]):(l.uniforms.globalMtlMap.value=r.meshState.globalMtlTexture,l.uniforms.globalMtlMapSize.value=r.meshState.globalMtlTextureSize)),l.uniforms.bodyWorldMatrixOffset.value=t.bodyWorldMatrixOffset,l.uniformsNeedUpdate=!0,l.uniforms.needsUpdate=!0,l.uniformsGroups=e,n.material=l,n.material.transparent=!o&&!i,n.material.flatShading=!n.geometry.attributes.normal},K=function(e,t,r,i,n,a){for(var o=0;o!==e.length;)for(var s=0;o<e.length&&s<512;){if(!r&&e[o].faceMaterials){if(512<=e[o].faceMaterials.length+s)break;for(var l=e[o].geometry.drawRange.start,d=e[o].geometry.drawRange.count,c=0,h=e[o].faceMaterials.length;c<h;++c){var u,p,f=e[o];!f.faceMaterials[c].visible||a&&f.faceMaterials[c].transparent||!a&&!f.faceMaterials[c].transparent||(u=f.faceMaterials[c].range[0],p=f.faceMaterials[c].range[1]-u+1,u+=e[o].geometry.drawRange.start,e[o].geometry.drawRange.start=u,e[o].geometry.drawRange.count=p,(t.material.isNdsBatchedPhongMaterial||t.material.isNdsBatchedPhysicalMaterial)&&(t.material.uniforms.meshId.value.x=e[o].localIndex,t.material.uniforms.meshId.value.y=f.faceMaterials[c].color_opacity),t.material.uniforms.needsUpdate=!0,t.material.uniformsNeedUpdate=!0,t.geometry=e[o].geometry,t.material.flatShading=!t.geometry.attributes.normal,t.matrixWorld.copy(e[o].bodyNode.worldMatrix),q.renderMeshDirect(i,n,t,null),e[o].geometry.drawRange.start=l,e[o].geometry.drawRange.count=d,++s)}}else t.material.isNdsBatchedPhongMaterial||t.material.isNdsBatchedPhysicalMaterial?(t.material.uniforms.meshId.value.x=e[o].localIndex,t.material.uniforms.meshId.value.y=-1):t.material.uniforms.meshId.value=e[o].localIndex,t.material.uniforms.needsUpdate=!0,t.material.uniformsNeedUpdate=!0,t.geometry=e[o].geometry,t.material.flatShading=!t.geometry.attributes.normal,t.matrixWorld.copy(e[o].bodyNode.worldMatrix),q.renderMeshDirect(i,n,t,null),++s;++o}},C=function(e,t,r,i,n,a,o,s,O,F,l,d){void 0===l&&(l="opaque"),void 0===d&&(d=!1);var U=performance.now(),c=(q._current_model_data_version_=t.dataVersion,Y[0].batchLength=0,Y[1].batchLength=0,"opaque"===l),h={shouldDrawDoubleSide:!1,frustum:X.renderParams.renderInfo.frustum},u=t.meshManager.mesh,p=(c?e.fetchOpaqueForDraw(Y[0],Y[1],d?-1:a,o,s,F,!O,h):e.fetchTransparentForDraw(Y[0],Y[1],a,o,s,F,!O,h),e.resetInstanceMesh(),[[],[]]),f=[[],[]],m=[[],[]];if(0<Y[0].batchLength||0<Y[1].batchLength){for(var g=0;g<Y.length;++g){var v=Y[g];if(v&&0!==v.batchLength)for(var y=0;y<v.batchLength;++y){var A=v[y],M=e.getMeshId(A.localIndex),M=t.meshState.getMeshMaterial(M).hasTexture;A&&1<A.geometry.refMeshes.length&&A.geometry.refMeshesSameMaterial&&!A.faceMaterials&&!M?(p[g].push(A),A.geometry.refInThisMeshSet++):(M?m:f)[g].push(A)}}for(var E=0;E<p.length;++E){var w=p[E];if(w&&0!==w.length){Q(!0,e,t,c,u,w,d,h);for(var N=new Set,x=0;x<w.length;++x){var b,B=w[x].geometry;N.has(B.uuid)||((b=e.geomUUID2MeshIdAttribute.get(B.uuid))&&B.refInThisMeshSet===b.array.length?(B.hasAttribute("meshId")||B.setAttribute("meshId",b),B.isInstancedBufferGeometry=!0,B.instanceCount=b.array.length,u.geometry=B,u.material.flatShading=!u.geometry.attributes.normal,u.matrixWorld.copy(w[x].bodyNode.worldMatrix),q.renderMeshDirect(i,r,u,null),B.hasAttribute("meshId")&&(B.deleteAttribute("meshId"),B.meshId=void 0),N.add(B.uuid)):f[E].push(w[x]))}}}}if(0!==f[0].length||0!==f[1].length||0!==m[0].length||0!==m[1].length){for(var I=0;I<f.length;++I){var T=f[I];0!==T.length&&(Q(!1,e,t,c,u,T,d,h),K(T,u,d,i,r,c))}if(0!==m[0].length||0!==m[1].length){for(var S=0;S<m.length;++S){var R=m[S];if(0!==R.length)for(var C=0;C!==R.length;)for(var D=0;C<R.length&&D<512;){u.material=R[C].material,u.matrixWorld.copy(R[C].bodyNode.worldMatrix),u.modelViewMatrix.multiplyMatrices(i.matrixWorldInverse,u.matrixWorld),u.matrixAutoUpdate=!1,u.matrixWorldNeedsUpdate=!1;var V=R[C].material.transparent;if(null!==R[C].material.alphaMap&&(R[C].material.transparent=!0),t.viewer.clipDataManager.isSectionViewEnabled()&&t.viewer.clipDataManager.enableClipDraw([R[C].material],!1),!d&&R[C].faceMaterials){if(512<=R[C].faceMaterials.length+D)break;for(var G=R[C].geometry.drawRange.start,k=R[C].geometry.drawRange.count,j=R[C].material.color,z=R[C].material.opacity,P=0,W=R[C].faceMaterials.length;P<W;++P){var H,_,L=R[C];!L.faceMaterials[P].visible||c&&L.faceMaterials[P].transparent||!c&&!L.faceMaterials[P].transparent||(H=L.faceMaterials[P].range[0],_=L.faceMaterials[P].range[1]-H+1,H+=R[C].geometry.drawRange.start,R[C].geometry.drawRange.start=H,R[C].geometry.drawRange.count=_,L=((H=L.faceMaterials[P].color_opacity)-16*(_=H/16))/16,u.material.color=(new THREE.Color).setHex(_),(u.material.opacity=L)<.99&&(u.material.transparent=!0),u.geometry=R[C].geometry,u.material.flatShading=!u.geometry.attributes.normal,q.renderMeshDirect(i,r,u,null),R[C].geometry.drawRange.start=G,R[C].geometry.drawRange.count=k,u.material.transparent=V,++D)}R[C].material.color=j,R[C].material.opacity=z}else u.geometry=R[C].geometry,u.material.flatShading=!u.geometry.attributes.normal,q.renderMeshDirect(i,r,u,null),++D;t.viewer.clipDataManager.isSectionViewEnabled()&&t.viewer.clipDataManager.disableClipDraw([R[C].material],!1),R[C].material.transparent=V,++C}}n-=performance.now()-U}}return n},D=function(n,a,e,t,r,i,o,s,l){void 0===o&&(o=!0),void 0===s&&(s=!1),void 0===l&&(l=0);for(var O=performance.now(),d=function(e,t,r){var i;0!==t.length&&(r.geometry=t[0].geometry,t=[],i=void(X.supportLargeUniformBuffer&&(t=[n.bodyWorldMatrixUniformBlock])),(i=e?q.inOutlinePass||0===l?X.instancedLineMtl:X.instancedHiddenLineMtl:q.inOutlinePass||0===l?X.lineBasicMtl:X.hiddenLineMtl).uniforms.meshId2BodyIdParam.value.x=n.lineOffset,i.uniforms.meshId2BodyIdParam.value.y=a.lineId2BodyIdTexSize,i.uniforms.meshId2BodyIdMap.value=a.lineId2BodyIdTexture,i.uniforms.lineMtlParam.value.x=n.lineOffset,i.uniforms.lineMtlParam.value.y=a.meshState.lineMtlTexSize,i.uniforms.lineMtlMap.value=a.meshState.lineMtlTexture,i.uniforms.bodyWorldMatrixOffset.value=n.bodyWorldMatrixOffset,X.supportLargeUniformBuffer||(i.uniforms.bodyNodeWorldMatrixMap.value=n.bodyWorldMatrixUniformMap,i.uniforms.bodyNodeWorldMatrixMapSize.value=n.bodyWorldMatrixUniformMapSize),i.uniformsGroups=t,i.side=THREE.DoubleSide,i.uniformsNeedUpdate=!0,i.uniforms.needsUpdate=!0,r.material=i)},c=a.meshManager.lineSegments,h=!1,u=!0,p=null,f=q.inOutlinePass,m=0,F=q.inOutlinePass?1:2;m<F;++m){q.inOutlinePass?(0===n.renderMode&&a.drawMode===a.SHADED_WITH_EDGES||n.hasNormalNode())&&(p=n.selectedDrawingLines,u=!(h=!0)):0===m?(G.batchLength=0,n.fetchLineForDraw(G,512,i,!s&&!o,s,q.inOutlinePass),p=G,u=!0):(p=n.selectedDrawingLines,f=h=!0),n.resetInstanceLine();for(var g=[],v=[],y=[],A=0;A<p.batchLength;++A){var M=p[A];M&&!M.material.material.isShaderMaterial&&1<M.geometry.refLineSegs.length&&M.geometry.refLineSegsSameMaterial&&!M.lineSegMaterials&&.99<M.material.opacity&&!h?(g.push(M),M.geometry.refInThisMeshSet++):(M.material.material.isShaderMaterial?y:v).push(M)}if(0<g.length){d(!0,g,c);for(var E=new Set,w=0;w<g.length;++w){var x,b=g[w].geometry;E.has(b.uuid)||((x=n.geomUUID2LineIdAttribute.get(b.uuid))&&b.refInThisMeshSet===x.array.length?(b.hasAttribute("meshId")||b.setAttribute("meshId",x),b.isInstancedBufferGeometry=!0,b.instanceCount=x.array.length,c.geometry=b,q.renderMeshDirect(t,e,c,null),b.hasAttribute("meshId")&&(b.deleteAttribute("meshId"),b.meshId=void 0),b.isInstancedBufferGeometry=!1,b.instanceCount=0,E.add(b.uuid)):v.push(g[w]))}}if(0!==v.length){d(!1,v,c);for(var B=0;B!==v.length;){var I=0,T=v[B].bodyNode,S=T.renderMode||T.ndsModel.drawMode;if(1!==m||S!==T.ndsModel.SHADED_WITH_EDGES||T.ndsModel.isSketchModel){c.material.depthTest=u;var R=-1;for(f&&(R=S===T.ndsModel.WIREFRAME?T.ndsModel.meshState.getSelectedEdgeColorOpacity(1):S<=T.ndsModel.SHADED?T.ndsModel.meshState.getSelectedEdgeColorOpacity(0):0===l?T.ndsModel.meshState.getSelectedEdgeColorOpacity(1):T.ndsModel.meshState.getSelectedEdgeColorOpacity(2));B<v.length&&I<512;){if(v[B].lineSegMaterials&&!f){if(512<=v[B].lineSegMaterials.length+I)break;for(var U=v[B].geometry.drawRange.start,N=v[B].geometry.drawRange.count,C=0,V=v[B].lineSegMaterials.length;C<V;++C){var D,P,H=v[B];H.lineSegMaterials[C].visible&&(D=H.lineSegMaterials[C].range[0],P=H.lineSegMaterials[C].range[1]-D+1,D+=v[B].geometry.drawRange.start,v[B].geometry.drawRange.start=D,v[B].geometry.drawRange.count=P,c.material.uniforms.meshId.value.x=v[B].localIndex,c.material.uniforms.meshId.value.y=-1===R?H.lineSegMaterials[C].color_opacity:R,c.material.uniforms.needsUpdate=!0,c.material.uniformsNeedUpdate=!0,c.geometry=v[B].geometry,q.renderMeshDirect(t,e,c,null),v[B].geometry.drawRange.start=U,v[B].geometry.drawRange.count=N,++I)}}else q.inOutlinePass&&(T.renderMode===T.ndsModel.WIREFRAME||T.ndsModel.isSketchModel)||(c.material.uniforms.meshId.value.x=v[B].localIndex,c.material.uniforms.meshId.value.y=R,c.material.uniforms.needsUpdate=!0,c.material.uniformsNeedUpdate=!0,c.geometry=v[B].geometry,q.renderMeshDirect(t,e,c,null),++I);++B}}else++B}}if(0!==y.length&&!q.inOutlinePass)for(var _=0;_!==y.length;){var L=y[_].bodyNode.isSelected();c.geometry=y[_].geometry,c.material=y[_].material.material,L&&(c.material.depthTest=!1,c.material.uniforms.diffuse.value=y[_].bodyNode.ndsModel.meshState.getSelectedEdgeColor()),c.matrixWorld.copy(y[_].bodyNode.worldMatrix),c.modelViewMatrix.multiplyMatrices(t.matrixWorldInverse,c.matrixWorld),c.matrixAutoUpdate=!1,c.matrixWorldNeedsUpdate=!1,q.renderMeshDirect(t,e,c,null),L&&(c.material.uniforms.diffuse.value=(new THREE.Color).setHex(y[_].material.color),c.material.depthTest=!0),++_}}return r-=performance.now()-O},v=[],y=[],A=[],M=[],P=function(e,t,r,i,n,a,o,s,l){void 0===o&&(o=!0),void 0===s&&(s=!1),void 0===l&&(l=0);var d=performance.now(),c=t.meshManager.batchedLineSegments,h=(c._multiDrawStarts||(c._multiDrawStarts=new Int32Array(512),c._multiDrawCounts=new Int32Array(512)),q.inOutlinePass||0===l?X.batchedLineBasicMtl:X.batchedHiddenLineBasicMtl),u=(h.uniforms.meshId2BodyIdParam.value.x=e.lineOffset,h.uniforms.meshId2BodyIdParam.value.y=t.lineId2BodyIdTexSize,h.uniforms.meshId2BodyIdMap.value=t.lineId2BodyIdTexture,h.uniforms.lineMtlParam.value.x=e.lineOffset,h.uniforms.lineMtlParam.value.y=t.meshState.lineMtlTexSize,h.uniforms.lineMtlMap.value=t.meshState.lineMtlTexture,X.supportLargeUniformBuffer||(h.uniforms.bodyNodeWorldMatrixMap.value=e.bodyWorldMatrixUniformMap,h.uniforms.bodyNodeWorldMatrixMapSize.value=e.bodyWorldMatrixUniformMapSize),h.uniforms.bodyWorldMatrixOffset.value=e.bodyWorldMatrixOffset,h.uniforms.opacityScale.value=0!==l||o||s?1:.6,[]),u=X.supportLargeUniformBuffer?[X.drawId2MeshIdUniformBlock,e.bodyWorldMatrixUniformBlock]:[X.drawId2MeshIdUniformBlock];h.uniformsNeedUpdate=!0,h.uniforms.needsUpdate=!0,h.uniformsGroups=u,h.side=THREE.DoubleSide,c.material=h;for(var p=null,f=q.inOutlinePass,m=0,g=q.inOutlinePass?1:2;m<g;++m)if(q.inOutlinePass?(0===e.renderMode&&t.drawMode===t.SHADED_WITH_EDGES||e.hasNormalNode())&&(p=e.selectedDrawingLines,t.viewer.clipDataManager.isSectionViewEnabled()&&t.viewer.clipDataManager.addClipPlanesToMaterial(h),h.depthTest=!1):0===m?(G.batchLength=0,e.fetchLineForDraw(G,512,a,!s&&!o,s,q.inOutlinePass),p=G,h.depthTest=!0):(p=e.selectedDrawingLines,f=!0),p&&0!==p.batchLength){c._multiDrawCount=p.length,c.geometry=p[0].geometry;for(var v=X.drawId2MeshIdUniformBlock.uniforms[0],y=p[0].geometry.index.array.BYTES_PER_ELEMENT,A=0;A!==p.batchLength;){for(var M=0;A<p.batchLength&&M<512;){var E=p[A].bodyNode,w=E.renderMode||E.ndsModel.drawMode;if(1===m&&w===E.ndsModel.SHADED_WITH_EDGES);else{var x=-1;if(f&&(x=w===E.ndsModel.WIREFRAME?E.ndsModel.meshState.getSelectedEdgeColorOpacity(1):w<=E.ndsModel.SHADED?E.ndsModel.meshState.getSelectedEdgeColorOpacity(0):0===l?E.ndsModel.meshState.getSelectedEdgeColorOpacity(1):E.ndsModel.meshState.getSelectedEdgeColorOpacity(2)),!f&&p[A].lineSegMaterials){if(512<=p[A].lineSegMaterials.length+M)break;for(var b=0,B=p[A].lineSegMaterials.length;b<B;++b){var I,T,S=p[A];S.lineSegMaterials[b].visible&&(I=S.lineSegMaterials[b].range[0],T=S.lineSegMaterials[b].range[1]-I+1,I+=p[A].geometry.drawRange.start,c._multiDrawStarts[M]=I*y,c._multiDrawCounts[M]=T,v.value[2*M]=p[A].localIndex,v.value[2*M+1]=-1===x?S.lineSegMaterials[b].color_opacity:x,++M)}}else q.inOutlinePass&&p[A].bodyNode.renderMode===E.ndsModel.WIREFRAME||(c._multiDrawStarts[M]=p[A].geometry.drawRange.start*y,c._multiDrawCounts[M]=p[A].geometry.drawRange.count,v.value[2*M]=p[A].localIndex,v.value[2*M+1]=x,++M)}++A}0<M&&(c._multiDrawCount=M,v.needsUpdate=!0,v.__update_offset=0,v.__update_length=2*M,X.drawId2MeshIdUniformBlock.needsUpdate=!0,q.renderMeshDirect(i,r,c,null))}}return q.inOutlinePass?t.viewer.clipDataManager.isSectionViewEnabled()&&(h.clippingPlanes=[]):n-=performance.now()-d,n},H=function(e,t,r,i,n,a,o,s,l,d,c,h){void 0===c&&(c="opaque"),void 0===h&&(h=!1);var u=performance.now(),p=(q._current_model_data_version_=t.dataVersion,Y[0].batchLength=0,Y[1].batchLength=0,"opaque"===c),f={shouldDrawDoubleSide:!1,frustum:X.renderParams.renderInfo.frustum};if(p?e.fetchOpaqueForDraw(Y[0],Y[1],h?-1:a,o,s,d,!l,f):e.fetchTransparentForDraw(Y[0],Y[1],a,o,s,d,!l,f),0!==Y.length){var m=t.meshManager.batchedMesh;m._multiDrawStarts||(m._multiDrawStarts=new Int32Array(512),m._multiDrawCounts=new Int32Array(512));for(var g=0;g<2;++g){var v=Y[g];if(0!==v.batchLength){m.geometry=v[0].geometry,m.geometry.aniMorphInfluences&&m.geometry.aniMorphDictionary?(m.morphTargetInfluences=m.geometry.aniMorphInfluences,m.morphTargetDictionary=m.geometry.aniMorphDictionary):m.morphTargetInfluences&&(delete m.morphTargetInfluences,delete m.morphTargetDictionary);for(var y=1===g,A=h?X.batchedDepthMtl:y?f.shouldDrawDoubleSide?X.batchedDoubleSidePhysicalMtl:X.batchedPhysicalMtl:f.shouldDrawDoubleSide?X.batchedDoubleSidePhongMtl:X.batchedPhongMtl,M=((A=h||p?A:y?X.batchedTransparentPhysicalMtl:X.batchedTransparentPhongMtl).needsLightsUpdate=q.__lightsChanged,A.uniforms.meshId2BodyIdParam.value.x=e.meshOffset,A.uniforms.meshId2BodyIdParam.value.y=t.meshId2BodyIdTexSize,A.uniforms.meshId2BodyIdMap.value=t.meshId2BodyIdTexture,h||(A.uniforms.meshMtlParam.value.x=e.meshOffset,A.uniforms.meshMtlParam.value.y=t.meshState.meshMtlTexSize,A.uniforms.meshMtlMap.value=t.meshState.meshMtlTexture),[]),E=(X.supportLargeUniformBuffer?M=h?[X.batchedPhongMtl.uniformsGroups[0],e.bodyWorldMatrixUniformBlock]:[(y?X.batchedPhysicalMtl:X.batchedPhongMtl).uniformsGroups[0],e.ndsModel.meshState.globalMtlUniformBlock,e.bodyWorldMatrixUniformBlock]:(M=h?[X.batchedPhongMtl.uniformsGroups[0]]:[(y?X.batchedPhysicalMtl:X.batchedPhongMtl).uniformsGroups[0]],A.uniforms.bodyNodeWorldMatrixMap.value=e.bodyWorldMatrixUniformMap,A.uniforms.bodyNodeWorldMatrixMapSize.value=e.bodyWorldMatrixUniformMapSize,X.supportGlobalMtlUBO?M.push(e.ndsModel.meshState.globalMtlUniformBlock):(A.uniforms.globalMtlMap.value=t.meshState.globalMtlTexture,A.uniforms.globalMtlMapSize.value=t.meshState.globalMtlTextureSize)),A.uniforms.bodyWorldMatrixOffset.value=e.bodyWorldMatrixOffset,A.uniformsNeedUpdate=!0,A.uniforms.needsUpdate=!0,A.uniformsGroups=M,m.material=A,m.material.transparent=!h&&!p,m.material.flatShading=!m.geometry.attributes.normal,X.drawId2MeshIdUniformBlock.uniforms[0]),w=v[0].geometry.index.array.BYTES_PER_ELEMENT,x=0;x!==v.batchLength;){for(var b=0;x<v.batchLength&&b<512;){if(!h&&v[x].faceMaterials){if(512<=v[x].faceMaterials.length+b)break;for(var B=0,I=v[x].faceMaterials.length;B<I;++B){var T,S,R=v[x];!R.faceMaterials[B].visible||p&&R.faceMaterials[B].transparent||!p&&!R.faceMaterials[B].transparent||(T=R.faceMaterials[B].range[0],S=R.faceMaterials[B].range[1]-T+1,T+=v[x].geometry.drawRange.start,m._multiDrawStarts[b]=T*w,m._multiDrawCounts[b]=S,E.value[2*b]=v[x].localIndex,E.value[2*b+1]=R.faceMaterials[B].color_opacity,++b)}}else m._multiDrawStarts[b]=v[x].geometry.drawRange.start*w,m._multiDrawCounts[b]=v[x].geometry.drawRange.count,E.value[2*b]=v[x].localIndex,E.value[2*b+1]=-1,++b;++x}m._multiDrawCount=b,E.needsUpdate=!0,E.__update_offset=0,E.__update_length=2*b,X.drawId2MeshIdUniformBlock.needsUpdate=!0,q.renderMeshDirect(i,r,m,null)}}}n-=performance.now()-u}return n},o=!1,f=!1;this.render=function(m,e,t,r,g){o||(q.supportMultiDraw&&!X.drawId2MeshIdUniformBlock&&(X.drawId2MeshIdUniformBlock=new THREE.UniformsGroup,X.drawId2MeshIdUniformBlock.setName("drawId2MeshIdData"),X.drawId2MeshIdUniformBlock.add(new THREE.Uniform(new Int32Array(1024))),X.drawId2MeshIdUniformBlock.usage=THREE.DynamicDrawUsage),X.batchedPhongMtl||(X.batchedPhongMtl=new I({polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1,side:THREE.FrontSide},!1,!0,X.supportLargeUniformBuffer,X.supportGlobalMtlUBO),X.batchedPhongMtl.uniformsGroups=[X.drawId2MeshIdUniformBlock],X.batchedDoubleSidePhongMtl=new I({polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1,side:THREE.DoubleSide},!1,!0,X.supportLargeUniformBuffer,X.supportGlobalMtlUBO),X.batchedTransparentPhongMtl=new I({depthWrite:!1,transparent:!0,polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1,side:THREE.DoubleSide},!1,!0,X.supportLargeUniformBuffer,X.supportGlobalMtlUBO),X.batchedTransparentPhongMtl.uniformsGroups=[X.drawId2MeshIdUniformBlock],X.batchedDepthMtl=new sr({polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1},!1,!0,X.supportLargeUniformBuffer),X.batchedDepthMtl.uniformsGroups=[X.drawId2MeshIdUniformBlock]),X.batchedPhysicalMtl||(X.batchedPhysicalMtl=new T({polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1,side:THREE.FrontSide},!1,!0,X.supportLargeUniformBuffer,X.supportGlobalMtlUBO),X.batchedPhysicalMtl.uniformsGroups=[X.drawId2MeshIdUniformBlock],X.batchedDoubleSidePhysicalMtl=new T({polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1,side:THREE.DoubleSide},!1,!0,X.supportLargeUniformBuffer,X.supportGlobalMtlUBO),X.batchedTransparentPhysicalMtl=new T({depthWrite:!1,transparent:!0,polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1,side:THREE.DoubleSide},!1,!0,X.supportLargeUniformBuffer,X.supportGlobalMtlUBO),X.batchedTransparentPhysicalMtl.uniformsGroups=[X.drawId2MeshIdUniformBlock]),X.batchedLineBasicMtl||(X.batchedLineBasicMtl=new S({transparent:!0},!1,!0,X.supportLargeUniformBuffer),X.batchedLineBasicMtl.uniformsGroups=[X.drawId2MeshIdUniformBlock],X.batchedHiddenLineBasicMtl=new S({depthWrite:!0,transparent:!0,opacity:.2,depthFunc:THREE.GreaterDepth},!1,!0,X.supportLargeUniformBuffer),X.batchedHiddenLineBasicMtl.uniforms.overrideColor.value.x=0,X.batchedHiddenLineBasicMtl.uniforms.overrideColor.value.y=0,X.batchedHiddenLineBasicMtl.uniforms.overrideColor.value.z=0,X.batchedHiddenLineBasicMtl.uniforms.overrideColor.value.w=.2,X.batchedHiddenLineBasicMtl.uniformsGroups=[X.drawId2MeshIdUniformBlock]),X.instancedPhongMtl||(X.instancedPhongMtl=new I({polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1,side:THREE.FrontSide},!0,!1,X.supportLargeUniformBuffer,X.supportGlobalMtlUBO)),X.instancedDoubleSidePhongMtl||(X.instancedDoubleSidePhongMtl=new I({polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1,side:THREE.DoubleSide},!0,!1,X.supportLargeUniformBuffer,X.supportGlobalMtlUBO)),X.instancedTransparentPhongMtl||(X.instancedTransparentPhongMtl=new I({depthWrite:!1,transparent:!0,polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1,side:THREE.DoubleSide},!0,!1,X.supportLargeUniformBuffer,X.supportGlobalMtlUBO)),X.phongMtl||(X.phongMtl=new I({polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1,side:THREE.FrontSide},!1,!1,X.supportLargeUniformBuffer,X.supportGlobalMtlUBO),X.phongMtl.uniformsGroups=[]),X.doubleSidePhongMtl||(X.doubleSidePhongMtl=new I({polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1,side:THREE.DoubleSide},!1,!1,X.supportLargeUniformBuffer,X.supportGlobalMtlUBO)),X.transparentMtl||(X.transparentMtl=new I({depthWrite:!1,transparent:!0,polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1,side:THREE.DoubleSide},!1,!1,X.supportLargeUniformBuffer,X.supportGlobalMtlUBO)),X.instancedPhysicalMtl||(X.instancedPhysicalMtl=new T({polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1,side:THREE.FrontSide},!0,!1,X.supportLargeUniformBuffer,X.supportGlobalMtlUBO)),X.instancedDoubleSidePhysicalMtl||(X.instancedDoubleSidePhysicalMtl=new T({polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1,side:THREE.DoubleSide},!0,!1,X.supportLargeUniformBuffer,X.supportGlobalMtlUBO)),X.physicalMtl||(X.physicalMtl=new T({polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1,side:THREE.FrontSide},!1,!1,X.supportLargeUniformBuffer,X.supportGlobalMtlUBO),X.physicalMtl.uniformsGroups=[]),X.doubleSidePhysicalMtl||(X.doubleSidePhysicalMtl=new T({polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1,side:THREE.DoubleSide},!1,!1,X.supportLargeUniformBuffer,X.supportGlobalMtlUBO)),X.transparentPhysicalMtl||(X.transparentPhysicalMtl=new T({depthWrite:!1,transparent:!0,polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1,side:THREE.DoubleSide},!1,!1,X.supportLargeUniformBuffer,X.supportGlobalMtlUBO)),X.instancedTransparentPhysicalMtl||(X.instancedTransparentPhysicalMtl=new T({depthWrite:!1,transparent:!0,polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1,side:THREE.DoubleSide},!0,!1,X.supportLargeUniformBuffer,X.supportGlobalMtlUBO)),X.instancedDepthMtl||(X.instancedDepthMtl=new sr({polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1},!0,!1,X.supportLargeUniformBuffer)),X.depthMtl||(X.depthMtl=new sr({polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1},!1,!1,X.supportLargeUniformBuffer)),X.instancedLineMtl||(X.instancedLineMtl=new S({transparent:!0},!0,!1,X.supportLargeUniformBuffer),X.instancedHiddenLineMtl=new S({depthWrite:!0,transparent:!0,opacity:.2,depthFunc:THREE.GreaterDepth},!0,!1,X.supportLargeUniformBuffer),X.instancedHiddenLineMtl.uniforms.overrideColor.value.x=0,X.instancedHiddenLineMtl.uniforms.overrideColor.value.y=0,X.instancedHiddenLineMtl.uniforms.overrideColor.value.z=0,X.instancedHiddenLineMtl.uniforms.overrideColor.value.w=.2),X.lineBasicMtl||(X.lineBasicMtl=new S({transparent:!0},!1,!1,X.supportLargeUniformBuffer),X.hiddenLineMtl=new S({depthWrite:!0,transparent:!0,opacity:.2,depthFunc:THREE.GreaterDepth},!1,!1,X.supportLargeUniformBuffer),X.hiddenLineMtl.uniforms.overrideColor.value.x=0,X.hiddenLineMtl.uniforms.overrideColor.value.y=0,X.hiddenLineMtl.uniforms.overrideColor.value.z=0,X.hiddenLineMtl.uniforms.overrideColor.value.w=.2),o=!0),X.renderParams=g,v.length=0,v.isGlobalPass=!1,y.length=0,y.isGlobalPass=!1,A.length=0,A.isGlobalPass=!1,M.length=0,M.isGlobalPass=!1;m.models.forEach(function(e){if(e.state<ee.StateType.RENDERING_PREPARED)q.stopRenderingEarly=!0;else if((void 0===e.renderOnce||e.lineSegmentsSet.dirty||q.inOutlinePass)&&(e.renderOnce=!0),e.hasrenderMesh=!1,e.renderOnce){e.applyCull(g.renderInfo.frustum),e.meshManager.renderContext=q.renderContext,e.geomManager.renderContext=q.renderContext;for(var t=e.getDrawModeFace(),r=e.getDrawModeFaceColorMask(),i=e.getDrawModeEdge(),n=e.getDrawModeHiddenEdge(),a=((m.viewer.customEdgeDetectPassGlobal||m.viewer.customEdgeDetectPassGlobal)&&(n=i=!1),r?(t&&(A.isGlobalPass=!0),i&&(M.isGlobalPass=!0)):n?y.isGlobalPass=!0:v.isGlobalPass=!0,e.getMeshSets()),o=0;o<a.length;++o){var s,l,d,c,h,u,p,f=a[o];0===f.bodyNodes.length?f.visualStates.dirty=!1:(f.visualStates.dirty&&f.applyCull(),f.isCulled()||(s=0!=(f.renderMode&Ce.RENDER_BIT.NORMAL),l=0!=(f.renderMode&Ce.RENDER_BIT.WIREFRAME),d=0!=(f.renderMode&Ce.RENDER_BIT.HIDDEN_LINE_VISIBLE),c=0!=(f.renderMode&Ce.RENDER_BIT.HIDDEN_LINE_REMOVE),h=!(d||c),u=f.needsMeshDraw(),p=q.inOutlinePass||f.needsLineDraw(s),(m.viewer.customEdgeDetectPassGlobal||m.viewer.customEdgeDetectPassGlobal)&&(p=c=d=l=!1),f.isLoaded()?(f.prepareForBatchDraw(),r?(h||u&&(d&&y.push(f),c)&&v.push(f),u&&(t||s)&&A.push(f),(u||p)&&(i||l)&&M.push(f)):(u&&(n?(y.push(f),c&&v.push(f)):(d&&y.push(f),v.push(f))),s&&u&&A.push(f),(u||p)&&l&&M.push(f))):q.stopRenderingEarly=!0))}}});var i,n=[v,y,A,M];m.viewer.clipDataManager.isSectionViewEnabled()&&0<r?(i=[X.batchedPhongMtl,X.batchedDoubleSidePhongMtl,X.batchedTransparentPhongMtl,X.batchedDepthMtl,X.batchedLineBasicMtl,X.batchedPhysicalMtl,X.batchedDoubleSidePhysicalMtl,X.batchedTransparentPhysicalMtl,X.phongMtl,X.doubleSidePhongMtl,X.instancedPhongMtl,X.instancedDoubleSidePhongMtl,X.transparentMtl,X.instancedTransparentPhongMtl,X.depthMtl,X.instancedDepthMtl,X.lineBasicMtl,X.instancedLineMtl,X.physicalMtl,X.doubleSidePhysicalMtl,X.instancedPhysicalMtl,X.instancedDoubleSidePhysicalMtl,X.transparentPhysicalMtl,X.instancedTransparentPhysicalMtl],m.viewer.clipDataManager.enableClipDraw(i),r=a(m,n,e,t,r),m.viewer.clipDataManager.disableClipDraw(i),f=!0,m.viewer.clipDataManager.isPartClipEnabled()&&m.viewer.clipDataManager.containsUnClippedObjects()&&a(m,n,e,t,r),f=!1):0<r&&(a(m,n,e,t,r),f=!1)}}var pr=function(t){function e(e){e=t.call(this,e)||this;return e.batchLength=0,e}var r,i;return i=t,(r=e).prototype=Object.create(i.prototype),cr(r.prototype.constructor=r,i),e}(lr(Array));function fr(e,t){return(fr=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}THREE.UniformsLib.NdsBatched2DMeshBasic={bodyWorldMatrixOffset:{value:0},bodyNodeWorldMatrixMap:{value:null},bodyNodeWorldMatrixMapSize:{value:1},meshId:{value:new THREE.Vector2},meshId2BodyIdParam:{value:new THREE.Vector2},meshId2BodyIdMap:{value:null},lineMtlParam:{value:new THREE.Vector2},lineMtlMap:{value:null},extraMtlParam:{value:new THREE.Vector2},extraMtlMap:{value:null},pictureMtlMap:{value:null}},THREE.ShaderLib.NdsBatched2DMeshBasic={uniforms:THREE.UniformsUtils.merge([{map:{value:null},mapTransform:{value:new THREE.Matrix3},alphaMap:{value:null},alphaMapTransform:{value:new THREE.Matrix3},alphaTest:{value:0}},THREE.UniformsLib.common,THREE.UniformsLib.specularmap,THREE.UniformsLib.envmap,THREE.UniformsLib.aomap,THREE.UniformsLib.lightmap,THREE.UniformsLib.fog,THREE.UniformsLib.NdsBatched2DMeshBasic]),vertexShader:"\n    #ifdef BATCHED_MESH\n        ivec2 meshId;\n    #else\n        #ifdef INSTANCE_MESH\n            attribute ivec2 meshId;\n        #else\n            uniform ivec2 meshId;\n        #endif\n    #endif\n    // hatch\n    #ifdef IS_2DHATCH\n        varying vec2 vUv;\n    #endif\n\n    // from meshbasic.glsl.js\n    #include <common>\n    #include <uv_pars_vertex>\n    #include <envmap_pars_vertex>\n    #include <color_pars_vertex>\n    #include <fog_pars_vertex>\n    #include <morphtarget_pars_vertex>\n    #include <skinning_pars_vertex>\n    #include <logdepthbuf_pars_vertex>\n    #include <clipping_planes_pars_vertex>\n    #include <2D_mesh_modelMatrix_map_vertex>\n\n    void main() {\n        \n        mat4 modelViewMatrix = viewMatrix * getModelMatrix();\n        mat3 normalMatrix = mat3(modelViewMatrix);  \n\n        #include <uv_vertex>\n\t    #include <color_vertex>\n\t    #include <morphcolor_vertex>\n\n\t    #if defined ( USE_ENVMAP ) || defined ( USE_SKINNING )\n\n\t\t    #include <beginnormal_vertex>\n\t\t    #include <morphnormal_vertex>\n\t\t    #include <skinbase_vertex>\n\t\t    #include <skinnormal_vertex>\n\t\t    //#include <defaultnormal_vertex>\n            vec3 transformedNormal = objectNormal;\n            transformedNormal = normalMatrix * transformedNormal;\n\t    #endif\n\n\t    #include <begin_vertex>\n\t    #include <morphtarget_vertex>\n\t    #include <skinning_vertex>\n\t    //#include <project_vertex>\n\n        #ifdef IS_2DHATCH\n            vUv = uv;\n        #endif\n        \n        vec4 mvPosition = vec4( transformed, 1.0 );\n        mvPosition = modelViewMatrix * mvPosition;\n        gl_Position = projectionMatrix * mvPosition;\n\n\t    #include <logdepthbuf_vertex>\n\t    #include <clipping_planes_vertex>\n\n\t    #include <worldpos_vertex>\n\t    #include <envmap_vertex>\n\t    #include <fog_vertex>\n\n    }\n    ",fragmentShader:"\n    // hatch\n    #ifdef IS_2DHATCH\n        varying vec2 vUv;\n        #define SQRT_2_VALUE 1.414213562373\n\t\t#define PI_VALUE 3.14159265359\n        #ifdef IS_PICTURE\n            uniform sampler2D pictureMtlMap;\n        #endif\n    #endif\n\n    // from meshbasic.glsl.js\n\n    #ifndef FLAT_SHADED\n\t    varying vec3 vNormal;\n    #endif\n\n    #include <common>\n    #include <2D_line_mtl_map_fragment_4v>\n    #include <dithering_pars_fragment>\n    #include <color_pars_fragment>\n    #include <uv_pars_fragment>\n    #include <map_pars_fragment>\n    #include <alphamap_pars_fragment>\n    #include <alphatest_pars_fragment>\n    #include <aomap_pars_fragment>\n    #include <lightmap_pars_fragment>\n    #include <envmap_common_pars_fragment>\n    #include <envmap_pars_fragment>\n    #include <fog_pars_fragment>\n    #include <specularmap_pars_fragment>\n    #include <logdepthbuf_pars_fragment>\n    #include <clipping_planes_pars_fragment>\n\n    void main() {\n        // \n        mesh_id = int(_mesh_id_ + 0.1);\n        //\n        vec4 lineMtl = getLineMtl();\n        int color_hex = int(_usePackColor > 0.0f ? _packColor : lineMtl[1]);\n        vec3 diffuse = getColorFromHex(color_hex);\n        float opacity = lineMtl[2]/1000.0;\n\n        // hatch\n        #ifdef IS_2DHATCH\n            if(lineMtl[3] > -0.1f && _usePackColor <0.0f){\n                int hatchNum = (extraMtlParam[0] + int(lineMtl[3]))*16;\n\n                int index_x =  hatchNum % extraMtlParam[1];\n                int index_y = hatchNum / extraMtlParam[1];\n\n                float color1 = texelFetch(extraMtlMap, ivec2(index_x + 4, index_y), 0).x;\n                float color2 = texelFetch(extraMtlMap, ivec2(index_x + 5, index_y), 0).x;\n                float hatchType = texelFetch(extraMtlMap, ivec2(index_x + 6, index_y), 0).x;\n                float shift = texelFetch(extraMtlMap, ivec2(index_x + 7, index_y), 0).x;\n                float params = texelFetch(extraMtlMap, ivec2(index_x + 8, index_y), 0).x;\n\n                float dist = 0.0;\n\n\t\t\t\t// 直线形\n\t\t\t\tif( hatchType >0.5 && hatchType <1.5){\n\t\t\t\t\tdist = vUv.x;\n\t\t\t\t}\n\n\t\t\t\t// 球形\n\t\t\t\tif( hatchType >1.5 && hatchType <2.5){\n\t\t\t\t\tdist = length(vUv);\n\t\t\t\t\tdist = dist > 1.0 ? 0.0 : (sqrt(2.0-dist*dist)-1.0)/(SQRT_2_VALUE-1.0);\n\t\t\t\t}\n\n\t\t\t\t// 半球形\n\t\t\t\tif( hatchType >2.5 && hatchType <3.5){\n\t\t\t\t\tdist = sin((1.0 - length(vUv)) *PI_VALUE*0.5);\n\t\t\t\t}\n\n\t\t\t\t// 曲线形\n\t\t\t\tif( hatchType >3.5 && hatchType <4.5){\n\t\t\t\t\t//dist = cos(length(vUv)*PI_VALUE/2.0);\n\n\t\t\t\t\tdist = cos((length(vUv) - params)*PI_VALUE/2.0);\n\t\t\t\t}\n\n\t\t\t\t// 圆柱形\n\t\t\t\tif( hatchType >4.5 && hatchType <5.5){\n\t\t\t\t\tdist = vUv.x < 0.0 ? 1.0 + vUv.x /(1.0-shift/2.0): 1.0 - vUv.x/(1.0+shift/2.0);\n\t\t\t\t\tdist = (sin(dist * PI_VALUE *3.0/4.0 - PI_VALUE/4.0)+SQRT_2_VALUE/2.0)/(1.0 + SQRT_2_VALUE/2.0);\n\t\t\t\t}\n\n                vec3 diffuse1 = getColorFromHex(int(color1));\n                vec3 diffuse2 = getColorFromHex(int(color2));\n                diffuse = mix(diffuse1,diffuse2,dist);\n            }\n        #endif\n\n        #ifdef IS_PICTURE\n            if(_usePackColor < 0.0f){\n                diffuse = texture2D(pictureMtlMap,vUv).rgb;\n            }else{\n                vec3 diffuse1 = texture2D(pictureMtlMap,vUv).rgb;\n                diffuse = mix(diffuse1,diffuse,0.5);\n            }\n        #endif\n    \n        #include <clipping_planes_fragment>\n\n        vec4 diffuseColor = vec4( diffuse, opacity );\n\n        #include <logdepthbuf_fragment>\n        #include <map_fragment>\n        #include <color_fragment>\n        #include <alphamap_fragment>\n        #include <alphatest_fragment>\n        #include <specularmap_fragment>\n\n        ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\n        // accumulation (baked indirect lighting only)\n        #ifdef USE_LIGHTMAP\n\n            vec4 lightMapTexel = texture2D( lightMap, vLightMapUv );\n            reflectedLight.indirectDiffuse += lightMapTexel.rgb * lightMapIntensity * RECIPROCAL_PI;\n\n        #else\n\n            reflectedLight.indirectDiffuse += vec3( 1.0 );\n\n        #endif\n\n        // modulation\n        #include <aomap_fragment>\n\n        reflectedLight.indirectDiffuse *= diffuseColor.rgb;\n\n        vec3 outgoingLight = reflectedLight.indirectDiffuse;\n\n        #include <envmap_fragment>\n\n        #include <output_fragment>\n        #include <tonemapping_fragment>\n        #include <encodings_fragment>\n        #include <fog_fragment>\n        #include <premultiplied_alpha_fragment>\n        #include <dithering_fragment>\n    }\n    "};var mr=function(o){function e(e,t,r,i,n){var a;return void 0===t&&(t=!1),void 0===r&&(r=!1),void 0===i&&(i=!1),void 0===n&&(n=!0),(a=o.call(this,{type:"NdsBatched2DMeshBasicMaterial",uniforms:THREE.UniformsUtils.clone(THREE.ShaderLib.NdsBatched2DMeshBasic.uniforms),vertexShader:THREE.ShaderLib.NdsBatched2DMeshBasic.vertexShader,fragmentShader:THREE.ShaderLib.NdsBatched2DMeshBasic.fragmentShader,clipping:!0})||this).isNdsBatchedMeshBasicMaterial=!0,t&&(a.defines={INSTANCE_MESH:""}),r&&(a.defines={BATCHED_MESH:""},a.extensions={multiDraw:!0}),n&&(a.defines.SUPPORT_UNIFORM_BLOCK=""),a.defines.IS_2DHATCH="",i&&(a.defines.IS_PICTURE=""),a.setValues(e),a}var t,r;return r=o,(t=e).prototype=Object.create(r.prototype),fr(t.prototype.constructor=t,r),e}(THREE.ShaderMaterial);function gr(e,t){return(gr=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}THREE.UniformsLib.NdsBatched2DLineBasic={bodyWorldMatrixOffset:{value:0},bodyNodeWorldMatrixMap:{value:null},bodyNodeWorldMatrixMapSize:{value:1},meshId:{value:new THREE.Vector2},meshId2BodyIdParam:{value:new THREE.Vector2},meshId2BodyIdMap:{value:null},lineMtlParam:{value:new THREE.Vector2},lineMtlMap:{value:null},extraMtlParam:{value:new THREE.Vector2},extraMtlMap:{value:null}},THREE.ShaderLib.NdsBatched2DLineBasic={uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib.common,THREE.UniformsLib.specularmap,THREE.UniformsLib.envmap,THREE.UniformsLib.aomap,THREE.UniformsLib.lightmap,THREE.UniformsLib.fog,THREE.UniformsLib.NdsBatched2DLineBasic]),vertexShader:"\n    #ifdef BATCHED_MESH\n        ivec2 meshId;\n    #else\n        #ifdef INSTANCE_MESH\n            attribute ivec2 meshId;\n        #else\n            uniform ivec2 meshId;\n        #endif\n    #endif\n    #ifdef USE_2DLINETYPE\n        attribute vec3 lineDistance;\n        varying vec3 vLineDistance;\n    #endif\n    //\n    #include <common>\n    #include <uv_pars_vertex>\n    #include <envmap_pars_vertex>\n    #include <color_pars_vertex>\n    #include <fog_pars_vertex>\n    #include <morphtarget_pars_vertex>\n    #include <skinning_pars_vertex>\n    #include <logdepthbuf_pars_vertex>\n    #include <clipping_planes_pars_vertex>\n    #include <2D_mesh_modelMatrix_map_vertex>\n    \n    void main() {\n    \n        mat4 modelViewMatrix = viewMatrix * getModelMatrix();\n        \n        #include <uv_vertex>\n\t    #include <color_vertex>\n\t    #include <morphcolor_vertex>\n    \n    \n        #include <begin_vertex>\n        #include <morphtarget_vertex>\n        #include <skinning_vertex>\n        //#include <project_vertex>\n        \n        vec4 mvPosition = vec4( transformed, 1.0 );\n        mvPosition = modelViewMatrix * mvPosition;\n        gl_Position = projectionMatrix * mvPosition;\n\n        #ifdef USE_2DLINETYPE\n            vLineDistance =  lineDistance;\n        #endif\n        \n        #include <logdepthbuf_vertex>\n        #include <clipping_planes_vertex>\n    \n        #include <worldpos_vertex>\n        #include <envmap_vertex>\n        #include <fog_vertex>\n        \n    }\n    ",fragmentShader:"\n    #ifdef USE_2DLINETYPE\n        varying vec3 vLineDistance;\n    #endif\n\n    #include <common>\n    #include <2D_line_mtl_map_fragment_4v>\n    #include <dithering_pars_fragment>\n    #include <color_pars_fragment>\n    #include <uv_pars_fragment>\n    #include <map_pars_fragment>\n    #include <alphamap_pars_fragment>\n    #include <alphatest_pars_fragment>\n    #include <aomap_pars_fragment>\n    #include <lightmap_pars_fragment>\n    #include <envmap_common_pars_fragment>\n    #include <envmap_pars_fragment>\n    #include <fog_pars_fragment>\n    #include <specularmap_pars_fragment>\n    #include <logdepthbuf_pars_fragment>\n    #include <clipping_planes_pars_fragment>\n    void main() {\n        #include <clipping_planes_fragment>\n        // \n        mesh_id = int(_mesh_id_ + 0.1);\n        //\n        vec4 lineMtl = getLineMtl();\n        float useColor = _usePackColor > 0.0f ? _packColor : lineMtl[0];\n        vec4 diffuseColor = vec4( getColorFromHex(int(useColor+0.1f)), float(lineMtl[1])/1000.0 );\n\n        #ifdef USE_2DLINETYPE\n            #include <2D_line_mtl_map_fragment_linedistacne>\n        #endif\n    \n        #include <logdepthbuf_fragment>\n        #include <map_fragment>\n        #include <color_fragment>\n        #include <alphamap_fragment>\n        #include <alphatest_fragment>\n        #include <specularmap_fragment>\n    \n        ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n    \n        // accumulation (baked indirect lighting only)\n        #ifdef USE_LIGHTMAP\n    \n            vec4 lightMapTexel = texture2D( lightMap, vLightMapUv );\n            reflectedLight.indirectDiffuse += lightMapTexel.rgb * lightMapIntensity * RECIPROCAL_PI;\n    \n        #else\n    \n            reflectedLight.indirectDiffuse += vec3( 1.0 );\n    \n        #endif\n    \n        // modulation\n        #include <aomap_fragment>\n    \n        reflectedLight.indirectDiffuse *= diffuseColor.rgb;\n    \n        vec3 outgoingLight = reflectedLight.indirectDiffuse;\n    \n        #include <envmap_fragment>\n    \n        #include <output_fragment>\n        #include <tonemapping_fragment>\n        #include <encodings_fragment>\n        #include <fog_fragment>\n        #include <premultiplied_alpha_fragment>\n        #include <dithering_fragment>\n \n    }\n    "};var yr=function(o){function e(e,t,r,i,n){var a;return void 0===t&&(t=!1),void 0===r&&(r=!1),void 0===i&&(i=!0),void 0===n&&(n=!0),(a=o.call(this,{type:"NdsBatched2DLineBasicMaterial",uniforms:THREE.UniformsUtils.clone(THREE.ShaderLib.NdsBatched2DLineBasic.uniforms),vertexShader:THREE.ShaderLib.NdsBatched2DLineBasic.vertexShader,fragmentShader:THREE.ShaderLib.NdsBatched2DLineBasic.fragmentShader,clipping:!0})||this).isNdsBatchedLineBasicMaterial=!0,t&&(a.defines={INSTANCE_MESH:""}),r&&(a.defines={BATCHED_MESH:""},a.extensions={multiDraw:!0}),n&&(a.defines.SUPPORT_UNIFORM_BLOCK=""),i&&(a.defines.USE_2DLINETYPE=""),a.setValues(e),a}var t,r;return r=o,(t=e).prototype=Object.create(r.prototype),gr(t.prototype.constructor=t,r),e}(THREE.ShaderMaterial);function Ar(e,t){return(Ar=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}THREE.UniformsLib.NdsBatched2DPoint={bodyWorldMatrixOffset:{value:0},bodyNodeWorldMatrixMap:{value:null},bodyNodeWorldMatrixMapSize:{value:1},meshId:{value:new THREE.Vector2},meshId2BodyIdParam:{value:new THREE.Vector2},meshId2BodyIdMap:{value:null},lineMtlParam:{value:new THREE.Vector2},lineMtlMap:{value:null}},THREE.ShaderLib.NdsBatched2DPoint={uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib.points,THREE.UniformsLib.fog,THREE.UniformsLib.NdsBatched2DPoint]),vertexShader:"\n    //uniform float size;\n    //uniform float scale;\n    #ifdef BATCHED_MESH\n        ivec2 meshId;\n    #else\n        #ifdef INSTANCE_MESH\n            attribute ivec2 meshId;\n        #else\n            uniform ivec2 meshId;\n        #endif\n    #endif\n\n    #include <common>\n    #include <color_pars_vertex>\n    #include <fog_pars_vertex>\n    #include <morphtarget_pars_vertex>\n    #include <logdepthbuf_pars_vertex>\n    #include <clipping_planes_pars_vertex>\n    #include <2D_mesh_modelMatrix_map_vertex>\n\n    #ifdef USE_POINTS_UV\n\n\t    varying vec2 vUv;\n\t    uniform mat3 uvTransform;\n\n    #endif\n\n    void main() {\n\n\t    #ifdef USE_POINTS_UV\n\n\t\t    vUv = ( uvTransform * vec3( uv, 1 ) ).xy;\n\n\t    #endif\n\n        mat4 modelViewMatrix = viewMatrix * getModelMatrix();\n\n\t    #include <color_vertex>\n\t    #include <morphcolor_vertex>\n\t    #include <begin_vertex>\n\t    #include <morphtarget_vertex>\n\t    //#include <project_vertex>\n\n        vec4 mvPosition = vec4( transformed, 1.0 );\n        mvPosition = modelViewMatrix * mvPosition;\n        gl_Position = projectionMatrix * mvPosition;\n\n\t    gl_PointSize = 1.5;\n\n\t    #include <logdepthbuf_vertex>\n\t    #include <clipping_planes_vertex>\n\t    #include <worldpos_vertex>\n\t    #include <fog_vertex>\n\n    }\n    ",fragmentShader:"\n    //uniform vec3 diffuse;\n    //uniform float opacity;\n\n    #include <common>\n    #include <2D_line_mtl_map_fragment>\n    #include <color_pars_fragment>\n    #include <map_particle_pars_fragment>\n    #include <alphatest_pars_fragment>\n    #include <fog_pars_fragment>\n    #include <logdepthbuf_pars_fragment>\n    #include <clipping_planes_pars_fragment>\n\n    void main() {\n\n\t    #include <clipping_planes_fragment>\n        // \n        mesh_id = int(_mesh_id_ + 0.1);\n        //\n        ivec2 lineMtl = getLineMtl();\n        int useColor = _usePackColor > 0.0f ? int(_packColor) : lineMtl[0];\n        vec4 diffuseColor = vec4( getColorFromHex(useColor), float(lineMtl[1])/1000.0 );\n\n\t    vec3 outgoingLight = vec3( 0.0 );\n\t    //vec4 diffuseColor = vec4( diffuse, opacity );\n\n\t    #include <logdepthbuf_fragment>\n\t    #include <map_particle_fragment>\n\t    #include <color_fragment>\n\t    #include <alphatest_fragment>\n\n\t    outgoingLight = diffuseColor.rgb;\n\n\t    #include <output_fragment>\n\t    #include <tonemapping_fragment>\n\t    #include <encodings_fragment>\n\t    #include <fog_fragment>\n\t    #include <premultiplied_alpha_fragment>\n\n    }\n    "};var Mr=function(a){function e(e,t,r,i){var n;return void 0===t&&(t=!1),void 0===r&&(r=!1),void 0===i&&(i=!0),(n=a.call(this,{type:"NdsBatched2DPointMaterial",uniforms:THREE.UniformsUtils.clone(THREE.ShaderLib.NdsBatched2DPoint.uniforms),vertexShader:THREE.ShaderLib.NdsBatched2DPoint.vertexShader,fragmentShader:THREE.ShaderLib.NdsBatched2DPoint.fragmentShader,clipping:!0})||this).isNdsBatched2DPointMaterial=!0,t&&(n.defines={INSTANCE_MESH:""}),r&&(n.defines={BATCHED_MESH:""},n.extensions={multiDraw:!0}),i&&(n.defines.SUPPORT_UNIFORM_BLOCK=""),n.setValues(e),n}var t,r;return r=a,(t=e).prototype=Object.create(r.prototype),Ar(t.prototype.constructor=t,r),e}(THREE.ShaderMaterial);function Er(e,t){return(Er=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}THREE.UniformsLib.NdsBatched2DTextBasic={bodyWorldMatrixOffset:{value:0},bodyNodeWorldMatrixMap:{value:null},bodyNodeWorldMatrixMapSize:{value:1},meshId:{value:new THREE.Vector2},meshId2BodyIdParam:{value:new THREE.Vector2},meshId2BodyIdMap:{value:null},lineMtlParam:{value:new THREE.Vector2},lineMtlMap:{value:null},extraMtlParam:{value:new THREE.Vector2},extraMtlMap:{value:null}},THREE.ShaderLib.NdsBatched2DTextBasic={uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib.common,THREE.UniformsLib.specularmap,THREE.UniformsLib.envmap,THREE.UniformsLib.aomap,THREE.UniformsLib.lightmap,THREE.UniformsLib.fog,THREE.UniformsLib.NdsBatched2DTextBasic]),vertexShader:"\n    #ifdef BATCHED_MESH\n        ivec2 meshId;\n    #else\n        #ifdef INSTANCE_MESH\n            attribute ivec2 meshId;\n        #else\n            uniform ivec2 meshId;\n        #endif\n    #endif\n    #ifdef USE_2DVIEWPORT\n        varying vec2 posxy;\n    #endif\n    //\n    #include <common>\n    #include <uv_pars_vertex>\n    #include <envmap_pars_vertex>\n    #include <color_pars_vertex>\n    #include <fog_pars_vertex>\n    #include <morphtarget_pars_vertex>\n    #include <skinning_pars_vertex>\n    #include <logdepthbuf_pars_vertex>\n    #include <clipping_planes_pars_vertex>\n    #include <2D_mesh_modelMatrix_map_vertex>\n    \n    void main() {\n    \n        #ifdef USE_2DVIEWPORT\n            mat4 modelMatrix = getModelMatrix();\n            mat4 modelViewMatrix = viewMatrix * modelMatrix;\n        #else\n            mat4 modelViewMatrix = viewMatrix * getModelMatrix();\n        #endif\n        \n        #include <uv_vertex>\n\t    #include <color_vertex>\n\t    #include <morphcolor_vertex>\n    \n    \n        #include <begin_vertex>\n        #include <morphtarget_vertex>\n        #include <skinning_vertex>\n        //#include <project_vertex>\n        \n        #ifdef USE_2DVIEWPORT\n            vec4 mvPosition = vec4( transformed, 1.0 );\n            vec4 tmp = modelMatrix * mvPosition;\n            posxy.xy= tmp.xy;\n        #else\n            vec4 mvPosition = vec4( transformed, 1.0 );\n        #endif\n\n        mvPosition = modelViewMatrix * mvPosition;\n        gl_Position = projectionMatrix * mvPosition;\n        \n        #include <logdepthbuf_vertex>\n        #include <clipping_planes_vertex>\n    \n        #include <worldpos_vertex>\n        #include <envmap_vertex>\n        #include <fog_vertex>\n        \n    }\n    ",fragmentShader:"\n    #ifdef USE_2DVIEWPORT\n        varying vec2 posxy;\n    #endif\n\n    #include <common>\n    #include <2D_line_mtl_map_fragment_4v>\n    #include <dithering_pars_fragment>\n    #include <color_pars_fragment>\n    #include <uv_pars_fragment>\n    #include <map_pars_fragment>\n    #include <alphamap_pars_fragment>\n    #include <alphatest_pars_fragment>\n    #include <aomap_pars_fragment>\n    #include <lightmap_pars_fragment>\n    #include <envmap_common_pars_fragment>\n    #include <envmap_pars_fragment>\n    #include <fog_pars_fragment>\n    #include <specularmap_pars_fragment>\n    #include <logdepthbuf_pars_fragment>\n    #include <clipping_planes_pars_fragment>\n    void main() {\n        #include <clipping_planes_fragment>\n        // \n        mesh_id = int(_mesh_id_ + 0.1);\n        //\n        vec4 lineMtl = getLineMtl();\n        float useColor = _usePackColor > 0.0f ? _packColor : lineMtl[0];\n        vec4 diffuseColor = vec4( getColorFromHex(int(useColor+0.1f)), float(lineMtl[1])/1000.0 );\n\n        #ifdef USE_2DVIEWPORT\n            if (lineMtl[2] > -0.1f)\n            {\n                int index = (int(lineMtl[2]+0.1f) + extraMtlParam[0])*16;\n\n                int index_x =  index % extraMtlParam[1];\n                int index_y = index / extraMtlParam[1];\n\n                float minX = texelFetch(extraMtlMap, ivec2(index_x + 0, index_y), 0).x;\n                float minY = texelFetch(extraMtlMap, ivec2(index_x + 1, index_y), 0).x;\n                float maxX = texelFetch(extraMtlMap, ivec2(index_x + 2, index_y), 0).x;\n                float maxY = texelFetch(extraMtlMap, ivec2(index_x + 3, index_y), 0).x;\n\n                if(posxy.x < minX || posxy.x > maxX || posxy.y < minY || posxy.y > maxY){\n                    discard;\n                }\n            }\n        #endif\n    \n        #include <logdepthbuf_fragment>\n        #include <map_fragment>\n        #include <color_fragment>\n        #include <alphamap_fragment>\n        #include <alphatest_fragment>\n        #include <specularmap_fragment>\n    \n        ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n    \n        // accumulation (baked indirect lighting only)\n        #ifdef USE_LIGHTMAP\n    \n            vec4 lightMapTexel = texture2D( lightMap, vLightMapUv );\n            reflectedLight.indirectDiffuse += lightMapTexel.rgb * lightMapIntensity * RECIPROCAL_PI;\n    \n        #else\n    \n            reflectedLight.indirectDiffuse += vec3( 1.0 );\n    \n        #endif\n    \n        // modulation\n        #include <aomap_fragment>\n    \n        reflectedLight.indirectDiffuse *= diffuseColor.rgb;\n    \n        vec3 outgoingLight = reflectedLight.indirectDiffuse;\n    \n        #include <envmap_fragment>\n    \n        #include <output_fragment>\n        #include <tonemapping_fragment>\n        #include <encodings_fragment>\n        #include <fog_fragment>\n        #include <premultiplied_alpha_fragment>\n        #include <dithering_fragment>\n \n    }\n    "};var wr=function(o){function e(e,t,r,i,n){var a;return void 0===t&&(t=!1),void 0===r&&(r=!1),void 0===i&&(i=!0),void 0===n&&(n=!0),(a=o.call(this,{type:"NdsBatched2DTextBasicMaterial",uniforms:THREE.UniformsUtils.clone(THREE.ShaderLib.NdsBatched2DTextBasic.uniforms),vertexShader:THREE.ShaderLib.NdsBatched2DTextBasic.vertexShader,fragmentShader:THREE.ShaderLib.NdsBatched2DTextBasic.fragmentShader,clipping:!0})||this).isNdsBatched2DTextBasicMaterial=!0,t&&(a.defines={INSTANCE_MESH:""}),r&&(a.defines={BATCHED_MESH:""},a.extensions={multiDraw:!0}),n&&(a.defines.SUPPORT_UNIFORM_BLOCK=""),i&&(a.defines.USE_2DVIEWPORT=""),a.setValues(e),a}var t,r;return r=o,(t=e).prototype=Object.create(r.prototype),Er(t.prototype.constructor=t,r),e}(THREE.ShaderMaterial);function xr(e,t){return(xr=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}THREE.UniformsLib.NdsBatched2DTextLineBasic={bodyWorldMatrixOffset:{value:0},bodyNodeWorldMatrixMap:{value:null},bodyNodeWorldMatrixMapSize:{value:1},meshId:{value:new THREE.Vector2},meshId2BodyIdParam:{value:new THREE.Vector2},meshId2BodyIdMap:{value:null},lineMtlParam:{value:new THREE.Vector2},lineMtlMap:{value:null},extraMtlParam:{value:new THREE.Vector2},extraMtlMap:{value:null}},THREE.ShaderLib.NdsBatched2DTextLineBasic={uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib.common,THREE.UniformsLib.specularmap,THREE.UniformsLib.envmap,THREE.UniformsLib.aomap,THREE.UniformsLib.lightmap,THREE.UniformsLib.fog,THREE.UniformsLib.NdsBatched2DTextLineBasic]),vertexShader:"\n    #ifdef BATCHED_MESH\n        ivec2 meshId;\n    #else\n        #ifdef INSTANCE_MESH\n            attribute ivec2 meshId;\n        #else\n            uniform ivec2 meshId;\n        #endif\n    #endif\n    #ifdef USE_2DVIEWPORT\n        varying vec2 posxy;\n    #endif\n    //\n    #include <common>\n    #include <uv_pars_vertex>\n    #include <envmap_pars_vertex>\n    #include <color_pars_vertex>\n    #include <fog_pars_vertex>\n    #include <morphtarget_pars_vertex>\n    #include <skinning_pars_vertex>\n    #include <logdepthbuf_pars_vertex>\n    #include <clipping_planes_pars_vertex>\n    #include <2D_mesh_modelMatrix_map_vertex>\n    \n    void main() {\n    \n        #ifdef USE_2DVIEWPORT\n            mat4 modelMatrix = getModelMatrix();\n            mat4 modelViewMatrix = viewMatrix * modelMatrix;\n        #else\n            mat4 modelViewMatrix = viewMatrix * getModelMatrix();\n        #endif\n        \n        #include <uv_vertex>\n\t    #include <color_vertex>\n\t    #include <morphcolor_vertex>\n    \n    \n        #include <begin_vertex>\n        #include <morphtarget_vertex>\n        #include <skinning_vertex>\n        //#include <project_vertex>\n        \n        vec4 mvPosition = vec4( transformed, 1.0 );\n        #ifdef USE_2DVIEWPORT\n            vec4 tmp = modelMatrix * mvPosition;\n            posxy.xy= tmp.xy;\n        #endif\n\n        mvPosition = modelViewMatrix * mvPosition;\n        gl_Position = projectionMatrix * mvPosition;\n        \n        #include <logdepthbuf_vertex>\n        #include <clipping_planes_vertex>\n    \n        #include <worldpos_vertex>\n        #include <envmap_vertex>\n        #include <fog_vertex>\n        \n    }\n    ",fragmentShader:"\n    #ifdef USE_2DVIEWPORT\n         varying vec2 posxy;\n    #endif\n\n    #include <common>\n    #include <2D_line_mtl_map_fragment_4v>\n    #include <dithering_pars_fragment>\n    #include <color_pars_fragment>\n    #include <uv_pars_fragment>\n    #include <map_pars_fragment>\n    #include <alphamap_pars_fragment>\n    #include <alphatest_pars_fragment>\n    #include <aomap_pars_fragment>\n    #include <lightmap_pars_fragment>\n    #include <envmap_common_pars_fragment>\n    #include <envmap_pars_fragment>\n    #include <fog_pars_fragment>\n    #include <specularmap_pars_fragment>\n    #include <logdepthbuf_pars_fragment>\n    #include <clipping_planes_pars_fragment>\n    void main() {\n        #include <clipping_planes_fragment>\n        // \n        mesh_id = int(_mesh_id_ + 0.1);\n        //\n        vec4 lineMtl = getLineMtl();\n        float useColor = _usePackColor > 0.0f ? _packColor : lineMtl[0];\n        vec4 diffuseColor = vec4( getColorFromHex(int(useColor+0.1f)), float(lineMtl[1])/1000.0 );\n\n        #ifdef USE_2DVIEWPORT\n            if (lineMtl[2] > -0.1f)\n            {\n                int index = (int(lineMtl[2]+0.1f) + extraMtlParam[0])*16;\n\n                int index_x =  index % extraMtlParam[1];\n                int index_y = index / extraMtlParam[1];\n\n                float minX = texelFetch(extraMtlMap, ivec2(index_x + 0, index_y), 0).x;\n                float minY = texelFetch(extraMtlMap, ivec2(index_x + 1, index_y), 0).x;\n                float maxX = texelFetch(extraMtlMap, ivec2(index_x + 2, index_y), 0).x;\n                float maxY = texelFetch(extraMtlMap, ivec2(index_x + 3, index_y), 0).x;\n\n                if(posxy.x < minX || posxy.x > maxX || posxy.y < minY || posxy.y > maxY){\n                    discard;\n                }\n            }\n        #endif\n    \n        #include <logdepthbuf_fragment>\n        #include <map_fragment>\n        #include <color_fragment>\n        #include <alphamap_fragment>\n        #include <alphatest_fragment>\n        #include <specularmap_fragment>\n    \n        ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n    \n        // accumulation (baked indirect lighting only)\n        #ifdef USE_LIGHTMAP\n    \n            vec4 lightMapTexel = texture2D( lightMap, vLightMapUv );\n            reflectedLight.indirectDiffuse += lightMapTexel.rgb * lightMapIntensity * RECIPROCAL_PI;\n    \n        #else\n    \n            reflectedLight.indirectDiffuse += vec3( 1.0 );\n    \n        #endif\n    \n        // modulation\n        #include <aomap_fragment>\n    \n        reflectedLight.indirectDiffuse *= diffuseColor.rgb;\n    \n        vec3 outgoingLight = reflectedLight.indirectDiffuse;\n    \n        #include <envmap_fragment>\n    \n        #include <output_fragment>\n        #include <tonemapping_fragment>\n        #include <encodings_fragment>\n        #include <fog_fragment>\n        #include <premultiplied_alpha_fragment>\n        #include <dithering_fragment>\n \n    }\n    "};var br=function(o){function e(e,t,r,i,n){var a;return void 0===t&&(t=!1),void 0===r&&(r=!1),void 0===i&&(i=!0),void 0===n&&(n=!0),(a=o.call(this,{type:"NdsBatched2DTextLineBasicMaterial",uniforms:THREE.UniformsUtils.clone(THREE.ShaderLib.NdsBatched2DTextLineBasic.uniforms),vertexShader:THREE.ShaderLib.NdsBatched2DTextLineBasic.vertexShader,fragmentShader:THREE.ShaderLib.NdsBatched2DTextLineBasic.fragmentShader,clipping:!0})||this).isNdsBatchedLineBasicMaterial=!0,t&&(a.defines={INSTANCE_MESH:""}),r&&(a.defines={BATCHED_MESH:""},a.extensions={multiDraw:!0}),n&&(a.defines.SUPPORT_UNIFORM_BLOCK=""),i&&(a.defines.USE_2DVIEWPORT=""),a.setValues(e),a}var t,r;return r=o,(t=e).prototype=Object.create(r.prototype),xr(t.prototype.constructor=t,r),e}(THREE.ShaderMaterial);function Br(e,t){return(Br=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}THREE.UniformsLib.NdsBatched2DTextOldBasic={bodyWorldMatrixOffset:{value:0},bodyNodeWorldMatrixMap:{value:null},bodyNodeWorldMatrixMapSize:{value:1},meshId:{value:new THREE.Vector2},meshId2BodyIdParam:{value:new THREE.Vector2},meshId2BodyIdMap:{value:null},lineMtlParam:{value:new THREE.Vector2},lineMtlMap:{value:null},extraMtlParam:{value:new THREE.Vector2},extraMtlMap:{value:null},uSampler0:{value:null},uSampler1:{value:null},uSampler2:{value:null},uSampler3:{value:null},uSampler4:{value:null}},THREE.ShaderLib.NdsBatched2DTextOldBasic={uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib.common,THREE.UniformsLib.specularmap,THREE.UniformsLib.envmap,THREE.UniformsLib.aomap,THREE.UniformsLib.lightmap,THREE.UniformsLib.fog,THREE.UniformsLib.NdsBatched2DTextOldBasic]),vertexShader:"\n    #ifdef BATCHED_MESH\n        ivec2 meshId;\n    #else\n        #ifdef INSTANCE_MESH\n            attribute ivec2 meshId;\n        #else\n            uniform ivec2 meshId;\n        #endif\n    #endif\n\n    attribute float textureid;\n    \n    varying vec2 vUv;\n    varying float vtextureid;\n\n    //\n    #include <common>\n    #include <uv_pars_vertex>\n    #include <envmap_pars_vertex>\n    #include <color_pars_vertex>\n    #include <fog_pars_vertex>\n    #include <morphtarget_pars_vertex>\n    #include <skinning_pars_vertex>\n    #include <logdepthbuf_pars_vertex>\n    #include <clipping_planes_pars_vertex>\n    #include <2D_mesh_modelMatrix_map_vertex>\n    \n    void main() {\n    \n        mat4 modelViewMatrix = viewMatrix * getModelMatrix();\n        \n        #include <uv_vertex>\n\t    #include <color_vertex>\n\t    #include <morphcolor_vertex>\n    \n    \n        #include <begin_vertex>\n        #include <morphtarget_vertex>\n        #include <skinning_vertex>\n        //#include <project_vertex>\n        \n        vec4 mvPosition = vec4( transformed, 1.0 );\n\n        mvPosition = modelViewMatrix * mvPosition;\n        gl_Position = projectionMatrix * mvPosition;\n        \n        #include <logdepthbuf_vertex>\n        #include <clipping_planes_vertex>\n    \n        #include <worldpos_vertex>\n        #include <envmap_vertex>\n        #include <fog_vertex>\n        \n        \n        vUv = uv;\n        vtextureid = textureid;\n    }\n    ",fragmentShader:"\n\n    varying vec2 vUv;\n    varying float vtextureid;\n\n    uniform sampler2D uSampler0;\n    uniform sampler2D uSampler1;\n    uniform sampler2D uSampler2;\n    uniform sampler2D uSampler3;\n    uniform sampler2D uSampler4;\n\n    const float uGamma = 0.0004;\n    const float cBuffer = 0.2;\n\n    #include <common>\n    #include <2D_line_mtl_map_fragment_4v>\n    #include <dithering_pars_fragment>\n    #include <color_pars_fragment>\n    #include <uv_pars_fragment>\n    #include <map_pars_fragment>\n    #include <alphamap_pars_fragment>\n    #include <alphatest_pars_fragment>\n    #include <aomap_pars_fragment>\n    #include <lightmap_pars_fragment>\n    #include <envmap_common_pars_fragment>\n    #include <envmap_pars_fragment>\n    #include <fog_pars_fragment>\n    #include <specularmap_pars_fragment>\n    #include <logdepthbuf_pars_fragment>\n    #include <clipping_planes_pars_fragment>\n    void main() {\n        #include <clipping_planes_fragment>\n        // \n        mesh_id = int(_mesh_id_ + 0.1);\n        //\n        vec4 lineMtl = getLineMtl();\n        float useColor = _usePackColor > 0.0f ? _packColor : lineMtl[0];\n        vec4 diffuseColor = vec4( getColorFromHex(int(useColor+0.1f)), float(lineMtl[1])/1000.0 );\n\n\n        float dist = 0.0;\n        if (vtextureid > -0.5 && vtextureid < 0.5)\n        {\n            dist = texture2D(uSampler0, vUv).a;\n        }\n        if (vtextureid > 0.5 && vtextureid < 1.5)\n        {\n            dist = texture2D(uSampler1, vUv).a;\n        }\n        if (vtextureid > 1.5 && vtextureid < 2.5)\n        {\n            dist = texture2D(uSampler2, vUv).a;\n        }\n        if (vtextureid > 2.5 && vtextureid < 3.5)\n        {\n            dist = texture2D(uSampler3, vUv).a;\n        }\n        if (vtextureid > 3.5 && vtextureid < 4.5)\n        {\n            dist = texture2D(uSampler4, vUv).a;\n        }\n        //diffuseColor.r = dist;\n        //diffuseColor.g = 0.0;\n        //diffuseColor.b = 0.0;\n        diffuseColor.a = smoothstep(cBuffer - uGamma, cBuffer + uGamma, dist);\n\n        gl_FragColor = diffuseColor;\n\n        // #include <logdepthbuf_fragment>\n        // #include <map_fragment>\n        // #include <color_fragment>\n        // #include <alphamap_fragment>\n        // #include <alphatest_fragment>\n        // #include <specularmap_fragment>\n    \n        // ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n    \n        // // accumulation (baked indirect lighting only)\n        // #ifdef USE_LIGHTMAP\n    \n        //     vec4 lightMapTexel = texture2D( lightMap, vLightMapUv );\n        //     reflectedLight.indirectDiffuse += lightMapTexel.rgb * lightMapIntensity * RECIPROCAL_PI;\n    \n        // #else\n    \n        //     reflectedLight.indirectDiffuse += vec3( 1.0 );\n    \n        // #endif\n    \n        // // modulation\n        // #include <aomap_fragment>\n    \n        // reflectedLight.indirectDiffuse *= diffuseColor.rgb;\n    \n        // vec3 outgoingLight = reflectedLight.indirectDiffuse;\n    \n        // #include <envmap_fragment>\n    \n        // #include <output_fragment>\n        // #include <tonemapping_fragment>\n        // #include <encodings_fragment>\n        // #include <fog_fragment>\n        // #include <premultiplied_alpha_fragment>\n        // #include <dithering_fragment>\n \n    }\n    "};var Ir=function(a){function e(e,t,r,i){var n;return void 0===t&&(t=!1),void 0===r&&(r=!1),void 0===i&&(i=!0),(n=a.call(this,{type:"NdsBatched2DTextOldBasicMaterial",uniforms:THREE.UniformsUtils.clone(THREE.ShaderLib.NdsBatched2DTextOldBasic.uniforms),vertexShader:THREE.ShaderLib.NdsBatched2DTextOldBasic.vertexShader,fragmentShader:THREE.ShaderLib.NdsBatched2DTextOldBasic.fragmentShader,clipping:!0})||this).isNdsBatched2DTextOldBasicMaterial=!0,t&&(n.defines={INSTANCE_MESH:""}),r&&(n.defines={BATCHED_MESH:""},n.extensions={multiDraw:!0}),i&&(n.defines.SUPPORT_UNIFORM_BLOCK=""),n.setValues(e),n}var t,r;return r=a,(t=e).prototype=Object.create(r.prototype),Br(t.prototype.constructor=t,r),e}(THREE.ShaderMaterial);function Tr(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,function(e){e=function(e,t){if("object"!=typeof e||!e)return e;var r=e[Symbol.toPrimitive];if(void 0===r)return("string"===t?String:Number)(e);r=r.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}(e,"string");return"symbol"==typeof e?e:e+""}(i.key),i)}}function Sr(e,t){return(Sr=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}THREE.UniformsLib.NdsBatched2DLine2Basic={bodyWorldMatrixOffset:{value:0},bodyNodeWorldMatrixMap:{value:null},bodyNodeWorldMatrixMapSize:{value:1},meshId:{value:new THREE.Vector2},meshId2BodyIdParam:{value:new THREE.Vector2},meshId2BodyIdMap:{value:null},lineMtlParam:{value:new THREE.Vector2},lineMtlMap:{value:null},extraMtlParam:{value:new THREE.Vector2},extraMtlMap:{value:null},resolution:{value:new THREE.Vector2(1,1)}},THREE.ShaderLib.NdsBatched2DLine2Basic={uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib.common,THREE.UniformsLib.specularmap,THREE.UniformsLib.envmap,THREE.UniformsLib.aomap,THREE.UniformsLib.lightmap,THREE.UniformsLib.fog,THREE.UniformsLib.NdsBatched2DLine2Basic]),vertexShader:"\n    #ifdef BATCHED_MESH\n        ivec2 meshId;\n    #else\n        #ifdef INSTANCE_MESH\n            attribute ivec2 meshId;\n        #else\n            uniform ivec2 meshId;\n        #endif\n    #endif\n    //\n    uniform vec2 resolution;\n    //\n\tattribute vec3 instanceStart;\n\tattribute vec3 instanceEnd;\n    attribute vec4 instanceDistance;\n    attribute vec2 instanceWidth;\n    //\n    varying float vLineWidth;\n    varying vec3 vLineDistance;\n    varying vec2 vUv;\n    #ifdef USE_WORLDUNIT\n\t\tvarying vec4 worldPos;\n\t\tvarying vec3 worldStart;\n\t\tvarying vec3 worldEnd;\n    #endif\n    //\n    #include <common>\n    #include <uv_pars_vertex>\n    #include <envmap_pars_vertex>\n    #include <color_pars_vertex>\n    #include <fog_pars_vertex>\n    #include <morphtarget_pars_vertex>\n    #include <skinning_pars_vertex>\n    #include <logdepthbuf_pars_vertex>\n    #include <clipping_planes_pars_vertex>\n    #include <2D_mesh_modelMatrix_map_vertex>\n\n    void main() {\n\n        mat4 modelMatrix = getModelMatrix();\n        mat4 modelViewMatrix = viewMatrix * modelMatrix;\n\n        #include <uv_vertex>\n\t    #include <color_vertex>\n\t    #include <morphcolor_vertex>\n\n\n        #include <begin_vertex>\n        #include <morphtarget_vertex>\n        #include <skinning_vertex>\n        //#include <project_vertex>\n\n        //\n        vLineWidth = ( position.y < 0.5 ) ?  instanceWidth[0] :  instanceWidth[1];\n        vLineDistance[0] = ( position.y < 0.5 ) ?  instanceDistance[0] :  instanceDistance[1];\n        vLineDistance[1] = instanceDistance[2];\n        vLineDistance[2] = instanceDistance[3];\n\t\tvUv = uv;\n\n        float aspect = resolution.x / resolution.y;\n\n        vec4 start = modelViewMatrix * vec4( instanceStart, 1.0 );\n        vec4 end = modelViewMatrix * vec4( instanceEnd, 1.0 );\n\n        // clip space\n\t\tvec4 clipStart = projectionMatrix * start;\n\t\tvec4 clipEnd = projectionMatrix * end;\n\n\t\t// ndc space\n\t\tvec3 ndcStart = clipStart.xyz / clipStart.w;\n\t\tvec3 ndcEnd = clipEnd.xyz / clipEnd.w;\n\n\t\t// direction\n\t\tvec2 dir = ndcEnd.xy - ndcStart.xy;\n\n\t\t// account for clip-space aspect ratio\n\t\tdir.x *= aspect;\n\t\tdir = normalize( dir );\n\n        #ifdef USE_WORLDUNIT\n            // 世界坐标系宽度   \n            worldStart = start.xyz;\n\t\t\tworldEnd = end.xyz;\n\n            // get the offset direction as perpendicular to the view vector\n\t\t\tvec3 worldDir = normalize( end.xyz - start.xyz);\n\t\t\tvec3 offset;\n\t\t\tif ( position.y < 0.5 ) {\n\t\t\t\toffset = normalize( cross( start.xyz, worldDir ) );\n\t\t\t} else {\n\t\t\t\toffset = normalize( cross( end.xyz, worldDir ) );\n\t\t\t}\n\n            // sign flip\n\t\t\tif ( position.x < 0.0 ) offset *= - 1.0;\n\n            vec4 lenModel = modelMatrix * vec4(vLineWidth,0.0,0.0,0.0);\n            vLineWidth = length(lenModel.xyz);\n\n            float forwardOffset = dot( worldDir, vec3( 0.0, 0.0, 1.0 ) );\n\n\t\t\t// don't extend the line if we're rendering dashes because we\n\t\t\t// won't be rendering the endcaps\n\t\t\tif(instanceDistance[0] > 0.1f && vLineDistance[0] != vLineDistance[1] || vLineDistance[2] > 1.0f){\n\t\t\t\t// extend the line bounds to encompass  endcaps\n\n\t\t\t\tstart.xyz += - worldDir * vLineWidth * 0.5;\n\t\t\t\tend.xyz += worldDir * vLineWidth * 0.5;\n\n                // shift the position of the quad so it hugs the forward edge of the line\n\n\t\t\t\toffset.xy -= dir * forwardOffset;\n\t\t\t\toffset.z += 0.5;\n            }\n\n\t\t\t// endcaps\n\t\t\tif ( position.y > 1.0 || position.y < 0.0 ) {\n\t\t\t\toffset.xy += dir * 2.0 * forwardOffset;\n\t\t\t}\n            \n            // adjust for linewidth\n\t\t\toffset *= vLineWidth * 0.5;\n\n            // set the world position\n\t\t\tworldPos = ( position.y < 0.5 ) ? start : end;\n\t\t\tworldPos.xyz += offset;\n\n\t\t\t// project the worldpos\n\t\t\tvec4 clip = projectionMatrix * worldPos;\n\n            // shift the depth of the projected points so the line\n\t\t    // segments overlap neatly\n\t\t\tvec3 clipPose = ( position.y < 0.5 ) ? ndcStart : ndcEnd;\n\t\t\tclip.z = clipPose.z * clip.w;\n\n        #else\n            // 像素宽度\n\t\t\tvec2 offset = vec2( dir.y, - dir.x );\n\n\t\t\t// undo aspect ratio adjustment\n\t\t\tdir.x /= aspect;\n\t\t\toffset.x /= aspect;\n\n\t\t\t// sign flip\n\t\t\tif ( position.x < 0.0 ) offset *= - 1.0;\n\n\t\t\t// endcaps\n\t\t\tif ( position.y < 0.0 ) {\n\t\t\t\toffset += - dir;\n\t\t\t} else if ( position.y > 1.0 ) {\n\t\t\t\toffset += dir;\n\t\t\t}\n\n\t\t\t// adjust for linewidth\n\t\t\toffset *= vLineWidth;\n\n\t\t\t// adjust for clip-space to screen-space conversion // maybe resolution should be based on viewport ...\n\t\t\toffset /= resolution.y;\n\n\t\t\t// select end\n\t\t\tvec4 clip = ( position.y < 0.5 ) ? clipStart : clipEnd;\n\n\t\t\t// back to clip space\n\t\t\toffset *= clip.w;\n\n\t\t\tclip.xy += offset;\n        #endif\n\n\t\tgl_Position = clip;\n\t\tvec4 mvPosition = ( position.y < 0.5 ) ? start : end; // this is an approximation\n\n        #include <logdepthbuf_vertex>\n        #include <clipping_planes_vertex>\n    \n        #include <worldpos_vertex>\n        #include <envmap_vertex>\n        #include <fog_vertex>\n    }\n    ",fragmentShader:"\n    varying vec3 vLineDistance;\n    varying vec2 vUv;\n\n    #ifdef USE_WORLDUNIT\n\t\tvarying vec4 worldPos;\n\t\tvarying vec3 worldStart;\n\t\tvarying vec3 worldEnd;\n        varying float vLineWidth;\n        vec2 closestLineToLine(vec3 p1, vec3 p2, vec3 p3, vec3 p4) {\n\n\t\t\tfloat mua;\n\t\t\tfloat mub;\n\n\t\t\tvec3 p13 = p1 - p3;\n\t\t\tvec3 p43 = p4 - p3;\n\n\t\t\tvec3 p21 = p2 - p1;\n\n\t\t\tfloat d1343 = dot( p13, p43 );\n\t\t\tfloat d4321 = dot( p43, p21 );\n\t\t\tfloat d1321 = dot( p13, p21 );\n\t\t\tfloat d4343 = dot( p43, p43 );\n\t\t\tfloat d2121 = dot( p21, p21 );\n\n\t\t\tfloat denom = d2121 * d4343 - d4321 * d4321;\n\n\t\t\tfloat numer = d1343 * d4321 - d1321 * d4343;\n\n\t\t\tmua = numer / denom;\n\t\t\tmua = clamp( mua, 0.0, 1.0 );\n\t\t\tmub = ( d1343 + d4321 * ( mua ) ) / d4343;\n\t\t\tmub = clamp( mub, 0.0, 1.0 );\n\n\t\t\treturn vec2( mua, mub );\n\n\t\t}\n    #endif\n\n    #include <common>\n    #include <2D_line_mtl_map_fragment_4v>\n    #include <dithering_pars_fragment>\n    #include <color_pars_fragment>\n    #include <uv_pars_fragment>\n    #include <map_pars_fragment>\n    #include <alphamap_pars_fragment>\n    #include <alphatest_pars_fragment>\n    #include <aomap_pars_fragment>\n    #include <lightmap_pars_fragment>\n    #include <envmap_common_pars_fragment>\n    #include <envmap_pars_fragment>\n    #include <fog_pars_fragment>\n    #include <specularmap_pars_fragment>\n    #include <logdepthbuf_pars_fragment>\n    #include <clipping_planes_pars_fragment>\n    void main() {\n        #include <clipping_planes_fragment>\n        // \n        mesh_id = int(_mesh_id_ + 0.1);\n        //\n        vec4 lineMtl = getLineMtl();\n        float useColor = _usePackColor > 0.0f ? _packColor : lineMtl[0];\n        vec4 diffuseColor = vec4( getColorFromHex(int(useColor+0.1f)), float(lineMtl[1])/1000.0 );\n\n        if ( abs( vUv.y ) > 1.0 ) {\n\t\t\tfloat a = vUv.x;\n\t\t\tfloat b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;\n\t\t\tfloat len2 = a * a + b * b;\n\t\t\tif ( len2 > 1.0 ) discard;\n        }\n\n        #ifdef USE_WORLDUNIT\n\n            if (lineMtl[2] < -0.1f){\n                // Find the closest points on the view ray and the line segment\n                vec3 rayEnd = normalize( worldPos.xyz ) * 1e9;\n                vec3 lineDir = worldEnd - worldStart;\n                vec2 params = closestLineToLine( worldStart, worldEnd, vec3( 0.0, 0.0, 0.0 ), rayEnd );\n\n                vec3 p1 = worldStart + lineDir * params.x;\n                vec3 p2 = rayEnd * params.y;\n                vec3 delta = p1 - p2;\n                float len = length( delta );\n                float norm = len / vLineWidth;\n\n                if ( norm > 0.5 ) {\n                    discard;\n                }\n            }\n        #endif\n\n        //#ifdef USE_2DLINETYPE\n        #include <2D_line_mtl_map_fragment_linedistacne>\n        //#endif\n\n        #include <logdepthbuf_fragment>\n        #include <map_fragment>\n        #include <color_fragment>\n        #include <alphamap_fragment>\n        #include <alphatest_fragment>\n        #include <specularmap_fragment>\n    \n        ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n    \n        // accumulation (baked indirect lighting only)\n        #ifdef USE_LIGHTMAP\n    \n            vec4 lightMapTexel = texture2D( lightMap, vLightMapUv );\n            reflectedLight.indirectDiffuse += lightMapTexel.rgb * lightMapIntensity * RECIPROCAL_PI;\n    \n        #else\n    \n            reflectedLight.indirectDiffuse += vec3( 1.0 );\n    \n        #endif\n    \n        // modulation\n        #include <aomap_fragment>\n    \n        reflectedLight.indirectDiffuse *= diffuseColor.rgb;\n    \n        vec3 outgoingLight = reflectedLight.indirectDiffuse;\n    \n        #include <envmap_fragment>\n    \n        #include <output_fragment>\n        #include <tonemapping_fragment>\n        #include <encodings_fragment>\n        #include <fog_fragment>\n        #include <premultiplied_alpha_fragment>\n        #include <dithering_fragment>\n \n    }\n    "};function Rr(e){var d=this,B=this.baseRenderer=e;this.supportLargeUniformBuffer=65536<=B.maxSupportUniformBufferSize,this.ndsMaterials=[],this.render=function(e,t,r,i){var n;if(e.modelVisible&&(d.MCAD_InitMaterial(e,d.baseRenderer.supportMultiDraw,!d.baseRenderer.supportMultiDraw),e.viewer.modelContentVersion<=3&&e.SDFMaker&&(n=[d.ndsMaterials[c.MU_TTF]],d.baseRenderer.supportMultiDraw||n.push(d.ndsMaterials[c.S_TTF]),e.SDFMaker.OldTextUpdateTextures(n)),void 0!==e.renderOnce&&!e.lineSegmentsSet.dirty||(e.renderOnce=!0),e.hasrenderMesh=!1,e.renderOnce)){e.meshManager.renderContext=B.renderContext,e.geomManager.renderContext=B.renderContext,B._current_model_data_version_=e.dataVersion;e.sptIndex.lines;e.needsFastRendering&&(i/=1.2),e.forceRenderAll&&(e.forceRenderAll=!(i=500));var a=e.getMeshSets(),o=[];0===a.length&&0;for(var s=0;s<a.length;++s){var l=a[s];l.isLoaded()&&l.needAllMeshSetDraw()&&(l.prepareForBatchDraw(),o.push(s))}for(;!((i=d.MCAD_RenderMeshSet(e,t,r,i,"mapMesh"))<=0)&&!((i=d.MCAD_RenderMeshSet(e,t,r,i,"opaque"))<=0)&&!((i=d.MCAD_RenderMeshSet(e,t,r,i,"line"))<=0)&&!((i=d.MCAD_RenderMeshSet(e,t,r,i,"ttf"))<=0)&&!((i=d.MCAD_RenderMeshSet(e,t,r,i,"shx"))<=0)&&!((i=d.MCAD_RenderMeshSet(e,t,r,i,"ltMesh"))<=0)&&!((i=d.MCAD_RenderMeshSet(e,t,r,i,"ltLine"))<=0)&&!((i=d.MCAD_RenderMeshSet(e,t,r,i,"ltPoint"))<=0)&&!((i=d.MCAD_RenderMeshSet(e,t,r,i,"point"))<=0)&&!((i=d.MCAD_RenderMeshSet(e,t,r,i,"line2World"))<=0)&&(e.viewer.showLineWidth&&(i=d.MCAD_RenderMeshSet(e,t,r,i,"line2Mesh")),0););return i}},this.MCAD_RenderMeshSet=function(e,t,r,i,n){for(var a=e.getMeshSets(),o=[],s=0;s<a.length;++s){var l=a[s];l.isLoaded()&&l.needAllMeshSetDraw(n)&&o.push(s)}for(var d=!0;;){for(var d=!0,c=0,h=o.length;c<h;++c){var u=a[o[c]];if(!u.drawAllMeshSet(n)&&(i=B.supportMultiDraw?"line2Mesh"===n||"line2World"===n?this.MCAD_RenderMCAD2DMeshSetMultiDrawLine2(u,e,t,r,i,0,n):this.MCAD_RenderMCAD2DMeshSetMultiDraw(u,e,t,r,i,0,n):"line2Mesh"===n||"line2World"===n?this.MCAD_RenderMCAD2DMeshSetDrawLine2(u,e,t,r,i,0,n):this.MCAD_RenderMCAD2DMeshSetDraw(u,e,t,r,i,0,n),u.drawAllMeshSet(n)||(d=!1),u.visualStates.dirty=!1,B.enableProgressiveRender&&i<=0?(i=0,B.stopRenderingEarly=!0):B.stopRenderingEarly=!1))break}if(d||i<=0)break}return i},this.MCAD_InitMaterial=function(e,t,r){if(!(0<this.ndsMaterials.length)){var i={polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1},e=3<e.viewer.modelContentVersion;if(this.ndsMaterials[c.MU_MESH]=new mr(i,r,t,!1,this.supportLargeUniformBuffer),this.ndsMaterials[c.MU_MESHMAP]=new mr(i,r,t,!0,this.supportLargeUniformBuffer),this.ndsMaterials[c.MU_LINE]=new yr({},r,t,!1,this.supportLargeUniformBuffer),this.ndsMaterials[c.MU_LINETYPE]=new yr({},r,t,!0,this.supportLargeUniformBuffer),this.ndsMaterials[c.MU_LINE2PIEXL]=new Pr({},r,t,!1,this.supportLargeUniformBuffer),this.ndsMaterials[c.MU_LINE2WORLD]=new Pr({},r,t,!0,this.supportLargeUniformBuffer),this.ndsMaterials[c.MU_SHX]=new br({},r,t,!0,this.supportLargeUniformBuffer),this.ndsMaterials[c.MU_TTF]=e?new wr({},r,t,!0,this.supportLargeUniformBuffer):new Ir({transparent:!0,depthWrite:!1,side:THREE.DoubleSide},r,t,this.supportLargeUniformBuffer),this.ndsMaterials[c.MU_POINT]=new Mr({},r,t,this.supportLargeUniformBuffer),t){this.drawId2MeshIdUniformBlock||(this.drawId2MeshIdUniformBlock=new THREE.UniformsGroup,this.drawId2MeshIdUniformBlock.setName("drawId2MeshIdData"),this.drawId2MeshIdUniformBlock.add(new THREE.Uniform(new Int32Array(1024))),this.drawId2MeshIdUniformBlock.usage=THREE.DynamicDrawUsage);for(var n=0;n<this.ndsMaterials.length;n++)this.ndsMaterials[n].uniformsGroups=[this.drawId2MeshIdUniformBlock]}else this.ndsMaterials[c.S_MESH]=new mr(i,!1,!1,!1,this.supportLargeUniformBuffer),this.ndsMaterials[c.S_MESHMAP]=new mr(i,!1,!1,!0,this.supportLargeUniformBuffer),this.ndsMaterials[c.S_LINE]=new yr({},!1,!1,!1,this.supportLargeUniformBuffer),this.ndsMaterials[c.S_LINETYPE]=new yr({},!1,!1,!0,this.supportLargeUniformBuffer),this.ndsMaterials[c.S_LINE2PIEXL]=new Pr({},!1,!1,!1,this.supportLargeUniformBuffer),this.ndsMaterials[c.S_LINE2WORLD]=new Pr({},!1,!1,!0,this.supportLargeUniformBuffer),this.ndsMaterials[c.S_SHX]=new br({},!1,!1,!0,this.supportLargeUniformBuffer),this.ndsMaterials[c.S_TTF]=e?new wr({},!1,!1,!0,this.supportLargeUniformBuffer):new Ir({transparent:!0,depthWrite:!1,side:THREE.DoubleSide},!1,!1,this.supportLargeUniformBuffer),this.ndsMaterials[c.S_POINT]=new Mr({},!1,!1,this.supportLargeUniformBuffer)}},this.MCAD_UpdateRenderPassMaterial=function(e,t,r,i,n){switch(i){case"line":case"line2Mesh":case"line2World":case"ltMesh":case"ltMesh_line":case"ltLine":case"ltPoint":this.MCAD_UpdateMaterialMeshId(e,t.lineOffset,r.lineId2BodyIdTexSize,r.lineId2BodyIdTexture),this.MCAD_UpdateMateriallineMtl(e,t.lineOffset,r.meshState.lineMtlTexSize,r.meshState.lineMtlTexture),this.MCAD_UpdateMaterialExtraMtl(e,r.meshState.extraMtlLineCount,r.meshState.extraMtlTexSize,r.meshState.extraMtlTexture);break;case"mapMesh":case"opaque":this.MCAD_UpdateMaterialMeshId(e,t.meshOffset,r.meshId2BodyIdTexSize,r.meshId2BodyIdTexture),this.MCAD_UpdateMateriallineMtl(e,t.meshOffset,r.meshState.meshMtlTexSize,r.meshState.meshMtlTexture),this.MCAD_UpdateMaterialExtraMtl(e,r.meshState.extraMtlLineCount,r.meshState.extraMtlTexSize,r.meshState.extraMtlTexture);break;case"ttf":case"ttf_line":case"shx":this.MCAD_UpdateMaterialMeshId(e,t.textOffset,r.textId2BodyIdTexSize,r.textId2BodyIdTexture),this.MCAD_UpdateMateriallineMtl(e,t.textOffset,r.meshState.textMtlTexSize,r.meshState.textMtlTexture),this.MCAD_UpdateMaterialExtraMtl(e,r.meshState.extraMtlLineCount,r.meshState.extraMtlTexSize,r.meshState.extraMtlTexture);break;case"point":this.MCAD_UpdateMaterialMeshId(e,t.pointOffset,r.pointId2BodyIdTexSize,r.pointId2BodyIdTexture),this.MCAD_UpdateMateriallineMtl(e,t.pointOffset,r.meshState.pointMtlTexSize,r.meshState.pointMtlTexture)}n?this.supportLargeUniformBuffer?e.uniformsGroups=[e.uniformsGroups[0],t.bodyWorldMatrixUniformBlock]:(e.uniformsGroups=[e.uniformsGroups[0]],e.uniforms.bodyNodeWorldMatrixMap.value=t.bodyWorldMatrixUniformMap,e.uniforms.bodyNodeWorldMatrixMapSize.value=t.bodyWorldMatrixUniformMapSize):this.supportLargeUniformBuffer?e.uniformsGroups=[t.bodyWorldMatrixUniformBlock]:(e.uniforms.bodyNodeWorldMatrixMap.value=t.bodyWorldMatrixUniformMap,e.uniforms.bodyNodeWorldMatrixMapSize.value=t.bodyWorldMatrixUniformMapSize),e.uniforms.bodyWorldMatrixOffset.value=t.bodyWorldMatrixOffset,e.uniformsNeedUpdate=!0,e.uniforms.needsUpdate=!0},this.MCAD_UpdateMaterialMeshId=function(e,t,r,i){e.uniforms.meshId2BodyIdParam.value.x=t,e.uniforms.meshId2BodyIdParam.value.y=r,e.uniforms.meshId2BodyIdMap.value=i},this.MCAD_UpdateMateriallineMtl=function(e,t,r,i){e.uniforms.lineMtlParam.value.x=t,e.uniforms.lineMtlParam.value.y=r,e.uniforms.lineMtlMap.value=i},this.MCAD_UpdateMaterialExtraMtl=function(e,t,r,i){e.uniforms.extraMtlParam&&(e.uniforms.extraMtlParam.value.x=t,e.uniforms.extraMtlParam.value.y=r,e.uniforms.extraMtlMap.value=i)},this.MCAD_UpdapteMaterialResolution=function(e,t){var r;e.viewer.viewManager?(e=B.colorTarget.viewport.z,r=B.colorTarget.viewport.w,t.resolution.set(e,r)):(e=B.getPixelRatio(),r=B.domElement.width/e,e=B.domElement.height/e,t.resolution.set(r,e))},this.MCAD_GetRenderObject=function(e,t,r){var i=null;return(r=void 0===r?!0:r)?(i=e.meshManager.batchedLineSegments,"point"===t||"ltPoint"===t?i=e.meshManager.batchedPoint:"opaque"!==t&&"ttf"!==t&&"ltMesh"!==t&&"mapMesh"!==t||(i=e.meshManager.batchedMesh),"line2Mesh"===t||"line2World"===t?(i=e.meshManager.batchedLine2Segments)._multiDrawStarts||(i._multiDrawStarts=new Int32Array(1024),i._multiDrawCounts=new Int32Array(1024),i._multiDrawInstanceCounts=new Int32Array(512)):i._multiDrawStarts||(i._multiDrawStarts=new Int32Array(1024),i._multiDrawCounts=new Int32Array(1024))):(i=e.meshManager.lineSegments,"point"===t||"ltPoint"===t?i=e.meshManager.points:"opaque"===t||"ttf"===t||"ltMesh"===t||"mapMesh"===t?i=e.meshManager.mesh:"line2Mesh"!==t&&"line2World"!==t||(i=e.meshManager.lineSegments2)),i},this.MCAD_GetRenderMaterial=function(e,t,r,i,n){void 0===n&&(n=!1);var a,n=(i=void 0===i?!0:i)||n,o=null;return"line"===r?(a=n?c.MU_LINETYPE:c.S_LINETYPE,o=this.ndsMaterials[a]):"line2Mesh"===r?(a=n?c.MU_LINE2PIEXL:c.S_LINE2PIEXL,o=this.ndsMaterials[a],this.MCAD_UpdapteMaterialResolution(t,o)):"line2World"===r?(a=n?c.MU_LINE2WORLD:c.S_LINE2WORLD,o=this.ndsMaterials[a],this.MCAD_UpdapteMaterialResolution(t,o)):"ltMesh"===r?o=t.viewer.modelContentVersion<=3?(a=n?c.MU_TTF:c.S_TTF,this.ndsMaterials[a]):(a=n?c.MU_LINE:c.S_LINE,this.ndsMaterials[a]):"ltMesh_line"===r||"ltLine"===r?(a=n?c.MU_LINE:c.S_LINE,o=this.ndsMaterials[a]):"point"===r||"ltPoint"===r?(a=n?c.MU_POINT:c.S_POINT,o=this.ndsMaterials[a]):"mapMesh"===r?(o=this.batched2DBasicMtl,a=n?c.MU_MESHMAP:c.S_MESHMAP,o=this.ndsMaterials[a]):"opaque"===r?(o=this.batched2DHatchBasicMtl,a=n?c.MU_MESH:c.S_MESH,o=this.ndsMaterials[a]):"ttf"===r?(a=n?c.MU_TTF:c.S_TTF,o=this.ndsMaterials[a]):"ttf_line"!==r&&"shx"!==r||(a=n?c.MU_SHX:c.S_SHX,o=this.ndsMaterials[a]),this.MCAD_UpdateRenderPassMaterial(o,e,t,r,i),o},this.MCAD_GetBatchedObjects=function(e,t,r,i){void 0===i&&(i=512);var n=[];return"line"===r?e.fetchLineForDraw(n,i):"point"===r?e.fetchPointForDraw(n,i):"opaque"===r?e.fetchOpaqueForDraw(n,t,i):"ttf"===r?e.fetchTTFTextForDraw(n,i):"shx"===r?e.fetchSHXTextForDraw(n,i):"ltMesh"===r?e.fetchLTMeshForDraw(n,i):"ltLine"===r?e.fetchLTLineForDraw(n,i):"ltPoint"===r?e.fetchLTPointForDraw(n,i):"line2Mesh"===r?e.fetchLine2MeshForDraw(n,i):"line2World"===r?e.fetchLine2WorldForDraw(n,[],i):"mapMesh"===r?e.fetchMapMeshForDraw(n,i):console.log("Get batchedObjects failed ",r),n},this.MCAD_RenderMCAD2DMeshSetMultiDraw=function(e,t,r,i,n,a,o){void 0===o&&(o="opaque");var s=performance.now(),l=this.MCAD_GetBatchedObjects(e,a,o);if(0!==l.length){if(3<t.viewer.modelContentVersion&&("ttf"===o||"ltMesh"===o)){for(var d=this.MCAD_GetRenderObject(t,"line",!0),a=this.MCAD_GetRenderMaterial(e,t,o+"_line",!0,!1),c=this.drawId2MeshIdUniformBlock.uniforms[0],h=l[0].geometry.textWireFrame,u=h.index.array.BYTES_PER_ELEMENT,p=0;p<l.length;++p)d._multiDrawStarts[p]=l[p].geometry.textWireFrame.drawRange.start*u,d._multiDrawCounts[p]=l[p].geometry.textWireFrame.drawRange.count,c.value[2*p]=l[p].localIndex,c.value[2*p+1]=l[p].material.packColor;c.needsUpdate=!0,this.drawId2MeshIdUniformBlock.needsUpdate=!0,d._multiDrawCount=l.length,d.geometry=h,d.material=a,B.renderMeshDirect(i,r,d,null)}var f=this.MCAD_GetRenderObject(t,o,!0),m=this.MCAD_GetRenderMaterial(e,t,o,!0,!1),g=this.drawId2MeshIdUniformBlock.uniforms[0],h=l[0].geometry,v=h.index.array.BYTES_PER_ELEMENT;if("mapMesh"===o)for(var y=0;y<l.length;++y)f._multiDrawStarts[0]=l[y].geometry.drawRange.start*v,f._multiDrawCounts[0]=l[y].geometry.drawRange.count,g.value[0]=l[y].localIndex,g.value[1]=l[y].material.packColor,g.needsUpdate=!0,this.drawId2MeshIdUniformBlock.needsUpdate=!0,m.uniforms.pictureMtlMap.value=l[y].material.map,m.uniforms.pictureMtlMap.needsUpdate=!0,m.uniformsNeedUpdate=!0,m.uniforms.needsUpdate=!0,f._multiDrawCount=1,f.geometry=l[y].geometry,f.material=m,B.renderMeshDirect(i,r,f,null);else{for(var A=0;A<l.length;++A)f._multiDrawStarts[A]=l[A].geometry.drawRange.start*v,f._multiDrawCounts[A]=l[A].geometry.drawRange.count,g.value[2*A]=l[A].localIndex,g.value[2*A+1]=l[A].material.packColor;g.needsUpdate=!0,this.drawId2MeshIdUniformBlock.needsUpdate=!0,f._multiDrawCount=l.length,f.geometry=h,f.material=m,B.renderMeshDirect(i,r,f,null)}n-=performance.now()-s}return n},this.MCAD_RenderMCAD2DMeshSetMultiDrawLine2=function(e,t,r,i,n,a,o){void 0===o&&(o="opaque");var s=performance.now(),l=[],d=[];if("line2Mesh"===o?e.fetchLine2MeshForDraw(l,512):"line2World"===o&&e.fetchLine2WorldForDraw(l,d,512),0!==l.length){if(0<d.length){for(var c=this.MCAD_GetRenderObject(t,"line",!0),h=this.MCAD_GetRenderMaterial(e,t,"line",!0,!1),u=this.drawId2MeshIdUniformBlock.uniforms[0],p=d[0].geometry,f=p.index.array.BYTES_PER_ELEMENT,m=0;m<d.length;++m)c._multiDrawStarts[m]=d[m].geometry.drawRange.start*f,c._multiDrawCounts[m]=d[m].geometry.drawRange.count,u.value[2*m]=d[m].localIndex,u.value[2*m+1]=d[m].material.packColor;u.needsUpdate=!0,this.drawId2MeshIdUniformBlock.needsUpdate=!0,c._multiDrawCount=d.length,c.geometry=p,c.material=h,B.renderMeshDirect(i,r,c,null)}for(var g=this.MCAD_GetRenderObject(t,o,!0),v=this.MCAD_GetRenderMaterial(e,t,o,!0,!1),y=this.drawId2MeshIdUniformBlock.uniforms[0],A=0;A<l.length;){for(var M=l[A].geometry,E=M.LSKey,w=M.index.array.BYTES_PER_ELEMENT,x=0,b=A;b<l.length&&E===l[b].geometry.LSKey;b++)g._multiDrawStarts[x]=l[b].geometry.drawRange.start*w,g._multiDrawCounts[x]=l[b].geometry.drawRange.count,g._multiDrawInstanceCounts[x]=l[b].count,y.value[2*x]=l[b].localIndex,y.value[2*x+1]=l[b].material.packColor,x++;y.needsUpdate=!0,this.drawId2MeshIdUniformBlock.needsUpdate=!0,g._multiDrawCount=x,g.geometry=M,g.material=v,B.renderMeshDirect(i,r,g,null),A+=x}n-=performance.now()-s}return n},this.MCAD_SplitBactchedObjects=function(e,t,r){for(var i=new Map,n=0;n<e.length;n++){var a=e[n].geometry;i.has(a.uuid)?i.get(a.uuid).push(e[n]):i.set(a.uuid,[e[n]])}i.forEach(function(e){1<e.length?t.push(e):1===e.length&&r.push(e[0])})},this.MCAD_GetInstranceAttribute=function(e,t,r){switch(t){case"line":return e.lineInstanceMap.get(r);case"opaque":case"mapMesh":return e.meshInstanceMap.get(r);case"ttf":case"ttf_line":return e.ttfInstanceMap.get(r);case"shx":return e.shxInstanceMap.get(r);case"point":return e.pointInstanceMap.get(r)}return null},this.MCAD_RenderMCAD2DMeshSetDraw=function(e,t,r,i,n,a,o){void 0===o&&(o="opaque");var s,l,d,c,h,u=performance.now(),a=this.MCAD_GetBatchedObjects(e,a,o,8192);return 0!==a.length&&(s=3<t.viewer.modelContentVersion&&("ttf"===o||"ltMesh"===o),l=this.MCAD_GetRenderObject(t,o,!1),this.MCAD_SplitBactchedObjects(a,a=[],d=[]),0<a.length&&(s&&(h=this.MCAD_GetRenderObject(t,"line",!1),c=this.MCAD_GetRenderMaterial(e,t,o+"_line",!1,!0),this.MCAD_RenderMCAD2DMeshSetDrawInstance(i,r,e,h,c,a,o,!0)),h=this.MCAD_GetRenderMaterial(e,t,o,!1,!0),this.MCAD_RenderMCAD2DMeshSetDrawInstance(i,r,e,l,h,a,o)),0<d.length&&(s&&(c=this.MCAD_GetRenderObject(t,"line",!1),h=this.MCAD_GetRenderMaterial(e,t,o+"_line",!1,!1),this.MCAD_RenderMCAD2DMeshSetDrawUnInstance(i,r,e,c,h,d,o,!0)),a=this.MCAD_GetRenderMaterial(e,t,o,!1,!1),this.MCAD_RenderMCAD2DMeshSetDrawUnInstance(i,r,e,l,a,d,o)),n-=performance.now()-u),n},this.MCAD_RenderMCAD2DMeshSetDrawLine2=function(e,t,r,i,n,a,o){void 0===o&&(o="opaque");var s,l,d,c=performance.now(),h=[],u=[];return"line2Mesh"===o?e.fetchLine2MeshForDraw(h,8192):"line2World"===o&&e.fetchLine2WorldForDraw(h,u,8192),0!==h.length&&(0<u.length&&(d=this.MCAD_GetRenderObject(t,"line",!1),this.MCAD_SplitBactchedObjects(u,u=[],s=[]),0<u.length&&(l=this.MCAD_GetRenderMaterial(e,t,"line",!1,!0),this.MCAD_RenderMCAD2DMeshSetDrawInstance(i,r,e,d,l,u,"line")),0<s.length)&&(l=this.MCAD_GetRenderMaterial(e,t,"line",!1,!1),this.MCAD_RenderMCAD2DMeshSetDrawUnInstance(i,r,e,d,l,s,"line")),u=this.MCAD_GetRenderObject(t,o,!1),d=this.MCAD_GetRenderMaterial(e,t,o,!1,!1),this.MCAD_RenderMCAD2DMeshSetDrawUnInstance(i,r,e,u,d,h,o),n-=performance.now()-c),n},this.MCAD_RenderMCAD2DMeshSetDrawInstance=function(e,t,r,i,n,a,o,s){for(var l=0;l<a.length;l++){var d=a[l],c=s?d[0].geometry.textWireFrame:d[0].geometry,h=this.MCAD_GetInstranceAttribute(r,o,d[0].geometry.uuid);if(h){for(var u=0;u<d.length;u++)h.array[2*u]=d[u].localIndex,h.array[2*u+1]=d[u].material.packColor;h.needsUpdate=!0,c.hasAttribute("meshId")||c.setAttribute("meshId",h),c.isInstancedBufferGeometry=!0,c.instanceCount=d.length,c.needsUpdate=!0,"mapMesh"===o&&(n.uniforms.pictureMtlMap.value=d[0].material.map,n.uniforms.pictureMtlMap.needsUpdate=!0),i.geometry=c,i.material=n,B.renderMeshDirect(e,t,i,null),c.hasAttribute("meshId")&&c.deleteAttribute("meshId")}else console.log("render ",o," size ",d.length," get attribute failed")}},this.MCAD_RenderMCAD2DMeshSetDrawUnInstance=function(e,t,r,i,n,a,o,s){for(var l=0;l<a.length;l++){var d=a[l],c=s?d.geometry.textWireFrame:d.geometry;"line2Mesh"===o||"line2World"===o?c.isInstancedBufferGeometry=!0:(c.isInstancedBufferGeometry=!1,c.instanceCount=0),"mapMesh"===o&&(n.uniforms.pictureMtlMap.value=d.material.map,n.uniforms.pictureMtlMap.needsUpdate=!0),n.uniforms.meshId.value.x=d.localIndex,n.uniforms.meshId.value.y=d.material.packColor,n.uniformsNeedUpdate=!0,n.uniforms.needsUpdate=!0,i.geometry=c,i.material=n,B.renderMeshDirect(e,t,i,null)}}}function Cr(e){function M(e,t,B,I,T){for(var S=function(){return!(!O.enableProgressiveRender||!(T<=0||T<300&&O.info.render.triangles+O.info.render.lines>O.maxPrimitivesPerFrame))&&(T=0,O.stopRenderingEarly=!0)},r=function(e,t,r,i,n,a){if(t&&0<T){r||(O.renderContext.state.buffers.color.setMask(!1),O.renderContext.state.buffers.color.setLocked(!0));for(var o=!0,s=O.enableProgressiveRender?0:1e4;;){for(var o=!0,l=0,d=a.length;l<d;++l){var c=a[l];if(c.visualStates.opaqueDrawCount===c.opaqueMeshes.length)c.visualStates.dirty=!1;else if(c.visualStates.dirty&&c.applyCull(),!c.isCulled()&&(T=R(c,c.ndsModel,B,I,T,s,e,t,r,n,"opaque",!r),c.visualStates.opaqueDrawCount<c.opaqueMeshes.length&&(o=!1),c.ndsModel.renderMeshSetCount+=1,c.ndsModel.hasrenderMesh=!0,c.renderOnce=!0,c.visualStates.dirty=!1,c.lineDirty=!0,S()))break}if(l===d&&++s,o||T<=0)break}if(o&&0<T)for(var h=!0,s=O.enableProgressiveRender?0:1e4;;){for(var h=!0,u=0,p=a.length;u<p;++u){var f=a[u];if(f.visualStates.transparentDrawCount===f.transparentMeshes.length)f.visualStates.dirty=!1;else if(f.visualStates.dirty&&f.applyCull(),!f.isCulled()&&(T=R(f,f.ndsModel,B,I,T,s,e,t,r,n,"opaque",!r),f.visualStates.transparentDrawCount<f.transparentMeshes.length&&(h=!1),f.ndsModel.renderMeshSetCount+=1,f.ndsModel.hasrenderMesh=!0,f.renderOnce=!0,f.visualStates.dirty=!1,f.lineDirty=!0,S()))break}if(u===p&&++s,h||T<=0)break}r||(O.renderContext.state.buffers.color.setLocked(!1),O.renderContext.state.buffers.color.setMask(!0))}if(i&&0<T)for(var m=0,g=n?2:1;m<g;++m){for(var v=2,y=!0;;){for(var y=!0,A=0,M=a.length;A<M;++A){var E=a[A];if(O.inOutlinePass){if(0===E.selectedDrawingLines.length)continue}else if(!E.needsLineDraw(t))continue;if((O.inOutlinePass||(n&&0!==v||1!==E.visualStates.lineDrawPass)&&(!n||2!==E.visualStates.lineDrawPass))&&(E.visualStates.dirty&&E.applyCull(),!E.isCulled()&&(T=C(E,E.ndsModel,B,I,T,e,r,n,E.visualStates.lineDrawPass),E.visualStates.lineDrawCount<E.drawingLines.length?y=!1:E.visualStates.lineDrawPass++,E.visualStates.lineDrawCount,E.visualStates.dirty=!1,v>E.visualStates.lineDrawPass&&(v=E.visualStates.lineDrawPass),S())))break}if(y||T<=0)break}if(y&&n&&2!==v)for(var w=0,x=a.length;w<x;++w)for(var b=a[w].visualStates.lineDrawCount=0;b<a[w].drawingLines.length;++b)a[w].drawingLines[b].rendered=!1}},i=function(e,t,r,i,n,a){for(var o=0;o<e.length;++o)!e[o].visualStates.dirty&&e[o]._last_render_pass_===a||(e[o]._last_render_pass_=a,r||!t&&0==(e[o].renderMode&Ce.RENDER_BIT.HIDDEN_LINE_REMOVE)&&0==(e[o].renderMode&Ce.RENDER_BIT.HIDDEN_LINE_VISIBLE)||(e[o].visualStates.lineDrawCount=0,e[o].visualStates.lineDrawPass=0,e[o].visualStates.opaqueDrawCount=0,e[o].visualStates.transparentDrawCount=0),i&&(t||e[o].renderMode===Ce.RENDER_BIT.NORMAL)&&(e[o].visualStates.opaqueDrawCount=0,e[o].visualStates.transparentDrawCount=0),n&&(t||e[o].renderMode===Ce.RENDER_BIT.NORMAL||0!=(e[o].renderMode&Ce.RENDER_BIT.WIREFRAME))&&(e[o].visualStates.lineDrawCount=0,e[o].visualStates.lineDrawPass=0))},n=T,a=0;a<3&&!O.inOutlinePass;++a){var o=t[a];if(0!==o.length){var s=o.isGlobalPass,l=1<a,d=!l,c=1===a;if(i(o,s,l,!0,d,a),T<=0&&!O.stopRenderingEarly){O.stopRenderingEarly=!0;break}a<=1?(n=T,T=5e3):(e.needsFastRendering&&(T/=1.2),e.forceRenderAll&&(T=1e3,e.forceRenderAll=!1)),r(s,!0,l,d,c,o),a<=1&&(T=n-(5e3-T))}}0<T&&e.viewer.selectionManager.shouldDrawSelectedMeshesIn3DViewer()&&(e.getDrawModeFace()&&O.drawSelectedBodyMeshes(e,B,I,e.getDrawModeFaceColorMask()),T=1e3);for(var h=3;h<4&&!(e.needsFastRendering||T<=0);++h){var u,p=t[h];0!==p.length&&(u=p.isGlobalPass,e.forceRenderAll&&(T=1e3,e.forceRenderAll=!1),O.inOutlinePass||i(p,u,!0,!1,!0,h),r(u,!1,!0,!0,!1,p))}return T}var L=this,O=this.baseRenderer=e,P=(this.supportLargeUniformBuffer=65536<=O.maxSupportUniformBufferSize,console.log("Support large uniform buffer? "+this.supportLargeUniformBuffer),new pr(512)),F=[new pr(512),new pr(512)],U=function(e,t,r,i,n,a,o,s){n.geometry=a[0].geometry;var a=!0===a[0].material.isMeshPhysicalMaterial,l=[],d=(L.supportLargeUniformBuffer?l=o?[t.bodyWorldMatrixUniformBlock]:[t.ndsModel.meshState.globalMtlUniformBlock,t.bodyWorldMatrixUniformBlock]:o||(l=[t.ndsModel.meshState.globalMtlUniformBlock]),void 0);e?(d=o?L.instancedDepthMtl:a?L.instancedPhysicalMtl:L.instancedPhongMtl,o||i||(d=a?L.instancedTransparentPhysicalMtl:L.instancedTransparentPhongMtl)):(d=o?L.depthMtl:a?L.physicalMtl:L.phongMtl,o||i||(d=a?L.transparentPhysicalMtl:L.transparentMtl)),d.needsLightsUpdate=O.__lightsChanged,d.uniforms.meshId2BodyIdParam.value.x=t.meshOffset,d.uniforms.meshId2BodyIdParam.value.y=r.meshId2BodyIdTexSize,d.uniforms.meshId2BodyIdMap.value=r.meshId2BodyIdTexture,o||(d.uniforms.meshMtlParam.value.x=t.meshOffset,d.uniforms.meshMtlParam.value.y=r.meshState.meshMtlTexSize,d.uniforms.meshMtlMap.value=r.meshState.meshMtlTexture),L.supportLargeUniformBuffer||(d.uniforms.bodyNodeWorldMatrixMap.value=t.bodyWorldMatrixUniformMap,d.uniforms.bodyNodeWorldMatrixMapSize.value=t.bodyWorldMatrixUniformMapSize),d.uniforms.bodyWorldMatrixOffset.value=t.bodyWorldMatrixOffset,d.uniformsNeedUpdate=!0,d.uniforms.needsUpdate=!0,d.uniformsGroups=l,n.material=d,n.material.transparent=!o&&!i,i&&!o&&(n.material.side=!0===s.shouldDrawDoubleSide?THREE.DoubleSide:THREE.FrontSide),n.material.flatShading=!n.geometry.attributes.normal},N=function(e,t,r,i,n){for(var a=0;a!==e.length;){if(!r&&e[a].faceMaterials)for(var o=e[a].geometry.drawRange.start,s=e[a].geometry.drawRange.count,l=0,d=e[a].faceMaterials.length;l<d;++l){var c,h,u=e[a];!u.faceMaterials[l].visible||opaqueDraw&&u.faceMaterials[l].transparent||!opaqueDraw&&!u.faceMaterials[l].transparent||(c=u.faceMaterials[l].range[0],h=u.faceMaterials[l].range[1]-c+1,c+=e[a].geometry.drawRange.start,e[a].geometry.drawRange.start=c,e[a].geometry.drawRange.count=h,(t.material.isNdsBatchedPhongMaterial||t.material.isNdsBatchedPhysicalMaterial)&&(t.material.uniforms.meshId.value.x=e[a].localIndex,t.material.uniforms.meshId.value.y=u.faceMaterials[l].color_opacity),t.material.uniforms.needsUpdate=!0,t.material.uniformsNeedUpdate=!0,t.geometry=e[a].geometry,t.material.flatShading=!t.geometry.attributes.normal,t.matrixWorld.copy(e[a].bodyNode.worldMatrix),O.renderMeshDirect(i,n,t,null),e[a].geometry.drawRange.start=o,e[a].geometry.drawRange.count=s)}else t.material.isNdsBatchedPhongMaterial||t.material.isNdsBatchedPhysicalMaterial?(t.material.uniforms.meshId.value.x=e[a].localIndex,t.material.uniforms.meshId.value.y=-1):t.material.uniforms.meshId.value=e[a].localIndex,t.material.uniforms.needsUpdate=!0,t.material.uniformsNeedUpdate=!0,t.geometry=e[a].geometry,t.material.flatShading=!t.geometry.attributes.normal,t.matrixWorld.copy(e[a].bodyNode.worldMatrix),O.renderMeshDirect(i,n,t,null);++a}},V=function(e,t,r,i,n,a,o,s,l){i.geometry=n[0].geometry;for(var d=[],d=L.supportLargeUniformBuffer?a?[L.batchedPhongMtl.uniformsGroups[0],e.bodyWorldMatrixUniformBlock]:[L.batchedPhongMtl.uniformsGroups[0],e.ndsModel.meshState.globalMtlUniformBlock,e.bodyWorldMatrixUniformBlock]:a?[L.batchedPhongMtl.uniformsGroups[0]]:[L.batchedPhongMtl.uniformsGroups[0],e.ndsModel.meshState.globalMtlUniformBlock],c=a?L.batchedDepthMtl:L.batchedPhongMtl,h=((c=a||r?c:L.batchedTransparentPhongMtl).needsLightsUpdate=O.__lightsChanged,c.uniforms.meshId2BodyIdParam.value.x=e.meshOffset,c.uniforms.meshId2BodyIdParam.value.y=t.meshId2BodyIdTexSize,c.uniforms.meshId2BodyIdMap.value=t.meshId2BodyIdTexture,a||(c.uniforms.meshMtlParam.value.x=e.meshOffset,c.uniforms.meshMtlParam.value.y=t.meshState.meshMtlTexSize,c.uniforms.meshMtlMap.value=t.meshState.meshMtlTexture),L.supportLargeUniformBuffer||(c.uniforms.bodyNodeWorldMatrixMap.value=e.bodyWorldMatrixUniformMap,c.uniforms.bodyNodeWorldMatrixMapSize.value=e.bodyWorldMatrixUniformMapSize),c.uniforms.bodyWorldMatrixOffset.value=e.bodyWorldMatrixOffset,c.uniformsNeedUpdate=!0,c.uniforms.needsUpdate=!0,c.uniformsGroups=d,i.material=c,i.material.transparent=!a&&!r,r&&!a&&(i.material.side=!0===o.shouldDrawDoubleSide?THREE.DoubleSide:THREE.FrontSide),i.material.flatShading=!i.geometry.attributes.normal,L.drawId2MeshIdUniformBlock.uniforms[0]),u=n[0].geometry.index.array.BYTES_PER_ELEMENT,p=0;p!==n.length;){for(var f=0;p<n.length&&f<512;){if(!a&&n[p].faceMaterials){if(512<=n[p].faceMaterials.length+f)break;for(var m=0,g=n[p].faceMaterials.length;m<g;++m){var v,y,A=n[p];!A.faceMaterials[m].visible||r&&A.faceMaterials[m].transparent||!r&&!A.faceMaterials[m].transparent||(v=A.faceMaterials[m].range[0],y=A.faceMaterials[m].range[1]-v+1,v+=n[p].geometry.drawRange.start,i._multiDrawStarts[f]=v*u,i._multiDrawCounts[f]=y,h.value[2*f]=n[p].localIndex,h.value[2*f+1]=A.faceMaterials[m].color_opacity,++f)}}else i._multiDrawStarts[f]=n[p].geometry.drawRange.start*u,i._multiDrawCounts[f]=n[p].geometry.drawRange.count,h.value[2*f]=n[p].localIndex,h.value[2*f+1]=-1,++f;++p}i._multiDrawCount=f,h.needsUpdate=!0,h.__update_offset=0,h.__update_length=2*f,L.drawId2MeshIdUniformBlock.needsUpdate=!0,O.renderMeshDirect(s,l,i,null)}},R=function(e,t,r,i,n,a,o,s,l,d,c,h){void 0===c&&(c="opaque"),void 0===h&&(h=!1);var u=performance.now(),p=(O._current_model_data_version_=t.dataVersion,F[0].batchLength=0,F[1].batchLength=0,"opaque"===c),f={shouldDrawDoubleSide:!1,frustum:L.renderParams.renderInfo.frustum},m=(p?e.fetchOpaqueForDraw(F[0],F[1],h?-1:a,o,s,d,!l,f):e.fetchTransparentForDraw(F[0],F[1],a,o,s,d,!l,f),e.resetInstanceMesh(),[[],[]]),g=[[],[]];if(0<F[0].batchLength||0<F[1].batchLength)for(var v=0;v<F.length;++v){var y=F[v];if(y&&0!==y.batchLength)for(var A=0;A<y.batchLength;++A){var M=y[A],E=1<M.geometry.refMeshes.length?e.instancedMeshGeomes.get(M.geometry):null;!E||E.hasOpaqueMtl&&E.hasTransparentMtl||E.hasPhongMtl&&E.hasPhysicMtl?g[v].push(M):(m[v].push(M),M.geometry.refInThisMeshSet++)}}for(var w=0;w<m.length;++w){var x=m[w];if(x&&0!==x.length)for(var b=t.meshManager.mesh,B=(U(!0,e,t,p,b,x,h,f),new Set),I=0;I<x.length;++I){var T,S=x[I].geometry;B.has(S.uuid)||((T=e.geomUUID2MeshIdAttribute.get(S.uuid))&&S.refInThisMeshSet===T.array.length?(S.hasAttribute("meshId")||S.setAttribute("meshId",T),S.isInstancedBufferGeometry=!0,S.instanceCount=T.array.length,S._maxInstanceCount=void 0,b.geometry=S,b.material.flatShading=!b.geometry.attributes.normal,b.matrixWorld.copy(x[I].bodyNode.worldMatrix),O.renderMeshDirect(i,r,b,null),S.hasAttribute("meshId")&&(S.deleteAttribute("meshId"),S.meshId=void 0),B.add(S.uuid),S.isInstancedBufferGeometry=!1,S.instanceCount=0):g[w].push(x[I]))}}if(0!==g[0].length||0!==g[1].length){if(O.supportMultiDraw&&e.supportMultiDraw){var R=t.meshManager.batchedMesh;R._multiDrawStarts||(R._multiDrawStarts=new Int32Array(512),R._multiDrawCounts=new Int32Array(512));for(var C=0;C<g.length;++C){var D=g[C];0!==D.length&&V(e,t,p,R,D,h,f,i,r)}}else for(var P=t.meshManager.mesh,H=0;H<g.length;++H){var _=g[H];0!==_.length&&(U(!1,e,t,p,P,_,h,f),N(_,P,h,i,r))}n-=performance.now()-u}return n},C=function(n,a,e,r,i,o,s,l,d){void 0===s&&(s=!0),void 0===l&&(l=!1),void 0===d&&(d=0);for(var c=performance.now(),h=function(e,t){var r,i;0!==P.length&&(t.geometry=P[0].geometry,r=[],i=void(L.supportLargeUniformBuffer&&(r=[n.bodyWorldMatrixUniformBlock])),(i=e?0===d?L.instancedLineMtl:L.instancedTransparentLineMtl:0===d?L.lineBasicMtl:L.transparentLineBasicMtl).uniforms.meshId2BodyIdParam.value.x=n.lineOffset,i.uniforms.meshId2BodyIdParam.value.y=a.lineId2BodyIdTexSize,i.uniforms.meshId2BodyIdMap.value=a.lineId2BodyIdTexture,i.uniforms.lineMtlParam.value.x=n.lineOffset,i.uniforms.lineMtlParam.value.y=a.meshState.lineMtlTexSize,i.uniforms.lineMtlMap.value=a.meshState.lineMtlTexture,i.uniforms.bodyWorldMatrixOffset.value=n.bodyWorldMatrixOffset,L.supportLargeUniformBuffer||(i.uniforms.bodyNodeWorldMatrixMap.value=n.bodyWorldMatrixUniformMap,i.uniforms.bodyNodeWorldMatrixMapSize.value=n.bodyWorldMatrixUniformMapSize),0===d?(i.uniforms.overrideColor.value.w=-1,i.depthFunc=THREE.LessEqualDepth):(i.uniforms.overrideColor.value.x=0,i.uniforms.overrideColor.value.y=0,i.uniforms.overrideColor.value.z=0,i.uniforms.overrideColor.value.w=.2,i.depthFunc=THREE.GreaterDepth),i.uniformsGroups=r,i.side=THREE.DoubleSide,i.uniformsNeedUpdate=!0,i.uniforms.needsUpdate=!0,t.material=i)},u=(P.batchLength=0,a.meshManager.lineSegments),p=(n.fetchLineForDraw(P,512,o,!l&&!s,l),n.resetInstanceLine(),[]),f=[],m=[],g=0;g<P.batchLength;++g){var v=P[g];v&&!v.material.material.isShaderMaterial&&1<v.geometry.refLineSegs.length&&!v.lineSegMaterials&&.99<v.bodyNode.opacity?(p.push(v),v.geometry.refInThisMeshSet++):(v.material.material.isShaderMaterial?m:f).push(v)}if(0<p.length){h(!0,u);for(var y=new Set,A=0;A<p.length;++A){var M,E=p[A].geometry;y.has(E.uuid)||((M=n.geomUUID2LineIdAttribute.get(E.uuid))&&E.refInThisMeshSet===M.array.length?(E.hasAttribute("meshId")||E.setAttribute("meshId",M),E.isInstancedBufferGeometry=!0,E.instanceCount=M.array.length,E._maxInstanceCount=void 0,u.geometry=E,O.renderMeshDirect(r,e,u,null),E.hasAttribute("meshId")&&(E.deleteAttribute("meshId"),E.meshId=void 0),E.isInstancedBufferGeometry=!1,E.instanceCount=0,y.add(E.uuid)):f.push(p[A]))}}if(0!==f.length){h(!1,u);for(var w=0;w!==f.length;){if(f[w].lineSegMaterials)for(var x=f[w].geometry.drawRange.start,b=f[w].geometry.drawRange.count,B=0,I=f[w].lineSegMaterials.length;B<I;++B){var T,S,R=f[w];R.lineSegMaterials[B].visible&&(S=R.lineSegMaterials[B].range[0],T=R.lineSegMaterials[B].range[1]-S+1,S+=f[w].geometry.drawRange.start,f[w].geometry.drawRange.start=S,f[w].geometry.drawRange.count=T,S=.99<=f[w].bodyNode.opacity,u.material.needsUpdate=u.material.transparent!==S,u.material.transparent=S,u.material.uniforms.meshId.value.x=f[w].localIndex,u.material.uniforms.meshId.value.y=R.lineSegMaterials[B].color_opacity,u.material.uniforms.needsUpdate=!0,u.material.uniformsNeedUpdate=!0,u.geometry=f[w].geometry,O.renderMeshDirect(r,e,u,null),f[w].geometry.drawRange.start=x,f[w].geometry.drawRange.count=b,++t)}else{var C=.99<=f[w].bodyNode.opacity;u.material.needsUpdate=u.material.transparent!==C,u.material.transparent=C,u.material.uniforms.meshId.value.x=f[w].localIndex,u.material.uniforms.meshId.value.y=-1,u.material.uniforms.needsUpdate=!0,u.material.uniformsNeedUpdate=!0,u.geometry=f[w].geometry,O.renderMeshDirect(r,e,u,null)}++w}}if(0!==m.length)for(var D=0;D!==m.length;)u.geometry=m[D].geometry,u.material=m[D].material.material,u.matrixWorld.copy(m[D].bodyNode.worldMatrix),u.modelViewMatrix.multiplyMatrices(r.matrixWorldInverse,u.matrixWorld),u.matrixAutoUpdate=!1,u.matrixWorldNeedsUpdate=!1,O.renderMeshDirect(r,e,u,null),++D;return i-=performance.now()-c},E=[],w=[],x=[],b=[],B=!1;this.render=function(e,t,r,i,n){B||(O.supportMultiDraw&&!L.drawId2MeshIdUniformBlock&&(L.drawId2MeshIdUniformBlock=new THREE.UniformsGroup,L.drawId2MeshIdUniformBlock.setName("drawId2MeshIdData"),L.drawId2MeshIdUniformBlock.add(new THREE.Uniform(new Int32Array(1024))),L.drawId2MeshIdUniformBlock.usage=THREE.DynamicDrawUsage),L.batchedPhongMtl||(L.batchedPhongMtl=new I({},!1,!0,L.supportLargeUniformBuffer),L.batchedPhongMtl.uniformsGroups=[L.drawId2MeshIdUniformBlock],L.batchedTransparentPhongMtl=new I({depthWrite:!1,transparent:!0,side:THREE.DoubleSide},!1,!0,L.supportLargeUniformBuffer),L.batchedTransparentPhongMtl.uniformsGroups=[L.drawId2MeshIdUniformBlock],L.batchedDepthMtl=new sr({},!1,!0,L.supportLargeUniformBuffer),L.batchedDepthMtl.uniformsGroups=[L.drawId2MeshIdUniformBlock]),L.batchedPhysicalMtl||(L.batchedPhysicalMtl=new T({},!1,!0,L.supportLargeUniformBuffer),L.batchedPhysicalMtl.uniformsGroups=[L.drawId2MeshIdUniformBlock],L.batchedTransparentPhysicalMtl=new T({depthWrite:!1,transparent:!0,side:THREE.DoubleSide},!1,!0,L.supportLargeUniformBuffer),L.batchedTransparentPhysicalMtl.uniformsGroups=[L.drawId2MeshIdUniformBlock]),L.batchedLineBasicMtl||(L.batchedLineBasicMtl=new S({transparent:!0},!1,!0,L.supportLargeUniformBuffer),L.batchedLineBasicMtl.uniformsGroups=[L.drawId2MeshIdUniformBlock],L.batchedHiddenLineBasicMtl=new S({depthWrite:!0,transparent:!0,opacity:.2,depthFunc:THREE.GreaterDepth},!1,!0,L.supportLargeUniformBuffer),L.batchedHiddenLineBasicMtl.uniforms.overrideColor.value.x=0,L.batchedHiddenLineBasicMtl.uniforms.overrideColor.value.y=0,L.batchedHiddenLineBasicMtl.uniforms.overrideColor.value.z=0,L.batchedHiddenLineBasicMtl.uniforms.overrideColor.value.w=.2,L.batchedHiddenLineBasicMtl.uniformsGroups=[L.drawId2MeshIdUniformBlock]),L.instancedPhongMtl||(L.instancedPhongMtl=new I({},!0,!1,L.supportLargeUniformBuffer)),L.instancedTransparentPhongMtl||(L.instancedTransparentPhongMtl=new I({depthWrite:!1,transparent:!0,side:THREE.DoubleSide},!0,!1,L.supportLargeUniformBuffer)),L.phongMtl||(L.phongMtl=new I({},!1,!1,L.supportLargeUniformBuffer),L.phongMtl.uniformsGroups=[]),L.transparentMtl||(L.transparentMtl=new I({depthWrite:!1,transparent:!0,side:THREE.DoubleSide},!1,!1,L.supportLargeUniformBuffer)),L.instancedPhysicalMtl||(L.instancedPhysicalMtl=new T({},!0,!1,L.supportLargeUniformBuffer)),L.physicalMtl||(L.physicalMtl=new T({},!1,!1,L.supportLargeUniformBuffer),L.physicalMtl.uniformsGroups=[]),L.transparentPhysicalMtl||(L.transparentPhysicalMtl=new T({depthWrite:!1,transparent:!0,side:THREE.DoubleSide},!1,!1,L.supportLargeUniformBuffer)),L.instancedTransparentPhysicalMtl||(L.instancedTransparentPhysicalMtl=new T({depthWrite:!1,transparent:!0,side:THREE.DoubleSide},!0,!1,L.supportLargeUniformBuffer)),L.instancedDepthMtl||(L.instancedDepthMtl=new sr({},!0,!1,L.supportLargeUniformBuffer)),L.depthMtl||(L.depthMtl=new sr({},!1,!1,L.supportLargeUniformBuffer)),L.instancedLineMtl||(L.instancedLineMtl=new S({transparent:!0},!0,!1,L.supportLargeUniformBuffer),L.instancedTransparentLineMtl=new S({depthWrite:!1,transparent:!0},!0,!1,L.supportLargeUniformBuffer)),L.lineBasicMtl||(L.lineBasicMtl=new S({transparent:!0},!1,!1,L.supportLargeUniformBuffer),L.transparentLineBasicMtl=new S({depthWrite:!1,transparent:!0},!1,!1,L.supportLargeUniformBuffer)),B=!0),L.renderParams=n,E.length=0,E.isGlobalPass=!1,w.length=0,w.isGlobalPass=!1,x.length=0,x.isGlobalPass=!1,b.length=0,b.isGlobalPass=!1;if(e.state<ee.StateType.RENDERING_PREPARED)O.stopRenderingEarly=!0;else if((void 0===e.renderOnce||e.lineSegmentsSet.dirty||O.inOutlinePass)&&(e.renderOnce=!0),e.hasrenderMesh=!1,e.renderOnce){e.applyCull(n.renderInfo.frustum),e.meshManager.renderContext=O.renderContext,e.geomManager.renderContext=O.renderContext;for(var a=e.getDrawModeFace(),o=e.getDrawModeFaceColorMask(),s=e.getDrawModeEdge(),l=e.getDrawModeHiddenEdge(),d=(o?(a&&(x.isGlobalPass=!0),s&&(b.isGlobalPass=!0)):l?w.isGlobalPass=!0:E.isGlobalPass=!0,e.getMeshSets()),c=0;c<d.length;++c){var h,u,p,f,m,g,v,y=d[c];0===y.bodyNodes.length?y.visualStates.dirty=!1:(y.visualStates.dirty&&y.applyCull(),y.isCulled()||(h=0!=(y.renderMode&Ce.RENDER_BIT.NORMAL),u=0!=(y.renderMode&Ce.RENDER_BIT.WIREFRAME),p=0!=(y.renderMode&Ce.RENDER_BIT.HIDDEN_LINE_VISIBLE),f=0!=(y.renderMode&Ce.RENDER_BIT.HIDDEN_LINE_REMOVE),m=!(p||f),g=y.needsMeshDraw(),v=O.inOutlinePass||y.needsLineDraw(h),y.isLoaded()?(y.prepareForBatchDraw(),o?(m||g&&(p&&w.push(y),f)&&E.push(y),g&&(a||h)&&x.push(y),(g||v)&&(s||u)&&b.push(y)):(g&&(l?(w.push(y),f&&E.push(y)):(p&&w.push(y),E.push(y))),h&&g&&x.push(y),(g||v)&&u&&b.push(y))):O.stopRenderingEarly=!0))}}var A,n=[E,w,x,b];e.viewer.clipDataManager.isSectionViewEnabled()&&(A=[L.batchedPhongMtl,L.batchedTransparentPhongMtl,L.batchedDepthMtl,L.batchedLineBasicMtl,L.batchedPhysicalMtl,L.batchedTransparentPhysicalMtl,L.phongMtl,L.instancedPhongMtl,L.transparentMtl,L.instancedTransparentPhongMtl,L.depthMtl,L.instancedDepthMtl,L.lineBasicMtl,L.instancedLineMtl,L.physicalMtl,L.instancedPhysicalMtl,L.transparentPhysicalMtl,L.instancedTransparentPhysicalMtl],e.viewer.clipDataManager.enableClipDraw(A),i=M(e,n,t,r,i),e.viewer.clipDataManager.disableClipDraw(A)),i&&M(e,n,t,r,i)}}function Dr(e){function p(e,t,B,I,T){for(var S=function(){return!(!O.enableProgressiveRender||!(T<=0||T<300&&O.info.render.triangles+O.info.render.lines>O.maxPrimitivesPerFrame))&&(T=0,O.stopRenderingEarly=!0)},r=function(e,t,r,i,n,a){if(t&&0<T){r||(O.renderContext.state.buffers.color.setMask(!1),O.renderContext.state.buffers.color.setLocked(!0));for(var o=!0,s=O.enableProgressiveRender?0:1e4;;){for(var o=!0,l=0,d=a.length;l<d;++l){var c=a[l];if(c.visualStates.opaqueDrawCount===c.opaqueMeshes.length)c.visualStates.dirty=!1;else if(c.visualStates.dirty&&c.applyCull(),!c.isCulled()&&(T=R(c,c.ndsModel,B,I,T,s,e,t,r,n,"opaque",!r),c.visualStates.opaqueDrawCount<c.opaqueMeshes.length&&(o=!1),c.ndsModel.renderMeshSetCount+=1,c.ndsModel.hasrenderMesh=!0,c.renderOnce=!0,c.visualStates.dirty=!1,c.lineDirty=!0,S()))break}if(l===d&&++s,o||T<=0)break}if(o&&0<T)for(var h=!0,s=O.enableProgressiveRender?0:1e4;;){for(var h=!0,u=0,p=a.length;u<p;++u){var f=a[u];if(f.visualStates.transparentDrawCount===f.transparentMeshes.length)f.visualStates.dirty=!1;else if(f.visualStates.dirty&&f.applyCull(),!f.isCulled()&&(T=renderMCAD3DMeshSet(f,f.ndsModel,B,I,T,s,e,t,r,n,"transparent"),f.visualStates.transparentDrawCount<f.transparentMeshes.length&&(h=!1),f.ndsModel.renderMeshSetCount+=1,f.ndsModel.hasrenderMesh=!0,f.renderOnce=!0,f.visualStates.dirty=!1,f.lineDirty=!0,S()))break}if(u===p&&++s,h||T<=0)break}r||(O.renderContext.state.buffers.color.setLocked(!1),O.renderContext.state.buffers.color.setMask(!0))}if(i&&0<T)for(var m=0,g=n?2:1;m<g;++m){for(var v=2,y=!0;;){for(var y=!0,A=0,M=a.length;A<M;++A){var E=a[A];if(O.inOutlinePass){if(0===E.selectedDrawingLines.length)continue}else if(!E.needsLineDraw(t))continue;if((O.inOutlinePass||(n&&0!==v||1!==E.visualStates.lineDrawPass)&&(!n||2!==E.visualStates.lineDrawPass))&&(E.visualStates.dirty&&E.applyCull(),!E.isCulled()&&(T=(O.supportMultiDraw&&E.supportMultiDraw?D:C)(E,E.ndsModel,B,I,T,e,r,n,E.visualStates.lineDrawPass),E.visualStates.lineDrawCount<E.drawingLines.length?y=!1:E.visualStates.lineDrawPass++,E.visualStates.lineDrawCount,E.visualStates.dirty=!1,v>E.visualStates.lineDrawPass&&(v=E.visualStates.lineDrawPass),S())))break}if(y||T<=0)break}if(y&&n&&2!==v)for(var w=0,x=a.length;w<x;++w)for(var b=a[w].visualStates.lineDrawCount=0;b<a[w].drawingLines.length;++b)a[w].drawingLines[b].rendered=!1}},i=function(e,t,r,i,n,a){for(var o=0;o<e.length;++o)!e[o].visualStates.dirty&&e[o]._last_render_pass_===a||(e[o]._last_render_pass_=a,r||!t&&0==(e[o].renderMode&Ce.RENDER_BIT.HIDDEN_LINE_REMOVE)&&0==(e[o].renderMode&Ce.RENDER_BIT.HIDDEN_LINE_VISIBLE)||(e[o].visualStates.lineDrawCount=0,e[o].visualStates.lineDrawPass=0,e[o].visualStates.opaqueDrawCount=0,e[o].visualStates.transparentDrawCount=0),i&&(t||e[o].renderMode===Ce.RENDER_BIT.NORMAL)&&(e[o].visualStates.opaqueDrawCount=0,e[o].visualStates.transparentDrawCount=0),n&&(t||e[o].renderMode===Ce.RENDER_BIT.NORMAL||0!=(e[o].renderMode&Ce.RENDER_BIT.WIREFRAME))&&(e[o].visualStates.lineDrawCount=0,e[o].visualStates.lineDrawPass=0))},n=T,a=0;a<3&&!O.inOutlinePass;++a){var o=t[a];if(0!==o.length){var s=o.isGlobalPass,l=1<a,d=!l,c=1===a;if(i(o,s,l,!0,d,a),T<=0&&!O.stopRenderingEarly){O.stopRenderingEarly=!0;break}a<=1?(n=T,T=5e3):(e.needsFastRendering&&(T/=1.2),e.forceRenderAll&&(T=1e3,e.forceRenderAll=!1)),r(s,!0,l,d,c,o),a<=1&&(T=n-(5e3-T))}}0<T&&e.viewer.selectionManager.shouldDrawSelectedMeshesIn3DViewer()&&(e.getDrawModeFace()&&O.drawSelectedBodyMeshes(e,B,I,e.getDrawModeFaceColorMask()),T=1e3);for(var h=3;h<4&&!(e.needsFastRendering||T<=0);++h){var u,p=t[h];0!==p.length&&(u=p.isGlobalPass,e.forceRenderAll&&(T=1e3,e.forceRenderAll=!1),O.inOutlinePass||i(p,u,!0,!1,!0,h),r(u,!1,!0,!0,!1,p))}return T}var L=this,O=this.baseRenderer=e,P=(this.supportLargeUniformBuffer=65536<=O.maxSupportUniformBufferSize,console.log("Support large uniform buffer? "+this.supportLargeUniformBuffer),new pr(512)),F=[new pr(512),new pr(512)],U=function(e,t,r,i,n,a,o,s){n.geometry=a[0].geometry;var a=!0===a[0].material.isMeshPhysicalMaterial,l=[],d=(L.supportLargeUniformBuffer?l=o?[t.bodyWorldMatrixUniformBlock]:[t.ndsModel.meshState.globalMtlUniformBlock,t.bodyWorldMatrixUniformBlock]:o||(l=[t.ndsModel.meshState.globalMtlUniformBlock]),void 0);e?(d=o?L.instancedDepthMtl:a?L.instancedPhysicalMtl:L.instancedPhongMtl,o||i||(d=a?L.instancedTransparentPhysicalMtl:L.instancedTransparentPhongMtl)):(d=o?L.depthMtl:a?L.physicalMtl:L.phongMtl,o||i||(d=a?L.transparentPhysicalMtl:L.transparentMtl)),d.needsLightsUpdate=O.__lightsChanged,d.uniforms.meshId2BodyIdParam.value.x=t.meshOffset,d.uniforms.meshId2BodyIdParam.value.y=r.meshId2BodyIdTexSize,d.uniforms.meshId2BodyIdMap.value=r.meshId2BodyIdTexture,o||(d.uniforms.meshMtlParam.value.x=t.meshOffset,d.uniforms.meshMtlParam.value.y=r.meshState.meshMtlTexSize,d.uniforms.meshMtlMap.value=r.meshState.meshMtlTexture),L.supportLargeUniformBuffer||(d.uniforms.bodyNodeWorldMatrixMap.value=t.bodyWorldMatrixUniformMap,d.uniforms.bodyNodeWorldMatrixMapSize.value=t.bodyWorldMatrixUniformMapSize),d.uniforms.bodyWorldMatrixOffset.value=t.bodyWorldMatrixOffset,d.uniformsNeedUpdate=!0,d.uniforms.needsUpdate=!0,d.uniformsGroups=l,n.material=d,n.material.transparent=!o&&!i,i&&!o&&(n.material.side=!0===s.shouldDrawDoubleSide?THREE.DoubleSide:THREE.FrontSide),n.material.flatShading=!n.geometry.attributes.normal},N=function(e,t,r,i,n){for(var a=0;a!==e.length;){if(!r&&e[a].faceMaterials)for(var o=e[a].geometry.drawRange.start,s=e[a].geometry.drawRange.count,l=0,d=e[a].faceMaterials.length;l<d;++l){var c,h,u=e[a];!u.faceMaterials[l].visible||opaqueDraw&&u.faceMaterials[l].transparent||!opaqueDraw&&!u.faceMaterials[l].transparent||(c=u.faceMaterials[l].range[0],h=u.faceMaterials[l].range[1]-c+1,c+=e[a].geometry.drawRange.start,e[a].geometry.drawRange.start=c,e[a].geometry.drawRange.count=h,(t.material.isNdsBatchedPhongMaterial||t.material.isNdsBatchedPhysicalMaterial)&&(t.material.uniforms.meshId.value.x=e[a].localIndex,t.material.uniforms.meshId.value.y=u.faceMaterials[l].color_opacity),t.material.uniforms.needsUpdate=!0,t.material.uniformsNeedUpdate=!0,t.geometry=e[a].geometry,t.material.flatShading=!t.geometry.attributes.normal,t.matrixWorld.copy(e[a].bodyNode.worldMatrix),O.renderMeshDirect(i,n,t,null),e[a].geometry.drawRange.start=o,e[a].geometry.drawRange.count=s)}else t.material.isNdsBatchedPhongMaterial||t.material.isNdsBatchedPhysicalMaterial?(t.material.uniforms.meshId.value.x=e[a].localIndex,t.material.uniforms.meshId.value.y=-1):t.material.uniforms.meshId.value=e[a].localIndex,t.material.uniforms.needsUpdate=!0,t.material.uniformsNeedUpdate=!0,t.geometry=e[a].geometry,t.material.flatShading=!t.geometry.attributes.normal,t.matrixWorld.copy(e[a].bodyNode.worldMatrix),O.renderMeshDirect(i,n,t,null);++a}},V=function(e,t,r,i,n,a,o,s,l){i.geometry=n[0].geometry;for(var d=[],d=L.supportLargeUniformBuffer?a?[L.batchedPhongMtl.uniformsGroups[0],e.bodyWorldMatrixUniformBlock]:[L.batchedPhongMtl.uniformsGroups[0],e.ndsModel.meshState.globalMtlUniformBlock,e.bodyWorldMatrixUniformBlock]:a?[L.batchedPhongMtl.uniformsGroups[0]]:[L.batchedPhongMtl.uniformsGroups[0],e.ndsModel.meshState.globalMtlUniformBlock],c=a?L.batchedDepthMtl:L.batchedPhongMtl,h=((c=a||r?c:L.batchedTransparentPhongMtl).needsLightsUpdate=O.__lightsChanged,c.uniforms.meshId2BodyIdParam.value.x=e.meshOffset,c.uniforms.meshId2BodyIdParam.value.y=t.meshId2BodyIdTexSize,c.uniforms.meshId2BodyIdMap.value=t.meshId2BodyIdTexture,a||(c.uniforms.meshMtlParam.value.x=e.meshOffset,c.uniforms.meshMtlParam.value.y=t.meshState.meshMtlTexSize,c.uniforms.meshMtlMap.value=t.meshState.meshMtlTexture),L.supportLargeUniformBuffer||(c.uniforms.bodyNodeWorldMatrixMap.value=e.bodyWorldMatrixUniformMap,c.uniforms.bodyNodeWorldMatrixMapSize.value=e.bodyWorldMatrixUniformMapSize),c.uniforms.bodyWorldMatrixOffset.value=e.bodyWorldMatrixOffset,c.uniformsNeedUpdate=!0,c.uniforms.needsUpdate=!0,c.uniformsGroups=d,i.material=c,i.material.transparent=!a&&!r,r&&!a&&(i.material.side=!0===o.shouldDrawDoubleSide?THREE.DoubleSide:THREE.FrontSide),i.material.flatShading=!i.geometry.attributes.normal,L.drawId2MeshIdUniformBlock.uniforms[0]),u=n[0].geometry.index.array.BYTES_PER_ELEMENT,p=0;p!==n.length;){for(var f=0;p<n.length&&f<512;){if(!a&&n[p].faceMaterials){if(512<=n[p].faceMaterials.length+f)break;for(var m=0,g=n[p].faceMaterials.length;m<g;++m){var v,y,A=n[p];!A.faceMaterials[m].visible||r&&A.faceMaterials[m].transparent||!r&&!A.faceMaterials[m].transparent||(v=A.faceMaterials[m].range[0],y=A.faceMaterials[m].range[1]-v+1,v+=n[p].geometry.drawRange.start,i._multiDrawStarts[f]=v*u,i._multiDrawCounts[f]=y,h.value[2*f]=n[p].localIndex,h.value[2*f+1]=A.faceMaterials[m].color_opacity,++f)}}else i._multiDrawStarts[f]=n[p].geometry.drawRange.start*u,i._multiDrawCounts[f]=n[p].geometry.drawRange.count,h.value[2*f]=n[p].localIndex,h.value[2*f+1]=-1,++f;++p}i._multiDrawCount=f,h.needsUpdate=!0,h.__update_offset=0,h.__update_length=2*f,L.drawId2MeshIdUniformBlock.needsUpdate=!0,O.renderMeshDirect(s,l,i,null)}},R=function(e,t,r,i,n,a,o,s,l,d,c,h){void 0===c&&(c="opaque"),void 0===h&&(h=!1);var u=performance.now(),p=(O._current_model_data_version_=t.dataVersion,F[0].batchLength=0,F[1].batchLength=0,"opaque"===c),f={shouldDrawDoubleSide:!1,frustum:L.renderParams.renderInfo.frustum},m=(p?e.fetchOpaqueForDraw(F[0],F[1],h?-1:a,o,s,d,!l,f):e.fetchTransparentForDraw(F[0],F[1],a,o,s,d,!l,f),[[],[]]),g=[[],[]];if(0<F[0].batchLength||0<F[1].batchLength)for(var v=0;v<F.length;++v){var y=F[v];if(y&&0!==y.batchLength)for(var A=0;A<y.batchLength;++A){var M=y[A],E=1<M.geometry.refMeshes.length?e.instancedMeshGeomes.get(M.geometry):null;!E||E.hasOpaqueMtl&&E.hasTransparentMtl||E.hasPhongMtl&&E.hasPhysicMtl?g[v].push(M):(m[v].push(M),M.geometry.refInThisMeshSet++)}}for(var w=0;w<m.length;++w){var x=m[w];if(x&&0!==x.length)for(var b=t.meshManager.mesh,B=(U(!0,e,t,p,b,x,h,f),new Set),I=0;I<x.length;++I){var T,S=x[I].geometry;B.has(S.uuid)||((T=e.geomUUID2MeshIdAttribute.get(S.uuid))&&S.refInThisMeshSet===T.array.length?(S.hasAttribute("meshId")||S.setAttribute("meshId",T),S.isInstancedBufferGeometry=!0,S.instanceCount=T.array.length,S._maxInstanceCount=void 0,b.geometry=S,b.material.flatShading=!b.geometry.attributes.normal,b.matrixWorld.copy(x[I].bodyNode.worldMatrix),O.renderMeshDirect(i,r,b,null),S.hasAttribute("meshId")&&(S.deleteAttribute("meshId"),S.meshId=void 0),S.isInstancedBufferGeometry=!1,S.instanceCount=0,B.add(S.uuid)):g[w].push(x[I]))}}if(0!==g[0].length||0!==g[1].length){if(O.supportMultiDraw&&e.supportMultiDraw){var R=t.meshManager.batchedMesh;R._multiDrawStarts||(R._multiDrawStarts=new Int32Array(512),R._multiDrawCounts=new Int32Array(512));for(var C=0;C<g.length;++C){var D=g[C];0!==D.length&&V(e,t,p,R,D,h,f,i,r)}}else for(var P=t.meshManager.mesh,H=0;H<g.length;++H){var _=g[H];0!==_.length&&(U(!1,e,t,p,P,_,h,f),N(_,P,h,i,r))}n-=performance.now()-u}return n},C=function(n,a,e,t,r,i,o,s,l){void 0===o&&(o=!0),void 0===s&&(s=!1),void 0===l&&(l=0);for(var d=performance.now(),c=function(e,t){var r,i;0!==P.length&&(t.geometry=P[0].geometry,r=[],i=void(L.supportLargeUniformBuffer&&(r=[n.bodyWorldMatrixUniformBlock])),(i=e?0===l?L.instancedLineMtl:L.instancedTransparentLineMtl:0===l?L.lineBasicMtl:L.transparentLineBasicMtl).uniforms.meshId2BodyIdParam.value.x=n.lineOffset,i.uniforms.meshId2BodyIdParam.value.y=a.lineId2BodyIdTexSize,i.uniforms.meshId2BodyIdMap.value=a.lineId2BodyIdTexture,i.uniforms.lineMtlParam.value.x=n.lineOffset,i.uniforms.lineMtlParam.value.y=a.meshState.lineMtlTexSize,i.uniforms.lineMtlMap.value=a.meshState.lineMtlTexture,i.uniforms.bodyWorldMatrixOffset.value=n.bodyWorldMatrixOffset,L.supportLargeUniformBuffer||(i.uniforms.bodyNodeWorldMatrixMap.value=n.bodyWorldMatrixUniformMap,i.uniforms.bodyNodeWorldMatrixMapSize.value=n.bodyWorldMatrixUniformMapSize),0===l?(i.uniforms.overrideColor.value.w=-1,i.depthFunc=THREE.LessEqualDepth):(i.uniforms.overrideColor.value.x=0,i.uniforms.overrideColor.value.y=0,i.uniforms.overrideColor.value.z=0,i.uniforms.overrideColor.value.w=.2,i.depthFunc=THREE.GreaterDepth),i.uniformsGroups=r,i.side=THREE.DoubleSide,i.uniformsNeedUpdate=!0,i.uniforms.needsUpdate=!0,t.material=i)},h=(P.batchLength=0,a.meshManager.lineSegments),u=(n.fetchLineForDraw(P,512,i,!s&&!o,s),[]),p=[],f=[],m=0;m<P.batchLength;++m){var g=P[m];g&&!g.material.material.isShaderMaterial&&1<g.geometry.refLineSegs.length&&!g.lineSegMaterials&&.99<g.bodyNode.opacity?(u.push(g),g.geometry.refInThisMeshSet++):(g.material.material.isShaderMaterial?f:p).push(g)}if(0<u.length){c(!0,h);for(var v=new Set,y=0;y<u.length;++y){var A,M=u[y].geometry;v.has(M.uuid)||((A=n.geomUUID2LineIdAttribute.get(M.uuid))&&M.refInThisMeshSet===A.array.length?(M.hasAttribute("meshId")||M.setAttribute("meshId",A),M.isInstancedBufferGeometry=!0,M.instanceCount=A.array.length,M._maxInstanceCount=void 0,h.geometry=M,O.renderMeshDirect(t,e,h,null),M.hasAttribute("meshId")&&(M.deleteAttribute("meshId"),M.meshId=void 0),M.isInstancedBufferGeometry=!1,M.instanceCount=0,v.add(M.uuid)):p.push(u[y]))}}if(0!==p.length){c(!1,h);for(var E=0;E!==p.length;)for(var w=0;E<p.length&&w<512;){if(p[E].lineSegMaterials){if(512<=p[E].lineSegMaterials.length+w)break;for(var x=p[E].geometry.drawRange.start,b=p[E].geometry.drawRange.count,B=0,I=p[E].lineSegMaterials.length;B<I;++B){var T,S,R=p[E];R.lineSegMaterials[B].visible&&(S=R.lineSegMaterials[B].range[0],T=R.lineSegMaterials[B].range[1]-S+1,S+=p[E].geometry.drawRange.start,p[E].geometry.drawRange.start=S,p[E].geometry.drawRange.count=T,S=.99<=p[E].bodyNode.opacity,h.material.needsUpdate=h.material.transparent!==S,h.material.transparent=S,h.material.uniforms.meshId.value.x=p[E].localIndex,h.material.uniforms.meshId.value.y=R.lineSegMaterials[B].color_opacity,h.material.uniforms.needsUpdate=!0,h.material.uniformsNeedUpdate=!0,h.geometry=p[E].geometry,O.renderMeshDirect(t,e,h,null),p[E].geometry.drawRange.start=x,p[E].geometry.drawRange.count=b,++w)}}else{var C=.99<=p[E].bodyNode.opacity;h.material.needsUpdate=h.material.transparent!==C,h.material.transparent=C,h.material.uniforms.meshId.value.x=p[E].localIndex,h.material.uniforms.meshId.value.y=-1,h.material.uniforms.needsUpdate=!0,h.material.uniformsNeedUpdate=!0,h.geometry=p[E].geometry,O.renderMeshDirect(t,e,h,null),++w}++E}}if(0!==f.length)for(var D=0;D!==f.length;)h.geometry=f[D].geometry,h.material=f[D].material.material,h.matrixWorld.copy(f[D].bodyNode.worldMatrix),h.modelViewMatrix.multiplyMatrices(t.matrixWorldInverse,h.matrixWorld),h.matrixAutoUpdate=!1,h.matrixWorldNeedsUpdate=!1,O.renderMeshDirect(t,e,h,null),++D;return r-=performance.now()-d},f=[],m=[],g=[],v=[],D=function(e,t,r,i,n,a,o,s,l){void 0===o&&(o=!0),void 0===s&&(s=!1),void 0===l&&(l=0);var d=performance.now(),c=t.meshManager.batchedLineSegments,h=(c._multiDrawStarts||(c._multiDrawStarts=new Int32Array(512),c._multiDrawCounts=new Int32Array(512)),O.inOutlinePass||0===l?L.batchedLineBasicMtl:L.batchedHiddenLineBasicMtl),u=(h.uniforms.meshId2BodyIdParam.value.x=e.lineOffset,h.uniforms.meshId2BodyIdParam.value.y=t.lineId2BodyIdTexSize,h.uniforms.meshId2BodyIdMap.value=t.lineId2BodyIdTexture,h.uniforms.lineMtlParam.value.x=e.lineOffset,h.uniforms.lineMtlParam.value.y=t.meshState.lineMtlTexSize,h.uniforms.lineMtlMap.value=t.meshState.lineMtlTexture,L.supportLargeUniformBuffer||(h.uniforms.bodyNodeWorldMatrixMap.value=e.bodyWorldMatrixUniformMap,h.uniforms.bodyNodeWorldMatrixMapSize.value=e.bodyWorldMatrixUniformMapSize),h.uniforms.bodyWorldMatrixOffset.value=e.bodyWorldMatrixOffset,h.uniforms.opacityScale.value=0!==l||o||s?1:.6,[]),u=L.supportLargeUniformBuffer?[L.drawId2MeshIdUniformBlock,e.bodyWorldMatrixUniformBlock]:[L.drawId2MeshIdUniformBlock];h.uniformsNeedUpdate=!0,h.uniforms.needsUpdate=!0,h.uniformsGroups=u,h.side=THREE.DoubleSide,c.material=h;for(var p=null,f=O.inOutlinePass,m=0,g=O.inOutlinePass?1:2;m<g;++m)if(O.inOutlinePass?(0===e.renderMode&&t.drawMode===t.SHADED_WITH_EDGES||e.hasNormalNode())&&(p=e.selectedDrawingLines,h.depthTest=!1):0===m?(P.batchLength=0,e.fetchLineForDraw(P,512,a,!s&&!o,s,O.inOutlinePass),p=P,h.depthTest=!0):(p=e.selectedDrawingLines,f=!0),p&&0!==p.batchLength){c._multiDrawCount=p.length,c.geometry=p[0].geometry;for(var v=L.drawId2MeshIdUniformBlock.uniforms[0],y=p[0].geometry.index.array.BYTES_PER_ELEMENT,A=0;A!==p.batchLength;){for(var M=0;A<p.batchLength&&M<512;){var E=p[A].bodyNode,w=E.renderMode||E.ndsModel.drawMode;if(1===m&&w===E.ndsModel.SHADED_WITH_EDGES);else{var x=-1;if(f&&(x=w===E.ndsModel.WIREFRAME?E.ndsModel.meshState.getSelectedEdgeColorOpacity(1):w<=E.ndsModel.SHADED?E.ndsModel.meshState.getSelectedEdgeColorOpacity(0):0===l?E.ndsModel.meshState.getSelectedEdgeColorOpacity(1):E.ndsModel.meshState.getSelectedEdgeColorOpacity(2)),!f&&p[A].lineSegMaterials){if(512<=p[A].lineSegMaterials.length+M)break;for(var b=0,B=p[A].lineSegMaterials.length;b<B;++b){var I,T,S=p[A];S.lineSegMaterials[b].visible&&(I=S.lineSegMaterials[b].range[0],T=S.lineSegMaterials[b].range[1]-I+1,I+=p[A].geometry.drawRange.start,c._multiDrawStarts[M]=I*y,c._multiDrawCounts[M]=T,v.value[2*M]=p[A].localIndex,v.value[2*M+1]=-1===x?S.lineSegMaterials[b].color_opacity:x,++M)}}else O.inOutlinePass&&p[A].bodyNode.renderMode===E.ndsModel.WIREFRAME||(c._multiDrawStarts[M]=p[A].geometry.drawRange.start*y,c._multiDrawCounts[M]=p[A].geometry.drawRange.count,v.value[2*M]=p[A].localIndex,v.value[2*M+1]=x,++M)}++A}0<M&&(c._multiDrawCount=M,v.needsUpdate=!0,v.__update_offset=0,v.__update_length=2*M,L.drawId2MeshIdUniformBlock.needsUpdate=!0,O.renderMeshDirect(i,r,c,null))}}return O.inOutlinePass||(n-=performance.now()-d),n},y=!1;this.render=function(e,t,r,i,n){y||(O.supportMultiDraw&&!L.drawId2MeshIdUniformBlock&&(L.drawId2MeshIdUniformBlock=new THREE.UniformsGroup,L.drawId2MeshIdUniformBlock.setName("drawId2MeshIdData"),L.drawId2MeshIdUniformBlock.add(new THREE.Uniform(new Int32Array(1024))),L.drawId2MeshIdUniformBlock.usage=THREE.DynamicDrawUsage),L.batchedPhongMtl||(L.batchedPhongMtl=new I({polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1},!1,!0,L.supportLargeUniformBuffer),L.batchedPhongMtl.uniformsGroups=[L.drawId2MeshIdUniformBlock],L.batchedTransparentPhongMtl=new I({depthWrite:!1,transparent:!0,polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1,side:THREE.DoubleSide},!1,!0,L.supportLargeUniformBuffer),L.batchedTransparentPhongMtl.uniformsGroups=[L.drawId2MeshIdUniformBlock],L.batchedDepthMtl=new sr({polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1},!1,!0,L.supportLargeUniformBuffer),L.batchedDepthMtl.uniformsGroups=[L.drawId2MeshIdUniformBlock]),L.batchedPhysicalMtl||(L.batchedPhysicalMtl=new T({polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1},!1,!0,L.supportLargeUniformBuffer),L.batchedPhysicalMtl.uniformsGroups=[L.drawId2MeshIdUniformBlock],L.batchedTransparentPhysicalMtl=new T({depthWrite:!1,transparent:!0,polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1,side:THREE.DoubleSide},!1,!0,L.supportLargeUniformBuffer),L.batchedTransparentPhysicalMtl.uniformsGroups=[L.drawId2MeshIdUniformBlock]),L.batchedLineBasicMtl||(L.batchedLineBasicMtl=new S({transparent:!0},!1,!0,L.supportLargeUniformBuffer),L.batchedLineBasicMtl.uniformsGroups=[L.drawId2MeshIdUniformBlock],L.batchedHiddenLineBasicMtl=new S({depthWrite:!0,transparent:!0,opacity:.2,depthFunc:THREE.GreaterDepth},!1,!0,L.supportLargeUniformBuffer),L.batchedHiddenLineBasicMtl.uniforms.overrideColor.value.x=0,L.batchedHiddenLineBasicMtl.uniforms.overrideColor.value.y=0,L.batchedHiddenLineBasicMtl.uniforms.overrideColor.value.z=0,L.batchedHiddenLineBasicMtl.uniforms.overrideColor.value.w=.2,L.batchedHiddenLineBasicMtl.uniformsGroups=[L.drawId2MeshIdUniformBlock]),L.instancedPhongMtl||(L.instancedPhongMtl=new I({polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1},!0,!1,L.supportLargeUniformBuffer)),L.instancedTransparentPhongMtl||(L.instancedTransparentPhongMtl=new I({depthWrite:!1,transparent:!0,polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1,side:THREE.DoubleSide},!0,!1,L.supportLargeUniformBuffer)),L.phongMtl||(L.phongMtl=new I({polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1},!1,!1,L.supportLargeUniformBuffer),L.phongMtl.uniformsGroups=[]),L.transparentMtl||(L.transparentMtl=new I({depthWrite:!1,transparent:!0,polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1,side:THREE.DoubleSide},!1,!1,L.supportLargeUniformBuffer)),L.instancedPhysicalMtl||(L.instancedPhysicalMtl=new T({polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1},!0,!1,L.supportLargeUniformBuffer)),L.physicalMtl||(L.physicalMtl=new T({polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1},!1,!1,L.supportLargeUniformBuffer),L.physicalMtl.uniformsGroups=[]),L.transparentPhysicalMtl||(L.transparentPhysicalMtl=new T({depthWrite:!1,transparent:!0,polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1,side:THREE.DoubleSide},!1,!1,L.supportLargeUniformBuffer)),L.instancedTransparentPhysicalMtl||(L.instancedTransparentPhysicalMtl=new T({depthWrite:!1,transparent:!0,polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1,side:THREE.DoubleSide},!0,!1,L.supportLargeUniformBuffer)),L.instancedDepthMtl||(L.instancedDepthMtl=new sr({polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1},!0,!1,L.supportLargeUniformBuffer)),L.depthMtl||(L.depthMtl=new sr({polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1},!1,!1,L.supportLargeUniformBuffer)),L.instancedLineMtl||(L.instancedLineMtl=new S({transparent:!0},!0,!1,L.supportLargeUniformBuffer),L.instancedTransparentLineMtl=new S({depthWrite:!1,transparent:!0},!0,!1,L.supportLargeUniformBuffer)),L.lineBasicMtl||(L.lineBasicMtl=new S({transparent:!0},!1,!1,L.supportLargeUniformBuffer),L.transparentLineBasicMtl=new S({depthWrite:!1,transparent:!0},!1,!1,L.supportLargeUniformBuffer)),y=!0),L.renderParams=n,f.length=0,f.isGlobalPass=!1,m.length=0,m.isGlobalPass=!1,g.length=0,g.isGlobalPass=!1,v.length=0,v.isGlobalPass=!1;if(e.state<ee.StateType.RENDERING_PREPARED)O.stopRenderingEarly=!0;else if((void 0===e.renderOnce||e.lineSegmentsSet.dirty||O.inOutlinePass)&&(e.renderOnce=!0),e.hasrenderMesh=!1,e.renderOnce){e.applyCull(n.renderInfo.frustum),e.meshManager.renderContext=O.renderContext,e.geomManager.renderContext=O.renderContext;for(var a=e.getDrawModeFace(),o=e.getDrawModeFaceColorMask(),s=(o?a&&(g.isGlobalPass=!0):f.isGlobalPass=!0,e.getMeshSets()),l=0;l<s.length;++l){var d,c,h=s[l];0===h.bodyNodes.length?h.visualStates.dirty=!1:(h.visualStates.dirty&&h.applyCull(),h.isCulled()||(d=0!=(h.renderMode&Ce.RENDER_BIT.NORMAL),0,c=h.needsMeshDraw(),O.inOutlinePass||h.needsLineDraw(d),h.isLoaded()?(h.prepareForBatchDraw(),o?c&&(a||d)&&g.push(h):(c&&f.push(h),d&&c&&g.push(h))):O.stopRenderingEarly=!0))}}var u,n=[f,m,g,v];e.viewer.clipDataManager.isSectionViewEnabled()&&(u=[L.batchedPhongMtl,L.batchedTransparentPhongMtl,L.batchedDepthMtl,L.batchedLineBasicMtl,L.batchedPhysicalMtl,L.batchedTransparentPhysicalMtl,L.phongMtl,L.instancedPhongMtl,L.transparentMtl,L.instancedTransparentPhongMtl,L.depthMtl,L.instancedDepthMtl,L.lineBasicMtl,L.instancedLineMtl,L.physicalMtl,L.instancedPhysicalMtl,L.transparentPhysicalMtl,L.instancedTransparentPhysicalMtl],e.viewer.clipDataManager.enableClipDraw(u),i=p(e,n,t,r,i),e.viewer.clipDataManager.disableClipDraw(u)),i&&p(e,n,t,r,i)}}var Pr=function(o){function e(e,t,r,i,n){var a;return void 0===t&&(t=!1),void 0===r&&(r=!1),void 0===i&&(i=!0),void 0===n&&(n=!0),(a=o.call(this,{type:"NdsBatched2DLine2BasicMaterial",uniforms:THREE.UniformsUtils.clone(THREE.ShaderLib.NdsBatched2DLine2Basic.uniforms),vertexShader:THREE.ShaderLib.NdsBatched2DLine2Basic.vertexShader,fragmentShader:THREE.ShaderLib.NdsBatched2DLine2Basic.fragmentShader,clipping:!0})||this).isNdsBatchedLineBasicMaterial=!0,t&&(a.defines={INSTANCE_MESH:""}),r&&(a.defines={BATCHED_MESH:""},a.extensions={multiDraw:!0}),n&&(a.defines.SUPPORT_UNIFORM_BLOCK=""),i&&(a.defines.USE_WORLDUNIT=""),a.setValues(e),a}var t,r,i;return r=o,(t=e).prototype=Object.create(r.prototype),Sr(t.prototype.constructor=t,r),t=e,(r=[{key:"resolution",get:function(){return this.uniforms.resolution.value},set:function(e){this.uniforms.resolution.value.copy(e)}}])&&Tr(t.prototype,r),i&&Tr(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}(THREE.ShaderMaterial),c={MU_MESH:0,MU_MESHMAP:1,MU_LINE:2,MU_LINETYPE:3,MU_LINE2PIEXL:4,MU_LINE2WORLD:5,MU_TTF:6,MU_SHX:7,MU_POINT:8,S_MESH:9,S_MESHMAP:10,S_LINE:11,S_LINETYPE:12,S_LINE2PIEXL:13,S_LINE2WORLD:14,S_TTF:15,S_SHX:16,S_POINT:17};function Hr(e,t){e.prototype=Object.create(t.prototype),_r(e.prototype.constructor=e,t)}function _r(e,t){return(_r=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}function Lr(e,t,r,i,n,a){void 0===a&&(a=!0),this.viewer=e,this.renderScene=r,this.renderCamera=i,this.selectedObjects=void 0!==n?n:[],this.visibleEdgeColor=new THREE.Color(255,255,255),this.edgeThickness=1,this.edgeStrength=1,this.downSampleRatio=2,this.shouldRenderMaskDownSample=a,u.call(this),this.resolution=void 0!==t?new THREE.Vector2(t.x,t.y):new THREE.Vector2(256,256),e={minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat},r=Math.round(this.resolution.x/this.downSampleRatio),i=Math.round(this.resolution.y/this.downSampleRatio),this.maskBufferMaterial=new THREE.MeshBasicMaterial({color:255}),this.maskBufferMaterial.side=THREE.DoubleSide,this.maskBufferMaterialCopy=(new this.maskBufferMaterial.constructor).copy(this.maskBufferMaterial),n=this.shouldRenderMaskDownSample?this.resolution.x:r,a=this.shouldRenderMaskDownSample?this.resolution.y:i,this.renderTargetMaskBuffer=new THREE.WebGLRenderTarget(n,a,e),this.renderTargetMaskBuffer.texture.name="OutlinePass.mask",this.renderTargetMaskBuffer.texture.generateMipmaps=!1,this.shouldRenderMaskDownSample&&(this.renderTargetMaskDownSampleBuffer=new THREE.WebGLRenderTarget(r,i,e),this.renderTargetMaskDownSampleBuffer.texture.name="OutlinePass.depthDownSample",this.renderTargetMaskDownSampleBuffer.texture.generateMipmaps=!1),this.renderTargetBlurBuffer1=new THREE.WebGLRenderTarget(r,i,e),this.renderTargetBlurBuffer1.texture.name="OutlinePass.blur1",this.renderTargetBlurBuffer1.texture.generateMipmaps=!1,this.edgeDetectionMaterial=this.getEdgeDetectionMaterial(),this.renderTargetEdgeBuffer1=new THREE.WebGLRenderTarget(r,i,e),this.renderTargetEdgeBuffer1.texture.name="OutlinePass.edge1",this.renderTargetEdgeBuffer1.texture.generateMipmaps=!1,this.separableBlurMaterial1=this.getSeperableBlurMaterial(4),this.separableBlurMaterial1.uniforms.texSize.value=new THREE.Vector2(r,i),this.separableBlurMaterial1.uniforms.kernelRadius.value=1,this.overlayMaterial=this.getOverlayMaterial(),t=je,this.copyUniforms=THREE.UniformsUtils.clone(t.uniforms),this.copyUniforms.opacity.value=1,this.materialCopy=new THREE.ShaderMaterial({uniforms:this.copyUniforms,vertexShader:t.vertexShader,fragmentShader:t.fragmentShader,blending:THREE.NoBlending,depthTest:!1,depthWrite:!1,transparent:!0}),this.enabled=!0,this.needsSwap=!1,this.oldClearColor=new THREE.Color,this.oldClearAlpha=1,this.camera=new THREE.OrthographicCamera(-1,1,1,-1,0,1),this.scene=new THREE.Scene,this.quad=new THREE.Mesh(new THREE.PlaneGeometry(2,2),null),this.quad.frustumCulled=!1,this.scene.add(this.quad)}function Or(e,t,r,i,n){this.tempSelectedObjects=[],this.tempScene=new THREE.Scene,Lr.call(this,e,t,r,i,n),this.visibleEdgeColor=new THREE.Color(0,1,0),this.edgeThickness=3,this.edgeStrength=3,this.downSampleRatio=2,this.tempPulseColor1=new THREE.Color,this.tempPulseColor2=new THREE.Color,this.textureMatrix=new THREE.Matrix4}function Fr(e,t,r,i){Lr.call(this,e,t,r,i,void 0,!0),this.blendMaterial=this.getBlendMaterial(),this.maskMarterial=this.getMaskPassMaterial(),this.renderSelectedMeshes=!1,this.shouldRenderOutline=!0,this.selectionMaterial=De.selectedMaterial,this.selectionMaterialCopy=(new this.selectionMaterial.constructor).copy(this.selectionMaterial),e={minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat},this.renderTargetSelectionBuffer=new THREE.WebGLRenderTarget(this.resolution.x,this.resolution.y,e),this.renderTargetSelectionBuffer.texture.name="OutlinePass.selection",this.renderTargetSelectionBuffer.texture.generateMipmaps=!1,this.visibleEdgeColor=new THREE.Color(250,225,0),this.edgeThickness=1,this.edgeStrength=3,this.downSampleRatio=2}function Ur(e,t){this.textureID=void 0!==t?t:"tDiffuse",this.uniforms=THREE.UniformsUtils.clone(e.uniforms),this.material=new THREE.ShaderMaterial({uniforms:this.uniforms,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader,defines:THREE.UniformsUtils.clone(e.defines)}),this.renderToScreen=!1,this.enabled=!0,this.clear=!1,this.camera=new THREE.OrthographicCamera(-1,1,1,-1,0,1);var t=new THREE.BufferGeometry,r=((e=new Float32Array(9))[0]=-1,e[1]=-1,e[2]=0,e[3]=3,e[4]=-1,e[5]=0,e[6]=-1,e[7]=3,e[8]=0,new Float32Array(6));r[0]=0,r[1]=0,r[2]=2,r[3]=0,r[4]=0,r[5]=2,t.addAttribute("position",new THREE.BufferAttribute(e,3)),t.addAttribute("uv",new THREE.BufferAttribute(r,2)),this.quad=new THREE.Mesh(t,this.material),this.scene=new THREE.Scene,this.scene.add(this.quad)}function Nr(e,t,r){this.baseUrl=e,this.options=t,this.crossOrigin=r}function Vr(e){this.manager=void 0!==e?e:THREE.DefaultLoadingManager}var Gr=function(S){function e(e){var n,s=S.call(this,e||{})||this,u=(THREE.DefaultSide=-1,console.log("THREE.WebGLRenderer",THREE.REVISION),s.enableProgressiveRender=!0,s.maxPrimitivesPerFrame=0,s.maxTrianglesPerFrame=1e5,s.maxLinesPerFrame=1e5,s.disableTransparent=!1,s.stopRenderingEarly=!1,s.renderContext.info.memory.ndsGeometries=0,s),m=e.is2DModel,a=s.getContext(),o=s.domElement,l=THREE.DefaultSide,A=(s.colorTarget=n,s._ndsCurrentTarget=null,new THREE.Matrix4),A=(s.capabilities.isWebGL2||(s.extensions.get("WEBGL_depth_texture"),s.extensions.get("OES_texture_float"),s.extensions.get("OES_texture_float_linear"),s.extensions.get("OES_texture_half_float"),s.extensions.get("OES_texture_half_float_linear"),s.extensions.get("OES_standard_derivatives"),s.extensions.get("ANGLE_instanced_arrays"),s.extensions.get("OES_vertex_array_object"),s.extensions.get("WEBGL_draw_buffers")),s.supportMultiDraw=!!s.extensions.get("WEBGL_multi_draw"),s.maxSupportUniformBufferSize=65536,a&&(s.maxSupportUniformBufferSize=a.getParameter(a.MAX_UNIFORM_BLOCK_SIZE)),console.log("Support multi-draw? "+s.supportMultiDraw),(s.capabilities.isWebGL2||s.extensions.get("OES_element_index_uint"))&&(THREE.BufferGeometry.MaxIndex=4294967296),s.__render_type__="normal",s._renderScene_=s.renderScene,s._render_=s.render,s._setSize_=s.setSize,new THREE.Matrix4);function d(e){var t,r,i=e.target;for(t in null!==i.index&&u.renderContext.attributes.remove(i.index),i.attributes)u.renderContext.attributes.remove(i.attributes[t]);for(r in i.morphAttributes)for(var n=i.morphAttributes[r],a=0,o=n.length;a<o;a++)u.renderContext.attributes.remove(n[a]);i.removeEventListener("dispose",d);e=u.renderContext.geometries.wireframeAttributes.get(i);e&&(u.renderContext.attributes.remove(e),u.renderContext.geometries.wireframeAttributes.delete(i)),u.renderContext.bindingStates.releaseStatesOfGeometry(i),!0===i.isInstancedBufferGeometry&&delete i._maxInstanceCount,u.renderContext.info.memory.ndsGeometries--}s._current_model_data_version_=-1,s.setSize=function(e,t,r){u._setSize_(e,t,r);var e=a.getParameter(a.MAX_TEXTURE_SIZE),t=2,r=o.width*(t=m?1:t),t=o.height*t,i=r/t;t<r?e<r&&(r=e,t=Math.floor(r/i)):e<t&&(t=e,r=Math.floor(t*i)),De.isVRmodel||De.isARmodel&&De.supportAR||n&&n.width===r&&n.height===t||(n&&(n.dispose(),n=null),e={magFilter:THREE.LinearFilter,minFilter:THREE.LinearFilter,format:THREE.RGBAFormat,type:THREE.UnsignedByteType,depthBuffer:!0,stencilBuffer:!1,depthTexture:null},(n=new THREE.WebGLRenderTarget(r,t,e)).texture.generateMipmaps=!1),this.colorTarget=n},s.clearTarget=function(e,t,r,i){De.isVRmodel||De.isARmodel&&De.supportAR||(this.setRenderTarget(e),this.clear(t,r,i))},s.supportInstancedArrays=function(){return this.capabilities.isWebGL2||!!this.extensions.get("ANGLE_instanced_arrays")},s.setNdsModelRenderSide=function(e){l=e},s.getNdsModelRenderSide=function(){return l};var M=function(e,t,r,i){He.onBeforeNdsMeshRender(r,u);var n=r.geometry;n.onNdsGeometryDispose||(n.addEventListener("dispose",d),n.onNdsGeometryDispose=d,u.renderContext.info.memory.ndsGeometries++),n.needsUpdate&&(u.renderContext.geometries.update(n),n.needsUpdate=!1),n.modelMatrixAttribute&&n.modelMatrixAttribute.unUsed&&(s.renderContext.attributes.remove(n.modelMatrixAttribute),r.geometry.deleteAttribute("modelMatrixAttrib"),r.geometry.modelMatrixAttribute=void 0),t.disableTransparent=s.disableTransparent,6.3<=s._current_model_data_version_?l!==THREE.DefaultSide&&(r.material.side=!0===r.hasSurface?THREE.DoubleSide:l):r.material.side=THREE.DoubleSide,t.overrideMaterial?(t.overrideMaterialCallBack&&t.overrideMaterialCallBack(r,t.overrideMaterial),u.renderBufferDirect(e,t,n,t.overrideMaterial,r,i)):u.renderBufferDirect(e,t,n,r.material,r,i)};s.renderMeshDirect=M,s.mcad3dRenderer=new ur(s),s.mcad2dRenderer=new Rr(s),s.ecad2dRenderer=new Cr(s),s.ecad3dRenderer=new Dr(s);var t=!(s.drawSelectedBodyMeshes=function(e,t,r,i){for(var n=e.getSelectedBodies(),a=0,o=n.length;a<o;++a){var s=n[a];if(s.ndsModel.id===e.id&&!(s.renderMode>e.SHADED)){var l=s.isHidden(),d=!1;l&&s.show(),De.HideLeafBody&&(c=s.parent.FirstVisibleNode||0,d=s.parent.children[c].isHidden())&&s.parent.children[c].show();for(var c,h=0,u=e.meshManager.getNumBodyMeshs(s);h<u;++h){var p,f=e.meshManager.getBodyMesh(s,h);f&&(e.viewer.selectionManager.shouldApplySelectedMaterial&&(f.material=e.meshManager.selectedMaterial,e.meshManager.overrideMaterial)&&(f.material=e.meshManager.overrideMaterial),m||"MeshBasicMaterial"==f.material.type||(f.geometry.attributes.normal?f.material.flatShading=!1:f.material.flatShading=!0),p=!1,e.viewer.clipDataManager.isSectionViewEnabled()&&e.viewer.clipDataManager.isCurrentNodeClipped(s)&&(e.viewer.clipDataManager.enableClipDraw([f.material]),p=!0),f.modelViewMatrix.multiplyMatrices(r.matrixWorldInverse,f.matrixWorld),f.matrixAutoUpdate=!1,f.matrixWorldNeedsUpdate=!1,i||(f.material.colorWrite=!1),M(r,t,f,null),i||(f.material.colorWrite=!0),p)&&e.viewer.clipDataManager.disableClipDraw([f.material])}l&&(s.hide(),De.HideLeafBody)&&d&&(c=s.parent.FirstVisibleNode||0,s.parent.children[c].hide())}}}),r=null;function i(e){null!==r&&r(e),(vr.getDevice()||window).requestAnimationFrame(i)}s.animate=function(e){r=e,t||((vr.getDevice()||window).requestAnimationFrame(i),t=!0)};var c,h,p,f,g,v,y,E,w,x,b=new THREE.Vector3,B=new THREE.Quaternion,I=new THREE.Vector3;function T(){for(var e=0;e<5;e++){var t=new THREE.Mesh(c,new THREE.MeshPhysicalMaterial({color:new THREE.Color(Math.random(),Math.random(),Math.random()),opacity:0,metalness:Math.random(),roughness:Math.random(),transparent:!0}));t.position.x=e%2==0?150*Math.random():-150*Math.random(),t.position.y=e%2==0?150*Math.random():-150*Math.random(),t.position.z=10*Math.random(),t.rotateX(1.5*Math.random()),t.rotateX(Math.random()),h.add(t)}}return s.renderScene=function(e,n,a,t,r){var g,i,o,v,s,l=this,y=(a.pixelSizeVector=(i=u.domElement.clientWidth,s=u.domElement.clientHeight,d=a.projectionMatrix,o=a.matrixWorldInverse,c=d.elements[0]*i*.5,i=d.elements[8]*i*.5+d.elements[11]*i*.5,c=new THREE.Vector3(o.elements[0]*c+o.elements[2]*i,o.elements[4]*c+o.elements[6]*i,o.elements[8]*c+o.elements[10]*i),i=d.elements[5]*s*.5,s=d.elements[9]*s*.5+d.elements[11]*s*.5,i=new THREE.Vector3(o.elements[1]*i+o.elements[2]*s,o.elements[5]*i+o.elements[6]*s,o.elements[9]*i+o.elements[10]*s),s=d.elements[11],d=d.elements[15],s=new THREE.Vector4(o.elements[2]*s,o.elements[6]*s,o.elements[10]*s,o.elements[14]*s+o.elements[15]*d),o=.7071067811/Math.sqrt(c.lengthSq()+i.lengthSq()),s.multiplyScalar(o),s),r.ndsModelset),d=(r.ndsModel,this.inOutlinePass=r.inOutlinePass,e.opaque),c=e.transparent,h=(r.renderInfo.currentRenderState.setupLightsView(a),!0===r.renderInfo.clippingEnabled&&this.renderContext.clipping.setGlobalState(u.clippingPlanes,a),t&&this.setViewportDirect(t),!1);u.stopRenderingEarly=!1,He.onBeforeNdsModelSetRender(y,u),y&&(u.__lightsChanged=!1,i=u.renderContext.renderStates.get(n).state.lights.state,u.__lightsVersion!==i.version&&(u.__lightsVersion=i.version,u.__lightsChanged=!0),r.bDrawReferenceEntity?(o=y.activeModel,y.models.forEach(function(e){var t,r,i;y.activeModel=e,t=n,r=a,(e=e).referenceEntityDirty&&0<e.wholeRefEntityNodes.length&&!e.referenceEntityDispManager.overrideMaterial&&(performance.now(),(i=e.referenceEntityDispManager.getAxisDispData()).normalAxisLines&&(i.normalAxisLines.modelViewMatrix.copy(r.matrixWorldInverse),i.normalAxisLines.matrixAutoUpdate=!1,i.normalAxisLines.matrixWorldNeedsUpdate=!1,M(r,t,i.normalAxisLines,null)),i.selectedAxisLines&&(i.selectedAxisLines.modelViewMatrix.copy(r.matrixWorldInverse),i.selectedAxisLines.matrixAutoUpdate=!1,i.selectedAxisLines.matrixWorldNeedsUpdate=!1,M(r,t,i.selectedAxisLines,null)),i.preselectedAxisLines&&(i.preselectedAxisLines.modelViewMatrix.copy(r.matrixWorldInverse),i.preselectedAxisLines.matrixAutoUpdate=!1,i.preselectedAxisLines.matrixWorldNeedsUpdate=!1,M(r,t,i.preselectedAxisLines,null)),(i=e.referenceEntityDispManager.getPlaneDispData()).normalPlaneEdge&&(i.normalPlaneEdge.modelViewMatrix.copy(r.matrixWorldInverse),i.normalPlaneEdge.matrixAutoUpdate=!1,i.normalPlaneEdge.matrixWorldNeedsUpdate=!1,u.renderContext.objects.update(i.normalPlaneEdge),M(r,t,i.normalPlaneEdge,null)),i.selectedPlaneEdge&&(i.selectedPlaneEdge.modelViewMatrix.copy(r.matrixWorldInverse),i.selectedPlaneEdge.matrixAutoUpdate=!1,i.selectedPlaneEdge.matrixWorldNeedsUpdate=!1,M(r,t,i.selectedPlaneEdge,null)),i.preselectedPlaneEdge&&(i.preselectedPlaneEdge.modelViewMatrix.copy(r.matrixWorldInverse),i.preselectedPlaneEdge.matrixAutoUpdate=!1,i.preselectedPlaneEdge.matrixWorldNeedsUpdate=!1,M(r,t,i.preselectedPlaneEdge,null)),i.normalPlaneMesh&&(i.normalPlaneMesh.modelViewMatrix.copy(r.matrixWorldInverse),i.normalPlaneMesh.matrixAutoUpdate=!1,i.normalPlaneMesh.matrixWorldNeedsUpdate=!1,M(r,t,i.normalPlaneMesh,null)),i.selectedPlaneMesh&&(i.selectedPlaneMesh.modelViewMatrix.copy(r.matrixWorldInverse),i.selectedPlaneMesh.matrixAutoUpdate=!1,i.selectedPlaneMesh.matrixWorldNeedsUpdate=!1,M(r,t,i.selectedPlaneMesh,null)),i.preselectedPlaneMesh&&(i.preselectedPlaneMesh.modelViewMatrix.copy(r.matrixWorldInverse),i.preselectedPlaneMesh.matrixAutoUpdate=!1,i.preselectedPlaneMesh.matrixWorldNeedsUpdate=!1,M(r,t,i.preselectedPlaneMesh,null)),e.referenceEntityDirty=!1,performance.now())}),y.activeModel=o):((s=y.getSubModelSet("MCAD3D"))&&this.mcad3dRenderer.render(s,n,a,r.remainTime,r),e=y.activeModel,y.models.forEach(function(e){y.activeModel=e,De.isVRmodel||De.isARmodel&&De.supportAR?renderNDSVR(e,n,a,r.remainTime,r):e.isMCAD3DModel||(e.isMCAD2DModel?l.mcad2dRenderer.render(e,n,a,r.remainTime,r):e.isECAD2DModel?l.ecad2dRenderer.render(e,n,a,r.remainTime,r):e.isECAD3DModel&&l.ecad3dRenderer.render(e,n,a,r.remainTime,r))}),y.activeModel=e)),y&&y.viewer.pmiObject&&(g=y.viewer.getCameraInfo(),t=null,t=y.viewer.controls.getBoundingBox().clone(),i=new THREE.Vector3,t.getCenter(i),o=t.min.distanceTo(t.max),v=Math.abs(i.distanceTo(g.position))-.5*o,y.viewer.pmiObject.traverse(function(e){function t(e){if(e.fixedPmi&&e.fixedBox){var t=function e(t){if("Mesh"===t.type&&"TextBufferGeometry"===t.geometry.type)return t.scale.x;if(!(t.children&&0<t.children.length))return null;for(var r=0;r<t.children.length;r++){var i=e(t.children[r]);if(i)return i}}(e);if(y.viewer.camera.IsPerspective()){var r,i=new THREE.Vector3(1,0,0),n=new THREE.Vector3(0,1,0),a=(i.applyQuaternion(B),n.applyQuaternion(B),700),o=e.textSize/10,o=(a*=o,r=3*o,Math.abs(g.far/2)/a),s=(i.multiplyScalar(o),n.multiplyScalar(o),I.set(o,o,1),(new THREE.Vector3).subVectors(g.target,g.position));switch(s.normalize().multiplyScalar(g.far/2),b.copy(g.position).add(s),e.fixedPmiNum){case 0:b.add(i.multiplyScalar(-180*r-e.fixedBox.min.x)),b.add(n.multiplyScalar(-80*r-e.fixedBox.min.y));break;case 1:b.add(i.multiplyScalar(180*r-e.fixedBox.max.x)),b.add(n.multiplyScalar(-80*r-e.fixedBox.min.y));break;case 2:b.add(i.multiplyScalar(180*r-e.fixedBox.max.x)),b.add(n.multiplyScalar(80*r-e.fixedBox.max.y));break;case 3:b.add(i.multiplyScalar(-180*r-e.fixedBox.min.x)),b.add(n.multiplyScalar(80*r-e.fixedBox.max.y));break;case 4:b.add(i.multiplyScalar(0-e.fixedBox.min.x)),b.add(n.multiplyScalar(-80*r-e.fixedBox.min.y));break;case 5:b.add(i.multiplyScalar(-180*r-e.fixedBox.min.x)),b.add(n.multiplyScalar(0-e.fixedBox.min.y));break;case 6:b.add(i.multiplyScalar(0-e.fixedBox.min.x)),b.add(n.multiplyScalar(80*r-e.fixedBox.max.y));break;case 7:b.add(i.multiplyScalar(-180*r-e.fixedBox.min.x)),b.add(n.multiplyScalar(0-e.fixedBox.min.y))}}else{var l,d=new THREE.Vector3(1,0,0),c=new THREE.Vector3(0,1,0),a=(d.applyQuaternion(B),c.applyQuaternion(B),600),s=e.textSize*t/7.5,o=(a*=s,l=3*s,Math.abs(g.left)/a),t=(d.multiplyScalar(o),c.multiplyScalar(o),I.set(o,o,1),(new THREE.Vector3).subVectors(g.target,g.position));switch(t.normalize().multiplyScalar(v),b.copy(g.position).add(t),e.fixedPmiNum){case 0:b.add(d.multiplyScalar(-180*l-e.fixedBox.min.x)),b.add(c.multiplyScalar(-50*l-e.fixedBox.min.y));break;case 1:b.add(d.multiplyScalar(180*l-e.fixedBox.max.x)),b.add(c.multiplyScalar(-50*l-e.fixedBox.min.y));break;case 2:b.add(d.multiplyScalar(180*l-e.fixedBox.max.x)),b.add(c.multiplyScalar(80*l-e.fixedBox.max.y));break;case 3:b.add(d.multiplyScalar(-180*l-e.fixedBox.min.x)),b.add(c.multiplyScalar(80*l-e.fixedBox.max.y));break;case 4:b.add(d.multiplyScalar(0-e.fixedBox.min.x)),b.add(c.multiplyScalar(-50*l-e.fixedBox.min.y));break;case 5:b.add(d.multiplyScalar(-180*l-e.fixedBox.min.x)),b.add(c.multiplyScalar(0-e.fixedBox.min.y));break;case 6:b.add(d.multiplyScalar(0-e.fixedBox.min.x)),b.add(c.multiplyScalar(80*l-e.fixedBox.max.y));break;case 7:b.add(d.multiplyScalar(-180*l-e.fixedBox.min.x)),b.add(c.multiplyScalar(0-e.fixedBox.min.y))}}}}if(e.followCamera)if("Mesh"===e.type&&"TextBufferGeometry"===e.geometry.type)e.quaternion.copy(y.viewer.camera.quaternion),e.updateMatrix(),e.updateMatrixWorld(!0),e.matrixAutoUpdate=!1;else if(0<e.children.length&&function(e){for(var t=0;t<e.length;t++){var r=e[t];if(0===t||5===t||10===t){if(1!==r)return 1}else if((1===t||2===t||4===t||6===t||8===t||9===t)&&0!==r)return 1}}(e.children[0].matrix.toArray())){e.children[0].matrix.decompose(b,B,I);var r=B.clone().conjugate(),i=(e.originMatrixWorld.decompose(b,B,I),B.clone().invert()),r=(B.copy(r),B.premultiply(y.viewer.camera.quaternion),B.clone().multiply(i));e.fixedPmi&&e.fixedBox?t(e):e.followCameraCenter&&((i=b.clone().sub(e.followCameraCenter)).applyQuaternion(r),b.copy(e.followCameraCenter).add(i)),e.matrixWorld.compose(b,B,I),e.matrixAutoUpdate=!1;for(var n=0;n<e.children.length;n++)e.children[n].updateMatrixWorld(!0)}else{e.originMatrixWorld.decompose(b,B,I);r=B.clone().invert(),i=(B.copy(y.viewer.camera.quaternion),B.clone().multiply(r));e.fixedPmi&&e.fixedBox?t(e):e.followCameraCenter&&((r=b.clone().sub(e.followCameraCenter)).applyQuaternion(i),b.copy(e.followCameraCenter).add(r)),e.matrixWorld.compose(b,B,I),e.matrixAutoUpdate=!1;for(var a=0;a<e.children.length;a++)e.children[a].updateMatrixWorld(!0)}if(e.hasOrientation&&e.line&&e.visible){var i=[],r=(i[0]=e.line.start.x,i[1]=e.line.start.y,i[2]=e.line.start.z,y.viewer.modelCoordToClientCoord(i)),i=((i=[])[0]=e.line.end.x,i[1]=e.line.end.y,i[2]=e.line.end.z,y.viewer.modelCoordToClientCoord(i)),o=i[0]-r[0],i=i[1]-r[1],s=!1;if(Math.abs(o),(5.67*o<i&&-5.67*o<i||i<5.67*o&&i<-5.67*o)&&1e-7<Math.abs(o))s=!0;else if(0<(o=Math.abs(o)<1e-7&&(o=-1,i<0)?1:o))for(var l=0;l<e.children.length;l++){var d=e.children[l];d.autoOrientation&&(d.matrixWorld.copy(d.originMatrixWorld),d.overturn=!1)}else for(var c=0;c<e.children.length;c++){var h=e.children[c];h.autoOrientation&&(h.matrixWorld.copy(h.originMatrixWorld),A.makeTranslation(-e.axis.start.x,-e.axis.start.y,-e.axis.start.z),h.matrixWorld.premultiply(A),A.makeRotationAxis(new THREE.Vector3(e.axis.end.x-e.axis.start.x,e.axis.end.y-e.axis.start.y,e.axis.end.z-e.axis.start.z),Math.PI),h.matrixWorld.premultiply(A),A.makeTranslation(e.axis.start.x,e.axis.start.y,e.axis.start.z),h.matrixWorld.premultiply(A),h.overturn=!1)}r=y.viewer.camera.getCameraTarget(),i=y.viewer.camera.position,o=new THREE.Vector3,r=(o.subVectors(r,i),new THREE.Vector3);if(r.subVectors(e.axis.start,e.axis.end),0==(o.dot(r)<=0?0:1))for(var u=0;u<e.children.length;u++){var p=e.children[u];!p.autoOrientation||s&&p.overturn||(A.makeTranslation(-e.axis.start.x,-e.axis.start.y,-e.axis.start.z),p.matrixWorld.premultiply(A),A.makeRotationAxis(new THREE.Vector3(e.line.end.x-e.line.start.x,e.line.end.y-e.line.start.y,e.line.end.z-e.line.start.z).normalize(),Math.PI),p.matrixWorld.premultiply(A),A.makeTranslation(e.axis.start.x,e.axis.start.y,e.axis.start.z),p.matrixWorld.premultiply(A),p.overturn=!0)}else for(var f=0;f<e.children.length;f++){var m=e.children[f];m.autoOrientation&&s&&m.overturn&&(m.matrixWorld.copy(m.originMatrixWorld),m.overturn=!1)}}})),He.onAfterNdsModelSetRender(y,u),n.overrideMaterial?(s=n.overrideMaterial,d.length&&this.renderObjects(d,n,a,s),c.length&&this.renderObjects(c,n,a,s)):(y&&!y.viewer.CADViewer?(5==y.viewer.getRenderMode()||4==y.viewer.getRenderMode()?y.models.forEach(function(e){h|=e.hasrenderMesh}):h=!0,d.length&&h&&this.renderObjects(d,n,a)):d.length&&this.renderObjects(d,n,a),c.length&&this.renderObjects(c,n,a),this.renderContext.state.buffers.depth.setTest(!0),this.renderContext.state.buffers.depth.setMask(!0),this.renderContext.state.buffers.color.setMask(!0),this.renderContext.state.setPolygonOffset(!1))},s.render=function(e,t,r,i,n,a,o){void 0===o&&(o=60);var s=null,l=(0<e.children.length&&e.children[e.children.length-1]instanceof er&&(s=e.children.pop()),null),d=(0<e.children.length&&e.children[e.children.length-1]instanceof ee&&(l=e.children.pop()),void 0===r&&(r=null),De.isVRmodel||De.isARmodel&&De.supportAR||(this.setRenderTarget(r),i&&(r?this.clearTarget(r):this.clear())),De.isARmodel&&De.supportAR&&t.ARCamera&&(t=t.ARCamera),!1);r&&"OutlinePass.selection"===r.texture.name&&(d=!0),this._render_(e,t,{forceClear:i,bDrawForPick:n,bDrawReferenceEntity:a,inOutlinePass:d,remainTime:this.tryRenderAll?500:o,ndsModelset:s,ndsModel:l})},s.checkGPUPerformance=(c=new(function(T){function e(e,t,r,i){void 0===e&&(e=1),void 0===t&&(t=1),void 0===r&&(r=1),void 0===i&&(i=1),(n=T.call(this)||this).type="PlaneGeometry",n.parameters={width:e,height:t,widthSegments:r,heightSegments:i};for(var n,a=e/2,o=t/2,s=Math.floor(r),l=Math.floor(i),d=s+1,c=l+1,h=e/s,u=t/l,p=new Uint32Array(c*d*6),f=new Float32Array(c*d*3),m=new Float32Array(c*d*3),g=0,v=0;v<c;v++)for(var y=v*u-o,A=0;A<d;A++){var M=A*h-a,E=Math.random();f[3*g+0]=M,f[3*g+1]=-y,f[3*g+2]=.5<=E?10*E:-10*E,m[3*g+0]=g%5/5,m[3*g+1]=g%3/3,m[3*g+2]=1,++g}for(var g=0,w=0;w<l;w++)for(var x=0;x<s;x++){var b=x+d*(w+1),B=x+1+d*(w+1),I=x+1+d*w;p[g++]=x+d*w,p[g++]=b,p[g++]=I,p[g++]=b,p[g++]=B,p[g++]=I}return n.setIndex(new THREE.BufferAttribute(p,1)),n.setAttribute("position",new THREE.BufferAttribute(f,3,!1)),n.setAttribute("normal",new THREE.BufferAttribute(m,3,!1)),n}return Hr(e,T),e}(THREE.BufferGeometry))(100,100,1e3,2e3),h=new THREE.Group,p=c.index.array.length/3,(f=new THREE.PerspectiveCamera(60,1,1,1e3)).position.z=300,(g=new THREE.Scene).add(new THREE.HemisphereLight(new THREE.Color(16777215),new THREE.Color(5592405),1)),g.add(new THREE.DirectionalLight(new THREE.Color(16777215),1)),g.add(new THREE.DirectionalLight(new THREE.Color(16711680),.2)),g.add(new THREE.PointLight(new THREE.Color(65280),.2,1e3)),g.add(h),T(),E=[],w=[],x=y=v=0,function(e,t){if(0===y)return y=e||0,s.render(g,f),60;if(v=1e3/(e-y),E.push(v),10===E.length){for(var r=E[0],i=1;i<10;++i)r+=E[i];if(v=r/10,E.length=0,1===h.children.length?v=60:w[w.length]={fps:v,triangles:h.children.length*p},v<=t||5===w.length){if(v<t&&w.length<5&&0===x)return x=1,60;h.children[0].geometry.dispose();for(var n=0,a=h.children.length;n<a;++n)h.children[n].material.dispose();var o=w[w.length-1],o=(v=o.fps,1===x&&(v=(v+w[w.length-2].fps)/2),o.triangles*v/1e3);return s.datumTrianglesPerFrame=1e3*o/t,s.datumTrianglesPerFrame*=.35,0}T()}else v=60;return y=e,s.render(g,f),v}),s}return Hr(e,S),e}(Pe.isSupportCanvas2()?THREE.WebGLRenderer:THREE.WebGL1Renderer);Lr.prototype=Object.assign(Object.create(u.prototype),{constructor:Lr,dispose:function(){this.renderTargetMaskBuffer.dispose(),this.shouldRenderMaskDownSample&&this.renderTargetMaskDownSampleBuffer.dispose(),this.renderTargetBlurBuffer1.dispose(),this.renderTargetEdgeBuffer1.dispose()},setSize:function(e,t){var r=Math.round(e/this.downSampleRatio),i=Math.round(t/this.downSampleRatio);(this.shouldRenderMaskDownSample?(this.renderTargetMaskBuffer.setSize(e,t),this.renderTargetMaskDownSampleBuffer):this.renderTargetMaskBuffer).setSize(r,i),this.renderTargetBlurBuffer1.setSize(r,i),this.renderTargetEdgeBuffer1.setSize(r,i),this.separableBlurMaterial1.uniforms.texSize.value=new THREE.Vector2(r,i)},changeVisibilityOfNonSelectedObjects:function(a){var o=[];function e(e){(e instanceof THREE.Mesh||e instanceof THREE.SkinnedMesh||e instanceof THREE.Line||e instanceof THREE.LineSegments)&&o.push(e)}for(var t=0,r=this.selectedObjects.length;t<r;t++)this.selectedObjects[t].traverse(e);this.renderScene.traverse(function(e){if(e instanceof THREE.Mesh||e instanceof THREE.SkinnedMesh||e instanceof THREE.Line||e instanceof THREE.LineSegments){for(var t,r=!1,i=0,n=o.length;i<n;i++)if(o[i].id===e.id){r=!0;break}r||(t=e.visible,a&&!e.bVisible||(e.visible=a),e.bVisible=t)}})},renderToMaskBuffer:function(e){e.render(this.renderScene,this.renderCamera,this.renderTargetMaskBuffer,!0)},renderSelectedMesh:function(e){},hideUnselectedObjects:function(){this.viewer.ndsModel?(this.viewer.ndsModel.setDrawMode(this.viewer.ndsModel.SHADED),this.renderScene.children.push(this.viewer.ndsModel),this.viewer.ndsModel.setOverrideMaterial(this.maskBufferMaterial,this.maskBufferMaterialCopy,!1)):(this.changeVisibilityOfNonSelectedObjects(!1),this.renderScene.overrideMaterial=this.maskBufferMaterial)},resetVisibleState:function(){if(this.viewer.ndsModel){this.viewer.ndsModel.setOverrideMaterial(null,null,!1),this.viewer.ndsModel.resetAllBodiesFlag(),this.viewer.ndsModel.resetEmptyBodyNodeVisibleState(),this.viewer.ndsModel.resetDirty();for(var e=0,t=this.renderScene.children.length;e<t;e++)this.renderScene.children[e]!=this.viewer.ndsModel&&void 0!==this.renderScene.children[e].oldVisible&&(this.renderScene.children[e].visible=this.renderScene.children[e].oldVisible,this.renderScene.children[e].oldVisible=void 0);for(e=0,t=this.selectedObjects.length;e<t;e++)this.selectedObjects[e].oldVisible&&this.selectedObjects[e].oldVisible!==this.selectedObjects[e].visible&&!this.selectedObjects[e].isEmptyNode()&&(this.selectedObjects[e].oldVisible?this.viewer.ndsModel.showBody(this.selectedObjects[e]):this.viewer.ndsModel.hideBody(this.selectedObjects[e])),this.selectedObjects[e].oldVisible=void 0}else this.renderScene.overrideMaterial=null,this.changeVisibilityOfNonSelectedObjects(!0)},renderToColorBuffer:function(e,t,r){this.quad.material=this.overlayMaterial,this.overlayMaterial.uniforms.maskTexture.value=this.renderTargetMaskBuffer.texture,this.overlayMaterial.uniforms.edgeTexture1.value=this.renderTargetEdgeBuffer1.texture,this.overlayMaterial.uniforms.edgeStrength.value=this.edgeStrength,r&&e.context.enable(e.context.STENCIL_TEST),this.viewer.ndsModel?e.render(this.scene,this.camera,t,!1):e.render(this.scene,this.camera)},renderOutline:function(e,t,r){r&&e.context.disable(e.context.STENCIL_TEST);var i=this.renderScene.getObjectByName("rotateCenterHelper"),n=!0,i=(i&&(n=i.visible,i.visible=!1),this.viewer.ndsModel?this.renderScene.children.push(this.viewer.ndsModel):(this.changeVisibilityOfNonSelectedObjects(!1),this.renderScene.overrideMaterial=this.maskBufferMaterial),this.renderSelectedMesh(e),e.setClearColor(16777215,1),this.renderToMaskBuffer(e),i&&(i.visible=n),this.viewer.ndsModel.setOverrideMaterial(null,null,!1),this.shouldRenderMaskDownSample&&(this.quad.material=this.materialCopy,this.copyUniforms.tDiffuse.value=this.renderTargetMaskBuffer.texture,e.render(this.scene,this.camera,this.renderTargetMaskDownSampleBuffer,!0)),this.quad.material=this.edgeDetectionMaterial,this.shouldRenderMaskDownSample?this.renderTargetMaskDownSampleBuffer:this.renderTargetMaskBuffer);this.edgeDetectionMaterial.uniforms.maskTexture.value=i.texture,this.edgeDetectionMaterial.uniforms.texSize.value=new THREE.Vector2(i.width,i.height),this.edgeDetectionMaterial.uniforms.edgeColor.value=this.visibleEdgeColor,e.render(this.scene,this.camera,this.renderTargetEdgeBuffer1,!0),this.quad.material=this.separableBlurMaterial1,this.separableBlurMaterial1.uniforms.colorTexture.value=this.renderTargetEdgeBuffer1.texture,this.separableBlurMaterial1.uniforms.direction.value=Lr.BlurDirectionX,this.separableBlurMaterial1.uniforms.kernelRadius.value=this.edgeThickness,e.render(this.scene,this.camera,this.renderTargetBlurBuffer1,!0),this.separableBlurMaterial1.uniforms.colorTexture.value=this.renderTargetBlurBuffer1.texture,this.separableBlurMaterial1.uniforms.direction.value=Lr.BlurDirectionY,e.render(this.scene,this.camera,this.renderTargetEdgeBuffer1,!0),this.renderToColorBuffer(e,t,r)},render:function(e,t,r,i,n){var a;0!==this.selectedObjects.length&&(e.getClearColor(this.oldClearColor),this.oldClearAlpha=e.getClearAlpha(),a=e.autoClear,e.autoClear=!1,this.renderOutline(e,r,n),e.setClearColor(this.oldClearColor,this.oldClearAlpha),e.autoClear=a)},getEdgeDetectionMaterial:function(){return new THREE.ShaderMaterial({uniforms:{maskTexture:{value:null},texSize:{value:new THREE.Vector2(.5,.5)},edgeColor:{value:new THREE.Vector3(1,1,1)}},vertexShader:"varying vec2 vUv;\n               void main() {\n                   vUv = uv;\n                   gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n               }",fragmentShader:"varying vec2 vUv;               uniform sampler2D maskTexture;               uniform vec2 texSize;               uniform vec3 edgeColor;                              void main() {\n                   vec2 invSize = 1.0 / texSize;                   vec4 uvOffset = vec4(1.0, 0.0, 0.0, 1.0) * vec4(invSize, invSize);                   vec4 c1 = texture2D( maskTexture, vUv + uvOffset.xy);                   vec4 c2 = texture2D( maskTexture, vUv - uvOffset.xy);                   vec4 c3 = texture2D( maskTexture, vUv + uvOffset.yw);                   vec4 c4 = texture2D( maskTexture, vUv - uvOffset.yw);                   float diff1 = (c1.r - c2.r)*0.5;                   float diff2 = (c3.r - c4.r)*0.5;                   float d = length( vec2(diff1, diff2) );                   gl_FragColor = vec4(edgeColor, 1.0) * vec4(d);               }"})},getSeperableBlurMaterial:function(e){return new THREE.ShaderMaterial({defines:{MAX_RADIUS:e},uniforms:{colorTexture:{value:null},texSize:{value:new THREE.Vector2(.5,.5)},direction:{value:new THREE.Vector2(.5,.5)},kernelRadius:{value:1}},vertexShader:"varying vec2 vUv;\n               void main() {\n                   vUv = uv;\n                   gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n               }",fragmentShader:"#include <common>               varying vec2 vUv;               uniform sampler2D colorTexture;               uniform vec2 texSize;               uniform vec2 direction;               uniform float kernelRadius;                              float gaussianPdf(in float x, in float sigma) {                   return 0.39894 * exp( -0.5 * x * x/( sigma * sigma))/sigma;               }               void main() {                   vec2 invSize = 1.0 / texSize;                   float weightSum = gaussianPdf(0.0, kernelRadius);                   vec3 diffuseSum = texture2D( colorTexture, vUv).rgb * weightSum;                   vec2 delta = direction * invSize * kernelRadius/float(MAX_RADIUS);                   vec2 uvOffset = delta;                   for( int i = 1; i <= MAX_RADIUS; i ++ ) {                       float w = gaussianPdf(uvOffset.x, kernelRadius);                       vec3 sample1 = texture2D( colorTexture, vUv + uvOffset).rgb;                       vec3 sample2 = texture2D( colorTexture, vUv - uvOffset).rgb;                       diffuseSum += ((sample1 + sample2) * w);                       weightSum += (2.0 * w);                       uvOffset += delta;                   }                   float alpha = texture2D( colorTexture, vUv).a;                   gl_FragColor = vec4(diffuseSum/weightSum, alpha);               }"})},getOverlayMaterial:function(){return new THREE.ShaderMaterial({uniforms:{maskTexture:{value:null},edgeTexture1:{value:null},edgeStrength:{value:1}},vertexShader:"varying vec2 vUv;\n               void main() {\n                   vUv = uv;\n                   gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n               }",fragmentShader:"varying vec2 vUv;               uniform sampler2D maskTexture;               uniform sampler2D edgeTexture1;               uniform float edgeStrength;                              void main() {                   vec4 edgeValue = texture2D(edgeTexture1, vUv);                   vec4 maskColor = texture2D(maskTexture, vUv);                   vec4 finalColor = edgeStrength * maskColor.r * edgeValue;                   gl_FragColor = finalColor;               }",blending:THREE.NormalBlending,depthTest:!1,depthWrite:!1,transparent:!0})}}),Lr.BlurDirectionX=new THREE.Vector2(1,0),Lr.BlurDirectionY=new THREE.Vector2(0,1),Or.prototype=Object.assign(Object.create(Lr.prototype),{constructor:Or,renderToMaskBuffer:function(e){if(0<this.tempSelectedObjects.length)for(var t=0,r=this.tempSelectedObjects.length;t<r;t++)this.tempScene.children.push(this.tempSelectedObjects[t]);e.render(this.renderScene,this.renderCamera,this.renderTargetMaskBuffer,!0),e.render(this.tempScene,this.renderCamera,this.renderTargetMaskBuffer,!1),0<this.tempSelectedObjects.length&&(this.tempScene.children.length=0)},render:function(e,t,r,i,n){var a;0===this.selectedObjects.length&&0===this.tempSelectedObjects.length||(e.getClearColor(this.oldClearColor),this.oldClearAlpha=e.getClearAlpha(),a=e.autoClear,e.autoClear=!1,this.renderOutline(e,r,n),e.setClearColor(this.oldClearColor,this.oldClearAlpha),e.autoClear=a)}}),Fr.prototype=Object.assign(Object.create(Lr.prototype),{constructor:Fr,dispose:function(){this.renderTargetMaskBuffer.dispose(),this.renderTargetSelectionBuffer.dispose(),this.shouldRenderMaskDownSample&&this.renderTargetMaskDownSampleBuffer.dispose(),this.renderTargetBlurBuffer1.dispose(),this.renderTargetEdgeBuffer1.dispose()},setSize:function(e,t){var r=Math.round(e/this.downSampleRatio),i=Math.round(t/this.downSampleRatio);(this.shouldRenderMaskDownSample?(this.renderTargetMaskBuffer.setSize(e,t),this.renderTargetMaskDownSampleBuffer):this.renderTargetMaskBuffer).setSize(r,i),this.renderTargetSelectionBuffer.setSize(e,t),this.renderTargetBlurBuffer1.setSize(r,i),this.renderTargetEdgeBuffer1.setSize(r,i),this.separableBlurMaterial1.uniforms.texSize.value=new THREE.Vector2(r,i)},hideUnselectedObjects:function(){this.viewer.ndsModel?this.renderScene.children.push(this.viewer.ndsModel):this.changeVisibilityOfNonSelectedObjects(!1)},renderToMaskBuffer:function(e){this.quad.material=this.maskMarterial,this.maskMarterial.uniforms.selectionTexture.value=this.renderTargetSelectionBuffer.texture,e.render(this.scene,this.camera,this.renderTargetMaskBuffer,!0),this.renderSelectedMeshes=!1},renderSelectedMesh:function(e){this.renderSelectedMeshes=!0,e.render(this.renderScene,this.renderCamera,this.renderTargetSelectionBuffer,!0)},renderToColorBuffer:function(e,t,r){r&&e.context.enable(e.context.STENCIL_TEST),this.quad.material=this.blendMaterial,this.blendMaterial.uniforms.selectionTexture.value=this.renderTargetSelectionBuffer.texture,this.blendMaterial.uniforms.blendStrength.value=.65,this.viewer.ndsModel?e.render(this.scene,this.camera,t,!1):e.render(this.scene,this.camera),this.quad.material=this.overlayMaterial,this.overlayMaterial.uniforms.maskTexture.value=this.renderTargetMaskBuffer.texture,this.overlayMaterial.uniforms.edgeTexture1.value=this.renderTargetEdgeBuffer1.texture,this.overlayMaterial.uniforms.edgeStrength.value=this.edgeStrength,this.viewer.ndsModel?e.render(this.scene,this.camera,t,!1):e.render(this.scene,this.camera),this.shouldRenderOutline=!1},getBlendMaterial:function(){return new THREE.ShaderMaterial({uniforms:{selectionTexture:{value:null},blendStrength:{value:1}},vertexShader:"varying vec2 vUv;\n                void main() {\n                    vUv = uv;\n                    gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n                }",fragmentShader:"varying vec2 vUv;                uniform sampler2D selectionTexture;                uniform float blendStrength;                                void main() {                    vec4 selectionValue = texture2D(selectionTexture, vUv);                    float mask = step(0.01, length(selectionValue.rgb));                    vec4 finalColor = selectionValue;                    finalColor.a = finalColor.a * mask * blendStrength;                    gl_FragColor = finalColor;                }",blending:THREE.NormalBlending,depthTest:!1,depthWrite:!1,transparent:!0})},getMaskPassMaterial:function(){return new THREE.ShaderMaterial({uniforms:{selectionTexture:{value:null}},vertexShader:"varying vec2 vUv;\n                void main() {\n                    vUv = uv;\n                    gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n                }",fragmentShader:"varying vec2 vUv;                uniform sampler2D selectionTexture;                                void main() {                    vec4 selectionValue = texture2D(selectionTexture, vUv);                    float mask = step(0.005, selectionValue.a);                    gl_FragColor = mask > 0.01 ? vec4(0.0, 0.0, mask, 1.0) : vec4(1.0, 1.0, 1.0, 1.0);                }",blending:THREE.NoBlending,depthTest:!1,depthWrite:!1,transparent:!0})}}),Ur.prototype={render:function(e,t,r,i){this.uniforms[this.textureID]&&(this.uniforms[this.textureID].value=r&&r.texture?r.texture:r),this.renderToScreen||!t?e.render(this.scene,this.camera):e.render(this.scene,this.camera,t,this.clear)},dispose:function(){this.material.dispose(),this.quad.geometry.dispose()}},Nr.prototype={constructor:Nr,load:function(e,t,r,i){var n=this,a=new THREE.XHRLoader;a.setCrossOrigin(this.crossOrigin),a.load(e,function(e){t(n.parse(e))},r,i)},parse:function(e){for(var t=e.split("\n"),r={},i=/\s+/,n={},a=0;a<t.length;a++){var o,s,l=(l=t[a]).trim();0!==l.length&&"#"!==l.charAt(0)&&(o=(o=0<=(s=l.indexOf(" "))?l.substring(0,s):l).toLowerCase(),l=(l=0<=s?l.substring(s+1):"").trim(),"newmtl"===o?n[l]=r={name:l}:r&&("ka"===o||"kd"===o||"ks"===o?(s=l.split(i,3),r[o]=[parseFloat(s[0]),parseFloat(s[1]),parseFloat(s[2])]):r[o]=l))}e=new Nr.MaterialCreator(this.baseUrl,this.options);return e.setMaterials(n),e}},(Nr.MaterialCreator=function(e,t){this.baseUrl=e,this.options=t,this.materialsInfo={},this.materials={},this.materialsArray=[],this.nameLookup={},this.side=this.options&&this.options.side?this.options.side:THREE.FrontSide,this.wrap=this.options&&this.options.wrap?this.options.wrap:THREE.RepeatWrapping}).prototype={constructor:Nr.MaterialCreator,setMaterials:function(e){this.materialsInfo=this.convert(e),this.materials={},this.materialsArray=[],this.nameLookup={}},convert:function(e){if(!this.options)return e;var t,r={};for(t in e){var i,n=e[t],a={};for(i in r[t]=a,n){var o=!0,s=n[i],l=i.toLowerCase();switch(l){case"kd":case"ka":case"ks":this.options&&this.options.normalizeRGB&&(s=[s[0]/255,s[1]/255,s[2]/255]),this.options&&this.options.ignoreZeroRGBs&&0===s[0]&&0===s[1]&&0===s[1]&&(o=!1);break;case"d":this.options&&this.options.invertTransparency&&(s=1-s)}o&&(a[l]=s)}}return r},preload:function(){for(var e in this.materialsInfo)this.create(e)},getIndex:function(e){return this.nameLookup[e]},getAsArray:function(){var e,t=0;for(e in this.materialsInfo)this.materialsArray[t]=this.create(e),this.nameLookup[e]=t,t++;return this.materialsArray},create:function(e){return void 0===this.materials[e]&&this.createMaterial_(e),this.materials[e]},createMaterial_:function(e){var t,r=this.materialsInfo[e],i={name:e,side:this.side};for(t in r){var n=r[t];switch(t.toLowerCase()){case"kd":i.diffuse=(new THREE.Color).fromArray(n);break;case"ka":i.ambient=(new THREE.Color).fromArray(n);break;case"ks":i.specular=(new THREE.Color).fromArray(n);break;case"map_kd":i.map=this.loadTexture(this.baseUrl+n),i.map.wrapS=this.wrap,i.map.wrapT=this.wrap;break;case"ns":i.shininess=n;break;case"d":n<1&&(i.transparent=!0,i.opacity=n)}}return i.diffuse&&(i.ambient||(i.ambient=i.diffuse),i.color=i.diffuse),this.materials[e]=new THREE.MeshPhongMaterial(i),this.materials[e]},loadTexture:function(e,t,r,i){var n=null,a=new THREE.Texture;return(n=new THREE.ImageLoader).crossOrigin=this.crossOrigin,n.load(e,function(e){a.image=Nr.ensurePowerOfTwo_(e),a.needsUpdate=!0,r&&r(a)}),a.mapping=t,a}},Nr.ensurePowerOfTwo_=function(e){var t;return THREE.Math.isPowerOfTwo(e.width)&&THREE.Math.isPowerOfTwo(e.height)?e:((t=document.createElement("canvas")).width=Nr.nextHighestPowerOfTwo_(e.width),t.height=Nr.nextHighestPowerOfTwo_(e.height),t.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,t.width,t.height),t)},Nr.nextHighestPowerOfTwo_=function(e){--e;for(var t=1;t<32;t<<=1)e|=e>>t;return e+1},Nr.prototype=Object.create(THREE.EventDispatcher.prototype);function kr(e,t){return(kr=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}Vr.prototype={constructor:Vr,load:function(t,e,i,n,a){function r(e){var r=e,e=(r&&r.preload(),new THREE.XHRLoader(o.manager));e.setCrossOrigin(this.crossOrigin),e.load(t,function(e){e=o.parse(e);e.traverse(function(e){var t;e instanceof THREE.Mesh&&e.material.name&&(t=r?r.create(e.material.name):null)&&(e.material=t)}),i(e)},n,a)}var o=this;e?new Nr(t.substr(0,t.lastIndexOf("/")+1)).load(e,r,n,a):r()},parse:function(e,t){function r(e,t,r){return new THREE.Vector3(e,t,r)}function n(e,t,r,i){return new THREE.Face3(e,t,r,i)}var a=0;function i(e,t){0<h.length&&(l.vertices=h,l.mergeVertices(),l.computeFaceNormals(),l.computeBoundingSphere(),s.add(c),l=new THREE.Geometry,c=new THREE.Mesh(l,d)),void 0!==e&&(c.name=e),void 0!==t&&((d=new THREE.MeshLambertMaterial).name=t,c.material=d)}var o=new THREE.Group,s=o,l=new THREE.Geometry,d=new THREE.MeshLambertMaterial,c=new THREE.Mesh(l,d),h=[],u=[],p=[];function f(e,t,r,i){void 0===i?l.faces.push(n(parseInt(e)-(a+1),parseInt(t)-(a+1),parseInt(r)-(a+1))):l.faces.push(n(parseInt(e)-(a+1),parseInt(t)-(a+1),parseInt(r)-(a+1),[u[parseInt(i[0])-1].clone(),u[parseInt(i[1])-1].clone(),u[parseInt(i[2])-1].clone()]))}function m(e,t,r){l.faceVertexUvs[0].push([p[parseInt(e)-1].clone(),p[parseInt(t)-1].clone(),p[parseInt(r)-1].clone()])}function g(e,t,r){void 0===e[3]?(f(e[0],e[1],e[2],r),void 0!==t&&0<t.length&&m(t[0],t[1],t[2])):(void 0!==r&&0<r.length?(f(e[0],e[1],e[3],[r[0],r[1],r[3]]),f(e[1],e[2],e[3],[r[1],r[2],r[3]])):(f(e[0],e[1],e[3]),f(e[1],e[2],e[3])),void 0!==t&&0<t.length&&(m(t[0],t[1],t[3]),m(t[1],t[2],t[3])))}for(var v,y,A=/v( +[\d|\.|\+|\-|e]+)( +[\d|\.|\+|\-|e]+)( +[\d|\.|\+|\-|e]+)/,M=/vn( +[\d|\.|\+|\-|e]+)( +[\d|\.|\+|\-|e]+)( +[\d|\.|\+|\-|e]+)/,E=/vt( +[\d|\.|\+|\-|e]+)( +[\d|\.|\+|\-|e]+)/,w=/f( +\d+)( +\d+)( +\d+)( +\d+)?/,x=/f( +(\d+)\/(\d+))( +(\d+)\/(\d+))( +(\d+)\/(\d+))( +(\d+)\/(\d+))?/,b=/f( +(\d+)\/(\d+)\/(\d+))( +(\d+)\/(\d+)\/(\d+))( +(\d+)\/(\d+)\/(\d+))( +(\d+)\/(\d+)\/(\d+))?/,B=/f( +(\d+)\/\/(\d+))( +(\d+)\/\/(\d+))( +(\d+)\/\/(\d+))( +(\d+)\/\/(\d+))?/,I=e.split("\n"),T=0;T<I.length;T++){var S,R=I[T];0!==(R=R.trim()).length&&"#"!==R.charAt(0)&&(null!==(S=A.exec(R))?h.push(r(parseFloat(S[1]),parseFloat(S[2]),parseFloat(S[3]))):null!==(S=M.exec(R))?u.push(r(parseFloat(S[1]),parseFloat(S[2]),parseFloat(S[3]))):null!==(S=E.exec(R))?p.push((v=parseFloat(S[1]),y=parseFloat(S[2]),new THREE.Vector2(v,y))):null!==(S=w.exec(R))?g([S[1],S[2],S[3],S[4]]):null!==(S=x.exec(R))?g([S[2],S[5],S[8],S[11]],[S[3],S[6],S[9],S[12]]):null!==(S=b.exec(R))?g([S[2],S[6],S[10],S[14]],[S[3],S[7],S[11],S[15]],[S[4],S[8],S[12],S[16]]):null!==(S=B.exec(R))?g([S[2],S[5],S[8],S[11]],[],[S[3],S[6],S[9],S[12]]):/^o /.test(R)?(i(),a+=h.length,h=[],(s=new THREE.Object3D).name=R.substring(2).trim(),o.add(s)):/^g /.test(R)?i(R.substring(2).trim(),void 0):/^usemtl /.test(R)?i(void 0,R.substring(7).trim()):/^mtllib /.test(R)?t&&t(R.substring(7).trim()):/^s /.test(R)||console.log("OBJMTLLoader: Unhandled line "+R))}return i(void 0,void 0),o}},Vr.prototype=Object.create(THREE.EventDispatcher.prototype);var jr=function(r){function e(e,t,n){var e=r.call(this,e,t,n)||this,G=e;return e.version=2,e.disaLoadingBrep=!1,e.disaNeedRequest=!1,e.disaCallback=null,e.addRequest=function(){if(this.modelRequestor){for(var e=this._brepFileUrls,t=this._loadedTags,r=this._reqTags,i=0;i<e.length;i++)t[i]||(this.modelRequestor.addRequest(e[i],1e5,"loadBrepData",{ndsModel:n}),this.disaLoadingBrep=!0,r[i]=!0);this.disaNeedRequest=!1}},e.tryMergeBrep=function(){var e=this._brepFileUrls,t=this._loadedTags,r=this._reqTags;if(this.disaLoadingBrep){for(var i,n=0,a=0;a<e.length;a++)t[a]?n++:r[a]&&(i=this.modelRequestor.tryMergeBrep(e[a]))&&(this.disaToBrep(i),t[a]=!0,this._hasBrepInfo=!0);n==t.length&&(this.disaLoadingBrep=!1)}},e.disaToBrep=function(e){for(var t=this.brepInfos.breps.length,r=new Map,i=0;i<e.bodies.length;i++)r.set(e.bodies[i].id,t+i);for(var n=this.ndsModel,a=[n.rootBodyNode],o=0;o<a.length;o++){if(0==a[o].children.length&&a[o].brepId){var s=r.get(a[o].brepId),l=(G.brepInfos.bodies.set(a[o].uuid,s),e.bodies[s-t]),d=[],O=[];if(a[o]._leafBodyAttri){if(a[o]._leafBodyAttri._bodyMeshIds)for(var c=0,F=a[o]._leafBodyAttri._bodyMeshIds.length;c<F;++c){var h=a[o]._leafBodyAttri._bodyMeshIds[c],U=n.meshManager.geomId[h],h=n.meshManager.geomUuid[h];if(-1<U){var u=n.geomManager.getGeomFromId(U);if(1==u.primitiveType||2==u.primitiveType||3==u.primitiveType){var p={};p.geomUUID=h,p.loopPerimeters=[],p.loopStartEdgeId=[];for(var f=u.startBrepEntIndex,m=0;f<u.startBrepEntIndex+u.brepPrimitiveGroup.length;f++,m++){var g=e.faces[f];if(g){var v=void 0,y=void 0,y=f==u.startBrepEntIndex+u.brepPrimitiveGroup.length-1?(v=Math.floor(u.brepPrimitiveGroup[m]/3),Math.floor((u.drawRange.count-1)/3)):(v=Math.floor(u.brepPrimitiveGroup[m]/3),Math.floor((u.brepPrimitiveGroup[m+1]-1)/3)),A=e.surfaces.get(g.surfaceId);if(A)switch(A.type){case 0:p.planes||(p.planes={areas:new Array,ids:new Array,loops:new Array,triIndexRanges:new Array,normals:new Array,origins:new Array});var M=p.loopPerimeters.length;p.loopPerimeters.push(g.perimeter),p.loopStartEdgeId.push(M,M+1),p.planes.areas.push(g.area),p.planes.ids.push(g.id),p.planes.loops.push(M,1),p.planes.triIndexRanges.push(v,y),p.planes.normals.push(A.normal[0],A.normal[1],A.normal[2]),p.planes.origins.push(A.origin[0],A.origin[1],A.origin[2]);break;case 1:p.spheres||(p.spheres={areas:new Array,ids:new Array,loops:new Array,triIndexRanges:new Array,radiuses:new Array,origins:new Array});M=p.loopPerimeters.length;p.loopPerimeters.push(g.perimeter),p.loopStartEdgeId.push(M,M+1),p.spheres.areas.push(g.area),p.spheres.ids.push(g.id),p.spheres.loops.push(M,1),p.spheres.triIndexRanges.push(v,y),p.spheres.radiuses.push(A.radius),p.spheres.origins.push(A.center[0],A.center[1],A.center[2]);break;case 2:p.cylinders||(p.cylinders={areas:new Array,ids:new Array,loops:new Array,triIndexRanges:new Array,origins:new Array,axis:new Array,radiuses:new Array});var E=p.loopPerimeters.length;p.loopPerimeters.push(g.perimeter),p.loopStartEdgeId.push(E,E+1),p.cylinders.areas.push(g.area),p.cylinders.ids.push(g.id),p.cylinders.loops.push(E,1),p.cylinders.triIndexRanges.push(v,y),p.cylinders.axis.push(A.normal[0],A.normal[1],A.normal[2]),p.cylinders.origins.push(A.center[0],A.center[1],A.center[2]),p.cylinders.radiuses.push(A.radius);break;case 3:p.toruses||(p.toruses={areas:new Array,ids:new Array,loops:new Array,triIndexRanges:new Array});E=p.loopPerimeters.length;p.loopPerimeters.push(g.perimeter),p.loopStartEdgeId.push(E,E+1),p.toruses.areas.push(g.area),p.toruses.ids.push(g.id),p.toruses.loops.push(E,1),p.toruses.triIndexRanges.push(v,y);break;case 4:p.cones||(p.cones={areas:new Array,ids:new Array,loops:new Array,triIndexRanges:new Array,origins:new Array,axis:new Array,radiuses:new Array});var w=p.loopPerimeters.length;p.loopPerimeters.push(g.perimeter),p.loopStartEdgeId.push(w,w+1),p.cones.areas.push(g.area),p.cones.ids.push(g.id),p.cones.loops.push(w,1),p.cones.triIndexRanges.push(v,y),p.cones.axis.push(A.normal[0],A.normal[1],A.normal[2]),p.cones.origins.push(A.center[0],A.center[1],A.center[2]),p.cones.radiuses.push(A.radius);break;default:p.others||(p.others={areas:new Array,ids:new Array,loops:new Array,triIndexRanges:new Array});w=p.loopPerimeters.length;p.loopPerimeters.push(g.perimeter),p.loopStartEdgeId.push(w,w+1),p.others.areas.push(g.area),p.others.ids.push(g.id),p.others.loops.push(w,1),p.others.triIndexRanges.push(v,y)}else{p.others||(p.others={areas:new Array,ids:new Array,loops:new Array,triIndexRanges:new Array});var x=p.loopPerimeters.length;p.loopPerimeters.push(g.perimeter),p.loopStartEdgeId.push(x,x+1),p.others.areas.push(g.area),p.others.ids.push(g.id),p.others.loops.push(x,1),p.others.triIndexRanges.push(v,y)}}}d.push(G.brepInfos.faceGroups.length),G.brepInfos.faceGroups.push(p)}}}if(a[o]._leafBodyAttri._bodyLineSegIds)for(var b=0,N=a[o]._leafBodyAttri._bodyLineSegIds.length;b<N;++b){var B=a[o]._leafBodyAttri._bodyLineSegIds[b],V=n.meshManager.lineSegGeomId[B],B=n.meshManager.lineSegGeomUuid[B],I=n.geomManager.getGeomFromId(V);if(4==I.primitiveType||5==I.primitiveType||6==I.primitiveType){var T={};T.geomUUID=B;for(var S=I.startBrepEntIndex,R=0;S<I.startBrepEntIndex+I.brepPrimitiveGroup.length;S++,R++){var C=e.edges[S];if(C){var D=void 0,P=void 0,P=S==I.startBrepEntIndex+I.brepPrimitiveGroup.length-1?(D=Math.floor(I.brepPrimitiveGroup[R]/2),Math.floor((I.drawRange.count-1)/2)):(D=Math.floor(I.brepPrimitiveGroup[R]/2),Math.floor((I.brepPrimitiveGroup[R+1]-1)/2)),H=e.curves.get(C.curveID);if(H)switch(H.type){case 0:T.lines||(T.lines={ids:new Array,indexRanges:new Array,lengthes:new Array}),T.lines.ids.push(C.id),T.lines.lengthes.push(C.length),T.lines.indexRanges.push(D,P);break;case 1:case 3:T.circles||(T.circles={ids:new Array,indexRanges:new Array,lengthes:new Array,centers:new Array,radiuses:new Array,normals:new Array}),T.circles.ids.push(C.id),T.circles.lengthes.push(C.length),T.circles.indexRanges.push(D,P),T.circles.centers.push(H.center[0],H.center[1],H.center[2]),T.circles.normals.push(H.normal[0],H.normal[1],H.normal[2]),T.circles.radiuses.push(H.radius);break;case 2:case 4:T.ellipses||(T.ellipses={ids:new Array,indexRanges:new Array,lengthes:new Array}),T.ellipses.ids.push(C.id),T.ellipses.lengthes.push(C.length),T.ellipses.indexRanges.push(D,P);break;default:T.others||(T.others={ids:new Array,indexRanges:new Array,lengthes:new Array}),T.others.ids.push(C.id),T.others.lengthes.push(C.length),T.others.indexRanges.push(D,P)}else T.others||(T.others={ids:new Array,indexRanges:new Array,lengthes:new Array}),T.others.ids.push(C.id),T.others.lengthes.push(C.length),T.others.indexRanges.push(D,P)}}O.push(G.brepInfos.edgeGroups.length),G.brepInfos.edgeGroups.push(T)}}}var _={};_.area=l.area,_.volume=l.volume,_.faceGroups=d,_.edgeGroups=O,_.vertices=[],this.brepInfos.breps[s]=_}for(var L=0;L<a[o].children.length;L++)a.push(a[o].children[L])}e.mask&&(G.viewer.brepInfo.BfaceArea=!0,G.viewer.brepInfo.BbodyVolume=!0,G.viewer.brepInfo.BbodyArea=!0,G.viewer.brepInfo.BtotalArea=!0,G.viewer.brepInfo.BfacePerimeter=!0),G.viewer.dispatchBrepEvent(),G.disaCallback&&G.disaCallback()},e}var t,i;return i=r,(t=e).prototype=Object.create(i.prototype),kr(t.prototype.constructor=t,i),e}(At);Ce.TOUCH={TOUCH_SINGLE:10,TOUCH_DOUBLE:11,TOUCH_TRIPLE:12},Ce.MOUSE={NONE:-1,LEFT:0,MIDDLE:1,RIGHT:2};function Le(e){a.call(this,e),this.scene=new THREE.Scene,this.type="OpSelectLasso",this.selectionPoints=[],this.selectionShapeNeedsUpdate=!1,this.selectionNeedsUpdate=!1,this.lassoSegments=[],this.pixelInfo=[],this.segment=10,e=this.viewer.renderer.domElement.height/this.viewer.renderer.domElement.width,this.pickingTexture=new THREE.WebGLRenderTarget(1920,1920*e),this.TargetWidth=1920,this.TargetHeight=1920*e,this.prevX=1/0,this.prevY=1/0,this.toScreenSpaceMatrix=new THREE.Matrix4D,this.boxLines=new Array(12).fill().map(function(){return new THREE.Line3}),this.selectionShape=new THREE.Line,this.selectionShape.material=new THREE.LineBasicMaterial({color:3969758,linewidth:1}),this.selectionShape.renderOrder=1,this.selectionShape.position.z=-.2,this.selectionShape.depthTest=!1,this.selectionShape.scale.setScalar(1),this.scene.add(this.selectionShape),this.pickingMaterial=new THREE.ShaderMaterial({uniforms:{width:{value:1080,type:"f"},height:{value:920,type:"f"},lassoSegments:{value:null},lassolength:{value:300,type:"i"},vbodyId:{value:0,type:"i"}},vertexShader:"\n            void main() {\n                gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n            }\n        ",fragmentShader:"\n            uniform vec2 lassoSegments[300];\n            uniform int lassolength;\n            uniform float width;\n            uniform float height;\n            uniform int vbodyId;\n         \n            bool pointRayCrossesLine (vec2 point,vec2 start,vec2 end,bool prevDirection, bool thisDirection ){\n              \n                float px = point.x;\n                float py = point.y;\n\n                float sy = start.y;\n                float ey = end.y;\n\n                if ( sy == ey ) return false;\n\n                if ( py > sy && py > ey ) return false; // above\n                if ( py < sy && py < ey ) return false; // below\n\n                float sx = start.x;\n                float ex = end.x;\n                if ( px > sx && px > ex ) return false; // right\n                if ( px < sx && px < ex ) { // left\n\n                    if ( py == sy && prevDirection != thisDirection ) {\n\n                        return false;\n\n                    }\n\n                    return true;\n                }\n\n                float dx = ex - sx;\n                float dy = ey - sy;\n                float perpx = dy;\n                float perpy = - dx;\n\n                float pdx = px - sx;\n                float pdy = py - sy;\n\n                float dot = perpx * pdx + perpy * pdy;\n\n                if ( sign( dot ) != sign( perpx ) ) {\n\n                    return true;\n\n                }\n\n                return false;\n            }\n            void main() {\n                int crossings = 0;\n                vec2 LindStart = lassoSegments[ lassolength - 2 ];\n                vec2 LineEnd = lassoSegments[ lassolength - 1 ];\n                bool prevDirection = LindStart.y > LineEnd.y; \n\n                float _x = mod(float(vbodyId) ,10.0);  //这个值要与this.segment 相同\n                float _y = floor(float(vbodyId) / 10.0); \n\n                float x = ((gl_FragCoord.x - _x * width)- width / 2.0) / width *2.0;\n                float y = ((gl_FragCoord.y - _y * height ) - height / 2.0 ) / height *2.0;\n                vec2 point = vec2(x,y);\n                for ( int s = 0, l = lassolength - 1; s < l; s ++ ) {\n                    vec2 StartPoint = lassoSegments[ s ];\n                    if(StartPoint.x > 5.0)  //大于1，就说明为10 ，表示套索点结束\n                        break;\n                    vec2 EndPoint = lassoSegments[ s + 1];\n                    bool thisDirection = StartPoint.y > EndPoint.y;\n                    if ( pointRayCrossesLine( point, StartPoint, EndPoint, prevDirection, thisDirection ) ) {\n    \n                        crossings ++;\n    \n                    }\n    \n                    prevDirection = thisDirection;\n                }\n                float b = float(vbodyId + 1) / 100.0; //this.segment * this.segment\n                vec3 destColor = vec3(1.0,0.0,b);\n                if(crossings % 2 == 1)\n                {\n                    destColor.r = 0.0;\n                    destColor.g = 1.0;\n                }\n                gl_FragColor = vec4(destColor, 1.0);;\n            }\n        "})}function zr(e){this.viewer=e;var V=this,I=null,G=null,T=!1,S=null,R=null;this.broadcastInfo=null,this.initialization=!0,this.onTouchMove=function(e){if(!V.viewer.isClipTransformControlSelected()&&!V.viewer.isLightEditControlSelected()){switch(e.stopPropagation(),e.touches.length){case 1:var t=e.touches[0].offsetX||e.touches[0].clientX-V.viewer.container.getBoundingClientRect().left,r=e.touches[0].offsetY||e.touches[0].clientY-V.viewer.container.getBoundingClientRect().top;if(V.viewer.limitEventArea){var i=V.viewer.container.getBoundingClientRect().width,n=V.viewer.container.getBoundingClientRect().height;if(i<t||n<r)return}break;case 2:t=e.touches[0].offsetX||e.touches[0].clientX-V.viewer.container.getBoundingClientRect().left,r=e.touches[0].offsetY||e.touches[0].clientY-V.viewer.container.getBoundingClientRect().top;if(t=e.touches[1].offsetX||e.touches[1].clientX-V.viewer.container.getBoundingClientRect().left,r=e.touches[1].offsetY||e.touches[1].clientY-V.viewer.container.getBoundingClientRect().top,V.viewer.limitEventArea){i=V.viewer.container.getBoundingClientRect().width,n=V.viewer.container.getBoundingClientRect().height;if((V.pointer.x>i||V.pointer.y>n)&&(V.pointer2nd.x>i||V.pointer2nd.y>n))return}}if(null==I&&(I=new THREE.Vector2),"OpMeasure"==V.viewer.getCurrentOperatorID()){null==S&&(S=new THREE.Vector3);var a=V.viewer.controls.getOperator().MeasureOper.getIntersectsByPriorityOfLine(t,r),o=null;if(a&&0<a.length)for(var s=0;s<a.length;){if(null!=a[s].object){o=a[s].point.clone();break}s++}o?S.set(o.x,o.y,o.z):S=null}else S=null;var l=V.viewer.renderer.getPixelRatio();I.set(t*l/V.viewer.renderer.domElement.width,r*l/V.viewer.renderer.domElement.height)}},this.onBroadcastMouseMove=function(e){var t=e.offsetX||e.clientX-V.viewer.container.getBoundingClientRect().left,r=e.offsetY||e.clientY-V.viewer.container.getBoundingClientRect().top;if(e.srcElement&&e.srcElement!==V.viewer.renderer.domElement&&(t=e.clientX-V.viewer.container.getBoundingClientRect().left,r=e.clientY-V.viewer.container.getBoundingClientRect().top),null==e.srcElement&&e.target&&e.target!==V.viewer.renderer.domElement&&(t=e.clientX-V.viewer.container.getBoundingClientRect().left,r=e.clientY-V.viewer.container.getBoundingClientRect().top),null==I&&(I=new THREE.Vector2),"OpMeasure"==V.viewer.getCurrentOperatorID()){null==S&&(S=new THREE.Vector3);var i=V.viewer.controls.getOperator().MeasureOper.getIntersectsByPriorityOfLine(t,r),n=null;if(i&&0<i.length)for(var a=0;a<i.length;){if(null!=i[a].object){n=i[a].point.clone();break}a++}n?S.set(n.x,n.y,n.z):S=null}else S=null;var o=V.viewer.renderer.getPixelRatio();I.set(t*o/V.viewer.renderer.domElement.width,r*o/V.viewer.renderer.domElement.height),T=!1,!e.srcElement||"toolbar"!=e.srcElement.className&&"toolbar-button"!=e.srcElement.className&&"dialog"!=e.srcElement.className&&"explode-tool-slider"!=e.srcElement.className||(T=!0),null!=e.srcElement||!e.target||"toolbar"!=e.target.className&&"toolbar-button"!=e.target.className&&"dialog"!=e.target.className&&"explode-tool-slider"!=e.target.className||(T=!0)},this.getBroadcastInfo=function(){var e={timestamp:Date.now(),version:1,isMobile:Pe.isMobileDevice(),operator:V.viewer.getCurrentOperatorID(),state:V.viewer.getCurrentOperatorState(),explode:{factor:null,mode:null,level:null,obj:null},annoSetting:0,line:V.viewer.getLinesVisibility()?1:0,mousePos:I?[I.x,I.y]:[-1,-1],worldPos:S?[S.x,S.y,S.z]:[-1,-1,-1],ClearColor:V.viewer.clearColor,camera:{pos:[V.viewer.camera.position.x,V.viewer.camera.position.y,V.viewer.camera.position.z],center:[V.viewer.camera.getCameraTarget().x,V.viewer.camera.getCameraTarget().y,V.viewer.camera.getCameraTarget().z],fov:V.viewer.camera.fov,persp:V.viewer.camera.isPerspective?1:0,near:V.viewer.camera.near,far:V.viewer.camera.far,up:[V.viewer.camera.up.x,V.viewer.camera.up.y,V.viewer.camera.up.z]},selfromTree:V.viewer.selectionManager.selectfromtree,measuringScale:V.viewer.measuringScale},t=("OpZoomWindow"==e.operator&&(r={x:0,y:0},t=V.viewer.renderer.getPixelRatio(),e.state==Ce.MOUSE.LEFT?(r.x=V.viewer.controls.getOperator().lMouseDown.x,r.y=V.viewer.controls.getOperator().lMouseDown.y):e.state==Ce.TOUCH.TOUCH_SINGLE&&(r.x=V.viewer.controls.getOperator().singleTouchStartPos.x,r.y=V.viewer.controls.getOperator().singleTouchStartPos.y),r.x=r.x*t/V.viewer.renderer.domElement.width,r.y=r.y*t/V.viewer.renderer.domElement.height,e.lMouseDown=r),V.viewer.controls.staticmeasureOp),r=null,i=(t&&(r=t.getMeasureContent(!0)),("OpMeasure"===e.operator||null!==r&&JSON.stringify(r)!==V._measureContent)&&(e.click=t.click,e.InfoType=t.InfoType,e.MeasureType=t.measureType,(i=t.getDimString())?(e.unit=i.unit,e.dimString=i.str):(e.unit="",e.dimString=""),e.measureRelease=t.measureRelease,e.MeasureContent=r,V._measureContent=JSON.stringify(r),0<Object.keys(t.unsteadyData).length&&(e.MeasureContent.unsteadyData=t.unsteadyData),t.click=!1,t.measureRelease=!1),V.initialization&&null===r&&(e.shouldClearMeasureContent=!0),"OpDrag"==e.operator&&(e.opMode=V.viewer.controls.getOperator().opMode),"");if(V.viewer.serverUrl&&(i=V.viewer.serverUrl),""!=V.viewer.renderer.domElement.style.cursor)switch(V.viewer.renderer.domElement.style.cursor){case"url('"+i+"img/cursorOrbit.ico'), wait":e.cursor="Orbit";break;case"url('"+i+"img/cursorPan.ico'), wait":e.cursor="Pan";break;case"url('"+i+"img/cursorZoom.ico'), wait":e.cursor="Zoom";break;case"url('"+i+"img/cursorCross.ico'), crosshair":e.cursor="Cross"}V.viewer.syncSendMsg(e),R!==De.StopPMIOcclusion&&(R=De.StopPMIOcclusion,e.shouldStopPMIOcclusion=De.StopPMIOcclusion),T&&(e.cursor="Normal"),V.viewer.Optoolbar&&(V.viewer.Optoolbar.getExplodeDlgVisibility()&&(e.explodeDlg=1,e.explodeDlgValue=V.viewer.Optoolbar.getExplodeDlgValue()),e.annoSetting=V.viewer.Optoolbar.getAnnotationSetting()?1:0,(t=V.viewer.Optoolbar.getDispStyleToolbar())&&(t.getVisibility()?e.DispStyle=!0:e.DispStyle=!1),r=V.viewer.Optoolbar.getMeasureDlg())&&(e.measureDlg=r.dialog.getVisibility(),e.checkID=r.getChecked());var n=void 0;switch(V.viewer.getRenderMode()){case 0:n="lighting";break;case 1:n="primarycolor";break;case 2:n="wireframe";break;case 3:n="whitemold";break;case 4:n="shadedWithEdges";break;case 5:n="shaded";break;case 6:n="hiddenLineRemove";break;case 7:n="hiddenLineVisible";break;case 8:n="transparent"}e.RenderMode=n;var i=He.getExtension("ClipExtension"),a=(i&&i.isSectionViewEnabled()&&(e.clipPlaneInfo=i.getClipPlaneInfo()),[]),o=[],s=[],l=[],d=[];if(V.viewer.ndsModel){var c=V.viewer.ndsModel.getSelectedBodies();if(0<c.length){e.meshSel=[];for(var h=0;h<c.length;++h)V.viewer.ndsModel.objectidTouuid&&!V.viewer.is2DModel?e.meshSel.push(c[h].objectid):e.meshSel.push(c[h].id)}if(0<V.viewer.ndsModel.draggedBodies.length)for(var u=0;u<V.viewer.ndsModel.draggedBodies.length;++u){var p=V.viewer.ndsModel.draggedBodies[u];d.push({id:p.id,dragPos:p.leafBodyAttri.bodyDragTranslate})}for(var u=0,f=V.viewer.ndsModel.wholeLeafBodyNodes.length;u<f;++u)(p=V.viewer.ndsModel.wholeLeafBodyNodes[u]).leafBodyAttri&&((p.isHidden()?o:a).push(p.id),V.viewer.ndsModel.inIsolate())&&(!p.isIsolated()&&p.isTransparent()?s:l).push(p.id)}0<d.length&&(e.meshDrag=d),0==o.length?e.meshInvisible=[]:0==a.length&&0<o.length?e.meshVisible=[]:o.length<=a.length?e.meshInvisible=o:e.meshVisible=a,s.length<=l.length?e.meshTrans=s:e.meshNoTrans=l,V.viewer.Optoolbar&&V.viewer.Optoolbar.getDragToolbarBtnSelected()&&(e.dragBtn=V.viewer.Optoolbar.getDragToolbarBtnSelected()),V.viewer.annotationsManager&&(e.annotationsVisible=V.viewer.annotationsManager.isAnnotationsVisible(),e.SelectAnnotation=V.viewer.annotationsManager.getSelectAnnotation()),V.viewer.controls.staticmeasureOp&&(e.shouldShowMeasureContent=V.viewer.controls.staticmeasureOp.getMeasureVisible());var m=[],g=[];if(void 0!==V.viewer.PMINDSBodys&&0<V.viewer.PMINDSBodys.length){for(var v=0,y=V.viewer.PMINDSBodys.length;v<y;++v)null===V.viewer.PMINDSBodys[v].uuid||V.viewer.isPMIObjectOrSomeChildHidden(V.viewer.PMINDSBodys[v])||g.push(V.viewer.PMINDSBodys[v].uuid);t=JSON.stringify(g)+V.viewer.isPmiVisible();V._PMIObjectVisibleContent!==t&&(e.PMIObjectVisibleList=g,V._PMIObjectVisibleContent=t)}if(V.viewer.pmiObject&&V.viewer.pmiObject.children){r=V.viewer.pmiObject.children[0];if(r.version||V.getPMIObject(),2===r.version){var A=V.viewer.getPMINDSBodySelectList();if(A&&0<A.length)for(var M=0,E=A.length;M<E;++M){var w=A[M];w.isHidden()||m.push(w.uuid)}}else if(1===r.version){var x=V.viewer.getPMISelectList();if(x&&0<x.length)for(var b=0,B=x.length;b<B;++b)m.push(x[b].uuid)}i=JSON.stringify(m);V._PMISelContent===i&&!e.PMIObjectVisibleList||(e.PMIObjectSelList=m,V._PMISelContent=i)}return V.initialization=!1,He.onAfterGetBroadcastInfo(e),e},this.startBroadcast=function(e){V.exitBroadcast(),De.enableBroadcast=!0,De.broadcastMajor=null!=e&&e;var t,r,i,e=V.viewer.controls.getOperator();"OpMeasure"==e.type&&e.restrictMeasuretime(),De.broadcastMajor&&(document.addEventListener("mousemove",V.onBroadcastMouseMove,!1),document.addEventListener("touchmove",V.onTouchMove,!1),V._resetLocalCacheEventintervalID=setInterval(V.resetLocalCache,1200),V.viewer.controls.staticmeasureOp)&&((e=V.viewer.getMeasureContent())&&e.content&&(t="",i=V.viewer.controls.staticmeasureOp.getMeasureVisible(),(r=e.content.boxInfos&&0<e.content.boxInfos.length)&&(t=V.viewer.controls.staticmeasureOp.measureType,V.viewer.controls.staticmeasureOp.setMeasureType(""),V.viewer.setMeasureContent(e,!0,i)),V.viewer.controls.staticmeasureOp.resetMeasureTimesWithMeasureContent(e.content),"OpMeasure"==this.viewer.getCurrentOperatorID())&&r&&V.viewer.controls.staticmeasureOp.setMeasureType(t),(i=V.viewer.controls.staticmeasureOp.MeasureOper)&&(i.clearPerimetrBox(),i.clearFaceInfo()),V.viewer.dispatchEvent({type:"FaceSelectionPerimeterEvent",perimeters:[]}))},this.exitBroadcast=function(){var e;De.enableBroadcast&&De.broadcastMajor&&(V.viewer.controls.staticmeasureOp&&(e=V.viewer.controls.staticmeasureOp.getMeasureContent(!0))&&0<e.perimeterInfos.length&&((e=V.viewer.controls.staticmeasureOp.MeasureOper).clearPerimetrBox(),e.clearFaceInfo()),V._resetLocalCacheEventintervalID&&clearInterval(V._resetLocalCacheEventintervalID),document.removeEventListener("mousemove",V.onBroadcastMouseMove,!1),document.removeEventListener("touchmove",V.onTouchMove,!1)),De.enableBroadcast=!1,De.broadcastMajor=!1,I=null,T=!1,G&&V.viewer.container.removeChild(G),G=null},this.setBroadcastInfo=function(e){try{if(De.enableBroadcast&&null!=e){var t;if(e.timestamp&&(t=Date.now(),console.log("info send[",e.timestamp,"] rece[",t,"] ",t-e.timestamp,"ms")),V.viewer.syncGetMsg(e),e.operator&&V.viewer.getCurrentOperatorID()!=e.operator)switch(e.operator){case"OpOrbit":V.viewer.controls.setOperator(new ui(V.viewer)),V.viewer.controls.addEventListener("change",V.viewer.render),V.viewer.tlbOperator?(i={target:V.viewer.tlbOperator.getChildElement("btnOrbit")},V.viewer.onOpChanged(i)):V.viewer.onOpChanged({id:"OpOrbit"});break;case"OpPan":V.viewer.controls.setOperator(new pi(V.viewer)),V.viewer.controls.addEventListener("change",V.viewer.render),V.viewer.tlbOperator?(i={target:V.viewer.tlbOperator.getChildElement("btnPan")},V.viewer.onOpChanged(i)):V.viewer.onOpChanged({id:"OpPan"});break;case"OpZoom":V.viewer.controls.setOperator(new fi(V.viewer)),V.viewer.controls.addEventListener("change",V.viewer.render),V.viewer.tlbOperator?(i={target:V.viewer.tlbOperator.getChildElement("btnZoom")},V.viewer.onOpChanged(i)):V.viewer.onOpChanged({id:"OpZoom"});break;case"OpDrag":V.viewer.DragGrowthExtension?(V.viewer.controls.setOperator(V.viewer.DragGrowthExtension.getDrag()),V.viewer.controls.addEventListener("change",V.viewer.render),V.viewer.tlbOperator?(i={target:V.viewer.tlbOperator.getChildElement("btnDrag")},V.viewer.onOpChanged(i)):V.viewer.onOpChanged({id:"OpDrag"})):console.warn("拖动增强插件未加载");break;case"OpZoomWindow":V.viewer.controls.setOperator(new mi(V.viewer)),V.viewer.tlbOperator?(i={target:V.viewer.tlbOperator.getChildElement("btnZoomWindow")},V.viewer.onOpChanged(i)):V.viewer.onOpChanged({id:"OpZoomWindow"});break;case"OpSelectWindow":V.viewer.controls.setOperator(new gi(V.viewer)),V.viewer.tlbOperator?(i={target:V.viewer.tlbOperator.getChildElement("btnSelectWindow")},V.viewer.onOpChanged(i)):V.viewer.onOpChanged({id:"OpSelectWindow"});break;case"OpMeasure":V.viewer.controls.setOperator(new OpMeasure(V.viewer)),V.viewer.tlbOperator?(i={target:V.viewer.tlbOperator.getChildElement("btnMeasure")},V.viewer.onOpChanged(i)):V.viewer.onOpChanged({id:"OpMeasure"})}for(var r,i,n,a,o,s,l,d,c,h,u,p,f,m,g,v;0<V.viewer.ndsModel.draggedBodies.length;)(A=V.viewer.ndsModel.draggedBodies[0]).leafBodyAttri&&A.isDragged()&&(A.setDragged(!1),A.leafBodyAttri.bodyDragTranslate[0]=0,A.leafBodyAttri.bodyDragTranslate[1]=0,A.leafBodyAttri.bodyDragTranslate[2]=0,-1<(r=V.viewer.ndsModel.draggedBodies.indexOf(A))&&V.viewer.ndsModel.draggedBodies.splice(r,1),V.viewer.ndsModel.meshManager.setGeomSameMaterialFlag(A));if(e.meshDrag&&0<e.meshDrag.length)if(V.viewer.ndsModel)for(var y=0;y<e.meshDrag.length;++y){var A=V.viewer.ndsModel.getBodyNode(e.meshDrag[y].id),M=new THREE.Vector3;M.fromArray(e.meshDrag[y].dragPos),A.leafBodyAttri&&(A.isDragged()||(A.setDragged(!0),V.viewer.ndsModel.draggedBodies.push(A)),A.leafBodyAttri.bodyDragTranslate[0]=M.x,A.leafBodyAttri.bodyDragTranslate[1]=M.y,A.leafBodyAttri.bodyDragTranslate[2]=M.z,V.viewer.ndsModel.meshManager.setGeomSameMaterialFlag(A))}else for(var E=new THREE.Vector3,y=0;y<e.meshDrag.length;++y)(B=V.viewer.scene.getObjectByProperty("uuid",e.meshDrag[y].uuid))&&(void 0===B.matrixWorldTransOrginal&&(B.matrixWorldTransOrginal=new THREE.Vector3,B.matrixWorldTransOrginal.setFromMatrixPosition(B.matrixWorld)),null==B.matrixWorldTransOrginalDrag&&(B.matrixWorldTransOrginalDrag=new THREE.Vector3),B.matrixWorldTransOrginalDrag.fromArray(e.meshDrag[y].dragPos),E.copy(B.matrixWorldTransOrginal),E.add(B.matrixWorldTransOrginalDrag),B.matrixWorld.setPosition(E));if("OpZoomWindow"!=e.operator||e.state!=Ce.MOUSE.LEFT&&e.state!=Ce.TOUCH.TOUCH_SINGLE?"OpZoomWindow"==e.operator&&(n=V.viewer.controls.getOperator()).clearCanvas2D():(V.viewer.controls.getOperator().state=e.state,P=V.viewer.renderer.getPixelRatio(),(n=V.viewer.controls.getOperator()).drawRectangle(e.lMouseDown.x*V.viewer.renderer.domElement.width,e.lMouseDown.y*V.viewer.renderer.domElement.height,e.mousePos[0]*V.viewer.renderer.domElement.width,e.mousePos[1]*V.viewer.renderer.domElement.height)),"OpMeasure"!=e.operator||!V.viewer.ndsModel.activeModel.brepManager.hasBrepInfo()&&V.viewer.hasBrepFile()?"OpDrag"==e.operator&&(V.viewer.controls.getOperator().opMode=e.opMode):(e.measureRelease&&V.viewer.getCurrentOperatorID()==e.operator&&(V.viewer.controls.setOperator(new OpMeasure(V.viewer)),V.viewer.tlbOperator?(i={target:V.viewer.tlbOperator.getChildElement("btnMeasure")},V.viewer.onOpChanged(i)):V.viewer.onOpChanged({id:"OpMeasure"})),n=V.viewer.controls.getOperator(),e.MeasureType!=n.measureType&&n.setMeasureType(e.MeasureType),n.PostInfo(e.InfoType),""!=e.dimString&&(n.dimString=e.dimString),""!=e.unit&&(n.unit=e.unit),n.setMeasureContent(e.MeasureContent),void 0!==e.MeasureContent.unsteadyData&&(n.unsteadyData=e.MeasureContent.unsteadyData),0<e.MeasureContent.perimeterInfos.length?V.viewer.dispatchEvent({type:"FaceSelectionPerimeterEvent",perimeters:e.MeasureContent.perimeterBroadcast,modelUnit:e.MeasureContent.perimeterunit}):(n.MeasureOper.clearPerimetrBox(),V.viewer.dispatchEvent({type:"FaceSelectionPerimeterEvent",perimeters:[]})),V.viewer.measuringScale!=e.measuringScale&&V.viewer.setMeasuringScale(e.measuringScale),V.viewer.Optoolbar&&V.viewer.Optoolbar.getMeasureDlg().setChecked(e.checkID),-1!=e.worldPos[0]||-1!=e.worldPos[1]||-1!=e.worldPos[2]?(a=V.viewer.modelCoordToClientCoord(e.worldPos))&&(a[0],a[1],a[0],a[1]):(e.mousePos[0],V.viewer.renderer.domElement.width,e.mousePos[1],V.viewer.renderer.domElement.height,e.mousePos[0],V.viewer.renderer.domElement.width,e.mousePos[1],V.viewer.renderer.domElement.height)),void 0!==e.MeasureContent&&(V.viewer.controls.staticmeasureOp||(o=V.viewer.getCurrentOperatorID(),V.viewer.setOperatorByID("OpMeasure"),V.viewer.setOperatorByID(o)),V.viewer.controls.staticmeasureOp.setMeasureContent(e.MeasureContent),void 0!==e.MeasureContent.unsteadyData)&&(V.viewer.controls.staticmeasureOp.unsteadyData=e.MeasureContent.unsteadyData),e.shouldClearMeasureContent&&V.viewer.controls.staticmeasureOp&&V.viewer.controls.staticmeasureOp.setMeasureContent({boxInfos:[],boundingboxInfos:[],perimeterInfos:[],textPos:[],textBox:null,textLines:[],snappedPoint:null,InMeasure:!1,cs:0,Ps:[],rootObject:[]}),"OpMeasure"==e.operator&&!V.viewer.ndsModel.activeModel.brepManager.hasBrepInfo()&&V.viewer.hasBrepFile()?V.broadcastInfo=e:V.broadcastInfo=null,V.viewer.Optoolbar&&(s=V.viewer.Optoolbar.getDispStyleToolbar())&&s.setVisibility(e.DispStyle),e.RenderMode&&V.viewer.setRenderMode(e.RenderMode,!0),null!=e.annotationsVisible&&""==e.SelectAnnotation&&V.viewer.setAnnotationsVisibility(e.annotationsVisible),null!=e.clipBoxActive&&(l=He.getExtension("ClipExtension"))&&l.isClipBoxActive()!==e.clipBoxActive&&l.onBoxSectionView(e.clipBoxActive),V.viewer.Optoolbar&&null==(d=V.viewer.Optoolbar.getMeasureDlg())&&(d=new OpMeasureDlg(V.viewer),V.viewer.Optoolbar.setMeasureDlg(d)),null!=e.measureDlg&&d.show(e.measureDlg),(V.viewer.bLinesVisibility&&0==e.line||!V.viewer.bLinesVisibility&&1==e.line)&&(V.viewer.setLinesVisibility(1==e.line,!1),V.viewer.tlbOperator)&&(V.viewer.getLinesVisibility()?null==(h=V.viewer.tlbOperator.getChildElement("btnLineInVisible"))&&(c=V.viewer.tlbOperator.getChildElement("btnLineVisible"))&&(c.domElement.id="btnLineInVisible",V.viewer.tlbOperator.updateChildElement("btnLineVisible","btnLineInVisible")):null==(c=V.viewer.tlbOperator.getChildElement("btnLineVisible"))&&(h=V.viewer.tlbOperator.getChildElement("btnLineInVisible"))&&(h.domElement.id="btnLineVisible",V.viewer.tlbOperator.updateChildElement("btnLineInVisible","btnLineVisible"))),null!=e.annoSetting&&V.viewer.tlbOperator&&(u=V.viewer.tlbOperator.getChildElement("btnAnnotationSettingShow"),1==e.annoSetting&&null==u&&((p=V.viewer.tlbOperator.getChildElement("btnAnnotationSettingHide"))&&(p.domElement.id="btnAnnotationSettingShow",V.viewer.tlbOperator.updateChildElement("btnAnnotationSettingHide","btnAnnotationSettingShow")),V.viewer.annotationsManager)&&V.viewer.annotationsManager.getAnnotationJsonArray()&&V.viewer.showAnnotations(V.viewer.annotationsManager.getAnnotationJsonArray(),!1),0==e.annoSetting)&&null!=u&&V.viewer.tlbOperator&&(u.domElement.id="btnAnnotationSettingHide",V.viewer.tlbOperator.updateChildElement("btnAnnotationSettingShow","btnAnnotationSettingHide"),V.viewer.annotationsManager)&&V.viewer.annotationsManager.removeAllAnnotations(!1),V.viewer.scene.traverse(function(e){"lightctrls"!=e.name&&(null!=e.matrixWorldTransOrginalDrag&&(e.matrixWorldTransOrginalDrag=void 0),e.matrixWorldTransExplode?e.matrixWorld.setPosition(e.matrixWorldTransExplode):e.matrixWorldTransOrginal&&e.matrixWorld.setPosition(e.matrixWorldTransOrginal))}),V.viewer.ndsModel)if(null!=e.meshSel&&0<e.meshSel.length){var w=!0,x=V.viewer.ndsModel.getSelectedBodies();if(e.meshSel.length==x.length){var b=!0;if(V.viewer.ndsModel.objectidTouuid&&!V.viewer.is2DModel){for(y=0;y<x.length;++y)if(e.meshSel[y]!=x[y].objectid){b=!1;break}}else for(y=0;y<x.length;++y)if(e.meshSel[y]!=x[y].id){b=!1;break}b&&(w=!1)}if(w){V.viewer.ndsModel.clearSelection();for(var B,O,F=V.viewer.selectionManager.getSelectedObjects(),y=F.length=0;y<e.meshSel.length;++y)(B=!this.viewer.ndsModel.objectidTouuid||V.viewer.is2DModel?V.viewer.ndsModel.getBodyNode(e.meshSel[y]):(O=V.viewer.ndsModel.objectidTouuid[e.meshSel[y]],V.viewer.ndsModel.getBodyNodeFromUuid(O)))&&(V.viewer.ndsModel.models.forEach(function(e){e.meshManager.setSelectedMaterial(De.selectedMaterial,De.selectedLineMaterial)}),V.viewer.ndsModel.addSelection(B),F.push(B));var I,T,S=V.viewer.getCurrentMeasureType(),R="BodyVolume"!==S&&"BodyArea"!==S?!0:!1;De.enableBodyVolumeMeasure&&(!V.viewer.hasBrepInfo()||V.viewer.productData)&&R&&((I=V.viewer.getSelectedObjectProperty(function(){}))&&1e-7<I.area?V.viewer.dispatchAsyncEvent({type:"BodySelectionChangeEvent",volumeAreaInfo:I,modelUnit:I.unit}):V.viewer.dispatchAsyncEvent({type:"BodySelectionChangeEvent",volumeAreaInfo:null,modelUnit:null})),De.enableBodyVolumeMeasure&&V.viewer.hasBrepInfo()&&!V.viewer.productData&&R&&((T=V.viewer.selectionManager.getSelectedBodyVolumeAndArea())?V.viewer.dispatchAsyncEvent({type:"BodySelectionChangeEvent",volumeAreaInfo:T[0],modelUnit:T[1]}):V.viewer.dispatchAsyncEvent({type:"BodySelectionChangeEvent",volumeAreaInfo:null,modelUnit:null})),De.enableBodyVolumeMeasure&&V.viewer.hasBrepInfo()&&!R&&((T=V.viewer.selectionManager.getSelectedBodyVolumeAndArea())?V.viewer.dispatchAsyncEvent({type:"BodyMeasureChangeEvent",volumeAreaInfo:T[0],measureType:S,modelUnit:T[1]}):V.viewer.dispatchAsyncEvent({type:"BodyMeasureChangeEvent",volumeAreaInfo:null,measureType:S,modelUnit:null})),e.selfromTree||V.viewer.dispatchAsyncEvent({type:"selectObjectEvent"})}}else V.viewer.selectionManager.clearSelection();if(null!=e.explode&&(e.explode.mode&Ce.EXPLODEMODE.SELECTED?(V.viewer.explodeObjects=e.explode.obj,V.viewer.setExplodeMode(e.explode.mode,e.explode.level,!0)):V.viewer.setExplodeMode(e.explode.mode,e.explode.level),V.viewer.getExplodeFactor()!=e.explode.factor)&&V.viewer.explodeModel(e.explode.factor),null!=e.dragBtn&&V.viewer.Optoolbar&&V.viewer.Optoolbar.setDragToolbarBtnSelected(e.dragBtn),V.viewer.Optoolbar&&(V.viewer.Optoolbar.setExplodeDlgVisibility(1==e.explodeDlg),V.viewer.Optoolbar.setExplodeDlgValue(1==e.explodeDlg?e.explodeDlgValue:0)),e.meshVisible&&V.viewer.ndsModel){V.viewer.ndsModel.hideBody(V.viewer.ndsModel.rootBodyNode);for(y=0;y<e.meshVisible.length;++y){var C=e.meshVisible[y];V.viewer.ndsModel.hasHiddenBodies=!0,(A=V.viewer.ndsModel.getBodyNode(C)).show()}}if(e.meshInvisible&&V.viewer.ndsModel){V.viewer.ndsModel.showBody(V.viewer.ndsModel.rootBodyNode);for(y=0;y<e.meshInvisible.length;++y){C=e.meshInvisible[y];V.viewer.ndsModel.hasHiddenBodies=!0,(A=V.viewer.ndsModel.getBodyNode(C)).hide(),V.viewer.ndsModel.meshManager.setGeomSameMaterialFlag(A)}}if(V.viewer.ndsModel&&V.viewer.ndsModel.inIsolate()&&V.viewer.ndsModel.exitIsolate(),e.meshTrans&&0<e.meshTrans.length&&V.viewer.ndsModel){for(var D=[],y=0;y<e.meshTrans.length;++y){C=e.meshTrans[y];D.push(V.viewer.ndsModel.getBodyNode(C))}V.viewer.ndsModel.transparentizeBodies(D)}if(e.meshNoTrans)if(0<e.meshNoTrans.length){for(D=[],y=0;y<e.meshNoTrans.length;++y){C=e.meshNoTrans[y];D.push(V.viewer.ndsModel.getBodyNode(C))}V.viewer.ndsModel.isolateBodies(D,De.bodyOpacity,De.lineOpacity)}else 0==e.meshNoTrans.length&&((f=[]).push(V.viewer.ndsModel.rootBodyNode),V.viewer.ndsModel.transparentizeBodies(f));if(null!=e.camera&&(V.viewer.camera.fov=e.camera.fov,V.viewer.camera.near=e.camera.near,V.viewer.camera.far=e.camera.far,V.viewer.camera.position.fromArray(e.camera.pos),V.viewer.camera.up.fromArray(e.camera.up),V.viewer.camera.setCameraTarget((new THREE.Vector3).fromArray(e.camera.center)),V.viewer.camera.isPerspective=e.camera.persp,V.viewer.camera.updateProjectionMatrix(),V.viewer.viewBox)&&V.viewer.cameraControl.updateViewBoxCamDir(),null!=e.clipPlaneInfo?(m=He.getExtension("ClipExtension"))&&(m.isSectionViewEnabled()||(m.onSectionView(!0,!1),V.viewer.tlbOperator&&(v=V.viewer.tlbOperator.getChildElement("btnSectionView"))&&(v.setBorder("1px solid rgba(150,150,150,0.8)"),v.setBgColor(De.toolbarButtonClickedBkgColor))),m.setClipPlaneInfor(e.clipPlaneInfo)):(g=He.getExtension("ClipExtension"))&&g.isSectionViewEnabled()&&(g.onSectionView(!1,!1),V.viewer.tlbOperator)&&(v=V.viewer.tlbOperator.getChildElement("btnSectionView"))&&(v.setBorder(""),v.setBgColor("")),null!=e.mousePos&&!e.isMobile){var P=V.viewer.renderer.getPixelRatio();switch(null==G&&((G=document.createElement("div")).className="broadcastMouseDiv",G.onselectstart=function(){return!1},V.viewer.container.appendChild(G)),G.style.top=e.mousePos[1]*V.viewer.renderer.domElement.height/P+"px",G.style.left=e.mousePos[0]*V.viewer.renderer.domElement.width/P+"px","Cross"==e.cursor?(G.style.width="96px",G.style.height="96px"):(G.style.width="24px",G.style.height="24px"),e.cursor){case"Orbit":"broadcastMouseDivOrbit"!=G.id&&(G.id="broadcastMouseDivOrbit");break;case"Pan":"broadcastMouseDivPan"!=G.id&&(G.id="broadcastMouseDivPan");break;case"Zoom":"broadcastMouseDivZoom"!=G.id&&(G.id="broadcastMouseDivZoom");break;case"Normal":"broadcastMouseDivNormal"!=G.id&&(G.id="broadcastMouseDivNormal");break;case"Cross":"broadcastMouseDivCoordinate"!=G.id&&(G.id="broadcastMouseDivCoordinate");break;default:"broadcastMouseDivNormal"!=G.id&&(G.id="broadcastMouseDivNormal")}}if((e.isMobile||De.broadcastMajor)&&G&&(V.viewer.container.removeChild(G),G=null),void 0!==e.shouldShowMeasureContent&&V.viewer.controls.staticmeasureOp&&V.viewer.controls.staticmeasureOp.setMeasureVisible(e.shouldShowMeasureContent),void 0!==e.shouldStopPMIOcclusion&&V.viewer.stopPMIOcclusion(e.shouldStopPMIOcclusion),void 0!==e.PMIObjectVisibleList){V.viewer.getPMIObject()&&V.viewer.setPMIObjectVisible(V.viewer.getPMIObject(),!1);for(var H=0,U=e.PMIObjectVisibleList.length;H<U;H++)V.viewer.setPMIObjectVisible(V.viewer.PMIUUIDtoPMIObject[e.PMIObjectVisibleList[H]],!0)}if(void 0!==e.PMIObjectSelList){V.viewer.getPMIObject()&&V.viewer.deselectPMIObject(V.viewer.getPMIObject());for(var _=0,N=e.PMIObjectSelList.length;_<N;_++)V.viewer.selectPMIObject(V.viewer.PMIUUIDtoPMIObject[e.PMIObjectSelList[_]])}if(void 0!==e.shouldShowAnnotationContent&&V.viewer.showNoteAnnotation(e.shouldShowAnnotationContent),void 0!==e.annotationNoteContent){V.viewer.clearAnnotation();for(var L=0;L<e.annotationNoteContent.length;L++)V.viewer.setNoteAnnotation(e.annotationNoteContent[L])}He.onAfterSetBroadcastInfo(e),V.viewer.render()}}catch(e){console.error(e)}},this.resetLocalCache=function(){V._measureContent=null,V._PMISelContent=null,V._PMIObjectVisibleContent=null}}function Wr(e){var t=this,n=(this.viewer=e,this.customComments=new Array,this.commentsStyle={font:"20px Verdana",color:"#ff0000"},this);this.clear=function(){t.customComments=new Array},this.setDefultStyle=function(e){null!=e&&(null!=e.font&&(this.commentsStyle.font=e.font),null!=e.color)&&(this.commentsStyle.color=e.color)},this.addComment=function(e){return null==e.visible&&(e.visible=!0),null==e.hasIndicator&&(e.visible=!1),n.customComments.push(e),n.viewer.render(),n.customComments.length-1},this.getAllComments=function(){return n.customComments},this.getCommentsCount=function(){return n.customComments.length},this.getComment=function(e){return null==e||e<0||e>=n.customComments.length?null:n.customComments[e]},this.setCommentVisible=function(e,t){null==e||null==t||e<0||e>=n.customComments.length||null!=t&&(n.customComments[e].visible=t,n.viewer.render())},this.removeComment=function(e){null==e||e<0||e>=n.customComments.length||(n.customComments.splice(e,1),n.viewer.render())},this.removeAllComments=function(){var e=n.customComments.length;n.customComments.splice(0,e),n.viewer.render()},this.get2dPoint=function(e){var e=(new THREE.Vector3).copy(e),t=(e.project(n.viewer.camera),n.viewer.container.offsetWidth/2),r=n.viewer.container.offsetHeight/2;return{x:Math.round(e.x*t+t),y:Math.round(-e.y*r+r)}},this.setAllCommentsVisible=function(e){if(null!=e){for(var t=0;t<n.customComments.length;t++)n.customComments[t].visible=e;n.viewer.render()}},this.renderComments=function(){if(null!=n.viewer.canvas2DLayer){var e=n.viewer.canvas2DLayer.getContext("2d");if(e.clearRect(0,0,window.innerWidth,window.innerHeight),0<n.customComments.length){n.viewer.canvas2DLayer.style.display="";for(var t=0;t<n.customComments.length;t++){var r,i=n.customComments[t];i.visible&&(r=n.get2dPoint(n.customComments[t].position),null!=i.font?e.font=i.font:e.font=this.commentsStyle.font,null!=i.color?e.fillStyle=i.color:e.fillStyle=this.commentsStyle.color,i.hasIndicator?(e.beginPath(),e.arc(r.x,r.y,4,0,2*Math.PI),e.fill(),e.fillText(n.customComments[t].text,r.x+6,r.y+5)):(e.beginPath(),e.fillText(n.customComments[t].text,r.x,r.y)))}}}}}function Xr(e,t){this.viewer=e;var r="coverer_"+Date.now();(r=new Ce.Element({className:"coverer",id:r})).setVisibility(!1),void 0!==t&&r.setBgColor(t),e.container.appendChild(r.domElement),e.coverer=r}function qr(e){var o=this;this.viewer=e,this.Fonts={},this.loadFonts=function(t,r){function i(){console.log("load Font error")}var n=new THREE.FontLoader,a=new Rt(new THREE.LoadingManager);a.setCrossOrigin("anonymous"),a.setResponseType("arraybuffer");a.load(o.viewer.gobalReqHeader,"./Fonts/DS ISO 1_Regular.js.gz",function(e){e=pako.inflate(e,{to:"string"}),e=JSON.parse(e);o.Fonts.default=n.parse(e),t?a.load(o.viewer.gobalReqHeader,"./Fonts/simfang_Regular.js.gz",function(e){e=pako.inflate(e,{to:"string"}),e=JSON.parse(e);o.Fonts.simfang=n.parse(e),r&&r()},void 0,i):r&&r()},void 0,i)}}var Yr,Qr,Kr,Zr,Jr,$r,ei,ti,ri,ii,ni,ai,oi,si,li,di,ci=30,hi=20,a=function n(e){this.type="OpBase",this.viewer=e,this.state=-1,this.pointer=new THREE.Vector2,this.pointerOld=new THREE.Vector2,this.pointer2nd=new THREE.Vector2,this.pointerOld2nd=new THREE.Vector2,this.MouseDown=new THREE.Vector2,this.MouseUp=new THREE.Vector2,this.lMouseDown=new THREE.Vector2,this.lMouseUp=new THREE.Vector2,this.downModelPnt=new THREE.Vector3,this.singleTouchStartPos=new THREE.Vector2,this.singleTouchEndPos=new THREE.Vector2,this.normalMatrix=new THREE.Matrix3,this.intervalTimer=null,this.isDoubleTouch=!1,this.needIgnoreModelSelection=!1;var t=.7,r=new THREE.SphereGeometry(t,20,20),i=new THREE.MeshPhongMaterial({color:7829503,depthTest:!0}),a=(this.rotateCenterHelper=new THREE.Mesh(r,i),this.rotateCenterHelper.name="rotateCenterHelper",this.rotateSphereCenter=null),o=(this.OpBeginTime=null,this.oldSelectType=e.selectionManager.getSelectType(),this.startTransform=null,this.endTransform=null,this.entityIsTransformed=!1,this.transformType="",(e.canvas2D||e.canvas3D).height,this.latAngle=0,this.selectBodyByRect=!this.viewer.is2DModel,this.selectBodyByClick=!0,this);function s(){this.getCameraScale=function(e,t){var r,i,n;return e?(t=null!=t?t:5,r=o.viewer.camera.getCameraTarget(),i=o.viewer.camera.position,(n=new THREE.Vector3).subVectors(r,i),r=e.clone(),e=o.viewer.camera.isPerspective?r.sub(i).dot(n.normalize()):1.2*n.length(),r=o.viewer.camera.fov,i=2*e*Math.tan(THREE.Math.degToRad(.5*r)),n=o.viewer.renderer.domElement.height,t*i*o.viewer.renderer.getPixelRatio()/n):1},this.run=function(){var e;o.rotateSphereCenter&&o.viewer.scene.getObjectByName("rotateCenterHelper")&&(e=this.getCameraScale(o.rotateCenterHelper.position,10*t),o.rotateCenterHelper.scale.x=o.rotateCenterHelper.scale.y=o.rotateCenterHelper.scale.z=e,o.rotateCenterHelper.updateMatrixWorld(!0))}}this.showRotateCenterHelper=function(){try{if(o.viewer.scene.getObjectByName("rotateCenterHelper"))return}catch(e){return}if(!o.rotateSphereCenter){var e=o.viewer.cameraControl.getRotateCenter();if(!e){var t=o.viewer.controls.getBoundingBox();if(t||renturn,!(e=t.getCenter()))return}o.rotateSphereCenter=e.clone(),o.rotateCenterHelper.position.x=o.rotateSphereCenter.x,o.rotateCenterHelper.position.y=o.rotateSphereCenter.y,o.rotateCenterHelper.position.z=o.rotateSphereCenter.z}a=a||new s,o.viewer.addFrameListener(a),o.viewer.scene.add(o.rotateCenterHelper),o.rotateCenterHelper.updateMatrixWorld(!0),o.viewer.render()},this.hideRotateCenterHelper=function(){try{if(!o.viewer.scene.getObjectByName("rotateCenterHelper"))return}catch(e){return}a&&o.viewer.removeFrameListener(a),o.viewer.scene.remove(o.rotateCenterHelper),o.viewer.render()},this.updateRotateCenterHelper=function(){var e=o.viewer.cameraControl.getRotateCenter();e&&(o.rotateSphereCenter=e.clone()),o.rotateSphereCenter&&!o.rotateCenterHelper.position.equals(o.rotateSphereCenter)&&(o.rotateCenterHelper.position.x=o.rotateSphereCenter.x,o.rotateCenterHelper.position.y=o.rotateSphereCenter.y,o.rotateCenterHelper.position.z=o.rotateSphereCenter.z,o.rotateCenterHelper.updateMatrixWorld(!0))},this.onMouseOut=function(e){De.enableBroadcast&&!De.broadcastMajor||(e.preventDefault(),o.IsNodeChildOfContainer(e.toElement))||o.onMouseUp(e)},this.IsNodeChildOfContainer=function(e){return!!e&&(e==o.viewer.container||o.IsNodeChildOfContainer(e.parentNode))},this.updateViewCenterByVisibleBody=function(){var e,t;De.AnimationEdit||De.ScenarioEditor||o.viewer.is2DModel||(t=o.viewer.ndsModel.getTotalBodyBoundingBox(null,!0),e=new THREE.Vector3,t.getSize(e),(0!=e.x||0!=e.y||0!=e.z)&&(e=new THREE.Vector3,t.getCenter(e),o.viewer.controls.setBoundingBox(t.min,t.max),o.viewer.cameraControl.setRotateCenter(e),t=o.viewer.controls.getOperator())&&t.updateRotateCenterHelper())},this.onMouseDown=function(e){var t,r,i,n;0===e.button&&1==e.buttons||1===e.button&&4==e.buttons||2===e.button&&2==e.buttons?De.enableBroadcast&&!De.broadcastMajor||He.needDisableInputEvent()||(e.preventDefault(),t=e.offsetX||e.clientX-o.viewer.container.getBoundingClientRect().left,r=e.offsetY||e.clientY-o.viewer.container.getBoundingClientRect().top,e.srcElement&&e.srcElement!==o.viewer.renderer.domElement&&(t=e.clientX-o.viewer.container.getBoundingClientRect().left,r=e.clientY-o.viewer.container.getBoundingClientRect().top),null==e.srcElement&&e.target&&e.target!==o.viewer.renderer.domElement&&(t=e.clientX-o.viewer.container.getBoundingClientRect().left,r=e.clientY-o.viewer.container.getBoundingClientRect().top),o.viewer.viewManager&&o.viewer.viewManager.preselectActiveView(t,r),t=(i=o.remapCoordnidateToFullView(t,r))[0],r=i[1],o.pointer.set(t,r),i=[t,r],(n=null)!=(n=o.viewer.is2DModel?n:o.viewer.getIntersectionPtByScreenPt(i,!1))?o.downModelPnt.set(n.coords[0],n.coords[1],n.coords[2]):(n=o.viewer.clientCoordToModelCoord(i),o.downModelPnt.set(n[0],n[1],n[2])),o.MouseDown.set(t,r),0===e.button?(o.lMouseDown.set(t,r),o.onLMouseDown(e)):1===e.button?(o.onMMouseDown(e),o.viewer.renderer.domElement.removeEventListener("mousewheel",o.onMouseWheel,!1),o.viewer.canvas2D&&o.viewer.canvas2D.removeEventListener("mousewheel",o.onMouseWheel,!1)):2===e.button&&o.onRMouseDown(e),o.pointerOld.set(t,r),document.addEventListener("mouseup",o.onMouseUp,!1),o.viewer.testMode&&console.log("屏幕按下坐标为 x :"+e.clientX+" y :"+e.clientY)):console.log("onMouseDown btn %d btns %d undefined combo",e.button,e.buttons)};var l,d,c,h;l=o.onNMouseMove,d=100,h=o;this.onMouseMove=function(e){var t,r,i;o.OpBeginTime=Date.now(),De.enableBroadcast&&!De.broadcastMajor||(e.preventDefault(),r=e.offsetX||e.clientX-o.viewer.container.getBoundingClientRect().left,i=e.offsetY||e.clientY-o.viewer.container.getBoundingClientRect().top,e.srcElement&&e.srcElement!==o.viewer.renderer.domElement&&(r=e.clientX-o.viewer.container.getBoundingClientRect().left,i=e.clientY-o.viewer.container.getBoundingClientRect().top),null==e.srcElement&&e.target&&e.target!==o.viewer.renderer.domElement&&(r=e.clientX-o.viewer.container.getBoundingClientRect().left,i=e.clientY-o.viewer.container.getBoundingClientRect().top),r=(t=o.remapCoordnidateToFullView(r,i))[0],i=t[1],o.pointer.set(r,i),o.pointer.equals(o.pointerOld))||(o.viewer.promptshow?(o.viewer.prompt.innerHTML=o.viewer.promptstring,o.viewer.prompt.style.display="inline",o.viewer.prompt&&(o.viewer.prompt.style.left=e.clientX+16-o.viewer.prompt.clientoffsetX+"px",o.viewer.prompt.style.top=e.clientY+16-o.viewer.prompt.clientoffsetY+"px")):o.viewer.prompt&&(o.viewer.prompt.style.display="none"),o.state===Ce.MOUSE.LEFT?o.viewer.controls.staticAnnotation&&o.viewer.controls.staticAnnotation.onLMouseMoveEnable()?"OpAnnotationNew"==o.type&&o.onLMouseMove(e):De.enableDirectMove&&o.viewer.selectionManager.hasTransformableObjectSelected()&&"OpBall"!=o.viewer.controls.getOperator().type?n.prototype.onLMouseMove.call(o,e):o.viewer.controls.getOperator().type==o.type&&o.onLMouseMove(e):o.state===Ce.MOUSE.MIDDLE?o.onMMouseMove(e):o.state===Ce.MOUSE.RIGHT?De.enableDirectRotate&&o.viewer.selectionManager.hasTransformableObjectSelected()&&"OpBall"!=o.viewer.controls.getOperator().type?n.prototype.onRMouseMove.call(o,e):o.onRMouseMove(e):(o.viewer.viewBox&&(o.viewer.viewBox.processMouseMove(e),o.viewer.viewBox.mouseMoveSave=e),o.onNMouseMove(e)),o.pointerOld.set(r,i))},this.onMouseUp=function(e){var t,r,i;0!==e.button&&1!==e.button&&2!==e.button||0!=e.buttons?("OpAnnotationNew"==this.type&&(this._isDragging||this._isResizing)&&(this._isDragging=!1,this._isResizing=!1,this.onLMouseUp()),console.log("onMouseUp btn %d btns %d undefined combo",e.button,e.buttons)):(o.hideRotateCenterHelper(),document.removeEventListener("mouseup",o.onMouseUp,!1),e.preventDefault(),r=e.offsetX||e.clientX-o.viewer.container.getBoundingClientRect().left,i=e.offsetY||e.clientY-o.viewer.container.getBoundingClientRect().top,e.srcElement&&e.srcElement!==o.viewer.renderer.domElement&&(r=e.clientX-o.viewer.container.getBoundingClientRect().left,i=e.clientY-o.viewer.container.getBoundingClientRect().top),null==e.srcElement&&e.target&&e.target!==o.viewer.renderer.domElement&&(r=e.clientX-o.viewer.container.getBoundingClientRect().left,i=e.clientY-o.viewer.container.getBoundingClientRect().top),o.viewer.viewManager&&o.viewer.viewManager.setActiveView(r,i),r=(t=o.remapCoordnidateToFullView(r,i))[0],i=t[1],o.MouseUp.set(r,i),o.state===Ce.MOUSE.LEFT?(o.lMouseUp.set(r,i),o.onLMouseUp(e),"OpDrag"==o.viewer.controls.getOperator().type&&"OpDrag"==o.type&&o.onLMouseUpEnd(e)):o.state===Ce.MOUSE.MIDDLE?(o.onMMouseUp(e),o.viewer.renderer.domElement.addEventListener("mousewheel",o.onMouseWheel,!1),o.viewer.canvas2D&&o.viewer.canvas2D.addEventListener("mousewheel",o.onMouseWheel,!1)):o.state===Ce.MOUSE.RIGHT&&o.onRMouseUp(e),o.viewer.testMode&&(t=o.viewer.getCameraInfo(),console.log("相机信息： "+JSON.stringify(t))),De.enableBroadcast&&De.broadcastMajor&&o.type===o.viewer.controls.getOperator().type&&He.updateBroadcastInfo("generalInfo"))};u=function(){var e=o.viewer.getCameraInfo();console.log("相机信息： "+JSON.stringify(e))},p=null;var u,p,f=function(){null!==p&&clearTimeout(p),p=setTimeout(u,1e3)};this.onMouseWheel=function(e){var t,r;o.OpBeginTime=Date.now(),De.enableBroadcast&&!De.broadcastMajor||(e.preventDefault(),o.mouseEvent(e),t=0,r=ci,e.shiftKey&&(r=hi),e.wheelDelta?t=-e.wheelDelta:e.detail&&(t=e.detail),o.viewer.getMouseWheelForwardEnlargeFlag()||(t*=-1),t=0<t?r:-r,o.zoom(new THREE.Vector3(0,0,t),e),o.viewer.testMode&&f(),De.enableBroadcast&&De.broadcastMajor&&o.type===o.viewer.controls.getOperator().type&&He.updateBroadcastInfo("generalInfo"))},this.onClick=function(e){o.OpBeginTime=Date.now(),De.enableBroadcast&&!De.broadcastMajor||He.needDisableInputEvent()||(e.preventDefault(),0===e.button?o.lMouseDown.equals(o.lMouseUp)&&o.onLMouseClick(e):1===e.button?o.onMMouseClick(e):2===e.button&&o.onRMouseClick(e))},this.ondblClick=function(e){De.enableBroadcast&&!De.broadcastMajor||o.viewer.controls.getOperator().type===o.type&&(e.preventDefault(),0===e.button?o.onLMouseDbClick():1!==e.button&&e.button)},this.touchstart=function(e){if((!De.enableBroadcast||De.broadcastMajor)&&!(He.needDisableInputEvent()||o.viewer.__globalMeasureExtension&&o.viewer.__globalMeasureExtension.isInLineargauge())){switch(e.preventDefault(),e.touches.length){case 1:if(clearTimeout(o.intervalTimer),o.isDoubleTouch)return o.viewer.__globalMeasureExtension&&o.type!=o.viewer.__globalMeasureExtension.getOperatorName()&&(De.enableSelect?o.selectAndZoom(o.singleTouchEndPos.x,o.singleTouchEndPos.y):o.viewer.zoomExtents()),o.updateRotateCenterHelper(),o.state=-1,void(o.isDoubleTouch=!1);o.isDoubleTouch=!0,o.intervalTimer=setTimeout(function(){o.isDoubleTouch=!1},300);var t=e.touches[0].offsetX||e.touches[0].clientX-o.viewer.container.getBoundingClientRect().left,r=e.touches[0].offsetY||e.touches[0].clientY-o.viewer.container.getBoundingClientRect().top;o.pointer.set(t,r),o.pointerOld.set(t,r),o.singleTouchStartPos.set(t,r),o.viewer.testMode&&console.log("屏幕按下坐标为 x :"+t+" y :"+r),o.onTouchSingleStart(e);break;case 2:o.isDoubleTouch=!1;t=e.touches[0].offsetX||e.touches[0].clientX-o.viewer.container.getBoundingClientRect().left,r=e.touches[0].offsetY||e.touches[0].clientY-o.viewer.container.getBoundingClientRect().top;o.pointer.set(t,r),o.pointerOld.set(t,r),t=e.touches[1].offsetX||e.touches[1].clientX-o.viewer.container.getBoundingClientRect().left,r=e.touches[1].offsetY||e.touches[1].clientY-o.viewer.container.getBoundingClientRect().top,o.pointer2nd.set(t,r),o.pointerOld2nd.set(t,r),o.onTouchDoubleStart(e);break;default:o.isDoubleTouch=!1}var i=[o.pointer.x,o.pointer.y],n=null;null!=(n=o.viewer.is2DModel||1!=e.touches.length?n:o.viewer.getIntersectionPtByScreenPt(i,!1))?o.downModelPnt.set(n.coords[0],n.coords[1],n.coords[2]):(n=o.viewer.clientCoordToModelCoord(i),o.downModelPnt.set(n[0],n[1],n[2]))}},this.touchmove=function(e){if(o.OpBeginTime=Date.now(),(!De.enableBroadcast||De.broadcastMajor)&&!(He.needDisableInputEvent()||o.viewer.__globalMeasureExtension&&o.viewer.__globalMeasureExtension.isInLineargauge())){switch(e.preventDefault(),e.touches.length){case 1:var t=e.touches[0].offsetX||e.touches[0].clientX-o.viewer.container.getBoundingClientRect().left,r=e.touches[0].offsetY||e.touches[0].clientY-o.viewer.container.getBoundingClientRect().top;if(o.pointer.set(t,r),o.viewer.limitEventArea){var i=o.viewer.container.getBoundingClientRect().width,n=o.viewer.container.getBoundingClientRect().height;if(i<t||n<r)return void o.touchend(e)}break;case 2:t=e.touches[0].offsetX||e.touches[0].clientX-o.viewer.container.getBoundingClientRect().left,r=e.touches[0].offsetY||e.touches[0].clientY-o.viewer.container.getBoundingClientRect().top;if(o.pointer.set(t,r),t=e.touches[1].offsetX||e.touches[1].clientX-o.viewer.container.getBoundingClientRect().left,r=e.touches[1].offsetY||e.touches[1].clientY-o.viewer.container.getBoundingClientRect().top,o.pointer2nd.set(t,r),o.viewer.limitEventArea){i=o.viewer.container.getBoundingClientRect().width,n=o.viewer.container.getBoundingClientRect().height;if((o.pointer.x>i||o.pointer.y>n)&&(o.pointer2nd.x>i||o.pointer2nd.y>n))return void o.touchend(e)}}switch(o.state){case Ce.TOUCH.TOUCH_SINGLE:o.viewer.controls.getOperator().type!=o.type&&1!=e.force||o.onTouchSingleMove(e);break;case Ce.TOUCH.TOUCH_DOUBLE:o.onTouchDoubleMove(e)}o.pointerOld.copy(o.pointer),o.pointerOld2nd.copy(o.pointer2nd)}},this.touchend=function(e){if((!De.enableBroadcast||De.broadcastMajor)&&!(He.needDisableInputEvent()||o.viewer.__globalMeasureExtension&&o.viewer.__globalMeasureExtension.isInLineargauge())){switch(o.state){case Ce.TOUCH.TOUCH_SINGLE:var t,r;e.changedTouches&&0<e.changedTouches.length&&(r=e.changedTouches[0].offsetX||e.changedTouches[0].clientX-o.viewer.container.getBoundingClientRect().left,t=e.changedTouches[0].offsetY||e.changedTouches[0].clientY-o.viewer.container.getBoundingClientRect().top,o.singleTouchEndPos.set(r,t)),o.viewer.testMode&&(r=o.viewer.getCameraInfo(),console.log("相机信息： "+JSON.stringify(r))),o.onTouchSingleEnd(e);break;case Ce.TOUCH.TOUCH_DOUBLE:o.onTouchDoubleEnd(e)}o.state=-1}},this.touchcancel=function(e){o.state=-1},this.onKeyDown=function(e){switch(e.keyCode){case 38:De.enableArrowKeyOp&&o.moveForwardBack(!0,!0);break;case 37:De.enableArrowKeyOp&&o.pan(new THREE.Vector3(-20,0,0),!0);break;case 40:De.enableArrowKeyOp&&o.moveForwardBack(!1,!0);break;case 39:De.enableArrowKeyOp&&o.pan(new THREE.Vector3(20,0,0),!0);break;case 46:var t;"OpAnnotationNew"==o.type&&o.enableMove&&(o.clearFlag(!0),o.deleteNoteAnnotation(o.selectID),o.deleteNoteAnnotation(o.picSelectID),(t=o.selectIDs.concat()).length)&&o.deleteNoteAnnotation(t)}o.onKey(e)},this.onKeyUp=function(e){}},ui=(a.prototype={constructor:a,center:function(){return this.viewer.camera.getCameraTarget()},render:function(e,t){this.dispatchEvent({type:"render",forceRenderAll:e=void 0===e?!1:e,onlyUpdateActiveView:t=void 0===t?!0:t})},renderModel:function(){var e,t,r,i,n;4==this.viewer.Rectangle.length&&(e=this.viewer.canvas2D.getContext("2d"),t=this.viewer.Rectangle[0],r=this.viewer.Rectangle[1],i=this.viewer.Rectangle[2],n=this.viewer.Rectangle[3],this.viewer.is2DModel||"OpZoomWindow"==this.type?(e.strokeStyle="#00FFFF",e.setLineDash([5,5]),e.beginPath(),e.moveTo(t,i),e.lineTo(r,i),e.lineTo(r,n),e.lineTo(t,n),e.lineTo(t,i),e.closePath(),e.stroke(),e.setLineDash([])):(e.strokeStyle="#3C92DE",e.beginPath(),e.lineWidth=2,e.moveTo(t,i),e.lineTo(r,i),e.lineTo(r,n),e.lineTo(t,n),e.lineTo(t,i),e.closePath(),e.stroke(),e.lineWidth=1))},update:function(){},remapCoordnidateToFullView:function(e,t){return this.viewer.viewManager?this.viewer.viewManager.remapViewCoordinateToFullView(e,t):[e,t]},remapCoordnidateToViewPort:function(e,t){return this.viewer.viewManager?this.viewer.viewManager.remapViewCoordinateToViewPort(e,t):[e,t]},mouseEvent:function(e){this.dispatchEvent({type:"mouseEvent",event:e})},onTouchSingleStart:function(e){this.state=Ce.TOUCH.TOUCH_SINGLE,this.viewer.cameraControl.isViewLockedBySingleBody||this.updateViewCenterByVisibleBody()},onTouchSingleMove:function(e){var t,r,i,n;this.viewer.is2DModel&&De.New2DMeasure&&this.viewer.__globalMeasureExtension&&this.type==this.viewer.__globalMeasureExtension.getOperatorName()?(i=this.pointer.x-this.pointerOld.x,n=this.pointer.y-this.pointerOld.y,this.pan(new THREE.Vector3(-i,n,0))):(t=new THREE.Vector2,r=new THREE.Vector2,t.copy(this.getMouseOnCircle(this.pointerOld.x,this.pointerOld.y)),r.copy(this.getMouseOnCircle(this.pointer.x,this.pointer.y)),i=r.x-t.x,n=r.y-t.y,this.rotate(new THREE.Vector3(i,n,0)))},onTouchSingleEnd:function(e){if(this.state=-1,this.viewer.annotationsManager&&"body"==this.viewer.annotationsManager.getAnnotationMode()){var t=Math.abs(this.singleTouchEndPos.x-this.singleTouchStartPos.x),r=Math.abs(this.singleTouchEndPos.y-this.singleTouchStartPos.y);if(t<3&&r<3){if("OpAnnotationNew"==this.type)return;var i=this.viewer.ndsModel.getSelectedBodies().length;this.selectByClick(this.singleTouchEndPos.x,this.singleTouchEndPos.y,!0),0==i&&this.viewer.annotationsManager.setAnnotationPos(this.singleTouchEndPos.x,this.singleTouchEndPos.y)}}else if(this.viewer.annotationsManager&&"face"==this.viewer.annotationsManager.getAnnotationMode()){t=Math.abs(this.singleTouchEndPos.x-this.singleTouchStartPos.x),r=Math.abs(this.singleTouchEndPos.y-this.singleTouchStartPos.y);if(t<3&&r<3){if("OpAnnotationNew"==this.type)return;this.viewer.selectionManager.SelectFace(this.singleTouchEndPos.x,this.singleTouchEndPos.y,!1,null)}}else De.enableSelect&&(t=Math.abs(this.singleTouchEndPos.x-this.singleTouchStartPos.x),r=Math.abs(this.singleTouchEndPos.y-this.singleTouchStartPos.y),t<3)&&r<3&&(this.viewer.is2DModel||("OpAnnotationNew"==this.type?this.onTouchSingle(e):this.selectByClick(this.singleTouchEndPos.x,this.singleTouchEndPos.y)));this.hideRotateCenterHelper(),this.render()},onTouchDoubleStart:function(e){this.state=Ce.TOUCH.TOUCH_DOUBLE},onTouchDoubleMove:function(e){var t=.5*(this.pointerOld.x+this.pointerOld2nd.x),r=.5*(this.pointerOld.y+this.pointerOld2nd.y),i=.5*(this.pointer.x+this.pointer2nd.x),n=.5*(this.pointer.y+this.pointer2nd.y),t=i-t,r=n-r,a=this.pointerOld.x-this.pointerOld2nd.x,o=this.pointerOld.y-this.pointerOld2nd.y,s=a*a+o*o,s=((a=this.pointer.x-this.pointer2nd.x)*a+(o=this.pointer.y-this.pointer2nd.y)*o)/s-1,a=this.pointer.x-this.pointerOld.x,o=this.pointer.y-this.pointerOld.y,l=this.pointer2nd.x-this.pointerOld2nd.x,d=this.pointer2nd.y-this.pointerOld2nd.y,a=new THREE.Vector2(a,o),o=(a.normalize(),new THREE.Vector2(l,d)),l=(o.normalize(),a.dot(o)),d=0,a=ci,o=!1;l<.6?.05<Math.abs(s)&&(d=0<s?-a:a,l={offsetX:i,offsetY:n},this.zoom(new THREE.Vector3(0,0,.4*d),l,!1),o=!0):0==t&&0==r||(this.pan(new THREE.Vector3(-t,r,0),!1),o=!0),o&&this.render()},onTouchDoubleEnd:function(e){this.state=-1,this.hideRotateCenterHelper()},onLMouseDbClick:function(e){if(this.viewer.viewManager)return this.viewer.viewManager.isActiveViewInRender()?(De.enableSelect?this.selectAndZoom(this.lMouseUp.x,this.lMouseUp.y,!1):this.viewer.zoomExtents(!1),void this.viewer.viewManager.notifyConnectCameraMove()):void(De.enableSelect?this.viewer.viewManager.updateZoomEvent={type:"selectAndZoom",x:this.lMouseUp.x,y:this.lMouseUp.y}:this.viewer.viewManager.updateZoomEvent={type:"zoomExtents"});De.enableSelect?this.selectAndZoom(this.lMouseUp.x,this.lMouseUp.y):(De.enableICheck&&(this.viewer.cameraControl.isViewLockedBySingleBody=!1),this.viewer.zoomExtents()),this.updateRotateCenterHelper()},onLMouseClick:function(e){var t=this;clearTimeout(t.intervalTimer),t.isDoubleTouch?(t.ondblClick(e),t.isDoubleTouch=!1):(t.isDoubleTouch=!0,t.intervalTimer=setTimeout(function(){t.isDoubleTouch=!1,!De.enableSelect||t.viewer.is2DModel||!t.selectBodyByClick||t.viewer.viewManager&&!t.viewer.viewManager.isActiveViewInRender()||t.selectByClick(t.lMouseUp.x,t.lMouseUp.y,e.ctrlKey)},200))},onMMouseClick:function(e){},onRMouseClick:function(e){},onKey:function(e){},onTransformStart:function(){var e;this.viewer.selectionManager.hasTransformableObjectSelected()&&(e=this.viewer.selectionManager.getSelectedObjects()[0],this.entityIsTransformed=!1,this.transformType="",this.startTransform=new THREE.Matrix4,e.matrix)&&this.startTransform.fromArray(e.matrix)},onTransformFinish:function(){var e,t,r;this.viewer.selectionManager.hasTransformableObjectSelected()&&this.entityIsTransformed&&(e=this.viewer.selectionManager.getSelectedObjects()[0],this.entityIsTransformed=!1,t=e.matrix.slice(0),this.startTransform.toArray(r=[]),this.viewer.dispatchEvent({type:"ComponentTransformedEvent",componentUuid:e.uuid,originalTransform:r,endTransform:t,transformType:this.transformType}),this.transformType="",this.viewer.ndsModel.updateBvh())},onLMouseDown:function(e){this.state=Ce.MOUSE.LEFT,De.enableDirectMove&&!this.viewer.isExploded()&&this.onTransformStart(),this.viewer.cameraControl.isViewLockedBySingleBody||this.updateViewCenterByVisibleBody()},onMMouseDown:function(e){this.state=Ce.MOUSE.MIDDLE,this.mouseEvent(e)},onRMouseDown:function(e){this.state=Ce.MOUSE.RIGHT,this.mouseEvent(e),De.enableDirectRotate&&!this.viewer.isExploded()&&this.onTransformStart()},onLMouseMove:function(e){var t,r,i,n=this.viewer.controls.getOperator().type;"OpZoomWindow"===n||"OpSelectWindow"===n?(e.preventDefault(),n=this.viewer.renderer.getPixelRatio(),e=this.remapCoordnidateToViewPort(this.MouseDown.x,this.MouseDown.y),t=this.remapCoordnidateToViewPort(this.pointer.x,this.pointer.y),this.drawRectangle(e[0]*n,e[1]*n,t[0]*n,t[1]*n)):De.enableDirectMove&&!this.viewer.isExploded()&&this.viewer.selectionManager.hasTransformableObjectSelected()?(e=this.viewer.selectionManager.getSelectedComponent())&&!e.isFixed()&&(r=this.pointer.x-this.pointerOld.x,i=this.pointer.y-this.pointerOld.y,t=[this.downModelPnt.x,this.downModelPnt.y,this.downModelPnt.z],t=[(n=this.viewer.modelCoordToClientCoord(t))[0]+r,n[1]+i,n[2]],n=this.viewer.clientCoordToModelCoord(t),(t=new THREE.Vector3(n[0],n[1],n[2]).clone()).sub(this.downModelPnt),n=new THREE.Matrix4,t=(new THREE.Matrix4).makeTranslation(t.x,t.y,t.z),e.matrix?n.fromArray(e.matrix).premultiply(t):n.copy(t),this.viewer.ndsModel.updateNodeMatrix(e.uuid,n.toArray(),e.getModel().id),this.render(),this.entityIsTransformed=!0,this.transformType="Move"):(t=new THREE.Vector2,n=new THREE.Vector2,t.copy(this.getMouseOnCircle(this.pointerOld.x,this.pointerOld.y)),n.copy(this.getMouseOnCircle(this.pointer.x,this.pointer.y)),r=n.x-t.x,i=n.y-t.y,this.rotate(new THREE.Vector3(r,i,0)))},drawRectangle:function(e,t,r,i,n){this.viewer.Rectangle=[],this.viewer.Rectangle.push(e),this.viewer.Rectangle.push(r),this.viewer.Rectangle.push(t),this.viewer.Rectangle.push(i)},onMMouseMove:function(e){var t,r,i;this.selectBodyByRect&&(t=this.viewer.renderer.getPixelRatio(),r=this.remapCoordnidateToViewPort(this.MouseDown.x,this.MouseDown.y),i=this.remapCoordnidateToViewPort(this.pointer.x,this.pointer.y),this.drawRectangle(r[0]*t,r[1]*t,i[0]*t,i[1]*t))},onRMouseMove:function(e){var t,r,i,n,a,o,s=this.pointer.x-this.pointerOld.x,l=this.pointer.y-this.pointerOld.y;De.enableDirectRotate&&!this.viewer.isExploded()&&this.viewer.selectionManager.hasTransformableObjectSelected()?(t=this.viewer.selectionManager.getSelectedComponent())&&!t.isFixed()&&((r=new THREE.Vector3(0,0,0)).unproject(this.viewer.camera),(n=new THREE.Vector3(10,0,0)).unproject(this.viewer.camera),n.sub(r).normalize(),(i=new THREE.Vector3(0,10,0)).unproject(this.viewer.camera),i.sub(r).normalize(),(r=new THREE.Quaternion).setFromAxisAngle(i,s/200),(i=new THREE.Quaternion).setFromAxisAngle(n,l/200),n=new THREE.Matrix4,a=new THREE.Matrix4,o=new THREE.Matrix4,t.matrix&&n.fromArray(t.matrix),o.makeTranslation(-this.downModelPnt.x,-this.downModelPnt.y,-this.downModelPnt.z),n.premultiply(o),a.premultiply(o),o.makeRotationFromQuaternion(r),n.premultiply(o),a.premultiply(o),o.makeRotationFromQuaternion(i),n.premultiply(o),a.premultiply(o),o.makeTranslation(this.downModelPnt.x,this.downModelPnt.y,this.downModelPnt.z),n.premultiply(o),a.premultiply(o),this.viewer.ndsModel.updateNodeMatrix(t.uuid,n.toArray(),t.getModel().id),this.render(),this.entityIsTransformed=!0,this.transformType="Rotate"):this.pan(new THREE.Vector3(-s,l,0))},onNMouseMove:function(e){De.enablePreSelectBrep&&this.viewer.selectionManager.selectOnMouseMove(this.pointer.x,this.pointer.y)},onLMouseUp:function(e){this.state=-1,De.enableDirectMove&&!this.viewer.isExploded()&&this.onTransformFinish()},setSelectBodyByRect:function(e){this.selectBodyByRect=e},setSelectBodyByClick:function(e){this.selectBodyByClick=e},onMMouseUp:function(e){if(this.state=-1,this.mouseEvent(e),this.selectBodyByRect&&this.viewer.controls.getOperator().type===this.type){e=this.viewer.renderer.getPixelRatio();if(this.viewer.canvas2D.getContext("2d").clearRect(0,0,window.innerWidth*e,window.innerHeight*e),this.MouseDown.x==this.MouseUp.x||this.MouseDown.y==this.MouseUp.y)return this.viewer.Rectangle=[],void this.viewer.render();this.viewer.Rectangle=[],this.viewer.selectionManager.selectBodyByRect(this.MouseDown.x,this.MouseDown.y,this.MouseUp.x,this.MouseUp.y)}this.viewer.renderAllViews()},onRMouseUp:function(e){this.state=-1,this.mouseEvent(e),De.enableDirectRotate&&!this.viewer.isExploded()&&this.onTransformFinish()},pan:function(e,t){this.viewer.cameraControl.pan(this,e,t),this.viewer.viewManager&&this.viewer.viewManager.notifyCameraMove({eventType:"cameraPan"}),this.viewer.logOperatorTime&&this.viewer.logOperatorTimeShow("[平移]",this.OpBeginTime)},moveForwardBack:function(e,t){this.viewer.cameraControl.moveForwardBack(this,e,t)},zoom:function(e,t,r){this.viewer.cameraControl.zoom(this,e,t,r),this.viewer.viewManager&&this.viewer.viewManager.notifyCameraMove({eventType:"cameraZoom"}),this.viewer.logOperatorTime&&this.viewer.logOperatorTimeShow("[缩放]",this.OpBeginTime)},calFarthestDistToCamera:function(){return this.viewer.cameraControl.calFarthestDistToCamera()},zoomByMouse:function(e,t,r){this.cameraControl.zoomByMouse(this,e,t,r)},rotateByTrackBall:function(e,t){this.viewer.cameraControl.rotateByTrackBall(this,e,t)},rotateByHall:function(e,t){this.viewer.cameraControl.rotateByHall(this,t)},rotateByBim:function(e,t){this.viewer.cameraControl.rotateByBim(this,t)},rotateByFirstPerson:function(e){this.viewer.cameraControl.rotateByFirstPerson(this,e)},rotate:function(e,t){var r;this.viewer.isRotationEnable()&&("hall"==(r=this.viewer.getModelOperationMode())?this.rotateByHall(e,t):"bim"==r?this.rotateByBim(e,t):"FirstPerson"==r?this.rotateByFirstPerson(e):this.rotateByTrackBall(e,t),"FirstPerson"==r||Ce.MOUSE.LEFT!==this.state&&Ce.TOUCH.TOUCH_SINGLE!==this.state||this.showRotateCenterHelper()),this.viewer.logOperatorTime&&this.viewer.logOperatorTimeShow("[旋转]",this.OpBeginTime)},createEventListener:function(){var e=this.viewer.canvas2D;e?Pe.isMobileDevice()?(e.addEventListener("touchstart",this.touchstart,!1),e.addEventListener("touchend",this.touchend,!1),e.addEventListener("touchmove",this.touchmove,!1),e.addEventListener("touchcancel",this.touchmove,!1)):(e.addEventListener("mousedown",this.onMouseDown,!1),e.addEventListener("mousemove",this.onMouseMove,!1),e.addEventListener("mousewheel",this.onMouseWheel,!1),this.viewer.limitEventArea&&e.addEventListener("mouseout",this.onMouseOut,!1),e.addEventListener("DOMMouseScroll",this.onMouseWheel,!1),e.addEventListener("click",this.onClick,!1),e.addEventListener("touchstart",this.touchstart,!1),e.addEventListener("touchend",this.touchend,!1),e.addEventListener("touchmove",this.touchmove,!1),e.addEventListener("touchcancel",this.touchmove,!1),window.addEventListener("keydown",this.onKeyDown,!1),window.addEventListener("keyup",this.onKeyUp,!1)):(e=null!=(e=this.viewer.renderer.domElement)?e:document,Pe.isMobileDevice()?(e.addEventListener("touchstart",this.touchstart,!1),e.addEventListener("touchend",this.touchend,!1),e.addEventListener("touchmove",this.touchmove,!1),e.addEventListener("touchcancel",this.touchmove,!1)):(e.addEventListener("mousedown",this.onMouseDown,!1),e.addEventListener("mousemove",this.onMouseMove,!1),e.addEventListener("mousewheel",this.onMouseWheel,!1),this.viewer.limitEventArea&&e.addEventListener("mouseout",this.onMouseOut,!1),e.addEventListener("DOMMouseScroll",this.onMouseWheel,!1),e.addEventListener("click",this.onClick,!1),e.addEventListener("touchstart",this.touchstart,!1),e.addEventListener("touchend",this.touchend,!1),e.addEventListener("touchmove",this.touchmove,!1),e.addEventListener("touchcancel",this.touchmove,!1),window.addEventListener("keydown",this.onKeyDown,!1),window.addEventListener("keyup",this.onKeyUp,!1)))},releaseEventListener:function(){var e=this.viewer.canvas2D;e?Pe.isMobileDevice()?(e.removeEventListener("touchstart",this.touchstart,!1),e.removeEventListener("touchend",this.touchend,!1),e.removeEventListener("touchmove",this.touchmove,!1),e.removeEventListener("touchcancel",this.touchmove,!1)):(e.removeEventListener("mousedown",this.onMouseDown,!1),e.removeEventListener("mousemove",this.onMouseMove,!1),e.removeEventListener("mousewheel",this.onMouseWheel,!1),this.viewer.limitEventArea&&e.removeEventListener("mouseout",this.onMouseOut,!1),e.removeEventListener("DOMMouseScroll",this.onMouseWheel,!1),e.removeEventListener("click",this.onClick,!1),e.removeEventListener("touchstart",this.touchstart,!1),e.removeEventListener("touchend",this.touchend,!1),e.removeEventListener("touchmove",this.touchmove,!1),e.removeEventListener("touchcancel",this.touchmove,!1),window.removeEventListener("keydown",this.onKeyDown,!1),window.removeEventListener("keyup",this.onKeyUp,!1)):(e=null!=(e=this.viewer.renderer.domElement)?e:document,Pe.isMobileDevice()?(e.removeEventListener("touchstart",this.touchstart,!1),e.removeEventListener("touchend",this.touchend,!1),e.removeEventListener("touchmove",this.touchmove,!1),e.removeEventListener("touchcancel",this.touchmove,!1)):(e.removeEventListener("mousedown",this.onMouseDown,!1),e.removeEventListener("mousemove",this.onMouseMove,!1),e.removeEventListener("mousewheel",this.onMouseWheel,!1),this.viewer.limitEventArea&&e.removeEventListener("mouseout",this.onMouseOut,!1),e.removeEventListener("DOMMouseScroll",this.onMouseWheel,!1),e.removeEventListener("click",this.onClick,!1),e.removeEventListener("touchstart",this.touchstart,!1),e.removeEventListener("touchend",this.touchend,!1),e.removeEventListener("touchmove",this.touchmove,!1),e.removeEventListener("touchcancel",this.touchmove,!1),window.removeEventListener("keydown",this.onKeyDown,!1),window.removeEventListener("keyup",this.onKeyUp,!1)))},create:function(){this.createEventListener()},init:function(){},release:function(){this.viewer.selectionManager.setSelectType(this.oldSelectType),this.releaseEventListener()},clearFlag:function(){},resetEventListener:function(){this.releaseEventListener(),this.createEventListener()},getMouseOnCircle:function(e,t){var r=this.viewer.renderer.domElement,i=new THREE.Vector2,n=this.viewer.renderer.getPixelRatio();return i.set((e*n-.5*r.width)/(.5*r.width),(r.height-2*t*n)/r.height),i},ignoreModelSelection:function(e){this.needIgnoreModelSelection=e},selectByClick:function(e,t,r){this.needIgnoreModelSelection||(this.viewer.selectionManager.selectByClick(e,t,r),r=this.viewer.selectionManager.getSelectedObjects(),-1<this.viewer.showHiddenMode&&0<r.length&&(this.viewer.selectionManager.setTempSelectedObjects(r),this.viewer.selectionManager.clearSelection(!1),De.enableBroadcast)&&De.broadcastMajor&&this.type===this.viewer.controls.getOperator().type&&He.updateBroadcastInfo("ModelState"),0==r.length&&this.viewer.dispatchEvent({type:"pickOnEmptyArea",clickPosX:e,clickPosY:t}),this.render(!1,!1),this.viewer.logOperatorTime&&this.viewer.logOperatorTimeShow("[选择（单击）]",this.OpBeginTime))},selectAndZoom:function(e,t,r){var i,n;void 0===r&&(r=!0),this.needIgnoreModelSelection||(this.viewer.selectionManager.clearSelection(),this.viewer.selectionManager.selectByClick(e,t),e=null,1===(t=this.viewer.selectionManager.getSelectedObjects()).length?e=t[0]:(i=this.viewer.getPMISelectList())&&1===i.length&&(e=i[0]),e?(this.viewer.viewManager&&this.viewer.viewManager.getActiveView().is2DView&&this.viewer.opViewportConnect(!1),this.viewer.zoomToObject(e,r),De.dynamicRotateCenter&&1===t.length&&(i=new THREE.Vector3,e=new THREE.Vector3,this.viewer.computeBoundingBox(t[0],i,e,{flag:!0}),(n=new THREE.Vector3).x=.5*(e.x+i.x),n.y=.5*(e.y+i.y),n.z=.5*(e.z+i.z),this.viewer.cameraControl.setRotateCenter(n)),1===t.length&&(this.viewer.logOperatorTime&&this.viewer.logOperatorTimeShow("[自动缩放(模型)]",this.OpBeginTime),this.viewer.cameraControl.isViewLockedBySingleBody=!0)):(this.viewer.is2DModel?((e=this.viewer.getExtension("NDSCamera2DExtension"))&&e.fixedViewInfo?this.viewer.startSmoothTranslation(e.fixedViewInfo,function(){}):this.viewer.zoomExtents(r,!0),this.viewer.dispatchEvent({type:"resetCameraEvent",doubleClick:!0})):this.viewer.zoomExtents(r),n=this.viewer.controls.getBoundingBox().getCenter(),this.viewer.cameraControl.setRotateCenter(n),this.viewer.logOperatorTime&&this.viewer.logOperatorTimeShow("[自动缩放(鼠标点击位置)]",this.OpBeginTime),this.viewer.cameraControl.isViewLockedBySingleBody=!1))}},Object.assign(a.prototype,THREE.EventDispatcher.prototype),function(e){a.call(this,e),this.type="OpOrbit"}),pi=(ui.prototype=Object.create(a.prototype),ui.prototype.onOpOrbit=function(){var e=new THREE.Vector2,t=new THREE.Vector2,r=(e.copy(this.getMouseOnCircle(this.pointerOld.x,this.pointerOld.y)),t.copy(this.getMouseOnCircle(this.pointer.x,this.pointer.y)),t.x-e.x),t=t.y-e.y;this.rotate(new THREE.Vector3(r,t,0))},ui.prototype.onLMouseMove=function(e){this.onOpOrbit()},ui.prototype.onTouchSingleMove=function(e){this.onOpOrbit()},function(e){a.call(this,e),this.type="OpPan"}),fi=(pi.prototype=Object.create(a.prototype),pi.prototype.onOpPan=function(){var e=this.pointer.x-this.pointerOld.x,t=this.pointer.y-this.pointerOld.y;this.pan(new THREE.Vector3(-e,t,0))},pi.prototype.onLMouseMove=function(e){this.onOpPan()},pi.prototype.onTouchSingleMove=function(e){this.onOpPan()},function(e){a.call(this,e),this.type="OpZoom"}),mi=(fi.prototype=Object.create(a.prototype),fi.prototype.onOpZoom=function(){var e=this.pointer.y-this.pointerOld.y;this.zoom(new THREE.Vector3(0,0,5*e))},fi.prototype.onLMouseMove=function(e){this.onOpZoom()},fi.prototype.onTouchSingleMove=function(e){this.onOpZoom()},function(e){a.call(this,e),this.type="OpZoomWindow",this.clearCanvas2D=function(){var e=this.viewer.renderer.getPixelRatio();this.viewer.canvas2D.getContext("2d").clearRect(0,0,window.innerWidth*e,window.innerHeight*e),this.viewer.Rectangle=[]},this.zoomToRect=function(e,t,r,i){var n,a=this.viewer.container.getBoundingClientRect(),o=Math.abs(r-e),s=Math.abs(i-t);0!=o&&0!=s&&(e=[.5*(e+r),.5*(t+i)],r=new THREE.Vector3,null!=(t=this.viewer.getIntersectionPtByScreenPt(e,!1))?r.set(t.coords[0],t.coords[1],t.coords[2]):(i=this.viewer.clientCoordToModelCoord(e),r.set(i[0],i[1],i[2])),t=this.viewer.camera.position,i=(e=this.viewer.camera.target.clone().sub(t)).length(),e.normalize(),o=i/(i=Math.min(a.width/o,a.height/s)),this.viewer.is2DModel?(a=(r.z-t.z)/e.z,s=t.clone().addScaledVector(e,a),a=(t=this.viewer.camera.position.clone().sub(s)).length(),t.normalize(),n=(s=this.viewer.camera.target.clone().sub(s)).length(),s.normalize(),(t=t.clone()).multiplyScalar(a/i),t.add(r),(a=s.clone()).multiplyScalar(n/i),a.add(r),this.viewer.camera.position.set(t.x,t.y,t.z),this.viewer.camera.setCameraTarget(a)):(e.multiplyScalar(-o),e.add(r),this.viewer.camera.position.set(e.x,e.y,e.z),this.viewer.camera.setCameraTarget(r)),this.viewer.camera.updateProjectionMatrix(),this.viewer.render())},this.drawRectangle=function(e,t,r,i){this.clearCanvas2D();var n=this.viewer.canvas2D.getContext("2d");n.strokeStyle="#00FFFF",n.setLineDash([5,5]),n.beginPath(),n.moveTo(e,t),n.lineTo(r,t),n.lineTo(r,i),n.lineTo(e,i),n.lineTo(e,t),n.closePath(),n.stroke(),n.setLineDash([]),this.viewer.Rectangle.push(e),this.viewer.Rectangle.push(r),this.viewer.Rectangle.push(t),this.viewer.Rectangle.push(i)}}),gi=(mi.prototype=Object.create(a.prototype),mi.prototype.release=function(){this.clearCanvas2D(),a.prototype.release.call(this)},mi.prototype.onLMouseDown=function(e){e.preventDefault(),a.prototype.onLMouseDown.call(this,e)},mi.prototype.onLMouseUp=function(e){var t=Date.now();e.preventDefault(),a.prototype.onLMouseUp.call(this,e),this.clearCanvas2D(),this.zoomToRect(this.lMouseDown.x,this.lMouseDown.y,this.lMouseUp.x,this.lMouseUp.y),this.viewer.logOperatorTime&&this.viewer.logOperatorTimeShow("[框选-放大]",t)},mi.prototype.onTouchSingleStart=function(e){e.preventDefault(),a.prototype.onTouchSingleStart.call(this,e)},mi.prototype.onTouchSingleMove=function(e){e.preventDefault();e=this.viewer.renderer.getPixelRatio();this.drawRectangle(this.singleTouchStartPos.x*e,this.singleTouchStartPos.y*e,this.pointer.x*e,this.pointer.y*e)},mi.prototype.onTouchSingleEnd=function(e){var t=Date.now();e.preventDefault(),a.prototype.onTouchSingleEnd.call(this,e),this.clearCanvas2D(),this.zoomToRect(this.singleTouchStartPos.x,this.singleTouchStartPos.y,this.singleTouchEndPos.x,this.singleTouchEndPos.y),this.viewer.logOperatorTime&&this.viewer.logOperatorTimeShow("[框选-放大]",t)},r(13),THREE.Polytope=function(e){function i(e){for(var t=f.planes,r=e,i=[],n=0,a=t.length;n<a;n++){var i=[],o=t[n],s=r[0],l=o.distanceToPoint(s);Math.abs(l)<1e-6&&(l=0);for(var d=1,c=r.length;d<c;++d){var h,u=r[d],p=o.distanceToPoint(u);Math.abs(p)<1e-6&&(p=0),0<=l&&i.push(s),l*p<0&&(h=l/(l-p),h=s.clone().multiplyScalar(1-h).add(u.clone().multiplyScalar(h)),i.push(h)),l=p,s=u}if(0<=l&&i.push(s),i.length<=1)return!1;r=i}return!0}var f=this;this.planes=e||[];this.intersectsLineSegment=function(e,t){return i([e,t])},this.intersectsTriangle=function(e,t,r){return i([e,t,r,e])}},Object.assign(THREE.Polytope.prototype,{add:function(e){return this.planes.push(e.clone()),this},clone:function(){return(new this.constructor).copy(this)},copy:function(e){for(var t=0,r=e.planes.length;t<r;t++)this.planes[t]=e.planes[t].clone();return this},setFromMatrix:function(e){var t=this.planes,e=e.elements,r=e[0],i=e[1],n=e[2],a=e[3],o=e[4],s=e[5],l=e[6],d=e[7],c=e[8],h=e[9],u=e[10],p=e[11],f=e[12],m=e[13],g=e[14],e=e[15];return t[0].setComponents(a-r,d-o,p-c,e-f).normalize(),t[1].setComponents(a+r,d+o,p+c,e+f).normalize(),t[2].setComponents(a+i,d+s,p+h,e+m).normalize(),t[3].setComponents(a-i,d-s,p-h,e-m).normalize(),t[4].setComponents(a-n,d-l,p-u,e-g).normalize(),t[5].setComponents(a+n,d+l,p+u,e+g).normalize(),this},intersectsObject:(ti=new THREE.Sphere,function(e){var t=e.geometry;return null===t.boundingSphere&&t.computeBoundingSphere(),ti.copy(t.boundingSphere).applyMatrix4(e.matrixWorld),this.intersectsSphere(ti)}),intersectsPMIObject:(ei=new THREE.Box3,function(e){var a=this,o=[];return e.traverse(function(e){var t,r=e.geometry;if(r)if(null===r.boundingBox&&r.computeBoundingBox(),r.charGeoBoxes&&Array.isArray(r.charGeoBoxes))for(var i=0;i<r.charGeoBoxes.length;i++){var n=r.charGeoBoxes[i];if(ei.copy(n).applyMatrix4(e.matrixWorld),a.intersectsBox(ei)){o.push(e);break}}else ei.copy(r.boundingBox).applyMatrix4(e.matrixWorld),a.intersectsBox(ei)&&(t=!0,t="Line2"!=e.type&&"LineSegments2"!=e.type?t:a.intersectLineSegments2(e))&&o.push(e)}),o}),intersectLineSegments2:(Jr=new THREE.Vector3,$r=new THREE.Vector3,function(e){var t=e.geometry,r=e.matrixWorld;if(t.attributes.instanceStart)for(var i=t.attributes.instanceStart.data.array,n=0,a=i.length/3-1;n<a;n+=2)if(Jr.fromArray(i,3*n).applyMatrix4(r),$r.fromArray(i,3*n+3).applyMatrix4(r),this.intersectsLineSegment(Jr,$r))return!0;return!1}),intersectsSprite:(Zr=new THREE.Sphere,function(e){return Zr.center.set(0,0,0),Zr.radius=.7071067811865476,Zr.applyMatrix4(e.matrixWorld),this.intersectsSphere(Zr)}),intersectsSphere:function(e){for(var t=this.planes,r=e.center,i=-e.radius,n=0,a=this.planes.length;n<a;n++)if(t[n].distanceToPoint(r)<i)return!1;return!0},intersectsBox:(Kr=new THREE.Vector3,function(e){for(var t=this.planes,r=0,i=this.planes.length;r<i;r++){var n=t[r];if(Kr.x=(0<n.normal.x?e.max:e.min).x,Kr.y=(0<n.normal.y?e.max:e.min).y,Kr.z=(0<n.normal.z?e.max:e.min).z,n.distanceToPoint(Kr)<0)return!1}return!0}),intersectsBoxDetailed:(Yr=new THREE.Vector3,Qr=new THREE.Vector3,function(e){for(var t=this.planes,r=!1,i=0,n=this.planes.length;i<n;i++){var a=t[i];if(Yr.x=(0<a.normal.x?e.max:e.min).x,Yr.y=(0<a.normal.y?e.max:e.min).y,Yr.z=(0<a.normal.z?e.max:e.min).z,Qr.x=(0<a.normal.x?e.min:e.max).x,Qr.y=(0<a.normal.y?e.min:e.max).y,Qr.z=(0<a.normal.z?e.min:e.max).z,a.distanceToPoint(Yr)<0)return 1;a.distanceToPoint(Qr)<0&&(r=!0)}return r?2:0}),containsPoint:function(e){for(var t=this.planes,r=0,i=t.length;r<i;r++)if(t[r].distanceToPoint(e)<0)return!1;return!0},applyMatrix4:function(e){for(var t=this.planes,r=0,i=t.length;r<i;r++)t[r].applyMatrix4(e);return this},transformProvidingInverse:function(e){for(var t=this.planes,r=0,i=t.length;r<i;r++)t[r].transformProvidingInverse(e);return this},setToUnitFrustum:function(e,t){void 0===e&&(e=!0),void 0===t&&(t=!0),this.planes=[],this.planes.push(new THREE.Plane(new THREE.Vector3(1,0,0),1)),this.planes.push(new THREE.Plane(new THREE.Vector3(-1,0,0),1)),this.planes.push(new THREE.Plane(new THREE.Vector3(0,1,0),1)),this.planes.push(new THREE.Plane(new THREE.Vector3(0,-1,0),1)),e&&this.planes.push(new THREE.Plane(new THREE.Vector3(0,0,1),1)),t&&this.planes.push(new THREE.Plane(new THREE.Vector3(0,0,-1),1))},setToBoundingBox:function(e){this.planes=[],this.planes.push(new THREE.Plane(new THREE.Vector3(1,0,0),-e.min.x)),this.planes.push(new THREE.Plane(new THREE.Vector3(-1,0,0),e.max.x)),this.planes.push(new THREE.Plane(new THREE.Vector3(0,1,0),-e.min.y)),this.planes.push(new THREE.Plane(new THREE.Vector3(0,-1,0),e.max.y)),this.planes.push(new THREE.Plane(new THREE.Vector3(0,0,1),-e.min.z)),this.planes.push(new THREE.Plane(new THREE.Vector3(0,0,-1),e.max.z))}}),THREE.Line.prototype.raycast=(ri=new THREE.Matrix4,ii=new THREE.Ray,new THREE.Sphere,ni=new THREE.Box3,function(e,t){var r=e.linePrecision,i=r*r,n=this.geometry,a=this.matrixWorld;if(null===n.boundingBox&&n.computeBoundingBox(),ni.copy(n.boundingBox),ni.applyMatrix4(a),ni.max.x+=r,ni.max.y+=r,ni.max.z+=r,ni.min.x-=r,ni.min.y-=r,ni.min.z-=r,!1!==e.ray.intersectsBox(ni)&&n.attributes.position){ri.getInverse(a),ii.copy(e.ray).applyMatrix4(ri);var o=new THREE.Vector3,s=new THREE.Vector3,l=new THREE.Vector3,d=new THREE.Vector3,c=this&&this.isLineSegments?2:1;if(n.isBufferGeometry){var r=n.index,h=n.attributes.position.array;if(null!==r)for(var u=r.array,p=0,f=u.length-1;p<f;p+=c){var m=u[p],g=u[p+1];o.fromArray(h,3*m),s.fromArray(h,3*g),i<ii.distanceSqToSegment(o,s,d,l)||(d.applyMatrix4(this.matrixWorld),(v=e.ray.origin.distanceTo(d))<e.near)||v>e.far||t.push({distance:v,point:l.clone().applyMatrix4(this.matrixWorld),index:p,face:null,faceIndex:null,object:this})}else for(p=0,f=h.length/3-1;p<f;p+=c)o.fromArray(h,3*p),s.fromArray(h,3*p+3),i<ii.distanceSqToSegment(o,s,d,l)||(d.applyMatrix4(this.matrixWorld),(v=e.ray.origin.distanceTo(d))<e.near)||v>e.far||t.push({distance:v,point:l.clone().applyMatrix4(this.matrixWorld),index:p,face:null,faceIndex:null,object:this})}else if(n.isGeometry)for(var v,y=n.vertices,A=y.length,p=0;p<A-1;p+=c)i<ii.distanceSqToSegment(y[p],y[p+1],d,l)||(d.applyMatrix4(this.matrixWorld),(v=e.ray.origin.distanceTo(d))<e.near)||v>e.far||t.push({distance:v,point:l.clone().applyMatrix4(this.matrixWorld),index:p,face:null,faceIndex:null,object:this})}}),THREE.Box3.prototype.intersectsPlane=function(e){return oi=0<e.normal.x?(ai=e.normal.x*this.min.x,e.normal.x*this.max.x):(ai=e.normal.x*this.max.x,e.normal.x*this.min.x),0<e.normal.y?(ai+=e.normal.y*this.min.y,oi+=e.normal.y*this.max.y):(ai+=e.normal.y*this.max.y,oi+=e.normal.y*this.min.y),0<e.normal.z?(ai+=e.normal.z*this.min.z,oi+=e.normal.z*this.max.z):(ai+=e.normal.z*this.max.z,oi+=e.normal.z*this.min.z),ai<=-e.constant&&oi>=-e.constant},Ke.prototype.raycast=(si=new THREE.Matrix4,li=new THREE.Ray,new THREE.Sphere,di=new THREE.Box3,function(e,t){if(0!=this.visible){var r=e.linePrecision,i=r*r,n=this.geometry,a=this.matrixWorld;if(null===n.boundingBox&&n.computeBoundingBox(),di.copy(n.boundingBox),di.applyMatrix4(a),di.max.x+=r,di.max.y+=r,di.max.z+=r,di.min.x-=r,di.min.y-=r,di.min.z-=r,!1!==e.ray.intersectsBox(di)&&n.attributes.position){si.getInverse(a),li.copy(e.ray).applyMatrix4(si);var o=new THREE.Vector3,s=new THREE.Vector3,l=new THREE.Vector3,d=new THREE.Vector3;if(n.isBufferGeometry&&n.attributes&&n.attributes.instanceStart)for(var c,h=n.attributes.instanceStart.data.array,u=0,p=h.length/3-1;u<p;u+=2)o.fromArray(h,3*u),s.fromArray(h,3*u+3),i<li.distanceSqToSegment(o,s,d,l)||(d.applyMatrix4(this.matrixWorld),(c=e.ray.origin.distanceTo(d))<e.near)||c>e.far||t.push({distance:c,point:l.clone().applyMatrix4(this.matrixWorld),index:0,face:null,faceIndex:null,object:this})}}}),Ce.INTERSECTSTATE={INTERSECTED:0,CONTAINED:1,NOTINTERSECTED:2},(Le.prototype=Object.create(a.prototype)).initPixelInfo=function(){for(var e=0;e<this.segment*this.segment;e++)this.pixelInfo[e]={totalPixel:0,InLlasso:0}},Le.prototype.updateSelection=function(){for(this.toScreenSpaceMatrix.identity().premultiply(this.viewer.camera.matrixWorldInverse).premultiply(this.viewer.camera.projectionMatrix);this.lassoSegments.length<this.selectionPoints.length/3;)this.lassoSegments.push(new THREE.Line3);this.lassoSegments.length=this.selectionPoints.length/3;for(var e=0,t=this.selectionPoints.length,r=0;e<t;e+=3,r++){var i=this.lassoSegments[r],n=(e+3)%t;i.start.x=this.selectionPoints[e],i.start.y=this.selectionPoints[e+1],i.end.x=this.selectionPoints[n],i.end.y=this.selectionPoints[1+n]}},Le.prototype.pointRayCrossesLine=function(e,t,r,i){var n=t.start,t=t.end,a=e.x,e=e.y,o=n.y,s=t.y;return o!==s&&!(o<e&&s<e||e<o&&e<s||(n=n.x,t=t.x,n<a&&t<a)||(a<n&&a<t?e===o&&r!==i:(r=s-o,Math.sign(r*(a-n)+-(t-n)*(e-o))===Math.sign(r))))},Le.prototype.pointRayCrossesSegments=function(e,t){for(var r=0,i=t[t.length-1],n=i.start.y>i.end.y,a=0,o=t.length;a<o;a++){var s=t[a],l=s.start.y>s.end.y;this.pointRayCrossesLine(e,s,n,l)&&r++,n=l}return r},Le.prototype.lineCrossesLine=function(e,t){function r(e,t,r){return(r.y-e.y)*(t.x-e.x)>(t.y-e.y)*(r.x-e.x)}var i=e.start,e=e.end,n=t.start,t=t.end;return r(i,n,t)!==r(e,n,t)&&r(i,e,n)!==r(i,e,t)},Le.prototype.intersectsBounds=function(e,t){for(var r=new Array(8).fill().map(function(){return new THREE.Vector3}),i=0,n=1/0,a=-1/0,o=1/0,s=0;s<=1;s++)for(var l=0;l<=1;l++)for(var d=0;d<=1;d++){var c=r[i],h=(c.x=(0===s?e:t).x,c.y=(0===l?e:t).y,c.z=(0===d?e:t).z,c.w=1,[]),h=(h[0]=c.x,h[1]=c.y,h[2]=c.z,this.viewer.modelCoordToClientCoord(h));c.x=h[0]/window.innerWidth*2-1,c.y=1-h[1]/window.innerHeight*2,c.z=0,i++,c.y<n&&(n=c.y),c.y>a&&(a=c.y),c.x<o&&(o=c.x)}for(var u=this.lassoSegments,p=[],f=0,m=u.length;f<m;f++){var g=u[f],v=g.start.x,y=g.start.y,A=g.end.x,M=g.end.y;v<o&&A<o||a<y&&a<M||y<n&&M<n||p.push(g)}if(0===p.length)return Ce.INTERSECTSTATE.NOTINTERSECTED;for(var E=0,w=0,x=r.length;w<x;w++){var b=r[w];this.pointRayCrossesSegments(b,p)%2==1&&E++}return E==r.length?Ce.INTERSECTSTATE.CONTAINED:0==E?Ce.INTERSECTSTATE.NOTINTERSECTED:Ce.INTERSECTSTATE.INTERSECTED},Le.prototype.renderModel=function(){var e;this.scene&&(this.selectionShapeNeedsUpdate&&(e=this.selectionPoints.length,this.selectionPoints.push(this.selectionPoints[0],this.selectionPoints[1],this.selectionPoints[2]),this.selectionPoints.length=e,this.selectionShapeNeedsUpdate=!1),this.drawLasso(),this.selectionNeedsUpdate)&&(this.selectionNeedsUpdate=!1,0<this.selectionPoints.length)&&this.updateSelection()},Le.prototype.onLMouseMove=function(e){var t,r=e.clientX,i=e.clientY,n=new THREE.Vector2,a=new THREE.Vector2,o=new THREE.Vector2,s=[-1,-1],l=-1===(s=this.viewer.viewManager?this.viewer.viewManager.normalizeViewCoordinateToViewPort(e.clientX,e.clientY,{left:0,top:0,width:window.innerWidth,height:window.innerHeight}):s)[0]?e.clientX/window.innerWidth*2-1:s[0],e=-1===s[1]?2*-(e.clientY/window.innerHeight)+1:-s[1];Math.abs(r-this.prevX)<3&&Math.abs(i-this.prevY)<3||(s=3*(this.selectionPoints.length/3-1),t=!1,3<this.selectionPoints.length&&(n.set(this.selectionPoints[s-3],this.selectionPoints[s-3+1]),a.set(this.selectionPoints[s],this.selectionPoints[1+s]),a.sub(n).normalize(),n.set(this.selectionPoints[s],this.selectionPoints[1+s]),o.set(l,e),o.sub(n).normalize(),t=.99<a.dot(o)),t?(this.selectionPoints[s]=l,this.selectionPoints[1+s]=e):this.selectionPoints.push(l,e,0),this.selectionShapeNeedsUpdate=!0,this.prevX=r,this.prevY=i,this.selectionNeedsUpdate=!0)},Le.prototype.selectIntersectBody=function(){for(var b=new Array(300),e=0;e<b.length;e++)b[e]=new THREE.Vector2(10,10);return function(e,t){if(!(e.length<1)){this.pickingMaterial.uniforms.width.value=this.TargetWidth/this.segment,this.pickingMaterial.uniforms.height.value=this.TargetHeight/this.segment;for(var r=0,i=0,n=this.selectionPoints.length;i<n;i+=3,r++)b[r].set(this.selectionPoints[i],this.selectionPoints[i+1]);b[r].set(this.selectionPoints[0],this.selectionPoints[1]),r++;for(var a=b.length;r<a;r++)b[r].set(10,10);this.pickingMaterial.uniforms.lassoSegments.value=b,this.pickingMaterial.uniforms.lassolength.value=this.selectionPoints.length/3+1,this.pickingMaterial.needsUpdate=!0;for(var o=new THREE.Vector4,s=this.viewer.renderer.sortObjects,l=(this.viewer.renderer.getViewport(o),this.viewer.renderer.sortObjects=!1,[]),d=new Uint8Array(this.TargetWidth*this.TargetHeight*4);0<e.length;){e=e.length<this.segment*this.segment+1?(l=e.slice(0),[]):(l=e.slice(0,this.segment*this.segment),e.slice(this.segment*this.segment)),this.initPixelInfo(),this.viewer.renderer.clearTarget(this.pickingTexture,!0,!0,!0);for(var c=0,h=l.length;c<h;c++){var u=l[c].leafBodyAttri.bodyMeshIds,p=l[c].ndsModel;if(u){this.pickingMaterial.uniforms.vbodyId.value=c,this.pickingMaterial.needsUpdate=!0,this.scene.clear();for(var f=0,m=u.length;f<m;++f){var g,v=u[f];-1<p.meshManager.geomId[v]&&(g=p.meshManager.geomManager.getGeomFromId(p.meshManager.geomId[v]),g=new THREE.Mesh(g,this.pickingMaterial),v=p.meshManager.bodyNodes[v].worldMatrix.clone(),g.applyMatrix4(v),g.matrixAutoUpdate=!1,g.matrixWorldNeedsUpdate=!1,g.frustumCulled=!1,this.scene.add(g))}var y=c%this.segment,A=Math.floor(c/this.segment),y=new THREE.Vector4(y*this.TargetWidth/this.segment,A*this.TargetHeight/this.segment,this.TargetWidth/this.segment,this.TargetHeight/this.segment);this.viewer.renderer.clearDepth(),this.pickingTexture.scissorTest=!0,this.pickingTexture.scissor.copy(y),this.pickingTexture.viewport.copy(y),this.viewer.renderer.render(this.scene,this.viewer.camera,this.pickingTexture,!1),this.pickingTexture.scissorTest=!1}}this.viewer.renderer.readRenderTargetPixels(this.pickingTexture,0,0,this.TargetWidth,this.TargetHeight,d);for(var M=0;M<d.length;M+=4){var E=d[M+2];0<E&&(E=Math.round(E/255*this.segment*this.segment)-1,0<d[M]?this.pixelInfo[E].totalPixel++:0<d[M+1]&&(this.pixelInfo[E].totalPixel++,this.pixelInfo[E].InLlasso++))}for(var w=0;w<this.pixelInfo.length;w++){var x=this.pixelInfo[w];0<x.totalPixel&&.5<x.InLlasso/x.totalPixel&&(De.HideLeafBody?t.push(l[w].parent):t.push(l[w]))}}this.viewer.renderer.setViewport(o),this.viewer.renderer.setScissor(o),this.viewer.renderer.setScissorTest(!1),this.viewer.renderer.sortObjects=s,De.enableBroadcast&&De.broadcastMajor&&He.updateBroadcastInfo("ModelState"),this.scene.clear()}}}(),Le.prototype.drawLasso=function(){if(0!=this.selectionPoints.length){for(var e=this.viewer.canvas2D.getContext("2d"),t=(e.strokeStyle="#3C92DE",e.beginPath(),e.lineWidth=2,this.viewer.renderer.getPixelRatio()),r=0;r<this.selectionPoints.length;r+=3){var i=(this.selectionPoints[r]+1)/2*window.innerWidth,n=(1-this.selectionPoints[r+1])/2*window.innerHeight,i=this.remapCoordnidateToViewPort(i,n),n=i[0]*t,i=i[1]*t;0==r?e.moveTo(n,i):e.lineTo(n,i)}e.closePath(),e.stroke(),e.lineWidth=1}},Le.prototype.selectBody=function(){for(var t=this,e=[],r=[],i=(this.viewer.ndsModel.setActiveModel(0),[]),n=0;n<this.viewer.ndsModel.models.length;n++){var a=this.viewer.ndsModel.models[n];a.isSketchModel||(i=a.wholeLeafBodyNodes.concat(i))}for(var o=0,s=i.length;o<s;++o){var l=i[o],d=l.ndsModel;if(!(!l.leafBodyAttri||l.leafBodyAttri.bodyMeshIds.length<1||l.isHidden())){for(var c=new THREE.Box3,h=null,u=0,p=l.leafBodyAttri.bodyMeshIds.length;u<p;++u){var f=l.leafBodyAttri.bodyMeshIds[u];d.meshManager.getMeshBBox(f,c),0==u?h=c.clone():h.union(c)}var m=this.intersectsBounds(h.min,h.max);m==Ce.INTERSECTSTATE.INTERSECTED?r.push(l):m==Ce.INTERSECTSTATE.CONTAINED&&(De.HideLeafBody?e.push(l.parent):e.push(l))}}if(0<r.length&&this.selectIntersectBody(r,e),0<e.length){this.viewer.outlinePass&&this.viewer.outlinePass.enabled||(De.selectedMaterial.colorWrite=!0,De.inBIMContext?this.viewer.ndsModel.meshManager.setSelectedMaterial(De.selectedMaterial,De.selectedLineMaterial):this.viewer.ndsModel.models.forEach(function(e){e.meshManager.setSelectedMaterial(t.viewer.is2DModel?De.selectedFace2DMaterial:De.selectedMaterial,De.selectedLineMaterial)}));for(var g=0;g<e.length;g++){var v=e[g];null!=v&&(this.viewer.ndsModel.addSelection(v),this.viewer.selectionManager.selectedObjects.push(v))}this.viewer.selectionManager.selectObjectList([])}this.viewer.render()},Le.prototype.onLMouseUp=function(e){var t=Date.now();this.viewer.selectionManager.clearSelection(),this.selectBody(),this.selectionPoints.length&&(this.selectionNeedsUpdate=!0,this.selectionPoints.length=0,this.lassoSegments.length=0),a.prototype.onLMouseUp.call(this,e),this.viewer.renderAllViews(),this.viewer.logOperatorTime&&this.viewer.logOperatorTimeShow("[套索-高亮]",t)},Le.prototype.onLMouseDown=function(e){e.preventDefault(),a.prototype.onLMouseDown.call(this,e),this.viewer.renderNew()},Le.prototype.onMMouseUp=function(e){},Le.prototype.onMMouseMove=function(e){},Le.prototype.release=function(){a.prototype.release.call(this),this.pickingTexture.dispose()},function(e){a.call(this,e),this.type="OpSelectWindow",this.viewer.selectionManager.lasso=new Le(this.viewer),this.clearCanvas2D=function(){this.viewer.Rectangle=[]},this.selectRect=function(e,t,r,i){this.viewer.selectionManager.selectBodyByRect(e,t,r,i),this.render(!1,!1)},this.viewer.selectionManager.clearSelection(),this.viewer.pmiObject&&this.viewer.deselectPMIObject(this.viewer.pmiObject),this.viewer.render()});gi.prototype=Object.create(a.prototype),gi.prototype.release=function(){this.clearCanvas2D(),this.viewer.selectionManager.lasso&&(this.viewer.selectionManager.lasso.release(),this.viewer.selectionManager.lasso=null),a.prototype.release.call(this)},gi.prototype.onLMouseDown=function(e){e.preventDefault(),this.viewer.render(),a.prototype.onLMouseDown.call(this,e)},gi.prototype.onLMouseUp=function(e){var t=Date.now(),e=(e.preventDefault(),a.prototype.onLMouseUp.call(this,e),this.clearCanvas2D(),this.lMouseDown.x),r=this.lMouseDown.x,i=this.lMouseDown.y,n=this.lMouseDown.y;this.lMouseUp.x<e&&(e=this.lMouseUp.x),this.lMouseUp.x>r&&(r=this.lMouseUp.x),this.lMouseUp.y<i&&(i=this.lMouseUp.y),this.lMouseUp.y>n&&(n=this.lMouseUp.y),Math.abs(e-r)<.1||Math.abs(i-n)<.1||(this.selectRect(e,i,r,n),this.viewer.logOperatorTime&&this.viewer.logOperatorTimeShow("[框选-高亮]",t))},gi.prototype.onTouchSingleStart=function(e){e.preventDefault(),a.prototype.onTouchSingleStart.call(this,e)},gi.prototype.onTouchSingleMove=function(e){e.preventDefault();e=this.viewer.renderer.getPixelRatio();this.drawRectangle(this.singleTouchStartPos.x*e,this.singleTouchStartPos.y*e,this.pointer.x*e,this.pointer.y*e)},gi.prototype.onTouchSingleEnd=function(e){var t=Date.now(),e=(e.preventDefault(),a.prototype.onTouchSingleEnd.call(this,e),this.clearCanvas2D(),this.singleTouchStartPos.x),r=this.singleTouchStartPos.x,i=this.singleTouchStartPos.y,n=this.singleTouchStartPos.y;this.singleTouchEndPos.x<e&&(e=this.singleTouchEndPos.x),this.singleTouchEndPos.x>r&&(r=this.singleTouchEndPos.x),this.singleTouchEndPos.y<i&&(i=this.singleTouchEndPos.y),this.singleTouchEndPos.y>n&&(n=this.singleTouchEndPos.y),this.selectRect(e,i,r,n),this.viewer.logOperatorTime&&this.viewer.logOperatorTimeShow("[框选-高亮]",t)};function vi(e,t){var r,i="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(i)return(i=i.call(e)).next.bind(i);if(Array.isArray(e)||(i=function(e,t){{var r;if(e)return"string"==typeof e?yi(e,t):"Map"===(r="Object"===(r={}.toString.call(e).slice(8,-1))&&e.constructor?e.constructor.name:r)||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?yi(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length)return i&&(e=i),r=0,function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}};throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function yi(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,i=Array(t);r<t;r++)i[r]=e[r];return i}function Ai(e,t){return(Ai=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}var Mi=function(t){function e(e){var r=t.call(this)||this;return r.ndsModel=e,r.meshManager=e.meshManager,r.clipDataManager=e.viewer.clipDataManager,r.bodyNodes=[],r.assamblyNodes=[],r.instancedMeshGeomes=new Map,r.instancedLineGeomes=new Map,r.partNodes=[],r._loaded_=!1,r.meshId2BodyId=[],r.meshMaterial=[],r._max_mesh_size_=0,r._avg_mesh_size_=0,r._min_mesh_size_=9999999,r.opaqueMeshes=[],r.transparentMeshes=[],r.selectedMeshes=[],r.drawingLines=[],r.selectedDrawingLines=new pr,r.meshSetHasMaterialWithMap=!1,r.meshSetHasCW=!1,r.needsUpdate=!0,r.__phongMatDrawingIndex=0,r.__physicalMatDrawingIndex=1,r.supportMultiDraw=!0,r.renderMode=0,r.__renderModeList=[0,0,0],r.visualStates={dirty:!0,visible:!0,opaqueDrawCount:0,opaqueMeshCount:0,transparentDrawCount:0,transparentMeshCount:0,lineDrawCount:0,lineSegmentCount:0,lineDrawPass:0},r.__visualStatesUpdateCallback=[],r.subscribeVisualStatesCallback=function(e){r.__visualStatesUpdateCallback.push(e)},r.clearVisualStatesCallback=function(){r.__visualStatesUpdateCallback.length=0},r.makeDirty=function(){r.visualStates.dirty=!0,r.visualStates.visible=!0},r.applyCull=function(){r._isCulled_=0!==r.assamblyNodes.length;for(var e=0,t=r.assamblyNodes.length;e<t;++e)if(1<=r.assamblyNodes[e].cullInfo.cullState||-1===r.assamblyNodes[e].cullInfo.cullState){r._isCulled_=!1;break}},r.isCulled=function(){return r._isCulled_},r}r=t,(i=e).prototype=Object.create(r.prototype),Ai(i.prototype.constructor=i,r);var r,i=e.prototype;return i.__updateCachedGeometryArray=function(e,r,t,i){function n(e){var t;"opaque"===r?(a.visualStates.opaqueMeshCount=e,i&&a.instancedMeshGeomes.has(i.geometry)&&((t=a.instancedMeshGeomes.get(i.geometry)).hasOpaqueMtl=!0,i.material.isMeshPhongMaterial?t.hasPhongMtl=!0:t.hasPhysicMtl=!0)):"transparent"===r?(a.visualStates.transparentMeshCount=e,i&&a.instancedMeshGeomes.has(i.geometry)&&((t=a.instancedMeshGeomes.get(i.geometry)).hasTransparentMtl=!0,i.material.isMeshPhongMaterial?t.hasPhongMtl=!0:t.hasPhysicMtl=!0)):"line"===r&&(a.visualStates.lineSegmentCount=e)}var a=this;void 0===i&&(i=void 0);e<0?n(t.length=0):(t[e]=i,n(t.length))},i.isLoaded=function(){var e;return!!(this._loaded_||(0<this.meshes.length?(e=this.meshManager.geomId[this.meshes[0]],(e=this.meshManager.geomManager.getGeomFromId(e))&&e.loaded&&(this._loaded_=!0)):!(0<this.lines.length)||(e=this.meshManager.lineSegGeomId[this.lines[0]],(e=this.meshManager.geomManager.getGeomFromId(e))&&e.loaded&&(this._loaded_=!0))))},i.updateMultiDrawControlParams=function(){for(var e=0;e<this.meshCount;++e){var t=this.meshes[e],t=(!this.meshSetHasMaterialWithMap&&this.ndsModel.meshState.getMeshMaterial(t).hasTexture&&(this.meshSetHasMaterialWithMap=!0),this.meshManager.getMeshInfor(t,null,!1,!1));t.bodyNode.worldMatrix&&t.bodyNode.worldMatrix.determinant()<0&&(this.meshSetHasCW=!0)}},i.init=function(e){this.levelCriticalSizes=e;for(var t=this.meshes,r=(this.meshes=[],this.meshSize=[],this.meshId2BodyId=new Int32Array(this.meshCount),this.geomUUID2MeshIdAttribute=new Map,this.geomUUID2LineIdAttribute=new Map,t.sort(function(e,t){return e.size===t.size?e.geomIndex-t.geomIndex:t.size-e.size}),new Map),i=0;i<this.meshCount;++i){this.meshes[i]=t[i].meshId,this.meshSize[i]=t[i].size,this.meshId2BodyId[i]=t[i].bodyId;var n=this.meshManager.getMeshInfor(this.meshes[i],null,!0,!1);n.geometry&&1<n.geometry.refMeshes.length&&(r.has(n.geometry.uuid)||r.set(n.geometry.uuid,[]),r.get(n.geometry.uuid).push(i),this.instancedMeshGeomes.has(n.geometry)||(this.instancedMeshGeomes.set(n.geometry,{hasPhongMtl:!1,hasPhysicMtl:!1,hasOpaqueMtl:!1,hasTransparentMtl:!1}),n.geometry.refInThisMeshSet=0)),this._max_mesh_size_<t[i].size&&(this._max_mesh_size_=t[i].size),this._min_mesh_size_>t[i].size&&(this._min_mesh_size_=t[i].size),(1===this.meshCount||i<Math.floor(this.meshCount/2))&&(this._avg_mesh_size_+=t[i].size)}for(var a=new Set,o=new Set,s=0,l=this.bodyNodes.length;s<l;++s){var d=this.bodyNodes[s].parent;if(d||"Model"!==this.bodyNodes[s].type){for(o.has(d)||(this.partNodes.push(d),o.add(d)),d.cullInfo.valid&&(this.bodyNodes[s].cullInfo=d.cullInfo);!d.isAssamblyNode&&d.parent;)d=d.parent;!this.bodyNodes[s].cullInfo.valid&&d.cullInfo.valid&&(this.bodyNodes[s].cullInfo=d.cullInfo),a.has(d)||(this.assamblyNodes.push(d),a.add(d))}}for(var c=vi(r);!(h=c()).done;){var h=h.value,u=h[0],h=h[1];1<h.length&&!this.geomUUID2MeshIdAttribute.has(u)&&(h=new Int32Array(h),(h=new THREE.InstancedBufferAttribute(h,1)).needsUpdate=!0,this.geomUUID2MeshIdAttribute.set(u,h))}1<this.meshCount&&(this._avg_mesh_size_/=Math.floor(this.meshCount/2));var p=this.lines;this.lines=[],this.lineId2BodyId=new Int32Array(this.lineCount),r.clear();for(var f=0;f<this.lineCount;++f){this.lines[f]=p[f].lineId,this.lineId2BodyId[f]=p[f].bodyId;var m=this.meshManager.getLineSegmentsInfor(this.lines[f],null,!1,!1);m.geometry&&1<m.geometry.refLineSegs.length&&(r.has(m.geometry.uuid)||r.set(m.geometry.uuid,[]),r.get(m.geometry.uuid).push(f),this.instancedLineGeomes.has(m.geometry)||(this.instancedLineGeomes.set(m.geometry,{hasOpaqueMtl:!1,hasTransparentMtl:!1}),m.geometry.refInThisMeshSet=0))}for(var g=vi(r);!(v=g()).done;){var v=v.value,y=v[0],v=v[1];this.geomUUID2LineIdAttribute.has(y)||(v=new Int32Array(v),(v=new THREE.InstancedBufferAttribute(v,1)).needsUpdate=!0,this.geomUUID2LineIdAttribute.set(y,v))}},i.prepareForBatchDraw=function(){if((this.needsUpdate||this.visualStates.dirty)&&(this.visualStates.opaqueDrawCount=0,this.visualStates.transparentDrawCount=0,this.visualStates.lineDrawCount=0,this.visualStates.lineDrawPass=0,this.needsUpdate)){this.instancedMeshGeomes.forEach(function(e,t,r){e.hasPhongMtl=!1,e.hasPhysicMtl=!1,e.hasOpaqueMtl=!1,e.hasTransparentMtl=!1}),this.__updateCachedGeometryArray(-1,"opaque",this.opaqueMeshes,void 0),this.__updateCachedGeometryArray(-1,"transparent",this.transparentMeshes,void 0),this.opaqueLevelEnd=[],this.transparentLevelEnd=[];for(var e=0;e<this.levelCriticalSizes.length;++e)this.opaqueLevelEnd[e]=0,this.transparentLevelEnd[e]=0;this.__updateCachedGeometryArray(-1,"line",this.drawingLines,void 0);var t=this.meshManager,r=this.ndsModel;(r.isSketchModel||r.isDisaModel)&&(this.supportMultiDraw=!1);for(var i=0,n=this.getNumMeshes();i<n;++i){var a=this.getMeshId(i),o=t.getMeshInfor(a,{},!1,!1),a=r.meshState.getMeshMaterial(a);if(o.material=a.material,o.localIndex=i,o.size=this.meshSize[i],!1===o.geometry.supportMultiDraw&&(this.supportMultiDraw=!1),o.bodyNode.opacity=a.material.opacity,0<a.faceMaterials.length){if(o.faceMaterials=a.faceMaterials,o.containsOpaqueFace=0<a.numOpaqueFace,o.containsTransparentFace=0<a.numTransparentFace,0<a.numOpaqueFace){this.__updateCachedGeometryArray(this.opaqueMeshes.length,"opaque",this.opaqueMeshes,o);for(var s=0;s<this.levelCriticalSizes.length;++s)if(o.size>this.levelCriticalSizes[s]){++this.opaqueLevelEnd[s];break}}if(0<a.numTransparentFace){this.__updateCachedGeometryArray(this.transparentMeshes.length,"transparent",this.transparentMeshes,o);for(var l=0;l<this.levelCriticalSizes.length;++l)if(o.size>this.levelCriticalSizes[l]){++this.transparentLevelEnd[l];break}}}else{o.faceMaterials=null;if(((a.drawingParams?a.drawingParams.opacity<.99:a.material.transparent)||null!==a.material.alphaMap)&&t.enableTransparent){this.__updateCachedGeometryArray(this.transparentMeshes.length,"transparent",this.transparentMeshes,o);for(var d=0;d<this.levelCriticalSizes.length;++d)if(o.size>this.levelCriticalSizes[d]){++this.transparentLevelEnd[d];break}a.drawingParams&&(o.bodyNode.opacity=a.drawingParams.opacity)}else{this.__updateCachedGeometryArray(this.opaqueMeshes.length,"opaque",this.opaqueMeshes,o);for(var c=0;c<this.levelCriticalSizes.length;++c)if(o.size>this.levelCriticalSizes[c]){++this.opaqueLevelEnd[c];break}o.bodyNode.opacity=1}}}for(var h=1;h<this.levelCriticalSizes.length;++h)this.opaqueLevelEnd[h]+=this.opaqueLevelEnd[h-1],this.transparentLevelEnd[h]+=this.transparentLevelEnd[h-1];for(var u,p=0,f=this.getNumLineSegments();p<f;++p){var m,g,v=this.getLineSegmentsId(p),y=t.getLineSegmentsInfor(v,{},!0,!1);y.bodyNode.parent.disableDrawLine||y.bodyNode.disableDrawLine||(m=y.material?y.material.color.hex:0,g=(g=y.bodyNode.opacity<=.99?Math.max(.85*y.bodyNode.opacity,.2):1)<y.material.opacity?g:y.material.opacity,r.meshState.setLineMaterial(v,m,g),y.material=r.meshState.getLineMaterial(v),y.localIndex=p,!1===y.geometry.supportMultiDraw&&(this.supportMultiDraw=!1),0<y.material.lineSegMaterials.length?(y.lineSegMaterials=y.material.lineSegMaterials,y.containsOpaqueLineSeg=0<y.material.numOpaqueLineSeg,y.containsTransparentLineSeg=0<y.material.numTransparentLineSeg):y.lineSegMaterials=null,this.__updateCachedGeometryArray(this.drawingLines.length,"line",this.drawingLines,y))}this.needsUpdate=!1,0<this.__visualStatesUpdateCallback.length&&(u=this).__visualStatesUpdateCallback.forEach(function(e){e.call(u,u.visualStates)})}},i.resetInstanceMesh=function(){this.instancedMeshGeomes.forEach(function(e,t,r){t.refInThisMeshSet=0})},i.resetInstanceLine=function(){this.instancedLineGeomes.forEach(function(e,t,r){t.refInThisMeshSet=0})},i.__shouldDrawBodyNodeInRenderMode=function(e,t,r,i,n,a,o){if(void 0===i&&(i=!1),void 0===n&&(n=!1),void 0===a&&(a=!1),void 0===o&&(o=!1),this.ndsModel.viewer.singlePartMode&&this.ndsModel.viewer.customEdgeDetectPassBodyPart&&!a){if(e.renderMode===e.ndsModel.HIDDEN_LINE_VISIBLE)return!0;if(e.renderMode===e.ndsModel.HIDDEN_LINE_REMOVE)return!0;if(e.renderMode===e.ndsModel.WIREFRAME)return!0;if(!this.ndsModel.viewer.customEdgeDetectPassGlobal)return!1}if(!e.renderMode||0===e.renderMode)return t;if(i&&e.renderMode===e.ndsModel.HIDDEN_LINE_VISIBLE)return!0;if(n&&e.renderMode===e.ndsModel.HIDDEN_LINE_REMOVE)return!0;if(r&&(e.renderMode===e.ndsModel.SHADED_WITH_EDGES||e.renderMode===e.ndsModel.SHADED))return!0;if(a){if(o&&e.renderMode===e.ndsModel.WIREFRAME)return!1;if(e.renderMode===e.ndsModel.SHADED_WITH_EDGES||e.renderMode===e.ndsModel.WIREFRAME)return!0}return!1},i.__fetchForDepthDraw=function(e,t,r,i,n){void 0===i&&(i=!1),void 0===n&&(n={});for(var a=!0,o=0,s=this.opaqueMeshes.length;o<s;++o){var l=this.opaqueMeshes[o],d=l.bodyNode;(a=0<d.cullInfo.cullState&&!d.isHidden(!0)&&this.__shouldDrawBodyNodeInRenderMode(d,r,!0,!0,!0,!1))&&this.clipDataManager.needIncludePartClip(d)&&(l.material.isMeshPhongMaterial?e[e.batchLength++]=l:t[t.batchLength++]=l),this.visualStates.opaqueDrawCount++}for(var c=0,h=this.transparentMeshes.length;c<h;++c){var u=this.transparentMeshes[c],p=u.bodyNode;a=0<p.cullInfo.cullState&&!p.isHidden(!0)&&this.__shouldDrawBodyNodeInRenderMode(p,r,!0,!0,!0,!1),!i&&a&&this.clipDataManager.needIncludePartClip(p)&&(u.material.isMeshPhongMaterial?e[e.batchLength++]=u:t[t.batchLength++]=u),this.visualStates.transparentDrawCount++}},i.fetchOpaqueForDraw=function(e,t,r,i,n,a,o,s){if(void 0===s&&(s={}),-1===r)this.__fetchForDepthDraw(e,t,i,!a,s);else{r>=this.levelCriticalSizes.length&&(r=this.levelCriticalSizes.length-1);for(var l=0,d=this.visualStates.opaqueDrawCount,c=this.opaqueLevelEnd[r],h=d,u=this.opaqueMeshes.length;!(u<=h||0<=r&&c<=h);++h){var p=this.opaqueMeshes[h],f=p.bodyNode;0<f.cullInfo.cullState&&!f.isHidden(!0)&&this.__shouldDrawBodyNodeInRenderMode(f,i,n,a,o,!1)&&(!f.isSelected()||this.ndsModel.viewer.customEdgeDetectPassGlobal||this.ndsModel.viewer.customEdgeDetectPassBodyPart)&&this.clipDataManager.needIncludePartClip(f)&&(p.material.isMeshPhongMaterial?e[e.batchLength++]=p:t[t.batchLength++]=p,p.material.side===THREE.DoubleSide)&&(s.shouldDrawDoubleSide=!0),++l}this.visualStates.opaqueDrawCount+=l}},i.fetchTransparentForDraw=function(e,t,r,i,n,a,o,s){r>=this.levelCriticalSizes.length&&(r=this.levelCriticalSizes.length-1);for(var l=0,d=this.visualStates.transparentDrawCount,c=this.transparentLevelEnd[r],h=d,u=this.transparentMeshes.length;!(u<=h||0<=r&&c<=h);++h){var p=this.transparentMeshes[h],f=p.bodyNode;0<f.cullInfo.cullState&&!f.isHidden(!0)&&this.__shouldDrawBodyNodeInRenderMode(f,i,n,a,o,!1)&&(!f.isSelected()||this.ndsModel.viewer.customEdgeDetectPassGlobal||this.ndsModel.viewer.customEdgeDetectPassBodyPart)&&this.clipDataManager.needIncludePartClip(f)&&(p.material.isMeshPhongMaterial?e[e.batchLength++]=p:t[t.batchLength++]=p,p.material.side===THREE.DoubleSide)&&(s.shouldDrawDoubleSide=!0),++l}this.visualStates.transparentDrawCount+=l},i.fetchOpaqueLineForDraw=function(e,t,r,i,n,a){void 0===t&&(t=-1),void 0===a&&(a=!1);for(var o=0,s=0,l=this.selectedDrawingLines.batchLength,d=this.visualStates.lineDrawCount;!(t<=s||d>=this.lineCount);++d){var c,h=this.drawingLines[d];h&&(!(c=h.bodyNode).unload&&0<c.cullInfo.cullState&&this.__shouldDrawBodyNodeInRenderMode(c,r,!1,n,i,!0,a)&&this.clipDataManager.needIncludePartClip(c)&&(c.isSelected()?this.selectedDrawingLines[l++]=h:c.isHidden(!0)||(e[e.batchLength++]=h),++s),++o)}this.visualStates.lineDrawCount+=o,this.selectedDrawingLines.batchLength=l},i.fetchLineForDraw=function(e,t,r,i,n,a){void 0===t&&(t=-1),0===this.visualStates.lineDrawCount&&(this.selectedDrawingLines.batchLength=0),this.fetchOpaqueLineForDraw(e,t,r,i,n,a)},i.fetchTransparentLineForDraw=function(e,t){},i.needsMeshDraw=function(){return!!this.visualStates.dirty||this.visualStates.opaqueDrawCount<this.opaqueMeshes.length||this.visualStates.transparentDrawCount<this.transparentMeshes.length},i.needsLineDraw=function(e){return(!(e=void 0===e||e)||!this.needsMeshDraw())&&this.visualStates.lineDrawCount<this.drawingLines.length},i.containsBodyNode=function(e){for(var t=0;t<this.bodyNodes.length;++t)if(this.bodyNodes[t].globalIndex===e.globalIndex)return!0;return!1},i.updateMeshSetRenderMode=function(t,e){function r(e){switch(e){case t.ndsModel.WIREFRAME:return 0;case t.ndsModel.HIDDEN_LINE_REMOVE:return 1;case t.ndsModel.HIDDEN_LINE_VISIBLE:return 2}}var i=t.renderMode,n=this.renderMode,a=r(i);if(void 0!==a&&(this.__renderModeList[a]--,0===this.__renderModeList[a]))switch(i){case t.ndsModel.WIREFRAME:n&=~NDS.RENDER_BIT.WIREFRAME;break;case t.ndsModel.HIDDEN_LINE_REMOVE:n&=~NDS.RENDER_BIT.HIDDEN_LINE_REMOVE;break;case t.ndsModel.HIDDEN_LINE_VISIBLE:n&=~NDS.RENDER_BIT.HIDDEN_LINE_VISIBLE}i=function(e){switch(e){case"wireframe":return 3;case"hiddenLineRemove":return 4;case"hiddenLineVisible":return 5}return 0}(e),a=r(i);switch(i){case t.ndsModel.WIREFRAME:n|=NDS.RENDER_BIT.WIREFRAME,this.__renderModeList[a]++;break;case t.ndsModel.HIDDEN_LINE_REMOVE:n|=NDS.RENDER_BIT.HIDDEN_LINE_REMOVE,this.__renderModeList[a]++;break;case t.ndsModel.HIDDEN_LINE_VISIBLE:n|=NDS.RENDER_BIT.HIDDEN_LINE_VISIBLE,this.__renderModeList[a]++}if(0===this.renderMode&&0!==n)for(var o=0,s=this.bodyNodes.length;o<s;++o)if(!this.bodyNodes[o].renderMode||this.bodyNodes[o].renderMode===this.ndsModel.SHADED||this.bodyNodes[o].renderMode===this.ndsModel.SHADED_WITH_EDGES){n|=NDS.RENDER_BIT.NORMAL;break}this.renderMode=n,t.renderMode=i},i.hasNormalNode=function(){return this.renderMode&0!==NDS.RENDER_BIT.NORMAL},i.hasWireframeNode=function(){return this.renderMode&0!==NDS.RENDER_BIT.WIREFRAME},i.hasHiddenLineVisibleNode=function(){return this.renderMode&0!==NDS.RENDER_BIT.HIDDEN_LINE_VISIBLE},i.hasHiddenLineRemoveNode=function(){return this.renderMode&0!==NDS.RENDER_BIT.HIDDEN_LINE_REMOVE},i.sortMeshes=function(e){},i.isAllMeshHidden=function(){return!1},i.isVisible=function(){return!0},i.getNumMeshes=function(){return this.meshCount},i.getMesh=function(e){},i.getMeshId=function(e){return this.meshes[e]},i.includeTexts=function(){},i.getNumTexts=function(){},i.getTextId=function(){},i.getText=function(e){},i.includeLineSegments=function(){},i.getNumLineSegments=function(){return this.lineCount},i.getLineSegmentsId=function(e){return this.lines[e]},i.getLineSegmentsWithState=function(e,t,r){void 0===t&&(t=!1)},i.getLineSegments=function(e,t,r){void 0===t&&(t=!1)},i.intersect=function(e,t){for(var r=this.getNumMeshes(),i=new THREE.Box3,n=0;n<r;++n){var a=this.getMeshId(n);this.meshManager.getMeshInfor(a).bodyNode.isHidden(!0)||(this.meshManager.getMeshBBox(a,i),e.intersectsBox(i)&&t.push(a))}},e}(nt);function Ei(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,function(e){e=function(e,t){if("object"!=typeof e||!e)return e;var r=e[Symbol.toPrimitive];if(void 0===r)return("string"===t?String:Number)(e);r=r.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}(e,"string");return"symbol"==typeof e?e:e+""}(i.key),i)}}function wi(e,t,r){return t&&Ei(e.prototype,t),r&&Ei(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function xi(e,t){e.prototype=Object.create(t.prototype),bi(e.prototype.constructor=e,t)}function bi(e,t){return(bi=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}var Bi=function(r){function e(e){var t=r.call(this,e)||this;return t.isTypedArrayUniform=!0,e.buffer.version=-1,t.__version=-1,t}return xi(e,r),wi(e,[{key:"needsUpdate",get:function(){return this.__version!==this.value.buffer.version},set:function(e){!1===e?this.__version=this.value.buffer.version:!0===e&&this.value.buffer.version++}}])}(THREE.Uniform),Ii=function(t){function e(){var e=t.call(this)||this;return e.dynamicBinding=!1,e.dataBuffer=null,e.unUsedIndex=0,e}return xi(e,t),e.prototype.add=function(e){if(e.isTypedArrayUniform)return this.uniforms[0]=e,this.dataBuffer=e.value,this},wi(e,[{key:"needsUpdate",get:function(){return 0<this.uniforms.length&&this.uniforms[0].needsUpdate},set:function(e){this.uniforms[0].needsUpdate=e}}])}(THREE.UniformsGroup),Ti=0,Si=-1,Ri=1024,o=new Int32Array(4*Ri),Ci=void 0,Di=void 0,Pi=128,Hi=function(e){return Math.round(1e3*e)},_i=function(e){e?(void 0===Ci&&((Ci=new THREE.UniformsGroup).setName("globalMtlData"),Ci.add(new THREE.Uniform(o))),Ci.uniforms[0].needsUpdate=!0,Ci.needsUpdate=!0):(void 0===Di&&((Di=new THREE.DataTexture(o,Pi,Pi/4,THREE.RedIntegerFormat,THREE.IntType)).minFilter=THREE.NearestFilter,Di.magFilter=THREE.NearestFilter),Di.needsUpdate=!0)},Li=new Map,Oi=function(){function e(e){var n=this,a=(this.ndsModel=e,this.meshMtls=new Map,this.needsMtlCacheUpdate=!0,this.meshMtlTexSize=0,this.meshMtlBuffer=null,this.meshMtlTexture=null,this.ndsModel.viewer.renderer.mcad3dRenderer.supportGlobalMtlUBO),e=(this.globalMtlUniformBlock=void 0,this.globalMtlTexture=void 0,this.globalMtlTextureSize=void 0,this.lineMtls=new Map,this.lineMtlTexture=null,this.lineMtlBuffer=null,this.lineMtlTexSize=0,new THREE.Color(16233729));this.__wireframe_color_opacity=this.__calculatePackedColorOpacity(new THREE.Color(0,0,0),1),this.__selected_wireframe_color_opacity=this.__calculatePackedColorOpacity(e,.4),this.__selected_edge_color_opacity=this.__calculatePackedColorOpacity(new THREE.Color(16776960),.4),this.__selected_visible_edge_color_opacity=this.__calculatePackedColorOpacity(e,1),this.__selected_visible_edge_color=e,this.__selected_hidden_edge_color_opacity=this.__calculatePackedColorOpacity(e,.2),this.getMtlKey=function(e){var t,r,i;return e.cacheKey||(e.cacheKey=e.type,"MeshPhongMaterial"===e.type?(e.cacheKey+="-"+e.specular.getHexString()+"-"+e.shininess+"-"+e.emissive.getHexString()+"-"+e.emissiveIntensity,Li.has(e.cacheKey)||Li.set(e.cacheKey,function(e,t){void 0===t&&(t=!0);e={globalIndex:Ti++,type:e.type,specular:e.specular.getHex(),shininess:Math.round(e.shininess),emissive:e.emissive.getHex(),emissiveIntensity:Hi(e.emissiveIntensity)};return o[4*e.globalIndex+0]=e.specular,o[4*e.globalIndex+1]=e.shininess,o[4*e.globalIndex+2]=e.emissive,o[4*e.globalIndex+3]=e.emissiveIntensity,_i(t),e}(e,a))):"MeshPhysicalMaterial"===e.type&&(e.cacheKey+="-"+e.anisotropy+"-"+e.anisotropyRotation+"-"+e.attenuationColor.getHexString()+"-"+e.attenuationDistance,e.cacheKey+="-"+e.clearcoat+"-"+e.clearcoatRoughness+"-"+e.dispersion+"-"+e.emissive.getHex(),e.cacheKey+="-"+e.emissiveIntensity+"-"+e.ior+"-"+e.iridescence+"-"+e.iridescenceIOR+"-"+e.sheen,e.cacheKey+="-"+e.sheenColor.getHexString()+"-"+e.sheenRoughness+"-"+e.transmission,Li.has(e.cacheKey)||Li.set(e.cacheKey,(r=a,t={globalIndex:Si--,type:(t=e).type,anisotropy:Hi(t.anisotropy),anisotropyRotation:Hi(t.anisotropyRotation),attenuationColor:t.attenuationColor.getHex(),attenuationDistance:Hi(t.attenuationDistance),specularColor:t.specularColor.hex,specularColorIntensity:Hi(t.specularIntensity),dispersion:Hi(t.dispersion),emissive:t.emissive.getHex(),emissiveIntensity:Hi(t.emissiveIntensity),ior:Hi(t.ior),sheen:Hi(t.sheen),sheenColor:t.sheenColor.getHex(),sheenRoughness:t.sheenRoughness,transmission:Hi(t.transmission)},o[0+(i=4*(Ri+4*t.globalIndex))]=t.anisotropy,o[1+i]=t.anisotropyRotation,o[2+i]=t.attenuationColor,o[3+i]=t.attenuationDistance,o[4+i]=t.specularColor,o[5+i]=t.specularColorIntensity,o[6+i]=t.emissive,o[7+i]=t.emissiveIntensity,o[8+i]=t.dispersion,o[9+i]=t.ior,o[10+i]=t.sheen,o[11+i]=t.sheenColor,o[12+i]=t.sheenRoughness,o[13+i]=t.transmission,_i(r),t))),a?n.globalMtlUniformBlock=void 0===n.globalMtlUniformBlock?Ci:n.globalMtlUniformBlock:(n.globalMtlTexture=void 0===n.globalMtlTexture?Di:n.globalMtlTexture,n.globalMtlTextureSize=void 0===n.globalMtlTextureSize?Pi:n.globalMtlTextureSize)),e.cacheKey}}var t=e.prototype;return t.__calculatePackedColorOpacity=function(e,t){return 16*e.hex+Math.floor(15*t)},t.__getMeshDrawingMtlParams=function(e,t){e*=4;return"MeshPhongMaterial"===t?{color:this.meshMtlBuffer[1+e],opacity:this.meshMtlBuffer[2+e]/1e3}:"MeshPhysicalMaterial"===t?{color:this.meshMtlBuffer[1+e],opacity:(this.meshMtlBuffer[2+e]>>16)/255}:void 0},t.__updateMeshMtlBuffer=function(e,t){var r,i,n,e=4*e,a=t.material.type;"MeshPhongMaterial"===a?(this.meshMtlBuffer[e]=t.globalIndex,this.meshMtlBuffer[1+e]=t.material.color.hex,this.meshMtlBuffer[2+e]=t.material.transparent?Math.round(1e3*t.material.opacity):1e3):"MeshPhysicalMaterial"===a&&(this.meshMtlBuffer[e]=4*t.globalIndex+Ri,this.meshMtlBuffer[1+e]=t.material.color.hex,a=Math.floor(15*t.material.reflectivity),n=Math.floor(15*t.material.roughness),i=Math.floor(255*t.material.metalness),r=Math.floor(255*t.material.opacity),this.meshMtlBuffer[2+e]=r<<16|i<<8|n<<4|a,r=Math.floor(255*t.material.clearcoat),i=Math.floor(255*t.material.iridescence),n=Math.floor(15*t.material.clearcoatRoughness),a=Math.floor(10*(t.material.iridescenceIOR-1)),this.meshMtlBuffer[3+e]=r<<16|i<<8|n<<4|a)},t.update=function(){if(this.needsMtlCacheUpdate){if(this.needsMtlCacheUpdate=!1,!this.meshMtlTexture){var e=this.meshMtls.size,e=Math.ceil(Math.log2(e)),e=Math.pow(2,Math.ceil(e/2));this.meshMtlTexSize=e,this.meshMtlBuffer=new Float32Array(this.meshMtlTexSize*this.meshMtlTexSize*4),this.meshMtlTexture=new THREE.DataTexture(this.meshMtlBuffer,this.meshMtlTexSize,this.meshMtlTexSize,THREE.RGBAFormat,THREE.FloatType);for(var t=this.ndsModel.meshSets,r=0;r<t.length;r++)for(var i=t[r],n=0;n<i.meshCount;n++){var a=i.meshOffset+n,o=this.meshMtls.get(i.meshes[n]);o.meshMtlIndex=a,this.__updateMeshMtlBuffer(a,o)}this.meshMtlTexture.needsUpdate=!0}if(!this.lineMtlTexture){e=this.lineMtls.size,e=Math.ceil(Math.log2(e)),e=Math.pow(2,Math.ceil(e/2));this.lineMtlTexSize=e,this.lineMtlBuffer=new Float32Array(this.lineMtlTexSize*this.lineMtlTexSize*2),this.lineMtlTexture=new THREE.DataTexture(this.lineMtlBuffer,this.lineMtlTexSize,this.lineMtlTexSize,THREE.RGFormat,THREE.FloatType);for(var s=this.ndsModel.meshSets,l=0;l<s.length;l++)for(var d=s[l],c=0;c<d.lineCount;c++){var h=d.lineOffset+c,u=this.lineMtls.get(d.lines[c]),h=2*(u.lineMtlIndex=h);this.lineMtlBuffer[h]=u.color,this.lineMtlBuffer[1+h]=Math.round(1e3*u.opacity)}this.lineMtlTexture.needsUpdate=!0}}},t.hasTexture=function(e){return null!==e.map&&void 0!==e.map||null!==e.emissiveMap&&void 0!==e.emissiveMap||null!==e.normalMap&&void 0!==e.normalMap||null!==e.specularMap&&void 0!==e.specularMap||null!==e.alphaMap&&void 0!==e.alphaMap||null!==e.roughnessMap&&void 0!==e.roughnessMap||null!==e.metalnessMap&&void 0!==e.metalnessMap||null!==e.specularColorMap&&void 0!==e.specularColorMap||null!==e.specularIntensityMap&&void 0!==e.specularIntensityMap},t.setMeshMaterial=function(e,t){var r=this.getMtlKey(t),i=this.meshMtls.get(e);i?t&&(i.material=t,i.faceMaterials.length)&&this.__updateFaceMaterial(e):this.meshMtls.set(e,{globalIndex:Li.get(r).globalIndex,material:t,numTransparentFace:0,numOpaqueFace:0,faceMaterials:[],hasTexture:this.hasTexture(t)}),this.meshMtlTexture&&(this.__updateMeshMtlBuffer(i.meshMtlIndex,i),this.meshMtlTexture.needsUpdate=!0)},t.__isSameColor=function(e,t){return null===e.color&&null===t.color||!(null===e.color&&null!==t.color||null!==e.color&&null===t.color)&&e.color.hex===t.color.hex},t.__updateFaceMaterial=function(e){var t=this.meshMtls.get(e),r=t.faceMaterials,i=this.ndsModel.meshManager.getMeshInfor(e,null,!1,!1),n=i.geometry.drawRange.count-1;if(1<r.length&&r.sort(function(e,t){return e.range[0]-t.range[0]}),1<=r.length){0!==r[0].range[0]&&r.unshift({range:[0,n],color:null,opacity:null,visible:!0,color_opacity:-1});for(var a=0;a<r.length-1;a++)r[a].range[0]>=n?r.splice(a,1):(r[a].range[1]>r[a+1].range[0]?r[a].range[1]=r[a+1].range[0]-1:r[a].range[1]<r[a+1].range[0]-1&&r.splice(a+1,0,{range:[r[a].range[1]+1,r[a+1].range[0]-1],color:null,opacity:null,visible:!0,color_opacity:-1}),r[a].range[1]+1===r[a+1].range[0]&&this.__isSameColor(r[a],r[a+1])&&r[a].opacity===r[a+1].opacity&&r[a].visible===r[a+1].visible&&(r[a].range[1]=r[a+1].range[1],r.splice(a+1,1),--a))}1!==r.length||null!==r[0].color&&r[0].color.hex!==t.material.color.hex||null!==r[0].opacity&&r[0].opacity!==t.material.opacity||!r[0].visible||r.splice(0,1),1<=r.length&&(r[r.length-1].range[1]>n?r[r.length-1].range[1]=n:r[r.length-1].range[1]<n&&(e={range:[r[r.length-1].range[1]+1,n],color:null,opacity:null,visible:!0,color_opacity:-1},r[r.length]=e)),t.numOpaqueFace=0,t.numTransparentFace=0,t.minOpacity=t.material.opacity;for(var o=0;o<r.length;++o){var s,l=t.meshSet.meshManager,l=!l||l.enableTransparent,l=null!==r[o].opacity?Number(r[o].opacity):!1===l?1:t.material.opacity;(8===this.ndsModel.viewer.getRenderMode()||i.bodyNode.isTransparent())&&t.material.opacity<1&&(l=t.material.opacity),(-2===r[o].color_opacity||0<=r[o].color_opacity)&&(s=(null!==r[o].color?r[o]:t.material).color,r[o].color_opacity=16*s.hex+Math.floor(15*l)),l<1?(++t.numTransparentFace,r[o].transparent=!0,t.minOpacity=Math.min(t.minOpacity,l)):(++t.numOpaqueFace,r[o].transparent=!1)}},t.setFaceColor=function(e,t,r){if(r){var i=this.meshMtls.get(e);if(i){for(var n=0,a=i.faceMaterials;n<a.length&&(a[n].range[0]!==t[0]||a[n].range[1]!==t[1]);++n);var o=!1;n<a.length?r.hex!==i.material.color.hex||null!==a[n].opacity&&a[n].opacity!==i.material.opacity||!a[n].visible?null!==a[n].color&&r.hex===a[n].color.hex||(a[n].color=r,a[n].color_opacity=-2,o=!0):(a.splice(n,1),o=!0):r.hex!==i.material.color.hex&&(a[n]={range:t,color:r,opacity:null,visible:!0,color_opacity:-2},o=!0),o&&this.__updateFaceMaterial(e)}return i}},t.setFaceOpacity=function(e,t,r){if(null!=r){var i=this.meshMtls.get(e);if(i){for(var n=0,a=i.faceMaterials;n<a.length&&(a[n].range[0]!==t[0]||a[n].range[1]!==t[1]);++n);var o=!1;n<a.length?null!==a[n].color&&a[n].color.hex!==i.material.color.hex||r!==i.material.opacity||!a[n].visible?r!==a[n].opacity&&(a[n].opacity=r,a[n].color_opacity=-2,o=!0):(a.splice(n,1),o=!0):r!==i.material.opacity&&(a[n]={range:t,color:null,opacity:r,visible:!0,color_opacity:-2},o=!0),o&&this.__updateFaceMaterial(e)}return i}},t.setFaceVisible=function(e,t,r){var i=this.meshMtls.get(e);if(i){for(var n=0,a=i.faceMaterials;n<a.length&&(a[n].range[0]!==t[0]||a[n].range[1]!==t[1]);++n);var o=!1;n<a.length?null!==a[n].color&&a[n].color.hex!==i.material.color.hex||null!==a[n].opacity&&a[n].opacity!==i.material.opacity||!r?a[n].visible=r:(a.splice(n,1),o=!0):r||(a[n]={range:t,color:null,opacity:null,visible:r,color_opacity:-2},o=!0),o&&this.__updateFaceMaterial(e)}return i},t.removeFaceMaterial=function(e,t,r,i){void 0===r&&(r=!0),void 0===i&&(i=!0);var n=this.meshMtls.get(e);if(n){for(var a=0,o=n.faceMaterials;a<o.length&&(o[a].range[0]!==t[0]||o[a].range[1]!==t[1]);++a);a<o.length&&(r&&(o[a].color=null),i&&(o[a].opacity=null),null===o[a].color&&null===o[a].opacity&&o[a].visible&&o.splice(a,1),this.__updateFaceMaterial(e))}return n},t.removeAllFaceMaterials=function(){var r=this;this.meshMtls&&0!=this.meshMtls.length&&this.meshMtls.forEach(function(e,t){e.faceMaterials&&0<e.faceMaterials.length&&(e.faceMaterials=[],r.__updateFaceMaterial(t),e.meshSet.visualStates.dirty=!0,e.meshSet.needsUpdate=!0,e.meshSet.prepareForBatchDraw())})},t.__updateLineMaterial=function(e){var t=this.lineMtls.get(e),r=t.lineSegMaterials,i=this.ndsModel.meshManager.getLineSegmentsInfor(e,null,!1,!1).geometry.drawRange.count-1;if(1<r.length&&r.sort(function(e,t){return e.range[0]-t.range[0]}),1<=r.length){0!==r[0].range[0]&&r.unshift({range:[0,i],color:null,opacity:null,visible:!0,color_opacity:-1});for(var n=0;n<r.length-1;n++)r[n].range[0]>=i?r.splice(n,1):(r[n].range[1]>r[n+1].range[0]?r[n].range[1]=r[n+1].range[0]-1:r[n].range[1]<r[n+1].range[0]-1&&r.splice(n+1,0,{range:[r[n].range[1]+1,r[n+1].range[0]-1],color:null,opacity:null,visible:!0}),r[n].range[1]+1===r[n+1].range[0]&&this.__isSameColor(r[n],r[n+1])&&r[n].opacity===r[n+1].opacity&&r[n].visible===r[n+1].visible&&(r[n].range[1]=r[n+1].range[1],r.splice(n+1,1),--n))}1!==r.length||null!==r[0].color&&r[0].color.hex!==t.color||null!==r[0].opacity&&r[0].opacity!==t.opacity||!r[0].visible||r.splice(0,1),1<=r.length&&(r[r.length-1].range[1]>i?r[r.length-1].range[1]=i:r[r.length-1].range[1]<i&&(e={range:[r[r.length-1].range[1]+1,i],color:null,opacity:null,visible:!0,color_opacity:-1},r[r.length]=e)),t.numOpaqueLineSeg=0;for(var a=t.numTransparentLineSeg=0;a<r.length;++a){var o,s=(null!==r[a].opacity?r[a]:t).opacity;(-2===r[a].color_opacity||0<=r[a].color_opacity)&&(o=(null!==r[a].color?r[a]:t).color,r[a].color_opacity=16*o.hex+Math.floor(15*s)),s<1?(++t.numTransparentLineSeg,r[a].transparent=!0):(++t.numOpaqueLineSeg,r[a].transparent=!1)}},t.setLineMaterial=function(e,t,r,i){void 0===t&&(t=0),void 0===r&&(r=1),void 0===i&&(i=null);var n=this.lineMtls.get(e),a=!1;return n?(null!=t&&n.color!==t&&(n.color=t,a=!0),null!=r&&n.opacity!==r&&(n.opacity=r,a=!0),a&&null!==n.lineSegMaterials&&0<n.lineSegMaterials.length&&this.__updateLineMaterial(e)):(a=!0,this.lineMtls.set(e,{material:i,color:t||0,opacity:r||1,numTransparentLineSeg:0,numOpaqueLineSeg:0,lineSegMaterials:[]})),a&&this.lineMtlTexture&&(e=2*n.lineMtlIndex,this.lineMtlBuffer[e]=n.color,this.lineMtlBuffer[1+e]=Math.round(1e3*n.opacity),this.lineMtlTexture.needsUpdate=!0),n},t.setLineColor=function(e,t,r){if(r){var i=this.lineMtls.get(e);if(i){for(var n=0,a=i.lineSegMaterials;n<a.length&&(a[n].range[0]!==t[0]||a[n].range[1]!==t[1]);++n);var o=!1;n<a.length?r.hex!==i.color||null!==a[n].opacity&&a[n].opacity!==i.opacity||!a[n].visible?null!==a[n].color&&r.hex===a[n].color.hex||(a[n].color=r,a[n].color_opacity=-2,o=!0):(a.splice(n,1),o=!0):r.hex!==i.color&&(a[n]={range:t,color:r,opacity:null,visible:!0,color_opacity:-2},o=!0),o&&this.__updateLineMaterial(e)}return i}},t.setLineOpacity=function(e,t,r){if(null!=r){var i=this.lineMtls.get(e);if(i){for(var n=0,a=i.lineSegMaterials;n<a.length&&(a[n].range[0]!==t[0]||a[n].range[1]!==t[1]);++n);var o=!1;n<a.length?null!==a[n].color&&a[n].color.hex!==i.color||r!==i.opacity||!a[n].visible?r!==a[n].opacity&&(a[n].opacity=r,a[n].color_opacity=-2,o=!0):(a.splice(n,1),o=!0):r!==i.opacity&&(a[n]={range:t,color:null,opacity:r,visible:!0,color_opacity:-2},o=!0),o&&this.__updateLineMaterial(e)}return i}},t.getWireFrameColorOpacity=function(e){return(e=void 0===e?!1:e)?this.__selected_wireframe_color_opacity:this.__wireframe_color_opacity},t.getSelectedEdgeColorOpacity=function(e){return 0===(e=void 0===e?0:e)?this.__selected_edge_color_opacity:1===e?this.__selected_visible_edge_color_opacity:2===e?this.__selected_hidden_edge_color_opacity:void 0},t.getSelectedEdgeColor=function(){return this.__selected_visible_edge_color},t.setLineVisible=function(e,t,r){var i=this.lineMtls.get(e);if(i){for(var n=0,a=i.lineSegMaterials;n<a.length&&(a[n].range[0]!==t[0]||a[n].range[1]!==t[1]);++n);var o=!1;n<a.length?null!==a[n].color&&a[n].color.hex!==i.color||null!==a[n].opacity&&a[n].opacity!==i.opacity||!r?a[n].visible=r:(a.splice(n,1),o=!0):r||(a[n]={range:t,color:null,opacity:null,visible:r,color_opacity:-2},o=!0),o&&this.__updateLineMaterial(e)}return i},t.removeLineMarterial=function(e,t,r,i){void 0===r&&(r=!0),void 0===i&&(i=!0);var n=this.lineMtls.get(e);if(n){for(var a=0,o=n.lineSegMaterials;a<o.length&&(o[a].range[0]!==t[0]||o[a].range[1]!==t[1]);++a);a<o.length&&(r&&(o[a].color=null),i&&(o[a].opacity=null),null===o[a].color&&null===o[a].opacity&&o[a].visible&&o.splice(a,1),this.__updateLineMaterial(e))}return n},t.removeAllLineMaterials=function(){var r=this;this.lineMtls&&0!=this.lineMtls.length&&this.lineMtls.forEach(function(e,t){e.lineSegMaterials&&0<e.lineSegMaterials.length&&(e.lineSegMaterials=[],r.__updateLineMaterial(t),e.meshSet.visualStates.dirty=!0,e.meshSet.needsUpdate=!0,e.meshSet.prepareForBatchDraw())})},t.getMeshMaterial=function(t){var r=this.meshMtls.get(t);return r?(r.material.colors&&r.material.colors.forEach(function(e){e.meshId===t&&(r.material.color.copy(e.value),r.material.needsUpdate=!0,r.material.needsRefresh=!0)}),r.material.opacities&&r.material.opacities.forEach(function(e){e.meshId===t&&(r.material.opacity=e.value,r.material.transparent=r.material.opacity<1,r.material.needsUpdate=!0,r.material.needsRefresh=!0)}),this.meshMtlBuffer&&(r.drawingParams=this.__getMeshDrawingMtlParams(r.meshMtlIndex,r.material.type)),r):null},t.getLineMaterial=function(e){e=this.lineMtls.get(e);return e||null},e}();function Fi(e,t){var r,i="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(i)return(i=i.call(e)).next.bind(i);if(Array.isArray(e)||(i=function(e,t){{var r;if(e)return"string"==typeof e?Ui(e,t):"Map"===(r="Object"===(r={}.toString.call(e).slice(8,-1))&&e.constructor?e.constructor.name:r)||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?Ui(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length)return i&&(e=i),r=0,function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}};throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function Ui(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,i=Array(t);r<t;r++)i[r]=e[r];return i}function Ni(e,t){e.prototype=Object.create(t.prototype),Vi(e.prototype.constructor=e,t)}function Vi(e,t){return(Vi=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}function Gi(){var e=new Ii,t=(e.dynamicBinding=!0,e.setName("bodyWorldMatrixData"),new Float32Array(16384));return e.add(new Bi(t)),e}function ki(){var e=new Float32Array(262144);return(e=new THREE.DataTexture(e,ji,ji,THREE.RGBAFormat,THREE.FloatType)).unUsedIndex=0,e.needsUpdate=!0,e}var ji=256,Ye=[],Qe=[],zi=function(d){function e(e,t,r){function a(){var d=c;if(c.viewer.pmiObject&&!De.ScenarioEditor){c.viewer.isDisaModel||(o=[],0<(o=c.viewer.SDFMaker.getHashKey()).length&&(o=c.viewer.SDFMaker.CreateImage(o),c.viewer.SDFMaker.CreateOldMaterialFromImage(o)));var e=null;if(c.refModel)e=c.pmiObject,c.pmiObject.offsetMatrix&&(e.applyMatrix(c.pmiObject.offsetMatrix),delete c.pmiObject.offsetMatrix),e.updateMatrixWorld(!0),c.viewer.pmiObject.add(e);else{for(var e=c.pmiObject.children[0].children[0],t=1;t<c.pmiObject.children.length;t++)for(var r=c.pmiObject.children[t],i=0;i<r.children[0].children.length;i++){var n=r.children[0].children[i];n.ndsModel=c,e.add(n)}c.viewer.pmiObject.remove(e.parent.parent),c.viewer.pmiObject.add(e),c.pmiObject.offsetMatrix&&(e.applyMatrix(c.pmiObject.offsetMatrix),delete c.pmiObject.offsetMatrix),e.updateMatrixWorld(!0),c.pmiObject=e}c.viewer.isDisaModel||e.traverse(function(e){e.ndsModel=d,e.geometry&&"TextBufferGeometry"===e.geometry.type&&null!==e.geometry.styleId&&(e.material=d.viewer.SDFMaker.TextMaterial)}),e.ndsModel=c;var a=e.version,o=(a||("PMI_Model1"===e.name?(e.version=2,e.name=c.rootBodyNode.name,c.viewer.viewerPMIVisible||e.traverse(function(e){e.visible=d.viewer.viewerPMIVisible})):e.version=1),(c.PMIUUIDtoPMIObject[e.uuid]=e).views&&d.pmiuuidMap&&e.views.forEach(function(e){e.pmiuuid&&(e.pmiuuid=e.pmiuuid.map(function(e){return d.pmiuuidMap.get(e)?d.pmiuuidMap.get(e):e}))}),e.captures&&d.pmiuuidMap&&e.captures.forEach(function(e){e.pmiuuid&&(e.pmiuuid=e.pmiuuid.map(function(e){return d.pmiuuidMap.get(e)?d.pmiuuidMap.get(e):e}))}),0<c.viewer.ndsModel.ModelUpMatrix4.length&&((o=new THREE.Matrix4).fromArray(c.viewer.ndsModel.ModelUpMatrix4),e.applyMatrix(o),e.updateMatrixWorld(!0)),e.traverse(function(e){e.geometry&&d.viewer.leafPMIObjects.push(e),(d.PMIUUIDtoPMIObject[e.uuid]=e).views&&d.pmiuuidMap&&e.views.forEach(function(e){e.pmiuuid&&(e.pmiuuid=e.pmiuuid.map(function(e){return d.pmiuuidMap.get(e)?d.pmiuuidMap.get(e):e}))}),e.captures&&d.pmiuuidMap&&e.captures.forEach(function(e){e.pmiuuid&&(e.pmiuuid=e.pmiuuid.map(function(e){return d.pmiuuidMap.get(e)?d.pmiuuidMap.get(e):e}))}),e.originMatrixWorld&&e.originMatrixWorld.copy(e.matrixWorld),a||(e.name=e.name.replace(/Circular Region/gi,"圆形区域"),e.name=e.name.replace(/Rectangular Region/gi,"矩形区域"),e.name=e.name.replace(/Hole Callout/gi,"孔标注"),e.name=e.name.replace(/Notes Area/gi,"注释区域"),e.name=e.name.replace(/Datum Reference Frams/gi,"基准参考框架"),e.name=e.name.replace(/Construction geometries/gi,"构造几何图形"),e.name=e.name.replace(/Restricted Areas/gi,"受限区域"),e.name=e.name.replace(/Datum features and datum targets/gi,"基准特征和基准目标"),e.name=e.name.replace(/Reference Frams/gi,"参考框架"),e.name=e.name.replace(/radius Dimension/gi,"半径尺寸"),e.name=e.name.replace(/horizontal Dimension/gi,"水平尺寸"),e.name=e.name.replace(/vertical Dimension/gi,"垂直尺寸"),e.name=e.name.replace(/perpendicular Dimension/gi,"法线标注"),e.name=e.name.replace(/Chamfer Dimension/gi,"倒斜角尺寸"),e.name=e.name.replace(/Radial Dimension/gi,"半径尺寸"),e.name=e.name.replace(/Thickness Dimension/gi,"厚度尺寸"),e.name=e.name.replace(/Ordinate Origin/gi,"坐标原点"),e.name=e.name.replace(/Ordinate Dimension/gi,"坐标尺寸"),e.name=e.name.replace(/Datum Feature Symbol/gi,"基准特征符合"),e.name=e.name.replace(/Datum Target/gi,"基准目标"),e.name=e.name.replace(/Arc Length Dimension/gi,"弧长尺寸"),e.name=e.name.replace(/Feature Control Frame/gi,"特征控制框"),e.name=e.name.replace(/Balloon Note/gi,"符号注释"),e.name=e.name.replace(/Surface Finish/gi,"表面粗糙度"),e.name=e.name.replace(/Angular Dimension/gi,"角度尺寸"),e.name=e.name.replace(/Flag Note/gi,"标识注解"),e.name=e.name.replace(/Weld Symbol/gi,"焊接符号"),e.name=e.name.replace(/Geometrica Tolerances/gi,"形位公差"),e.name=e.name.replace(/geometrical tolerance/gi,"形位公差"),e.name=e.name.replace(/surface texture/gi,"粗糙度"),e.name=e.name.replace(/Linear Size/gi,"线性尺寸"),e.name=e.name.replace(/Coordinate Dimension/gi,"坐标尺寸"),e.name=e.name.replace(/Note/gi,"注释"),e.name=e.name.replace(/Datum/gi,"基准"),e.name=e.name.replace(/GeomTol/gi,"几何公差"),e.name=e.name.replace(/Roughness/gi,"粗糙度"),e.name=e.name.replace(/Capture/gi,"捕获"),e.name=e.name.replace(/View/gi,"视图"),e.name=e.name.replace(/Feature/gi,"特征"),e.name=e.name.replace(/Target/gi,"目标"),e.name=e.name.replace(/Text/gi,"文本"),e.name=e.name.replace(/Weld/gi,"焊接"),e.name=e.name.replace(/Dimension/gi,"尺寸"),e.name=e.name.replace(/Label/gi,"标签"),-1!==e.name.indexOf("pmi_")&&(e.name=e.name.substr(4))),e.children[0]&&e.children[0].geometry&&d.pmiNum++}),new THREE.Raycaster(new THREE.Vector3(0,0,0),new THREE.Vector3(0,1,0)));o.linePrecision=1,o.intersectObjects(d.viewer.leafPMIObjects,!0),a||(!function e(t){var r=!!t.refMatrix;if(t.pmiuuid&&0<t.pmiuuid.length)for(var i=0;i<t.pmiuuid.length;++i){var n=t.pmiuuid[i],a=d.PMIUUIDtoPMIObject[n];if(r&&a){a.applyMatrix4(t.worldMatrix),a.updateMatrixWorld(!0);for(var o=0;o<a.children.length;o++){var s=a.children[o];s.originMatrixWorld.copy(s.matrixWorld)}}}for(var l=0;l<t.children.length;l++)e(t.children[l])}(c.rootBodyNode),c.OrientationPMI(e),c.calculatePMIBoundingBox(e))}d.pmiuuidMap&&delete d.pmiuuidMap}(c=d.call(this,e,t,r=void 0===r?{}:r)||this).sptIndex=null,c.isMCAD3DModel=!0,c.typeName="MCAD3D",c.hasRefModel=!!r.hasRefModel,c.needsPMI=void 0===r.needsPMI||r.needsPMI,c.needsSketchModel=void 0===r.needsSketchModel||r.needsSketchModel,c.insetModel=void 0!==r.insetModel&&r.insetModel,c.ndsSketchModel=null,c.meshState=new Oi(c),c.SDFMaker=new de(c.viewer.is2DModel),c.pmiObject=null,c.pmiNum=0,c.shouldApplyCull=!0,c.setDirty=function(){var e,t,r=void 0===c?this:c;return function(){for(e=0,t=r.meshSets.length;e<t;++e)r.meshSets[e].makeDirty();0<r.assamblyNodes.length&&(r.assamblyNodes[0].cullInfo.cullState=-1),r.selectedBodiesDirty=!0,r.transparentBodiesDirty=!0,r.referenceEntityDirty=!0,r.lineSegmentsSet.dirty=!0,r.meshManager.dirty=!0,r.spriteDirty=!0}}(),c.applyCull=function(e){if(c.shouldApplyCull&&0!==c.assamblyNodes.length&&(!c.assamblyNodes[0].cullInfo.valid||-1===c.assamblyNodes[0].cullInfo.cullState))for(var t=0,r=c.assamblyNodes.length;t<r;++t)c.assamblyNodes[t].cullInfo.valid=!0,c.assamblyNodes[t].parent&&2===c.assamblyNodes[t].parent.cullInfo.cullState?c.assamblyNodes[t].cullInfo.cullState=2:c.assamblyNodes[t].parent&&0===c.assamblyNodes[t].parent.cullInfo.cullState?c.assamblyNodes[t].cullInfo.cullState=0:c.assamblyNodes[t].getBoundingSphere().isEmpty()?c.assamblyNodes[t].cullInfo.cullState=2:c.assamblyNodes[t].cullInfo.cullState=e.intersectsSphere2(c.assamblyNodes[t].getBoundingSphere())};c.handelUnloadState=function(){var e,t;if(c.refModel){if(c.copyFrom(c.refModel),0!==c.position.x||0!==c.position.y||0!==c.position.z||0!==c.rotation.x||0!==c.rotation.y||0!==c.rotation.z||1!==c.scale.x||1!==c.scale.y||1!==c.scale.z||c.rootBodyNode.fileUnit!=c.viewer.modelUnit?(c.updateMatrixByModelUnit(),(e=new THREE.Matrix4).compose(c.position,c.rotation,c.scale),c.rootBodyNode.matrix&&((t=new THREE.Matrix4).fromArray(c.rootBodyNode.matrix),e=e.multiply(t)),c.updateNodeMatrix(c.rootBodyNode.uuid,e.elements),c.meshManager.reCalculateMeshBBox()):c.rootBodyNode.updateMatrixWorld(!0,!0),c.state=ee.StateType.PREPARED,c.viewer.dispatchModelEvent({type:"PMIInfoEvent"}),c.viewer.dispatchModelEvent({type:"BVHInfoEvent"}),c.viewer.dispatchModelEvent({type:"geometryAllLoadedEvent"}),c.viewer.getLoadingManager().onLoadCallback(),c.needsRecalculateMeshBBox&&(c.meshManager.reCalculateMeshBBox(),c.needsRecalculateMeshBBox=!1),c.params.resetCamera&&(c.viewer.camera.setOrginalCameraInfo(void 0),c.viewer.controls.SetBoundingBoxUpdated(!1),c.viewer.resetCamera({smoothTranslation:!1})),0==c.params.visible&&c.viewer.hideObject(c.rootBodyNode),c.pmiObject&&(a(),c.pmiObject.type="PMI"),c.loadSketch(),"posy"!==De.modelUpDirection&&!De.inBIMContext&&c.viewer.enableFlip&&(!c.viewer.CADViewer||!c.ndsSketchModel)){c.viewer.OriginalRootMatrix=c.rootBodyNode.matrix?c.rootBodyNode.matrix.slice(0):[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];for(var r=(c.viewer.ndsModel.activeModel=c).viewer.initModelUpDirection(De.modelUpDirection,!0),i=new THREE.Matrix4,n=0;n<16;++n)i.elements[n]=r[n];c.meshManager.globalTransform=i,c.rootBodyNode.matrix=r.slice(0),c.rootBodyNode.updateMatrixWorld(!0,!1)}}else d.prototype.handelUnloadState.call(c)},c.handleAllGeomLoadedState=function(){c.pmiObject?(c.viewer.addPMIObject(c.pmiObject),a(),c.viewer.dispatchModelEvent({type:"PMIInfoEvent",PMI:!0})):c.viewer.dispatchModelEvent({type:"PMIInfoEvent",PMI:!1}),d.prototype.handleAllGeomLoadedState.call(c)};var c,h=null;return c.refreshMeshState=function(i){if(i.useBodyNodeMaterial&&!h&&(h=i.uuid),0<i.children.length)for(var e=0;e<i.children.length;++e)c.refreshMeshState(i.children[e]);if(i.leafBodyAttri){for(var n=0<c.getAllTransparentBodies(!1).length&&i.isTransparent(),a=null,o=i.getUserMaterial(),s=(o?(o.backMaterial||(o.backMaterial=o.clone(),o.backMaterial.transparent=!0,o.backMaterial.opacity=De.bodyOpacity,o.colors&&(o.backMaterial.colors=Array.from(o.colors)),o.backoriMaterial=o.clone(),o.colors&&(o.backoriMaterial.colors=Array.from(o.colors))),n?o=o.backMaterial:i.isOriginalTransparent()&&(o=o.backoriMaterial)):h&&((a=c.bodyNodeUUidToMaterial[h]).transparentMaterial||(a.transparentMaterial=a.clone(),a.transparentMaterial.transparent=!0,a.transparentMaterial.opacity=De.bodyOpacity),n)&&(a.transparentMaterial.color.copy(a.color),a.colors&&(a.transparentMaterial.colors=Array.from(a.colors)),a=a.transparentMaterial),i.leafBodyAttri.bodyMeshIds),t=i.leafBodyAttri.bodyLineSegIds,r=0;r<s.length;++r)!function(t){var e=null,r=c.meshManager.materialId[s[t]];r>=c.meshManager.mats.length/2&&(r-=c.meshManager.mats.length/2),e=c.meshManager.mats[r],o?(i.isOriginalTransparent()&&(o.transparent=e.transparent,o.opacity=e.opacity),o.colors&&o.colors.forEach(function(e){e.meshId===s[t]&&o.color.copy(e.value)}),o.opacities&&o.opacities.forEach(function(e){e.meshId===s[t]&&(o.opacity=e.value,o.transparent=o.opacity<1)}),e=o):a?(a.colors&&a.colors.forEach(function(e){e.meshId===s[t]&&a.color.copy(e.value)}),a.opacities&&a.opacities.forEach(function(e){e.meshId===s[t]&&(a.opacity=e.value,a.transparent=a.opacity<1)}),e=a):n&&(e=c.meshManager.matsCopy[r]),e.opacity<.99&&c.meshManager.enableTransparent?(e.transparent=!0,e.depthWrite=!1):(e.transparent=!1,e.depthWrite=!0),c.meshState.setMeshMaterial(s[t],e)}(r);for(var l=0;l<t.length;++l){var d=c.meshManager.lineSegMaterialId[t[l]],d=c.meshManager.mats[d];d.opacity<.99&&c.meshManager.enableTransparent?d.transparent=!0:d.transparent=!1,c.meshState.setLineMaterial(t[l],d.color.hex,d.opacity,d)}}h===i.uuid&&(h=null)},c.handlePreparedState=function(){if(c.rootBodyNode.updateMatrixWorld(!1),c.meshVisibleNeedsUpdate||c.meshMtlNeedsUpdate){c.refreshMeshState(c.rootBodyNode),c.meshVisibleNeedsUpdate=!1,c.meshMtlNeedsUpdate=!1;for(var e=0;e<c.meshSets.length;++e)c.meshSets[e].needsUpdate=!0}if(!c._load&&c.viewer.prepareLoadModels&&c.viewer.prepareLoadModels.length){var t=0;c._load=!0;for(var r=0;r<c.viewer.prepareLoadModels.length;r++){var i=c.viewer.prepareLoadModels[r];if(i.unload){i.unload=!1;var n=i.url,a=i.id,i=i.params;i.NoChangeDispathcNum=!0,c.viewer.loadModel(a,n,null,null,"js",null,null,null,i);break}t++}t==c.viewer.prepareLoadModels.length&&(c.viewer.prepareLoadModels=[])}},c}Ni(e,d);var t=e.prototype;return t.buildMeshSets=function(e){void 0===e&&(e=512),this.meshSets=[];var O,t,F=0,U=0,r=this.geomManager.bufferChunk,i=new THREE.Box3,N=new THREE.Vector3,n=[],V=new Map,G=new Map,s=new Map,l=[],a=[],o=new Map;for(O in r)if(r.hasOwnProperty(O)){var k=r[O].ndsGeometriesArray;if(k)for(var j=0,z=k.length;j<z;++j){var d,c=k[j];void 0!==c.subGeomId&&0!==c.subGeomId&&0<c.refMeshes.length&&(d=c.refMeshes[0],this.meshManager.getMeshBBox(d,i),i.getSize(N),o.has(c.uuid)?(d=(d=o.get(c.uuid)).union(i),o.set(c.uuid,d)):o.set(c.uuid,i.clone()))}}for(t in r)if(r.hasOwnProperty(t)){var W=r[t],X=W.ndsGeometriesArray;if(X){for(var q=X.length,Y=0,Q=0,K=0,Z=0,h=0,J=Number.MAX_SAFE_INTEGER,$=[],u=new Map,p=0,ee=q;p<ee;++p){var te,f=X[p],m={geom:f,size:0,isInstance:1<f.refMeshes.length,bodyNodes:[]};0<f.refMeshes.length?(o.has(f.uuid)?(te=o.get(f.uuid),i.copy(te)):(te=f.refMeshes[0],this.meshManager.getMeshBBox(te,i)),i.getSize(N),m.size=N.length(),a[a.length++]=m.size,Z+=m.size,h=h<m.size?m.size:h,J=m.size<J?m.size:J,K++,Y+=f.refMeshes.length,f.refMeshes.length):0<f.refLineSegs.length&&(m.size=1);for(var re=0,ie=f.refMeshes.length;re<ie;++re){var g=this.meshManager.bodyNodes[f.refMeshes[re]];g.unload||(void 0===g.chunkIndex?g.chunkIndex=l.length:g.chunkIndex!==l.length&&(s.has(g)||(s.set(g,new Set),s.get(g).add(g.chunkIndex)),s.get(g).add(l.length),g.chunkIndex=l.length),u.has(g.globalIndex)||(u.set(g.globalIndex,{node:g,localIndex:-1,meshes:[],lines:[]}),Q++),u.get(g.globalIndex).meshes.push({meshId:f.refMeshes[re],geomIndex:p,size:m.size}),m.bodyNodes.push(g))}for(var ne=0,ae=f.refLineSegs.length;ne<ae;++ne){var v=this.meshManager.lineSegBodyNodes[f.refLineSegs[ne]];v.unload||(u.has(v.globalIndex)||(u.set(v.globalIndex,{node:v,localIndex:-1,meshes:[],lines:[]}),Q++),u.get(v.globalIndex).lines.push({lineId:f.refLineSegs[ne],geomIndex:p,size:m.size}),m.bodyNodes.push(v))}$.push(m)}l.push({chunkUrl:t,groupIndex:-1,avgSize:Z/(0===K?1:K),maxSize:h,minSize:J,totalMeshCount:Y,totalBodyNodeCount:Q,bufferLength:W.bufferlenth}),V.set(t,$),G.set(t,u)}}for(var oe,se=0,le=function(){var e=oe.value,i=e[0],n=e[1];if(-1!==l[n.values().next().value].groupIndex)return 1;for(var a,o=Array.from(n),t=Fi(s);!(a=t()).done;)!function(){var e=a.value,t=e[0],r=e[1];if(i===t||-1!==l[r.values().next().value].groupIndex)return;0<o.filter(function(e){return r.has(e)}).length&&r.forEach(function(e){n.has(e)||(n.add(e),o.push(e))})}();for(var r=0;r<o.length;++r)l[o[r]].groupIndex=se;++se},de=Fi(s);!(oe=de()).done;)le();l.sort(function(e,t){return e.groupIndex!==t.groupIndex?t.groupIndex-e.groupIndex:t.maxSize-e.maxSize}),a.sort(function(e,t){return t-e});for(var ce,y=[],A=1,he=1,ue=a.length;he<ue;++he).05<((ce=a[he-1])-a[he])/ce||5e3===A?(y.push({criticalSize:ce,levelSize:A}),A=1):++A;y.push({criticalSize:0,levelSize:A});for(var M=0,pe=y.length-1;M<pe;++M){var fe=y[M].levelSize,me=y[M+1].levelSize;fe<2500&&fe<512*(M+1)&&fe+me<512*(M+2)&&(y[M+1].levelSize+=y[M].levelSize,y[M].discard=!0),M===pe-1&&!y[M].discard&&y[M+1].levelSize<512&&(y[M].discard=!0)}for(var ge=[],ve=0,ye=y.length;ve<ye;++ve)y[ve].discard||ge.push(y[ve].criticalSize);this.sizeLevelCount=(y=ge).length;for(var Ae=0,E={isProcessed:!1,meshCount:0,bufferLength:0,bodyNodeCount:0,geomChunkUrl:[],groupIndex:-2};Ae<l.length;){var w=l[Ae],Me=w.chunkUrl,Ee=w.totalMeshCount,we=w.totalBodyNodeCount,xe=w.groupIndex;0===E.geomChunkUrl.length||this.geomManager.enableMergeGeomChunk&&E.groupIndex===xe&&E.bodyNodeCount+we<e&&E.meshCount+Ee<e&&(E.bufferLength+w.bufferLength)/1024/1024<5?(E.geomChunkUrl.push(Me),-2===E.groupIndex&&(E.groupIndex=xe),E.meshCount+=Ee,E.bodyNodeCount+=we,E.bufferLength+=w.bufferLength,r[Me].geomChunkGroup=E,++Ae===l.length&&n.push(E)):(n.push(E),E={isProcessed:!1,meshCount:0,bufferLength:0,bodyNodeCount:0,geomChunkUrl:[],groupIndex:-2})}for(var be=0;be<n.length;++be)for(var Be=n[be],x=(this.meshSets.push(new Mi(this)),this.meshSets[this.meshSets.length-1]),Ie=0;Ie<Be.geomChunkUrl.length;++Ie){var Te=Be.geomChunkUrl[Ie],Se=V.get(Te),Re=G.get(Te);Se.sort(function(e,t){return t.size-e.size});for(var Ce=0;Ce<Se.length;++Ce)for(var De=Se[Ce].bodyNodes,Pe=0;Pe<De.length;++Pe){var b=Re.get(De[Pe].globalIndex);if(!(-1<b.localIndex)){(x.meshCount+b.meshes.length>e||x.bodyNodes.length===e)&&(this.meshSets.push(new Mi(this)),x=this.meshSets[this.meshSets.length-1]),b.localIndex=x.bodyNodes.indexOf(b.node),-1===b.localIndex&&(b.localIndex=x.bodyNodes.length,x.bodyNodes.push(b.node));for(var He=0;He<b.meshes.length;++He){var _e=b.meshes[He];_e.bodyId=b.localIndex,x.meshes.push(_e),++x.meshCount}for(var Le=0;Le<b.lines.length;++Le){var Oe=b.lines[Le];Oe.bodyId=b.localIndex,x.lines.push(Oe),++x.lineCount}}}}for(var B,I=0;I<this.meshSets.length;++I)this.meshSets[I].init(y),F+=this.meshSets[I].meshCount,U+=this.meshSets[I].lineCount;this.meshSets.sort(function(e,t){return t._avg_mesh_size_-e._avg_mesh_size_}),0<F&&(B=Math.ceil(Math.log2(F)),B=Math.pow(2,Math.ceil(B/2)),this.meshId2BodyIdTexSize=B,this.meshId2BodyIdBuffer=new Uint32Array(this.meshId2BodyIdTexSize*this.meshId2BodyIdTexSize),this.meshId2BodyIdTexture=new THREE.DataTexture(this.meshId2BodyIdBuffer,this.meshId2BodyIdTexSize,this.meshId2BodyIdTexSize,THREE.RedIntegerFormat,THREE.UnsignedIntType),this.meshId2BodyIdTexture.needsUpdate=!0),0<U&&(B=Math.ceil(Math.log2(U)),B=Math.pow(2,Math.ceil(B/2)),this.lineId2BodyIdTexSize=B,this.lineId2BodyIdBuffer=new Uint32Array(this.lineId2BodyIdTexSize*this.lineId2BodyIdTexSize),this.lineId2BodyIdTexture=new THREE.DataTexture(this.lineId2BodyIdBuffer,this.lineId2BodyIdTexSize,this.lineId2BodyIdTexSize,THREE.RedIntegerFormat,THREE.UnsignedIntType),this.lineId2BodyIdTexture.needsUpdate=!0);var T=0,S=0;if(this.viewer.renderer.mcad3dRenderer.supportLargeUniformBuffer){0===Ye.length&&Ye.push(Gi());for(var Fe=0;Fe<this.meshSets.length;++Fe){for(var R=this.meshSets[Fe],C=0;C<Ye.length&&!(Ye[C].unUsedIndex+R.bodyNodes.length<=1024);++C);C===Ye.length&&(Ye[C]=Gi()),R.bodyWorldMatrixUniformBlock=Ye[C],R.bodyWorldMatrixOffset=Ye[C].unUsedIndex,R.bodyNodeWorldMatrixBuffer=Ye[C].dataBuffer;for(var D=0,Ue=R.bodyNodes.length;D<Ue;++D)R.bodyNodes[D].worldMatrix?R.bodyNodes[D].synchronizedWorldMatrix.push(new THREE.Matrix4(R.bodyNodeWorldMatrixBuffer,16*(R.bodyWorldMatrixOffset+D)*4)):R.bodyNodes[D].worldMatrix=new THREE.Matrix4(R.bodyNodeWorldMatrixBuffer,16*(R.bodyWorldMatrixOffset+D)*4);Ye[C].unUsedIndex+=R.bodyNodes.length,R.bodyWorldMatrixUniformBlock.needsUpdate=!0;for(var Ne=0;Ne<R.meshId2BodyId.length;++Ne)this.meshId2BodyIdBuffer[T+Ne]=R.meshId2BodyId[Ne];R.meshOffset=T,T+=R.meshCount;for(var Ve=0;Ve<R.lineId2BodyId.length;++Ve)this.lineId2BodyIdBuffer[S+Ve]=R.lineId2BodyId[Ve];R.lineOffset=S,S+=R.lineCount}this.bodyWorldMatrixUniformBlocks=Ye,1===this.bodyWorldMatrixUniformBlocks.length?Ye[0].dynamicBinding=!1:Ye[0].dynamicBinding=!0}else{0===Qe.length&&Qe.push(ki());for(var Ge=0;Ge<this.meshSets.length;++Ge){for(var P=this.meshSets[Ge],H=0;H<Qe.length&&!(Qe[H].unUsedIndex+P.bodyNodes.length<=16384);++H);H===Qe.length&&(Qe[H]=ki()),P.bodyWorldMatrixUniformMap=Qe[H],P.bodyWorldMatrixUniformMapSize=ji,P.bodyWorldMatrixOffset=Qe[H].unUsedIndex,P.bodyNodeWorldMatrixBuffer=Qe[H].source.data.data;for(var _=0,ke=P.bodyNodes.length;_<ke;++_)P.bodyNodes[_].worldMatrix?P.bodyNodes[_].synchronizedWorldMatrix.push(new THREE.Matrix4(P.bodyNodeWorldMatrixBuffer,16*(P.bodyWorldMatrixOffset+_)*4)):P.bodyNodes[_].worldMatrix=new THREE.Matrix4(P.bodyNodeWorldMatrixBuffer,16*(P.bodyWorldMatrixOffset+_)*4);Qe[H].unUsedIndex+=P.bodyNodes.length,P.bodyWorldMatrixUniformMap.needsUpdate=!0;for(var je=0;je<P.meshId2BodyId.length;++je)this.meshId2BodyIdBuffer[T+je]=P.meshId2BodyId[je];P.meshOffset=T,T+=P.meshCount;for(var ze=0;ze<P.lineId2BodyId.length;++ze)this.lineId2BodyIdBuffer[S+ze]=P.lineId2BodyId[ze];P.lineOffset=S,S+=P.lineCount}this.bodyWorldMatrixUniformMaps=Qe}this.rootBodyNode.updateMatrixWorld(!0,!1),this.refreshMeshState(this.rootBodyNode),this.meshState.update();for(var We=0;We<this.meshSets.length;++We){var L=this.meshSets[We];L.updateMultiDrawControlParams();for(var Xe=0;Xe<L.meshes.length;++Xe)this.meshState.getMeshMaterial(L.meshes[Xe]).meshSet=L;for(var qe=0;qe<L.lines.length;++qe)this.meshState.getLineMaterial(L.lines[qe]).meshSet=L}},t.refreshBodyWorldMatrixUniforms=function(){if(this.viewer.renderer.mcad3dRenderer.supportLargeUniformBuffer)for(var e=0,t=this.bodyWorldMatrixUniformBlocks.length;e<t;++e)this.bodyWorldMatrixUniformBlocks[e].needsUpdate=!0;else for(var r=0,i=this.bodyWorldMatrixUniformMaps.length;r<i;++r)this.bodyWorldMatrixUniformMaps[r].needsUpdate=!0},t.setExplodeFactor=function(e,t){d.prototype.setExplodeFactor.call(this,e,t),this.refreshBodyWorldMatrixUniforms()},t.dragBody=function(e,t,r){d.prototype.dragBody.call(this,e,t,r=void 0===r?null:r),this.refreshBodyWorldMatrixUniforms()},t.restoreDraggedBody=function(e){d.prototype.restoreDraggedBody.call(this,e),this.refreshBodyWorldMatrixUniforms()},t.updateNodeMatrix=function(e,t){e=d.prototype.updateNodeMatrix.call(this,e,t);if(e.bodyNode){this.refreshBodyWorldMatrixUniforms();var t=e.bodyNode,r=e.offsetMatrix,i=this.getLeafPMIuuid(t);if(this.pmiObject&&this.pmiObject.version&&this.pmiObject.ndsModel){for(var n=0;n<i.length;n++){var a=i[n];if(this.pmiObject){var o=this.PMIUUIDtoPMIObject[a];if(o){o.matrixWorld.premultiply(r),o.originMatrixWorld.copy(o.matrixWorld),o.updateMatrixWorld(!0),o.matrixAutoUpdate=!1;for(var s=0;s<o.children.length;s++){var l=o.children[s];l.originMatrixWorld.copy(l.matrixWorld)}}}}this.OrientationPMI(),this.viewer.pmiObject.box3=null,this.viewer.calculatePMIBoundingBox()}else t.uuid===t.ndsModel.rootBodyNode.uuid&&this.pmiObject&&(this.pmiObject.offsetMatrix?this.pmiObject.offsetMatrix.premultiply(r):this.pmiObject.offsetMatrix=r.clone())}},t.attachBodyNode=function(e,t,r,i,n){if(n&&Object.assign(this.bodyNodeUUidToMaterial,n),!e)return this.viewer._CATIA&&t.referencename&&t.name&&t.oriName&&(t.name=t.oriName),this.setRootBodyNode(t,r,i),this.rootBodyNode;!e.propertyfile&&t.propertyfile&&(e.propertyfile=t.propertyfile,null!==this.viewer.propertyManager&&void 0!==this.viewer.propertyManager||(this.viewer.propertyManager=this.viewer.modelRequestor.createPropertyManager(this.viewer)),this.viewer.propertyManager.bindReference(e.uuid,t.referenceNode||t.uuid)),!e.pmiuuid&&t.pmiuuid&&(e.pmiuuid=t.pmiuuid),this.viewer._CATIA&&t.referencename&&(e.referencename=t.referencename),(!e.name||this.viewer._CATIA&&t.oriName)&&(e.name=t.name,e.oriName=t.oriName),t.externalRefUuid&&(e.externalRefUuid=t.externalRefUuid),e.area||void 0===t.area||(e.area=t.area),e.volume||void 0===t.volume||(e.volume=t.volume);for(var a,o=0;o<t.children.length;o++)e.children.push(t.children[o]),t.children[o].parent=e;for(a in r)this.meshUuid2GeomUuidMap[a]=r[a];for(var s=0,l=this.geomManager.geoms.length;s<l;++s){var d=this.geomManager.geoms[s];i[d.uuid]&&(d.tangentEdgeObject=!0)}return this.viewer.CADViewer&&this.sketchIsSub&&(e.volume=t.volume,e.area=t.area),e.worldMatrix=this.calculateNodeWorldMatrix(e,e.worldMatrix),e},t.addPMIObject=function(e){this.pmiObject||(this.pmiObject=new THREE.Object3D),this.pmiObject.add(e)},t.OrientationPMI=function(e){function de(e,t){var r=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3],i=new THREE.Box3;r[0].set(e.min.x,e.min.y,e.min.z).applyMatrix4(t),r[1].set(e.min.x,e.min.y,e.max.z).applyMatrix4(t),r[2].set(e.min.x,e.max.y,e.min.z).applyMatrix4(t),r[3].set(e.min.x,e.max.y,e.max.z).applyMatrix4(t),r[4].set(e.max.x,e.min.y,e.min.z).applyMatrix4(t),r[5].set(e.max.x,e.min.y,e.max.z).applyMatrix4(t),r[6].set(e.max.x,e.max.y,e.min.z).applyMatrix4(t),r[7].set(e.max.x,e.max.y,e.max.z).applyMatrix4(t);for(var n=0;n<r.length;n++)i.expandByPoint(r[n]);return i}e=e||(this.pmiObject&&this.pmiObject.children[0]&&this.pmiObject.children[0].children?this.pmiObject.children[0].children[0]:null);if(e){var ce=[],he=[];for(e.traverse(function(e){if(e.hasOrientation){for(var t=new THREE.Vector3,r=new THREE.Vector3,i=new THREE.Box3,n=new THREE.Line3(new THREE.Vector3(0,0,0),new THREE.Vector3(1e3,0,0)),a=new THREE.Line3(new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,1)),o=null,O=0;O<e.children.length;O++){var s,l,F,U,d,c=e.children[O];c.autoOrientation&&c.geometry?(c.geometry.TextBox?(s=de(c.geometry.TextBox,c.matrixWorld),i.containsBox(s)||i.union(s)):(c.geometry.boundingBox||c.geometry.computeBoundingBox(),s=de(c.geometry.boundingBox,c.matrixWorld),i.containsBox(s)||i.union(s)),o=o||c.matrixWorld):"Line"===c.type&&8===c.geometry.drawRange.count&&(l=c.geometry.drawRange.start,F=c.geometry.getAttribute("position"),d=c.geometry.index.getX(l),U=c.geometry.index.getX(l+7),t.fromBufferAttribute(F,d),r.fromBufferAttribute(F,U),c.geometry.index.getX(l+1)===c.geometry.index.getX(l+2))&&c.geometry.index.getX(l+3)===c.geometry.index.getX(l+4)&&c.geometry.index.getX(l+5)===c.geometry.index.getX(l+6)&&t.distanceTo(r)<1e-6&&(c.autoOrientation=!0,c.geometry.boundingBox||c.geometry.computeBoundingBox(),d=de(c.geometry.boundingBox,c.matrixWorld),i.containsBox(d)||i.union(d))}e.line=n.applyMatrix4(o);for(var h=null,N=0;N<e.children.length;N++){var u=e.children[N];if("Mesh"===u.type&&"TextBufferGeometry"===u.geometry.type&&u.geometry.name.includes("°")){h=null;break}if("Line"===u.type&&2===u.geometry.drawRange.count){var p=u.geometry.drawRange.start,f=u.geometry.getAttribute("position"),m=u.geometry.index.getX(p),p=u.geometry.index.getX(p+1),m=(t.fromBufferAttribute(f,m),r.fromBufferAttribute(f,p),new THREE.Line3(t,r));m.applyMatrix4(u.matrixWorld),(f=(new THREE.Vector3).subVectors(m.end,m.start)).normalize();(p=(new THREE.Vector3).subVectors(e.line.end,e.line.start)).normalize();var g=f.dot(p);if(1-Math.abs(g)<1e-4){if(h){h=null;break}h=m.clone()}}else if("Line2"===u.type&&6===u.geometry.attributes.instanceStart.data.array.length){t.fromArray(u.geometry.attributes.instanceStart.data.array,0),r.fromArray(u.geometry.attributes.instanceStart.data.array,3);m=new THREE.Line3(t,r);m.applyMatrix4(u.matrixWorld),(f=(new THREE.Vector3).subVectors(m.end,m.start)).normalize();(p=(new THREE.Vector3).subVectors(e.line.end,e.line.start)).normalize();g=f.dot(p);if(1-Math.abs(g)<1e-4){if(h){(f=(new THREE.Vector3).subVectors(h.start,m.start)).normalize(),(p=(new THREE.Vector3).subVectors(h.end,h.start)).normalize(),g=f.dot(p),1-Math.abs(g)<1e-4||(h=null);break}h=m.clone()}}}a.applyMatrix4(o);n=(new THREE.Vector3).subVectors(a.end,a.start),a=new THREE.Vector3;i.getCenter(a),h?(H=new THREE.Vector3,h.closestPointToPoint(a,!1,H),H=new THREE.Line3(H,new THREE.Vector3(H.x+n.x,H.y+n.y,H.z+n.z)),e.axis=H,e.BaseLine=h,H=h.start,_=h.end,V=i,B=o,B=(new THREE.Matrix4).copy(B).invert(),H=H.clone().applyMatrix4(B),_.clone().applyMatrix4(B),_=V.clone().applyMatrix4(B),Math.abs(_.min.z)<1e-4&&Math.abs(_.max.z)<1e-4&&Math.abs(H.z)<1e-4&&!(H.y<_.max.y&&H.y>_.min.y)&&he.push(e)):(V=new THREE.Line3(a,new THREE.Vector3(a.x+n.x,a.y+n.y,a.z+n.z)),e.axis=V)}var V;if(e.followCamera&&e.children&&0<e.children.length){var v=new THREE.Box3,y=null,G=new THREE.Vector3,k=-1/0,j=null;"GeomTol"===e.type&&(y=new THREE.Box3);for(var z=0;z<e.children.length;z++){var A=e.children[z];if(A.followCamera&&delete A.followCamera,"Note"===A.type&&y&&0<A.children.length){for(var W=0;W<A.children.length;W++){var M,E=A.children[W];E.geometry&&(E.geometry.TextBox?(M=de(E.geometry.TextBox,E.matrixWorld),y.containsBox(M)||y.union(M)):(E.geometry.boundingBox||E.geometry.computeBoundingBox(),M=de(E.geometry.boundingBox,E.matrixWorld),y.containsBox(M)||y.union(M)))}var w=new THREE.Vector3,X=(y.getCenter(w),new THREE.Vector3(y.max.x,y.min.x,y.min.z)),x=(new THREE.Vector3).subVectors(y.max,w).normalize(),X=(new THREE.Vector3).subVectors(X,w).normalize(),x=(new THREE.Vector3).crossVectors(x,X).normalize(),X=-x.dot(w),j=new THREE.Plane(x,X)}if(y){var b=new THREE.Vector3;if("Line2"===A.type)for(var q=0;q<A.geometry.attributes.instanceStart.data.array.length;q+=3)b.fromArray(A.geometry.attributes.instanceStart.data.array,q).applyMatrix4(A.matrixWorld),Math.abs(j.distanceToPoint(b))<1e-4&&b.distanceTo(y.min)>k&&(k=b.distanceTo(y.min),G.copy(b))}else A.geometry&&(A.geometry.TextBox?(w=de(A.geometry.TextBox,A.matrixWorld),v.containsBox(w)||v.union(w)):(A.geometry.boundingBox||A.geometry.computeBoundingBox(),x=de(A.geometry.boundingBox,A.matrixWorld),v.containsBox(x)||v.union(x)))}var B=new THREE.Vector3;v.getCenter(B),e.followCameraCenter=B,"GeomTol"===e.type&&(e.followCameraCenter=G)}if("GeomTol"===e.type&&e.autoOrientation){var I=[],Y=[];e.hasOrientation=!1;for(var Q=0;Q<e.children.length;Q++){var T=e.children[Q];if("Line"===T.type){var K=T.geometry.drawRange.start,S=new THREE.Vector3,R=new THREE.Vector3,Z=T.geometry.getAttribute("position"),J=T.geometry.index.getX(K),K=T.geometry.index.getX(K+1);if(S.fromBufferAttribute(Z,J),R.fromBufferAttribute(Z,K),S.distanceToSquared(R)<1e-4)continue;for(var C={start:S,end:R,uuid:T.uuid,p1:-1,p2:-1},D=0;D<I.length;D++){var $=I[D];S.distanceToSquared($)<1e-4&&(C.p1=D),R.distanceToSquared($)<1e-4&&(C.p2=D)}-1===C.p1&&(C.p1=I.length,I.push(S)),-1===C.p2&&(C.p2=I.length,I.push(R)),Y.push(C)}else if("Line2"===T.type){var ee=new THREE.Vector3,te=new THREE.Vector3,J=T.geometry.getAttribute("instanceStart"),Z=T.geometry.getAttribute("instanceEnd");if(ee.fromBufferAttribute(J,0),te.fromBufferAttribute(Z,0),ee.distanceToSquared(te)<1e-4)continue;for(var P={start:ee,end:te,uuid:T.uuid,p1:-1,p2:-1},re=0;re<I.length;re++){var ie=I[re];ee.distanceToSquared(ie)<1e-4&&(P.p1=re),te.distanceToSquared(ie)<1e-4&&(P.p2=re)}-1===P.p1&&(P.p1=I.length,I.push(ee)),-1===P.p2&&(P.p2=I.length,I.push(te)),Y.push(P)}(T.geometry&&"TextBufferGeometry"===T.geometry.type||"LineSegments"===T.type||"LineSegments2"===T.type)&&(e.hasOrientation=!0)}if(e.hasOrientation){var ne=function(e,t){for(var r=[],i={},n=new THREE.Line3,a=0;a<e.length;a++)(y=e[a]).p1!==y.p2&&(void 0!==i[y.p1]?i[y.p1].push(y.p2):i[y.p1]=[y.p2],void 0!==i[y.p2]?i[y.p2].push(y.p1):i[y.p2]=[y.p1]);for(var o=[];;){for(var s in i)if(1===i[s].length)for(var l in delete i[s],i){var d=parseInt(s),c=i[l].indexOf(d);-1!==c&&i[l].splice(c,1)}var h=!1;for(s in i)if(1===i[s].length){h=!0;break}if(!h)break}for(;;){var u=void 0;for(s in i)if(1<i[s].length){u=s;break}if(!u)for(var s in i)if(0<i[s].length){u=s;break}if(!u)break;var p=-1,d=parseInt(u),f=i[u];for(o.push(d);f&&f.length;){var m=f.shift();if(void 0===(m=m===p?f.shift():m)){delete i[d];break}o.push(m);for(h=!1,a=0;a<o.length-1;++a)if(m===o[a]){o=o.slice(a),h=!0;break}if(h)break;(0===f.length||f[0]===p)&&delete i[d],p=d,f=i[d=m]}if(5===o.length){if(o[0]===o[o.length-1]){r.push(o);break}o=[]}}var g=r[0],v=[];if(g&&0!==g.length)for(a=0;a<e.length;a++){var y=e[a];if(-1!==g.indexOf(y.p1))v.push(y.uuid);else{for(var A=!1,M=!1,E=0;E<g.length-1;E++){var w,x=g[E],b=g[E+1],x=t[x],b=t[b],b=(n.set(x,b),(new THREE.Vector3).subVectors(b,x)),B=(b.normalize(),(new THREE.Vector3).subVectors(y.start,x)),I=(B.normalize(),b.dot(B)),I=(1-Math.abs(I)<1e-4&&(w=n.closestPointToPointParameter(y.start,!1))<1&&0<w&&(A=!0),B.subVectors(y.end,x),B.normalize(),b.dot(B));1-Math.abs(I)<1e-4&&(w=n.closestPointToPointParameter(y.end,!1))<1&&0<w&&(M=!0)}A&&M&&v.push(y.uuid)}}return v}(Y,I);if(0!==ne.length){for(var ae=new THREE.Box3,H=new THREE.Line3(new THREE.Vector3(0,0,0),new THREE.Vector3(1e3,0,0)),_=new THREE.Line3(new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,1)),oe=null,se=0;se<e.children.length;se++){var le,L=e.children[se];-1===ne.indexOf(L.uuid)&&"TextBufferGeometry"!==L.geometry.type&&"LineSegments"!==L.type&&"LineSegments2"!==L.type||(L.autoOrientation=!0,"TextBufferGeometry"===L.geometry.type||"LineSegments"===L.type||"LineSegments2"===L.type?ne.push(L.uuid):(L.geometry.boundingBox||L.geometry.computeBoundingBox(),le=de(L.geometry.boundingBox,L.matrixWorld),ae.containsBox(le)||ae.union(le)),oe)||"TextBufferGeometry"!==L.geometry.type&&"LineSegments"!==L.type&&"LineSegments2"!==L.type||(oe=L.matrixWorld)}a=new THREE.Vector3,n=(ae.getCenter(a),e.line=H.applyMatrix4(oe),_.applyMatrix4(oe),(new THREE.Vector3).subVectors(_.end,_.start)),a=new THREE.Line3(a,new THREE.Vector3(a.x+n.x,a.y+n.y,a.z+n.z));e.axis=a,ne.length===e.children.length&&(e.vec=n,e.box=ae,ce.push(e))}}}});;){if(0===ce.length)break;for(var t=ce.shift(),r=0;r<he.length;r++){var i,n,a,o=he[r];o.BaseLine&&((i=(new THREE.Vector3).subVectors(o.BaseLine.end,o.BaseLine.start)).normalize(),(n=(new THREE.Vector3).subVectors(t.line.end,t.line.start)).normalize(),i=i.dot(n),1-Math.abs(i)<1e-4)&&(n=new THREE.Vector3,i=new THREE.Vector3,t.box.getCenter(i),o.BaseLine.closestPointToPoint(i,!1,n),n=new THREE.Line3(n,new THREE.Vector3(n.x+t.vec.x,n.y+t.vec.y,n.z+t.vec.z)),a=Math.min(i.distanceTo(o.BaseLine.start),i.distanceTo(o.BaseLine.end)),!t.distance||t.distance>a)&&(Math.abs(o.BaseLine.start.x-o.BaseLine.end.x)<1e-6&&Math.abs(i.x-o.BaseLine.end.x)<1e-6||Math.abs(o.BaseLine.start.y-o.BaseLine.end.y)<1e-6&&Math.abs(i.y-o.BaseLine.end.y)<1e-6||Math.abs(o.BaseLine.start.z-o.BaseLine.end.z)<1e-6&&Math.abs(i.z-o.BaseLine.end.z)<1e-6)&&(t.distance=a,t.axis=n)}}}},t.calculatePMIBoundingBox=function(e){var l,d,c;e&&(l=new THREE.Vector3,d=new THREE.Quaternion,c=new THREE.Vector3,e.traverse(function(e){if(e.fixedPmi){for(var t=new THREE.Box3,r=0,i=0;i<e.children.length;i++){var n,a=e.children[i];if(a.geometry)a.matrix.decompose(l,d,c),a.geometry.TextBox?(n=a.geometry.TextBox.clone().translate(l),t.containsBox(n)||t.union(n),r=a.geometry.TextBox.max.y-a.geometry.TextBox.min.y):(a.geometry.boundingBox||a.geometry.computeBoundingBox(),n=a.geometry.boundingBox.clone().translate(l),t.containsBox(n)||t.union(n));else if(0<a.children.length)for(var o=0;o<a.children.length;o++){var s=a.children[o];s.geometry&&(s.matrix.decompose(l,d,c),s.geometry.TextBox)&&0==r&&(r=s.geometry.TextBox.max.y-s.geometry.TextBox.min.y)}}e.fixedBox=t,e.textSize=r}}))},t.getLeafPMIuuid=function(e){var t=[];if(e.pmiuuid&&(t=t.concat(e.pmiuuid)),0<e.children.length)for(var r=[e],i=0;i<r.length;++i)if(r[i].pmiuuid&&0!==i&&(t=t.concat(r[i].pmiuuid)),0<r[i].children.length)for(var n=0,a=r[i].children.length;n<a;++n)r.push(r[i].children[n]);return t},t.setFaceVisible=function(e,t,r){e=this.meshState.setFaceVisible(e,t,r);e.meshSet.visualStates.dirty=!0,e.meshSet.needsUpdate=!0,e.meshSet.prepareForBatchDraw()},t.setFaceColor=function(e,t,r){e=this.meshState.setFaceColor(e,t,r);e.meshSet.visualStates.dirty=!0,e.meshSet.needsUpdate=!0,e.meshSet.prepareForBatchDraw()},t.setFaceOpacity=function(e,t,r){e=this.meshState.setFaceOpacity(e,t,r);e.meshSet.visualStates.dirty=!0,e.meshSet.needsUpdate=!0,e.meshSet.prepareForBatchDraw()},t.removeFaceMaterial=function(e,t,r,i){e=this.meshState.removeFaceMaterial(e,t,r=void 0===r?!0:r,i=void 0===i?!0:i);e.meshSet.visualStates.dirty=!0,e.meshSet.needsUpdate=!0,e.meshSet.prepareForBatchDraw()},t.removeAllFaceMaterials=function(){this.meshState.removeAllFaceMaterials()},t.setLineVisible=function(e,t,r){e=this.meshState.setLineVisible(e,t,r);e.meshSet.visualStates.dirty=!0,e.meshSet.needsUpdate=!0,e.meshSet.prepareForBatchDraw()},t.setLineColor=function(e,t,r){e=this.meshState.setLineColor(e,t,r);e.meshSet.visualStates.dirty=!0,e.meshSet.needsUpdate=!0,e.meshSet.prepareForBatchDraw()},t.setLineOpacity=function(e,t,r){e=this.meshState.setLineOpacity(e,t,r);e.meshSet.visualStates.dirty=!0,e.meshSet.needsUpdate=!0,e.meshSet.prepareForBatchDraw()},t.removeLineMarterial=function(e,t,r,i){e=this.meshState.removeLineMarterial(e,t,r=void 0===r?!0:r,i=void 0===i?!0:i);e.meshSet.visualStates.dirty=!0,e.meshSet.needsUpdate=!0,e.meshSet.prepareForBatchDraw()},t.removeAllLineMaterials=function(){this.meshState.removeAllLineMaterials()},t.mergeNode=function(){this.NeedsMergeBodyNode=!0,this.dirtyMergedNodeFalseBoundingBox(this.rootBodyNode),this.transparentBodyChanged=!0,this.getAllTransparentBodies(!1)},t.unmergeNode=function(){this.NeedsMergeBodyNode=!1,this.transparentBodyChanged=!0,this.ResetBodyFlagFromFirst(),this.getAllTransparentBodies(!1)},t.dirtyMergedNodeFalseBoundingBox=function(e){!1===e.IsMergedNode&&e.__setBoundingBoxDirty__();for(var t=Fi(e.children);!(r=t()).done;){var r=r.value;this.dirtyMergedNodeFalseBoundingBox(r)}},t.ResetBodyFlagFromFirst=function(){if(this.rootBodyNode){for(var e=[this.rootBodyNode],t=[],r=0;r<e.length;++r){var i=e[r];0<i.children.length&&!i.unload&&"Part"===i.type&&"Body"===i.children[0].type&&t.push(i);for(var n=0,a=i.children.length;n<a;++n)"Part"!==i.children[n].type&&"Assembly"!==i.children[n].type||e.push(i.children[n])}for(r=0;r<t.length;r++)for(var o=t[r],s=o.FirstVisibleNode||0,l=o.children[s],n=s+1;n<o.children.length;n++)!o.children[n].unload&&l.leafBodyAttri&&(o.children[n]._leafBodyAttri.bodyFlag=l._leafBodyAttri.bodyFlag)}},e}(ee),Wi=function(t){function e(e,d,r){var c;return void 0===r&&(r={}),(c=t.call(this,e,r.proxyName,r)||this).isProxyModel=!0,c.hasRefModel=!0,c.handelUnloadState=function(){c.nodeRequestor.addRequest(c.modelUri,1e5,"loadModelData",{modelId:c.id,urls:d,keepSourceFile:c.keepSourceFile,type:c.type,isProxy:!0});for(var t=c,l=(c.rootBodyNode=new _e,c.rootBodyNode.name=r.proxyName,(c.rootBodyNode.ndsModel=c).rootBodyNode.uuid=THREE.Math.generateUUID(),c.rootBodyNode.type="Assembly",c.rootBodyNode.objectid="proxy_root",c.viewer.loadParams.get("proxy")),e=(c.isSketchModel&&!l&&c.viewer.loadParams.get(c.parentModel.modelUri).forEach(function(e){t.parentModel.id==e.modelId&&(l=e)}),0);e<d.length;e++)!function(t){var e=new _e,r=(e.uuid=THREE.Math.generateUUID(),e.objectid="p_"+t,e.type="Assembly",null);if(!c.isSketchModel&&(l.modelInfos.forEach(function(e){d[t]==e.url&&(r=e)}),r)){var i=new THREE.Vector3(0,0,0),n=new THREE.Quaternion,a=new THREE.Vector3(1,1,1);if(r.matrix)e.matrix=r.matrix.concat();else if(r.position||r.rotation||r.scale){r.position&&(i.x=r.position.x,i.y=r.position.y,i.z=r.position.z),r.rotation&&n.setFromEuler(new THREE.Euler(r.rotation.x,r.rotation.y,r.rotation.z)),r.scale&&(a.x=r.scale.x,a.y=r.scale.y,a.z=r.scale.z),e.matrix||(e.matrix=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]));var o=new THREE.Matrix4;o.compose(i,n,a);for(var s=0;s<16;++s)e.matrix[s]=o.elements[s]}null!=r.visible&&null!=r.visible&&(e.visible=r.visible)}e.refModelUri=d[t].substr(0,d[t].lastIndexOf("/")),e.configName=d[t].substr(d[t].lastIndexOf("/")+1),c.rootBodyNode.children.push(e),e.parent=c.rootBodyNode}(e);c.state=ee.StateType.CONTENT_LOADING},c}return Ni(e,t),e}(zi);function Xi(e,t){return(Xi=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}Ce.RENDER2D={MESH:1,MESH_MAP:2,LINE:3,LINE_MESH:4,LINE_WORLD:5,LINE_LT_MESH:6,LINE_LT_LINE:7,LINE_LT_POINT:8,POINT:11,TEXT_TTF:9,TEXT_SHX:10};var qi=function(r){function e(e){var t=r.call(this)||this;return t.ndsModel=e,t.meshManager=e.meshManager,t.bodyNodes=[],t.meshId2BodyId=[],t.meshMaterial=[],t._max_mesh_size_=0,t._avg_mesh_size_=0,t._min_mesh_size_=9999999,t.needsUpdate=!0,t.matrixSets=new Set,t.meshes=[],t.opaqueMeshes=[],t.mapMeshes=[],t.transparentMeshes=[],t.meshCount=0,t.meshOffset=0,t.lines=[],t.drawingLines=[],t.lineCount=0,t.lineOffset=0,t.points=[],t.drawPoints=[],t.pointCount=0,t.pointOffset=0,t.texts=[],t.ttfTexts=[],t.shxTexts=[],t.drawTTFTexts=[],t.drawSHXTexts=[],t.textCount=0,t.textOffset=0,t.ttfCount=0,t.shxCount=0,t.ltMeshs=[],t.ltLines=[],t.ltPoints=[],t.line2Meshes=[],t.line2Worlds=[],t.meshInstanceMap=new Map,t.lineInstanceMap=new Map,t.pointInstanceMap=new Map,t.ttfInstanceMap=new Map,t.shxInstanceMap=new Map,t.isGeometryLoaded=!1,t.opaqueDrawCount=0,t.transparentDrawCount=0,t.mapMeshDrawCount=0,t.lineDrawCount=0,t.ttfTextDrawCount=0,t.shxTextDrawCount=0,t.pointDrawCount=0,t.ltMeshDrawCount=0,t.ltLineDrawCount=0,t.ltPointDrawCount=0,t.line2MeshDrawCount=0,t.line2WorldDrawCount=0,t}t=r,(i=e).prototype=Object.create(t.prototype),Xi(i.prototype.constructor=i,t);var t,i=e.prototype;return i.isLoaded=function(){if(this.isGeometryLoaded)return!0;if(0<this.meshes.length){var e=this.meshManager.geomId[this.meshes[0]],e=this.meshManager.geomManager.getGeomFromId(e);if(e&&e.loaded)return this.isGeometryLoaded=!0}if(0<this.lines.length){e=this.meshManager.lineSegGeomId[this.lines[0]],e=this.meshManager.geomManager.getGeomFromId(e);if(e&&e.loaded)return this.isGeometryLoaded=!0}if(0<this.points.length){e=this.meshManager.lineSegGeomId[this.points[0]],e=this.meshManager.geomManager.getGeomFromId(e);if(e&&e.loaded)return this.isGeometryLoaded=!0}if(0===this.meshes.length&&0===this.lines.length&&0==this.points.length&&0<this.texts.length){e=this.meshManager.textGeomId[this.texts[0]],e=this.meshManager.geomManager.getGeomFromId(e);if(e&&e.loaded)return this.isGeometryLoaded=!0}return!1},i.init=function(e){if(this.meshCount=this.meshes.length,this.lineCount=this.lines.length,this.pointCount=this.points.length,this.ttfCount=this.ttfTexts.length,this.shxCount=this.shxTexts.length,this.texts=this.ttfTexts.concat(this.shxTexts),this.textCount=this.texts.length,!e){for(var e=function(e,r){e.forEach(function(e,t){e=new Int32Array(2*e),e=new THREE.InstancedBufferAttribute(e,2);e.needsUpdate=!0,r.set(t,e)}),e.clear()},t=function(e,t){var r=1;e.has(t)&&(r+=e.get(t)),e.set(t,r)},r=new Map,i=this.meshManager,n=0,a=this.getNumMeshes();n<a;++n){var o=this.getMeshId(n);t(r,i.geomManager.getGeomFromId(i.geomId[o]).uuid)}e(r,this.meshInstanceMap);for(var s=0,l=this.getNumLineSegments();s<l;++s){var d=this.getLineSegmentsId(s);t(r,i.geomManager.getGeomFromId(i.lineSegGeomId[d]).uuid)}e(r,this.lineInstanceMap);for(var c=0,h=this.getNumPoints();c<h;++c){var u=this.getPointId(c);t(r,i.geomManager.getGeomFromId(i.lineSegGeomId[u]).uuid)}e(r,this.pointInstanceMap);for(var p=0,f=this.getNumTTFTexts();p<f;++p){var m=this.getTTFTextId(p);t(r,i.geomManager.getGeomFromId(i.textGeomId[m]).uuid)}e(r,this.ttfInstanceMap);for(var g=0,v=this.getNumSHXTexts();g<v;++g){var y=this.getSHXTextId(g);t(r,i.geomManager.getGeomFromId(i.textGeomId[y]).uuid)}e(r,this.shxInstanceMap)}},i.setDirty=function(){this.visualStates.dirty=!0,this.visualStates.visible=!0,this.opaqueDrawCount=0,this.transparentDrawCount=0,this.mapMeshDrawCount=0,this.lineDrawCount=0,this.ttfTextDrawCount=0,this.shxTextDrawCount=0,this.pointDrawCount=0,this.ltMeshDrawCount=0,this.ltLineDrawCount=0,this.ltPointDrawCount=0,this.line2MeshDrawCount=0,this.line2WorldDrawCount=0},i.prepareForBatchDraw=function(){if(this.visualStates.dirty&&this.needsUpdate){for(var e=new THREE.Matrix4,t=this.meshManager,r=this.ndsModel,i=0,n=this.getNumMeshes();i<n;++i){var a=this.getMeshId(i),o=t.getMeshInfor(a,{},!1,!1),s=r.meshState.getMeshMaterial(a);o.material=s.material,o.localIndex=i,o.hasMap=!!o.material.map,e.fromArray(t.matrixes,16*t.matrixId[a]),o.box=o.geometry.boundingBox.clone().applyMatrix4(e),o.hasMap&&(this.mapMeshes[this.mapMeshes.length]=o),this.opaqueMeshes[this.opaqueMeshes.length]=o}for(var l=0,d=this.getNumLineSegments();l<d;++l){var c=this.getLineSegmentsId(l),h=t.getLineSegmentsInfor(c,{},!1,!1);h.material=r.meshState.getLineMaterial(c),h.localIndex=l,e.fromArray(t.matrixes,16*t.lineSegMatrixId[c]),h.box=h.geometry.boundingBox.clone().applyMatrix4(e),this.drawingLines[this.drawingLines.length]=h}for(var u=0,p=this.getNumPoints();u<p;++u){var f=this.getPointId(u),m=t.getLineSegmentsInfor(f,{},!1,!1);m.material=r.meshState.getPointMaterial(f),m.localIndex=u,e.fromArray(t.matrixes,16*t.lineSegMatrixId[f]),m.box=m.geometry.boundingBox.clone().applyMatrix4(e),this.drawPoints[this.drawPoints.length]=m}for(var g=0,v=this.getNumTTFTexts();g<v;++g){var y=this.getTTFTextId(g),A=t.getTextInfo(y,{},!1,!1);A.material=r.meshState.getTextMaterial(y),A.localIndex=g,e.fromArray(t.matrixes,16*t.textMatrixId[y]),A.box=A.geometry.boundingBox.clone().applyMatrix4(e),this.drawTTFTexts[this.drawTTFTexts.length]=A}for(var M=0,E=this.getNumSHXTexts();M<E;++M){var w=this.getSHXTextId(M),x=t.getTextInfo(w,{},!1,!1);x.material=r.meshState.getTextMaterial(w),x.localIndex=this.ttfCount+M,e.fromArray(t.matrixes,16*t.textMatrixId[w]),x.box=x.geometry.boundingBox.clone().applyMatrix4(e),this.drawSHXTexts[this.drawSHXTexts.length]=x}this.needsUpdate=!1}},i.fetchOpaqueForDraw=function(e,t,r){void 0===r&&(r=-1);for(var i=0,n=0,a=0;;++n){var o=n+this.opaqueDrawCount;if(o>=this.opaqueMeshes.length||r<=n)break;o=this.opaqueMeshes[o];o.bodyNode.isHidden()||o.hasMap||(e[a++]=o),++i}this.opaqueDrawCount+=i},i.fetchTransparentForDraw=function(e,t,r){void 0===r&&(r=-1);for(var i=0,n=0,a=0;;++n){var o=n+this.transparentDrawCount;if(o>=this.transparentMeshes.length||r<=n||0<=t&&o>=this.transparentLevelEnd[t])break;o=this.transparentMeshes[o];o.bodyNode.isHidden()||(e[a++]=o),++i}this.transparentDrawCount+=i},i.fetchMapMeshForDraw=function(e,t){void 0===t&&(t=-1);for(var r=0,i=0,n=0;i<t&&!(i+this.mapMeshDrawCount>=this.mapMeshes.length);++i){var a=this.mapMeshes[i+this.mapMeshDrawCount];a.bodyNode.isHidden()||(e[n++]=a),++r}this.mapMeshDrawCount+=r},i.fetchLineForDraw=function(e,t){void 0===t&&(t=-1);for(var r=0,i=0,n=0;i<t&&!(i+this.lineDrawCount>=this.drawingLines.length);++i){var a=this.drawingLines[i+this.lineDrawCount];a.bodyNode.isHidden()||999===a.material.linewidth||(e[n++]=a),++r}this.lineDrawCount+=r},i.fetchPointForDraw=function(e,t){void 0===t&&(t=-1);for(var r=0,i=0,n=0;i<t&&!(i+this.pointDrawCount>=this.drawPoints.length);++i){var a=this.drawPoints[i+this.pointDrawCount];a.bodyNode.isHidden()||(e[n++]=a),++r}this.pointDrawCount+=r},i.fetchTTFTextForDraw=function(e,t){void 0===t&&(t=-1);for(var r=0,i=0,n=0;i<t&&!(i+this.ttfTextDrawCount>=this.drawTTFTexts.length);++i){var a=this.drawTTFTexts[i+this.ttfTextDrawCount];a.bodyNode.isHidden()||3<this.ndsModel.viewer.modelContentVersion&&!a.geometry.textWireFrame||(e[n++]=a),++r}this.ttfTextDrawCount+=r},i.fetchSHXTextForDraw=function(e,t){void 0===t&&(t=-1);for(var r=0,i=0,n=0;i<t&&!(i+this.shxTextDrawCount>=this.drawSHXTexts.length);++i){var a=this.drawSHXTexts[i+this.shxTextDrawCount];a.bodyNode.isHidden()||(e[n++]=a),++r}this.shxTextDrawCount+=r},i.fetchLTMeshForDraw=function(e,t){void 0===t&&(t=-1);for(var r=0,i=0,n=0;i<t&&!(i+this.ltMeshDrawCount>=this.ltMeshs.length);++i){var a=this.ltMeshs[i+this.ltMeshDrawCount],o=this.drawingLines[a.drawingIndex];o.bodyNode.isHidden()||(a.material=o.material,e[n++]=a),++r}this.ltMeshDrawCount+=r},i.fetchLTLineForDraw=function(e,t){void 0===t&&(t=-1);for(var r=0,i=0,n=0;i<t&&!(i+this.ltLineDrawCount>=this.ltLines.length);++i){var a=this.ltLines[i+this.ltLineDrawCount],o=this.drawingLines[a.drawingIndex];o.bodyNode.isHidden()||(a.material=o.material,e[n++]=a),++r}this.ltLineDrawCount+=r},i.fetchLTPointForDraw=function(e,t){void 0===t&&(t=-1);for(var r=0,i=0,n=0;i<t&&!(i+this.ltPointDrawCount>=this.ltPoints.length);++i){var a=this.ltPoints[i+this.ltPointDrawCount],o=this.drawingLines[a.drawingIndex];o.bodyNode.isHidden()||(a.material=o.material,e[n++]=a),++r}this.ltPointDrawCount+=r},i.fetchLine2MeshForDraw=function(e,t){void 0===t&&(t=-1);for(var r=0,i=0,n=0;i<t&&!(i+this.line2MeshDrawCount>=this.line2Meshes.length);++i){var a=this.line2Meshes[i+this.line2MeshDrawCount],o=this.drawingLines[a.drawingIndex];o.bodyNode.isHidden()||(a.material=o.material,e[n++]=a),++r}this.line2MeshDrawCount+=r},i.fetchLine2WorldForDraw=function(e,t,r){void 0===r&&(r=-1);for(var i=0,n=0,a=0;n<r&&!(n+this.line2WorldDrawCount>=this.line2Worlds.length);++n){var o=this.line2Worlds[n+this.line2WorldDrawCount],s=this.drawingLines[o.drawingIndex];s.bodyNode.isHidden()||(o.material=s.material,e[a]=o,t[a++]=s),++i}this.line2WorldDrawCount+=i},i.needAllMeshSetDraw=function(e){if(this.needsUpdate)return!0;if("line"==e){if(this.lineDrawCount<this.drawingLines.length)return!0}else if("opaque"==e){if(this.opaqueDrawCount<this.opaqueMeshes.length)return!0}else if("ttf"==e){if(this.ttfTextDrawCount<this.drawTTFTexts.length)return!0}else if("shx"==e){if(this.shxTextDrawCount<this.drawSHXTexts.length)return!0}else if("point"==e){if(this.pointDrawCount<this.drawPoints.length)return!0}else if("ltMesh"==e){if(this.ltMeshDrawCount<this.ltMeshs.length)return!0}else if("ltLine"==e){if(this.ltLineDrawCount<this.ltLines.length)return!0}else if("ltPoint"==e){if(this.ltPointDrawCount<this.ltPoints.length)return!0}else if("line2Mesh"==e){if(this.line2MeshDrawCount<this.line2Meshes.length)return!0}else if("line2World"==e){if(this.line2WorldDrawCount<this.line2Worlds.length)return!0}else if("mapMesh"==e&&this.mapMeshDrawCount<this.mapMeshes.length)return!0;return!1},i.drawAllMeshSet=function(e){return"line"==e?this.lineDrawCount>=this.drawingLines.length:"opaque"==e?this.opaqueDrawCount>=this.opaqueMeshes.length:"ttf"==e?this.ttfTextDrawCount>=this.drawTTFTexts.length:"shx"==e?this.shxTextDrawCount>=this.drawSHXTexts.length:"point"==e?this.pointDrawCount>=this.drawPoints.length:"ltMesh"==e?this.ltMeshDrawCount>=this.ltMeshs.length:"ltLine"==e?this.ltLineDrawCount>=this.ltLines.length:"ltPoint"==e?this.ltPointDrawCount>=this.ltPoints.length:"line2Mesh"==e?this.line2MeshDrawCount>=this.line2Meshes.length:"line2World"==e?this.line2WorldDrawCount>=this.line2Worlds.length:"mapMesh"!=e||this.mapMeshDrawCount>=this.mapMeshes.length},i.getMeshWorldMatrix=function(e,t){e=this.ndsModel.meshId2BodyIdBuffer[this.meshOffset+e];t.fromArray(this.bodyNodeWorldMatrixBuffer,16*(this.bodyWorldMatrixOffset+e))},i.getLineWorldMatrix=function(e,t){e=this.ndsModel.lineId2BodyIdBuffer[this.lineOffset+e];t.fromArray(this.bodyNodeWorldMatrixBuffer,16*(this.bodyWorldMatrixOffset+e))},i.getPointWorldMatrix=function(e,t){e=this.ndsModel.pointId2BodyIdBuffer[this.pointOffset+e];t.fromArray(this.bodyNodeWorldMatrixBuffer,16*(this.bodyWorldMatrixOffset+e))},i.getTextWorldMatrix=function(e,t){e=this.ndsModel.textId2BodyIdBuffer[this.textOffset+e];t.fromArray(this.bodyNodeWorldMatrixBuffer,16*(this.bodyWorldMatrixOffset+e))},i.sortMeshes=function(e){},i.isAllMeshHidden=function(){return!1},i.isVisible=function(){return!0},i.getNumMeshes=function(){return this.meshCount},i.getMesh=function(e){},i.getMeshId=function(e){return this.meshes[e]},i.includeTexts=function(){},i.getNumTexts=function(){},i.getTextId=function(){},i.getText=function(e){},i.getNumTTFTexts=function(){return this.ttfCount},i.getTTFTextId=function(e){return this.ttfTexts[e]},i.getNumSHXTexts=function(){return this.shxCount},i.getSHXTextId=function(e){return this.shxTexts[e]},i.getNumPoints=function(){return this.pointCount},i.getPointId=function(e){return this.points[e]},i.includeLineSegments=function(){},i.getNumLineSegments=function(){return this.lineCount},i.getLineSegmentsId=function(e){return this.lines[e]},i.getLineSegmentsWithState=function(e,t,r){void 0===t&&(t=!1)},i.getLineSegments=function(e,t,r){void 0===t&&(t=!1)},i.intersect=function(e,t){},e}(nt);function Yi(e,t){return(Yi=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}var Qi=function(t){function e(e){e=t.call(this,e)||this;return e.textMtls=new Map,e.textMtlTexture=null,e.textMtlBuffer=null,e.textMtlTexSize=0,e.pointMtls=new Map,e.pointMtlTexture=null,e.pointMtlBuffer=null,e.pointMtlTexSize=0,e.extraMtlTexture=null,e.extraMtlBuffer=null,e.extraMtlTexSize=0,e.extraMtlLineCount=0,e.viewBoxList=[],e._changedFlag=16777216,e._selectLineColor=De.selectedColor.getHex()|e._changedFlag,e._selectMeshColor=De.selectedFace2DMaterial.color.getHex()|e._changedFlag,e}r=t,(i=e).prototype=Object.create(r.prototype),Yi(i.prototype.constructor=i,r);var r,i=e.prototype;return i.createTexture=function(e,t){var r=2===t?THREE.RGFormat:1===t?THREE.RedFormat:THREE.RGBAFormat,e=Math.ceil(Math.log2(e)),e=Math.pow(2,Math.ceil(e/2)),t=new Float32Array(e*e*t),r=new THREE.DataTexture(t,e,e,r,THREE.FloatType);return r.needsUpdate=!0,[e,t,r]},i.setViewportList=function(e){this.viewBoxList=e},i.update=function(){if(this.needsMtlCacheUpdate){if(this.needsMtlCacheUpdate=!1,!this.meshMtlTexture){for(var e=this.createTexture(this.meshMtls.size,4),t=(this.meshMtlTexSize=e[0],this.meshMtlBuffer=e[1],this.meshMtlTexture=e[2],this.ndsModel.meshSets),r=0;r<t.length;r++)for(var i=t[r],n=0;n<i.meshCount;n++){var a=i.meshOffset+n,o=this.meshMtls.get(i.meshes[n]),a=4*(o.meshMtlIndex=a);this.meshMtlBuffer[a]=0,this.meshMtlBuffer[1+a]=o.material.color.hex,this.meshMtlBuffer[2+a]=Math.round(1e3*o.material.opacity),this.meshMtlBuffer[3+a]=o.material.hatchId}this.meshMtlTexture.needsUpdate=!0}if(!this.lineMtlTexture){for(var e=this.createTexture(this.lineMtls.size,4),s=(this.lineMtlTexSize=e[0],this.lineMtlBuffer=e[1],this.lineMtlTexture=e[2],this.ndsModel.meshSets),l=0;l<s.length;l++)for(var d=s[l],c=0;c<d.lineCount;c++){var h=d.lineOffset+c,u=this.lineMtls.get(d.lines[c]),h=4*(u.lineMtlIndex=h);this.lineMtlBuffer[h]=u.color,this.lineMtlBuffer[1+h]=Math.round(1e3*u.opacity),this.lineMtlBuffer[2+h]=u.lineTypeId,this.lineMtlBuffer[3+h]=u.lineScale}this.lineMtlTexture.needsUpdate=!0}if(!this.pointMtlTexture){for(var e=this.createTexture(this.pointMtls.size,4),p=(this.pointMtlTexSize=e[0],this.pointMtlBuffer=e[1],this.pointMtlTexture=e[2],this.ndsModel.meshSets),f=0;f<p.length;f++)for(var m=p[f],g=0;g<m.pointCount;g++){var v=m.pointOffset+g,y=this.pointMtls.get(m.points[g]),v=4*(y.pointMtlIndex=v);this.pointMtlBuffer[v]=y.color,this.pointMtlBuffer[1+v]=Math.round(1e3*y.opacity),this.pointMtlBuffer[2+v]=-1}this.pointMtlTexture.needsUpdate=!0}if(!this.textMtlTexture){for(var e=this.createTexture(this.textMtls.size,4),A=(this.textMtlTexSize=e[0],this.textMtlBuffer=e[1],this.textMtlTexture=e[2],this.ndsModel.meshSets),M=0;M<A.length;M++)for(var E=A[M],w=0;w<E.textCount;w++){var x=E.textOffset+w,b=this.textMtls.get(E.texts[w]),x=4*(b.textMtlIndex=x);this.textMtlBuffer[x]=b.color,this.textMtlBuffer[1+x]=Math.round(1e3*b.opacity),this.textMtlBuffer[2+x]=b.viewportId}this.textMtlTexture.needsUpdate=!0}if(!this.extraMtlTexture){var B,I,T=this.ndsModel.lineTypes?this.ndsModel.lineTypes.lineTypeStyle.length:0,S=this.viewBoxList.length,e=this.ndsModel.viewer.hatchTypes?this.ndsModel.viewer.hatchTypes.size:0,R=16*(T+Math.max(S+e)),R=this.createTexture(Math.max(R,256),1);if(this.extraMtlTexSize=R[0],this.extraMtlBuffer=R[1],this.extraMtlTexture=R[2],0<(this.extraMtlLineCount=T))for(var O=this.ndsModel.lineTypes.lineTypeStyle,C=0;C<T;C++){var D=O[C],F=Math.min(14,D.array.length);this.extraMtlBuffer[16*D.index+0]=D.pattern,this.extraMtlBuffer[16*D.index+1]=F;for(var P=0;P<F;P++)this.extraMtlBuffer[16*D.index+2+P]=D.array[P]}if(0<S)for(var H=T,_=0;_<S;_++){var L=this.viewBoxList[_];this.extraMtlBuffer[16*(H+_)+0]=L.min2.x,this.extraMtlBuffer[16*(H+_)+1]=L.min2.y,this.extraMtlBuffer[16*(H+_)+2]=L.max2.x,this.extraMtlBuffer[16*(H+_)+3]=L.max2.y}0<e&&(B=T,(I=this).ndsModel.viewer.hatchTypes.forEach(function(e,t){var r=e.hatchId,e=e.hatchType;e.invert?(I.extraMtlBuffer[16*(B+r)+4]=parseInt(e.sColor),I.extraMtlBuffer[16*(B+r)+5]=parseInt(e.mColor)):(I.extraMtlBuffer[16*(B+r)+4]=parseInt(e.mColor),I.extraMtlBuffer[16*(B+r)+5]=parseInt(e.sColor)),I.extraMtlBuffer[16*(B+r)+6]=e.type,I.extraMtlBuffer[16*(B+r)+7]=e.shift,I.extraMtlBuffer[16*(B+r)+8]=e.params||0})),this.extraMtlTexture.needsUpdate=!0}}},i.setMeshMaterial=function(e,t,r){t&&(t.packColor=r?this._selectMeshColor:t.color.hex);var i=this.meshMtls.get(e);i?t&&(i.material=t):this.meshMtls.set(e,{globalIndex:0,material:t,faceMaterial:[]}),this.meshMtlTexture&&(e=4*i.meshMtlIndex,this.meshMtlBuffer[e]=r?2:0,this.meshMtlBuffer[1+e]=i.material.color.hex,this.meshMtlBuffer[2+e]=Math.round(1e3*i.material.opacity),this.meshMtlTexture.needsUpdate=!0)},i.getMeshMaterial=function(t){var r=this.meshMtls.get(t);return r?(r.material.colors&&r.material.colors.forEach(function(e){e.meshId===t&&(r.material.color.copy(e.value),r.material.needsUpdate=!0,r.material.needsRefresh=!0)}),r):null},i.changeMeshMaterial=function(e,t){e=this.meshMtls.get(e);if(!e)return null;e.material.packColor=void 0===t?e.material.color.hex:t|this._changedFlag},i.setLineMaterial=function(e,t,r,i,n,a,o){void 0===t&&(t=0),void 0===r&&(r=1),void 0===i&&(i=-1),void 0===n&&(n=1),void 0===a&&(a=1);var s=this.lineMtls.get(e);s?(null!=t&&(s.color=t,s.packColor=o?this._selectLineColor:t),null!=r&&(s.opacity=r)):this.lineMtls.set(e,{color:t||0,opacity:r||1,lineTypeId:i,lineScale:n||1,linewidth:a,packColor:o?this._selectLineColor:t}),this.lineMtlTexture&&(e=4*s.lineMtlIndex,this.lineMtlBuffer[e]=s.color,this.lineMtlBuffer[1+e]=Math.round(1e3*s.opacity),this.lineMtlTexture.needsUpdate=!0)},i.getLineMaterial=function(e){e=this.lineMtls.get(e);return e||null},i.changeLineMaterial=function(e,t){e=this.lineMtls.get(e);if(!e)return null;e.packColor=void 0===t?e.color:t|this._changedFlag},i.setTextMaterial=function(e,t,r,i,n){void 0===t&&(t=0),void 0===r&&(r=1),void 0===i&&(i=-1);var a=this.textMtls.get(e);a?(null!=t&&(a.color=t,a.packColor=n?this._selectLineColor:t),null!=r&&(a.opacity=r)):this.textMtls.set(e,{color:t||0,opacity:r||1,viewportId:i,packColor:n?this._selectLineColor:t}),this.textMtlTexture&&(e=4*a.textMtlIndex,this.textMtlBuffer[e]=a.color,this.textMtlBuffer[1+e]=Math.round(1e3*a.opacity),this.textMtlTexture.needsUpdate=!0)},i.getTextMaterial=function(e){e=this.textMtls.get(e);return e||null},i.changeTextMaterial=function(e,t){e=this.textMtls.get(e);if(!e)return null;e.packColor=void 0===t?e.color:t|this._changedFlag},i.setPointMaterial=function(e,t,r,i){void 0===t&&(t=0),void 0===r&&(r=1);var n=this.pointMtls.get(e);n?(null!=t&&(n.color=t,n.packColor=i?this._selectLineColor:t),null!=r&&(n.opacity=r)):this.pointMtls.set(e,{color:t||0,opacity:r||1,packColor:i?this._selectLineColor:t}),this.pointMtlTexture&&(e=4*n.pointMtlIndex,this.pointMtlBuffer[e]=n.color,this.pointMtlBuffer[1+e]=Math.round(1e3*n.opacity),this.pointMtlTexture.needsUpdate=!0)},i.getPointMaterial=function(e){e=this.pointMtls.get(e);return e||null},i.changePointMaterial=function(e,t){e=this.pointMtls.get(e);if(!e)return null;e.packColor=void 0===t?e.color:t|this._changedFlag},e}(Oi);function Ki(e,t){var r,i="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(i)return(i=i.call(e)).next.bind(i);if(Array.isArray(e)||(i=function(e,t){{var r;if(e)return"string"==typeof e?Zi(e,t):"Map"===(r="Object"===(r={}.toString.call(e).slice(8,-1))&&e.constructor?e.constructor.name:r)||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?Zi(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length)return i&&(e=i),r=0,function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}};throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function Zi(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,i=Array(t);r<t;r++)i[r]=e[r];return i}function Ji(e,t){return(Ji=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}var $i=function(i){function e(e,t,r){(y=i.call(this,e,t,r=void 0===r?{}:r)||this).isMCAD2DModel=!0,y.typeName="MCAD2D",y.modelVisible=!0,y.needsPMI=void 0===r.needsPMI||r.needsPMI,y.needsSketchModel=void 0===r.needsSketchModel||r.needsSketchModel,y.meshState=new Qi(y),y.SDFMaker=new de(y.viewer.is2DModel),y.pmiObject=null,y.setDirty=function(){var t,r,i=void 0===y?this:y;return function(e){for(void 0===e&&(e=200),t=0,r=i.meshSets.length;t<r;++t)i.meshSets[t].setDirty();i.selectedBodiesDirty=!0,i.transparentBodiesDirty=!0,i.referenceEntityDirty=!0,i.lineSegmentsSet.dirty=!0,i.meshManager.dirty=!0,i.spriteDirty=!0}}(),y.handelUnloadState=function(){var e,t;y.refModel?(y.lineTypes=y.refModel.lineTypes,y.SDFMaker=y.refModel.SDFMaker,y.originModelBBox=y.refModel.originModelBBox.clone(),y.modelObjectsData=y.refModel.modelObjectsData,y.copyFrom(y.refModel),y.rootBodyNode.matrix=null,0===y.position.x&&0===y.position.y&&0===y.position.z&&0===y.rotation.x&&0===y.rotation.y&&0===y.rotation.z&&1===y.scale.x&&1===y.scale.y&&1===y.scale.z||(e=new THREE.Matrix4,t=(new THREE.Quaternion).setFromEuler(new THREE.Euler(y.rotation.x,y.rotation.y,y.rotation.z)),e.compose(y.position,t,y.scale),y.rootBodyNode.matrix&&((t=new THREE.Matrix4).fromArray(y.rootBodyNode.matrix),e=e.multiply(t)),y.updateNodeMatrix(y.rootBodyNode.uuid,e.elements),y.meshManager.reCalculateMeshBBox()),y.state=ee.StateType.PREPARED,y.createLineDistance(),y.createLineWidth(),y.createLineType(),y.createBlockBox()):i.prototype.handelUnloadState.call(y)},y.handleAllGeomLoadedState=function(){y.pmiObject&&(preparePMI(),y.viewer.addPMIObject(y.pmiObject)),y.createLineDistance(),y.createLineWidth(),y.createLineType(),y.createBlockBox(),i.prototype.handleAllGeomLoadedState.call(y)};var y,A=null;return y.refreshMeshState=function(e){if(e.useBodyNodeMaterial&&!A&&(A=e.uuid),0<e.children.length)for(var t=0;t<e.children.length;++t)y.refreshMeshState(e.children[t]);if(e.leafBodyAttri){for(var r=0<y.transparentizedBodies.length&&e.isTransparent(),i=null,n=e.getUserMaterial(),a=(n?(n.backMaterial||(n.backMaterial=n.clone(),n.backMaterial.transparent=!0,n.backMaterial.opacity=De.bodyOpacity,n.backoriMaterial=n.clone()),r?n=n.backMaterial:e.isOriginalTransparent()&&(n=n.backoriMaterial)):A&&((i=y.bodyNodeUUidToMaterial[A]).transparentMaterial||(i.transparentMaterial=i.clone(),i.transparentMaterial.transparent=!0,i.transparentMaterial.opacity=De.bodyOpacity),r)&&(i=i.transparentMaterial),e.isSelected()),o=e.leafBodyAttri.bodyMeshIds,s=e.leafBodyAttri.bodyLineSegIds,l=e.leafBodyAttri.bodyTextIds,d=0;d<o.length;++d){var c=null,h=y.meshManager.materialId[o[d]];h>=y.meshManager.mats.length/2&&(h-=y.meshManager.mats.length/2),c=y.meshManager.mats[h],n?(e.isOriginalTransparent()&&(n.transparent=c.transparent,n.opacity=c.opacity),c=n):i?c=i:r&&(c=y.meshManager.matsCopy[h]),y.meshState.setMeshMaterial(o[d],c,a)}for(var u=0;u<s.length;++u){var p=null,f=y.meshManager.lineSegMaterialId[s[u]],f=(f>=y.meshManager.mats.length/2&&(f-=y.meshManager.mats.length/2),p=y.meshManager.mats[f],y.meshManager.geomManager.getGeomFromId(y.meshManager.lineSegGeomId[s[u]]));f&&2==f.geomType?y.meshState.setPointMaterial(s[u],p.color.getHex(),a):y.meshState.setLineMaterial(s[u],p.color.getHex(),1,p.uniforms&&p.uniforms.lineTypeId?p.uniforms.lineTypeId.value:-1,p.uniforms&&p.uniforms.lineScale?p.uniforms.lineScale.value:1,p.linewidth&&1<p.linewidth?p.linewidth:1,a)}for(var m=0;m<l.length;++m){var g=null,v=y.meshManager.textMaterialId[l[m]],g=y.meshManager.mats[v],v=y.meshManager.geomManager.getGeomFromId(y.meshManager.textGeomId[l[m]]),v=v&&v.viewBox?v.viewBox.id:-1;y.meshState.setTextMaterial(l[m],g.color.getHex(),1,v,a)}}A===e.uuid&&(A=null)},y.changedMeshState=function(e){if(0<e.children.length)for(var t=0;t<e.children.length;++t)y.changedMeshState(e.children[t]);if(e.leafBodyAttri){for(var r=e.isSelected(),i=e.leafBodyAttri.bodyMeshIds,n=e.leafBodyAttri.bodyLineSegIds,a=e.leafBodyAttri.bodyTextIds,o=0;o<i.length;++o)y.meshState.changeMeshMaterial(i[o],r?y.meshState._selectMeshColor:void 0);for(var s=0;s<n.length;++s){var l=y.meshManager.geomManager.getGeomFromId(y.meshManager.lineSegGeomId[n[s]]);l&&2==l.geomType?y.meshState.changePointMaterial(n[s],r?y.meshState._selectLineColor:void 0):y.meshState.changeLineMaterial(n[s],r?y.meshState._selectLineColor:void 0)}for(var d=0;d<a.length;++d)y.meshState.changeTextMaterial(a[d],r?y.meshState._selectLineColor:void 0)}},y.handlePreparedState=function(){if(y.rootBodyNode.updateMatrixWorld(!1),y.meshVisibleNeedsUpdate||y.meshMtlNeedsUpdate){y.refreshMeshState(y.rootBodyNode),y.meshVisibleNeedsUpdate=!1,y.meshMtlNeedsUpdate=!1;for(var e=0;e<y.meshSets.length;++e)y.meshSets[e].needsUpdate=!0}},y}t=i,(r=e).prototype=Object.create(t.prototype),Ji(r.prototype.constructor=r,t);var t,r=e.prototype;return r.buildMeshSets=function(O){void 0===O&&(O=512),this.meshSets=[];var F=0,U=0,N=0,V=0,e=[];var G,k,j,t,z=this.geomManager.bufferChunk;for(G in z)if(z.hasOwnProperty(G)){var W=z[G].ndsGeometriesArray;if(W){for(var X=[],q=0,Y=W.length;q<Y;++q){for(var r=W[q],i={geom:r,meshIds:[],lineIds:[],pointIds:[],ttfIds:[],shxIds:[],matrixs:new Set,idx:0},n=0,Q=r.refMeshes.length;n<Q;++n)i.meshIds.push(r.refMeshes[n]),i.matrixs.add(this.meshManager.matrixId[r.refMeshes[n]]);for(var a=0,K=r.refLineSegs.length;a<K;++a)(2==r.geomType?i.pointIds:i.lineIds).push(r.refLineSegs[a]),i.matrixs.add(this.meshManager.lineSegMatrixId[r.refLineSegs[a]]);for(var o=0,Z=r.refTexts.length;o<Z;++o)if((r.isShx?i.shxIds:i.ttfIds).push(r.refTexts[o]),i.matrixs.add(this.meshManager.textMatrixId[r.refTexts[o]]),r.viewBox){for(var s=0;s<e.length;s++)if(k=r.viewBox,j=e[s],!(!k.max2.equals(j.max2)||!k.min2.equals(j.min2))){r.viewBox.id=s;break}s==e.length&&(e.push(r.viewBox),r.viewBox.id=s)}0<i.lineIds.length&&(i.idx=i.lineIds[0]),X.push(i)}for(var l=2*O,d=(this.meshSets.push(new qi(this)),this.meshSets[this.meshSets.length-1]),J=0;J<X.length;++J){var c=X[J];0!==d.matrixSets.size&&d.matrixSets.size+c.matrixs.size>=l&&(this.meshSets.push(new qi(this)),d=this.meshSets[this.meshSets.length-1]);for(var h=0;h<c.meshIds.length;h++)d.meshes.push(c.meshIds[h]),d.matrixSets.add(this.meshManager.matrixId[c.meshIds[h]]),d.matrixSets.size==l&&(this.meshSets.push(new qi(this)),d=this.meshSets[this.meshSets.length-1]);for(var u=0;u<c.lineIds.length;u++)d.lines.push(c.lineIds[u]),d.matrixSets.add(this.meshManager.lineSegMatrixId[c.lineIds[u]]),d.matrixSets.size==l&&(this.meshSets.push(new qi(this)),d=this.meshSets[this.meshSets.length-1]);for(var p=0;p<c.pointIds.length;p++)d.points.push(c.pointIds[p]),d.matrixSets.add(this.meshManager.lineSegMatrixId[c.pointIds[p]]),d.matrixSets.size==l&&(this.meshSets.push(new qi(this)),d=this.meshSets[this.meshSets.length-1]);for(var f=0;f<c.ttfIds.length;f++)d.ttfTexts.push(c.ttfIds[f]),d.matrixSets.add(this.meshManager.textMatrixId[c.ttfIds[f]]),d.matrixSets.size==l&&(this.meshSets.push(new qi(this)),d=this.meshSets[this.meshSets.length-1]);for(var m=0;m<c.shxIds.length;m++)d.shxTexts.push(c.shxIds[m]),d.matrixSets.add(this.meshManager.textMatrixId[c.shxIds[m]]),d.matrixSets.size==l&&(this.meshSets.push(new qi(this)),d=this.meshSets[this.meshSets.length-1]);F+=c.meshIds.length,U+=c.lineIds.length,N+=c.ttfIds.length+c.shxIds.length,V+=c.pointIds.length}}}if(0<F&&(t=Math.ceil(Math.log2(F)),t=Math.pow(2,Math.ceil(t/2)),this.meshId2BodyIdTexSize=t,this.meshId2BodyIdBuffer=new Uint32Array(this.meshId2BodyIdTexSize*this.meshId2BodyIdTexSize),this.meshId2BodyIdTexture=new THREE.DataTexture(this.meshId2BodyIdBuffer,this.meshId2BodyIdTexSize,this.meshId2BodyIdTexSize,THREE.RedIntegerFormat,THREE.UnsignedIntType),this.meshId2BodyIdTexture.needsUpdate=!0),0<U&&(t=Math.ceil(Math.log2(U)),t=Math.pow(2,Math.ceil(t/2)),this.lineId2BodyIdTexSize=t,this.lineId2BodyIdBuffer=new Uint32Array(this.lineId2BodyIdTexSize*this.lineId2BodyIdTexSize),this.lineId2BodyIdTexture=new THREE.DataTexture(this.lineId2BodyIdBuffer,this.lineId2BodyIdTexSize,this.lineId2BodyIdTexSize,THREE.RedIntegerFormat,THREE.UnsignedIntType),this.lineId2BodyIdTexture.needsUpdate=!0),0<V&&(t=Math.ceil(Math.log2(V)),t=Math.pow(2,Math.ceil(t/2)),this.pointId2BodyIdTexSize=t,this.pointId2BodyIdBuffer=new Uint32Array(this.pointId2BodyIdTexSize*this.pointId2BodyIdTexSize),this.pointId2BodyIdTexture=new THREE.DataTexture(this.pointId2BodyIdBuffer,this.pointId2BodyIdTexSize,this.pointId2BodyIdTexSize,THREE.RedIntegerFormat,THREE.UnsignedIntType),this.pointId2BodyIdTexture.needsUpdate=!0),0<N&&(t=Math.ceil(Math.log2(N)),t=Math.pow(2,Math.ceil(t/2)),this.textId2BodyIdTexSize=t,this.textId2BodyIdBuffer=new Uint32Array(this.textId2BodyIdTexSize*this.textId2BodyIdTexSize),this.textId2BodyIdTexture=new THREE.DataTexture(this.textId2BodyIdBuffer,this.textId2BodyIdTexSize,this.textId2BodyIdTexSize,THREE.RedIntegerFormat,THREE.UnsignedIntType),this.textId2BodyIdTexture.needsUpdate=!0),this.meshId2MeshSet=new Map,this.lineId2MeshSet=new Map,this.pointId2MeshSet=new Map,this.textId2MeshSet=new Map,this.viewer.renderer.mcad2dRenderer.supportLargeUniformBuffer){for(var $=function(){var e=new Ii,t=(e.dynamicBinding=!0,e.setName("bodyWorldMatrixData"),new Float32Array(16384));return e.add(new Bi(t)),e},g=[$()],ee=0,te=0,re=0,ie=0,v=0;v<this.meshSets.length;++v){for(var y=this.meshSets[v],A=(y.init(this.viewer.renderer.mcad2dRenderer.supportMultiDraw),0);A<g.length&&!(g[A].unUsedIndex+y.matrixSets.size<=1024);++A);A===g.length&&(g[A]=$()),y.bodyWorldMatrixUniformBlock=g[A],y.bodyWorldMatrixUniformBlock.needsUpdate=!0,y.bodyWorldMatrixOffset=g[A].unUsedIndex,y.bodyNodeWorldMatrixBuffer=g[A].dataBuffer;for(var ne,M=new Map,ae=0,oe=Ki(y.matrixSets);!(ne=oe()).done;){for(var se=ne.value,E=0;E<16;E++)y.bodyNodeWorldMatrixBuffer[16*(y.bodyWorldMatrixOffset+ae)+E]=this.meshManager.matrixes[16*se+E];M.set(se,ae),ae++}g[A].unUsedIndex+=y.matrixSets.size;for(var w=0;w<y.meshes.length;++w)this.meshId2BodyIdBuffer[ee+w]=M.get(this.meshManager.matrixId[y.meshes[w]]),this.meshId2MeshSet.set(y.meshes[w],[v,w]);y.meshOffset=ee,ee+=y.meshes.length;for(var x=0;x<y.lines.length;++x)this.lineId2BodyIdBuffer[te+x]=M.get(this.meshManager.lineSegMatrixId[y.lines[x]]),this.lineId2MeshSet.set(y.lines[x],[v,x]);y.lineOffset=te,te+=y.lines.length;for(var b=0;b<y.points.length;++b)this.pointId2BodyIdBuffer[re+b]=M.get(this.meshManager.lineSegMatrixId[y.points[b]]),this.pointId2MeshSet.set(y.points[b],[v,b]);y.pointOffset=re,re+=y.points.length;for(var B=0;B<y.texts.length;++B)this.textId2BodyIdBuffer[ie+B]=M.get(this.meshManager.textMatrixId[y.texts[B]]),this.textId2MeshSet.set(y.texts[B],[v,B]);y.textOffset=ie,ie+=y.texts.length}this.bodyWorldMatrixUniformBlocks=g}else{for(var I=256,le=I*I/4,de=function(){var e=new Float32Array(I*I*4),e=new THREE.DataTexture(e,I,I,THREE.RGBAFormat,THREE.FloatType);return e.unUsedIndex=0,e.needsUpdate=!0,e},T=[de()],ce=0,he=0,ue=0,pe=0,fe=0;fe<this.meshSets.length;++fe){for(var S=this.meshSets[fe],R=(S.init(),0);R<T.length&&!(T[R].unUsedIndex+S.matrixSets.size<=le);++R);R===T.length&&(T[R]=de()),S.bodyWorldMatrixUniformMap=T[R],S.bodyWorldMatrixUniformMapSize=I,S.bodyWorldMatrixOffset=T[R].unUsedIndex,S.bodyNodeWorldMatrixBuffer=T[R].source.data.data;for(var me,C=new Map,ge=0,ve=Ki(S.matrixSets);!(me=ve()).done;){for(var ye=me.value,D=0;D<16;D++)S.bodyNodeWorldMatrixBuffer[16*(S.bodyWorldMatrixOffset+ge)+D]=this.meshManager.matrixes[16*ye+D];C.set(ye,ge),ge++}T[R].unUsedIndex+=S.matrixSets.size;for(var P=0;P<S.meshes.length;++P)this.meshId2BodyIdBuffer[ce+P]=C.get(this.meshManager.matrixId[S.meshes[P]]);S.meshOffset=ce,ce+=S.meshes.length;for(var H=0;H<S.lines.length;++H)this.lineId2BodyIdBuffer[he+H]=C.get(this.meshManager.lineSegMatrixId[S.lines[H]]);S.lineOffset=he,he+=S.lines.length;for(var _=0;_<S.points.length;++_)this.pointId2BodyIdBuffer[ue+_]=C.get(this.meshManager.lineSegMatrixId[S.points[_]]);S.pointOffset=ue,ue+=S.points.length;for(var L=0;L<S.texts.length;++L)this.textId2BodyIdBuffer[pe+L]=C.get(this.meshManager.textMatrixId[S.texts[L]]);S.textOffset=pe,pe+=S.texts.length}this.bodyWorldMatrixUniformMaps=T}this.refreshMeshState(this.rootBodyNode),this.meshState.setViewportList(e),this.meshState.update()},r.attachBodyNode=function(e,t,r,i,n){return this.setRootBodyNode(t,r,i),this.rootBodyNode},r.addSelection=function(e){i.prototype.addSelection.call(this,e),this.changedMeshState(e)},r.removeSelection=function(e){i.prototype.removeSelection.call(this,e),this.changedMeshState(e)},r.clearSelection=function(){i.prototype.clearSelection.call(this),this.changedMeshState(this.rootBodyNode)},r.mergeNode=function(){},r.unmergeNode=function(){},r.createLineDistance=function(){if(this.viewer.allLoaded&&this.viewer.hasBrepInfo()){var e=performance.now(),t=new Map,r=this.viewer.ndsModel.activeModel.brepManager.brepInfos.edgeGroups;if(r&&0<r.length)for(var i,n=0;n<r.length;n++)r[n].circles&&(i=r[n].geomUUID,t.set(i,r[n]));if(0<t.size)for(var a=new Set,o=0;o<this.meshSets.length;o++)for(var s=this.meshSets[o],l=0;l<s.lines.length;l++){var d=s.lines[l],c=this.meshManager.lineSegMaterialId[d];if(c>=this.meshManager.mats.length/2&&(c-=this.meshManager.mats.length/2),(c=this.meshManager.mats[c])&&c.uniforms&&c.uniforms.lineTypeId){var h=this.meshManager.geomManager.getGeomFromId(this.meshManager.lineSegGeomId[d]);if(!a.has(h.uuid)){a.add(h.uuid);var u=h.index,p=h.attributes.position,f=h.attributes.lineDistance;if(h.index&&f){var m=f.itemSize,g=new THREE.Vector3,v=new THREE.Vector3,y=t.get(h.uuid);if(y&&y.circles)for(var A=0;A<y.circles.indexRanges.length;A+=2){var M=2*y.circles.indexRanges[A]+h.drawRange.start,E=2*y.circles.indexRanges[A+1]+1+h.drawRange.start;if(!(M<0||E<M)){for(var w=u.getX(M),x=u.getX(E),b=(g.fromBufferAttribute(p,w),v.fromBufferAttribute(p,x),g.equals(v)),B=0,I=M;I<=E;I+=2){var T,S=u.getX(I),R=u.getX(I+1);I!=M&&(T=f.array[R*m]-f.array[S*m],f.array[S*m]=B,f.array[R*m]=B+T),B=f.array[R*m]}for(var C=M;C<=E;C+=2){var D=u.getX(C),P=u.getX(C+1);f.array[D*m+1]=B,f.array[P*m+1]=B,b&&(f.array[D*m+2]=2,f.array[P*m+2]=2)}}}f.needsUpdate=!0,h.needsUpdate=!0}}}}this.logProcessTime("Create LineDistance:",e)}},r.createLineType=function(){var b;function B(e){return new(65535<=e?Uint32Array:256<=e?Uint16Array:Uint8Array)(e)}function I(e,t,r,i){var n=new THREE.BufferGeometry;return n.addAttribute("position",e),n.setIndex(t),n.drawRange.count=i,n.drawRange.start=r,n.needsUpdate=!0,n}function T(e,t,r){for(var i=t.length/6,n=B(3*i/2),a=0;a<i;a+=4)n[3*a/2+0]=a,n[3*a/2+1]=a+2,n[3*a/2+2]=a+1,n[3*a/2+3]=a+2,n[3*a/2+4]=a+3,n[3*a/2+5]=a+1;for(var o,s,l,d,c,h,u,p,t=new THREE.InterleavedBuffer(new Float32Array(t),6),f=new THREE.InterleavedBufferAttribute(t,3,0,!1),m=new THREE.InterleavedBufferAttribute(t,2,3,!1),g=new THREE.InterleavedBufferAttribute(t,1,5,!1),v=new THREE.BufferAttribute(n,1),y=0,A=0;A<r.length;A++)0<r[A].geom.mesh.length&&(o=r[A].geom.mesh.length/4,s=f,l=m,d=g,c=v,h=y,u=o,p=void 0,(p=new THREE.BufferGeometry).addAttribute("position",s),p.addAttribute("uv",l),p.addAttribute("textureid",d),p.setIndex(c),p.drawRange.count=u,p.drawRange.start=h,p.needsUpdate=!0,s=p,y+=o,e.ltMeshs.push({geometry:s,drawingIndex:r[A].localIndex,localIndex:r[A].localIndex}))}this.lineTypes&&(b=this,setTimeout(function(){for(var e=performance.now(),t=function(){var n=b.meshSets[x];if(0<n.lines.length){for(var a=[],o=[],p=[],e=function(){var s,l,e,d,t,c,h,u,r=n.lines[f],i=b.meshManager.lineSegMaterialId[r];i>=b.meshManager.mats.length/2&&(i-=b.meshManager.mats.length/2),(i=b.meshManager.mats[i])&&i.uniforms&&i.uniforms.lineTypeId&&(t=i.uniforms.lineTypeId.value,i=i.uniforms.lineScale.value,e=b.meshManager.geomManager.getGeomFromId(b.meshManager.lineSegGeomId[r]),0<(s=b.lineTypes.getLineStyleGeomInfoNew(e,t,i)).mesh.length||0<s.line.length||0<s.point.length)&&(3<b.viewer.modelContentVersion?s.mesh.forEach(function(e){o.push(e)}):s.mesh.forEach(function(e){p.push(e)}),s.line.forEach(function(e){o.push(e)}),s.point.forEach(function(e){o.push(e)}),a.push({geom:s,localIndex:f}),s.text)&&(e=(l=b.getMeshManager()).lineTypeUuid2ParamsMap,d=l.geomUuid2MeshPosMap,t=l.spliceTextRow,l.oriGeomUuid2MeshPosMap,i=l.geomUuid2MeshMtMap,c=l.lineStyleGeomUuid2MeshPosMap,h=e.get(s.lineTypeId))&&!d.has(s.lineTypeId)&&(u=(new THREE.Matrix4).fromArray(l.matrixes,16*l.lineSegMatrixId[r]).elements,i.set(s.lineTypeId,new THREE.Matrix4),t.push({uuid:s.lineTypeId,text:s.text,characterWidthHeight:h.characterWidthHeight,rectBearingY:h.rectBearingY||0,rectBearingX:h.rectBearingX||0,rectWidth:h.rectWidth,rectHeight:h.rectHeight}),h.vD.forEach(function(e){var t,r,i=[],n={x:u[12]+e.x,y:u[13]+e.y,z:0},a={x:u[12]+e.x+h.rectWidth,y:u[13]+e.y,z:0},o={x:u[12]+e.x+h.rectWidth,y:u[13]+e.y+h.rectHeight,z:0},e={x:u[12]+e.x,y:u[13]+e.y+h.rectHeight,z:0},i=(i.push(n,a,o,e),c.has(s.lineTypeId)?(a=l.geomUuid2MeshPosMap.get(s.lineTypeId).concat(i),c.set(s.lineTypeId,a)):c.set(s.lineTypeId,i),o=i,e=n,a=new THREE.Matrix4,t=new THREE.Vector3(e.x,e.y,e.z),(r=new THREE.Quaternion).setFromRotationMatrix(a),o.map(function(e){e=new THREE.Vector3(e.x,e.y,e.z);return e.sub(t),e.applyQuaternion(r),e.add(t),{x:e.x,y:e.y,z:e.z}}));d.has(s.lineTypeId)?(n=l.geomUuid2MeshPosMap.get(s.lineTypeId).concat(i),d.set(s.lineTypeId,n)):d.set(s.lineTypeId,i)}))},f=0;f<n.lines.length;f++)e();for(var t=n,r=o,i=a,s=r.length/3,l=B(s),d=0;d<s;d+=3)l[d+0]=d,l[d+1]=d+1,l[d+2]=d+2;for(var c,h,u=new THREE.BufferAttribute(new Float32Array(r),3,0,!1),m=new THREE.BufferAttribute(l,1),g=null,v=null,y=0,A=0;A<i.length;A++){if(0<i[A].geom.mesh.length&&3<b.viewer.modelContentVersion){var M=i[A].geom.mesh.length/3,E=I(u,m,y,M);g||(g=B(2*s),v=new THREE.BufferAttribute(g,1));for(var w=y;w<y+M;w+=3)g[2*w+0]=l[w+0],g[2*w+1]=l[w+1],g[2*w+2]=l[w+1],g[2*w+3]=l[w+2],g[2*w+4]=l[w+2],g[2*w+5]=l[w+0];E.textWireFrame=I(u,v,2*y,2*M),y+=M,t.ltMeshs.push({geometry:E,drawingIndex:i[A].localIndex,localIndex:i[A].localIndex})}0<i[A].geom.line.length&&(c=I(u,m,y,E=i[A].geom.line.length/3),y+=E,t.ltLines.push({geometry:c,drawingIndex:i[A].localIndex,localIndex:i[A].localIndex})),0<i[A].geom.point.length&&(h=I(u,m,y,c=i[A].geom.point.length/3),y+=c,t.ltPoints.push({geometry:h,drawingIndex:i[A].localIndex,localIndex:i[A].localIndex}))}0<p.length&&T(n,p,a)}},x=0;x<b.meshSets.length;x++)t();b.logProcessTime("Create LineType:",e)},0))},r.createLineWidth=function(){var x=this;setTimeout(function(){var e=performance.now(),t=new Map,r=0;for(var i,n=0;n<x.meshSets.length;n++){var a=x.meshSets[n];if(0<a.lines.length){for(var o=[],s=[],l=0;l<a.lines.length;l++){var d=a.lines[l],c=x.meshManager.lineSegMaterialId[d],h=(c>=x.meshManager.mats.length/2&&(c-=x.meshManager.mats.length/2),x.meshManager.mats[c]),u=x.meshManager.geomManager.getGeomFromId(x.meshManager.lineSegGeomId[d]),p=[];if(u&&h&&h.linewidth&&1<h.linewidth){var c=u.uuid+h.linewidth;if(t.has(c)){var d={geometry:t.get(c),count:u.drawRange.count/2,drawingIndex:l,localIndex:l};(999===h.linewidth?s:o).push(d)}else{for(var f,m,g=new THREE.Vector3,v=new THREE.Vector3,y=new THREE.Vector2,A=u.getAttribute("position"),M=u.getAttribute("uv"),E=u.getAttribute("lineDistance"),w=u.drawRange.start;w<u.drawRange.start+u.drawRange.count;w+=2)f=u.index.getX(w),m=u.index.getX(w+1),g.fromBufferAttribute(A,f),v.fromBufferAttribute(A,m),p.push(g.x,g.y,g.z,v.x,v.y,v.z),p.push(E.array[3*f],E.array[3*m],E.array[3*m+1],E.array[3*m+2]),M?(y.fromBufferAttribute(M,f),p.push(y.x),p.push(y.y)):(p.push(h.linewidth),p.push(h.linewidth));0<u.drawRange.count&&(d={geometry:(d=p,c=c,i=void 0,t.has(c)?t.get(c):(d=new THREE.InstancedInterleavedBuffer(new Float32Array(d),12,1),(i=new Xe).addAttribute("instanceStart",new THREE.InterleavedBufferAttribute(d,3,0,!1)),i.addAttribute("instanceEnd",new THREE.InterleavedBufferAttribute(d,3,3,!1)),i.addAttribute("instanceDistance",new THREE.InterleavedBufferAttribute(d,4,6,!1)),i.addAttribute("instanceWidth",new THREE.InterleavedBufferAttribute(d,2,10,!1)),i.needsUpdate=!0,i.LSKey=r++,t.set(c,i),i)),count:u.drawRange.count/2,drawingIndex:l,localIndex:l},(999===h.linewidth?s:o).push(d))}}}o.sort(function(e,t){return e.geometry.LSKey<t.geometry.LSKey}),s.sort(function(e,t){return e.geometry.LSKey<t.geometry.LSKey}),a.line2Meshes=o,a.line2Worlds=s}}x.logProcessTime("Create LineWidth:",e)},50)},r.createBlockBox=function(){var n;this.modelObjectsData&&(n=this.meshManager,this.modelObjectsData.processBox||(function e(t){var i;if(t.bbox.makeEmpty(),t.prims&&(i=new THREE.Box3,t.prims[0].forEach(function(e,t){var r=n.geomManager.getGeomFromId(n.geomId[t]),t=(new THREE.Matrix4).fromArray(n.matrixes,16*n.matrixId[t]),r=r.boundingBox.clone();r.applyMatrix4(t),i.union(r)}),t.prims[1].forEach(function(e,t){var r=n.geomManager.getGeomFromId(n.lineSegGeomId[t]),t=(new THREE.Matrix4).fromArray(n.matrixes,16*n.lineSegMatrixId[t]),r=r.boundingBox.clone();r.applyMatrix4(t),i.union(r)}),t.prims[2].forEach(function(e,t){var r=n.geomManager.getGeomFromId(n.lineSegGeomId[t]),t=(new THREE.Matrix4).fromArray(n.matrixes,16*n.lineSegMatrixId[t]),r=r.boundingBox.clone();r.applyMatrix4(t),i.union(r)}),t.prims[3].forEach(function(e,t){var r=n.geomManager.getGeomFromId(n.textGeomId[t]),t=(new THREE.Matrix4).fromArray(n.matrixes,16*n.textMatrixId[t]),r=r.boundingBox.clone();r.applyMatrix4(t),i.union(r)}),t.bbox.copy(i)),t.children)for(var r=0;r<t.children.length;r++)e(t.children[r]),t.bbox.union(t.children[r].bbox)}(this.modelObjectsData),this.modelObjectsData.processBox=!0))},r.logProcessTime=function(e,t){t=((performance.now()-t)/1e3).toFixed(2);console.log(e," ",t)},e}(ee);function en(e,t){var r,i="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(i)return(i=i.call(e)).next.bind(i);if(Array.isArray(e)||(i=function(e,t){{var r;if(e)return"string"==typeof e?tn(e,t):"Map"===(r="Object"===(r={}.toString.call(e).slice(8,-1))&&e.constructor?e.constructor.name:r)||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?tn(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length)return i&&(e=i),r=0,function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}};throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function tn(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,i=Array(t);r<t;r++)i[r]=e[r];return i}function rn(e,t){return(rn=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}var nn=function(y){function e(e,t,r){var i;return(i=y.call(this,e,t,r=void 0===r?{}:r)||this).isECAD2DModel=!0,i.isMCAD3DModel=!1,i.typeName="ECAD2D",i.__nets__=new Map,i.__layers__=new Map,i.__typedObjects__=new Map,i.getNets=function(){return i.__nets__},i.getLayers=function(){return i.__layers__},i.getTypedObjects=function(){return i.__typedObjects__},i}t=y,(r=e).prototype=Object.create(t.prototype),rn(r.prototype.constructor=r,t);var t,r=e.prototype;return r.buildMeshSets=function(e){void 0===e&&(e=512),this.meshSets=[];var t,O=0,F=0,r=this.geomManager.bufferChunk,U=new THREE.Box3,N=new THREE.Vector3,i=[],V=new Map,G=new Map,s=new Map,l=[],n=[];for(t in r)if(r.hasOwnProperty(t)){var k=r[t],j=k.ndsGeometriesArray;if(j){for(var z=j.length,W=0,X=0,q=0,Y=0,a=0,o=Number.MAX_SAFE_INTEGER,Q=[],d=new Map,c=0,K=z;c<K;++c){var h,u,p=j[c],f={geom:p,size:0,isInstance:1<p.refMeshes.length,bodyNodes:[]};0<p.refMeshes.length?(u=p.refMeshes[0],this.meshManager.getMeshBBox(u,U),"CopperZone"===(h=this.meshManager.bodyNodes[p.refMeshes[u=0]].parent.referencename)?u=3e4:"Track"===h?u=2e4:"SilkScreen"===h?u=1e4:"SolderPad"===h?u=1e3:"ThroughHole"===h&&(u=-2),U.getSize(N),f.size=N.length(),f.size=0<=u?u+f.size:-u,n[n.length++]=f.size,Y+=f.size,a=a<f.size?f.size:a,o=f.size<o?f.size:o,q++,W+=p.refMeshes.length,p.refMeshes.length):0<p.refLineSegs.length&&(f.size=1);for(var m=0,Z=p.refMeshes.length;m<Z;++m){var g=this.meshManager.bodyNodes[p.refMeshes[m]];g.unload||(void 0===g.chunkIndex?g.chunkIndex=l.length:g.chunkIndex!==l.length&&(s.has(g)||(s.set(g,new Set),s.get(g).add(g.chunkIndex)),s.get(g).add(l.length),g.chunkIndex=l.length),d.has(g.globalIndex)||(d.set(g.globalIndex,{node:g,localIndex:-1,meshes:[],lines:[]}),X++),d.get(g.globalIndex).meshes.push({meshId:p.refMeshes[m],geomIndex:c,size:f.size}),f.bodyNodes.push(g))}for(var J=0,$=p.refLineSegs.length;J<$;++J){var v=this.meshManager.lineSegBodyNodes[p.refLineSegs[J]];v.unload||(d.has(v.globalIndex)||(d.set(v.globalIndex,{node:v,localIndex:-1,meshes:[],lines:[]}),X++),d.get(v.globalIndex).lines.push({lineId:p.refLineSegs[J],geomIndex:c,size:f.size}),f.bodyNodes.push(v))}Q.push(f)}l.push({chunkUrl:t,groupIndex:-1,avgSize:Y/(0===q?1:q),maxSize:a,minSize:o,totalMeshCount:W,totalBodyNodeCount:X,bufferLength:k.bufferlenth}),V.set(t,Q),G.set(t,d)}}for(var ee,te=0,re=function(){var e=ee.value,i=e[0],n=e[1];if(-1!==l[n.values().next().value].groupIndex)return 1;for(var a,o=Array.from(n),t=en(s);!(a=t()).done;)!function(){var e=a.value,t=e[0],r=e[1];if(i===t||-1!==l[r.values().next().value].groupIndex)return;0<o.filter(function(e){return r.has(e)}).length&&r.forEach(function(e){n.has(e)||(n.add(e),o.push(e))})}();for(var r=0;r<o.length;++r)l[o[r]].groupIndex=te;++te},ie=en(s);!(ee=ie()).done;)re();l.sort(function(e,t){return e.groupIndex!==t.groupIndex?t.groupIndex-e.groupIndex:t.maxSize-e.maxSize}),n.sort(function(e,t){return t-e});for(var ne,y=[],A=1,ae=1,oe=n.length;ae<oe;++ae).05<((ne=n[ae-1])-n[ae])/ne||5e3===A?(y.push({criticalSize:ne,levelSize:A}),A=1):++A;y.push({criticalSize:0,levelSize:A});for(var M=0,se=y.length-1;M<se;++M){var le=y[M].levelSize,de=y[M+1].levelSize;y[M].criticalSize-y[M+1].criticalSize<1e3&&le<2500&&le<512*(M+1)&&le+de<512*(M+2)&&(y[M+1].levelSize+=y[M].levelSize,y[M].discard=!0),M===se-1&&!y[M].discard&&y[M+1].levelSize<512&&(y[M].discard=!0)}for(var ce=[],he=0,ue=y.length;he<ue;++he)y[he].discard||ce.push(y[he].criticalSize);this.sizeLevelCount=(y=ce).length;for(var pe=0,E={isProcessed:!1,meshCount:0,bufferLength:0,bodyNodeCount:0,geomChunkUrl:[],groupIndex:-2};pe<l.length;){var w=l[pe],fe=w.chunkUrl,me=w.totalMeshCount,ge=w.totalBodyNodeCount,ve=w.groupIndex;0===E.geomChunkUrl.length||this.geomManager.enableMergeGeomChunk&&E.groupIndex===ve&&E.bodyNodeCount+ge<e&&E.meshCount+me<e&&(E.bufferLength+w.bufferLength)/1024/1024<5?(E.geomChunkUrl.push(fe),-2===E.groupIndex&&(E.groupIndex=ve),E.meshCount+=me,E.bodyNodeCount+=ge,E.bufferLength+=w.bufferLength,r[fe].geomChunkGroup=E,++pe===l.length&&i.push(E)):(i.push(E),E={isProcessed:!1,meshCount:0,bufferLength:0,bodyNodeCount:0,geomChunkUrl:[],groupIndex:-2})}for(var ye=0;ye<i.length;++ye)for(var Ae=i[ye],x=(this.meshSets.push(new Mi(this)),this.meshSets[this.meshSets.length-1]),Me=0;Me<Ae.geomChunkUrl.length;++Me){var Ee=Ae.geomChunkUrl[Me],we=V.get(Ee),xe=G.get(Ee);we.sort(function(e,t){return t.size-e.size});for(var be=0;be<we.length;++be)for(var Be=we[be].bodyNodes,Ie=0;Ie<Be.length;++Ie){var b=xe.get(Be[Ie].globalIndex);if(!(-1<b.localIndex)){(x.meshCount+b.meshes.length>e||x.bodyNodes.length===e)&&(this.meshSets.push(new Mi(this)),x=this.meshSets[this.meshSets.length-1]),b.localIndex=x.bodyNodes.indexOf(b.node),-1===b.localIndex&&(b.localIndex=x.bodyNodes.length,x.bodyNodes.push(b.node));for(var Te=0;Te<b.meshes.length;++Te){var Se=b.meshes[Te];Se.bodyId=b.localIndex,x.meshes.push(Se),++x.meshCount}for(var Re=0;Re<b.lines.length;++Re){var Ce=b.lines[Re];Ce.bodyId=b.localIndex,x.lines.push(Ce),++x.lineCount}}}}for(var B,I=0;I<this.meshSets.length;++I)this.meshSets[I].init(y),O+=this.meshSets[I].meshCount,F+=this.meshSets[I].lineCount;this.meshSets.sort(function(e,t){return t._max_mesh_size_-e._max_mesh_size_}),0<O&&(B=Math.ceil(Math.log2(O)),B=Math.pow(2,Math.ceil(B/2)),this.meshId2BodyIdTexSize=B,this.meshId2BodyIdBuffer=new Uint32Array(this.meshId2BodyIdTexSize*this.meshId2BodyIdTexSize),this.meshId2BodyIdTexture=new THREE.DataTexture(this.meshId2BodyIdBuffer,this.meshId2BodyIdTexSize,this.meshId2BodyIdTexSize,THREE.RedIntegerFormat,THREE.UnsignedIntType),this.meshId2BodyIdTexture.needsUpdate=!0),0<F&&(B=Math.ceil(Math.log2(F)),B=Math.pow(2,Math.ceil(B/2)),this.lineId2BodyIdTexSize=B,this.lineId2BodyIdBuffer=new Uint32Array(this.lineId2BodyIdTexSize*this.lineId2BodyIdTexSize),this.lineId2BodyIdTexture=new THREE.DataTexture(this.lineId2BodyIdBuffer,this.lineId2BodyIdTexSize,this.lineId2BodyIdTexSize,THREE.RedIntegerFormat,THREE.UnsignedIntType),this.lineId2BodyIdTexture.needsUpdate=!0);var T=0,S=0;if(this.viewer.renderer.mcad3dRenderer.supportLargeUniformBuffer){0===Ye.length&&Ye.push(Gi());for(var De=0;De<this.meshSets.length;++De){for(var R=this.meshSets[De],C=0;C<Ye.length&&!(Ye[C].unUsedIndex+R.bodyNodes.length<=1024);++C);C===Ye.length&&(Ye[C]=Gi()),R.bodyWorldMatrixUniformBlock=Ye[C],R.bodyWorldMatrixOffset=Ye[C].unUsedIndex,R.bodyNodeWorldMatrixBuffer=Ye[C].dataBuffer;for(var D=0,Pe=R.bodyNodes.length;D<Pe;++D)R.bodyNodes[D].worldMatrix?R.bodyNodes[D].synchronizedWorldMatrix.push(new THREE.Matrix4(R.bodyNodeWorldMatrixBuffer,16*(R.bodyWorldMatrixOffset+D)*4)):R.bodyNodes[D].worldMatrix=new THREE.Matrix4(R.bodyNodeWorldMatrixBuffer,16*(R.bodyWorldMatrixOffset+D)*4);Ye[C].unUsedIndex+=R.bodyNodes.length,R.bodyWorldMatrixUniformBlock.needsUpdate=!0;for(var He=0;He<R.meshId2BodyId.length;++He)this.meshId2BodyIdBuffer[T+He]=R.meshId2BodyId[He];R.meshOffset=T,T+=R.meshCount;for(var _e=0;_e<R.lineId2BodyId.length;++_e)this.lineId2BodyIdBuffer[S+_e]=R.lineId2BodyId[_e];R.lineOffset=S,S+=R.lineCount}this.bodyWorldMatrixUniformBlocks=Ye,1===this.bodyWorldMatrixUniformBlocks.length?Ye[0].dynamicBinding=!1:Ye[0].dynamicBinding=!0}else{0===Qe.length&&Qe.push(ki());for(var Le=0;Le<this.meshSets.length;++Le){for(var P=this.meshSets[Le],H=0;H<Qe.length&&!(Qe[H].unUsedIndex+P.bodyNodes.length<=16384);++H);H===Qe.length&&(Qe[H]=ki()),P.bodyWorldMatrixUniformMap=Qe[H],P.bodyWorldMatrixUniformMapSize=ji,P.bodyWorldMatrixOffset=Qe[H].unUsedIndex,P.bodyNodeWorldMatrixBuffer=Qe[H].source.data.data;for(var _=0,Oe=P.bodyNodes.length;_<Oe;++_)P.bodyNodes[_].worldMatrix?P.bodyNodes[_].synchronizedWorldMatrix.push(new THREE.Matrix4(P.bodyNodeWorldMatrixBuffer,16*(P.bodyWorldMatrixOffset+_)*4)):P.bodyNodes[_].worldMatrix=new THREE.Matrix4(P.bodyNodeWorldMatrixBuffer,16*(P.bodyWorldMatrixOffset+_)*4);Qe[H].unUsedIndex+=P.bodyNodes.length,P.bodyWorldMatrixUniformMap.needsUpdate=!0;for(var Fe=0;Fe<P.meshId2BodyId.length;++Fe)this.meshId2BodyIdBuffer[T+Fe]=P.meshId2BodyId[Fe];P.meshOffset=T,T+=P.meshCount;for(var Ue=0;Ue<P.lineId2BodyId.length;++Ue)this.lineId2BodyIdBuffer[S+Ue]=P.lineId2BodyId[Ue];P.lineOffset=S,S+=P.lineCount}this.bodyWorldMatrixUniformMaps=Qe}this.rootBodyNode.updateMatrixWorld(!0,!1),this.refreshMeshState(this.rootBodyNode),this.meshState.update();for(var Ne=0;Ne<this.meshSets.length;++Ne){var L=this.meshSets[Ne];L.updateMultiDrawControlParams();for(var Ve=0;Ve<L.meshes.length;++Ve)this.meshState.getMeshMaterial(L.meshes[Ve]).meshSet=L;for(var Ge=0;Ge<L.lines.length;++Ge)this.meshState.getLineMaterial(L.lines[Ge]).meshSet=L}},r.handleContentLoadedState=function(){var e;this.isECAD2DModel&&(e=new THREE.AmbientLight(16777215,1),this.viewer.lights.push(e));for(var t=0,r=this.rootBodyNode.children.length;t<r;++t){var i=this.rootBodyNode.children[t],n="PCB"===i.referencename,a="Component"===i.referencename,o=(i.referencename,"Net"===i.referencename);if(n)this.__layers__.has(i.referencename)||(this.__layers__.set(i.referencename,new Map),this.__layers__.get(i.referencename).set(i.name,new Set),this.__layers__.get(i.referencename).get(i.name).add(i.children[0]));else if(a)for(var s=0,l=i.children.length;s<l;++s){var d=i.children[s];this.__typedObjects__.has(i.referencename)||this.__typedObjects__.set(i.referencename,new Set),this.__typedObjects__.get(i.referencename).add(d),this.__layers__.has(i.referencename)||this.__layers__.set(i.referencename,new Set),this.__layers__.get(i.referencename).add(d)}else{o&&!this.__nets__.has(i.referencename)&&this.__nets__.set(i.name,new Set);for(var c=0,h=i.children.length;c<h;++c){var u=i.children[c],p=u.name;this.__layers__.has(p)||this.__layers__.set(p,new Map);for(var f=0,m=u.children.length;f<m;++f){var g=u.children[f],v=g.referencename;"SolderPad"===v?(g.matrix?g.matrix[14]+=5e-5:g.matrix=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,5e-5,1],g.disableDrawLine=!0):"Track"===v?(g.matrix?g.matrix[14]+=2e-5:g.matrix=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,2e-5,1],g.disableDrawLine=!0):"CopperZone"!==v&&"ThroughHole"!==v||(g.disableDrawLine=!0),this.__typedObjects__.has(v)||this.__typedObjects__.set(v,new Set),this.__typedObjects__.get(v).add(g),this.__layers__.get(p).has(v)||this.__layers__.get(p).set(v,new Set),this.__layers__.get(p).get(v).add(g),o&&this.__nets__.has(i.name)&&this.__nets__.get(i.name).add(g)}}}}y.prototype.handleContentLoadedState.call(this)},e}(zi);function an(e,t){return(an=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}function on(){de.call(this,!1)}var sn=function(i){function e(e,t,r){return(e=i.call(this,e,t,r=void 0===r?{}:r)||this).isECAD2DModel=!1,e.isECAD3DModel=!0,e.typeName="ECAD3D",e}var t,r;return r=i,(t=e).prototype=Object.create(r.prototype),an(t.prototype.constructor=t,r),e}(nn);function ln(e,t){return(ln=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}on.prototype=Object.assign(Object.create(de.prototype),{constructor:on,CreateImage:function(e,t){var r,i=this.mappableUnit-this.textUnit,n=new Object,a=document.createElement("canvas"),o=(a.width=this.mappableUnit,a.height=this.mappableUnit,a.getContext("2d"));switch(t){case de.ITALIC:r="italic "+this.textSize+"px ";break;case de.BOLD:r="bold "+this.textSize+"px ";break;case de.NORMAL:r="normal "+this.textSize+"px ";break;case de.ITALICANDBOLD:r="italic bold "+this.textSize+"px "}o.textBaseline="bottom",o.fillStyle="black",o.clearRect(0,0,a.width,a.height);for(var s=2,l=0,d=1,c=0;c<e.length;c++){var h=e[c],u=!1,p=this.IsChinese(h),f=(-1!=this.specialCodeArray.indexOf(h)&&(u=!0),o.font=p?r+"FangSong":r+"Arial",o.clearRect(i,i,this.textUnit,this.textUnit),o.textAlign="center",o.fillText(h,i+this.textUnit/2,this.mappableUnit),50),m=0,g=0;if(p)w=this.textSize;else{for(var v=o.getImageData(i-2,i-2,this.textUnit,this.textUnit),y=0;y<this.textUnit;y++){for(var A=0;A<this.textUnit;A++){var M=v.data[4*(y*this.textUnit+A)+3];if(0!=M&&A<f){f=A;break}}for(var E=this.textUnit-1;0<=E;E--){M=v.data[4*(y*this.textUnit+E)+3];if(0!=M&&m<E){m=E;break}}}var w=m-f,x=(w<0&&(w=6),m+f>>1);x<this.textUnit/2-3?g=1:x>this.textUnit/2+3&&(g=2)}(s=s+(l>>1)+(w>>1)+14)+(w>>1)>this.mappableUnit&&(s=(s=7)+((l=0)>>1)+(w>>1)+14,d++),o.textAlign="center",o.fillText(h,s,this.textUnit*d);var l=w,x=s-(w>>1)-3,b=this.textUnit*d,p={height:p?1.5:1,width:p?1.5:(w+14)/this.textUnit,left:1==g?(x-7)/this.mappableUnit:x/this.mappableUnit,top:1-(b-this.textUnit+3.5)/this.mappableUnit,right:2==g?(x+w+14)/this.mappableUnit:(x+w+14/3)/this.mappableUnit,bottom:1-b/this.mappableUnit};u&&(g=p.right-p.left,p.right-=g*=1-.7,b=p.top-p.bottom,p.top-=(b*=1-.7)/2,p.bottom+=b/2),n[h]=p}this.metrics[t]=n;t=document.createElement("img");return t.src=a.toDataURL("image/png"),t},CreateMaterial:function(n,e,t){function r(e,t,r,i){var n=new THREE.ShaderMaterial({vertexColors:THREE.FaceColors,uniforms:{uSampler0:{type:"t",value:null},uSampler1:{type:"t",value:null},uSampler2:{type:"t",value:null},uSampler3:{type:"t",value:null},uSampler4:{type:"t",value:null},uGamma:{type:"f",value:4e-4},diffuse:{value:new THREE.Color(16777215)}},vertexShader:["varying vec2 vUv;","varying float vtextureid;","attribute float textureid;","void main() { ","vUv = uv;","vtextureid = textureid;","gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join("\n"),fragmentShader:["#ifdef GL_ES","precision mediump float;","#endif","varying vec2 vUv;","varying float vtextureid;","uniform sampler2D uSampler0;","uniform sampler2D uSampler1;","uniform sampler2D uSampler2;","uniform sampler2D uSampler3;","uniform sampler2D uSampler4;","uniform float uGamma;","uniform vec3 diffuse;","const float cBuffer = 0.2;","void main(void) {","float dist = 0.0;","if( vtextureid > -0.5 && vtextureid < 0.5){","dist = texture2D(uSampler0, vUv).a;","}","if( vtextureid > 0.5 && vtextureid < 1.5){","dist = texture2D(uSampler1, vUv).a;","}","if( vtextureid > 1.5 && vtextureid < 2.5){","dist = texture2D(uSampler2, vUv).a;","}","if( vtextureid > 2.5 && vtextureid < 3.5){","dist = texture2D(uSampler3, vUv).a;","}","if( vtextureid > 3.5 && vtextureid < 4.5){","dist = texture2D(uSampler4, vUv).a;","}","float alpha = smoothstep(cBuffer - uGamma, cBuffer + uGamma, dist);","vec3 destColor = diffuse;","if(destColor.r> 1.0){","destColor.r = 1.0;","alpha = 0.0;","}","if(destColor.g> 1.0){","destColor.r = 0.090;","destColor.g = 0.501;","destColor.b = 0.890;","}","gl_FragColor = vec4(destColor, alpha);","}"].join("\n")});if(1<e.SDFVerison)for(var a,o=0;o<t.length;++o)(a=t[o]).flipY=!1,a.needsUpdate=!0,n.uniforms["uSampler"+o].value=a;else(a=new THREE.Texture(t)).needsUpdate=!0,n.uniforms.uSampler0.value=a;switch(n.side=THREE.DoubleSide,n.transparent=!0,n.depthWrite=!1,n.alphaTest=.4,r){case de.ITALIC:e.TextMaterialItalic=n,e.TextMaterialItalic.styleId=r;break;case de.BOLD:e.TextMaterialBold=n,e.TextMaterialBold.styleId=r;break;case de.NORMAL:e.TextMaterial=n,e.TextMaterial.styleId=r;break;case de.ITALICANDBOLD:e.TextMaterialIandB=n,e.TextMaterialIandB.styleId=r;break;case de.BLEND:i?(e.newblendMaterial=n,e.newblendMaterial.styleId=r):(e.blendMaterial=n,e.blendMaterial.styleId=r)}}function i(e,t,r){var i=new THREE.ShaderMaterial({vertexColors:THREE.FaceColors,uniforms:{uSampler0:{type:"t",value:null},uSampler1:{type:"t",value:null},uSampler2:{type:"t",value:null},uSampler3:{type:"t",value:null},uSampler4:{type:"t",value:null},uGamma:{type:"f",value:4e-4}},vertexShader:["varying vec2 vUv;","varying vec3 vColor;","varying float vtextureid;","attribute float textureid;","void main() { ","vUv = uv;","vColor = color;","vtextureid = textureid;","gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join("\n"),fragmentShader:["#ifdef GL_ES","precision mediump float;","#endif","varying vec2 vUv;","varying vec3 vColor;","varying float vtextureid;","uniform sampler2D uSampler0;","uniform sampler2D uSampler1;","uniform sampler2D uSampler2;","uniform sampler2D uSampler3;","uniform sampler2D uSampler4;","uniform float uGamma;","const float cBuffer = 0.2;","void main(void) {","float dist = 0.0;","if( vtextureid > -0.5 && vtextureid < 0.5){","dist = texture2D(uSampler0, vUv).a;","}","if( vtextureid > 0.5 && vtextureid < 1.5){","dist = texture2D(uSampler1, vUv).a;","}","if( vtextureid > 1.5 && vtextureid < 2.5){","dist = texture2D(uSampler2, vUv).a;","}","if( vtextureid > 2.5 && vtextureid < 3.5){","dist = texture2D(uSampler3, vUv).a;","}","if( vtextureid > 3.5 && vtextureid < 4.5){","dist = texture2D(uSampler4, vUv).a;","}","float alpha = smoothstep(cBuffer - uGamma, cBuffer + uGamma, dist);","vec3 destColor = vColor;","if(destColor.r> 1.0){","destColor.r = 1.0;","alpha = 0.0;","}","if(destColor.g> 1.0){","destColor.r = 0.090;","destColor.g = 0.501;","destColor.b = 0.890;","}","gl_FragColor = vec4(destColor, alpha);","}"].join("\n")});if(1<e.SDFVerison)for(var n,a=0;a<t.length;++a)(n=t[a]).flipY=!1,n.needsUpdate=!0,i.uniforms["uSampler"+a].value=n;else(n=new THREE.Texture(t)).needsUpdate=!0,i.uniforms.uSampler0.value=n;switch(i.side=THREE.DoubleSide,i.transparent=!0,i.depthWrite=!1,i.alphaTest=.4,r){case de.ITALIC:e.TextMaterialItalic=i,e.TextMaterialItalic.styleId=r;break;case de.BOLD:e.TextMaterialBold=i,e.TextMaterialBold.styleId=r;break;case de.NORMAL:e.TextMaterial=i,e.TextMaterial.styleId=r;break;case de.ITALICANDBOLD:e.TextMaterialIandB=i,e.TextMaterialIandB.styleId=r;break;case de.BLEND:e.blendMaterial=i,e.blendMaterial.styleId=r}}var a=new Map;if(n.fonts)for(var o=0,O=n.fonts.length;o<O;++o)a.set(n.fonts[o].uuid,n.fonts[o]);var s=[],l=!1,d=!1,c=!1,h=this;if(3==e&&this.SDFVerison==e&&n){for(var u=new Object,p=0;p<n.length;p++){var f=n[p].name,m=n[p].str,g=void 0===n[p].textureid,v=(this.nametotextureID[f]=g?0:n[p].textureid,n[p].uvs),F=n[p].range,y=g?2:10,A=new Object;if(m&&v)for(var M=0;M<m.length;M++){var E,w=m[M];g?(E=F[M],A[w]={advanceX:v[M*y],advanceY:v[M*y+1],shxRange:0==E.length?null:E,isShx:!0}):A[w]={top:v[M*y],bottom:v[M*y+1],left:v[M*y+2],right:v[M*y+3],bearingX:v[M*y+4],bearingY:v[M*y+5],advanceX:v[M*y+6],advanceY:v[M*y+7],width:v[M*y+8],height:v[M*y+9],shxRange:null,isShx:!1}}u[f]=A}this.metrics[de.BLEND]=u,r(this,this.textures,de.BLEND,!1),this.shxMaterial=new THREE.ShaderMaterial({uniforms:{diffuse:{value:new THREE.Color(16777215)}},vertexShader:["void main() { ","gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join("\n"),fragmentShader:["#ifdef GL_ES","precision mediump float;","#endif","uniform vec3 diffuse;","void main(void) {","gl_FragColor = vec4(diffuse, 1.0);","}"].join("\n")})}else if(2==e&&this.SDFVerison==e&&n){for(var x=new Object,b=0;b<n.length;b++){var B=n[b].name,I=n[b].uvs,T=n[b].str,U=(this.nametotextureID[B]=n[b].textureid,n[b].shapid),S=n[b].range,R={};if(S)for(var C=0;C<S.length;C++)R[S[C].char]=S[C].data;var D=new Object;if(T&&I)for(var P=0;P<T.length;P++){var N=T[P];D[N]={height:1,width:(I[4*P+3]-I[4*P+2])/(I[4*P+1]-I[4*P]),left:I[4*P+2],top:I[4*P],right:I[4*P+3],bottom:I[4*P+1],shxRange:null!=S?R[N]:null}}if(U)for(var H=U.split(","),_=0;_<H.length&&H[_];_++)D[H[_]]={height:2<=t?4:2,width:2<=t?4:2*(I[4*_+3]-I[4*_+2])/(I[4*_+1]-I[4*_]),left:I[4*_+2],top:I[4*_],right:I[4*_+3],bottom:I[4*_+1],shxRange:null!=S?R[String.fromCharCode(H[_])]:null},"131"==H[_]&&(D[H[_]].height=2<=t?4:1,D[H[_]].width=2<=t?4:2),"130"==H[_]&&2<=t&&(D[H[_]].height=4,D[H[_]].width=1);x[B]=D}this.metrics[de.BLEND]=x,1==t?(i(this,this.textures,de.BLEND),r(this,this.textures,de.BLEND,!0)):(r(this,this.textures,de.BLEND,!1),this.shxMaterial=new THREE.ShaderMaterial({uniforms:{diffuse:{value:new THREE.Color(16777215)}},vertexShader:["void main() { ","gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join("\n"),fragmentShader:["#ifdef GL_ES","precision mediump float;","#endif","uniform vec3 diffuse;","void main(void) {","gl_FragColor = vec4(diffuse, 1.0);","}"].join("\n")}))}else if(1==e&&this.SDFVerison==e&&n){for(var L=0;L<n.bufferchunks.length;L++)n.bufferchunks[L].geometries.map(function(e,t){if("TextGeometry"===e.type)for(var r=0;r<e.text.length;r++){h.containHash(e.text.charAt(r))||h.addHash(e.text.charAt(r));var i=e.textFont;!i.style&&n.fonts&&(i=a.get(e.textFont)),l||"normal"==i.style||"normal"!=i.weight||(l=!0),d||"normal"==i.weight||"normal"!=i.style||(d=!0),c||"normal"==i.style||"normal"==i.weight||(c=!0)}});this.getHashKey(s),0!==s.length&&(e=this.CreateImage(s,de.NORMAL),i(this,e,de.NORMAL),l&&(e=this.CreateImage(s,de.ITALIC),i(this,e,de.ITALIC)),d&&(e=this.CreateImage(s,de.BOLD),i(this,e,de.BOLD)),c)&&(e=this.CreateImage(s,de.ITALICANDBOLD),i(this,e,de.ITALICANDBOLD))}},DisaCreateMaterial:function(e,t){for(var r,i,n=function(e,t,r){var i=new THREE.ShaderMaterial({vertexColors:!0,uniforms:{uSampler0:{type:"t",value:null},uSampler1:{type:"t",value:null},uSampler2:{type:"t",value:null},uSampler3:{type:"t",value:null},uSampler4:{type:"t",value:null},uGamma:{type:"f",value:4e-4}},vertexShader:["varying vec2 vUv;","varying vec3 vColor;","varying float vtextureid;","attribute float textureid;","void main() { ","vUv = uv;","vColor = color;","vtextureid = textureid;","gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join("\n"),fragmentShader:["#ifdef GL_ES","precision mediump float;","#endif","varying vec2 vUv;","varying vec3 vColor;","varying float vtextureid;","uniform sampler2D uSampler0;","uniform sampler2D uSampler1;","uniform sampler2D uSampler2;","uniform sampler2D uSampler3;","uniform sampler2D uSampler4;","uniform float uGamma;","const float cBuffer = 0.2;","void main(void) {","float dist = 0.0;","if( vtextureid > -0.5 && vtextureid < 0.5){","dist = texture2D(uSampler0, vUv).a;","}","if( vtextureid > 0.5 && vtextureid < 1.5){","dist = texture2D(uSampler1, vUv).a;","}","if( vtextureid > 1.5 && vtextureid < 2.5){","dist = texture2D(uSampler2, vUv).a;","}","if( vtextureid > 2.5 && vtextureid < 3.5){","dist = texture2D(uSampler3, vUv).a;","}","if( vtextureid > 3.5 && vtextureid < 4.5){","dist = texture2D(uSampler4, vUv).a;","}","float alpha = smoothstep(cBuffer - uGamma, cBuffer + uGamma, dist);","vec3 destColor = vColor;","if(destColor.r> 1.0){","destColor.r = 1.0;","alpha = 0.0;","}","if(destColor.g> 1.0){","destColor.r = 0.090;","destColor.g = 0.501;","destColor.b = 0.890;","}","gl_FragColor = vec4(destColor, alpha);","}"].join("\n")});if(1<e.SDFVerison)for(var n,a=0;a<t.length;++a)(n=t[a]).flipY=!1,n.needsUpdate=!0,i.uniforms["uSampler"+a].value=n;else(n=new THREE.Texture(t)).needsUpdate=!0,i.uniforms.uSampler0.value=n;switch(i.side=THREE.DoubleSide,i.transparent=!0,i.depthWrite=!1,i.alphaTest=.4,r){case de.ITALIC:e.TextMaterialItalic=i,e.TextMaterialItalic.styleId=r;break;case de.BOLD:e.TextMaterialBold=i,e.TextMaterialBold.styleId=r;break;case de.NORMAL:e.TextMaterial=i,e.TextMaterial.styleId=r;break;case de.ITALICANDBOLD:e.TextMaterialIandB=i,e.TextMaterialIandB.styleId=r;break;case de.BLEND:e.blendMaterial=i,e.blendMaterial.styleId=r}},a=!1,o=!1,s=!1,l=0;l<e.length;l++)if(e[l].Texts)for(var d=0;d<e[l].Texts.length;d++)for(var c=e[l].Texts[d],h=t[c.Font||c.FontId],u=0;u<c.Content.length;u++)this.containHash(c.Content.charAt(u))||this.addHash(c.Content.charAt(u)),!a&&h.Italic&&(a=!0),!o&&h.Bold&&(o=!0),!s&&h.Italic&&h.Bold&&(s=!0);0!==(r=this.getHashKey()).length&&(i=this.CreateImage(r,de.NORMAL),n(this,i,de.NORMAL),a&&(i=this.CreateImage(r,de.ITALIC),n(this,i,de.ITALIC)),o&&(i=this.CreateImage(r,de.BOLD),n(this,i,de.BOLD)),s)&&(i=this.CreateImage(r,de.ITALICANDBOLD),n(this,i,de.ITALICANDBOLD))},GetDimensionsForSize:function(e,t,r,i,n,a){var o,s=null,l=i,d="msyh.ttf",c="gbenor.shx",h="gbcbig.shx",h=(2<this.SDFVerison&&this.metrics[r]?(a&&this.metrics[r][a]&&(s=this.metrics[r][a][e],l=a),!s&&this.metrics[r][i]&&(s=this.metrics[r][i][e],l=i),s||(this.IsShxFont(i)?(!s&&this.metrics[r][h]&&(s=this.metrics[r][h][e],l=h),!s&&this.metrics[r][c]&&(s=this.metrics[r][c][e],l=c)):!s&&this.metrics[r][d]&&(s=this.metrics[r][d][e],l=d))):2==this.SDFVerison&&this.metrics[r]?(this.metrics[r][i]&&(s=this.metrics[r][i][e],l=i),!s&&a&&this.metrics[r][a]&&(s=this.metrics[r][a][e],l=a),!s&&this.metrics[r][d]&&(s=this.metrics[r][d][e],l=d)):1==this.SDFVerison&&this.metrics[r]&&(s=this.metrics[r][e],l=d),!1),s=s||{height:1,width:1,left:0,top:0,right:1,bottom:1,textureid:0,shxRange:null,advanceX:0,advanceY:0,bearingX:0,bearingY:0,isShx:!(h=!0)},c=1,i=1,a=1,r=0,d=0,u=0,p=0,f=5,m=!1;return 1==this.SDFVerison?(i=s.width*c*t,a=s.height*t,f=h?5:this.nametotextureID[l]):2==this.SDFVerison?(o=this.GetTextScale(e,l),i=s.width*o*(c=null==n?1:n)*t,a=s.height*o*t,f=h?5:this.nametotextureID[l],m=null!=s.shxRange,d=-a*this.GetTextOffset(null,l,m),c*=c<1.5?.95:1):3<=this.SDFVerison&&(u=s.advanceX*(c=null==n?1:n)*t,p=s.advanceY*t," "==e?s.isShx?(a=i=u,m=s.isShx):(a=i=u,f=h?5:this.nametotextureID[l],r=s.bearingX*c*t,d=s.bearingY*t):s.isShx?(i=i*c*t,a*=t,m=s.isShx):(i=s.width*c*t,a=s.height*t,f=h?5:this.nametotextureID[l],r=s.bearingX*c*t,d=s.bearingY*t)),{width:i,height:a,bearingX:r,bearingY:d,advanceX:u,advanceY:p,left:s.left,top:s.top,right:s.right,bottom:s.bottom,textureid:f||0,font:l,widthScale:c,discard:h,isShx:m,shxRange:s.shxRange}}});var dn=function(i){function e(e,t,r){return(e=i.call(this,e,t,r=void 0===r?{}:r)||this).isDisaModel=!0,e.SDFMaker=new on,e}var t,r;return r=i,(t=e).prototype=Object.create(r.prototype),ln(t.prototype.constructor=t,r),e}(zi);function cn(e,t){return(cn=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}var hn=function(i){function e(e,t,r){return(e=i.call(this,e,t,r=void 0===r?{}:r)||this).typeName="MCAD3D",e.isSketchModel=!0,e.parentModel=r.parentModel,(e.parentModel.ndsSketchModel=e).hasRefModel=!0,e.updateSketchNodeMatrix=function(){if(this.rootBodyNode.children)for(var e=0;e<this.rootBodyNode.children.length;e++){var t=this.rootBodyNode.children[e],r=this.viewer.getBodyNodeFromUuid(this.parentModel.sketchFileBindNodeuuid[e],this.parentModel.id);r&&(t.matrix=r.worldMatrix.toArray())}this.rootBodyNode.updateMatrixWorld(!0)},e}var t,r;return r=i,(t=e).prototype=Object.create(r.prototype),cn(t.prototype.constructor=t,r),e.prototype.handleContentLoadedState=function(){i.prototype.handleContentLoadedState.call(this),this.updateSketchNodeMatrix();var e=this.parentModel.rootBodyNode.matrix||[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];this.viewer.ndsModel.updateNodeMatrix(this.rootBodyNode.uuid,e),this.hideBody(this.rootBodyNode),!0===this.viewer.AuxiliaryLineVisible&&this.viewer.setAuxiliaryLineVisible(this.viewer.AuxiliaryLineVisible)},e}(Wi);function un(e,t){return(un=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}function pn(e){this.viewer=e,this.renderTarget=null,this.bkgDepthRGBAMat=null,this.bkgDepthRGBAMatCopy=null,this.bodyIdMat=null,this.convertPointScreen=function(e,t){var r,i,n,a,o,s,l,d,c,h,u,p,f,m=this.viewer.renderer.domElement,g=this.viewer.renderer.getPixelRatio();return e&&2<=e.length?(this.renderTarget||(this.renderTarget=new THREE.WebGLRenderTarget(m.width,m.height,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat,stencilBuffer:!1}),this.renderTarget.texture.generateMipmaps=!1),r=this.renderTarget,this.bkgDepthRGBAMat||(this.viewer.ndsModel?(this.bkgDepthRGBAMat=new THREE.ShaderMaterial({vertexShader:bn.vertexShader,fragmentShader:bn.fragmentShader}),this.bkgDepthRGBAMatCopy=(new this.bkgDepthRGBAMat.constructor).copy(this.bkgDepthRGBAMat)):(this.bkgDepthRGBAMat=new THREE.ShaderMaterial({vertexShader:bn.vertexShader,fragmentShader:bn.fragmentShader}),this.bkgDepthRGBAMat.side=THREE.DoubleSide)),i=this.viewer.scene.overrideMaterial,n=this.viewer.renderer.getClearColor(this.viewer.oldClearColor).clone(),a=this.viewer.renderer.getClearAlpha(),this.viewer.scene.overrideMaterial=this.bkgDepthRGBAMat,this.viewer.renderer.setClearColor(16777215),this.viewer.lightControls&&this.viewer.scene.remove(this.viewer.lightControls._scene),this.viewer.ndsModel&&(this.viewer.ndsModel.setDirty(),this.viewer.ndsModel.setDrawMode(this.viewer.ndsModel.SHADED),this.viewer.scene.children.push(this.viewer.ndsModel),this.viewer.ndsModel.setOverrideMaterial(this.bkgDepthRGBAMat,this.bkgDepthRGBAMatCopy,!1)),this.viewer.renderer.render(this.viewer.scene,this.viewer.camera,r,!0,!0),this.viewer.scene.overrideMaterial=i,this.viewer.ndsModel&&this.viewer.ndsModel.setOverrideMaterial(null,null,!1),(p=new THREE.Matrix4).multiplyMatrices(this.viewer.camera.matrixWorld,p.getInverse(this.viewer.camera.projectionMatrix)),o=[],s="",l=null,(u=new Uint8Array(4))[0]=u[1]=u[2]=u[3]=0,this.viewer.renderer.readRenderTargetPixels(r,e[0]*g,r.height-e[1]*g,1,1,u),(d=253<u[0]&&253<u[1]&&253<u[2]&&253<u[3])||(u=u[0]*(f=255/256)/16777216+u[1]*f/65536+u[2]*f/256+u[3]*f,u=2*(u/=255)-1,u-=4e-8*u,(f=new THREE.Vector3).set(e[0]*g/m.width*2-1,2*-(e[1]*g/m.height)+1,u),f.applyMatrix4(p),o.push(f.x),o.push(f.y),o.push(f.z)),d||null!=t&&1!=t||(c=10,h=[],this.viewer.ndsModel?this.bodyIdMat||(this.bodyIdMat=new THREE.MeshBasicMaterial):this.viewer.scene.traverse(function(e){e.hasOwnProperty("geometry")&&e.hasOwnProperty("material")&&(e.materialRaycasterRecord=e.material,e instanceof THREE.Line||e instanceof THREE.LineSegments?e.material=new THREE.LineBasicMaterial:(e.material=new THREE.MeshBasicMaterial,e.material.side=THREE.DoubleSide),e.material.color.setHex(c),h[c]=e,c+=10)}),this.viewer.scene.overrideMaterial=null,this.viewer.ndsModel&&(this.viewer.ndsModel.setDirty(),this.viewer.ndsModel.setDrawMode(this.viewer.ndsModel.SHADED),this.viewer.scene.children.push(this.viewer.ndsModel),this.viewer.ndsModel.setOverrideMaterial(this.bodyIdMat,null,!0)),this.viewer.renderer.render(this.viewer.scene,this.viewer.camera,r,!0,!0),this.viewer.scene.overrideMaterial=i,this.viewer.ndsModel&&this.viewer.ndsModel.setOverrideMaterial(null,null,!1),this.viewer.scene.traverse(function(e){e.hasOwnProperty("geometry")&&e.hasOwnProperty("material")&&e.materialRaycasterRecord&&(e.material&&e.material.dispose(),e.material=e.materialRaycasterRecord,e.materialRaycasterRecord=void 0)}),(m=new Uint8Array(4))[0]=m[1]=m[2]=m[3]=0,this.viewer.renderer.readRenderTargetPixels(r,e[0]*g,r.height-e[1]*g,1,1,m),d=253<m[0]&&253<m[1]&&253<m[2])||(u=m[0]<<16|m[1]<<8|m[2],this.viewer.ndsModel?(p=this.viewer.ndsModel.getBodyNode(u/10))&&(s=(l=p).uuid):h[u]&&(s=(l=h[u]).uuid)),this.viewer.renderer.setRenderTarget(null),this.viewer.renderer.setClearColor(n,a),this.viewer.lightControls&&this.viewer.scene.add(this.viewer.lightControls._scene),this.viewer.render(),f=null,0<o.length?{coords:o,locationObjectUUID:s,locationObject:l}:f):null}}function fn(e,t){this.viewer=e;var r="waiter_"+Date.now(),i=((r=new Ce.Element({className:"waiter",id:r})).setVisibility(!1),new Ce.Element({className:"bounce1"})),n=new Ce.Element({className:"bounce2"}),a=new Ce.Element({className:"bounce3"});void 0!==t&&(i.setBgColor(t),n.setBgColor(t),a.setBgColor(t)),r.addSubElement(i),r.addSubElement(n),r.addSubElement(a),e.container.appendChild(r.domElement),e.waiter=r}function mn(){this.init=function(){THREE.Object3D.call(this),this.handles=new THREE.Object3D,this.pickers=new THREE.Object3D,this.planes=new THREE.Object3D,this.add(this.handles),this.add(this.pickers),this.add(this.planes);var o,e=new THREE.PlaneGeometry(50,50,2,2),t=new THREE.MeshBasicMaterial({visible:!1,side:THREE.DoubleSide}),r={XY:new THREE.Mesh(e,t),YZ:new THREE.Mesh(e,t),XZ:new THREE.Mesh(e,t),XYZE:new THREE.Mesh(e,t)};for(o in this.activePlane=r.XYZE,r.YZ.rotation.set(0,Math.PI/2,0),r.XZ.rotation.set(-Math.PI/2,0,0),r)r[o].name=o,this.planes.add(r[o]),this.planes[o]=r[o];function i(e,t){for(var r in e)for(o=e[r].length;o--;){var i=e[r][o][0],n=e[r][o][1],a=e[r][o][2];i.name=r,n&&i.position.set(n[0],n[1],n[2]),a&&i.rotation.set(a[0],a[1],a[2]),t.add(i)}}i(this.handleGizmos,this.handles),i(this.pickerGizmos,this.pickers),this.traverse(function(e){var t;e instanceof THREE.Mesh&&(e.updateMatrix(),(t=e.geometry.clone()).applyMatrix(e.matrix),e.geometry=t,e.position.set(0,0,0),e.rotation.set(0,0,0),e.scale.set(1,1,1))})},this.highlight=function(t){this.traverse(function(e){e.material&&e.material.highlight&&(e.name===t?e.material.highlight(!0):e.material.highlight(!1))})}}function gn(e){function t(e,t){var r=new Image,i=(r.crossOrigin="anonymous",new THREE.Texture(r));switch(e){case 0:r.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAGuSURBVDhPpZK/SwJxGMbPkwYVAg0CHcIlECPEU8iisS2i0Yi2hiiiKWpoiH6ttRQRDTk4RP9EtAQhJxYhRkNGQ9MRhIQEZp/3zs47bfOBh/e95/3h931flV7haVlF07QBj8ezhftpGMZutVr9sSJtkDNNzlSz2cwXi0VdNNWMAAQD0we3Q6HQuik6QHGM4kvcdL1eL1mqo0ELm7BC4l4qldIsiYp0OoC5gt9wvlwuN0QXuBrouv6FWYAyWp4mftF58jFNR3EXyXkT7Q/elrXxDiKRiMyfhYFwODxI8Q7+CcWHkuOEvUQn4vG41+fz3eCOwxp8aTQamVKpVJe4E/82ELC0YX65gqsyQoYl31kRNzqXaINiGcGM46+K/Q9dOxCw9UlMDl7DVzjLXp5YzyO+C10jJJPJoKqqcud++TRFRbmHcrpE5xW6RqD4HDMEl0muCtmBjBCEuWg06qpxjcDilph3A/eCwgNLNU/7wAgx3Bm/31/j+9aKOF5A8QjFR7jPnGzNUtvgZSsYef4+f7CEKQK7AcUTmDOem+XecnsXCoXCB7E53FM4Zoq9Q1F+AdSNjQGiWI24AAAAAElFTkSuQmCC";break;case 1:r.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAEnSURBVDhP3ZM9S8RAEIbz0ZhAsEgj+QF6pDjyYWFj5Q/wbyhiIYetCCeWtoKVxZWW9gaxECTR7mwFIVWw0c4Qn8ntrYa7RsXGB968k8nuzDJhjd9iKjfSNN3GlpumGRVFkU+yXeI4XrEsa4twnOf5meQseSju0a5pmqMoihYmqU/CMLTZfE64g3QDXYCKt9gJ6tm2fdgmv+A4zh62ho5YO1tAqOv6AHtEgyRJVtskcPQeNkR3rDlukwo9gynMQrrcoDFKqqqqfd+/lk8oprk00NjKNWVZPgdBsEi4id5c1+3jMrh9Nl/iHWZOIHAKF3tAS+hdYs/zNrIsa4g7zC0gUGQdy9Ar6tP9SfLfgkG+UOhKvc6l8xd+wn8vwL045XJdqNe/wDA+AM+DTooKvznTAAAAAElFTkSuQmCC";break;case 2:r.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAE0SURBVDhPpZI9S8RAEIbzQRCLA8FeFPsYErk6jf4HLbQQwfZK7fTA2sbeRixsxcreIiQgthbXWUXRFHbGZ3aXkGA2V9wDwzs7w8zObOIsimtUkSTJGNnTJysfeZ5Pjd9tEMfxPnKtT11c1/WRETajwYYKQqeBjTRN3aqqbnFlugkNrlQCPKODUHyKSPFdu1iY24B32UEusFfWOFbBFoMrULyG5JjsP+b2N4m3sU4QhuESco+tYgd9xYK1QRAEsqt81inFDyrYQ28DPuchcoI9lmV5roIW/r0BxVs81jPuu+d521mWfepMP/I4DVEUrVD0hDuq63qX0Wc6Y6dZQX4W3/dvcDexo6IoXlRiDs0KcjsNZNxfbv/W0X5YcZ3pvpSvIsDuyyQuzXEQLjhjwh9zXATH+QMUOlTdo/cuSQAAAABJRU5ErkJggg=="}r.onload=function(){i.needsUpdate=!0,c.parent.dispatchEvent({type:"change"})},e=new THREE.SpriteMaterial({map:i,depthTest:!1,depthWrite:!1,transparent:!0}),(e=new THREE.Sprite(e)).scale.set(.2,.2,1),e.material.needsUpdate=!0,t(e)}var r=this,i=(mn.call(this),!0),n=!0,a=!0,o=(e&&(i=0<=e.indexOf("translateX"),n=0<=e.indexOf("translateY"),a=0<=e.indexOf("translateZ")),new THREE.CylinderGeometry(0,.05,.1,12,1,!1)),s=new THREE.Mesh(o);s.position.y=.5,s.updateMatrix(),o.applyMatrix(s.matrix);(s=new THREE.BufferGeometry).addAttribute("position",new THREE.Float32BufferAttribute([0,0,0,.7,0,0],3));var l=new THREE.BufferGeometry,d=(l.addAttribute("position",new THREE.Float32BufferAttribute([0,0,0,0,.7,0],3)),new THREE.BufferGeometry),c=(d.addAttribute("position",new THREE.Float32BufferAttribute([0,0,0,0,0,.7],3)),this.handleGizmos={},i&&(this.handleGizmos.X=[[new THREE.Mesh(o,new A({color:16711680})),[.2,0,0],[0,0,-Math.PI/2]],[new THREE.Line(s,new M({color:16711680}))]]),n&&(this.handleGizmos.Y=[[new THREE.Mesh(o,new A({color:65280})),[0,.2,0]],[new THREE.Line(l,new M({color:65280}))]]),a&&(this.handleGizmos.Z=[[new THREE.Mesh(o,new A({color:255})),[0,0,.2],[Math.PI/2,0,0]],[new THREE.Line(d,new M({color:255}))]]),this);Pe.isMobileDevice()||e||(t(0,function(e){e.position.set(.9,0,0),r.handleGizmos.X&&r.handleGizmos.X[0][0].add(e)}),t(1,function(e){e.position.set(0,.9,0),r.handleGizmos.Y&&r.handleGizmos.Y[0][0].add(e)}),t(2,function(e){e.position.set(0,0,.9),r.handleGizmos.Z&&r.handleGizmos.X&&r.handleGizmos.Y&&r.handleGizmos.Z[0][0].add(e)})),i&&n&&a&&(this.handleGizmos.XY=[[new THREE.Mesh(new THREE.PlaneGeometry(.29,.29),new A({color:16776960,opacity:.25})),[.15,.15,0]]],this.handleGizmos.YZ=[[new THREE.Mesh(new THREE.PlaneGeometry(.29,.29),new A({color:65535,opacity:.25})),[0,.15,.15],[0,Math.PI/2,0]]],this.handleGizmos.XZ=[[new THREE.Mesh(new THREE.PlaneGeometry(.29,.29),new A({color:16711935,opacity:.25})),[.15,0,.15],[-Math.PI/2,0,0]]]),this.pickerGizmos={},i&&(this.pickerGizmos.X=[[new THREE.Mesh(new THREE.CylinderGeometry(.2,0,1,4,1,!1),Tn),[.6,0,0],[0,0,-Math.PI/2]]]),n&&(this.pickerGizmos.Y=[[new THREE.Mesh(new THREE.CylinderGeometry(.2,0,1,4,1,!1),Tn),[0,.6,0]]]),a&&(this.pickerGizmos.Z=[[new THREE.Mesh(new THREE.CylinderGeometry(.2,0,1,4,1,!1),Tn),[0,0,.6],[Math.PI/2,0,0]]]),i&&n&&a&&(this.pickerGizmos.XYZ=[[new THREE.Mesh(new THREE.OctahedronGeometry(.2,0),Tn)]],this.pickerGizmos.XY=[[new THREE.Mesh(new THREE.PlaneGeometry(.4,.4),Tn),[.2,.2,0]]],this.pickerGizmos.YZ=[[new THREE.Mesh(new THREE.PlaneGeometry(.4,.4),Tn),[0,.2,.2],[0,Math.PI/2,0]]],this.pickerGizmos.XZ=[[new THREE.Mesh(new THREE.PlaneGeometry(.4,.4),Tn),[.2,0,.2],[-Math.PI/2,0,0]]]),this.setActivePlane=function(e,t){var r=new THREE.Matrix4;t.applyMatrix4(r.getInverse(r.extractRotation(this.planes.XY.matrixWorld))),"X"===e&&(this.activePlane=this.planes.XY,Math.abs(t.y)>Math.abs(t.z))&&(this.activePlane=this.planes.XZ),"Y"===e&&(this.activePlane=this.planes.XY,Math.abs(t.x)>Math.abs(t.z))&&(this.activePlane=this.planes.YZ),"Z"===e&&(this.activePlane=this.planes.XZ,Math.abs(t.x)>Math.abs(t.y))&&(this.activePlane=this.planes.YZ),"XYZ"===e&&(this.activePlane=this.planes.XYZE),"XY"===e&&(this.activePlane=this.planes.XY),"YZ"===e&&(this.activePlane=this.planes.YZ),"XZ"===e&&(this.activePlane=this.planes.XZ)},this.init()}function vn(e,t){mn.call(this);var r=new THREE.BufferGeometry,i=new Float32Array([-.1,0,0,0,.3,0,0,0,-.1,0,0,-.1,0,.3,0,.1,0,0,.1,0,0,0,.3,0,0,0,.1,0,0,.1,0,.3,0,-.1,0,0,-.1,0,0,0,-.3,0,0,0,-.1,0,0,-.1,0,-.3,0,.1,0,0,.1,0,0,0,-.3,0,0,0,.1,0,0,.1,0,-.3,0,-.1,0,0]),n=new THREE.CylinderGeometry(0,.05,.1,12,1,!1),a=((n=new THREE.Mesh(n,new A({color:16711680}))).rotateX(Math.PI),n.scale.set(1.1,1.1,1.1),n.position.set(0,0,.5),r.addAttribute("position",new THREE.BufferAttribute(i,3)),new THREE.MeshBasicMaterial({color:16711680}));new THREE.Mesh(r,a).position.set(.5,0,0),r.addAttribute("position",new THREE.BufferAttribute(i,3)),(a=new THREE.Mesh(r,new A({color:16711680}))).scale.set(.5,.5,.5),a.position.set(0,0,.5),(i=new THREE.Mesh(r,new A({color:65280}))).scale.set(.5,.5,.5),i.rotateZ(Math.PI/2),i.position.set(0,0,.5);(r=new THREE.Mesh(r,new A({color:255}))).scale.set(.5,.5,.5),r.position.set(.5,0,0);var o=e?2*Math.PI:Math.PI;this.handleGizmos={X:[[new THREE.Mesh(new THREE.TorusGeometry(.5,.01,10,40,o),new A({color:16711680})),[0,0,0],[0,-Math.PI/2,-Math.PI/2]],t?[n]:[a]],Y:[[new THREE.Mesh(new THREE.TorusGeometry(.5,.01,10,40,Math.PI),new A({color:65280})),[0,0,0],[Math.PI/2,0,0]],[i]],Z:[[new THREE.Mesh(new THREE.TorusGeometry(.5,.01,10,40,Math.PI),new A({color:255})),[0,0,0],[0,0,-Math.PI/2]],[r]],XYZE:[[new THREE.Line(new function(e,t,r){var i=new THREE.BufferGeometry,n=[];r=r||1;for(var a=0;a<=64*r;++a)"x"===t&&n.push(0,Math.cos(a/32*Math.PI)*e,Math.sin(a/32*Math.PI)*e),"y"===t&&n.push(Math.cos(a/32*Math.PI)*e,0,Math.sin(a/32*Math.PI)*e),"z"===t&&n.push(Math.sin(a/32*Math.PI)*e,Math.cos(a/32*Math.PI)*e,0);return i.addAttribute("position",new THREE.Float32BufferAttribute(n,3)),i}(.5,"z",1),new M({color:7895160}))]]},this.pickerGizmos={X:[[new THREE.Mesh(new THREE.TorusGeometry(.5,.12,4,12,o),Tn),[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new THREE.Mesh(new THREE.TorusGeometry(.5,.12,4,12,Math.PI),Tn),[0,0,0],[Math.PI/2,0,0]]],Z:[[new THREE.Mesh(new THREE.TorusGeometry(.5,.12,4,12,Math.PI),Tn),[0,0,0],[0,0,-Math.PI/2]]],XYZE:[[new THREE.Mesh(new THREE.Geometry)]]},this.setActivePlane=function(e){"E"===e&&(this.activePlane=this.planes.XYZE),"X"===e&&(this.activePlane=this.planes.YZ),"Y"===e&&(this.activePlane=this.planes.XZ),"Z"===e&&(this.activePlane=this.planes.XY)},this.update=function(e,t){mn.prototype.update.apply(this,arguments);this.handles,this.pickers;var r=new THREE.Matrix4,i=new THREE.Euler(0,0,1),n=new THREE.Quaternion,a=new THREE.Vector3(1,0,0),o=new THREE.Vector3(0,1,0),s=new THREE.Vector3(0,0,1),l=new THREE.Quaternion,d=new THREE.Quaternion,c=new THREE.Quaternion,h=t.clone();i.copy(this.planes.XY.rotation),n.setFromEuler(i),r.makeRotationFromQuaternion(n).getInverse(r),h.applyMatrix4(r),this.traverse(function(e){n.setFromEuler(i),"X"===e.name&&(l.setFromAxisAngle(a,Math.atan2(-h.y,h.z)),n.multiplyQuaternions(n,l),e.quaternion.copy(n)),"Y"===e.name&&(d.setFromAxisAngle(o,Math.atan2(h.x,h.z)),n.multiplyQuaternions(n,d),e.quaternion.copy(n)),"Z"===e.name&&(c.setFromAxisAngle(s,Math.atan2(h.y,h.x)),n.multiplyQuaternions(n,c),e.quaternion.copy(n))})},this.showAxis=function(e,t){if(void 0!==e&&""!==e)switch(e){case"x":this.handleGizmos.X[0][0].visible=t,this.handleGizmos.X[1][0].visible=t,this.pickerGizmos.X[0][0].visible=t;break;case"y":this.handleGizmos.Y[0][0].visible=t,this.handleGizmos.Y[1][0].visible=t,this.pickerGizmos.Y[0][0].visible=t;break;case"z":this.handleGizmos.Z[0][0].visible=t,this.handleGizmos.Z[1][0].visible=t,this.pickerGizmos.Z[0][0].visible=t;break;case"e":this.handleGizmos.XYZE[0][0].visible=t,this.pickerGizmos.XYZE[0][0].visible=t}},this.init(),e&&"translateX"==e[0]&&(this.showAxis("y",!1),this.showAxis("z",!1),this.showAxis("e",!1))}function yn(e,t){var r=this;THREE.Object3D.call(this),this._gizmoTranslate=new gn(e),this._gizmoRotate=new vn(e,t),this.add(this._gizmoTranslate),this.add(this._gizmoRotate),this._translatePickers=this._gizmoTranslate.pickers,this._rotatePickers=this._gizmoRotate.pickers,this.activePlane=this._gizmoTranslate.activePlane,this.highlight=function(e,t){"translate"==t?(this._gizmoRotate.highlight(null),this._gizmoTranslate.highlight(e)):"rotate"==t&&(this._gizmoTranslate.highlight(null),this._gizmoRotate.highlight(e))},this.setActivePlane=function(e,t){"translate"==r.pickType?(this._gizmoTranslate.setActivePlane(e,t),this.activePlane=this._gizmoTranslate.activePlane):"rotate"==r.pickType&&(this._gizmoRotate.setActivePlane(e,t),this.activePlane=this._gizmoRotate.activePlane)},this.update=function(e,t){this._gizmoTranslate.update(e,t),this._gizmoRotate.update(e,t)}}function An(){mn.call(this);var e=new THREE.BoxGeometry(.125,.125,.125),t=new THREE.Mesh(e);t.position.y=.5,t.updateMatrix(),e.applyMatrix(t.matrix);(t=new THREE.BufferGeometry).addAttribute("position",new THREE.Float32BufferAttribute([0,0,0,1,0,0],3));var r=new THREE.BufferGeometry,i=(r.addAttribute("position",new THREE.Float32BufferAttribute([0,0,0,0,1,0],3)),new THREE.BufferGeometry);i.addAttribute("position",new THREE.Float32BufferAttribute([0,0,0,0,0,1],3)),this.handleGizmos={X:[[new THREE.Mesh(e,new A({color:16711680})),[.5,0,0],[0,0,-Math.PI/2]],[new THREE.Line(t,new M({color:16711680}))]],Y:[[new THREE.Mesh(e,new A({color:65280})),[0,.5,0]],[new THREE.Line(r,new M({color:65280}))]],Z:[[new THREE.Mesh(e,new A({color:255})),[0,0,.5],[Math.PI/2,0,0]],[new THREE.Line(i,new M({color:255}))]],XYZ:[[new THREE.Mesh(new THREE.BoxGeometry(.125,.125,.125),new A({color:16777215,opacity:.25}))]]},this.pickerGizmos={X:[[new THREE.Mesh(new THREE.CylinderGeometry(.2,0,1,4,1,!1),Tn),[.6,0,0],[0,0,-Math.PI/2]]],Y:[[new THREE.Mesh(new THREE.CylinderGeometry(.2,0,1,4,1,!1),Tn),[0,.6,0]]],Z:[[new THREE.Mesh(new THREE.CylinderGeometry(.2,0,1,4,1,!1),Tn),[0,0,.6],[Math.PI/2,0,0]]],XYZ:[[new THREE.Mesh(new THREE.BoxGeometry(.4,.4,.4),Tn)]]},this.setActivePlane=function(e,t){var r=new THREE.Matrix4;t.applyMatrix4(r.getInverse(r.extractRotation(this.planes.XY.matrixWorld))),"X"===e&&(this.activePlane=this.planes.XY,Math.abs(t.y)>Math.abs(t.z))&&(this.activePlane=this.planes.XZ),"Y"===e&&(this.activePlane=this.planes.XY,Math.abs(t.x)>Math.abs(t.z))&&(this.activePlane=this.planes.YZ),"Z"===e&&(this.activePlane=this.planes.XZ,Math.abs(t.x)>Math.abs(t.y))&&(this.activePlane=this.planes.YZ),"XYZ"===e&&(this.activePlane=this.planes.XYZE)},this.init()}function Mn(l,d,O,F,i,n){THREE.Object3D.call(this),d=void 0!==d?d:document,this.object=void 0,this.viewer=O,this.visible=!1,this.translationSnap=null,this.rotationSnap=null,this.space="world",this.size=.5,this.axis=null,this.pickType=null,this.newPosition=new THREE.Vector3,this.down=!1,this.opBall=F,this.piovtDir=null;var U,c=this,a="translate",o=!1,s={translate:new gn(i),rotate:new vn(i),both:new yn(i,n),scale:new An};for(U in s){var N=s[U];N.visible=U===a,this.add(N)}var h={type:"change"},V={type:"mouseDown"},G={type:"mouseUp",mode:a},k=(document.createEvent("HTMLEvents").initEvent("mousemove",!0,!0),{type:"objectChange"}),j=new THREE.Raycaster,z=new THREE.Vector2,r=new THREE.Vector3,u=new THREE.Vector3,W=new THREE.Vector3,p=0,f=0,m=0,e=new THREE.Vector3,t=new THREE.Vector3,X=1,q=new THREE.Matrix4,g=new THREE.Vector3,v=new THREE.Matrix4,y=new THREE.Vector3,A=new THREE.Quaternion,M=new THREE.Vector3(1,0,0),E=new THREE.Vector3(0,1,0),w=new THREE.Vector3(0,0,1),x=new THREE.Quaternion,b=new THREE.Quaternion,B=new THREE.Quaternion,I=new THREE.Quaternion,Y=new THREE.Quaternion,T=new THREE.Quaternion,S=new THREE.Vector3,Q=new THREE.Vector3,R=new THREE.Vector3,K=new THREE.Matrix4,C=new THREE.Matrix4,Z=new THREE.Vector3(1,1,1),D=new THREE.Vector3,J=new THREE.Euler,P=new THREE.Matrix4,$=new THREE.Vector3,ee=new THREE.Euler;function H(e){if((!De.enableBroadcast||De.broadcastMajor)&&!(void 0===c.object||!0===o||void 0!==e.button&&0!==e.button||c.down)){var t=e.changedTouches?e.changedTouches[0]:e,r=null;if("both"!=a)r=L(t,s[a].pickers.children);else if(r=L(t,s[a]._rotatePickers.children))c.pickType="rotate";else if(r=L(t,s[a]._translatePickers.children)){if(n)return;c.pickType="translate"}t=null;r&&(t=r.object.name,e.preventDefault()),c.axis!==t&&(c.axis=t,c.update(),c.dispatchEvent(h))}}function te(e){var t,r;De.enableBroadcast&&!De.broadcastMajor||(e.offsetX||(e.clientX,this.viewer.container.getBoundingClientRect().left),e.offsetY||(e.clientY,this.viewer.container.getBoundingClientRect().top),e.srcElement&&e.srcElement!==this&&(e.clientX,this.viewer.container.getBoundingClientRect().left,e.clientY,this.viewer.container.getBoundingClientRect().top),null==e.srcElement&&e.target&&e.target!==this&&(e.clientX,this.viewer.container.getBoundingClientRect().left,e.clientY,this.viewer.container.getBoundingClientRect().top),void 0===c.object)||!0===o||void 0!==e.button&&0!==e.button||(0!==(t=e.changedTouches?e.changedTouches[0]:e).button&&void 0!==t.button||(r=null,"both"!=a?(r=L(t,s[a].pickers.children))&&(c.pickType=a):(r=L(t,s[a]._rotatePickers.children))?(c.pickType="rotate",(n||i)&&"X"!=r.object.name&&(r=null)):((r=L(t,s[a]._translatePickers.children))&&(c.pickType="translate"),n&&(r=null)),r?(e.preventDefault(),e.stopPropagation(),c.dispatchEvent(V),c.axis=r.object.name,c.down=!0,c.update(),g.copy($).sub(D).normalize(),s[a].setActivePlane(c.axis,g),(e=L(t,[s[a].activePlane]))&&(S.copy(c.object.position),Q.copy(c.object.position),R.copy(c.object.scale),K.extractRotation(c.object.matrix),P.extractRotation(c.object.matrixWorld),c.object.parent&&(C.extractRotation(c.object.parent.matrixWorld),Z.setFromMatrixScale(v.getInverse(c.object.parent.matrixWorld))),u.copy(e.point))):(c.axis=null,c.update(),c.down=!1,c.pickType="default",c.dispatchEvent(h))),o=!0)}function re(){"translate"===a||"translate"==c.pickType?(r.sub(u),"local"===c.space&&(c.piovtDir?r.projectOnVector(c.piovtDir):(-1===c.axis.search("X")&&(r.x=0),-1===c.axis.search("Y")&&(r.y=0),-1===c.axis.search("Z")&&(r.z=0)),c.object.position.copy(S),c.object.position.add(r),(W=c.object.position.clone()).sub(Q),c.newPosition=c.object.position.clone(),Q.copy(c.newPosition)),"world"!==c.space&&-1===c.axis.search("XYZ")||(-1===c.axis.search("X")&&(r.x=0),-1===c.axis.search("Y")&&(r.y=0),-1===c.axis.search("Z")&&(r.z=0),r.applyMatrix4(v.getInverse(C)),c.object.position.copy(S),c.object.position.add(r)),null!==c.translationSnap&&("local"===c.space&&c.object.position.applyMatrix4(v.getInverse(P)),-1!==c.axis.search("X")&&(c.object.position.x=Math.round(c.object.position.x/c.translationSnap)*c.translationSnap),-1!==c.axis.search("Y")&&(c.object.position.y=Math.round(c.object.position.y/c.translationSnap)*c.translationSnap),-1!==c.axis.search("Z")&&(c.object.position.z=Math.round(c.object.position.z/c.translationSnap)*c.translationSnap),"local"===c.space)&&c.object.position.applyMatrix4(P)):"scale"===a?(r.sub(u),r.multiply(Z),"local"===c.space&&("XYZ"===c.axis?(X=1+r.y/Math.max(R.x,R.y,R.z),c.object.scale.x=R.x*X,c.object.scale.y=R.y*X,c.object.scale.z=R.z*X):(r.applyMatrix4(v.getInverse(P)),"X"===c.axis&&(c.object.scale.x=R.x*(1+r.x/R.x)),"Y"===c.axis&&(c.object.scale.y=R.y*(1+r.y/R.y)),"Z"===c.axis&&(c.object.scale.z=R.z*(1+r.z/R.z))))):"rotate"!==a&&"rotate"!=c.pickType||(r.sub(D),r.multiply(Z),y.copy(u).sub(D),y.multiply(Z),"E"===c.axis?(r.applyMatrix4(v.getInverse(q)),y.applyMatrix4(v.getInverse(q)),e.set(Math.atan2(r.z,r.y),Math.atan2(r.x,r.z),Math.atan2(r.y,r.x)),t.set(Math.atan2(y.z,y.y),Math.atan2(y.x,y.z),Math.atan2(y.y,y.x)),A.setFromRotationMatrix(v.getInverse(C)),Y.setFromAxisAngle(g,e.z-t.z),x.setFromRotationMatrix(P),A.multiplyQuaternions(A,Y),A.multiplyQuaternions(A,x),c.object.quaternion.copy(A)):"XYZE"===c.axis?(Y.setFromEuler(r.clone().cross(y).normalize()),A.setFromRotationMatrix(v.getInverse(C)),b.setFromAxisAngle(Y,-r.clone().angleTo(y)),x.setFromRotationMatrix(P),A.multiplyQuaternions(A,b),A.multiplyQuaternions(A,x),c.object.quaternion.copy(A)):"local"===c.space?(r.applyMatrix4(v.getInverse(P)),y.applyMatrix4(v.getInverse(P)),e.set(Math.atan2(r.z,r.y),Math.atan2(r.x,r.z),Math.atan2(r.y,r.x)),t.set(Math.atan2(y.z,y.y),Math.atan2(y.x,y.z),Math.atan2(y.y,y.x)),x.setFromRotationMatrix(K),null!==c.rotationSnap?(b.setFromAxisAngle(M,Math.round((e.x-t.x)/c.rotationSnap)*c.rotationSnap),B.setFromAxisAngle(E,Math.round((e.y-t.y)/c.rotationSnap)*c.rotationSnap),I.setFromAxisAngle(w,Math.round((e.z-t.z)/c.rotationSnap)*c.rotationSnap)):(b.setFromAxisAngle(M,e.x-t.x),B.setFromAxisAngle(E,e.y-t.y),I.setFromAxisAngle(w,e.z-t.z)),"X"===c.axis&&x.multiplyQuaternions(x,b),"Y"===c.axis&&x.multiplyQuaternions(x,B),"Z"===c.axis&&x.multiplyQuaternions(x,I),c.object.quaternion.copy(x)):"world"===c.space&&(e.set(Math.atan2(r.z,r.y),Math.atan2(r.x,r.z),Math.atan2(r.y,r.x)),t.set(Math.atan2(y.z,y.y),Math.atan2(y.x,y.z),Math.atan2(y.y,y.x)),A.setFromRotationMatrix(v.getInverse(C)),null!==c.rotationSnap?(b.setFromAxisAngle(M,Math.round((e.x-t.x)/c.rotationSnap)*c.rotationSnap),B.setFromAxisAngle(E,Math.round((e.y-t.y)/c.rotationSnap)*c.rotationSnap),I.setFromAxisAngle(w,Math.round((e.z-t.z)/c.rotationSnap)*c.rotationSnap)):(b.setFromAxisAngle(M,e.x-t.x),B.setFromAxisAngle(E,e.y-t.y),I.setFromAxisAngle(w,e.z-t.z)),x.setFromRotationMatrix(P),"X"===c.axis&&A.multiplyQuaternions(A,b),"Y"===c.axis&&A.multiplyQuaternions(A,B),"Z"===c.axis&&A.multiplyQuaternions(A,I),A.multiplyQuaternions(A,x),c.object.quaternion.copy(A))),c.update(),c.dispatchEvent(h),c.dispatchEvent(k)}function ie(e){var t;De.enableBroadcast&&!De.broadcastMajor||void 0===c.object||null===c.axis||!1===o||void 0!==e.button&&0!==e.button||!1!==(t=L(e.changedTouches?e.changedTouches[0]:e,[s[a].activePlane]))&&(e.preventDefault(),e.stopPropagation(),r.copy(t.point),re())}function _(e){De.enableBroadcast&&!De.broadcastMajor||(e.preventDefault(),void 0!==e.button&&0!==e.button)||(o&&null!==c.axis&&(G.mode=a,c.dispatchEvent(G)),o=!1,c.down=!1,"TouchEvent"in window&&e instanceof TouchEvent?(c.axis=null,c.update(),c.dispatchEvent(h)):H(e))}function L(e,t){var r=d.getBoundingClientRect(),i=r.width,n=r.height,i=(null!=d.clientWidth&&null!=d.clientHeight&&(10<Math.abs(i-d.clientWidth)&&(i=d.clientWidth),10<Math.abs(n-d.clientHeight))&&(n=d.clientHeight),(e.clientX-r.left)/i),e=(e.clientY-r.top)/n,a=(z.set(2*i-1,-2*e+1),l.setCastRay(j,z.x,z.y),j.intersectObjects(t,!0)),o=a[0];if(c.piovtDir)for(var s=0;s<a.length;s++)a[s].object.visible&&(o=a[s]);return o||!1}Pe.isMobileDevice()?(d.addEventListener("touchstart",te,!1),d.addEventListener("touchmove",H,!1),d.addEventListener("touchmove",ie,!0),d.addEventListener("touchend",_,!1),d.addEventListener("touchcancel",_,!1)):(d.addEventListener("mousedown",te,!1),d.addEventListener("mousemove",H,!1),d.addEventListener("mousemove",ie,!0),d.addEventListener("mouseup",_,!1)),this.setPiovtDir=function(e){this.piovtDir=e.clone()},this.getOffset=function(){return W},this.getRotate=function(){return x},this.getRotateAngle=function(){return p*Math.PI/180},this.getMultiRotateAngle=function(){return m},this.setMultiRotateAngle=function(e){m=e},this.getRotateOffset=function(){return T},this.initRotateOffset=function(){T.set(0,0,0,1),p=0},this.isDragging=function(){return o},this.isSelected=function(){return null!=c.axis},this.setOldPosition=function(e){e&&S.copy(e)},this.getOldPosition=function(){return S},this.dispose=function(){Pe.isMobileDevice()?(d.removeEventListener("touchstart",te),d.removeEventListener("touchmove",H),d.removeEventListener("touchmove",ie),d.removeEventListener("touchend",_),d.removeEventListener("touchcancel",_),d.removeEventListener("touchleave",_)):(d.removeEventListener("mousedown",te),d.removeEventListener("mousemove",H),d.removeEventListener("mousemove",ie),d.removeEventListener("mouseup",_),d.removeEventListener("mouseout",_))},this.attach=function(e){this.object=e,this.visible=!0,this.update()},this.detach=function(){this.object=void 0,this.visible=!1,this.axis=null},this.getMode=function(){return a},this.setMode=function(e){for(var t in"scale"===(a=e||a)&&(c.space="local"),s)s[t].visible=t===a;this.update(),c.dispatchEvent(h)},this.setTranslationSnap=function(e){c.translationSnap=e},this.setRotationSnap=function(e){c.rotationSnap=e},this.setSize=function(e){c.size=e,this.update(),c.dispatchEvent(h)},this.setSpace=function(e){c.space=e,this.update(),c.dispatchEvent(h)},this.MoveFromTextValue=function(e){var t;parseFloat(c.textBox.value);a=e.mode,t=e.value,c.axis=e.axis,"translate"===a||"translate"==c.pickType?(r.copy(u),r.x+=t,r.y+=t,r.z+=t,re()):"rotate"!==a&&"rotate"!=c.pickType||(t=t*Math.PI/180,x.setFromRotationMatrix(K),"X"===c.axis?(b.setFromAxisAngle(M,t),x.multiplyQuaternions(x,b),T.copy(b)):"Y"===c.axis?(B.setFromAxisAngle(E,t),x.multiplyQuaternions(x,B),T.copy(B)):"Z"===c.axis&&(I.setFromAxisAngle(w,t),x.multiplyQuaternions(x,I),T.copy(I)),c.object.quaternion.copy(x)),c.opBall.onOpBall()},this.SetTextValue=function(){var e,t,r={mode:null,x:0,y:0,z:0};return"translate"===a||"translate"==c.pickType?(r.mode="translate",-1!=c.axis.search("X")?r.x=(this.newPosition.x-S.x).toFixed(4):-1!=c.axis.search("Y")?r.y=(this.newPosition.y-S.y).toFixed(4):-1!=c.axis.search("Z")&&(r.z=(this.newPosition.z-S.z).toFixed(4))):"rotate"!==a&&"rotate"!=c.pickType||(r.mode="rotate",e=new THREE.Euler,t=0,-1!=c.axis.search("X")?(t=180*e.setFromQuaternion(b).x/Math.PI,r.x=t.toFixed(1),f=t-p,(p=t)<0?m+=f<-180?360+f:f:180<f?m-=360-f:m+=f,this.piovtDir?T.setFromAxisAngle(this.piovtDir,f*Math.PI/180):T.setFromAxisAngle(M,f*Math.PI/180)):-1!=c.axis.search("Y")?(e.setFromQuaternion(B),t=180*e.y/Math.PI,Math.abs(Math.abs(e.x)-Math.PI)<1e-5&&(t=(180-Math.abs(t))*t/Math.abs(t)),r.y=t.toFixed(1),f=t-p,p=t,T.setFromAxisAngle(E,f*Math.PI/180)):-1!=c.axis.search("Z")&&(t=180*e.setFromQuaternion(I).z/Math.PI,r.z=t.toFixed(1),f=t-p,p=t,T.setFromAxisAngle(w,f*Math.PI/180))),r},this.update=function(){var e,t,r,i;void 0!==c.object&&(c.object.updateMatrixWorld(),D.setFromMatrixPosition(c.object.matrixWorld),J.setFromRotationMatrix(v.extractRotation(c.object.matrixWorld)),l.updateMatrixWorld(),$.setFromMatrixPosition(l.matrixWorld),ee.setFromRotationMatrix(v.extractRotation(l.matrixWorld)),l.updateMatrix(),e=l.getCameraTarget(),r=l.position,(i=new THREE.Vector3).subVectors(e,r),t=D.clone(),t=l.isPerspective?t.sub(r).dot(i.normalize()):1.2*i.length(),r=l.fov,i=120*(2*t*Math.tan(THREE.Math.degToRad(.5*r)))/d.height*c.size,Pe.isMobileDevice()&&(i*=3),this.position.copy(D),this.scale.set(i,i,i),g.copy($).sub(e).normalize(),"local"===c.space?s[a].update(J,g):"world"===c.space&&s[a].update(new THREE.Euler,g),s[a].highlight(c.axis,c.pickType))}}function Oe(e){a.call(this,e),this.type="OpBall",this.opMode="move",this._setModel="both",this.translateScene=null,this.clipTransRotControl=null,this.clipObjectBox=null,this.geomPointSize=.04,this.domElement=null,this.WorldPosition=new THREE.Vector3,this.IntersectModel=null,this.MoveObjects=[],e.canvas2D?this.domElement=e.canvas2D:this.domElement=e.canvas3D,this.piovtRotatePos=null,this.piovtRotateDir=null,this.piovtRotateMid=null;var u=this,p=new THREE.Matrix4,f=new THREE.Matrix4,m=new THREE.Matrix4,g=new THREE.Matrix4,v=new THREE.Matrix4;this.DecomposeQuaternion=new THREE.Quaternion,this.DecomposePosition=new THREE.Vector3,this.DecomposeScale=new THREE.Vector3,this.preSelectedObjects=[],this.rotateAngle=0,this.angle=new THREE.Vector3,this.position=new THREE.Vector3,this.singleObject=null,this.emptyCenter=new THREE.Vector3,this.updateOpballCenter=function(e){if(u.MoveObjects=u.viewer.selectionManager.getSelectedleafObjects(),0==u.MoveObjects.length)u.translateScene&&"multiRotation"!=u._setModel&&(u.clipTransRotControl&&u.translateScene.remove(u.clipTransRotControl),u.clipObjectBox)&&u.translateScene.remove(u.clipObjectBox),u.render();else{for(var t=new THREE.Box3,r=0;r<u.MoveObjects.length;++r){var i=u.MoveObjects[r],n=null;i.isDrawGeom?(n=i.geometry.boundingBox.clone()).applyMatrix4(i.matrix):n=u.viewer.ndsModel.getBodyBoundingBox(i),n&&!n.isEmpty()&&(t.expandByPoint(n.max),t.expandByPoint(n.min))}u.emptyCenter.set(0,0,0),u.WorldPosition.copy(t.getCenter(u.emptyCenter)),u.render(),u.startMove()}},e.addEventListener("updateOpball",this.updateOpballCenter),this.mouseup=function(e){var t;u.clipTransRotControl&&(u.clipTransRotControl.object.matrixWorld.decompose(u.DecomposePosition,u.DecomposeQuaternion,u.DecomposeScale),u.piovtRotateDir||u.clipTransRotControl.totalquaternion.multiply(u.DecomposeQuaternion),u.startMove(!0,e),e=new THREE.Vector3,t=new THREE.Vector3,u.viewer.computeBoundingBox(u.viewer.scene,e,t,{flag:!0}),e.x>t.x||e.y>t.y||e.z>t.z||(u.viewer.controls.setBoundingBox(e,t),u.viewer.switchRotateCenterBySelection(),u.viewer.AnimationEdit&&u.viewer.AnimationEdit.dispatchFromTransformControl({type:"mouseUp"})))},this.onOpBall=function(){if(u.clipTransRotControl){var e=u.viewer.selectionManager.getSelectedleafObjects(!0),t=u.clipTransRotControl.getOffset(),r=u.clipTransRotControl.getRotateOffset(),i=(u.rotateAngle=u.clipTransRotControl.getRotateAngle(),t.clone());if(t.set(0,0,0),null==u.viewer.draggedObjects&&(u.viewer.draggedObjects=new Array),"translate"==u.clipTransRotControl.pickType){if(u.viewer.ndsModel)for(var n,a=0;a<e.length;++a)(c=e[a]).initBeginLocalMatrix||(c.beginLocalMatrix||(c.beginLocalMatrix=new THREE.Matrix4),c.matrix&&(c.isDrawGeom?c.beginLocalMatrix.fromArray(c.matrix.toArray()):c.beginLocalMatrix.fromArray(c.matrix)),c.initBeginLocalMatrix=!0),f.makeTranslation(i.x,i.y,i.z),c.isDrawGeom?(c.applyMatrix(f),c.updateMatrixWorld()):(v.copy(c.worldMatrix).premultiply(f),s=c.parent?c.parent.worldMatrix.clone():new THREE.Matrix4,(n=new THREE.Matrix4).getInverse(s),p=v.premultiply(n),u.viewer.ndsModel.updateNodeMatrix(c.uuid,p.toArray(),c.getModel().id),u.viewer.dispatchEvent({type:"OpBallTranslateMtx",bodyNode:c,matrix:f,mode:u.clipTransRotControl.pickType}));u.clipTransRotControl.SetTextValue()}else if("rotate"==u.clipTransRotControl.pickType){for(var o=(new THREE.Euler).setFromQuaternion(r),a=0;a<e.length;++a){var s,l,d,c=e[a];"multiRotation"!=u._setModel||c._multiSelectedMatrix||c.isDrawGeom||(c._multiSelectedMatrix=new THREE.Matrix4,c._multiSelectedMatrix.copy(c.worldMatrix),u.preSelectedObjects=e.filter(function(e){return!e.isDrawGeom})),c.initBeginLocalMatrix||(c.beginLocalMatrix||(c.beginLocalMatrix=new THREE.Matrix4),c.matrix&&(c.isDrawGeom?c.beginLocalMatrix.fromArray(c.matrix.toArray()):c.beginLocalMatrix.fromArray(c.matrix)),c.initBeginLocalMatrix=!0),m.makeTranslation(0,0,0),c.isDrawGeom?(g.makeTranslation(-u.WorldPosition.x,-u.WorldPosition.y,-u.WorldPosition.z),m.premultiply(g),g.makeRotationFromQuaternion(r),m.premultiply(g),g.makeTranslation(u.WorldPosition.x,u.WorldPosition.y,u.WorldPosition.z),m.premultiply(g),c.applyMatrix(m),c.updateMatrixWorld()):(v.copy(c.worldMatrix),s=c.parent?c.parent.worldMatrix.clone():new THREE.Matrix4,u.piovtRotatePos?(g.makeTranslation(-u.WorldPosition.x,-u.WorldPosition.y,-u.WorldPosition.z),v.premultiply(g),m.premultiply(g),g.makeRotationFromQuaternion(r),v.premultiply(g),m.premultiply(g),g.makeTranslation(u.piovtRotatePos.x,u.piovtRotatePos.y,u.piovtRotatePos.z),v.premultiply(g),m.premultiply(g),l=(new THREE.Vector3).subVectors(u.WorldPosition,u.piovtRotatePos),d=(new THREE.Vector3).copy(l).normalize().applyQuaternion(r),u.WorldPosition.copy(u.piovtRotatePos).addScaledVector(d,l.length()),g.makeTranslation(u.WorldPosition.x-u.piovtRotatePos.x,u.WorldPosition.y-u.piovtRotatePos.y,u.WorldPosition.z-u.piovtRotatePos.z),v.premultiply(g),m.premultiply(g),u.viewer.dispatchEvent({type:"OpBallTranslateMtx",bodyNode:c,piovtRotatePos:u.piovtRotatePos,quaternion:r,mode:u.clipTransRotControl.pickType})):(g.makeTranslation(-u.WorldPosition.x,-u.WorldPosition.y,-u.WorldPosition.z),v.premultiply(g),m.premultiply(g),g.makeRotationFromQuaternion(r),v.premultiply(g),m.premultiply(g),g.makeTranslation(u.WorldPosition.x,u.WorldPosition.y,u.WorldPosition.z),v.premultiply(g),m.premultiply(g),u.viewer.dispatchEvent({type:"OpBallTranslateMtx",bodyNode:c,piovtRotatePos:u.WorldPosition,quaternion:r,mode:u.clipTransRotControl.pickType})),g.getInverse(s),p=v.premultiply(g),u.viewer.ndsModel.updateNodeMatrix(c.uuid,p.toArray(),c.getModel().id)),c.originalEuler&&(u.piovtRotateDir?(c.originalEuler.x=o.x+c.originalEuler.x,c.originalEuler.y=o.y+c.originalEuler.y,c.originalEuler.z=o.z+c.originalEuler.z):"X"==u.clipTransRotControl.axis?c.originalEuler.x=o.x+c.originalEuler.x:"Y"==u.clipTransRotControl.axis?c.originalEuler.y=o.y+c.originalEuler.y:"Z"==u.clipTransRotControl.axis&&(c.originalEuler.z=o.z+c.originalEuler.z))}u.piovtRotateDir&&u.clipTransRotControl.totalquaternion.multiply(r),u.clipTransRotControl.SetTextValue()}u.updateclipTransRotControl(u.clipTransRotControl.pickType),u.dispatchPositonandAngle();var t=new THREE.Vector3,h=new THREE.Vector3;u.viewer.computeBoundingBox(u.viewer.scene,t,h,{flag:!0}),t.x>h.x||t.y>h.y||t.z>h.z||(u.viewer.controls.setBoundingBox(t,h),u.viewer.cameraControl.adjustNearAndFar(),u.render())}}}function En(e,t,r){THREE.Group.call(this),e=e||1e4,t=t||10,this.viewer=r,this.createGird=function(e,t){for(var r=new THREE.Color(16711680),i=new THREE.Color(6710886),n=(t=t<10?10:t)/2,a=e/t,o=e/2,s=[],l=[],d=0,c=0,h=-o;d<=t;d++,h+=a){s.push(-o,0,h,o,0,h),s.push(h,0,-o,h,0,o);var u=d===n?r:i;u.toArray(l,c),c+=3,u.toArray(l,c),c+=3,(u=d==n?new THREE.Color(255):u).toArray(l,c),c+=3,u.toArray(l,c),c+=3}var e=new THREE.BufferGeometry,p=(e.addAttribute("position",new THREE.Float32BufferAttribute(s,3)),e.addAttribute("color",new THREE.Float32BufferAttribute(l,3)),new THREE.LineBasicMaterial({vertexColors:!0})),e=new THREE.LineSegments(e,p);return e.name="GridLine",e};var r=this.createGird(e,t),e=(this.add(r),new THREE.SphereGeometry(.7,20,20)),t=new THREE.MeshPhongMaterial({color:0,depthTest:!0}),e=((r=new THREE.Mesh(e,t)).name="CenterHelp",this.add(r),this.name="GridHelper",null),o=this;e=e||new function(){this.getCameraScale=function(e,t){var r,i,n;return e?(t=null!=t?t:5,r=o.viewer.camera.getCameraTarget(),i=o.viewer.camera.position,(n=new THREE.Vector3).subVectors(r,i),r=e.clone(),e=o.viewer.camera.isPerspective?r.sub(i).dot(n.normalize()):1.2*n.length(),r=o.viewer.camera.fov,i=2*e*Math.tan(THREE.Math.degToRad(.5*r)),n=o.viewer.renderer.domElement.height,t*i*o.viewer.renderer.getPixelRatio()/n):1},this.run=function(){var e,t,r,i,n,a;o.viewer.scene.getObjectByName("GridHelper")&&(a=o.getObjectByName("CenterHelp"),e=o.getObjectByName("GridLine"),t=this.getCameraScale(a.position,7),a.scale.x=a.scale.y=a.scale.z=t,o.updateMatrixWorld(!0),o.matrixWorldNeedsUpdate=!0,e.geometry.computeBoundingBox(),n=e.geometry.boundingBox,i=new THREE.Vector3,n.getCenter(i),n=n.min.distanceTo(n.max),r=o.viewer.camera.position.clone(),i=Math.abs(i.distanceTo(r))+1.2*n,o.viewer.camera.far<i&&o.viewer.camera.adjustNearFar(i,i),r=o.viewer.renderer.domElement.width/20,n=o.viewer.clientCoordToModelCoord([0,0]),i=o.viewer.clientCoordToModelCoord([0,r]),r=new THREE.Vector3(i[0]-n[0],i[1]-n[1],i[2]-n[2]).length(),n=(i=(i=4*Math.max(Math.abs(o.viewer.camera.target.x-a.position.x),Math.abs(o.viewer.camera.target.y-a.position.y))*t)<40*r?40*r:i)/r,n=Math.round(n)%2==0?Math.round(n):Math.round(n)+1,a=o.createGird(i,n),o.remove(e),o.add(a))}},o.viewer.addFrameListener(e)}function wn(e){return"("+e.x+";"+e.y+")"}var xn=function(r){function e(e){var t=r.call(this,e)||this;return t.viewer=e,t.useDisaAttri=!1,t.disaAttriDefine=new Map,t}t=r,(i=e).prototype=Object.create(t.prototype),un(i.prototype.constructor=i,t);var t,i=e.prototype;return i.setDisaAttriDefine=function(e){this.useDisaAttri=!0;for(var t=0;t<e.length;t++)this.disaAttriDefine.set(e[t].Id,e[t])},i.getDisaObjectUUidToIndex=function(e){for(var t=[this.viewer.ndsModel.rootBodyNode],r=0;r<t.length;r++)if("Model"===t[r].type||"Assembly"===t[r].type||"Part"===t[r].type){null!=t[r].attrIndex&&e.set(t[r].attrIndex,{uuid:t[r].uuid,name:t[r].name});for(var i=0;i<t[r].children.length;i++)t.push(t[r].children[i])}},i.getObjectProperty=function(e,f,m){var t,g,v=e.uuid,y=this.useDisaAttri?e.attrUri:e.propertyfile;null==y?null!=f&&f(null,m):void 0!==this.cachedProperties&&this.cachedPropertyFileName==y&&null!=this.cachedProperties[v]&&null!=f?f(this.cachedProperties[v],m):((e=new Rt(this.loadingManager)).setCrossOrigin("anonymous"),e.setResponseType("arraybuffer"),t=function(e){e=e.split("/");return 1===e.length?"./":(e.pop(),e.join("/")+"/")}(this.viewer.modelInfo[0].url),e.load((g=this).viewer.gobalReqHeader,t+y,function(e){try{var t=pako.inflate(e,{to:"string"}),r=JSON.parse(t);if(g.useDisaAttri){for(var i=new Map,n=(g.getDisaObjectUUidToIndex(i),{}),a=0;a<r.length;a++){var o=i.get(a);if(o){for(var s={PropertyCategories:[],name:o.name},l=r[a],d=0;d<l.length;d++){var c=g.disaAttriDefine.get(l[d].DefId),h=[];if(c.Variables&&l[d].Values){for(var u=0;u<c.Variables.length;u++)h.push(c.Variables[u].Name),h.push(l[d].Values[u]);var p={};p[c.Name]=h,s.PropertyCategories.push(p)}}n[o.uuid]=s}}g.cachedProperties=n}else g.cachedProperties=r;null!=g.cachedProperties&&(g.cachedPropertyFileName=y,null!=f)&&(null!=g.cachedProperties[v]?f(g.cachedProperties[v],m):f(null,m))}catch(e){null!=f&&f(null,m)}},void 0,function(e){null!=f&&f(null,m)},!0))},e}(Ct),bn={vertexShader:["void main() {\n","#ifdef USE_MODELMATRIXATTRIB\n\tmat4 ndsModelViewMatrix = viewMatrix * modelMatrixAttrib;\n\tgl_Position = projectionMatrix * ndsModelViewMatrix * vec4( position, 1.0 );\n#else\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n#endif\n","}"].join("\n"),fragmentShader:["const float PackUpscale = 256. / 255.; // fraction -> 0..1 (including 1)","const float UnpackDownscale = 255. / 256.; // 0..1 -> fraction (excluding 1)","const vec3 PackFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );","const vec4 UnpackFactors = UnpackDownscale / vec4( PackFactors, 1. );","const float ShiftRight8 = 1. / 256.;","vec4 packDepthToRGBA( const in float v ) {","vec4 r = vec4( fract( v * PackFactors ), v );","r.yzw -= r.xyz * ShiftRight8; // tidy overflow","return r * PackUpscale;","}","float unpackRGBAToDepth( const in vec4 v ) {","return dot( v, UnpackFactors );","}","void main() {","gl_FragColor = packDepthToRGBA( gl_FragCoord.z);","}"].join("\n")},Bn=(["varying vec4 mvPosition;","void main() {","#ifdef USE_MODELMATRIXATTRIB\n\tmat4 ndsModelViewMatrix = viewMatrix * modelMatrixAttrib;\n\tmvPosition = ndsModelViewMatrix * vec4( position, 1.0 );\n#else\n\tmvPosition = modelViewMatrix * vec4( position, 1.0 );\n#endif\n","gl_Position = projectionMatrix * mvPosition;","}"].join("\n"),["uniform float cameraNear;","uniform float cameraFar;","varying vec4 mvPosition;","void main() {","float depth = gl_FragCoord.z / gl_FragCoord.w;","depth =smoothstep( cameraNear, cameraFar, depth );","gl_FragColor = vec4( mvPosition.xyz, depth);","}"].join("\n"),["varying vec3 vNormal;","void main() {","#ifdef USE_MODELMATRIXATTRIB\n\tmat4 ndsModelViewMatrix = viewMatrix * modelMatrixAttrib;\n\tvNormal =  normalize( mat3(ndsModelViewMatrix) * normal );\n\tgl_Position = projectionMatrix * ndsModelViewMatrix * vec4( position, 1.0 );\n#else\n\tvNormal =  normalize( mat3(modelViewMatrix) * normal );\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n#endif\n","}"].join("\n"),["varying vec3 vNormal;","void main() {","gl_FragColor = vec4( normalize(vNormal).xyz, 1.0);","}"].join("\n"),new THREE.Vector2(512,512),new THREE.Vector3(1,0,1),["varying vec2 vUv;","varying vec2 vExtent; ","vec2 getExtent() {","    vec2 extent;","    float a = projectionMatrix[2][2];","    float b = projectionMatrix[3][2];","    float nearOrthographic = (b + 1.0) / a;","    float farOrthographic = (b - 1.0) / a;","    float nearPerspective = b / (a - 1.0);","    float farPerspective = b / (a + 1.0);","    extent[0] = projectionMatrix[3][3] * nearOrthographic - projectionMatrix[2][3] * nearPerspective;","    extent[1] = projectionMatrix[3][3] * farOrthographic - projectionMatrix[2][3] * farPerspective;","    extent[1] -= extent[0];","    return extent;"," }","void main() {","vUv = uv;","vExtent = getExtent();","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),["varying vec2 vUv;","varying vec2 vExtent; ","uniform sampler2D tDiffuse;","uniform sampler2D tPosition;","uniform sampler2D tNormal;","uniform vec2 vSize;","uniform float fOccluderBias;","uniform vec3 vAttenuation;","uniform float fDistScale;","uniform float fOnlyAo;","uniform float fLumInfluence;","uniform float fRadiusNear;","uniform float fRadiusFar;","uniform float fIntensity;","#define nRadial 5 ","#define nAngular 5 ","#define minResolution 2e-4 ","float SamplePixels (vec3 srcPosition, vec3 srcNormal, vec2 uv)","{","   vec3 dstPosition = texture2D(tPosition, uv).xyz;","   vec3 positionVec = dstPosition - srcPosition;","   float len = length(positionVec);","   float intensity = fIntensity * max((dot(positionVec, srcNormal)- minResolution* vExtent[1])/len- fOccluderBias, 0.0);","   float dist  = fDistScale * len / vExtent[1];","   float attenuation = 1.0 / (vAttenuation.x + (vAttenuation.y * dist) + vAttenuation.z*dist*dist);","   return intensity * attenuation ;","}","vec2 rand( const vec2 coord ) {","vec2 noise;","float nx = dot ( coord, vec2( 12.9898, 78.233 ) );","float ny = dot ( coord, vec2( 12.9898, 78.233 ) * 2.0 );","noise = clamp( fract ( 43758.5453 * sin( vec2( nx, ny ) ) ), 0.0, 1.0 );","return ( noise * 2.0  - 1.0 );","}","float getRandomAngle(vec2 pos) {","vec2 rnd = rand(pos);","return atan(rnd.y, rnd.x);","}","void main ()","{","   vec3 srcPosition = texture2D(tPosition, vUv).xyz;","   float srcDepth = texture2D(tPosition, vUv).w;","   vec3 srcNormal = texture2D(tNormal, vUv).xyz;","   float ao = 0.0;"," float radiusMax = fRadiusNear + (fRadiusFar- fRadiusNear) * srcDepth;"," float radiusMin = radiusMax/float(nRadial);"," float angleStep = 6.2831853/float(nAngular);","  vec2 texelSize= 1.0/vSize;"," float angle = getRandomAngle(vUv);","   for (int i = 0; i < nRadial; ++i)","   {","       float radius = radiusMin*float(i+1);","       for(int j=0; j< nAngular; ++j){","           vec2 offset = radius * vec2(cos(angle),sin(angle));","           offset *= texelSize; ","           ao += SamplePixels(srcPosition, srcNormal, vUv + offset);","           angle += angleStep;","       }","       angle -= angleStep/2.0;","   }","   ao /= float(nRadial * nAngular);","\tao *= float(srcDepth < 1.0);","   ao = clamp(ao, 0.0, 1.0);","\tgl_FragColor.r = ao;","   gl_FragColor.a = 1.0;","}"].join("\n"),new THREE.Vector2(512,512),["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),["varying vec2 vUv;","uniform sampler2D tDiffuse;","uniform sampler2D tDiffuseOrginal;","uniform sampler2D tSSAOMap;","uniform vec2 vSize;","uniform float fOnlyAo;","uniform float fLumInfluence;","#define uFilterRadius 3","void main ()","{"," float occlusion = 0.0;"," float count = 0.0;"," vec2 texelSize= 1.0/vSize;"," for(int x= -uFilterRadius; x<= uFilterRadius; ++ x){","    for(int y = -uFilterRadius; y<= uFilterRadius; ++y){","        vec2 offset = vec2(x,y);","        float occulusionSample = texture2D(tSSAOMap, vUv + offset*texelSize).r;","        float weight = 1.0 / (1.0 + dot(offset, offset));","        occlusion += weight * occulusionSample;","        count += weight;","    }","}","occlusion /= count;","occlusion = clamp(occlusion, 0.0, 1.0);","occlusion = 1.0 - occlusion;","vec4 texelValue = texture2D(tDiffuseOrginal,vUv).rgba;","vec3 color = texelValue.rgb;","vec3 lumcoeff = vec3( 0.299, 0.587, 0.114 );","float lum = dot( color.rgb, lumcoeff );","vec3 luminance = vec3( lum );","vec3 aoResult = vec3( mix( vec3( occlusion ), vec3( 1.0 ), luminance * fLumInfluence ) );","if ( fOnlyAo == 1.0 )","\tgl_FragColor.xyz= aoResult;","else if ( fOnlyAo == 2.0 )","   gl_FragColor.xyz = color;","else","{","   gl_FragColor.xyz = color * aoResult;","}","gl_FragColor.w = texelValue.a;","}"].join("\n"),function(){function e(){}return e.isDISAPmiPrimaryObject=function(e){return!(!e||!e.type||10!==e.type&&20!==e.type&&21!==e.type&&22!==e.type&&23!==e.type&&24!==e.type&&25!==e.type&&26!==e.type&&30!==e.type&&31!==e.type&&32!==e.type&&33!==e.type&&34!==e.type&&40!==e.type)},e}()),In=function(){function e(P){this.viewer=P;var $=this,u=new Array,a=new Array,L=new Array,o=new Array,ee=new Array,p=new Array,E="body",d=(De.enablePreSelectBrep?E="vertex_edge_face":De.inAssemblyContext&&(E="component"),"replace"),c=new Array,h=new Array,f=new Array,m=new Array,g=new Array,v=new Array,l=null,y=null,A=null,M=null,w=null,x=null,b=3,n=new THREE.Scene,B=new THREE.Object3D,te=(n.add(B),this.selectfromtree=!1),re=null,ie=!1,ne=null,e=new THREE.MeshStandardMaterial({color:16763200,metalness:.2,roughness:1,side:THREE.DoubleSide,polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:2}),t=new THREE.MeshPhongMaterial({color:16763200,side:THREE.DoubleSide,opacity:.75,shiness:40,transparent:!0,depthTest:!1,blending:THREE.NormalBlending,polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:2}),r=(this.selectedObjects=ee,this.shouldApplySelectedMaterial=!0,[]);function I(){if($.viewer.ndsModel)$.viewer.ndsModel.clearSelection();else for(var e=$.viewer.getRenderMode(),t=0;t<o.length;++t){var r=o[t].key,i=o[t].value.oldMat;r.material=i,void 0!==r.material.colorWrite&&(4==e||5==e||8==e?r.material.colorWrite=!0:6!=e&&7!=e||(r instanceof THREE.Line||r instanceof THREE.LineSegments?r.material.colorWrite=!0:r.material.colorWrite=!1))}o.length=0,ee.length=0,p.length=0,B.children.length=0,c.length=0,h.length=0,f.length=0,m.length=0,g.length=0,v.length=0}function T(e,t){var r=!1,t=("face"!=t&&(l=null,y)&&(B.remove(y),r=!(y=null)),"edge"!=t&&(A=null,M)&&(B.remove(M),r=!(M=null)),"vertex"!=t&&(w=null,x)&&(B.remove(x),r=!(x=null)),$.viewer.ndsModel.clearPreSelection());(r||t)&&e&&$.viewer.render()}function S(e,t){return e.uuid==t.uuid&&e.ndsModel.id===t.ndsModel.id||!(!e.parent||!S(e.parent,t))}function O(e,t){if($.viewer.isLeaf(e)){for(var r=!1,i=$.getSelectedMeshes(),n=0,a=i.length;n<a;++n){var o=i[n].key;if(o.uuid==e.uuid||o.parent.uuid==e.uuid){r=!0;break}}r&&t.push(e)}else for(n=0,a=e.children.length;n<a;n++)O(e.children[n],t)}function F(e,t){if(void 0!==e&&!1!==e.visible&&!(e instanceof THREE.Light||"lightctrls"==e.name)){if(e.hasOwnProperty("geometry")){if(e instanceof THREE.Line){for(var r=0,i=a.length;r<i;r++)if(a[r]===e)return;a.push(e)}else t.push(e);L.push(e)}if(void 0!==e.children)for(var n=e.children,r=0,i=n.length;r<i;++r)F(n[r],t)}}function U(e,t,r){var i,n=!1;if(!P.pmiVisible&&P.pmiObject&&P.ndsModel.deselectPMIObject(P.pmiObject),P.pmiVisible&&P.pmiObject&&P.__globalMeasureExtension&&!P.__globalMeasureExtension.isInMeasureOp()){for(var a,o=P.renderer.domElement,s=P.renderer.getPixelRatio(),l=e*s/o.width*2-1,s=2*-(t*s/o.height)+1,d=((a=new THREE.Raycaster).linePrecision=1,new THREE.Vector3(0,0,0).project(P.camera)),c=new THREE.Vector3,h=(P.camera.getWorldDirection(c),new THREE.Vector3(0,1,0)),c=c.clone().cross(h).normalize().project(P.camera),h=d.distanceTo(c)*o.width,d=4,d=h>o.width/120?o.width/120:h<4?4:h,c=[0,0],o=P.clientCoordToModelCoord(c),h=new THREE.Vector3(o[0],o[1],o[2]),d=[d,0],u=P.clientCoordToModelCoord(d),p=new THREE.Vector3(u[0],u[1],u[2]),f=(a.linePrecision=h.distanceTo(p),P.camera.setCastRay(a,l,s),new THREE.Matrix4),m=new THREE.Ray,g=new THREE.Vector3,v=new THREE.Vector3,y=new THREE.Vector3,A=1/0,M=a.intersectObjects(P.leafPMIObjects,!0),E=null,w=0;w<M.length;w++){var x=M[w];if(x.object.visible){E=x;break}}if(M[0]&&M[0].index&&Number.isFinite(M[0].object.geometry.drawRange.count)){E=null;for(var b=0;b<M.length;b++){if(null!=M[b].faceIndex&&!E){E=M[b];break}var B=M[b].object.geometry.drawRange.count;if(Number.isFinite(B))for(var I,T,S,R,C,D=M[b].object.geometry.drawRange.start;D<M[b].object.geometry.drawRange.start+B;++D)D==M[b].index&&(I=M[b].object.matrixWorld,f.getInverse(I),m.copy(a.ray).applyMatrix4(f),I=M[b].object.geometry.index.array[D],T=M[b].object.geometry.index.array[D+1],v.fromArray(M[b].object.geometry.attributes.position.array,3*I),y.fromArray(M[b].object.geometry.attributes.position.array,3*T),I=m.distanceSqToSegment(v,y,null,g),T=y.sub(v),S=g.sub(v),R=T.length(),C=S.length(),T.normalize(),S.normalize(),C<R&&Math.abs(T.x-S.x)<1e-5&&Math.abs(T.y-S.y)<1e-5&&Math.abs(T.z-S.z)<1e-5||S.length()<1e-6)&&I<A&&(A=I,E=M[b])}}if(E){if(n=!!E.object.visible,2==P.pmiObject.children[0].version)for(;!E.object.NdsBodyNode&&E.object.parent;)E.object=E.object.parent;else if(P.isDisaModel)for(;!Bn.isDISAPmiPrimaryObject(E.object)&&E.object.parent;)E.object=E.object.parent;E.object.select?null==r||0==r?P.ndsModel.deselectPMIObject(P.pmiObject,!0):P.ndsModel.deselectPMIObject(E.object):(null!=r&&0!=r||P.ndsModel.deselectPMIObject(P.pmiObject,!1),E.object.visible&&P.ndsModel.selectPMIObject(E.object))}else null!=r&&0!=r||P.ndsModel.deselectPMIObject(P.pmiObject)}return P.controls.staticDrawGeomOp&&P.controls.staticDrawGeomOp.needSelectGeom()&&(i=P.renderer.domElement,l=e*(e=P.renderer.getPixelRatio())/i.width*2-1,s=2*-(t*e/i.height)+1,(a=new THREE.Raycaster).linePrecision=1,o=P.clientCoordToModelCoord(c=[0,0]),h=new THREE.Vector3(o[0],o[1],o[2]),u=P.clientCoordToModelCoord(d=[4,0]),p=new THREE.Vector3(u[0],u[1],u[2]),a.linePrecision=.65*h.distanceTo(p),P.camera.setCastRay(a,l,s),E=a.intersectObjects(P.controls.staticDrawGeomOp.drawScene.children,!0)[0],(P.controls.staticDrawGeomOp.isTraceMode()?E&&"Point"!=E.object.objectType:!!E)?(t=P.controls.staticDrawGeomOp.hasMeshSelected(E.object.uuid),null==r||0==r||P.controls.staticDrawGeomOp.isTraceMode()?(P.controls.staticDrawGeomOp.deselectAllMesh(t),t||P.controls.staticDrawGeomOp.selectMesh([E.object.uuid])):t?P.controls.staticDrawGeomOp.deselectMesh([E.object.uuid]):P.controls.staticDrawGeomOp.selectMesh([E.object.uuid])):null!=r&&0!=r||P.controls.staticDrawGeomOp.deselectAllMesh(!0)),n}function N(e,t){return!(e&&!t||!e&&t||!e&&!t||$.viewer.ndsModel&&(e.bodyId!=t.bodyId||e.meshId!=t.meshId||e.lineSegId!=t.lineSegId)||e.parentObj!=t.parentObj||e.id!=t.id)}function i(e){if(e&&$.viewer.hasBrepInfo()){var t,r,i,n,a=$.viewer.ndsModel?e.object:$.findParentElement(e.object);if(a)return $.viewer.ndsModel.setActiveModelByModelId(e.object.ndsModel.id),i=a.type.toLowerCase(),a&&"body"===i&&(i=a.uuid,a=e.object.uuid,$.viewer.ndsModel&&(0<=e.meshId?(e.mesh=$.viewer.ndsModel.meshManager.getSingleMesh(e.meshId),e.mesh&&(t=e.faceIndex-e.mesh.geometry.drawRange.start/3,r="face")):0<=e.lineSegId&&(e.mesh=$.viewer.ndsModel.meshManager.getLineSegments(e.lineSegId),e.mesh)&&(t=.5*(e.index-e.mesh.geometry.drawRange.start),r="edge"),a=e.geomUuid),0<=t)&&(n=$.viewer.ndsModel.activeModel.brepManager.GetBrepInfoByUUidAndTopolIndex(i,a,t,r))&&(n.parentObj=e.mesh,n.intersect=e.point.clone(),n.bodyId=i,n.meshId=a,n.lineSegId=e.lineSegId,n.normal)&&null==n.worldNormal&&(t=new THREE.Vector3,r=new THREE.Quaternion,i=new THREE.Vector3,n.parentObj.matrixWorld.decompose(t,r,i),n.worldNormal=new THREE.Vector3(n.normal[0],n.normal[1],n.normal[2]),n.worldNormal.applyQuaternion(r)),n}}function R(e,t){if(e&&e.parentObj instanceof THREE.Mesh){var r,i=e.parentObj.geometry,n=e.indexRange.concat();if($.viewer.ndsModel&&(n[0]+=i.drawRange.start/3,n[1]+=i.drawRange.start/3),i.isBufferGeometry){for(var a=i.index,o=i.attributes.position,i=n[1]-n[0]+1,s=new Float32Array(9*i),l=0,d=n[0],c=n[1];d<=c;d++,l+=1){var h=3*d,u=a.getX(h),p=a.getX(1+h),h=a.getX(2+h),f=new THREE.Vector3,m=new THREE.Vector3,g=new THREE.Vector3;f.fromBufferAttribute(o,u),m.fromBufferAttribute(o,p),g.fromBufferAttribute(o,h),s[9*l]=f.x,s[9*l+1]=f.y,s[9*l+2]=f.z,s[9*l+3]=m.x,s[9*l+4]=m.y,s[9*l+5]=m.z,s[9*l+6]=g.x,s[9*l+7]=g.y,s[9*l+8]=g.z,g=m=f=null}i=new THREE.BufferGeometry;i.addAttribute("position",new THREE.BufferAttribute(s,3)),(r=new THREE.Mesh(i,0==t?De.selectedFaceMaterial:De.preSelectedFaceMaterial)).objectType="Face",r.applyMatrix(e.parentObj.matrixWorld),r.matrixWorldNeedsUpdate=!0}return r}}function C(e,t){if(e&&e.parentObj instanceof THREE.Line){var r,i=e.parentObj.geometry,n=e.indexRange.concat();if($.viewer.ndsModel&&(n[0]+=i.drawRange.start/2,n[1]+=i.drawRange.start/2),i.isBufferGeometry){var a=n[1]-n[0]+1,o=i.index,s=i.attributes.position.array,l=new Float32Array(6*a);if(null!=o){var d=o.array,c=0,i=n[0],a=n[1];"circle"==e.type&&Math.round(.5*(i+a));for(var h=i,u=a;h<=u;h++,c+=1){var p=d[2*h],f=d[2*h+1],m=new THREE.Vector3,g=new THREE.Vector3;m.fromArray(s,3*p),g.fromArray(s,3*f),l[6*c]=m.x,l[6*c+1]=m.y,l[6*c+2]=m.z,l[6*c+3]=g.x,l[6*c+4]=g.y,l[6*c+5]=g.z,g=m=null}o=new THREE.BufferGeometry;o.addAttribute("position",new THREE.BufferAttribute(l,3)),(r=new THREE.LineSegments(o,0==t?De.selectedEdgeMaterial:De.preSelectedEdgeMaterial)).objectType="Edge",r.applyMatrix(e.parentObj.matrixWorld),r.matrixWorldNeedsUpdate=!0}}return r}}function V(e,t){a=e,r=5,null!=(t=t)&&(r=t),t=$.viewer.camera.getCameraTarget(),i=$.viewer.camera.position,(n=new THREE.Vector3).subVectors(t,i),t=a.position.clone(),a=$.viewer.camera.isPerspective?t.sub(i).dot(n.normalize()):n.length(),t=$.viewer.camera.fov,i=2*a*Math.tan(THREE.Math.degToRad(.5*t)),n=$.viewer.renderer.domElement.height;var r,i,n,a=r*i*$.viewer.renderer.getPixelRatio()/n;e.scale.x=a,e.scale.y=a,e.scale.z=a,e.updateMatrixWorld()}function D(e,t,r){r=new THREE.Mesh(new THREE.SphereGeometry(1),0==r?De.selectedVertexMaterial:De.preSelectedVertexMaterial);return r.position.set(e.x,e.y,e.z),V(r,t),r.objectType="Point",r}function s(e,t,r){t?e.isPreSelected()||($.viewer.ndsModel.preSelectObject(e),$.viewer.render(),$.viewer.dispatchAsyncEvent({type:"PreSelectedEntityChangeEvent",entityId:e.uuid})):null!=r&&1==r||"accumulate"==d?$.isObjectSelected(e)?($.deselectObject(e),$.updateBroadcastInfo(),$.viewer.dispatchAsyncEvent({type:"SelectionChangeEvent",added:[],removed:[{entityType:e.type,bodyId:e.uuid,entityId:""}]})):($.selectObject(e),$.updateBroadcastInfo(),$.viewer.dispatchAsyncEvent({type:"SelectionChangeEvent",added:[{entityType:e.type,bodyId:e.uuid,entityId:""}],removed:[]})):$.isObjectSelected(e)?$.clearSelection():($.clearSelection(),$.selectObject(e),$.updateBroadcastInfo(),$.viewer.dispatchAsyncEvent({type:"SelectionChangeEvent",added:[{entityType:e.type,bodyId:e.uuid,entityId:""}],removed:[]})),$.viewer.groundShadowChange()}function G(e){e=i(e[0]);return e&&null!=e.area?e:null}function H(e,t,r){if(t)T(!1,"face"),l?N(l,e)||(l=e,B.remove(y),y=R(e,!0),B.add(y),$.viewer.render(),$.viewer.dispatchAsyncEvent({type:"PreSelectedEntityChangeEvent",entityId:e.id})):(y=R(l=e,!0),B.add(y),$.viewer.render(),$.viewer.dispatchAsyncEvent({type:"PreSelectedEntityChangeEvent",entityId:e.id}));else{for(var i,n=!1,a=-1,o=0,s=c.length;o<s;o++)if(N(c[o],e)){n=!0,a=o;break}null!=r&&1==r||"accumulate"==d?n?(t=c[a],c.splice(a,1),B.remove(h[a]),h[a]=null,h.splice(a,1),$.updateBroadcastInfo(),$.viewer.dispatchAsyncEvent({type:"SelectionChangeEvent",added:[],removed:[{entityType:"face",bodyId:t.bodyId,entityId:t.id}]})):(c.push(e),(i=R(e,!1))&&(B.add(i),h.push(i)),$.updateBroadcastInfo(),$.viewer.dispatchAsyncEvent({type:"SelectionChangeEvent",added:[{entityType:"face",bodyId:e.bodyId,entityId:e.id}],removed:[]})):(r=$.getAllSelectionInfors(),t=[],I(),!n&&(c.push(e),t.push({entityType:"face",bodyId:e.bodyId,entityId:e.id}),i=R(e,!1))&&(B.add(i),h.push(i)),i=null,$.viewer.annotationsManager&&"face"==$.viewer.annotationsManager.getAnnotationMode()&&(i=$.viewer.annotationsManager.getHotPoint($.viewerClientX,$.viewerClientY)),$.updateBroadcastInfo(),$.viewer.dispatchAsyncEvent({type:"SelectionChangeEvent",added:t,removed:r,annoObj:i,clickPosX:$.viewerClientX,clickPosY:$.viewerClientY}))}}function k(e,t,r,i,n){if($.viewer.hasBrepInfo()){e=_(e,t,!1);if(e&&0<e.length){if("refplane"==e[0].bodyNode.type.toLowerCase())return void s(e[0].bodyNode,r,i);t=G(e);if(t)return n&&"plane"!=t.type?void 0:void H(t,r,i)}r?T(!0):null!=i&&0!=i||$.clearSelection()}}function j(e){var t=null;if($.viewer.ndsModel?0<=e[0].lineSegId&&(t=e[0]):e[0].object instanceof THREE.Line||e[0].object instanceof THREE.LineSegments?t=e[0]:1<e.length&&(e[1].object instanceof THREE.Line||e[1].object instanceof THREE.LineSegments)&&Math.abs(e[1].distance-e[0].distance)<(r=$.viewer.controls.getBoundingBox()).min.distanceTo(r.max)/1e3&&(t=e[1]),t){var r=i(t);if(r)return r}return null}function z(e,t,r){if(t)T(!1,"edge"),A?N(A,e)||(A=e,B.remove(M),M=C(e,!0),B.add(M),$.viewer.render(),$.viewer.dispatchAsyncEvent({type:"PreSelectedEntityChangeEvent",entityId:e.id})):(M=C(A=e,!0),B.add(M),$.viewer.render(),$.viewer.dispatchAsyncEvent({type:"PreSelectedEntityChangeEvent",entityId:e.id}));else{for(var i,n=!1,a=-1,o=0,s=f.length;o<s;o++)if(N(f[o],e)){n=!0,a=o;break}null!=r&&1==r||"accumulate"==d?n?(t=f[a],f.splice(a,1),B.remove(m[a]),m[a]=null,m.splice(a,1),$.updateBroadcastInfo(),$.viewer.dispatchAsyncEvent({type:"SelectionChangeEvent",added:[],removed:[{entityType:"edge",bodyId:t.bodyId,entityId:t.id}]})):(f.push(e),(i=C(e,!1))&&(B.add(i),m.push(i)),$.updateBroadcastInfo(),$.viewer.dispatchAsyncEvent({type:"SelectionChangeEvent",added:[{entityType:"edge",bodyId:e.bodyId,entityId:e.id}],removed:[]})):(r=$.getAllSelectionInfors(),t=[],I(),!n&&(f.push(e),t.push({entityType:"edge",bodyId:e.bodyId,entityId:e.id}),i=C(e,!1))&&(B.add(i),m.push(i)),$.updateBroadcastInfo(),$.viewer.dispatchAsyncEvent({type:"SelectionChangeEvent",added:t,removed:r}))}}function W(e,t,r,i){if($.viewer.hasBrepInfo()){e=_(e,t,!0);if(e&&0<e.length){if("refaxis"==e[0].bodyNode.type.toLowerCase())return void s(e[0].bodyNode,r,i);t=j(e);if(null!=t)return void z(t,r,i)}r?T(!0):null!=i&&0!=i||$.clearSelection()}}function _(e,t,r){var i=$.viewer,n=i.renderer.domElement,a=i.renderer.getPixelRatio(),e=e*a/n.width*2-1,t=2*-(t*a/n.height)+1,a=new THREE.Raycaster,o=(i.camera.setCastRay(a,e,t),r&&(a.linePrecision=1,n=i.clientCoordToModelCoord([0,0]),e=new THREE.Vector3(n[0],n[1],n[2]),t=i.clientCoordToModelCoord([4,0]),n=new THREE.Vector3(t[0],t[1],t[2]),a.linePrecision=e.distanceTo(n)),null);if(i.ndsModel){if((o=r?i.ndsModel.intersect(a.ray,a.linePrecision):i.ndsModel.intersect(a.ray))&&0<o.length)if(te){if(re&&0<re.length)for(var s=!1,l=0;l<o.length;l++){c=o[l].bodyNode;for(var s=!1,d=0;d<re.length;d++)if(re[d]==c||c.isChildOfNode(re[d])){s=!0;break}s&&(o.splice(l,1),l--)}}else if(ie&&ne&&0<ne.length)for(var c,h=!1,l=0;l<o.length;l++){c=o[l].bodyNode;for(h=!1,d=0;d<ne.length;d++)if(ne[d]==c||c.isChildOfNode(ne[d])){h=!0;break}h||(o.splice(l,1),l--)}}else t=$.viewer.getIsolateMeshes(),o=0<t.length?a.intersectObjects(t):r?a.intersectObjects(L):a.intersectObjects(u);return o}function X(e){var e=e[0],t=$.viewer.ndsModel?e.object:$.findParentElement(e.object);if(t&&"body"==t.type.toLowerCase()){var r=t.uuid,i=$.viewer.ndsModel.activeModel.brepManager.GetVerticesByBodyUUID(r);if(i){for(var n,a=(d=t)?(d.boxDiagonalLength||(l=new THREE.Vector3,a=new THREE.Vector3,$.viewer.computeBoundingBox(d,l,a,{flag:!0}),d.boxDiagonalLength=a.distanceTo(l)),.015*d.boxDiagonalLength):.5,o=a*a,s=e.point.clone(),l=null,l=$.viewer.ndsModel?t.worldMatrix:t.matrixWorld,d=new THREE.Matrix4,e=(d.getInverse(l),s.applyMatrix4(d),$.viewer.modelCoordToClientCoord([s.x,s.y,s.z])),c=new THREE.Vector3(e[0],e[1],0),h=new THREE.Vector3,u=new THREE.Vector3,p=64,f=-1,m=0,g=i.length;m<g;m++)u.set(i[m].coords[0],i[m].coords[1],i[m].coords[2]),s.distanceToSquared(u)<o&&(n=$.viewer.modelCoordToClientCoord(i[m].coords),h.set(n[0],n[1],0),(n=c.distanceToSquared(h))<p)&&(f=m,p=n);if(0<=f)return u.set(i[f].coords[0],i[f].coords[1],i[f].coords[2]),u.applyMatrix4(l),{id:i[f].id,coords:[u.x,u.y,u.z],bodyId:r}}}return null}function q(e,t,r){var i=new THREE.Vector3(e.coords[0],e.coords[1],e.coords[2]);if(t)T(!1,"vertex"),w?w.id!=e.id&&(w=e,x.position.set(i.x,i.y,i.z),$.viewer.render(),$.viewer.dispatchAsyncEvent({type:"PreSelectedEntityChangeEvent",entityId:e.id})):(w=e,x=D(i,b,!0),B.add(x),$.viewer.render(),$.viewer.dispatchAsyncEvent({type:"PreSelectedEntityChangeEvent",entityId:e.id}));else{for(var n,a=!1,o=-1,s=0,l=g.length;s<l;s++)if(g[s].id==e.id){a=!0,o=s;break}null!=r&&1==r||"accumulate"==d?a?(t=g[o],g.splice(o,1),B.remove(v[o]),v[o]=null,v.splice(o,1),$.updateBroadcastInfo(),$.viewer.dispatchAsyncEvent({type:"SelectionChangeEvent",added:[],removed:[{entityType:"vertex",bodyId:t.bodyId,entityId:t.id}]})):(g.push(e),(n=D(i,b,!1))&&(B.add(n),v.push(n)),$.updateBroadcastInfo(),$.viewer.dispatchAsyncEvent({type:"SelectionChangeEvent",added:[{entityType:"vertex",bodyId:e.bodyId,entityId:e.id}],removed:[]})):(r=$.getAllSelectionInfors(),t=[],I(),!a&&(g.push(e),t.push({entityType:"vertex",bodyId:e.bodyId,entityId:e.id}),n=D(i,b,!1))&&(B.add(n),v.push(n)),$.updateBroadcastInfo(),$.viewer.dispatchAsyncEvent({type:"SelectionChangeEvent",added:t,removed:r}))}}function Y(e,t,r,i){if($.viewer.hasBrepInfo()){e=_(e,t,!0);if(e&&0<e.length){t=X(e);if(null!=t)return void q(t,r,i)}r?T(!0):null!=i&&0!=i||$.clearSelection()}}function Q(e,t,r,i){if($.viewer.hasBrepInfo()){e=_(e,t,!0);if(e&&0<e.length){t=e[0].bodyNode.type.toLowerCase();if("refpoint"==t||"refaxis"==t||"refplane"==t)return void s(e[0].bodyNode,r,i);t=X(e);if(t)return void q(t,r,i);t=j(e);if(t)return void z(t,r,i);t=G(e);if(t)return void H(t,r,i)}r?T(!0):null!=i&&0!=i||$.clearSelection()}}function K(e,t,r,i){if($.viewer.hasBrepInfo()){e=_(e,t,!0);if(e&&0<e.length){if("refaxis"==e[0].bodyNode.type.toLowerCase())return void s(e[0].bodyNode,r,i);t=j(e);if(t){if("line"==t.type)return void z(t,r,i)}else{t=G(e);if(t&&"cylinder"==t.type)return void H(t,r,i)}}r?T(!0):null!=i&&0!=i||$.clearSelection()}}function Z(e,t,r,i){if($.viewer.hasBrepInfo()){e=_(e,t,!0);if(e&&0<e.length){if("refaxis"==e[0].bodyNode.type.toLowerCase())return void s(e[0].bodyNode,r,i);t=j(e);if(null!=t&&"line"==t.type)return void z(t,r,i)}r?T(!0):null!=i&&0!=i||$.clearSelection()}}function J(e,t,r,i){if($.viewer.hasBrepInfo()){e=_(e,t,!0);if(e&&0<e.length){t=e[0].bodyNode.type.toLowerCase();if("refaxis"==t||"refplane"==t)return void s(e[0].bodyNode,r,i);t=j(e);if(null!=t){if("line"==t.type)return void z(t,r,i)}else{t=G(e);if(t&&"plane"==t.type)return void H(t,r,i)}}r?T(!0):null!=i&&0!=i||$.clearSelection()}}function ae(e){return null==e?null:e instanceof THREE.Object3D&&"Link"===e.type?e:ae(e.parent)}this.setTempSelectedObjects=function(e){r=e.concat()},this.getTempSelectedObjects=function(){return r},this.setSelectType=function(e){E=e},this.getSelectType=function(){return E},this.setSelectPolicy=function(e){d=e},this.getSelectPolicy=function(){return d},this.enableExclusivePicking=function(e,t){if(e)if(ie=!(te=!0),ne=null,t&&0<t.length){var r;re=[];for(var i=0;i<t.length;i++)(r=$.viewer.ndsModel.getBodyNodeFromUuid(t[i]))&&re.push(r)}else re=null;else te=!1,re=null},this.enableInclusivePicking=function(e,t){if(e)if(te=!(ie=!0),re=null,t&&0<t.length){var r;ne=[];for(var i=0;i<t.length;i++)(r=$.viewer.ndsModel.getBodyNodeFromUuid(t[i]))&&ne.push(r)}else ne=null;else ie=!1,ne=null},this.clearSelection=function(e){var t,r,i;void 0===e&&(e=!0),(0!=o.length||0!=ee.length||0!=p.length||0!=c.length||0!=f||0!=g.length||$.viewer.ndsModel&&0!=$.viewer.ndsModel.selectedBodies.length)&&(t=0<ee.length,r=$.getAllSelectionInfors(),I(),e&&($.viewer.dispatchAsyncEvent({type:"clearSelection"}),$.viewer.dispatchAsyncEvent({type:"selectObjectEvent"}),$.updateBroadcastInfo(),$.viewer.dispatchAsyncEvent({type:"SelectionChangeEvent",added:[],removed:r})),$.viewer.startMove(),$.viewer.drawTraceUpdate(),r="BodyVolume"!==(e=$.viewer.getCurrentMeasureType())&&"BodyArea"!==e,De.enableBodyVolumeMeasure&&$.viewer.hasBrepInfo()&&t&&r&&((i=$.getSelectedBodyVolumeAndArea())?$.viewer.dispatchAsyncEvent({type:"BodySelectionChangeEvent",volumeAreaInfo:i[0],modelUnit:i[1]}):$.viewer.dispatchAsyncEvent({type:"BodySelectionChangeEvent",volumeAreaInfo:null,modelUnit:null})),De.enableBodyVolumeMeasure&&$.viewer.hasBrepInfo()&&!r&&((i=$.getSelectedBodyVolumeAndArea())?$.viewer.dispatchAsyncEvent({type:"BodyMeasureChangeEvent",volumeAreaInfo:i[0],measureType:e,modelUnit:i[1]}):$.viewer.dispatchAsyncEvent({type:"BodyMeasureChangeEvent",volumeAreaInfo:null,measureType:e,modelUnit:null})),$.updateBroadcastInfo(),$.viewer.groundShadowChange())},this.clearPreSelection=function(e){T(e)},this.clearSelectedBrepEntities=function(){var e;0==c.length&&0==f&&0==g.length||(e=$.getAllSelectedBrepEntities(),B.children.length=0,c.length=0,h.length=0,f.length=0,m.length=0,g.length=0,v.length=0,$.viewer.dispatchAsyncEvent({type:"clearSelectedBrepEntities"}),$.updateBroadcastInfo(),$.viewer.dispatchAsyncEvent({type:"SelectionChangeEvent",added:[],removed:e}))},this.changeSelectedObjectMaterial=function(e,t){var r,i=e.children;if((null==i||i.length<=0||e instanceof THREE.SkinnedMesh)&&!function(e){for(var t=0,r=o.length;t<r;++t)if(e==o[t].key)return 1;return}(e)&&null!=e.material)(r=e.material.clone()).oldMat=e.material,o.push(new Pe.map(e,r)),e instanceof THREE.SkinnedMesh?t.skinning=!0:t.skinning=!1,e.material=t;else for(var n=0;n<i.length;++n)$.changeSelectedObjectMaterial(i[n],t)},this.overrideMeshSelectionMaterialIn3DViewer=function(){$.viewer.isNdsModelInWireframeMode($.viewer.getRenderMode())?De.selectedMaterial=e:De.selectedMaterial=t,De.inBIMContext?$.viewer.ndsModel.meshManager.setSelectedMaterial(De.selectedMaterial,De.selectedLineMaterial):$.viewer.ndsModel.models.forEach(function(e){e.meshManager.setSelectedMaterial($.viewer.is2DModel?De.selectedFace2DMaterial:De.selectedMaterial,De.selectedLineMaterial)})},this.overrideLineSelectionMaterialIn3DViewer=function(e){e&&$.shouldApplySelectedMaterial&&$.viewer.isIn3DViewer()&&!$.viewer.isNdsModelInWireframeMode($.viewer.getRenderMode())&&(e.transparent=!0,e.opacity=.4,e.depthTest=!1)},this.shouldDrawSelectedMeshesIn3DViewer=function(){return!!($.viewer.isIn3DViewer()&&($.viewer.isNdsModelInWireframeMode($.viewer.getRenderMode())||$.viewer.selectionOutlinePass&&$.viewer.selectionOutlinePass.renderSelectedMeshes))},this.selectObjectByList=function(e,t,r){for(var i=null,n=0;n<e.length;++n){var a=this.viewer.ndsModel.getModelById(r[n]),o=((a=a||this.viewer.ndsModel.getActiveModel()).objectidTouuid||a.meshManager.bodyUuids)[e[n]],s=a.getBodyNodeFromUuid(o);if(s||(o=a.meshManager.lineSegBodyUuids[e[n]],s=a.getBodyNodeFromUuid(o)),s&&!$.isObjectSelected(s))for($.selectObject(s,!1,!(!0===t)),i=s;s.parent&&$.viewer.ndsModel.isBodyAllChildSelected(s.parent);)$.selectObject(s.parent,!1,!(!0===t)),i=s=s.parent}!0===t&&i&&$.selectObject(s),$.viewer.render()},this.selectObjectList=function(e,t){$.selectfromtree=t||!1;for(var r=null,i=0;i<e.length;i++){var n,r=e[i];$.viewer.ndsModel.setActiveModel(r.ndsModel.id),$.viewer.ndsModel&&(r=$.viewer.ndsModel.getBodyNodeFromUuid(r.uuid,r.ndsModel.id)),$.viewer.outlinePass&&$.viewer.outlinePass.enabled?$.viewer.outlinePass.selectedObjects=ee:(De.selectedMaterial.colorWrite=!0,$.viewer.ndsModel?"refpoint"==(n=r.type.toLowerCase())||"refaxis"==n||"refplane"==n?r.select():(De.inBIMContext?$.viewer.ndsModel.meshManager.setSelectedMaterial(De.selectedMaterial,De.selectedLineMaterial):$.viewer.ndsModel.models.forEach(function(e){e.meshManager.setSelectedMaterial($.viewer.is2DModel?De.selectedFace2DMaterial:De.selectedMaterial,De.selectedLineMaterial)}),$.viewer.ndsModel.addSelection(r)):$.changeSelectedObjectMaterial(r,De.selectedMaterial)),$.isObjectSelected(r)||ee.push(r)}$.viewer.selectionOutlinePass&&($.viewer.selectionOutlinePass.selectedObjects=ee),$.viewer.dispatchAsyncEvent({type:"selectObject",object:r,selectfromtree:$.selectfromtree}),$.viewer.dispatchAsyncEvent({type:"selectObjectEvent"});var a,o,t=$.viewer.getCurrentMeasureType(),s="BodyVolume"!==t&&"BodyArea"!==t?!0:!1;De.enableBodyVolumeMeasure&&(!$.viewer.hasBrepInfo()||$.viewer.productData)&&s&&((a=$.viewer.getSelectedObjectProperty(function(){}))&&1e-7<a.area?$.viewer.dispatchAsyncEvent({type:"BodySelectionChangeEvent",volumeAreaInfo:a,modelUnit:a.unit}):0<ee.length?$.viewer.dispatchAsyncEvent({type:"BodySelectionChangeEvent",volumeAreaInfo:null,modelUnit:$.viewer.modelUnit}):$.viewer.dispatchAsyncEvent({type:"BodySelectionChangeEvent",volumeAreaInfo:null,modelUnit:null})),De.enableBodyVolumeMeasure&&$.viewer.hasBrepInfo()&&!$.viewer.productData&&s&&((o=$.getSelectedBodyVolumeAndArea())?$.viewer.dispatchAsyncEvent({type:"BodySelectionChangeEvent",volumeAreaInfo:o[0],modelUnit:o[1]}):0<ee.length?$.viewer.dispatchAsyncEvent({type:"BodySelectionChangeEvent",volumeAreaInfo:null,modelUnit:$.viewer.modelUnit}):$.viewer.dispatchAsyncEvent({type:"BodySelectionChangeEvent",volumeAreaInfo:null,modelUnit:null})),De.enableBodyVolumeMeasure&&$.viewer.hasBrepInfo()&&!s&&((o=$.getSelectedBodyVolumeAndArea())?$.viewer.dispatchAsyncEvent({type:"BodyMeasureChangeEvent",volumeAreaInfo:o[0],measureType:t,modelUnit:o[1]}):$.viewer.dispatchAsyncEvent({type:"BodyMeasureChangeEvent",volumeAreaInfo:null,measureType:t,modelUnit:null})),$.viewer.groundShadowChange(),$.updateBroadcastInfo()},this.selectObject=function(e,t,r){if("parentNode"===e.type){for(var i=[],n=0;n<$.viewer.ndsModel.models.length;n++){var a=$.viewer.ndsModel.models[n];i.push(a.rootBodyNode)}this.selectObjectList(i,t)}else{$.selectfromtree=t||!1;var o=e;if(!e.isOtherNode()&&(o=$.viewer.ndsModel?$.viewer.ndsModel.getBodyNodeFromUuid(e.uuid,e.ndsModel.id):o)){var s=ee;o.ndsModel.isSketchModel&&(s=p);for(var l=0;l<$.viewer.ndsModel.models.length;l++)o.ndsModel.id===$.viewer.ndsModel.models[l].id&&$.viewer.ndsModel.setActiveModel(l);$.viewer.outlinePass&&$.viewer.outlinePass.enabled||(De.selectedMaterial.colorWrite=!0,$.viewer.ndsModel?"refpoint"==(t=o.type.toLowerCase())||"refaxis"==t||"refplane"==t?o.select():(De.inBIMContext?$.viewer.ndsModel.meshManager.setSelectedMaterial(De.selectedMaterial,De.selectedLineMaterial):$.viewer.ndsModel.models.forEach(function(e){if(e.isSketchModel)return!0;e.meshManager.setSelectedMaterial($.viewer.is2DModel?De.selectedFace2DMaterial:De.selectedMaterial,De.selectedLineMaterial)}),$.viewer.ndsModel.addSelection(o)):$.changeSelectedObjectMaterial(o,De.selectedMaterial));for(var d=!1,c=0;c<s.length;++c)if(o.uuid==s[c].uuid&&o.ndsModel.id==s[c].ndsModel.id){d=!0;break}if(!d){for(c=0;c<s.length;++c)S(s[c],o)&&(s.splice(c,1),c--);s.push(o)}"OpExplode"==$.viewer.controls.getOperator().type&&$.viewer.controls.getOperator().changeSelobject(),$.viewer.dispatchAsyncEvent({type:"selectObject",object:o,selectfromtree:$.selectfromtree}),$.viewer.dispatchEvent({type:"selectedObjectBody",object:o,selectfromtree:$.selectfromtree});var h,e=$.viewer.getCurrentMeasureType(),t="BodyVolume"!==e&&"BodyArea"!==e?!0:!1;!1!==r&&(De.enableBodyVolumeMeasure&&(!$.viewer.hasBrepInfo()||$.viewer.productData||De.AnimationEdit)&&t&&((r=$.viewer.getSelectedObjectProperty(function(){}))&&1e-7<r.area?$.viewer.dispatchAsyncEvent({type:"BodySelectionChangeEvent",volumeAreaInfo:r,modelUnit:r.unit}):0<s.length?$.viewer.dispatchAsyncEvent({type:"BodySelectionChangeEvent",volumeAreaInfo:null,modelUnit:$.viewer.modelUnit}):$.viewer.dispatchAsyncEvent({type:"BodySelectionChangeEvent",volumeAreaInfo:null,modelUnit:null})),De.enableBodyVolumeMeasure&&$.viewer.hasBrepInfo()&&!De.AnimationEdit&&!$.viewer.productData&&t&&((h=$.getSelectedBodyVolumeAndArea())?$.viewer.dispatchAsyncEvent({type:"BodySelectionChangeEvent",volumeAreaInfo:h[0],modelUnit:h[1]}):0<s.length?$.viewer.dispatchAsyncEvent({type:"BodySelectionChangeEvent",volumeAreaInfo:null,modelUnit:$.viewer.modelUnit}):$.viewer.dispatchAsyncEvent({type:"BodySelectionChangeEvent",volumeAreaInfo:null,modelUnit:null})),De.enableBodyVolumeMeasure)&&$.viewer.hasBrepInfo()&&!De.AnimationEdit&&!t&&((h=$.getSelectedBodyVolumeAndArea())?$.viewer.dispatchAsyncEvent({type:"BodyMeasureChangeEvent",volumeAreaInfo:h[0],measureType:e,modelUnit:h[1]}):$.viewer.dispatchAsyncEvent({type:"BodyMeasureChangeEvent",volumeAreaInfo:null,measureType:e,modelUnit:null})),$.viewer.outlinePass&&$.viewer.outlinePass.enabled&&($.viewer.outlinePass.selectedObjects=ee.concat(p)),$.viewer.selectionOutlinePass&&($.viewer.selectionOutlinePass.selectedObjects=ee.concat(p)),$.updateBroadcastInfo(),$.viewer.groundShadowChange(),$.viewer.startMove(),$.viewer.drawTraceUpdate()}}},this.isObjectSelected=function(e){if(e.parent&&this.isObjectSelected(e.parent))return!0;for(var t=0,r=ee.length;t<r;++t)if(e.uuid==ee[t].uuid&&e.ndsModel.id===ee[t].ndsModel.id)return!0;for(t=0,r=p.length;t<r;++t)if(e.uuid==p[t].uuid&&e.ndsModel.id===p[t].ndsModel.id)return!0;return!1},this.deselectObject=function(e,t){var r=e;if(r=$.viewer.ndsModel?$.viewer.ndsModel.getBodyNodeFromUuid(e.uuid,e.ndsModel.id):r){var i=ee;r.ndsModel.isSketchModel&&(i=p),$.viewer.ndsModel?"refpoint"==(e=r.type.toLowerCase())||"refaxis"==e||"refplane"==e?r.deSelect():$.viewer.ndsModel.removeSelection(r):$.restoreSelectedObjectMaterial(r);for(var n=0;n<i.length;++n)S(i[n],r)&&(i.splice(n,1),n--);for(var a=[],n=0;n<i.length;++n)if(S(r,i[n])){var o=null;$.viewer.ndsModel?o=$.viewer.ndsModel.getSelectedLeafBodyNodes(i[n]):O(i[n],o=[]);for(var s=0,l=o.length;s<l;++s)a.push(o[s]);i.splice(n,1),n--}for(var d=i.length,n=0,l=a.length;n<l;++n){for(var c=!1,s=0;s<d;s++)if(a[n].uuid==i[s].uuid){c=!0;break}c||i.push(a[n])}"OpExplode"==$.viewer.controls.getOperator().type&&$.viewer.controls.getOperator().changeSelobject();var h,e=$.viewer.getCurrentMeasureType(),u="BodyVolume"!==e&&"BodyArea"!==e?!0:!1;!1!==t&&(De.enableBodyVolumeMeasure&&(!$.viewer.hasBrepInfo()||$.viewer.productData)&&u&&((t=$.viewer.getSelectedObjectProperty(function(){}))&&1e-7<t.area?$.viewer.dispatchAsyncEvent({type:"BodySelectionChangeEvent",volumeAreaInfo:t,modelUnit:t.unit}):$.viewer.dispatchAsyncEvent({type:"BodySelectionChangeEvent",volumeAreaInfo:null,modelUnit:$.viewer.modelUnit})),De.enableBodyVolumeMeasure&&$.viewer.hasBrepInfo()&&!$.viewer.productData&&u&&((h=$.getSelectedBodyVolumeAndArea())?$.viewer.dispatchAsyncEvent({type:"BodySelectionChangeEvent",volumeAreaInfo:h[0],modelUnit:h[1]}):$.viewer.dispatchAsyncEvent({type:"BodySelectionChangeEvent",volumeAreaInfo:null,modelUnit:$.viewer.modelUnit})),De.enableBodyVolumeMeasure)&&$.viewer.hasBrepInfo()&&!u&&((h=$.getSelectedBodyVolumeAndArea())?$.viewer.dispatchAsyncEvent({type:"BodyMeasureChangeEvent",volumeAreaInfo:h[0],measureType:e,modelUnit:h[1]}):$.viewer.dispatchAsyncEvent({type:"BodyMeasureChangeEvent",volumeAreaInfo:null,measureType:e,modelUnit:null})),$.updateBroadcastInfo(),$.viewer.outlinePass&&$.viewer.outlinePass.enabled&&($.viewer.outlinePass.selectedObjects=ee.concat(p)),$.viewer.selectionOutlinePass&&($.viewer.selectionOutlinePass.selectedObjects=ee.concat(p)),$.viewer.groundShadowChange(),$.viewer.drawTraceUpdate()}},this.deselectObjectList=function(e,t){void 0===t&&(t=!1);for(var r=0;r<e.length;r++){var i,n=e[r];if(!(n=$.viewer.ndsModel?$.viewer.ndsModel.getBodyNodeFromUuid(n.uuid):n))return;$.viewer.ndsModel?"refpoint"==(i=n.type.toLowerCase())||"refaxis"==i||"refplane"==i?n.deSelect():$.viewer.ndsModel.removeSelection(n):$.restoreSelectedObjectMaterial(n);for(var a=0;a<ee.length;++a)S(ee[a],n)&&(ee.splice(a,1),a--);for(var o=[],a=0;a<ee.length;++a)if(S(n,ee[a])){var s=null;$.viewer.ndsModel?s=$.viewer.ndsModel.getSelectedLeafBodyNodes(ee[a]):O(ee[a],s=[]);for(var l=0,d=s.length;l<d;++l)o.push(s[l]);ee.splice(a,1),a--}}for(var c=ee.length,a=0,d=o.length;a<d;++a){for(var h=!1,l=0;l<c;l++)if(o[a].uuid==ee[l].uuid){h=!0;break}h||ee.push(o[a])}"OpExplode"==$.viewer.controls.getOperator().type&&$.viewer.controls.getOperator().changeSelobject();var u,p=$.viewer.getCurrentMeasureType(),f="BodyVolume"!==p&&"BodyArea"!==p?!0:!1;!1!==t&&(De.enableBodyVolumeMeasure&&(!$.viewer.hasBrepInfo()||$.viewer.productData)&&f&&((t=$.viewer.getSelectedObjectProperty(function(){}))&&1e-7<t.area?$.viewer.dispatchAsyncEvent({type:"BodySelectionChangeEvent",volumeAreaInfo:t,modelUnit:t.unit}):$.viewer.dispatchAsyncEvent({type:"BodySelectionChangeEvent",volumeAreaInfo:null,modelUnit:$.viewer.modelUnit})),De.enableBodyVolumeMeasure&&$.viewer.hasBrepInfo()&&!$.viewer.productData&&f&&((u=$.getSelectedBodyVolumeAndArea())?$.viewer.dispatchAsyncEvent({type:"BodySelectionChangeEvent",volumeAreaInfo:u[0],modelUnit:u[1]}):$.viewer.dispatchAsyncEvent({type:"BodySelectionChangeEvent",volumeAreaInfo:null,modelUnit:$.viewer.modelUnit})),De.enableBodyVolumeMeasure)&&$.viewer.hasBrepInfo()&&!f&&((u=$.getSelectedBodyVolumeAndArea())?$.viewer.dispatchAsyncEvent({type:"BodyMeasureChangeEvent",volumeAreaInfo:u[0],measureType:p,modelUnit:u[1]}):$.viewer.dispatchAsyncEvent({type:"BodyMeasureChangeEvent",volumeAreaInfo:null,measureType:p,modelUnit:null})),$.viewer.groundShadowChange(),$.viewer.drawTraceUpdate()},this.restoreSelectedObjectMaterial=function(e){var t=e.children;if(null==t||t.length<1||e instanceof THREE.SkinnedMesh)for(var r,i=0;i<o.length;i++)if(e.uuid==o[i].key.uuid)return r=o[i].value,e.material=r,void 0!==e.material.colorWrite&&(4==(r=$.viewer.getRenderMode())||5==r||8==r?e.material.colorWrite=!0:6!=r&&7!=r||(e instanceof THREE.Line||e instanceof THREE.LineSegments?e.material.colorWrite=!0:e.material.colorWrite=!1)),void o.splice(i,1);for(i=0;i<t.length;++i)$.restoreSelectedObjectMaterial(t[i])},this.getSelectedMeshes=function(){return o},this.getSelectedSketchObjects=function(){return p},this.getSelectedObjects=function(){return ee},this.getSelectedNewObjects=function(){var r,i;return 0===Object.keys($.viewer.ndsModel.activeModel.bodyUuid2ClonedNodeMap).length?ee:(r=[],i=[],ee.forEach(function(e){var t;$.viewer.ndsModel.setActiveModelByModelId(e.ndsModel.id),De.HideLeafBody?"Body"===(t=$.viewer.ndsModel.bodyUuid2ClonedNodeMap[e.uuid]||$.viewer.ndsModel.bodyUuid2NodeMap[e.uuid]).type?t.parent&&-1===i.indexOf(t.parent.uuid)&&(r.push($.viewer.ndsModel.bodyUuid2ClonedNodeMap[t.parent.uuid]),i.push(t.parent.uuid)):-1===i.indexOf(t.uuid)&&(r.push($.viewer.ndsModel.bodyUuid2ClonedNodeMap[t.uuid]),i.push(t.uuid)):r.push($.viewer.ndsModel.bodyUuid2ClonedNodeMap[e.uuid])}),r)},this.getSelectedleafObjects=function(e){for(var t=[],r=0;r<ee.length;r++)var i=ee[r],i=this.viewer.ndsModel.getLeafBodies(i),t=t.concat(i);return t=e&&this.viewer.controls.staticDrawGeomOp&&0<(e=this.viewer.controls.staticDrawGeomOp.getAllSelectObject()).length?t.concat(e):t},this.hasTransformableObjectSelected=function(){for(var e=0,t=ee.length;e<t;e++){var r=ee[e].type.toLowerCase();if("assembly"==r||"component"==r||"part"==r)return!0}return!1},this.getSelectedFaceInfors=function(){for(var e=[],t=0,r=c.length;t<r;t++)e.push({bodyId:c[t].bodyId,faceId:c[t].id});return e},this.getSelectedEdgeInfors=function(){for(var e=[],t=0,r=f.length;t<r;t++)e.push({bodyId:f[t].bodyId,edgeId:f[t].id});return e},this.getSelectedVertexInfors=function(){for(var e=[],t=0,r=g.length;t<r;t++)e.push({bodyId:g[t].bodyId,vertexId:g[t].id});return e},this.getAllSelectionInfors=function(){for(var e=[],t=0,r=c.length;t<r;t++)(i={entityType:"face"}).bodyId=c[t].bodyId,i.entityId=c[t].id,e.push(i);for(t=0,r=f.length;t<r;t++)(i={entityType:"edge"}).bodyId=f[t].bodyId,i.entityId=f[t].id,e.push(i);for(t=0,r=g.length;t<r;t++)(i={entityType:"vertex"}).bodyId=g[t].bodyId,i.entityId=g[t].id,e.push(i);for(t=0,r=ee.length;t<r;t++){var i,n=ee[t].type.toLowerCase();"body"!=n&&"rawmesh"!=n&&"refpoint"!=n&&"refaxis"!=n&&"refplane"!=n||((i={}).entityType=ee[t].type,i.bodyId=ee[t].uuid,i.entityId="",e.push(i))}return e},this.getAllSelectedBrepEntities=function(){for(var e=[],t=0,r=c.length;t<r;t++)(i={entityType:"face"}).bodyId=c[t].bodyId,i.entityId=c[t].id,e.push(i);for(t=0,r=f.length;t<r;t++)(i={entityType:"edge"}).bodyId=f[t].bodyId,i.entityId=f[t].id,e.push(i);for(var i,t=0,r=g.length;t<r;t++)(i={entityType:"vertex"}).bodyId=g[t].bodyId,i.entityId=g[t].id,e.push(i);return e},this.selectBrepEntities=function(e,t){if($.viewer.hasBrepInfo()){t&&I();for(var r=0,i=e.length;r<i;r++)if("face"==e[r].entityType){for(var n=!1,a=0;a<c.length;a++)if(e[r].bodyId==c[a].bodyId&&e[r].entityId==c[a].id){n=!0;break}n||(o=$.viewer.ndsModel.activeModel.brepManager.GetBrepInfoByBodyUuidAndTopoId(e[r].bodyId,e[r].entityId,e[r].entityType))&&(c.push(o),o=R(o,!1))&&(B.add(o),h.push(o))}else if("edge"==e[r].entityType){for(var o,n=!1,a=0;a<f.length;a++)if(e[r].bodyId==f[a].bodyId&&e[r].entityId==f[a].id){n=!0;break}n||(o=$.viewer.ndsModel.activeModel.brepManager.GetBrepInfoByBodyUuidAndTopoId(e[r].bodyId,e[r].entityId,e[r].entityType))&&(f.push(o),s=C(o,!1))&&(B.add(s),m.push(s))}else if("vertex"==e[r].entityType){for(var s,l,n=!1,a=0;a<g.length;a++)if(e[r].bodyId==g[a].bodyId&&e[r].entityId==g[a].id){n=!0;break}n||(s=$.viewer.ndsModel.activeModel.brepManager.GetBrepInfoByBodyUuidAndTopoId(e[r].bodyId,e[r].entityId,e[r].entityType))&&(g.push(s),l=D(new THREE.Vector3(s.coords[0],s.coords[1],s.coords[2]),b,!1))&&(B.add(l),v.push(l))}}},this.deselectBrepEntities=function(e){for(var t=0,r=e.length;t<r;t++)if("face"==e[t].entityType){for(var i=0;i<c.length;i++)if(e[t].bodyId==c[i].bodyId&&e[t].entityId==c[i].id){c.splice(i,1),B.remove(h[i]),h[i]=null,h.splice(i,1);break}}else if("edge"==e[t].entityType){for(i=0;i<f.length;i++)if(e[t].bodyId==f[i].bodyId&&e[t].entityId==f[i].id){f.splice(i,1),B.remove(m[i]),m[i]=null,m.splice(i,1);break}}else if("vertex"==e[t].entityType)for(i=0;i<g.length;i++)if(e[t].bodyId==g[i].bodyId&&e[t].entityId==g[i].id){g.splice(i,1),B.remove(v[i]),v[i]=null,v.splice(i,1);break}},this.selectEntities=function(e,t){if($.viewer.hasBrepInfo()){t&&I();for(var r=0,i=e.length;r<i;r++){var n=e[r].entityType.toLowerCase();if("face"==n){for(var a=!1,o=0;o<c.length;o++)if(e[r].bodyId==c[o].bodyId&&e[r].entityId==c[o].id){a=!0;break}a||(s=$.viewer.ndsModel.activeModel.brepManager.GetBrepInfoByBodyUuidAndTopoId(e[r].bodyId,e[r].entityId,e[r].entityType))&&(c.push(s),s=R(s,!1))&&(B.add(s),h.push(s))}else if("edge"==n){for(var s,a=!1,o=0;o<f.length;o++)if(e[r].bodyId==f[o].bodyId&&e[r].entityId==f[o].id){a=!0;break}a||(s=$.viewer.ndsModel.activeModel.brepManager.GetBrepInfoByBodyUuidAndTopoId(e[r].bodyId,e[r].entityId,e[r].entityType))&&(f.push(s),l=C(s,!1))&&(B.add(l),m.push(l))}else if("vertex"==n){for(var l,d,a=!1,o=0;o<g.length;o++)if(e[r].bodyId==g[o].bodyId&&e[r].entityId==g[o].id){a=!0;break}a||(l=$.viewer.ndsModel.activeModel.brepManager.GetBrepInfoByBodyUuidAndTopoId(e[r].bodyId,e[r].entityId,e[r].entityType))&&(g.push(l),d=D(new THREE.Vector3(l.coords[0],l.coords[1],l.coords[2]),b,!1))&&(B.add(d),v.push(d))}else"refplane"!=n&&"refaxis"!=n||$.viewer.ndsModel&&(d=$.viewer.ndsModel.getBodyNodeFromUuid(e[r].bodyId),$.isObjectSelected(d)||(d.select(),ee.push(d)))}}},this.deselectEntities=function(e){for(var t=0,r=e.length;t<r;t++){var i=e[t].entityType.toLowerCase();if("face"==i){for(var n=0;n<c.length;n++)if(e[t].bodyId==c[n].bodyId&&e[t].entityId==c[n].id){c.splice(n,1),B.remove(h[n]),h[n]=null,h.splice(n,1);break}}else if("edge"==i){for(n=0;n<f.length;n++)if(e[t].bodyId==f[n].bodyId&&e[t].entityId==f[n].id){f.splice(n,1),B.remove(m[n]),m[n]=null,m.splice(n,1);break}}else if("vertex"==i){for(n=0;n<g.length;n++)if(e[t].bodyId==g[n].bodyId&&e[t].entityId==g[n].id){g.splice(n,1),B.remove(v[n]),v[n]=null,v.splice(n,1);break}}else if(("refplane"==i||"refaxis"==i)&&$.viewer.ndsModel){var a=$.viewer.ndsModel.getBodyNodeFromUuid(e[t].bodyId);a.deSelect();for(n=0;n<ee.length;n++)if(ee[n].uuid==a.uuid){ee.splice(n,1);break}}}},this.computeTargetList=function(e){u.length=0,a.length=0,L.length=0,F(e,u)},this.addToTargetList=function(e){F(e,u)},this.getTargetList=function(){return u},this.getTargetLineList=function(){return a},this.getTargetIncludeLineList=function(){return L},this.getLineObjectFromUUid=function(e){for(var t=0,r=a.length;t<r;t++){var i=a[t];if(i&&i.uuid==e)return i}return null},this.getSelectedComponent=function(){if(0<ee.length){var e=ee[0];if(this.viewer.ndsModel){for(var t=e.parent,r=t?t.parent:null,i=e;null!=t&&null!=r&&("model"!=r.type||"assembly"!=t.type);)r=(t=(i=t).parent)?t.parent:null;return i}}return null},this.findParentElement=function(e){if(null==e)return null;if(e instanceof THREE.Object3D){var t=e.type.toLowerCase();if($.viewer.isObjectTypeOfElement(e)){if("object"==t)for(var r=e.parent;null!=r;)"instanceobject"==r.type.toLowerCase()&&(e=r),r=r.parent;return De.selectObjectWithPropertyOnly&&!e.propertyfile?this.findParentElement(e.parent):e}}return this.findParentElement(e.parent)},this.getPickIntersects=function(e,t){var r=$.viewer,i=r.renderer.domElement,n=r.renderer.getPixelRatio(),e=e*n/i.width*2-1,t=2*-(t*n/i.height)+1,n=new THREE.Raycaster;r.camera.setCastRay(n,e,t);return r.ndsModel?r.ndsModel.intersect(n.ray):n.intersectObjects(u)},this.getRealSelectBody=function(e,t,r,i,n){this.viewer.ndsModel.setActiveModel(0);for(var a=[],t=t/window.innerWidth*2-1,r=1-r/window.innerHeight*2,i=i/window.innerWidth*2-1,n=1-n/window.innerHeight*2,o=[],s=0,l=e.length;s<l;s++)e[s].bodyNode.leafBodyAttri&&(0==e[s].state?De.HideLeafBody?a.push(e[s].bodyNode.parent):a.push(e[s].bodyNode):o.push(e[s].bodyNode));var d=!0;return this.lasso||(this.lasso=new Le(this.viewer),d=!1),this.lasso.selectionPoints=[],this.lasso.selectionPoints[0]=t,this.lasso.selectionPoints[1]=r,this.lasso.selectionPoints[2]=0,this.lasso.selectionPoints[3]=t,this.lasso.selectionPoints[4]=n,this.lasso.selectionPoints[5]=0,this.lasso.selectionPoints[6]=i,this.lasso.selectionPoints[7]=n,this.lasso.selectionPoints[8]=0,this.lasso.selectionPoints[9]=i,this.lasso.selectionPoints[10]=r,this.lasso.selectionPoints[11]=0,this.lasso.selectIntersectBody(o,a),d||(this.lasso.release(),this.lasso=null),a},this.selectBodyByRect=function(s,l,d,c,O){for(var e=$.viewer,t=(e.selectionManager.clearSelection(),e.renderer.domElement),r=e.renderer.getPixelRatio(),i=(d<s&&(s=(i=[d,s])[0],d=i[1]),c<l&&(l=(i=[c,l])[0],c=i[1]),s*r/t.width*2-1),n=d*r/t.width*2-1,a=2*-(l*r/t.height)+1,r=2*-(c*r/t.height)+1,t=new THREE.Vector2(i,a),a=new THREE.Vector2(n,a),n=new THREE.Vector2(n,r),i=new THREE.Vector2(i,r),r=[],o=(this.viewer.camera.setCastPolytopes(r,t,a,n,i),new THREE.Polytope(r)),h=(this.viewer.ndsModel.setActiveModel(0),[]),u=[],p=0;p<this.viewer.ndsModel.models.length;p++){var F=this.viewer.ndsModel.models[p];F.isSketchModel||(u=F.wholeLeafBodyNodes.concat(u))}for(var f=0,U=u.length;f<U;++f){var m=u[f];if(!(!m.leafBodyAttri||m.leafBodyAttri.bodyMeshIds.length<1||m.isHidden())){for(var g=new THREE.Box3,N=null,V=m.ndsModel,v=0,G=m.leafBodyAttri.bodyMeshIds.length;v<G;++v){var k=m.leafBodyAttri.bodyMeshIds[v];V.meshManager.getMeshBBox(k,g),0==v?N=g.clone():N.union(g)}var j=o.intersectsBoxDetailed(N),y={};2==j?(y.bodyNode=m,y.bodyUuid=m.uuid,y.state=2,h.push(y)):1!=j&&0==j&&(y.bodyNode=m,y.bodyUuid=m.uuid,y.state=0,h.push(y))}}if(h&&0<h.length)if(te){if(re&&0<re.length)for(var z=!1,A=0;A<h.length;A++){M=h[A].bodyNode;for(z=!1,v=0;v<re.length;v++)if(re[v]==M||M.isChildOfNode(re[v])){z=!0;break}z&&(h.splice(A,1),A--)}}else if(ie&&ne&&0<ne.length)for(var M,W=!1,A=0;A<h.length;A++){M=h[A].bodyNode;for(W=!1,v=0;v<ne.length;v++)if(ne[v]==M||M.isChildOfNode(ne[v])){W=!0;break}W||(h.splice(A,1),A--)}var E=this.getRealSelectBody(h,s,l,d,c);if(E&&0<E.length){if($.viewer.outlinePass&&$.viewer.outlinePass.enabled)for(var X=0;X<E.length;X++)null!=(w=E[X])&&($.viewer.ndsModel.addSelection(w),ee.push(w));else{De.selectedMaterial.colorWrite=!0,De.inBIMContext?$.viewer.ndsModel.meshManager.setSelectedMaterial(De.selectedMaterial,De.selectedLineMaterial):$.viewer.ndsModel.models.forEach(function(e){e.meshManager.setSelectedMaterial($.viewer.is2DModel?De.selectedFace2DMaterial:De.selectedMaterial,De.selectedLineMaterial)});for(var w,q=0;q<E.length;q++)null!=(w=E[q])&&($.viewer.ndsModel.addSelection(w),ee.push(w))}this.selectObjectList([]),$.viewer.selectionOutlinePass&&0<ee.length&&($.viewer.selectionOutlinePass.selectedObjects=ee),$.viewer.dispatchAsyncEvent({type:"selectObjectEvent"})}if("OpExplode"==$.viewer.controls.getOperator().type&&$.viewer.controls.getOperator().changeSelobject(),this.viewer.pmiObject&&this.viewer.pmiVisible&&(t=o.intersectsPMIObject(this.viewer.pmiObject))&&0<t.length&&(t.forEach(function(e){e.parent&&!e.parent.select&&e.parent.visible&&$.viewer.ndsModel.selectPMIObject(e.parent,!1)}),$.viewer.dispatchEvent({type:"selPMI",object:null})),e.controls.staticDrawGeomOp&&e.controls.staticDrawGeomOp.needSelectGeom()){var x=o.intersectsPMIObject(e.controls.staticDrawGeomOp.drawScene);if(x&&0<x.length){for(var b=[],B=0;B<x.length;B++)if(e.controls.staticDrawGeomOp.isTraceMode()){if("Point"!=x[B].objectType){b.push(x[B].uuid);break}}else b.push(x[B].uuid);0<b.length?(e.controls.staticDrawGeomOp.deselectAllMesh(),e.controls.staticDrawGeomOp.selectMesh(b)):e.controls.staticDrawGeomOp.deselectAllMesh(!0)}else e.controls.staticDrawGeomOp.deselectAllMesh(!0)}function I(e,t){var r=e[0],i=r[0],r=r[1],e=e[1],n=e[0],e=e[1],a=t[0],o=a[0],a=a[1],t=t[1],s=t[0],t=t[1],l=(t-a)*(n-i)-(s-o)*(e-r),s=(s-o)*(r-a)-(t-a)*(i-o),t=(n-i)*(r-a)-(e-r)*(i-o);return 0==l?0==s&&0==t:(n=t/l,0<=(a=s/l)&&a<=1&&0<=n&&n<=1)}function Y(e,t,r,i){var n,a,o;return s<e&&e<d&&l<t&&t<c||s<r&&r<d&&l<i&&i<c||(n=[[s,l],[d,l]],a=[[d,l],[d,c]],o=[[d,c],[s,c]],!!(I(e=[[e,t],[r,i]],[[s,l],[s,c]])||I(e,n)||I(e,a)||I(e,o)))}if(e.controls.staticAnnotation){for(var T=[],Q=0;Q<e.controls.staticAnnotation.TextContents.length;++Q){var K,S,R,C,D=e.controls.staticAnnotation.TextContents[Q];"hidden"!=D.style.visibility&&(K=D.newPoint||D.interPnt,"up"==(S=D.getAttribute("mobile"))||"down"==S?(R=e.controls.staticAnnotation.get2dPoint(K.clone()),C=e.controls.staticAnnotation.get2dPoint(D.pos.clone()),Y(R.x,R.y,C.x,C.y)&&T.push(D.id)):("left"==S||"right"==S)&&(R=e.controls.staticAnnotation.get2dPoint(K.clone()),C=e.controls.staticAnnotation.get2dPoint(D.pos.clone()),Y(R.x,R.y,Math.round((R.x+C.x)/2),C.y)||Y(C.x,C.y,Math.round((R.x+C.x)/2),C.y))&&T.push(D.id))}for(var Z=0;Z<e.controls.staticAnnotation.PicContents.length;++Z){var P,H,_,L,J=e.controls.staticAnnotation.PicContents[Z];"hidden"!=J.style.visibility&&(P=(L=J.getBoundingClientRect()).left-$.viewer.container.getBoundingClientRect().left,H=L.top-$.viewer.container.getBoundingClientRect().top,_=P+L.width,L=H+L.height,s<P&&P<d&&l<H&&H<c||s<_&&_<d&&l<L&&L<c||s<_&&_<d&&l<H&&H<c||s<P&&P<d&&l<L&&L<c)&&T.push(J.id)}e.controls.staticAnnotation.setSelectIdArray(T)}$.viewer.dispatchEvent({type:"selectedObjectBody"})},this.selectByClick=function(e,t,r){for(var i,n,a,o,s,l=this.viewer.additionalObjectsScene.children.length-1;-1<l;l--){var d=this.viewer.additionalObjectsScene.children[l];"persist"==d.name&&$.viewer.additionalObjectsScene.remove(d)}if("component"==E){var c=e,h=t,u=r,p=$.viewer,f=_(c,h,!1);if(f&&0<f.length){var m=null;if(p.ndsModel){var g=(m=f[0].bodyNode).parent,v=g?g.parent:null;for(m=null;null!=g&&null!=v&&("model"!=v.type||"assembly"!=g.type);)v=(g=(m=g).parent)?g.parent:null}null!=m&&(null!=u&&1==u?$.isObjectSelected(m)?($.deselectObject(m),p.dispatchAsyncEvent({type:"deselectObjectEvent",clickPosX:c,clickPosY:h}),$.updateBroadcastInfo(),p.dispatchAsyncEvent({type:"SelectionChangeEvent",added:[],removed:[{entityType:"component",bodyId:m.uuid,entityId:""}],clickPosX:c,clickPosY:h})):($.selectObject(m),p.dispatchAsyncEvent({type:"selectObjectEvent",clickPosX:c,clickPosY:h}),$.updateBroadcastInfo(),p.dispatchAsyncEvent({type:"SelectionChangeEvent",added:[{entityType:"component",bodyId:m.uuid,entityId:""}],removed:[],clickPosX:c,clickPosY:h})):$.isObjectSelected(m)?($.clearSelection(),p.dispatchAsyncEvent({type:"deselectObjectEvent",clickPosX:c,clickPosY:h})):($.clearSelection(),$.selectObject(m),p.dispatchAsyncEvent({type:"selectObjectEvent",clickPosX:c,clickPosY:h}),$.updateBroadcastInfo(),p.dispatchAsyncEvent({type:"SelectionChangeEvent",added:[{entityType:"component",bodyId:m.uuid,entityId:""}],removed:[],clickPosX:c,clickPosY:h})))}else null!=u&&0!=u||(f=!1,0<ee.length&&(f=!0),$.clearSelection(),f&&p.dispatchAsyncEvent({type:"deselectObjectEvent",clickPosX:c,clickPosY:h}));$.viewer.groundShadowChange()}else if("body"==E){var u=e,f=t,p=r,c=$.viewer,h=U(u,f,p),y=_(u,f,!1);if(c.controls.staticDrawGeomOp&&c.controls.staticDrawGeomOp.needSelectGeom()&&c.controls.staticDrawGeomOp.isTraceMode()&&(p=!0),!h&&y&&0<y.length){var A=null;if(c.ndsModel){if(A=y[0].bodyNode,De.selectObjectWithPropertyOnly&&!A.propertyfile){var M=A.parent;for(A=null;null!=M;){if(M.propertyfile){A=M;break}M=M.parent}}}else null==(A=$.findParentElement(y[0].object))&&(A=y[0].object);null!=A&&($.viewer.dispatchEvent({type:"selectObjectMaterialInfoByUUid",uuid:A.uuid}),null!=p&&1==p?$.isObjectSelected(A)?($.deselectObject(A),c.dispatchAsyncEvent({type:"deselectObjectEvent",clickPosX:u,clickPosY:f}),$.updateBroadcastInfo(),c.dispatchAsyncEvent({type:"SelectionChangeEvent",added:[],removed:[{entityType:"body",bodyId:A.uuid,entityId:""}],clickPosX:u,clickPosY:f})):($.selectObject(A),c.dispatchAsyncEvent({type:"selectObjectEvent",clickPosX:u,clickPosY:f}),$.updateBroadcastInfo(),c.dispatchAsyncEvent({type:"SelectionChangeEvent",added:[{entityType:"body",bodyId:A.uuid,entityId:""}],removed:[],clickPosX:u,clickPosY:f})):($.isObjectSelected(A)?($.clearSelection(),c.dispatchAsyncEvent({type:"deselectObjectEvent",clickPosX:u,clickPosY:f})):($.clearSelection(),$.selectObject(A),c.dispatchAsyncEvent({type:"selectObjectEvent",clickPosX:u,clickPosY:f}),$.updateBroadcastInfo(),c.dispatchAsyncEvent({type:"SelectionChangeEvent",added:[{entityType:"body",bodyId:A.uuid,entityId:""}],removed:[],clickPosX:u,clickPosY:f})),c.pmiObject&&c.ndsModel.deselectPMIObject(c.pmiObject),c.controls.staticDrawGeomOp&&c.controls.staticDrawGeomOp.needSelectGeom()&&c.controls.staticDrawGeomOp.deselectAllMesh(!0)))}else null!=p&&0!=p||(h=!1,0<ee.length&&(h=!0),c._clearSelectedPmi=!0,$.clearSelection(),c._clearSelectedPmi=!1,h&&c.dispatchAsyncEvent({type:"deselectObjectEvent",clickPosX:u,clickPosY:f}));$.viewer.groundShadowChange()}else"part"==E?(y=e,i=t,n=r,a=$.viewer,o=U(y,i,n),s=_(y,i,!1),!o&&s&&0<s.length?null!=(o=(o=s[0].bodyNode).ndsModel.isSketchModel?o:o.parent)&&(null!=n&&1==n?$.isObjectSelected(o)?($.deselectObject(o),a.dispatchAsyncEvent({type:"deselectObjectEvent",clickPosX:y,clickPosY:i}),$.updateBroadcastInfo(),a.dispatchAsyncEvent({type:"SelectionChangeEvent",added:[],removed:[{entityType:"component",bodyId:o.uuid,entityId:""}],clickPosX:y,clickPosY:i})):($.selectObject(o),a.dispatchAsyncEvent({type:"selectObjectEvent",clickPosX:y,clickPosY:i}),$.updateBroadcastInfo(),a.dispatchAsyncEvent({type:"SelectionChangeEvent",added:[{entityType:"component",bodyId:o.uuid,entityId:""}],removed:[],clickPosX:y,clickPosY:i})):($.isObjectSelected(o)?($.clearSelection(),a.dispatchAsyncEvent({type:"deselectObjectEvent",clickPosX:y,clickPosY:i})):($.clearSelection(),$.selectObject(o),a.dispatchAsyncEvent({type:"selectObjectEvent",clickPosX:y,clickPosY:i}),$.updateBroadcastInfo(),a.dispatchAsyncEvent({type:"SelectionChangeEvent",added:[{entityType:"component",bodyId:o.uuid,entityId:""}],removed:[],clickPosX:y,clickPosY:i})),a.pmiObject&&a.ndsModel.deselectPMIObject(a.pmiObject),a.controls.staticDrawGeomOp&&a.controls.staticDrawGeomOp.needSelectGeom()&&a.controls.staticDrawGeomOp.deselectAllMesh(!0))):null!=n&&0!=n||(s=!1,0<ee.length&&(s=!0),a._clearSelectedPmi=!0,$.clearSelection(),a._clearSelectedPmi=!1,s&&a.dispatchAsyncEvent({type:"deselectObjectEvent",clickPosX:y,clickPosY:i})),$.viewer.groundShadowChange()):"face"==E?k(e,t,!1,r,!1):"edge"==E?W(e,t,!1,r):"vertex"==E?Y(e,t,!1,r):"plane"==E?k(e,t,!1,r,!0):"axis"==E?K(e,t,!1,r):"line"==E?Z(e,t,!1,r):"line_plane"==E?J(e,t,!1,r):"vertex_edge_face"==E&&Q(e,t,!1,r)},this.selectOnMouseMove=function(e,t){"vertex"==E?Y(e,t,!0):"edge"==E?W(e,t,!0):"face"==E?k(e,t,!0,void 0,!1):"plane"==E?k(e,t,!0,void 0,!0):"axis"==E?K(e,t,!0):"line"==E?Z(e,t,!0):"line_plane"==E?J(e,t,!0):"vertex_edge_face"==E&&Q(e,t,!0)},this.SelectFace=function(e,t,r,i){k(this.viewerClientX=e,this.viewerClientY=t,r,i,!1)},this.HandleSelectedFace=function(e,t,r){H(e,t,r)},this.renderSelectionScene=function(e,t){if(0<B.children.length){for(var r=0;r<B.children.length;r++){var i=B.children[r];null!=i.objectType&&"Point"===i.objectType&&V(i,b)}e?this.viewer.renderer.render(n,this.viewer.camera,e,t):this.viewer.renderer.render(n,this.viewer.camera)}},this.selectObjectByUuid=function(e,t){e=function e(t,r,i){var n=null;var a=r.children;if(null==a)return n;for(var o=0,s=a.length;o<s;++o){var l=a[o];if(l.uuid==t){if(!i){n=l;break}var d=ae(l);if(d&&i==d.uuid){n=l;break}}else if(null!=(n=e(t,l,i)))break}return n}(e,$.scene,t);null!=e&&($.clearSelection(),$.selectObject(e))},this.EXPORT_SelectGeom=function(e){var t,r,i,n,a=null,o=$.viewer;return a=o.controls.staticDrawGeomOp&&o.controls.staticDrawGeomOp.needSelectGeom()&&(n=o.renderer.domElement,r=o.renderer.getPixelRatio(),t=e.x*r/n.width*2-1,e=2*-(e.y*r/n.height)+1,(r=new THREE.Raycaster).linePrecision=1,n=o.clientCoordToModelCoord([0,0]),n=new THREE.Vector3(n[0],n[1],n[2]),i=o.clientCoordToModelCoord([4,0]),i=new THREE.Vector3(i[0],i[1],i[2]),r.linePrecision=.65*n.distanceTo(i),o.camera.setCastRay(r,t,e),n=r.intersectObjects(o.controls.staticDrawGeomOp.drawScene.children,!0)[0],o.controls.staticDrawGeomOp.isTraceMode()?n&&"Point"!=n.object.objectType:!!n)?n.object.uuid:a},this.EXPORT_SelectGeomPolytope=function(e){var t=[],r=$.viewer;if(r.controls.staticDrawGeomOp&&r.controls.staticDrawGeomOp.needSelectGeom()){var i=r.renderer.domElement,n=r.renderer.getPixelRatio(),a=e[0].x*n/i.width*2-1,o=2*-(e[0].y*n/i.height)+1,s=e[1].x*n/i.width*2-1,l=2*-(e[1].y*n/i.height)+1,d=e[2].x*n/i.width*2-1,c=2*-(e[2].y*n/i.height)+1,h=e[3].x*n/i.width*2-1,e=2*-(e[3].y*n/i.height)+1,n=new THREE.Vector2(a,o),i=new THREE.Vector2(s,l),a=new THREE.Vector2(d,c),o=new THREE.Vector2(h,e),s=[];this.viewer.camera.setCastPolytopes(s,n,i,a,o);var u=new THREE.Polytope(s).intersectsPMIObject(r.controls.staticDrawGeomOp.drawScene);if(u&&0<u.length)for(var p=0;p<u.length;p++)if(r.controls.staticDrawGeomOp.isTraceMode()){if("Point"!=u[p].objectType){t.push(u[p].uuid);break}}else t.push(u[p].uuid)}return t},this.EXPORT_SelectObject=function(e){var e=_(e.x,e.y,!1),t=null;return t=e&&0<e.length&&e[0].bodyNode?e[0].bodyNode.uuid:t},this.EXPORT_SelectBodyPolytope=function(e){var t=$.viewer,r=t.renderer.domElement,t=t.renderer.getPixelRatio(),i=e[0].x*t/r.width*2-1,n=2*-(e[0].y*t/r.height)+1,a=e[1].x*t/r.width*2-1,o=2*-(e[1].y*t/r.height)+1,s=e[2].x*t/r.width*2-1,l=2*-(e[2].y*t/r.height)+1,d=e[3].x*t/r.width*2-1,e=2*-(e[3].y*t/r.height)+1,t=new THREE.Vector2(i,n),r=new THREE.Vector2(a,o),i=new THREE.Vector2(s,l),n=new THREE.Vector2(d,e),a=[],o=(this.viewer.camera.setCastPolytopes(a,t,r,i,n),new THREE.Polytope(a)),c=[],h=this.viewer.ndsModel.intersectPolytope(o);if(h&&0<h.length)for(var u=0;u<h.length;u++)null!=h[u].bodyNode&&c.push(h[u].bodyNode.uuid);return c}}var t=e.prototype;return t.getSelectedBodyVolumeAndArea=function(){function s(e,t){for(var r=0,i=e.length;r<i;r++){var n=e[r].type.toLowerCase();if(!e[r].unload)if("body"==n){if(e[r]._leafBodyAttri&&0!=e[r]._leafBodyAttri._bodyMeshIds.length){for(var a=!1,o=0;o<l.selectedObjects.length;++o)if(e[r].uuid==l.selectedObjects[o].uuid&&e[r].ndsModel.id===l.selectedObjects[o].ndsModel.id){a=!0;break}a&&l.selectedObjects!=e||(n=e[r].ndsModel.brepManager.GetBodyVolumeAndArea(e[r].uuid))&&(t.volume+=n.volume,t.area+=n.area)}}else{for(a=!1,o=0;o<l.selectedObjects.length;++o)if(e[r].uuid==l.selectedObjects[o].uuid&&e[r].ndsModel.id===l.selectedObjects[o].ndsModel.id){a=!0;break}(!a||l.selectedObjects==e)&&0<e[r].children.length&&s(e[r].children,t)}}}var e,t,l=this;return this.viewer.hasBrepInfo()&&0<this.selectedObjects.length&&(s(this.selectedObjects,e={volume:0,area:0}),1e-7<e.area)?(t=this.viewer.getDispalyModelUnit(e.volume,e.area),e.volume=e.volume*t.scale*t.scale*t.scale,e.area=e.area*t.scale*t.scale,[e,t.unit]):null},t.updateBroadcastInfo=function(){De.enableBroadcast&&De.broadcastMajor&&He.updateBroadcastInfo("ModelState")},e}(),Tn=new A({visible:!1,transparent:!1}),e=(((mn.prototype=Object.create(THREE.Object3D.prototype)).constructor=mn).prototype.update=function(t,r){var i=new THREE.Vector3(0,0,0),n=new THREE.Vector3(0,1,0),a=new THREE.Matrix4;this.traverse(function(e){-1!==e.name.search("E")?e.quaternion.setFromRotationMatrix(a.lookAt(r,i,n)):-1===e.name.search("X")&&-1===e.name.search("Y")&&-1===e.name.search("Z")||e.quaternion.setFromEuler(t)})},(gn.prototype=Object.create(mn.prototype)).constructor=gn,(vn.prototype=Object.create(mn.prototype)).constructor=vn,(yn.prototype=Object.create(THREE.Object3D.prototype)).constructor=yn,(An.prototype=Object.create(mn.prototype)).constructor=An,(Mn.prototype=Object.create(THREE.Object3D.prototype)).constructor=Mn,(Oe.prototype=Object.create(a.prototype)).onLMouseDown=function(e){this.state=Ce.MOUSE.LEFT},Oe.prototype.onLMouseDbClick=function(e){this.viewer.zoomExtents(),this.updateRotateCenterHelper()},Oe.prototype.setMoveMode=function(){this.opMode="move"},Oe.prototype.setRestoreMode=function(){this.opMode="restore"},Oe.prototype.setDefaultMode=function(){this.opMode="default"},Oe.prototype.isModelMoved=function(){var t;return this.viewer.ndsModel?this.viewer.ndsModel.hasDraggedBodies():(t=!1,this.viewer.scene.traverse(function(e){e.hasOwnProperty("geometry")&&null!=e.matrixWorldTransoriginalDrag&&(t=!0)}),t)},Oe.prototype.hideSelectedModel=function(){this.viewer.hideSelectedObjects()},Oe.prototype.showAllModel=function(){this.viewer.showObject(this.viewer.scene,!0),this.render()},Oe.prototype.reverseVisibleAndHidingModel=function(){this.viewer.showObjectReversed(this.viewer.scene),this.render()},Oe.prototype.create=function(){De.HideLeafBody?(this.viewer.selectionManager.setSelectType("part"),this.viewer.controls.getOperator().oldSelectType="part"):this.viewer.selectionManager.setSelectType("body"),a.prototype.create.call(this)},Oe.prototype.release=function(){this.update(),this.render(),this.clipTransRotControl&&(this.clipTransRotControl.removeEventListener("objectChange",this.onOpBall),this.clipTransRotControl.removeEventListener("mouseUp",this.mouseup),this.clipTransRotControl.dispose(),this.clipTransRotControl=null),this.clipObjectBox&&(this.clipObjectBox=null),this.viewer.removeEventListener("updateOpball",this.updateOpballCenter),this.MoveObjects=[],this.viewer.piovtInfoMultiRot={},a.prototype.release.call(this)},Oe.prototype.update=function(){a.prototype.update.call(this)},Oe.prototype.onLMouseClick=function(e){e.preventDefault(),e.stopPropagation();this.viewer;var t=e.offsetX||e.clientX-this.viewer.container.getBoundingClientRect().left,r=e.offsetY||e.clientY-this.viewer.container.getBoundingClientRect().top;e.srcElement&&e.srcElement!==this.viewer.renderer.domElement&&(t=e.clientX-this.viewer.container.getBoundingClientRect().left,r=e.clientY-this.viewer.container.getBoundingClientRect().top),null==e.srcElement&&e.target&&e.target!==this.viewer.renderer.domElement&&(t=e.clientX-this.viewer.container.getBoundingClientRect().left,r=e.clientY-this.viewer.container.getBoundingClientRect().top),Math.abs(t-this.lMouseDown.x)<1&&Math.abs(r-this.lMouseDown.y)<1&&("move"!=this.opMode&&"default"!=this.opMode||(this.viewer.selectionManager.selectByClick(t,r,!!e.ctrlKey),this.startMove()))},Oe.prototype.onMMouseUp=function(e){a.prototype.onMMouseUp.call(this,e),"move"!=this.opMode&&"default"!=this.opMode||this.startMove()},Oe.prototype.updateclipTransRotControl=function(e){if(this.MoveObjects=this.viewer.selectionManager.getSelectedleafObjects(!0),0==this.MoveObjects.length)this.translateScene&&"multiRotation"!=this._setModel&&(this.clipTransRotControl&&this.translateScene.remove(this.clipTransRotControl),this.clipObjectBox)&&this.translateScene.remove(this.clipObjectBox);else if("rotate"!=this._setModel&&"rotate"!=e){for(var t=new THREE.Box3,r=0;r<this.MoveObjects.length;++r){var i=this.MoveObjects[r],n=null;i.isDrawGeom?(n=i.geometry.boundingBox.clone()).applyMatrix4(i.matrix):n=this.viewer.ndsModel.getBodyBoundingBox(i),n&&!n.isEmpty()&&(t.expandByPoint(n.max),t.expandByPoint(n.min))}this.emptyCenter.set(0,0,0),this.WorldPosition.copy(t.getCenter(this.emptyCenter)),this.viewer.dispatchEvent({type:"OpBallRosMid"}),this.clipTransRotControl&&(this.clipTransRotControl.position.copy(this.piovtRotateMid||this.WorldPosition),this.clipTransRotControl.object.position.copy(this.piovtRotateMid||this.WorldPosition),this.clipTransRotControl.updateMatrixWorld(!0))}this.render()},Oe.prototype.startMove=function(r,e){var i,n,a,t,o,s=this,l=(void 0===r&&(r=!1),this.MoveObjects=this.viewer.selectionManager.getSelectedleafObjects(!0),r&&(o=this.MoveObjects,this.viewer.controls.staticDrawGeomOp&&0<(t=this.viewer.controls.staticDrawGeomOp.selectMeshMap.size)&&(o=this.MoveObjects.slice(0,this.MoveObjects.length-t)),this.MoveObjects.forEach(function(e){r&&(e.finalLocalMatrix||(e.finalLocalMatrix=new THREE.Matrix4),e.isDrawGeom?e.finalLocalMatrix.fromArray(e.matrix.toArray()):e.finalLocalMatrix.fromArray(e.matrix),e.initBeginLocalMatrix=!1)}),this.viewer.dispatchEvent({type:"OpBallMoveEnd",MoveObjects:o,center:this.piovtRotatePos||this.WorldPosition,mode:e.mode})),this);if(this.MoveObjects.forEach(function(e){var t;e.originalPosition||(e.originalPosition=new THREE.Vector3,t=null,e.isDrawGeom?(t=e.geometry.boundingBox.clone()).applyMatrix4(e.matrix):t=l.viewer.ndsModel.getBodyBoundingBox(e),t&&(s.emptyCenter.set(0,0,0),e.originalPosition.copy(t.getCenter(s.emptyCenter)))),e.originalEuler||(e.originalEuler=new THREE.Euler,e.staticEuler=new THREE.Euler,e.worldMatrix.decompose(s.DecomposePosition,s.DecomposeQuaternion,s.DecomposeScale),e.originalEuler.setFromQuaternion(s.DecomposeQuaternion),e.staticEuler.copy(e.originalEuler)),e.originalMatrix||(e.originalMatrix=new THREE.Matrix4,e.originalMatrix.copy(e.worldMatrix)),r||(t=null,e.isDrawGeom?(t=e.geometry.boundingBox.clone()).applyMatrix4(e.matrix):t=l.viewer.ndsModel.getBodyBoundingBox(e),l.emptyCenter.set(0,0,0),t&&e.originalPosition.copy(t.getCenter(l.emptyCenter)),e.worldMatrix.decompose(s.DecomposePosition,s.DecomposeQuaternion,s.DecomposeScale),e.originalEuler.setFromQuaternion(s.DecomposeQuaternion),e.staticEuler.copy(e.originalEuler),e.originalMatrix.copy(e.worldMatrix)),r||(e.selectedMatrix=new THREE.Matrix4,e.selectedMatrix.copy(e.worldMatrix))}),this.singleObject&&!r&&(this.singleObject.originalEuler.set(this.angle.x*Math.PI/180,this.angle.y*Math.PI/180,this.angle.z*Math.PI/180),this.singleObject=null),1==this.MoveObjects.length&&(this.singleObject=this.MoveObjects[0]),0!=this.MoveObjects.length||"multiRotation"==this._setModel||r){if(!r){for(var d=new THREE.Box3,c=null,h=0;h<this.MoveObjects.length;++h){var u=this.MoveObjects[h];u.isDrawGeom?(c=u.geometry.boundingBox.clone()).applyMatrix4(u.matrix):c=this.viewer.ndsModel.getBodyBoundingBox(u),c&&!c.isEmpty()&&(d.expandByPoint(c.max),d.expandByPoint(c.min))}this.emptyCenter.set(0,0,0),this.WorldPosition.copy(d.getCenter(this.emptyCenter)),this.viewer.dispatchEvent({type:"OpBallRosMid"})}this.rotateAngle=0,"move"!=this.opMode&&"default"!=this.opMode||(t=new THREE.Object3D,this.piovtRotateDir?(o=(new THREE.Quaternion).setFromUnitVectors(new THREE.Vector3(1,0,0),this.piovtRotateDir),e=(new THREE.Matrix4).makeRotationFromQuaternion(o),o=(new THREE.Matrix4).makeTranslation(this.piovtRotateMid.x,this.piovtRotateMid.y,this.piovtRotateMid.z),t.applyMatrix(e),t.applyMatrix(o),t.updateMatrixWorld()):t.position.copy(this.piovtRotateMid||this.WorldPosition),t.visible=!0,o=e=null,this.clipTransRotControl&&(e=this.clipTransRotControl.originalPosition.clone(),o=this.clipTransRotControl.totalquaternion.clone()),this.translateScene||(this.translateScene=new THREE.Scene),this.clipObjectBox||"rotate"!=this._setModel&&"multiRotation"!=this._setModel||(this.clipObjectBox=new THREE.Mesh(new THREE.SphereGeometry(this.geomPointSize),new THREE.MeshBasicMaterial({color:750054,opacity:1,side:THREE.DoubleSide})),this.clipObjectBox.position.set(t.position.x,t.position.y,t.position.z),this.clipObjectBox.geometry.computeBoundingBox(),this.clipObjectBox.geometry.computeBoundingSphere(),this.clipObjectBox.updateMatrixWorld(),this.translateScene.add(this.clipObjectBox)),this.clipTransRotControl&&(this.piovtRotateDir&&null==this.clipTransRotControl.piovtDir||!this.piovtRotateDir&&this.clipTransRotControl.piovtDir)&&(this.translateScene&&this.translateScene.remove(this.clipTransRotControl),this.clipTransRotControl.removeEventListener("objectChange",this.onOpBall),this.clipTransRotControl.removeEventListener("mouseUp",this.mouseup),this.clipTransRotControl.dispose(),o=e=this.clipTransRotControl=null,this.viewer.render()),this.clipTransRotControl||(this.clipTransRotControl=new Mn(this.viewer.camera,this.domElement,this.viewer,this,this.piovtRotateDir?["translateX"]:void 0,"multiRotation"==this._setModel),this.translateScene.add(this.clipTransRotControl)),this.clipTransRotControl.position.copy(this.piovtRotateMid||this.WorldPosition),this.clipTransRotControl.quaternion.set(0,0,0,1),this.clipTransRotControl.updateMatrixWorld(!0),this.clipTransRotControl.originalPosition=e||(this.piovtRotateMid||this.WorldPosition).clone(),r||(this.clipTransRotControl.selectedPosition=(this.piovtRotateMid||this.WorldPosition).clone()),this.clipTransRotControl.totalquaternion=o||new THREE.Quaternion,this.clipTransRotControl.setSize(.8),this.clipTransRotControl.initRotateOffset(),this.clipTransRotControl.axis=null,this.clipTransRotControl.setMode("multiRotation"==this._setModel?"both":this._setModel),this.clipTransRotControl.setSpace("local"),this.clipTransRotControl.attach(t),this.clipTransRotControl.addEventListener("objectChange",this.onOpBall),this.clipTransRotControl.addEventListener("mouseUp",this.mouseup),this.piovtRotateDir&&this.clipTransRotControl.setPiovtDir(this.piovtRotateDir),this.viewer.controls.getOperator()&&this.viewer.controls.getOperator().resetEventListener(),this.render(),r)||this.dispatchPositonandAngle(!0)}else this.preSelectedObjects.length&&(i=new THREE.Matrix4,n=new THREE.Matrix4,a=new THREE.Matrix4,this.preSelectedObjects.forEach(function(e){var t=e.parent?e.parent.worldMatrix.clone():new THREE.Matrix4;a.copy(e._multiSelectedMatrix),delete e._multiSelectedMatrix,i.getInverse(t),n=a.premultiply(i),s.viewer.ndsModel.updateNodeMatrix(e.uuid,n.toArray(),e.getModel().id)}),this.clipTransRotControl&&this.clipTransRotControl.setMultiRotateAngle(0),this.preSelectedObjects=[]),"multiRotation"!=this._setModel&&(this.translateScene&&(this.clipTransRotControl&&this.translateScene.remove(this.clipTransRotControl),this.clipObjectBox)&&this.translateScene.remove(this.clipObjectBox),this.clipObjectBox&&(this.clipObjectBox=null),this.clipTransRotControl&&(this.clipTransRotControl.removeEventListener("objectChange",this.onOpBall),this.clipTransRotControl.removeEventListener("mouseUp",this.mouseup),this.clipTransRotControl.dispose(),this.clipTransRotControl=null),this.viewer.dispatchEvent({type:"OpBallModel",position:{x:0,y:0,z:0},angle:{x:0,y:0,z:0}})),this.render()},Oe.prototype.renderModel=function(){this.translateScene&&this.clipTransRotControl&&(this.clipTransRotControl.updateMatrixWorld(),this.clipTransRotControl.update(),this.clipObjectBox&&(this.clipObjectBox.position.copy(this.clipTransRotControl.position),this.clipObjectBox.scale.copy(this.clipTransRotControl.scale),this.clipObjectBox.updateMatrixWorld()),this.viewer.renderer.render(this.translateScene,this.viewer.camera)),a.prototype.renderModel.call(this)},Oe.prototype.setRosAxisAndPos=function(e,t,r){this.piovtRotateDir=e,this.piovtRotatePos=t,this.piovtRotateMid=r},Oe.prototype.textValueByMultiRos=function(e){var n=this,a=new THREE.Matrix4,o=new THREE.Matrix4,s=new THREE.Matrix4,l=(new THREE.Quaternion).setFromAxisAngle(this.piovtRotateDir,e.x*Math.PI/180),d=this.clipTransRotControl.totalquaternion.clone().conjugate(),r=this.viewer.selectionManager.getSelectedleafObjects(!1),e=this.preSelectedObjects.filter(function(t){return!r.find(function(e){return e.uuid==t.uuid&&e.ndsModel.id==t.ndsModel.id})}),t=r.filter(function(t){return!n.preSelectedObjects.find(function(e){return e.uuid==t.uuid&&e.ndsModel.id==t.ndsModel.id})}),i=this.preSelectedObjects.filter(function(t){return r.find(function(e){return e.uuid==t.uuid&&e.ndsModel.id==t.ndsModel.id})});t.forEach(function(e){e._multiSelectedMatrix||(e._multiSelectedMatrix=new THREE.Matrix4,e._multiSelectedMatrix.copy(e.worldMatrix));var t=e.parent?e.parent.worldMatrix.clone():new THREE.Matrix4,r=(s.copy(e.worldMatrix),a.makeTranslation(-e.originalPosition.x,-e.originalPosition.y,-e.originalPosition.z),s.premultiply(a),a.makeRotationFromQuaternion(l),s.premultiply(a),a.makeTranslation(n.piovtRotatePos.x,n.piovtRotatePos.y,n.piovtRotatePos.z),s.premultiply(a),(new THREE.Vector3).subVectors(e.originalPosition,n.piovtRotatePos)),i=(new THREE.Vector3).copy(r).normalize().applyQuaternion(l),i=(new THREE.Vector3).copy(n.piovtRotatePos).addScaledVector(i,r.length()),r=(a.makeTranslation(i.x-n.piovtRotatePos.x,i.y-n.piovtRotatePos.y,i.z-n.piovtRotatePos.z),s.premultiply(a),a.getInverse(t),e.beginLocalMatrix||(e.beginLocalMatrix=new THREE.Matrix4),new THREE.Matrix4);r.copy(e.worldMatrix),r.premultiply(a),e.beginLocalMatrix.fromArray(r.toArray()),o=s.premultiply(a),e.finalLocalMatrix||(e.finalLocalMatrix=new THREE.Matrix4),e.finalLocalMatrix.fromArray(o.toArray()),n.viewer.ndsModel.updateNodeMatrix(e.uuid,o.toArray(),e.getModel().id)}),e.forEach(function(e){var t=e.parent?e.parent.worldMatrix.clone():new THREE.Matrix4,t=(s.copy(e._multiSelectedMatrix),delete e._multiSelectedMatrix,a.getInverse(t),e.beginLocalMatrix||(e.beginLocalMatrix=new THREE.Matrix4),new THREE.Matrix4);t.copy(e.worldMatrix),t.premultiply(a),e.beginLocalMatrix.fromArray(t.toArray()),o=s.premultiply(a),e.finalLocalMatrix||(e.finalLocalMatrix=new THREE.Matrix4),e.finalLocalMatrix.fromArray(o.toArray()),n.viewer.ndsModel.updateNodeMatrix(e.uuid,o.toArray(),e.getModel().id)}),0==e.length&&0==t.length&&i.length==r.length&&i.forEach(function(e){var t=e.parent?e.parent.worldMatrix.clone():new THREE.Matrix4,r=(s.copy(e.worldMatrix),a.makeTranslation(-n.WorldPosition.x,-n.WorldPosition.y,-n.WorldPosition.z),s.premultiply(a),a.makeRotationFromQuaternion(d),s.premultiply(a),a.makeRotationFromQuaternion(l),s.premultiply(a),a.makeTranslation(n.piovtRotatePos.x,n.piovtRotatePos.y,n.piovtRotatePos.z),s.premultiply(a),(new THREE.Vector3).subVectors(n.WorldPosition,n.piovtRotatePos)),i=(new THREE.Vector3).copy(r).normalize().applyQuaternion(d).applyQuaternion(l),i=(new THREE.Vector3).copy(n.piovtRotatePos).addScaledVector(i,r.length()),r=(a.makeTranslation(i.x-n.piovtRotatePos.x,i.y-n.piovtRotatePos.y,i.z-n.piovtRotatePos.z),s.premultiply(a),a.getInverse(t),e.beginLocalMatrix||(e.beginLocalMatrix=new THREE.Matrix4),new THREE.Matrix4);r.copy(e.worldMatrix),r.premultiply(a),e.beginLocalMatrix.fromArray(r.toArray()),o=s.premultiply(a),e.finalLocalMatrix||(e.finalLocalMatrix=new THREE.Matrix4),e.finalLocalMatrix.fromArray(o.toArray()),n.viewer.ndsModel.updateNodeMatrix(e.uuid,o.toArray(),e.getModel().id)}),this.clipTransRotControl.totalquaternion.copy(l),this.preSelectedObjects=r,this.viewer.dispatchEvent({type:"OpBallMoveEnd",MoveObjects:r}),this.render()},Oe.prototype.resetValueByRos=function(){this.clipTransRotControl&&(this.clipTransRotControl.totalquaternion=new THREE.Quaternion,this.clipTransRotControl.setMultiRotateAngle(0))},Oe.prototype.MoveFromTextValueByDelta=function(e){if("multiRotation"==this._setModel)this.textValueByMultiRos(e),this.clipTransRotControl&&this.clipTransRotControl.setMultiRotateAngle(e.x);else if(this.clipTransRotControl){e.x=M(parseFloat(e.x)),e.y=M(parseFloat(e.y)),e.z=M(parseFloat(e.z));var t=null,r=this.viewer.selectionManager.getSelectedleafObjects(!0),i=new THREE.Matrix4;if("translate"==e.mode){this.piovtRotateDir?((t=new THREE.Vector3).x=e.x*Math.cos(this.piovtRotateDir.angleTo(new THREE.Vector3(1,0,0))),t.y=e.x*Math.cos(this.piovtRotateDir.angleTo(new THREE.Vector3(0,1,0))),t.z=e.x*Math.cos(this.piovtRotateDir.angleTo(new THREE.Vector3(0,0,1)))):t=new THREE.Vector3(e.x,e.y,e.z),this.clipTransRotControl.object.position.add(t),this.clipTransRotControl.object.updateMatrixWorld(),this.clipTransRotControl.update();for(var n=0;n<r.length;++n){var a,o,s=r[n],l=new THREE.Matrix4,d=(new THREE.Matrix4).makeTranslation(t.x,t.y,t.z),c=new THREE.Matrix4;c.copy(s.selectedMatrix),c.premultiply(d),s.isDrawGeom?(s.beginLocalMatrix||(s.beginLocalMatrix=new THREE.Matrix4),s.matrix&&s.beginLocalMatrix.fromArray(s.matrix.toArray()),s.matrix.copy(c),s.matrixAutoUpdate=!1,s.applyMatrix(new THREE.Matrix4),s.matrixAutoUpdate=!0,s.updateMatrixWorld(),s.finalLocalMatrix||(s.finalLocalMatrix=new THREE.Matrix4),s.finalLocalMatrix.fromArray(c.toArray())):((d=(new THREE.Matrix4).getInverse(s.worldMatrix)).premultiply(c),f=s.parent?s.parent.worldMatrix.clone():new THREE.Matrix4,(a=new THREE.Matrix4).getInverse(f),s.beginLocalMatrix||(s.beginLocalMatrix=new THREE.Matrix4),(o=new THREE.Matrix4).copy(s.worldMatrix),o.premultiply(a),s.beginLocalMatrix.fromArray(o.toArray()),l=c.premultiply(a),s.finalLocalMatrix||(s.finalLocalMatrix=new THREE.Matrix4),s.finalLocalMatrix.fromArray(l.toArray()),this.viewer.ndsModel.updateNodeMatrix(s.uuid,l.toArray(),s.getModel().id),this.viewer.dispatchEvent({type:"OpBallTranslateMtx",bodyNode:s,matrix:d,mode:e.mode}))}this.updateclipTransRotControl()}else if("rotate"==e.mode){for(var h=new THREE.Euler(e.x*Math.PI/180,e.y*Math.PI/180,e.z*Math.PI/180),u=this.piovtRotateDir?(new THREE.Quaternion).setFromAxisAngle(this.piovtRotateDir,e.x*Math.PI/180):(new THREE.Quaternion).setFromEuler(h),p=this.clipTransRotControl.totalquaternion.clone().conjugate(),n=0;n<r.length;++n){var f,m,s=r[n],g=new THREE.Matrix4,v=new THREE.Matrix4,y=new THREE.Matrix4;s.isDrawGeom?(s.beginLocalMatrix||(s.beginLocalMatrix=new THREE.Matrix4),s.matrix&&s.beginLocalMatrix.fromArray(s.matrix.toArray()),y.makeTranslation(-this.WorldPosition.x,-this.WorldPosition.y,-this.WorldPosition.z),v.premultiply(y),y.makeRotationFromQuaternion(p),v.premultiply(y),y.makeRotationFromQuaternion(u),v.premultiply(y),y.makeTranslation(this.WorldPosition.x,this.WorldPosition.y,this.WorldPosition.z),v.premultiply(y),s.applyMatrix(v),s.updateMatrixWorld(),s.finalLocalMatrix||(s.finalLocalMatrix=new THREE.Matrix4),s.finalLocalMatrix.fromArray(s.matrix.toArray())):(i.copy(s.worldMatrix),f=s.parent?s.parent.worldMatrix.clone():new THREE.Matrix4,this.piovtRotatePos?(y.makeTranslation(-this.WorldPosition.x,-this.WorldPosition.y,-this.WorldPosition.z),i.premultiply(y),y.makeRotationFromQuaternion(p),i.premultiply(y),y.makeRotationFromQuaternion(u),i.premultiply(y),y.makeTranslation(this.piovtRotatePos.x,this.piovtRotatePos.y,this.piovtRotatePos.z),i.premultiply(y),v=(new THREE.Vector3).subVectors(this.WorldPosition,this.piovtRotatePos),m=(new THREE.Vector3).copy(v).normalize().applyQuaternion(p).applyQuaternion(u),m=(new THREE.Vector3).copy(this.piovtRotatePos).addScaledVector(m,v.length()),y.makeTranslation(m.x-this.piovtRotatePos.x,m.y-this.piovtRotatePos.y,m.z-this.piovtRotatePos.z),i.premultiply(y),this.viewer.dispatchEvent({type:"OpBallTranslateMtx",bodyNode:s,piovtRotatePos:this.piovtRotatePos,quaternion:u,conjugatequater:p,mode:this.clipTransRotControl.pickType})):(y.makeTranslation(-this.WorldPosition.x,-this.WorldPosition.y,-this.WorldPosition.z),i.premultiply(y),y.makeRotationFromQuaternion(p),i.premultiply(y),y.makeRotationFromQuaternion(u),i.premultiply(y),y.makeTranslation(this.WorldPosition.x,this.WorldPosition.y,this.WorldPosition.z),i.premultiply(y),this.viewer.dispatchEvent({type:"OpBallTranslateMtx",bodyNode:s,piovtRotatePos:this.WorldPosition,quaternion:u,conjugatequater:p,mode:this.clipTransRotControl.pickType})),y.getInverse(f),g=i.premultiply(y),s.beginLocalMatrix||(s.beginLocalMatrix=new THREE.Matrix4),(v=new THREE.Matrix4).copy(s.worldMatrix),v.premultiply(y),s.beginLocalMatrix.fromArray(v.toArray()),s.finalLocalMatrix||(s.finalLocalMatrix=new THREE.Matrix4),s.finalLocalMatrix.fromArray(g.toArray()),this.viewer.ndsModel.updateNodeMatrix(s.uuid,g.toArray(),s.getModel().id))}this.rotateAngle=e.x,this.clipTransRotControl.totalquaternion.copy(u)}var A,h=r;this.viewer.controls.staticDrawGeomOp&&0<(A=this.viewer.controls.staticDrawGeomOp.selectMeshMap.size)&&(h=r.slice(0,r.length-A)),this.viewer.dispatchEvent({type:"OpBallMoveEnd",MoveObjects:h,center:this.piovtRotatePos||this.WorldPosition,mode:e.mode}),this.render()}function M(e){return e%180==0?0<e?e-1e-5:e<0?e+1e-5:e:e}},Oe.prototype.MoveFromTextValue=function(e){if(this.clipTransRotControl){e.x=parseFloat(e.x),e.y=parseFloat(e.y),e.z=parseFloat(e.z);var t=null,r=null,i=this.viewer.selectionManager.getSelectedleafObjects(!0),n=new THREE.Matrix4;if("translate"==e.mode){if(1==i.length){var t=new THREE.Vector3(e.x,e.y,e.z),a=new THREE.Box3,o=null,s=(i[0].isDrawGeom?(o=i[0].geometry.boundingBox.clone()).applyMatrix4(i[0].matrix):o=this.viewer.ndsModel.getBodyBoundingBox(i[0]),o&&!o.isEmpty()&&(a.expandByPoint(o.max),a.expandByPoint(o.min)),a.getCenter());i[0].worldMatrix.decompose(this.DecomposePosition,this.DecomposeQuaternion,this.DecomposeScale),t.sub(s),this.clipTransRotControl.object.position.add(t),this.clipTransRotControl.object.updateMatrixWorld(),this.clipTransRotControl.update();for(var l=0;l<i.length;++l){var d=i[l],c=new THREE.Matrix4,h=(new THREE.Matrix4).makeTranslation(t.x,t.y,t.z);d.isDrawGeom?(d.applyMatrix(h),d.updateMatrixWorld()):(n.copy(d.worldMatrix),n.premultiply(h),y=d.parent?d.parent.worldMatrix.clone():new THREE.Matrix4,(h=new THREE.Matrix4).getInverse(y),c=n.premultiply(h),this.viewer.ndsModel.updateNodeMatrix(d.uuid,c.toArray(),d.getModel().id))}}else{(t=new THREE.Vector3(e.x,e.y,e.z)).add(this.clipTransRotControl.originalPosition),t.sub(this.clipTransRotControl.object.position),this.clipTransRotControl.object.position.add(t),this.clipTransRotControl.object.updateMatrixWorld(),this.clipTransRotControl.update();for(l=0;l<i.length;++l){var d=i[l],u=new THREE.Matrix4,p=(new THREE.Matrix4).makeTranslation(t.x,t.y,t.z);d.isDrawGeom?(d.applyMatrix(p),d.updateMatrixWorld()):(n.copy(d.worldMatrix),n.premultiply(p),y=d.parent?d.parent.worldMatrix.clone():new THREE.Matrix4,(p=new THREE.Matrix4).getInverse(y),u=n.premultiply(p),this.viewer.ndsModel.updateNodeMatrix(d.uuid,u.toArray(),d.getModel().id))}}this.updateclipTransRotControl()}else if("rotate"==e.mode){var r=new THREE.Euler(e.x*Math.PI/180,e.y*Math.PI/180,e.z*Math.PI/180),f=(new THREE.Quaternion).setFromEuler(r),m=this.clipTransRotControl.totalquaternion.clone().conjugate();if(1==i.length){var d=i[0],r=(r.set(r.x-d.staticEuler.x,r.y-d.staticEuler.y,r.z-d.staticEuler.z),f.setFromEuler(r),new THREE.Matrix4),g=new THREE.Matrix4,v=new THREE.Matrix4,a=(n.copy(d.originalMatrix),new THREE.Box3),o=null;d.isDrawGeom?(o=d.geometry.boundingBox.clone()).applyMatrix4(d.matrix):o=this.viewer.ndsModel.getBodyBoundingBox(d),o&&!o.isEmpty()&&(a.expandByPoint(o.max),a.expandByPoint(o.min));o=(s=a.getCenter()).sub(d.originalPosition);d.isDrawGeom?(v.makeTranslation(-d.originalPosition.x,-d.originalPosition.y,-d.originalPosition.z),g.premultiply(v),v.makeRotationFromQuaternion(f),g.premultiply(v),v.makeTranslation(d.originalPosition.x,d.originalPosition.y,d.originalPosition.z),g.premultiply(v),v.makeTranslation(o.x,o.y,o.z),g.premultiply(v),d.applyMatrix(g),d.updateMatrixWorld()):(y=d.parent?d.parent.worldMatrix.clone():new THREE.Matrix4,v.makeTranslation(-d.originalPosition.x,-d.originalPosition.y,-d.originalPosition.z),n.premultiply(v),g.premultiply(v),v.makeRotationFromQuaternion(f),n.premultiply(v),g.premultiply(v),v.makeTranslation(d.originalPosition.x,d.originalPosition.y,d.originalPosition.z),n.premultiply(v),g.premultiply(v),v.makeTranslation(o.x,o.y,o.z),n.premultiply(v),g.premultiply(v),v.getInverse(y),r=n.premultiply(v),this.viewer.ndsModel.updateNodeMatrix(d.uuid,r.toArray(),d.getModel().id)),d.originalEuler.set(e.x*Math.PI/180,e.y*Math.PI/180,e.z*Math.PI/180),this.angle.x=e.x,this.angle.y=e.y,this.angle.z=e.z}else for(l=0;l<i.length;++l){var y,d=i[l],A=new THREE.Matrix4,g=new THREE.Matrix4,M=new THREE.Matrix4;d.isDrawGeom?(M.makeTranslation(-this.WorldPosition.x,-this.WorldPosition.y,-this.WorldPosition.z),g.premultiply(M),M.makeRotationFromQuaternion(m),g.premultiply(M),M.makeRotationFromQuaternion(f),g.premultiply(M),M.makeTranslation(this.WorldPosition.x,this.WorldPosition.y,this.WorldPosition.z),g.premultiply(M),d.applyMatrix(g),d.updateMatrixWorld()):(n.copy(d.worldMatrix),y=d.parent?d.parent.worldMatrix.clone():new THREE.Matrix4,M.makeTranslation(-this.WorldPosition.x,-this.WorldPosition.y,-this.WorldPosition.z),n.premultiply(M),g.premultiply(M),M.makeRotationFromQuaternion(m),n.premultiply(M),g.premultiply(M),M.makeRotationFromQuaternion(f),n.premultiply(M),g.premultiply(M),M.makeTranslation(this.WorldPosition.x,this.WorldPosition.y,this.WorldPosition.z),n.premultiply(M),g.premultiply(M),M.getInverse(y),A=n.premultiply(M),this.viewer.ndsModel.updateNodeMatrix(d.uuid,A.toArray(),d.getModel().id))}this.clipTransRotControl.totalquaternion.copy(f)}this.render()}},Oe.prototype.dispatchPositonandAngle=function(e){var t,r,i,n,a,o;function s(e){return e=Number(e),Math.abs(e)<1e-5}void 0===e&&(e=!1),this.clipTransRotControl&&(t=new THREE.Euler,r=new THREE.Euler,i=new THREE.Euler,n=new THREE.Vector3,this.clipTransRotControl.updateMatrixWorld(!0),this.clipTransRotControl.object.matrixWorld.decompose(this.DecomposePosition,this.DecomposeQuaternion,this.DecomposeScale),n.copy(this.DecomposePosition),(a=new THREE.Quaternion).multiplyQuaternions(this.clipTransRotControl.totalquaternion,this.DecomposeQuaternion),this.DecomposePosition.sub(this.clipTransRotControl.originalPosition),n.sub(this.clipTransRotControl.selectedPosition),(o=new THREE.Euler).setFromQuaternion(a),"rotate"==this.clipTransRotControl.pickType?this.piovtRotateDir?(this.angle.x=180*o.x/Math.PI,this.angle.y=180*o.y/Math.PI,this.angle.z=180*o.z/Math.PI):"X"==this.clipTransRotControl.axis?this.angle.x=180*o.x/Math.PI:"Y"==this.clipTransRotControl.axis?this.angle.y=180*o.y/Math.PI:"Z"==this.clipTransRotControl.axis&&(this.angle.z=180*o.z/Math.PI):"translate"==this.clipTransRotControl.pickType&&this.position.copy(this.DecomposePosition),e&&(this.angle.x=0,this.angle.y=0,this.angle.z=0,this.DecomposePosition.set(0,0,0),this.position.copy(this.DecomposePosition)),1==(a=this.viewer.selectionManager.getSelectedleafObjects(!0)).length&&a[0].originalPosition&&(o=new THREE.Box3,e=null,a[0].isDrawGeom?(e=a[0].geometry.boundingBox.clone()).applyMatrix4(a[0].matrix):e=this.viewer.ndsModel.getBodyBoundingBox(a[0]),e&&!e.isEmpty()&&(o.expandByPoint(e.max),o.expandByPoint(e.min)),this.emptyCenter.set(0,0,0),e=o.getCenter(this.emptyCenter),a[0].originalEuler,"rotate"==this.clipTransRotControl.pickType?(this.angle.x=180*a[0].originalEuler.x/Math.PI,this.angle.y=180*a[0].originalEuler.y/Math.PI,this.angle.z=180*a[0].originalEuler.z/Math.PI):"translate"==this.clipTransRotControl.pickType?this.position.copy(e):(this.position.copy(e),this.angle.x=180*a[0].originalEuler.x/Math.PI,this.angle.y=180*a[0].originalEuler.y/Math.PI,this.angle.z=180*a[0].originalEuler.z/Math.PI),r.setFromRotationMatrix(a[0].worldMatrix),t.setFromRotationMatrix(a[0].selectedMatrix),i.set(r.x-t.x,r.y-t.y,r.z-t.z)),this.piovtRotateDir&&(this.angle.x=180*this.rotateAngle/Math.PI,this.angle.y=0,this.angle.z=0,o=this.piovtRotateDir.angleTo(n),n.x=(o>Math.PI/4?-1:1)*n.length(),n.y=0,n.z=0),this.viewer.dispatchEvent({type:"OpBallModel",position:{x:s(this.position.x)?0:this.position.x,y:s(this.position.y)?0:this.position.y,z:s(this.position.z)?0:this.position.z},angle:{x:s(this.angle.x)?0:this.angle.x,y:s(this.angle.y)?0:this.angle.y,z:s(this.angle.z)?0:this.angle.z},deltaAngle:{x:1!=a.length||this.piovtRotateDir?this.angle.x:180*i.x/Math.PI,y:1!=a.length||this.piovtRotateDir?this.angle.y:180*i.y/Math.PI,z:1!=a.length||this.piovtRotateDir?this.angle.z:180*i.z/Math.PI},deltaPosition:{x:n.x,y:n.y,z:n.z},multiRotationAngle:this.clipTransRotControl.getMultiRotateAngle()}))},Oe.prototype.addDraggedObject=function(e){for(var t=0;t<this.viewer.draggedObjects.length;++t)if(e==this.viewer.draggedObjects[t])return;this.viewer.draggedObjects.push(e)},Oe.prototype.removeDraggedObject=function(e){if(null!=this.viewer.draggedObjects)for(var t=0;t<this.viewer.draggedObjects.length;++t)if(e==this.viewer.draggedObjects[t])return void this.viewer.draggedObjects.splice(t,1)},Oe.prototype.onLMouseMove=function(e){0<this.viewer.selectionManager.getSelectedleafObjects(!0).length&&this.clipTransRotControl&&"default"!=this.clipTransRotControl.pickType?this.onOpBall():a.prototype.onLMouseMove.call(this,e)},Oe.prototype.onTouchSingleStart=function(e){a.prototype.onTouchSingleStart.call(this,e)},Oe.prototype.onTouchSingleMove=function(e){0<(this.viewer.ndsModel?this.viewer.selectionManager.getSelectedleafObjects():this.viewer.selectionManager.getSelectedMeshes()).length&&this.clipTransRotControl&&"default"!=this.clipTransRotControl.pickType?this.onOpBall():a.prototype.onTouchSingleMove.call(this,e)},Oe.prototype.onTouchSingleEnd=function(e){this.state=-1,Math.abs(this.singleTouchEndPos.x-this.singleTouchStartPos.x)<1&&Math.abs(this.singleTouchEndPos.y-this.singleTouchStartPos.y)<1&&("move"!=this.opMode&&"default"!=this.opMode||(this.viewer.selectionManager.selectByClick(this.singleTouchEndPos.x,this.singleTouchEndPos.y),this.render()))},Oe.prototype.setModel=function(e){this._setModel=e,this.startMove(),this.clipTransRotControl&&this.clipTransRotControl.setMode("multiRotation"==this._setModel?"both":this._setModel)},Object.create(a.prototype).release=function(){this.update(),this.render(),a.prototype.release.call(this)},En.prototype=Object.create(THREE.Group.prototype),r(0)),Sn=r.n(e),Rn=(Ce.Element=function(e){this.type="Element",this.domElement=void 0!==(e=e||{}).element?document.createElement(e.element):document.createElement("div");var r=this.domElement,i=(void 0!==e.id&&(r.id=e.id),void 0!==e.name&&(r.name=e.name),void 0!==e.className&&(r.className=e.className),void 0!==e.callbackEvent&&this.addEventListener("event",e.callbackEvent),this.style={},this.subElements={},this.childElements=new Array,this.style),n=this;this.setSize=function(e,t){r.style.width=e+"px",r.style.height=t+"px",i.width=e,i.height=t},this.setWidth=function(e){r.style.width=e+"px",i.width=e},this.setHeight=function(e){r.style.height=e+"px",i.height=e},this.setPos=function(e,t){r.style.left=e+"px",r.style.top=t+"px",i.left=e,i.top=t},this.setLeft=function(e){r.style.left=e+"px",i.left=e},this.setTop=function(e){r.style.top=e+"px",i.top=e},this.setRight=function(e){r.style.right=e+"px",i.right=e},this.setBottom=function(e){r.style.bottom=e+"px",i.bottom=e},this.setBgColor=function(e){r.style.backgroundColor=e,i.opacity=e},this.setOpacity=function(e){r.style.opacity=e,i.opacity=e},this.deleteOpacity=function(){r.style.opacity="",delete i.opacity},this.setPosition=function(e){r.style.position=e,i.position=e},this.setBorder=function(e){r.style.border=e,i.border=e},this.setMargin=function(e){r.style.marginLeft=e.left+"px",r.style.marginRight=e.right+"px",r.style.marginTop=e.top+"px",r.style.marginBottom=e.bottom+"px",i.margin=e},this.setBorderRadius=function(e){r.style.borderRadius=e+"px",i.borderRadius=e},this.setPadding=function(e){r.style.paddingLeft=e.left+"px",r.style.paddingRight=e.right+"px",r.style.paddingTop=e.top+"px",r.style.paddingBottom=e.bottom+"px",i.padding=e},this.setListStyle=function(e){r.style.listStyle=e,i.listStyle=e},this.setTextAlign=function(e){r.style.textAlign=e,i.textAlign=e},this.setFloat=function(e){r.style.styleFloat=e,i.styleFloat=e,r.style.cssFloat=e,i.cssFloat=e},this.setCursor=function(e){r.style.cursor=e,i.cursor=e},this.setVisibility=function(e){r.style.visibility=e?"visible":"hidden",i.visibility=e},this.getVisibility=function(){return!(null==i.visibility||!i.visibility)},this.setDisplay=function(e){r.style.display=e?"":"none",i.display=e},this.setBgImage=function(e){r.style.backgroundImage=e,i.bgImage=e},this.setBgPosition=function(e){r.style.backgroundPosition=e,i.backgroundPosition=e},this.setBgRepeat=function(e){r.style.backgroundRepeat=e,i.backgroundRepeat=e},this.setText=function(e){r.innerHTML=e,i.text=e},this.setTitle=function(e){r.title=e,i.title=e},this.addEvent=function(e,t){r.addEventListener(e,n.onEvent,t)},this.removeEvent=function(e,t){r.removeEventListener(e,n.onEvent,t)},this.onEvent=function(e){n.dispatchEvent({type:"event",event:e})},this.addSubElement=function(e){r.appendChild(e.domElement)},this.addChildElement=function(e){n.childElements.push(new Pe.map(e.domElement.id,e))},this.getChildElement=function(e){for(var t=0;t<n.childElements.length;++t)if(n.childElements[t].key==e)return n.childElements[t].value},this.updateChildElement=function(e,t){for(var r=0;r<n.childElements.length;++r)n.childElements[r].key==e&&(n.childElements[r].key=t)},this.getChildElementIndex=function(e){for(var t=0;t<n.childElements.length;++t)if(n.childElements[t].key==e)return t;return-1},this.release=function(){r.parentElement.removeChild(r)},void 0!==e.img&&n.setBgImage(e.img),void 0!==e.text&&n.setText(e.text),void 0!==e.ttTitle&&n.setTitle(e.ttTitle)},Ce.Element.prototype=Object.create(THREE.EventDispatcher.prototype),1e-12),f={CW:1,CCW:-1,COLLINEAR:0},Cn=function(e,t){this.name="PointError",this.points=t=t||[],this.message=e||"Invalid Points!";for(var r=0;r<t.length;r++)this.message+=" "+Dn.toString(t[r])},Dn={};function Pn(e,t,r,i){t=(e.x-t.x)*(i.y-t.y)-(i.x-t.x)*(e.y-t.y);return!(-Rn<=t||(e.x-r.x)*(i.y-r.y)-(i.x-r.x)*(e.y-r.y)<=Rn)}function Hn(e,t){if(!e)throw new Error(t||"Assert Failed")}function m(e,t,r){e=(e.x-r.x)*(t.y-r.y)-(e.y-r.y)*(t.x-r.x);return-Rn<e&&e<Rn?f.COLLINEAR:0<e?f.CCW:f.CW}function _n(e,t,r){var i=t.x-e.x,t=t.y-e.y;return i*(r.x-e.x)+t*(r.y-e.y)<0}Dn.toString=function(e){var t=e.toString();return"[object Object]"===t?wn(e):t},Dn.toStringBase=wn,Dn.compare=function(e,t){return e.y===t.y?e.x-t.x:e.y-t.y},Dn.equals=function(e,t){return e.x===t.x&&e.y===t.y};function Ln(e,t){this.head_=e,this.tail_=t,this.search_node_=e}function d(e,t){this.x=+e||0,this.y=+t||0,this._p2t_edge_list=null}var On=function(e,t){this.point=e,this.triangle=t||null,this.next=null,this.prev=null,this.value=e.x},Fn=(Ln.prototype.head=function(){return this.head_},Ln.prototype.setHead=function(e){this.head_=e},Ln.prototype.tail=function(){return this.tail_},Ln.prototype.setTail=function(e){this.tail_=e},Ln.prototype.search=function(){return this.search_node_},Ln.prototype.setSearch=function(e){this.search_node_=e},Ln.prototype.findSearchNode=function(){return this.search_node_},Ln.prototype.locateNode=function(e){var t=this.search_node_;if(e<t.value){for(;t=t.prev;)if(e>=t.value)return this.search_node_=t}else for(;t=t.next;)if(e<t.value)return this.search_node_=t.prev,t.prev;return null},Ln.prototype.locatePoint=function(e){var t=e.x,r=this.findSearchNode(t),i=r.point.x;if(t===i){if(e!==r.point)if(e===r.prev.point)r=r.prev;else{if(e!==r.next.point)throw new Error("poly2tri Invalid AdvancingFront.locatePoint() call");r=r.next}}else if(t<i)for(;(r=r.prev)&&e!==r.point;);else for(;(r=r.next)&&e!==r.point;);return r&&(this.search_node_=r),r},d.prototype.toString=function(){return Dn.toStringBase(this)},d.prototype.toJSON=function(){return{x:this.x,y:this.y}},d.prototype.clone=function(){return new d(this.x,this.y)},d.prototype.set_zero=function(){return this.x=0,this.y=0,this},d.prototype.set=function(e,t){return this.x=+e||0,this.y=+t||0,this},d.prototype.negate=function(){return this.x=-this.x,this.y=-this.y,this},d.prototype.add=function(e){return this.x+=e.x,this.y+=e.y,this},d.prototype.sub=function(e){return this.x-=e.x,this.y-=e.y,this},d.prototype.mul=function(e){return this.x*=e,this.y*=e,this},d.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},d.prototype.normalize=function(){var e=this.length();return this.x/=e,this.y/=e,e},d.prototype.equals=function(e){return this.x===e.x&&this.y===e.y},d.negate=function(e){return new d(-e.x,-e.y)},d.add=function(e,t){return new d(e.x+t.x,e.y+t.y)},d.sub=function(e,t){return new d(e.x-t.x,e.y-t.y)},d.mul=function(e,t){return new d(e*t.x,e*t.y)},d.cross=function(e,t){return"number"==typeof e?"number"==typeof t?e*t:new d(-e*t.y,e*t.x):"number"==typeof t?new d(t*e.y,-t*e.x):e.x*t.y-e.y*t.x},d.toString=Dn.toString,d.compare=Dn.compare,d.cmp=Dn.compare,d.equals=Dn.equals,d.dot=function(e,t){return e.x*t.x+e.y*t.y},{triangulate:function(e){e.initTriangulation(),e.createAdvancingFront(),function(e){var t,r=e.pointCount();for(t=1;t<r;++t)for(var i=e.getPoint(t),n=function(e,t){var r=e.locateNode(t),i=function(e,t,r){var i=new s(t,r.point,r.next.point),t=(i.markNeighbor(r.triangle),e.addToMap(i),new On(t));t.next=r.next,(t.prev=r).next.prev=t,r.next=t,Gn(e,i)||e.mapTriangleToNodes(i);return t}(e,t,r);t.x<=r.point.x+Rn&&Vn(e,r);return function(e,t){var r=t.next;for(;r.next&&!_n(r.point,r.next.point,r.prev.point);)Vn(e,r),r=r.next;r=t.prev;for(;r.prev&&!_n(r.point,r.next.point,r.prev.point);)Vn(e,r),r=r.prev;t.next&&t.next.next&&(!function(e){var t=e.point.x-e.next.next.point.x,e=e.point.y-e.next.next.point.y;return Hn(0<=e,"unordered y"),0<=t||Math.abs(t)<e}(t)||!function(e,t){m(t.point,t.next.point,t.next.next.point)===f.CCW?e.basin.left_node=t.next.next:e.basin.left_node=t.next;e.basin.bottom_node=e.basin.left_node;for(;e.basin.bottom_node.next&&e.basin.bottom_node.point.y>=e.basin.bottom_node.next.point.y;)e.basin.bottom_node=e.basin.bottom_node.next;if(e.basin.bottom_node!==e.basin.left_node){for(e.basin.right_node=e.basin.bottom_node;e.basin.right_node.next&&e.basin.right_node.point.y<e.basin.right_node.next.point.y;)e.basin.right_node=e.basin.right_node.next;e.basin.right_node!==e.basin.bottom_node&&(e.basin.width=e.basin.right_node.point.x-e.basin.left_node.point.x,e.basin.left_highest=e.basin.left_node.point.y>e.basin.right_node.point.y,function e(t,r){if(jn(t,r))return;Vn(t,r);{if(r.prev===t.basin.left_node&&r.next===t.basin.right_node)return;if(r.prev===t.basin.left_node){if(m(r.point,r.next.point,r.next.next.point)===f.CW)return;r=r.next}else if(r.next===t.basin.right_node){if(m(r.point,r.prev.point,r.prev.prev.point)===f.CCW)return;r=r.prev}else r=r.prev.point.y<r.next.point.y?r.prev:r.next}e(t,r)}(e,e.basin.bottom_node))}}(e,t))}(e,i),i}(e,i),a=i._p2t_edge_list,o=0;a&&o<a.length;++o)!function(e,t,r){if(e.edge_event.constrained_edge=t,e.edge_event.right=t.p.x>t.q.x,!Nn(r.triangle,t.p,t.q)){!function(e,t,r){(e.edge_event.right?function(e,t,r){for(;r.next.point.x<t.p.x;)m(t.q,r.next.point,t.p)===f.CCW?function e(t,r,i){i.point.x<r.p.x&&(m(i.point,i.next.point,i.next.next.point)===f.CCW?zn:(Wn(t,r,i),e))(t,r,i)}(e,t,r):r=r.next}:function(e,t,r){for(;r.prev.point.x>t.p.x;)m(t.q,r.prev.point,t.p)===f.CW?function e(t,r,i){i.point.x>r.p.x&&(m(i.point,i.prev.point,i.prev.prev.point)===f.CW?qn:(Xn(t,r,i),e))(t,r,i)}(e,t,r):r=r.prev})(e,t,r)}(e,t,r);try{Un(e,t.p,t.q,r.triangle,t.q)}catch(e){}}}(e,a[o],n)}(e),function(e){var t=e.front().head().next.triangle,r=e.front().head().next.point;for(;!t.getConstrainedEdgeCW(r);)t=t.neighborCCW(r);e.meshClean(t)}(e)}});function Un(e,t,r,i,n){if(!Nn(i,t,r)){var a=i.pointCCW(n),o=m(r,a,t);if(o===f.COLLINEAR)throw new Cn("poly2tri EdgeEvent: Collinear not supported!",[r,a,t]);var a=i.pointCW(n),s=m(r,a,t);if(s===f.COLLINEAR)throw new Cn("poly2tri EdgeEvent: Collinear not supported!",[r,a,t]);o===s?Un(e,t,r,i=o===f.CW?i.neighborCCW(n):i.neighborCW(n),n):Yn(e,t,r,i,n)}}function Nn(e,t,r){var i=e.edgeIndex(t,r);if(-1!==i)return e.markConstrainedEdgeByIndex(i),(e=e.getNeighbor(i))&&e.markConstrainedEdgeByPoints(t,r),1}function Vn(e,t){var r=new s(t.prev.point,t.point,t.next.point);r.markNeighbor(t.prev.triangle),r.markNeighbor(t.triangle),e.addToMap(r),t.prev.next=t.next,t.next.prev=t.prev,Gn(e,r)||e.mapTriangleToNodes(r)}function Gn(e,t){for(var r=0;r<3;++r)if(!t.delaunay_edge[r]){var i=t.getNeighbor(r);if(i){var n=t.getPoint(r),a=i.oppositePoint(t,n),o=i.index(a);if(i.constrained_edge[o]||i.delaunay_edge[o])t.constrained_edge[r]=i.constrained_edge[o];else if(function(e,t,r,i){var n=e.x-i.x,e=e.y-i.y,a=t.x-i.x,t=t.y-i.y,o=n*t-a*e;if(o<=0)return!1;var s=r.x-i.x,r=r.y-i.y,i=s*e-n*r;if(i<=0)return!1;return 0<(n*n+e*e)*(a*r-s*t)+(a*a+t*t)*i+(s*s+r*r)*o}(n,t.pointCCW(n),t.pointCW(n),a))return t.delaunay_edge[r]=!0,i.delaunay_edge[o]=!0,kn(t,n,i,a),!Gn(e,t)&&e.mapTriangleToNodes(t),!Gn(e,i)&&e.mapTriangleToNodes(i),t.delaunay_edge[r]=!1,i.delaunay_edge[o]=!1,1}}}function kn(e,t,r,i){var n=e.neighborCCW(t),a=e.neighborCW(t),o=r.neighborCCW(i),s=r.neighborCW(i),l=e.getConstrainedEdgeCCW(t),d=e.getConstrainedEdgeCW(t),c=r.getConstrainedEdgeCCW(i),h=r.getConstrainedEdgeCW(i),u=e.getDelaunayEdgeCCW(t),p=e.getDelaunayEdgeCW(t),f=r.getDelaunayEdgeCCW(i),m=r.getDelaunayEdgeCW(i);e.legalize(t,i),r.legalize(i,t),r.setDelaunayEdgeCCW(t,u),e.setDelaunayEdgeCW(t,p),e.setDelaunayEdgeCCW(i,f),r.setDelaunayEdgeCW(i,m),r.setConstrainedEdgeCCW(t,l),e.setConstrainedEdgeCW(t,d),e.setConstrainedEdgeCCW(i,c),r.setConstrainedEdgeCW(i,h),e.clearNeighbors(),r.clearNeighbors(),n&&r.markNeighbor(n),a&&e.markNeighbor(a),o&&e.markNeighbor(o),s&&r.markNeighbor(s),e.markNeighbor(r)}function jn(e,t){t=e.basin.left_highest?e.basin.left_node.point.y-t.point.y:e.basin.right_node.point.y-t.point.y;return e.basin.width>t}function zn(e,t,r){Vn(e,r.next),r.next.point!==t.p&&m(t.q,r.next.point,t.p)===f.CCW&&m(r.point,r.next.point,r.next.next.point)===f.CCW&&zn(e,t,r)}function Wn(e,t,r){m(r.next.point,r.next.next.point,r.next.next.next.point)===f.CCW?zn(e,t,r.next):m(t.q,r.next.next.point,t.p)===f.CCW&&Wn(e,t,r.next)}function Xn(e,t,r){m(r.prev.point,r.prev.prev.point,r.prev.prev.prev.point)===f.CW?qn(e,t,r.prev):m(t.q,r.prev.prev.point,t.p)===f.CW&&Xn(e,t,r.prev)}function qn(e,t,r){Vn(e,r.prev),r.prev.point!==t.p&&m(t.q,r.prev.point,t.p)===f.CW&&m(r.point,r.prev.point,r.prev.prev.point)===f.CW&&qn(e,t,r)}function Yn(e,t,r,i,n){var a,o,s,l,d,c,h,u=i.neighborAcross(n),p=(Hn(u,"FLIP failed due to missing triangle!"),u.oppositePoint(i,n));if(i.getConstrainedEdgeAcross(n))throw a=i.index(n),new Cn("poly2tri Intersecting Constraints",[n,p,i.getPoint((a+1)%3),i.getPoint((a+2)%3)]);Pn(n,i.pointCCW(n),i.pointCW(n),p)?(kn(i,n,u,p),e.mapTriangleToNodes(i),e.mapTriangleToNodes(u),n===r&&p===t?r===e.edge_event.constrained_edge.q&&t===e.edge_event.constrained_edge.p&&(i.markConstrainedEdgeByPoints(t,r),u.markConstrainedEdgeByPoints(t,r),Gn(e,i),Gn(e,u)):(a=m(r,p,t),s=i,l=u,d=n,c=p,Yn(o=e,t,r,i=a!==f.CCW?(h=s.edgeIndex(d,c),s.delaunay_edge[h]=!0,Gn(o,s),s.clearDelaunayEdges(),l):(h=l.edgeIndex(d,c),l.delaunay_edge[h]=!0,Gn(o,l),l.clearDelaunayEdges(),s),n))):(function e(t,r,i,n,a,o){var s=a.neighborAcross(o);Hn(s,"FLIP failed due to missing triangle");a=s.oppositePoint(a,o);Pn(i,n.pointCCW(i),n.pointCW(i),a)?Yn(t,i,a,s,a):(o=Qn(r,i,s,a),e(t,r,i,n,s,o))}(e,t,r,i,u,Qn(t,r,u,p)),Un(e,t,r,i,n))}function Qn(e,t,r,i){var n=m(t,i,e);if(n===f.CW)return r.pointCCW(i);if(n===f.CCW)return r.pointCW(i);throw new Cn("poly2tri [Unsupported] nextFlipPoint: opposing point on constrained edge!",[t,i,e])}function Kn(e,t){if(this.p=e,this.q=t,e.y>t.y)this.q=e,this.p=t;else if(e.y===t.y)if(e.x>t.x)this.q=e,this.p=t;else if(e.x===t.x)throw new Cn("poly2tri Invalid Edge constructor: repeated points!",[e]);this.q._p2t_edge_list||(this.q._p2t_edge_list=[]),this.q._p2t_edge_list.push(this)}function Zn(){this.left_node=null,this.bottom_node=null,this.right_node=null,this.width=0,this.left_highest=!1}function Jn(){this.constrained_edge=null,this.right=!1}function p(e,t){t=t||{},this.triangles_=[],this.map_=[],this.points_=t.cloneArrays?e.slice(0):e,this.edge_list=[],this.pmin_=this.pmax_=null,this.front_=null,this.head_=null,this.tail_=null,this.af_head_=null,this.af_middle_=null,this.af_tail_=null,this.basin=new Zn,this.edge_event=new Jn,this.initEdges(this.points_)}function $n(e,t,r){var n,i,a,o,s,l,d,c,h,u,p,f=e,m=t,g=!1,v=new THREE.Color,y=this,A={texSize:64,pixScale:1,blurRadius:7,debug:!1};function M(e){return new THREE.ShaderMaterial({uniforms:THREE.UniformsUtils.clone(e.uniforms),vertexShader:e.vertexShader,fragmentShader:e.fragmentShader,defines:THREE.UniformsUtils.clone(e.defines)})}if(this.setTransform=function(e,t,r,i){n.left=-t.z/2,n.right=t.z/2,n.top=t.x/2,n.bottom=-t.x/2,n.near=1,n.far=t.y+n.near,n.updateProjectionMatrix(),n.position.addVectors(e,r.clone().multiplyScalar(-t.y/2-n.near)),i&&n.up.set(i.x,i.y,i.z),n.lookAt(e),a.position.set(e.x,e.y,e.z),a.rotation.set(n.rotation.x,n.rotation.y,n.rotation.z),a.scale.set(t.z,t.x,t.y),A.debug&&(p.position.set(e.x,e.y,e.z),p.rotation.set(n.rotation.x,n.rotation.y,n.rotation.z),p.scale.set(t.z,t.x,t.y)),u.uniforms.worldSize.value.copy(t)},this.renderIntoShadow=function(e){var t,r;!this.enabled||e.overrideMaterial&&e.overrideMaterial.transparent||(t=e.overrideMaterial,(r=e.getObjectByName("GridHelper"))&&(e.gridvisible=r.visible,r.visible=!1),f.ndsModel&&(f.ndsModel.backupDirty(),f.ndsModel.setDirty(),f.ndsModel.setDrawMode(f.ndsModel.SHADED),f.scene.children.push(f.ndsModel)),m.render(e,n,o,!1),e.overrideMaterial=t,f.ndsModel&&f.ndsModel.resetDirty(),r&&(r.visible=e.gridvisible))},this.renderShadow=function(e,t){this.enabled&&g&&(t?m.render(i,e,t,!1):m.render(i,e))},this.postprocess=function(){this.enabled&&(h.render(m,s,o),c.render(m,o,s),g=!0)},this.clear=function(){var e,t,r;this.enabled&&(e=m.getClearColor(v),t=m.getClearAlpha(),r=m.getRenderTarget(),m.setClearColor(16777215,0),m.setRenderTarget(o),m.clear(!0,!0,!1),m.setClearColor(e,t),g=!1,m.setRenderTarget(r))},this.getRenderTarget=function(){return o},this.setColor=function(e){d.uniforms.uShadowColor.value.x=e.r,d.uniforms.uShadowColor.value.y=e.g,d.uniforms.uShadowColor.value.z=e.b},this.getColor=function(){return new THREE.Color(d.uniforms.uShadowColor.value.x,d.uniforms.uShadowColor.value.y,d.uniforms.uShadowColor.value.z)},this.setAlpha=function(e){d.uniforms.uShadowColor.value.w=e},this.getAlpha=function(){return d.uniforms.uShadowColor.value.w},this.isValid=function(){return g},this.getDepthMaterial=function(){return l},this.updateGroundTransform=function(e,t,r){var i,n,a;y.enabled&&t&&(y.needClear=!0,t=t.clone(),i=new THREE.Vector3(1,0,0),n=t.getCenter(new THREE.Vector3),a=t.getSize(new THREE.Vector3),e.worldUpTransform&&(i.applyMatrix4(e.worldUpTransform),t.applyMatrix4(e.worldUpTransform),a=t.size()),t=a.x>a.z?a.x/a.z:a.z/a.x,a.multiply(new THREE.Vector3(1.25,1.01,1.25)),a.x=a.z=Math.max(a.x,a.z),r?y.setTransform(n,a,r,i):y.setTransform(n,a,e.up,i),--t<5&&(t/=500),0<(t=2/Math.PI*Math.atan(t)))&&(d.defines.DARKNESS_SCALE=1.00001+t)},r)for(var E in A)A[E]=r[E]||A[E];i=new THREE.Scene,n=new THREE.OrthographicCamera,(o=new THREE.WebGLRenderTarget(A.texSize,A.texSize,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat,stencilBuffer:!1})).texture.generateMipmaps=!1,(s=new THREE.WebGLRenderTarget(A.texSize,A.texSize,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat,stencilBuffer:!1})).texture.generateMipmaps=!1,(l=M(na)).defines.NUM_CUTPLANES=0,l.side=THREE.DoubleSide,l.blending=THREE.NoBlending,(new l.constructor).copy(l),c=new Ur(oa,"tDepth"),h=new Ur(oa,"tDepth"),u=new Ur(aa,"tDepth"),c.material.defines.KERNEL_SCALE=h.material.defines.KERNEL_SCALE=(A.pixScale/A.texSize).toFixed(4),c.material.defines.KERNEL_RADIUS=h.material.defines.KERNEL_RADIUS=A.blurRadius.toFixed(2),u.material.blending=c.material.blending=h.material.blending=THREE.NoBlending,u.material.depthWrite=c.material.depthWrite=h.material.depthWrite=!1,u.material.depthTest=c.material.depthTest=h.material.depthTest=!1,c.material.defines.HORIZONTAL=1,(d=M(sa)).uniforms.tDepth.value=o.texture,d.depthWrite=!1,d.transparent=!0,d.defines.NUM_CUTPLANES=0,(e=new THREE.BufferGeometry).addAttribute("position",new THREE.BufferAttribute(new Float32Array([-.5,-.5,.5,-.5,.5,.5,.5,.5,.5,.5,-.5,.5]),3)),e.addAttribute("uv",new THREE.BufferAttribute(new Float32Array([0,0,0,1,1,1,1,0]),2)),e.setIndex(new THREE.BufferAttribute(new Uint16Array([0,1,2,2,3,0]),1)),a=new THREE.Mesh(e,d),i.add(a),A.debug&&(p=new THREE.Mesh(new THREE.BoxGeometry(1,1,1),new THREE.MeshBasicMaterial({color:65280,wireframe:!0})),i.add(p)),this.setTransform(new THREE.Vector3(0,0,0),new THREE.Vector3(1,1,1),new THREE.Vector3(0,1,0))}function ea(e,t,r){this.manager=void 0!==e?e:THREE.DefaultLoadingManager,this.viewer=r,this.SDFMaker=t,r.SDFMaker=this.SDFMaker}function ta(){}var s=function(e,t,r){this.points_=[e,t,r],this.neighbors_=[null,null,null],this.interior_=!1,this.constrained_edge=[!1,!1,!1],this.delaunay_edge=[!1,!1,!1]},ra=Dn.toString,ia=(s.prototype.toString=function(){return"["+ra(this.points_[0])+ra(this.points_[1])+ra(this.points_[2])+"]"},s.prototype.getPoint=function(e){return this.points_[e]},s.prototype.GetPoint=s.prototype.getPoint,s.prototype.getPoints=function(){return this.points_},s.prototype.getNeighbor=function(e){return this.neighbors_[e]},s.prototype.containsPoint=function(e){var t=this.points_;return e===t[0]||e===t[1]||e===t[2]},s.prototype.containsEdge=function(e){return this.containsPoint(e.p)&&this.containsPoint(e.q)},s.prototype.containsPoints=function(e,t){return this.containsPoint(e)&&this.containsPoint(t)},s.prototype.isInterior=function(){return this.interior_},s.prototype.setInterior=function(e){return this.interior_=e,this},s.prototype.markNeighborPointers=function(e,t,r){var i=this.points_;if(e===i[2]&&t===i[1]||e===i[1]&&t===i[2])this.neighbors_[0]=r;else if(e===i[0]&&t===i[2]||e===i[2]&&t===i[0])this.neighbors_[1]=r;else{if(!(e===i[0]&&t===i[1]||e===i[1]&&t===i[0]))throw new Error("poly2tri Invalid Triangle.markNeighborPointers() call");this.neighbors_[2]=r}},s.prototype.markNeighbor=function(e){var t=this.points_;e.containsPoints(t[1],t[2])?(this.neighbors_[0]=e).markNeighborPointers(t[1],t[2],this):e.containsPoints(t[0],t[2])?(this.neighbors_[1]=e).markNeighborPointers(t[0],t[2],this):e.containsPoints(t[0],t[1])&&(this.neighbors_[2]=e).markNeighborPointers(t[0],t[1],this)},s.prototype.clearNeighbors=function(){this.neighbors_[0]=null,this.neighbors_[1]=null,this.neighbors_[2]=null},s.prototype.clearDelaunayEdges=function(){this.delaunay_edge[0]=!1,this.delaunay_edge[1]=!1,this.delaunay_edge[2]=!1},s.prototype.pointCW=function(e){var t=this.points_;return e===t[0]?t[2]:e===t[1]?t[0]:e===t[2]?t[1]:null},s.prototype.pointCCW=function(e){var t=this.points_;return e===t[0]?t[1]:e===t[1]?t[2]:e===t[2]?t[0]:null},s.prototype.neighborCW=function(e){return e===this.points_[0]?this.neighbors_[1]:e===this.points_[1]?this.neighbors_[2]:this.neighbors_[0]},s.prototype.neighborCCW=function(e){return e===this.points_[0]?this.neighbors_[2]:e===this.points_[1]?this.neighbors_[0]:this.neighbors_[1]},s.prototype.getConstrainedEdgeCW=function(e){return e===this.points_[0]?this.constrained_edge[1]:e===this.points_[1]?this.constrained_edge[2]:this.constrained_edge[0]},s.prototype.getConstrainedEdgeCCW=function(e){return e===this.points_[0]?this.constrained_edge[2]:e===this.points_[1]?this.constrained_edge[0]:this.constrained_edge[1]},s.prototype.getConstrainedEdgeAcross=function(e){return e===this.points_[0]?this.constrained_edge[0]:e===this.points_[1]?this.constrained_edge[1]:this.constrained_edge[2]},s.prototype.setConstrainedEdgeCW=function(e,t){e===this.points_[0]?this.constrained_edge[1]=t:e===this.points_[1]?this.constrained_edge[2]=t:this.constrained_edge[0]=t},s.prototype.setConstrainedEdgeCCW=function(e,t){e===this.points_[0]?this.constrained_edge[2]=t:e===this.points_[1]?this.constrained_edge[0]=t:this.constrained_edge[1]=t},s.prototype.getDelaunayEdgeCW=function(e){return e===this.points_[0]?this.delaunay_edge[1]:e===this.points_[1]?this.delaunay_edge[2]:this.delaunay_edge[0]},s.prototype.getDelaunayEdgeCCW=function(e){return e===this.points_[0]?this.delaunay_edge[2]:e===this.points_[1]?this.delaunay_edge[0]:this.delaunay_edge[1]},s.prototype.setDelaunayEdgeCW=function(e,t){e===this.points_[0]?this.delaunay_edge[1]=t:e===this.points_[1]?this.delaunay_edge[2]=t:this.delaunay_edge[0]=t},s.prototype.setDelaunayEdgeCCW=function(e,t){e===this.points_[0]?this.delaunay_edge[2]=t:e===this.points_[1]?this.delaunay_edge[0]=t:this.delaunay_edge[1]=t},s.prototype.neighborAcross=function(e){return e===this.points_[0]?this.neighbors_[0]:e===this.points_[1]?this.neighbors_[1]:this.neighbors_[2]},s.prototype.oppositePoint=function(e,t){e=e.pointCW(t);return this.pointCW(e)},s.prototype.legalize=function(e,t){var r=this.points_;if(e===r[0])r[1]=r[0],r[0]=r[2],r[2]=t;else if(e===r[1])r[2]=r[1],r[1]=r[0],r[0]=t;else{if(e!==r[2])throw new Error("poly2tri Invalid Triangle.legalize() call");r[0]=r[2],r[2]=r[1],r[1]=t}},s.prototype.index=function(e){var t=this.points_;if(e===t[0])return 0;if(e===t[1])return 1;if(e===t[2])return 2;throw new Error("poly2tri Invalid Triangle.index() call")},s.prototype.edgeIndex=function(e,t){var r=this.points_;if(e===r[0]){if(t===r[1])return 2;if(t===r[2])return 1}else if(e===r[1]){if(t===r[2])return 0;if(t===r[0])return 2}else if(e===r[2]){if(t===r[0])return 1;if(t===r[1])return 0}return-1},s.prototype.markConstrainedEdgeByIndex=function(e){this.constrained_edge[e]=!0},s.prototype.markConstrainedEdgeByEdge=function(e){this.markConstrainedEdgeByPoints(e.p,e.q)},s.prototype.markConstrainedEdgeByPoints=function(e,t){var r=this.points_;t===r[0]&&e===r[1]||t===r[1]&&e===r[0]?this.constrained_edge[2]=!0:t===r[0]&&e===r[2]||t===r[2]&&e===r[0]?this.constrained_edge[1]=!0:(t===r[1]&&e===r[2]||t===r[2]&&e===r[1])&&(this.constrained_edge[0]=!0)},Zn.prototype.clear=function(){this.left_node=null,this.bottom_node=null,this.right_node=null,this.width=0,this.left_highest=!1},p.prototype.AddHole=p.prototype.addHole=function(e){this.initEdges(e);for(var t=e.length,r=0;r<t;r++)this.points_.push(e[r]);return this},p.prototype.addHoles=function(e){for(var t=e.length,r=0;r<t;r++)this.initEdges(e[r]);return this.points_=this.points_.concat.apply(this.points_,e),this},p.prototype.AddPoint=p.prototype.addPoint=function(e){return this.points_.push(e),this},p.prototype.addPoints=function(e){return this.points_=this.points_.concat(e),this},p.prototype.triangulate=function(){return Fn.triangulate(this),this},p.prototype.getBoundingBox=function(){return{min:this.pmin_,max:this.pmax_}},p.prototype.GetTriangles=p.prototype.getTriangles=function(){return this.triangles_},p.prototype.front=function(){return this.front_},p.prototype.pointCount=function(){return this.points_.length},p.prototype.head=function(){return this.head_},p.prototype.setHead=function(e){this.head_=e},p.prototype.tail=function(){return this.tail_},p.prototype.setTail=function(e){this.tail_=e},p.prototype.getMap=function(){return this.map_},p.prototype.initTriangulation=function(){for(var e=this.points_[0].x,t=this.points_[0].x,r=this.points_[0].y,i=this.points_[0].y,n=this.points_.length,a=1;a<n;a++){var o=this.points_[a];o.x>e&&(e=o.x),o.x<t&&(t=o.x),o.y>r&&(r=o.y),o.y<i&&(i=o.y)}this.pmin_=new d(t,i),this.pmax_=new d(e,r);var s=.3*(e-t),l=.3*(r-i);this.head_=new d(e+s,i-l),this.tail_=new d(t-s,i-l),this.points_.sort(d.compare)},p.prototype.initEdges=function(e,t){for(var r=e.length,i=t?e.length-1:e.length,n=0;n<i;++n)this.edge_list.push(new Kn(e[n],e[(n+1)%r]))},p.prototype.getPoint=function(e){return this.points_[e]},p.prototype.addToMap=function(e){this.map_.push(e)},p.prototype.locateNode=function(e){return this.front_.locateNode(e.x)},p.prototype.createAdvancingFront=function(){var e,t,r=new s(this.points_[0],this.tail_,this.head_);this.map_.push(r),e=new On(r.getPoint(1),r),t=new On(r.getPoint(0),r),r=new On(r.getPoint(2)),this.front_=new Ln(e,r),(e.next=t).next=r,t.prev=e,r.prev=t},p.prototype.removeNode=function(e){},p.prototype.mapTriangleToNodes=function(e){for(var t,r=0;r<3;++r)e.getNeighbor(r)||(t=this.front_.locatePoint(e.pointCW(e.getPoint(r))))&&(t.triangle=e)},p.prototype.removeFromMap=function(e){for(var t=this.map_,r=t.length,i=0;i<r;i++)if(t[i]===e){t.splice(i,1);break}},p.prototype.meshClean=function(e){for(var t,r,i=[e];t=i.pop();)if(!t.isInterior())for(t.setInterior(!0),this.triangles_.push(t),r=0;r<3;r++)t.constrained_edge[r]||i.push(t.getNeighbor(r))},Ce.Triangulator=new function(){function s(e,t,r){return r+":"+(e<t?e+":"+t:t+":"+e)}function h(){this.bbox=new THREE.Box2,this.left=null,this.right=null,this.node_edges=[]}function u(e,t,r){this.pts=e,this.edges=t,this.bbox=r,this.pipResult=!1}u.prototype.splitNode=function(e){if(!(e.bbox.min.y>=e.bbox.max.y||e.node_edges.length<3)){for(var t=.5*(e.bbox.min.y+e.bbox.max.y),r=(e.left=new h,e.right=new h,this.pts),i=e.node_edges,n=[],a=new THREE.Vector2,o=0;o<i.length;o++){var s=this.edges[i[o]],l=r[s.p1].y,d=r[s.p2].y,c=(d<l&&(c=l,l=d,d=c),null);d<t?(e.left.node_edges.push(i[o]),c=e.left.bbox):t<l?(e.right.node_edges.push(i[o]),c=e.right.bbox):n.push(i[o]),c&&(a.set(r[s.p1].x,r[s.p1].y),c.expandByPoint(a),a.set(r[s.p2].x,r[s.p2].y),c.expandByPoint(a))}e.node_edges=n,e.left.node_edges.length&&this.splitNode(e.left),e.right.node_edges.length&&this.splitNode(e.right)}},u.prototype.build=function(){this.root=new h;for(var e=this.root.node_edges,t=0;t<this.edges.length;t++)e.push(t);this.root.bbox.copy(this.bbox),this.splitNode(this.root)},u.prototype.pointInPolygonRec=function(e,t,r){if(e.bbox.min.y<=r&&e.bbox.max.y>=r)for(var i=this.pts,n=e.node_edges,a=0,o=n.length;a<o;a++){var s=this.edges[n[a]],l=i[s.p1],d=l.x,l=l.y,s=i[s.p2],c=s.x,s=s.y,h=r<=s;r<=l!=h&&(c-t)*(l-s)<=(s-r)*(d-c)==h&&(this.pipResult=!this.pipResult)}var u=e.left,u=(u&&u.bbox.min.y<=r&&u.bbox.max.y>=r&&this.pointInPolygonRec(u,t,r),e.right);u&&u.bbox.min.y<=r&&u.bbox.max.y>=r&&this.pointInPolygonRec(u,t,r)},u.prototype.pointInPolygon=function(e,t){return this.pipResult=!1,this.pointInPolygonRec(this.root,e,t),this.pipResult};var r=new THREE.Vector3;function e(e,t){this.edges=e,this.bbox=t,this.pts=[],this.idmap={},this.xymap={},this.contours=[],this.scale=1e6/this.bbox.getSize(r).length()}function t(e){this.indices=[],this.cset=e;var t=this.pts=e.pts;this.intervalTree=new u(e.pts,e.edges,e.bbox),this.intervalTree.build();for(var r=0;r<t.length;r++)t[r].id=r;var i=new p([]);if(i.points_=t.slice(),e.contours)for(var n=this.cset.contours,a=0;a<n.length;a++){var o=n[a],s=o[0]!==o[o.length-1];if(!s){for(var l=[],d=0;d<o.length-1;d++)l.push(t[o[d]]);i.initEdges(l,s)}}else for(var c=this.cset.edges,r=0;r<c.length;r++){var h=c[r];h.p1!=h.p2&&(h=[t[h.p1],t[h.p2]],i.initEdges(h,!0))}0<i.edge_list.length&&(this.triangulate(i),this.processResult(i))}e.prototype.getPointIndex=function(e,t,r){var i,n,a=this.idmap[r];return void 0!==a||(a=0|e*this.scale,i=0|t*this.scale,void 0===(a=void 0===(n=this.xymap[a])?void(this.xymap[a]=n={}):n[i])&&(n[i]=a=this.pts.length,this.idmap[r]=a,this.pts.push({x:e,y:t}))),a},e.prototype.snapEdges=function(){for(var e=0;e<this.edges.length;e++){var t=this.edges[e];t.p1=this.getPointIndex(t.pt1.x,t.pt1.y,t.eid1),t.p2=this.getPointIndex(t.pt2.x,t.pt2.y,t.eid2)}},e.prototype.sanitizeEdges=function(){for(var e={},t=[],r=0,i=this.edges.length;r<i;r++){var n,a=this.edges[r];a.p1!==a.p2&&!0!==e[n=Math.min(a.p1,a.p2)+":"+Math.max(a.p1,a.p2)]&&(e[n]=!0,t.push(a))}this.edges=t},e.prototype.stitchContours=function(){for(var e={},t=0;t<this.edges.length;t++){var r=this.edges[t];r.p1!==r.p2&&(void 0!==e[r.p1]?e[r.p1].push(r.p2):e[r.p1]=[r.p2],void 0!==e[r.p2]?e[r.p2].push(r.p1):e[r.p2]=[r.p1])}var i=[];for(a in e)if(2!==e[a].length)break;for(;;){var n=void 0;for(a in e)if(1<e[a].length){n=a;break}if(!n)for(var a in e)if(0<e[a].length){n=a;break}if(!n)break;var o=-1,s=parseInt(n),l=e[n];for(i.push(s);l&&l.length;){var d=l.shift();if(void 0===(d=d===o?l.shift():d)){delete e[s];break}i.push(d),(0==l.length||l[0]===o)&&delete e[s],o=s,l=e[s=d]}i.length&&(this.contours.push(i),i=[])}for(var c=[],t=0;t<this.contours.length;t++)(f=this.contours[t])[0]!==f[f.length-1]&&c.push(f);if(c.length)for(var h=!0;h;){for(var h=!1,u={},p=this.contours,t=0;t<p.length;t++){var f,m=(f=p[t])[0],g=f[f.length-1];m!==g&&(u[m]?u[m].push(-t-1):u[m]=[-t-1],u[g]?u[g].push(t):u[g]=[t])}for(a in u){var v=u[a];if(2==v.length){var y,A,M=void 0;v[0]<0&&v[1]<0&&(y=-v[0]-1,p[A=-v[1]-1].shift(),Array.prototype.push.apply(p[y].reverse(),p[A]),M=A),v[0]<0&&0<v[1]&&(y=-v[0]-1,p[A=v[1]].pop(),Array.prototype.push.apply(p[A],p[y]),M=y),0<v[0]&&v[1]<0&&(y=v[0],A=-v[1]-1,p[y].pop(),Array.prototype.push.apply(p[y],p[A]),M=A),0<v[0]&&0<v[1]&&(y=v[0],A=v[1],p[y].pop(),Array.prototype.push.apply(p[y],p[A].reverse()),M=A),void 0!==M&&(p.splice(M,1),h=!0);break}}}},e.prototype.stitchContoursCheng=function(){for(var e={},t=0;t<this.edges.length;t++){var r=this.edges[t];r.p1!==r.p2&&(void 0!==e[r.p1]?e[r.p1].push(r.p2):e[r.p1]=[r.p2],void 0!==e[r.p2]?e[r.p2].push(r.p1):e[r.p2]=[r.p1])}for(var i=[];;){for(var n in e)if(1==e[n].length)for(var a in delete e[n],e){var o=parseInt(n),s=e[a].indexOf(o);-1!=s&&e[a].splice(s,1)}var l=!1;for(n in e)if(1==e[n].length){l=!0;break}if(!l)break}for(;;){var d=void 0;for(n in e)if(1<e[n].length){d=n;break}if(!d)for(var n in e)if(0<e[n].length){d=n;break}if(!d)break;var c=-1,o=parseInt(d),h=e[d];for(i.push(o);h&&h.length;){var u=h.shift();if(void 0===(u=u===c?h.shift():u)){delete e[o];break}i.push(u);for(l=!1,t=0;t<i.length-1;++t)if(u==i[t]){i=i.slice(t),l=!0;break}if(l)break;(0==h.length||h[0]===c)&&delete e[o],c=o,h=e[o=u]}i.length&&(this.contours.push(i),i=[])}for(var p=[],t=0;t<this.contours.length;t++)(v=this.contours[t])[0]!==v[v.length-1]&&p.push(v);if(p.length)for(var f=!0;f;){for(var f=!1,m={},g=this.contours,t=0;t<g.length;t++){var v,y=(v=g[t])[0],A=v[v.length-1];y!==A&&(m[y]?m[y].push(-t-1):m[y]=[-t-1],m[A]?m[A].push(t):m[A]=[t])}for(n in m){var M=m[n];if(2==M.length){var E,w,x=void 0;M[0]<0&&M[1]<0&&(E=-M[0]-1,g[w=-M[1]-1].shift(),Array.prototype.push.apply(g[E].reverse(),g[w]),x=w),M[0]<0&&0<M[1]&&(E=-M[0]-1,g[w=M[1]].pop(),Array.prototype.push.apply(g[w],g[E]),x=E),0<M[0]&&M[1]<0&&(E=M[0],w=-M[1]-1,g[E].pop(),Array.prototype.push.apply(g[E],g[w]),x=w),0<M[0]&&0<M[1]&&(E=M[0],w=M[1],g[E].pop(),Array.prototype.push.apply(g[E],g[w].reverse()),x=w),void 0!==x&&(g.splice(x,1),f=!0);break}}}},t.prototype.triangulate=function(e){try{e.triangulate()}catch(e){}},t.prototype.processResult=function(e){for(var t=0;t<e.map_.length;t++){var r=e.map_[t],i=r.points_[0],n=r.points_[1],r=r.points_[2];void 0!==i.id&&void 0!==n.id&&void 0!==r.id&&this.filterFace(i.id,n.id,r.id)}},t.prototype.pointInEdgeList=function(e,t){for(var r=this.cset.pts,i=this.cset.edges,n=!1,a=0,o=i.length;a<o;++a){var s,l=i[a],d=r[l.p1].x,c=r[l.p1].y,h=r[l.p2].x;t<=c!=(s=t<=(l=r[l.p2].y))&&(h-e)*(c-l)<=(l-t)*(d-h)==s&&(n=!n)}return n},t.prototype.pointInContour=function(e,t,r){for(var i,n,a,o=!1,s=this.cset.pts,l=s[r[r.length-1]].x,d=s[r[r.length-1]].y,c=t<=d,h=0,u=r.length;h<u;++h)n=s[r[h]].x,c!=(i=t<=(a=s[r[h]].y))&&(n-e)*(d-a)<=(a-t)*(l-n)==i&&(o=!o),c=i,l=n,d=a;return o},t.prototype.pointInPolygon=function(e,t){for(var r=!1,i=0;i<this.cset.contours.length;i++)this.pointInContour(e,t,this.cset.contours[i])&&(r=!r);return r},t.prototype.filterFace=function(e,t,r){var i=this.pts[e],n=this.pts[t],a=this.pts[r],o=(i.x+n.x+a.x)/3,s=(i.y+n.y+a.y)/3;this.intervalTree.pointInPolygon(o,s)&&(o=n.x-i.x,s=n.y-i.y,n=a.x-i.x,0<o*(a.y-i.y)-n*s?this.indices.push(e,t,r):this.indices.push(e,r,t))},this.TriangulatedSurface=t,this.ContourSet=e,this.Edge=function(e,t,r,i,n,a,o){this.pt1=e,this.pt2=t,this.p1=-1,this.p2=-1,this.eid1=s(r,i,o),this.eid2=s(n,a,o)}},["#if NUM_CUTPLANES > 0","uniform vec4 cutplanes[NUM_CUTPLANES];","#ifdef CUTPLANES_LINE","uniform vec3 cutplanesOutlineColor;","uniform float cutplanesOutlineThickness;","#endif","bool checkCutPlanes() {","bool isCut = false;","#ifdef CUTPLANES_LINE","bool isCutEdge = false;","float eyeDist = length(vViewPosition);","#endif","for (int i=0; i<NUM_CUTPLANES; i++) {","float dotPlane = dot(vec4(vWorldPosition, 1.0), cutplanes[i]);","isCut = isCut || (dotPlane > 0.0);","#ifdef CUTPLANES_LINE","isCutEdge = isCutEdge || (dotPlane > -cutplanesOutlineThickness*eyeDist);","#endif","}","if (isCut) {","discard;","return true;","}","#ifdef CUTPLANES_LINE","else if (isCutEdge) {","gl_FragColor = vec4(cutplanesOutlineColor, 1.0);","return true;","}","#endif","return false;","}","#endif"].join("\n")),r=["vec4 packDepth( const in float depth ) {","vec4 enc = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;","enc = fract(enc);","enc -= enc.yzww * vec4(1.0/255.0,1.0/255.0,1.0/255.0,0.0);","return enc;","}","float unpackDepth( const in vec4 rgba_depth ) {","return dot( rgba_depth, vec4(1.0, 1.0/255.0, 1.0/65025.0, 1.0/160581375.0) );","}"].join("\n"),na={uniforms:{cutplanes:{type:"v4v",value:[]}},vertexShader:["#ifdef USE_LOGDEPTHBUF","    #ifdef USE_LOGDEPTHBUF_EXT","        varying float vFragDepth;","    #endif","    uniform float logDepthBufFC;","#endif","#if NUM_CUTPLANES > 0","varying vec3 vWorldPosition;","#endif","void main() {","#ifdef USE_MODELMATRIXATTRIB","    mat4 ndsModelViewMatrix = viewMatrix * modelMatrixAttrib;","    gl_Position = projectionMatrix * ndsModelViewMatrix * vec4( position, 1.0 );","#else","    gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );;","#endif","#if NUM_CUTPLANES > 0","    vec4 worldPosition = modelMatrix * vec4( position, 1.0 );","    vWorldPosition = worldPosition.xyz;","#endif","#ifdef USE_LOGDEPTHBUF","    gl_Position.z = log2(max(1e-6, gl_Position.w + 1.0)) * logDepthBufFC;","    #ifdef USE_LOGDEPTHBUF_EXT","        vFragDepth = 1.0 + gl_Position.w;","    #else","        gl_Position.z = (gl_Position.z - 1.0) * gl_Position.w;","    #endif","#endif","}"].join("\n"),fragmentShader:["#ifdef USE_LOGDEPTHBUF","    uniform float logDepthBufFC;","    #ifdef USE_LOGDEPTHBUF_EXT","        #extension GL_EXT_frag_depth : enable","        varying float vFragDepth;","    #endif","#endif",r,"#if NUM_CUTPLANES > 0","varying vec3 vWorldPosition;","#endif",ia,"void main() {","#if NUM_CUTPLANES > 0","if (checkCutPlanes()) return;","#endif","#if defined(USE_LOGDEPTHBUF) && defined(USE_LOGDEPTHBUF_EXT)","gl_FragDepthEXT = log2(vFragDepth) * logDepthBufFC * 0.5;","#endif","#ifdef USE_LOGDEPTHBUF_EXT","float depth = gl_FragDepthEXT / gl_FragCoord.w;","#else","float depth = gl_FragCoord.z / gl_FragCoord.w;","#endif","depth = 1.0 - depth;","gl_FragColor = packDepth(depth);","}"].join("\n")},aa={uniforms:{tDepth:{type:"t",value:null},worldSize:{type:"v3",value:new THREE.Vector3(1,1,1)}},defines:{},vertexShader:["varying vec2 vUv;","void main() {","vUv = vec2(uv.x, uv.y);","gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join("\n"),fragmentShader:["#define NUM_SAMPLES 29.0","#define NUM_SPIRAL_TURNS 7.0","uniform sampler2D tDepth;","uniform vec3 worldSize;","varying vec2 vUv;","#ifdef PRESET_2","#define SAMPLE_RADIUS 0.3","#define AO_GAMMA 1.0","#define AO_INTENSITY 1.0","#else","#define SAMPLE_RADIUS 0.2","#define AO_GAMMA 3.0","#define AO_INTENSITY 0.8","#endif",r,"#define PI 3.14159265358979","float rand(vec2 co) {","return fract(sin(dot(co.xy, vec2(12.9898, 78.233))) * 43758.5453);","}","float getRandomAngle(vec2 pos) {","return rand(pos) * (2.0 * PI);","}","vec2 tapLocation(float sampleNumber, float spinAngle, out float ssR){","float alpha = float(sampleNumber + 0.5) * (1.0 / NUM_SAMPLES);","float angle = alpha * (NUM_SPIRAL_TURNS * PI * 2.0) + spinAngle;","ssR = alpha;","return vec2(cos(angle), sin(angle));","}","vec2 sampleAO(vec2 unitDirection, float radius) {","vec2 sampleOffset = unitDirection * radius;","float idepth = unpackDepth(texture2D(tDepth, vUv + sampleOffset));","float depth = 1.0 - idepth;","if (depth < 1e-6) {","if (radius == 0.0)","return vec2(1.0, 1.0);","else","return vec2(0.0, 1.0);","}","vec3 dir = vec3(sampleOffset.x, depth, sampleOffset.y) * worldSize;","float distance2 = dot(dir,dir);","float idistance = 1.0 / sqrt(distance2);","vec3 ndir = dir * idistance;","#ifdef PRESET_2","float importance = ndir.y * idistance;","#else","float importance = ndir.y / distance2;","#endif","vec2 ret;","ret.x = (idepth == 0.0) ? 0.0 : importance;","ret.y = importance;","return ret;","}","void main() {","vec2 sum = vec2(0.0);","float angle = getRandomAngle(vUv);","for (float i = 0.0; i<NUM_SAMPLES; i+= 1.0) {","float ssR;","vec2 uv = tapLocation(i, angle, ssR);","sum += sampleAO(uv, ssR * SAMPLE_RADIUS);","}","float ao = sum.x / sum.y;","gl_FragColor = packDepth(AO_INTENSITY * clamp(pow(ao, AO_GAMMA), 0.0, 0.9999));","}"].join("\n")},oa={uniforms:{tDepth:{type:"t",value:null}},defines:{},vertexShader:["varying vec2 vUv;","void main() {","vUv = vec2(uv.x, uv.y);","gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join("\n"),fragmentShader:["uniform sampler2D tDepth;","varying vec2 vUv;","#ifdef HORIZONTAL","#define GET_UV(X) vec2(vUv.x + KERNEL_SCALE*(X), vUv.y)","#else","#define GET_UV(Y) vec2(vUv.x, vUv.y + KERNEL_SCALE*(Y))","#endif",r,"#define PI 3.14159265358979","#define SIGMA ((2.0 * KERNEL_RADIUS+1.0) / 6.0)","#define SIGMASQ2 (2.0 * SIGMA * SIGMA)","#ifdef BOX","#define KERNEL_VAL(X) 1.0","#else","#define KERNEL_VAL(X) ( (1.0 / sqrt(PI * SIGMASQ2)) * exp(-(X)*(X)/SIGMASQ2) )","#endif","void main() {","float depthVal = 0.0;","float sum = 0.0;","for (float x=-KERNEL_RADIUS; x<=KERNEL_RADIUS; x+=1.0) {","depthVal += unpackDepth(texture2D(tDepth, GET_UV(x))) * KERNEL_VAL(x);","sum += KERNEL_VAL(x);","}","gl_FragColor = packDepth(depthVal/sum);","}"].join("\n")},sa={uniforms:{tDepth:{type:"t",value:null},uShadowColor:{type:"v4",value:new THREE.Vector4(0,0,0,1)}},vertexShader:["varying vec2 vUv;","void main() {","    vUv = vec2(uv.x, uv.y);","    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join("\n"),fragmentShader:["uniform sampler2D tDepth;","uniform vec4 uShadowColor;","varying vec2 vUv;",r,"void main() {","float depthVal = unpackDepth(texture2D(tDepth, vUv));","#ifdef DARKNESS_SCALE","depthVal *= DARKNESS_SCALE;","#endif","gl_FragColor = vec4(uShadowColor.rgb, uShadowColor.a * depthVal);","}"].join("\n")},la=($n.prototype.constructor=$n,ea.prototype={constructor:ea,parseMaterial:function(e){for(var t=[],r=0;r<e.length;++r){var i,n=e[r],a=null;if(1===n.Type){var o={};switch(n.Side){case 1:o.side=THREE.FrontSide;break;case 2:o.side=THREE.BackSide;break;case 3:o.side=THREE.DoubleSide;break;default:o.side=THREE.FrontSide}n.Color&&(o.color=new THREE.Color(n.Color[0]/255,n.Color[1]/255,n.Color[2]/255)),(a=new THREE.MeshBasicMaterial(o)).polygonOffset=!0,a.polygonOffsetFactor=1,a.polygonOffsetUnits=1}else if(2===n.Type){var s={};switch(n.Side){case 1:s.side=THREE.FrontSide;break;case 2:s.side=THREE.BackSide;break;case 3:s.side=THREE.DoubleSide;break;default:s.side=THREE.FrontSide}n.Color&&(s.color=new THREE.Color(n.Color[0]/255,n.Color[1]/255,n.Color[2]/255)),n.Emissive&&(s.emissive=new THREE.Color(n.Emissive[0]/255,n.Emissive[1]/255,n.Emissive[2]/255)),n.Specular&&(s.specular=new THREE.Color(n.Specular[0]/255,n.Specular[1]/255,n.Specular[2]/255)),null!=n.Shininess&&(s.shininess=n.Shininess),null!=n.Refraction&&(s.refractionRatio=n.Refraction),null!=n.Reflectivity&&(s.reflectivity=n.Reflectivity),null!=n.Opacity&&(s.opacity=n.Opacity,s.opacity<1)&&(s.transparent=!0),(a=new THREE.MeshPhongMaterial(s)).polygonOffset=!0,a.polygonOffsetFactor=1,a.polygonOffsetUnits=1}else if(3===n.Type){this.viewer.hasPbrMaterial=!0;var l={};switch(l.name=n.Name,n.Side){case 1:l.side=THREE.FrontSide;break;case 2:l.side=THREE.BackSide;break;case 3:l.side=THREE.DoubleSide;break;default:l.side=THREE.FrontSide}n.Color&&(l.color=new THREE.Color(n.Color[0]/255,n.Color[1]/255,n.Color[2]/255)),n.Emissive&&(l.emissive=new THREE.Color(n.Emissive[0]/255,n.Emissive[1]/255,n.Emissive[2]/255)),n.EmissiveIntensity&&(l.emissiveIntensity=n.EmissiveIntensity),null!=n.Roughness&&(l.roughness=n.Roughness),null!=n.Metalness&&(l.metalness=n.Metalness),n.Clearcoat&&(l.clearCoat=n.Clearcoat),n.ClearcoatRoughness&&(l.clearCoatRoughness=n.ClearcoatRoughness),null!=n.Reflectivity&&(l.reflectivity=n.Reflectivity),null!=n.Opacity&&(l.opacity=n.Opacity,l.opacity<1)&&(l.transparent=!0),null!=n.RoughnessMap&&this.loadMapTexture(l,"roughnessMap",n.RoughnessMap),(a=new THREE.MeshPhysicalMaterial(l)).polygonOffset=!0,a.polygonOffsetFactor=1,a.polygonOffsetUnits=1}else 4===n.Type&&(i={},n.Color&&(i.color=new THREE.Color(n.Color[0]/255,n.Color[1]/255,n.Color[2]/255)),a=new THREE.LineBasicMaterial(i));t[n.Id]={mat:a,refCount:0}}return t},parseFonts:function(e){for(var t=[],r=0;r<e.length;r++)t[e[r].Id]=e[r];return t},parseTessellationChunk:function(e,t){for(var r={ndsGeometriesArray:[],id2geom:new Map},i=0,n=e.length;i<n;++i){var a=e[i];a.ChunkBufferUri=t+a.ChunkBufferUri;for(var o=0,s=a.Tesellations.length;o<s;++o){var l=a.Tesellations[o],d=new le;d.uuid=l.Id,d.subGeomId=0,l.BBox&&d.boundingBox.setFromArray(l.BBox),l.ndsGeom=d,r.id2geom.set(d.uuid,d),r.ndsGeometriesArray.push(d),d.updateModelMatrix=!0}}return r.chunks=e,r},parseBodyNode:function(e,t,r,i,n,a){r.meshes||(r.tmpBox=new THREE.Box3,r.meshes={meshId:[],geometries:[],materials:[],bodyId:[],bbox:[]},r.meshMap=new Map),r.lines||(r.lines={lineId:[],geometries:[],materials:[],bodyId:[]},r.lineMap=new Map),r.mesh2geom||(r.mesh2geom=new Map),r.materialUuids||(r.materialUuids=[]),r.bodyUuids||(r.bodyUuids=[],r.bodyUuid2Index=new Map);var o,s=e.Id,l=!0;if(1===e.Type)o="Model";else if(2===e.Type)o="Assembly";else if(3===e.Type)o="Part";else if(4===e.Type)o="Body";else if(5===e.Type)l=!(o="LOD"),t&&"Body"===t.type&&e.Children&&this.parseBodyNode(e.Children[0],t,r,i,n);else if(6===e.Type){if(l=!(o="Mesh"),t&&t._leafBodyAttri){var d=t._leafBodyAttri;if(r.meshMap.set(s,[]),e.TessellationGeoms)for(var c=0;c<e.TessellationGeoms.length;++c){var h=r.meshes.meshId.length,u=(d.bodyMeshIds.push(h),r.meshMap.get(s).push(h),n[e.Materials[c]].refCount++,r.materialUuids.indexOf(e.Materials[c])),u=(-1===u&&(u=r.materialUuids.length,r.materialUuids.push(e.Materials[c])),r.meshes.meshId.push(h),r.meshes.geometries.push(e.TessellationGeoms[c]),r.meshes.materials.push(u),r.meshes.bodyId.push(r.bodyUuid2Index.get(t.uuid)),i.get(e.TessellationGeoms[c])?i.get(e.TessellationGeoms[c]).boundingBox:new THREE.Box3);r.tmpBox.copy(u),r.tmpBox.applyMatrix4(t.worldMatrix),r.meshes.bbox.push(r.tmpBox.min.x),r.meshes.bbox.push(r.tmpBox.min.y),r.meshes.bbox.push(r.tmpBox.min.z),r.meshes.bbox.push(r.tmpBox.max.x),r.meshes.bbox.push(r.tmpBox.max.y),r.meshes.bbox.push(r.tmpBox.max.z),0===d.bodyBbox.length?(d.bodyBbox[0]=r.tmpBox.min.x,d.bodyBbox[1]=r.tmpBox.min.y,d.bodyBbox[2]=r.tmpBox.min.z,d.bodyBbox[3]=r.tmpBox.max.x,d.bodyBbox[4]=r.tmpBox.max.y,d.bodyBbox[5]=r.tmpBox.max.z):(d.bodyBbox[0]=Math.min(d.bodyBbox[0],r.tmpBox.min.x),d.bodyBbox[1]=Math.min(d.bodyBbox[1],r.tmpBox.min.y),d.bodyBbox[2]=Math.min(d.bodyBbox[2],r.tmpBox.min.z),d.bodyBbox[3]=Math.max(d.bodyBbox[3],r.tmpBox.max.x),d.bodyBbox[4]=Math.max(d.bodyBbox[4],r.tmpBox.max.y),d.bodyBbox[5]=Math.max(d.bodyBbox[5],r.tmpBox.max.z)),r.mesh2geom.set(h,e.TessellationGeoms[c])}}}else if(7===e.Type){if(l=!(o="LinePieces"),t&&t._leafBodyAttri){var p=t._leafBodyAttri;if(r.lineMap.set(s,[]),e.TessellationGeoms)for(var f=0;f<e.TessellationGeoms.length;++f){var m=r.lines.lineId.length,g=(p.bodyLineSegIds.push(m),r.lineMap.get(s).push(m),n[e.Materials[f]].refCount++,r.materialUuids.indexOf(e.Materials[f]));-1===g&&(g=r.materialUuids.length,r.materialUuids.push(e.Materials[f])),r.lines.lineId.push(m),r.lines.geometries.push(e.TessellationGeoms[f]),r.lines.materials.push(g),r.lines.bodyId.push(r.bodyUuid2Index.get(t.uuid)),r.mesh2geom.set(m,e.TessellationGeoms[f])}}}else 8===e.Type&&(o="Reference");if(l){var v=new _e;if(v.type=o,v.ndsModel=a,v.uuid=s.toString(),v.id=s,v.objectid=s,a.objectidTouuid[v.objectid]=v.uuid,v.name=e.Name||v.uuid,v.visible=void 0===e.Visible||!!e.Visible,v._originalVisible=v.visible,t&&(v.parent=t).children.push(v),e.Transform&&(v.matrix=[],v.matrix.push(e.Transform[0]),v.matrix.push(e.Transform[3]),v.matrix.push(e.Transform[6]),v.matrix.push(e.Transform[12]),v.matrix.push(e.Transform[1]),v.matrix.push(e.Transform[4]),v.matrix.push(e.Transform[7]),v.matrix.push(e.Transform[13]),v.matrix.push(e.Transform[2]),v.matrix.push(e.Transform[5]),v.matrix.push(e.Transform[8]),v.matrix.push(e.Transform[14]),v.matrix.push(e.Transform[9]),v.matrix.push(e.Transform[10]),v.matrix.push(e.Transform[11]),v.matrix.push(e.Transform[15]),v._originalMatrix=v.matrix.slice(0)),"Body"!==o&&"Model"!==o||((l=new se(v)).bodyBbox=[],v.leafBodyAttri=l,v.worldMatrix=this.viewer.ndsModel.calculateNodeWorldMatrix(v),r.bodyUuid2Index.set(v.uuid,r.bodyUuids.length),r.bodyUuids.push(v.uuid)),!e.PMIs||"Model"!==o&&"Assembly"!==o&&"Part"!==o||(v.pmiuuid=e.PMIs),!e.AttrUri||"Model"!==o&&"Assembly"!==o&&"Part"!==o||(v.attrUri=e.AttrUri,v.attrIndex=e.AttrIndex),e.Body&&(v.brepId=e.Body),e.Children)for(var y=0,A=e.Children.length;y<A;++y)this.parseBodyNode(e.Children[y],v,r,i,n,a);return v}},parsePMINode:function(e,t,O,r,i){this.SDFMaker.DisaCreateMaterial(e,O);for(var o=[],n=(function e(t,r){if("Assembly"===t.type||"Part"===t.type||"Model"===t.type){for(var i=0;t.pmiuuid&&i<t.pmiuuid.length;i++)o.push({pmiuuid:t.pmiuuid[i],bodyMatrix:r.clone()});for(var n=0;n<t.children.length;n++){var a=t.children[n];e(a,a.matrix?(new THREE.Matrix4).fromArray(a.matrix).premultiply(r):(new THREE.Matrix4).copy(r))}}}(i,i.matrix?(new THREE.Matrix4).fromArray(i.matrix):new THREE.Matrix4),this.viewer.pmiNum=o.length,new THREE.Object3D),a=0;a<o.length;a++)for(var s=0;s<e.length;s++)if(e[s].Id==o[a].pmiuuid){var l=new THREE.Object3D,d=(l.uuid=e[s].Id,l.name=e[s].Name,l.type=e[s].Type,o[a].bodyMatrix),c=new THREE.Vector3(e[s].Plane.Data[0],e[s].Plane.Data[1],e[s].Plane.Data[2]),h=new THREE.Vector3(e[s].Plane.Data[3],e[s].Plane.Data[4],e[s].Plane.Data[5]),u=new THREE.Vector3(e[s].Plane.Data[6],e[s].Plane.Data[7],e[s].Plane.Data[8]),p=(new THREE.Vector3).crossVectors(u,h).normalize(),f=new THREE.Color(e[s].Color[0]/255,e[s].Color[1]/255,e[s].Color[2]/255);if(e[s].Leaders)for(var m=0;m<e[s].Leaders.length;m++){var g=e[s].Leaders[m],F=(g.Size,new THREE.Color(g.Color[0]/255,g.Color[1]/255,g.Color[2]/255));if(g.Id,g.RefObject,g.Arrows,g.RefObject,g.Extensions,g.GeomIds)for(var v=new THREE.Vector3,y=0;y<g.GeomIds.length;y++){var A=g.GeomIds[y],M=t.get(A);if(M){for(var E=M.position,w=M.materialId?r[M.materialId].mat:null,x=!!M.isPoint,U=!!M.close,N=(M.fill,M.color,E.length),b=new Float32Array(N/2*3),B=0,I=0;I<N;I+=2)v.set(c.x,c.y,c.z),v.addScaledVector(h,E[I]),v.addScaledVector(p,E[I+1]),b[B++]=v.x,b[B++]=v.y,b[B++]=v.z;var M=(new THREE.BufferGeometry).addAttribute("position",new THREE.BufferAttribute(b,3,0,!1)),w=(M.computeBoundingBox(),w?w.clone():new THREE.LineBasicMaterial),T=(w.color.copy(F),null);(T=x?((x=new THREE.PointsMaterial).color.copy(F),new THREE.Points(M,x)):new(U?THREE.LineLoop:THREE.Line)(M,w))&&(T.matrix.premultiply(d),T.matrixAutoUpdate=!1,T.updateMatrixWorld(!0),T.geomId=A,l.add(T))}else console.log("[DEBUG]: geomId : ",A," not found")}}if(e[s].Texts)for(var S=0;S<e[s].Texts.length;S++){var R=e[s].Texts[S],C=(new THREE.Vector3).copy(c),D=(C.addScaledVector(h,R.Position[0]),C.addScaledVector(p,R.Position[1]),R.Align,R.Direction,O[R.Font||R.FontId]),P=D.Color?new THREE.Color(D.Color[0]/255,D.Color[1]/255,D.Color[2]/255):f,D={text:R.Content,textFont:{name:D.Name,bigName:"",size:D.Size,width:D.Scale,style:D.Italic?"italic":"normal",weight:D.Bold?"bold":"normal"}},D=this.parseSDFTextGeometry(D,null,null,P),P=this.SDFMaker.GetMaterial(D.styleId),D=new THREE.Mesh(D,P),P=(new THREE.Matrix4).makeRotationAxis(u,R.Rotation),V=(new THREE.Matrix4).makeBasis(h,p,u),C=(new THREE.Matrix4).makeTranslation(C.x,C.y,C.z);D.matrix.premultiply(V),D.matrix.premultiply(P),D.matrix.premultiply(C),D.matrix.premultiply(d),D.matrixAutoUpdate=!1,D.updateMatrixWorld(!0),R.Id&&(D.textId=R.Id),l.add(D)}if(e[s].Symbols,e[s].Geometries){if(e[s].Geometries.Lines)for(var H=0;H<e[s].Geometries.Lines.length;H++){var G=e[s].Geometries.Lines[H],_=t.get(G),_=this.createLine(_,r,c,h,p,f,d);_?(_.geomId=G,l.add(_)):console.log("[DEBUG]: geomId : ",G," not found")}if(e[s].Geometries.Polylines)for(var k=0;k<e[s].Geometries.Polylines.length;k++){var j=e[s].Geometries.Polylines[k],L=t.get(j),L=this.createLine(L,r,c,h,p,f,d);L?(L.geomId=j,l.add(L)):console.log("[DEBUG]: geomId : ",j," not found")}}e[s].Extensions,n.add(l)}n.type="pmiModel";i=new THREE.Object3D;return i.type="pmiobject",i.isPmi=!0,i.add(n),i},parseLights:function(e){for(var t=[],r=0,i=e.length;r<i;++r){var n,a,o=e[r],s=new THREE.Color(o.Color[0]/255,o.Color[1]/255,o.Color[2]/255),l=2;o.ConstAttenuation?l=0:o.LinearAttenuation?l=1:o.QuadraticAttenuation&&(l=2),1==o.Type?((n=new THREE.DirectionalLight(s,o.Intensity)).position.set(-o.Direction[0],-o.Direction[1],-o.Direction[2]),t.push(n)):2===o.Type?((n=new THREE.PointLight(s,o.Intensity,0,l)).position.set(o.Location[0],o.Location[1],o.Location[2]),t.push(n)):3===o.Type?(a=Math.PI/3,o.Cutoff&&(a=o.Cutoff),(a=new THREE.SpotLight(s,o.Intensity,0,a,0,l)).position.set(o.Location[0],o.Location[1],o.Location[2]),(l=new THREE.Vector3(o.Direction[0],o.Direction[1],o.Direction[2])).normalize(),a.target.position.set(o.Location[0]+l.x,o.Location[1]+l.y,o.Location[2]+l.z),t.push(a)):0===o.Type&&(l=new THREE.AmbientLight(s,o.Intensity),t.push(l))}return t},parseBackground:function(e,t){var r,i,n,a={};return 1==e.Type?a.Color=(r=e.Color[0],i=e.Color[1],n=e.Color[2],(e[3]<<24)+(r<<16)+(i<<8)+n):2==e.Type&&(r=t+e.Image,a.Url=r),a.Type=e.Type,a},parseWaterMark:function(e){var t={};return t.Content=e.Mark,t.Angle=e.Angle,t.Opacity=e.Opacity,t.Color=e.Color,t.FontFamily=e.FontFamily,t.TextSize=e.TextSize,t.Gap=e.Gap,t.Pos=e.Pos,t.XMargin=e.XMargin,t.YMargin=e.YMargin,t.VOffset=e.vOffset,t.Fill=e.Fill,t.PadX=e.PadX,t.PadY=e.PadY,t},parseSDFTextGeometry:function(e,t,r,i,n,a){void 0===a&&(a=!1);for(var o,s,l,d=0,c=0,h=null,u=this.SDFMaker.GetMaterialStyleId(e.textFont.style,e.textFont.weight),p=this.SDFMaker.RegText(e.text),f=(e.text=p.text,e.text.length),m=this.SDFMaker.textCompositeStride,g=this.SDFMaker.getTextGeometryBuffer(u,f),v=(g.compositeIBuffer,g.compositePositionAttrib),y=g.compositeColorAttrib,A=g.compositeUvAttrib,M=g.compositeTextureAttrib,E=g.index.array,w=4*f*this.SDFMaker.textCompositeStride,x=g.bufferOffset,b=6*f,B=g.indexOffset,I=4*f,T=x/this.SDFMaker.textCompositeStride,f=(g.bufferOffset+=w,g.indexOffset+=b,new THREE.Euler),S=new THREE.Matrix4,R=new THREE.Vector3,C=0;C<e.text.length;C++){var D=e.text[C],P=this.SDFMaker.GetDimensionsForSize(D,e.textFont.size,u,e.textFont.name,e.textFont.width,e.textFont.bigName);if(!P)return null;(p.superscript&&C>=p.superscriptbegin&&C<=p.superscriptend||p.subscript&&C>=p.subscriptbegin&&C<=p.subscriptend)&&(P.height*=.5,P.width*=.5);D=P.height*this.SDFMaker.GetTextOffset(D,e.textFont.name);p.superscript&&C>=p.superscriptbegin&&C<=p.superscriptend&&(D-=P.height),c<P.height-D&&(c=P.height-D),v.array[x+36*C]=d,v.array[x+36*C+1]=P.height-D,v.array[x+36*C+2]=0,y.array[x+36*C+3]=i.r,y.array[x+36*C+4]=i.g,y.array[x+36*C+5]=i.b,A.array[x+36*C+6]=P.left,A.array[x+36*C+7]=P.top,M.array[x+36*C+8]=P.textureid,v.array[x+36*C+9]=d+P.width,v.array[x+36*C+10]=P.height-D,v.array[x+36*C+11]=0,y.array[x+36*C+12]=i.r,y.array[x+36*C+13]=i.g,y.array[x+36*C+14]=i.b,A.array[x+36*C+15]=P.right,A.array[x+36*C+16]=P.top,M.array[x+36*C+17]=P.textureid,v.array[x+36*C+18]=d,v.array[x+36*C+19]=-D,v.array[x+36*C+20]=0,y.array[x+36*C+21]=i.r,y.array[x+36*C+22]=i.g,y.array[x+36*C+23]=i.b,A.array[x+36*C+24]=P.left,A.array[x+36*C+25]=P.bottom,M.array[x+36*C+26]=P.textureid,v.array[x+36*C+27]=d+P.width,v.array[x+36*C+28]=-D,v.array[x+36*C+29]=0,y.array[x+36*C+30]=i.r,y.array[x+36*C+31]=i.g,y.array[x+36*C+32]=i.b,A.array[x+36*C+33]=P.right,A.array[x+36*C+34]=P.bottom,M.array[x+36*C+35]=P.textureid,E[B+6*C]=T+4*C,E[B+6*C+1]=T+4*C+2,E[B+6*C+2]=T+4*C+1,E[B+6*C+3]=T+4*C+2,E[B+6*C+4]=T+4*C+3,E[B+6*C+5]=T+4*C+1,d+=P.width}if(this.viewer.is2DModel){if(f.setFromQuaternion(r),this.viewer.modelContentVersion<2){S.identity(),S.makeRotationFromEuler(f),S.setPosition(t);for(var H=0;H<I;++H)R.x=v.array[x+H*m],R.y=v.array[x+H*m+1],R.z=v.array[x+H*m+2],R.applyMatrix4(S),v.array[x+H*m]=R.x,v.array[x+H*m+1]=R.y,v.array[x+H*m+2]=R.z;this.SDFMaker.AddTextGeometryBuffer(g,u,n,T,I)}p.underscode&&((o=new THREE.LineBasicMaterial).color.setRGB(i.r,i.g,i.b),(s=new THREE.Geometry).vertices.push(new THREE.Vector3(0,0,0),new THREE.Vector3(d,0,0)),s.rotateZ(f.z),s.rotateY(f.y),s.rotateX(f.x),s.translate(t.x,t.y,t.z),(l=new THREE.LineSegments(s,o)).name=n,l.color=o.color.clone(),this.SDFMaker.AddLine(l)),p.box&&((o=new THREE.LineBasicMaterial).color.setRGB(i.r,i.g,i.b),(s=new THREE.Geometry).vertices.push(new THREE.Vector3(d,c,0),new THREE.Vector3(d,0,0),new THREE.Vector3(d,0,0),new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,0),new THREE.Vector3(0,c,0),new THREE.Vector3(0,c,0),new THREE.Vector3(d,c,0)),s.rotateZ(f.z),s.rotateY(f.y),s.rotateX(f.x),s.translate(t.x,t.y,t.z),(l=new THREE.LineSegments(s,o)).name=n,l.color=o.color.clone(),this.SDFMaker.AddLine(l)),p.dash&&((o=new THREE.LineBasicMaterial).color.setRGB(i.r,i.g,i.b),(s=new THREE.Geometry).vertices.push(new THREE.Vector3(0,c,0),new THREE.Vector3(d,c,0)),s.rotateZ(f.z),s.rotateY(f.y),s.rotateX(f.x),s.translate(t.x,t.y,t.z),(l=new THREE.LineSegments(s,o)).name=n,l.color=o.color.clone(),this.SDFMaker.AddLine(l))}else(h=new(a?le:THREE.BufferGeometry)).type="TextBufferGeometry",h.name=e.text,h.styleId=u,h.addAttribute("position",v),h.addAttribute("color",y),h.addAttribute("uv",A),h.addAttribute("textureid",M),h.setIndex(g.index),h.setDrawRange(B,b);return h&&h.computeBoundingBox(),h},createLine:function(e,t,r,i,n,a,o){if(e){for(var s=e.position,t=e.materialId?t[e.materialId].mat:null,l=!!e.isPoint,d=!!e.close,c=!!e.fill,a=e.color||a,h=s.length,u=new Float32Array(h/2*3),p=0,f=new THREE.Vector3,m=0;m<h;m+=2)f.set(r.x,r.y,r.z),f.addScaledVector(i,s[m]),f.addScaledVector(n,s[m+1]),u[p++]=f.x,u[p++]=f.y,u[p++]=f.z;var g=(new THREE.BufferGeometry).addAttribute("position",new THREE.BufferAttribute(u,3,0,!1)),t=(g.computeBoundingBox(),t?t.clone():new THREE.LineBasicMaterial),e=(c&&t.color.copy(a),e.symbolColor&&t.color.copy(e.symbolColor),null);if(e=l?(l=new THREE.PointsMaterial,c&&l.color.copy(a),new THREE.Points(g,l)):new(d?THREE.LineLoop:THREE.Line)(g,t))return e.matrix.premultiply(o),e.matrixAutoUpdate=!1,e.updateMatrixWorld(!0),e}return null},loadMapTexture:function(e,t,r){var i=(new THREE.TextureLoader).load(r);e[t]=i,e[t].sourceFile=r,e[t].wrapS=THREE.RepeatWrapping,e[t].wrapT=THREE.RepeatWrapping}},ta.prototype={constructor:ta,parseSpatialIndex:function(e,t){for(var r=new yt.Stream(e.data),i=[],n=0;n<e.nodeCount;++n){var a={},o=(r.readUInt16(),a.index=r.readUInt32(),a.type=e.boundingType,a.idType=t.IdType,a.bounding=[],0===a.type?(a.bounding[0]=r.readFloat32(),a.bounding[1]=r.readFloat32(),a.bounding[2]=r.readFloat32(),a.bounding[3]=r.readFloat32(),a.bounding[4]=r.readFloat32(),a.bounding[5]=r.readFloat32()):1===a.type&&(a.bounding[0]=r.readFloat32(),a.bounding[1]=r.readFloat32(),a.bounding[2]=r.readFloat32(),a.bounding[3]=r.readFloat32()),r.readUInt8());a.children=[];for(var s=0;s<o;++s)a.children[s]=r.readUInt32();var l=r.readInt8();-1==l?l=r.readUInt16():-2==l&&(l=r.readUInt32()),a.meshes=[],a.lines=[];for(var d=0;d<l;++d){var c=void 0;if(1===t.IdType)c=r.readInt32();else if(0===t.IdType){for(var h="",u=0===e.idLength?r.readInt32():e.idLength,p=0;p<u;++p)h+=String.fromCharCode(r.readByte());c=h}t.meshMap.has(c)?a.meshes=a.meshes.concat(t.meshMap.get(c)):t.lineMap.has(c)&&(a.lines=a.lines.concat(t.lineMap.get(c)))}i[n]=a}return i},parseAnimation:function(e,t,r,i){for(var n={animations:[],tracks:[]},a=new yt.Stream(e),o=a.readUInt32(),s=0;s<o;s++){var l={},d=(l.trackID=a.readInt32(),l.name=a.readString32(),l.mode=a.readUInt8(),a.readUInt32());l.modelID=[];for(var c=0;c<d;c++)l.modelID.push(a.readIDType(t.IdType,i).toString());var h=a.readUInt32();l.times=[],l.times.length=h,a.readArrayUInt32(l.times);for(var u=0;u<l.times.length;u++){var p=l.times[u];l.times[u]=p/1e3}l.keyFrameCount=a.readUInt32();var f=[];f.length=l.keyFrameCount,a.readArrayUint8(f),a.readIDType(t.IdType,i);if(5===f[0]&&(l.materialAttribute=[],l.materialAttribute.length=l.keyFrameCount,a.readArrayUint8(l.materialAttribute)),l.translations=[],l.rotations=[],l.scales=[],l.morphWeight=[],2===l.mode)for(var m=0;m<l.keyFrameCount;++m)for(var g=0;g<h;g++){var v,y,A,M=f[m];1==M?((v=[]).length=3,a.readArrayFloat32(v),l.translations=l.translations.concat(v),l.trackType=1):2==M?((v=[]).length=4,a.readArrayFloat32(v),l.rotations=l.rotations.concat(v),l.trackType=2):3==M?((y=[]).length=3,a.readArrayFloat32(y),l.scales=l.scales.concat(y),l.trackType=3):4==M&&(A=a.readFloat32(A),l.morphWeight=l.morphWeight.push(A))}if(0<f.length&&4==f[0]){var E=a.readUInt32();l.deformation={},l.deformation.vertexIndexCount=E,l.deformation.vertexIndices=[],l.deformation.vertexCoordOffset=[],l.deformation.vertexNormalOffset=[],l.deformation.vertexNormalOffset=[];for(var w=0;w<f.length;++w){var x=[],x=(x.length=E,a.readArrayInt32(x),l.deformation.vertexIndices.concat(x),[]);x.length=3*E,a.readArrayFloat32(x),l.deformation.vertexCoordOffset.concat(x),a.readUInt8()&&((x=[]).length=3*E,a.readArrayFloat32(x),l.deformation.vertexNormalOffset.concat(x))}}l.interpolationTypes=[],2===l.mode?l.interpolationTypes.length=l.keyFrameCount:1===l.mode&&(l.interpolationTypes.length=h),a.readArrayUint8(l.interpolationTypes);for(var b=0;b<l.interpolationTypes.length;++b)2===l.interpolationTypes[b]&&(l.interpolationStarts=[],l.interpolationStarts.length=2*h,a.readArrayFloat32(l.interpolationStarts),l.interpolationEnds=[],l.interpolationEnds.length=2*h,a.readArrayFloat32(l.interpolationEnds));n.tracks.push(l)}for(var B=0;B<r;B++){for(var I={},T=a.readUInt32(),S=(I.id=T,I.animationID=a.readInt32(),I.name=a.readString2(),I.tracks=[],a.readUInt32()),R=0;R<S;R++){var C={};C.id=a.readInt32(),C.trackID=a.readIDType(t.IdType,i),C.startTime=a.readUInt32(),C.repeat=a.readUInt32(),I.tracks.push(C)}var D,T=a.readUInt32();0!==T&&(I.cameraMove={},I.cameraMove.id=a.readInt32(),I.cameraMove.cameraId=a.readIDType(t.IdType,i),(D=[]).length=T,a.readArrayUInt32(D),I.cameraMove.cameraTime=D,I.cameraMove.attributeCount=a.readUInt32(),(D=[]).length=I.cameraMove.attributeCount,a.readArrayUint8(D),I.cameraMove.attributeName=D,(D=[]).length=T,a.readArrayUint8(D),I.cameraMove.attributeValues=D),n.animations.push(I)}return n},parsePmiBin:function(e,t){for(var r=new yt.Stream(e.data),i=new Map,n=r.readUInt32(),a=r.readUInt32(),o=r.readUInt32(),s=r.readUInt32(),l=r.readUInt32(),d=0,c=0;c<n;c++){var h=r.readInt32(),u=new Float32Array(2),p=(r.readArrayFloat32(u),r.readUInt8()),f=r.readUInt8(),m=r.readUInt8();i.set(h,{position:u,isPoint:!0,color:new THREE.Color(p/255,f/255,m/255)}),d=Math.max(d,h)}for(var g=0;g<a;g++){var v=r.readInt32(),y=new Float32Array(4),A=(r.readArrayFloat32(y),void 0);0!=t&&(A=r.readInt32()),i.set(v,{position:y,materialId:A}),d=Math.max(d,v)}for(var M=0;M<o;M++){var E=r.readInt32(),w=r.readUInt8(),w=new Float32Array(w),x=(r.readArrayFloat32(w),void 0),b=(0!=t&&(x=r.readInt32()),r.readUInt8()),B=r.readUInt8(),I=r.readUInt8(),T=r.readUInt8(),S=r.readUInt8();i.set(E,{position:w,materialId:x,close:1==b,fill:1==B,color:new THREE.Color(I/255,T/255,S/255)}),d=Math.max(d,E)}for(var R=0;R<s;R++);for(var C=0;C<l;C++);return{nextPmiGeomIndex:d+1,geomMap:i}},parseBrep:function(e,t){var r=e.toplogyLen,i=e.geometrylen,n=new yt.Stream(e.data),a=null,o=null,s=null,l=null,d=null,c=new Map,h=new Map,u=new Map;if(0<r){for(var p=n.readInt32(),f=n.readInt32(),m=n.readInt32(),g=n.readInt32(),v=n.readInt32(),a=new Array(p),o=new Array(f),s=new Array(m),l=new Array(g),d=new Array(v),y=0;y<p;y++){for(var A=n.readIDType(t,e.idLength),M=n.readUInt8(),O=n.readUInt32(),E=[],w=0;w<O;w++)E[w]=n.readIDType(t,e.idLength);a[y]={id:A,bodyType:M,faceList:E,volume:n.readFloat64(),area:n.readFloat64()}}for(var x=0;x<f;x++){for(var F=n.readIDType(t,e.idLength),U=n.readUInt32(),b=[],B=0;B<U;B++)b[B]=n.readIDType(t,e.idLength);o[x]={id:F,loopList:b,faceDir:n.readUInt8(),area:n.readFloat64(),perimeter:n.readFloat64(),surfaceId:n.readIDType(t,e.idLength)}}for(var I=0;I<m;I++){for(var N=n.readIDType(t,e.idLength),V=0!=n.readInt8(),G=n.readUInt32(),T=[],S=0;S<G;S++)T[S]=n.readIDType(t,e.idLength);s[I]={id:N,isInnerLoop:V,edgeList:T}}for(var R=0;R<g;R++){var k=n.readIDType(t,e.idLength);l[R]={id:k,v0:n.readInt32(),v1:n.readInt32(),length:n.readFloat32(),curveID:n.readIDType(t,e.idLength)}}for(var C=0;C<v;C++){var j=n.readIDType(t,e.idLength);d[C]={id:j,pointId:n.readIDType(t,e.idLength)}}}if(0<i){for(var z=n.readInt32(),W=n.readInt32(),X=n.readInt32(),D=0;D<z;D++){var P=n.readIDType(t,e.idLength);switch(n.readUInt8()){case 0:c.set(P,{type:0,normal:n.readArrayFloat32(new Float32Array(3)),origin:n.readArrayFloat32(new Float32Array(3))});break;case 1:c.set(P,{type:1,center:n.readArrayFloat32(new Float32Array(3)),radius:n.readFloat64(),axisX:n.readArrayFloat32(new Float32Array(3)),axisZ:n.readArrayFloat32(new Float32Array(3))});break;case 2:c.set(P,{type:2,center:n.readArrayFloat32(new Float32Array(3)),radius:n.readFloat64(),normal:n.readArrayFloat32(new Float32Array(3)),axisX:n.readArrayFloat32(new Float32Array(3)),height:n.readFloat64()});break;case 3:c.set(P,{type:3,center:n.readArrayFloat32(new Float32Array(3)),maxRadius:n.readFloat64(),minRadius:n.readFloat64(),normal:n.readArrayFloat32(new Float32Array(3)),axisX:n.readArrayFloat32(new Float32Array(3))});break;case 4:c.set(P,{type:4,center:n.readArrayFloat32(new Float32Array(3)),radius:n.readFloat64(),normal:n.readArrayFloat32(new Float32Array(3)),axisX:n.readArrayFloat32(new Float32Array(3)),height:n.readFloat64()});break;case 5:c.set(P,{type:5,center:n.readArrayFloat32(new Float32Array(3)),xRadius:n.readFloat64(),yRadius:n.readFloat64(),zRadius:n.readFloat64(),axisX:n.readArrayFloat32(new Float32Array(3)),axisZ:n.readArrayFloat32(new Float32Array(3))});break;default:c.set(P,{type:6})}}for(var H=0;H<W;H++){var _=n.readIDType(t,e.idLength);switch(n.readUInt8()){case 0:h.set(_,{type:0,start:n.readArrayFloat32(new Float32Array(3)),end:n.readArrayFloat32(new Float32Array(3))});break;case 1:h.set(_,{type:1,center:n.readArrayFloat32(new Float32Array(3)),radius:n.readFloat64(),normal:n.readArrayFloat32(new Float32Array(3))});break;case 2:h.set(_,{type:2,center:n.readArrayFloat32(new Float32Array(3)),maxRadius:n.readFloat64(),minRadius:n.readFloat64(),axis:n.readArrayFloat32(new Float32Array(3)),normal:n.readArrayFloat32(new Float32Array(3))});break;case 3:h.set(_,{type:3,center:n.readArrayFloat32(new Float32Array(3)),radius:n.readFloat64(),startAngle:n.readFloat64(),endAngle:n.readFloat64(),axis:n.readArrayFloat32(new Float32Array(3)),normal:n.readArrayFloat32(new Float32Array(3))});break;case 4:h.set(_,{type:4,center:n.readArrayFloat32(new Float32Array(3)),maxRadius:n.readFloat64(),minRadius:n.readFloat64(),startAngle:n.readFloat64(),endAngle:n.readFloat64(),axis:n.readArrayFloat32(new Float32Array(3)),normal:n.readArrayFloat32(new Float32Array(3))});break;default:c.set(_,{type:5})}}for(var L=0;L<X;L++){var q=n.readIDType(t,e.idLength);u.set(q,{position:n.readArrayFloat32(new Float32Array(3))})}}return{mask:e.mask,bodies:a||[],faces:o||[],loops:s||[],edges:l||[],vertexs:d||[],surfaces:c,curves:h,points:u}}},function(){function e(){this.symbolString="\n        // Canvas Width and Height\n                60 60\n                \n        /*Symbol Map*/\n        /* Geometric Tolerance */\n        # ⎯ 23E4\n        # ⏤ 23E4\n        # ⏥ 23E5\n        # ⃝ 25EF\n        # ◯ 25EF\n        # ⌭ 232D\n        # ◠ 2312\n        # ⌒ 2312\n        # ⌓ 2313\n        # ∥ 2225\n        # ⟂ 27C2\n        # ⦟ 2220\n        # ∠ 2220\n        # ⌖ 2316\n        # ⦾ 233E\n        # ⌾ 233E\n        # ⌯ 232F\n        # ⭧ 2197\n        # ↗ 2197\n        # ⌰ 2330\n        # Ⓟ 24C5\n        # Ⓜ 24C2\n        # Ⓛ 24C1\n        # Ⓕ 24BB\n        # Ⓔ 24BA\n        # Ⓡ 24C7\n\n        /* Welding Symbol */\n        # ^11 F058\n        # ^12 F03C\n        # ^13 F037\n        # ^14 F03D\n        # ^15 F008\n        # ^16 F03B\n        # ^17 F040\n        # ^18 F041\n        # ^19 F042\n        # ^20 F035\n        # ^21 FF0B\n        # ^22 F038\n        # ^23 F039\n        # ^24 F03E\n        # ^25 F03F\n        # ^26 F060\n        # ^27 F054\n        # ^28 F13C\n        # ^29 F13D\n        # ^30 F13E\n        # ^31 FF00\n        # ^32 FF01\n        # ^33 FF02\n        # ^34 FF03\n        # ^35 FF04\n        # ^36 F043\n        # ^37 F045\n        # ^38 F044\n        # ^39 F053\n        # ^40 FF05\n        # ^41 FF06\n        # ^42 FF07\n        # ^43 FF08\n        # ^44 FF09\n        # ^45 FF0A\n\n        /* Hole */\n        // Diameter\n        $ 2300    24  00   12  60   128 000  16 -30\n                00  02  -01  04  -01  03  -01  02  -02  03  -03  03  -03  02\n                -02  01  -03  01  -04  01  -02  00\n                -02  00  -04 -01  -03 -01  -02 -01  -03 -02  -03 -03  -02 -03\n                -01 -02  -01 -03  -01 -04   00 -02\n                00 -02   01 -04   01 -03   01 -02   02 -03   03 -03   03 -02\n                02 -01   03 -01   04 -01   02  00\n                02  00   04  01   03  01   02  01   03  02   03  03   02  03\n                01  02   01  03   01  04   00  02  ;\n        // Spot Hole\n        $ 2334    00  60   00 -60   60  00   00  60  ;\n        // Depth Hole\n        $ 21A7    00  60   60  00  128 000  -30  00   00 -60  128 000  -21  36\n                21 -36   21  36  ;\n        // Sink Hole\n        $ 2335    00  30   30 -30   30  30  ;\n\n        /* Geometric Tolerance */\n        // Straightness From 2500 DISA:23AF\n        $ 23E4  -12  30   42  00   42  00  ;\n        // Planeness From F000\n        $ 23E5  -12  00   60  00   24  60  -60  00  -24 -60  ;\n        // Roundness DISA:20DD\n        $ 25EF    00  26   01 -06   02 -06   02 -05   04 -06   04 -05   05 -04\n                06 -04   05 -02   06 -02   06 -01   08  00   06  01   06  02\n                05  02   06  04   05  04   04  05   04  06   02  05   02  06\n                01  06   00  08  -01  06  -02  06  -02  05  -04  06  -04  05\n                -05  04  -06  04  -05  02  -06  02  -06  01  -08  00  -06 -01\n                -06 -02  -05 -02  -06 -04  -05 -04  -04 -05  -04 -06  -02 -05\n                -02 -06  -01 -06   00 -08  ;\n        // Cylindricity\n        $ 232D   -12 -12   18  42   18  42  128  00   12 -42  128 000   00 -42\n                18  42   18  42   128 000 -20 -42\n                00  02  -01  04  -01  03  -01  02  -02  03  -03  03  -03  02\n                -02  01  -03  01  -04  01  -02  00\n                -02  00  -04 -01  -03 -01  -02 -01  -03 -02  -03 -03  -02 -03\n                -01 -02  -01 -03  -01 -04   00 -02\n                00 -02   01 -04   01 -03   01 -02   02 -03   03 -03   03 -02\n                02 -01   03 -01   04 -01   02  00\n                02  00   04  01   03  01   02  01   03  02   03  03   02  03\n                01  02   01  03   01  04   00  02  ;\n        // Line Profile DISA:25E0\n        $ 2312    36  12   128 000  36  00   00  04  -01  06  -01  03  -01  03\n                -02  04  -03  05  -02  03  -02  02  -02  02  -03  02  -05  03\n                -04  02  -03  01  -03  01  -06  01  -04  00  -04  00  -06 -01\n                -03 -01  -03 -01  -04 -02  -05 -03  -03 -02  -02 -02  -02 -02\n                -02 -03  -03 -05  -02 -04  -01 -03  -01 -03  -01 -06   00 -04   ;\n        // Surface Profile\n        $ 2313   -12  12   42  00   42  00   00  04  -01  06  -01  03  -01  03\n                -02  04  -03  05  -02  03  -02  02  -02  02  -03  02  -05  03\n                -04  02  -03  01  -03  01  -06  01  -04  00  -04  00  -06 -01\n                -03 -01  -03 -01  -04 -02  -05 -03  -03 -02  -02 -02  -02 -02\n                -02 -03  -03 -05  -02 -04  -01 -03  -01 -03  -01 -06   00 -04   ;\n        // Parallelism\n        $ 2225   -06 -12   18  42   18  42  128 000   00 -42  128 000   00 -42\n                18  42   18  42   ;\n        // perpendicularity From 22A5\n        $ 27C2   -12 -12   42  00  42  00  128 000 -42 00  00 42  00 42  ;\n        // Gradient DISA:299F\n        $ 2220   -12 -12   42  00   42  00  128  000 -45  00  -42  00   42  42\n                42  42   ;\n        // Position\n        $ 2316   -12  30   42  00   42  00  128  00  -42 -42   00  42   00  42\n                128 000  22 -42\n                00  02  -01  04  -01  03  -01  02  -02  03  -03  03  -03  02\n                -02  01  -03  01  -04  01  -02  00\n                -02  00  -04 -01  -03 -01  -02 -01  -03 -02  -03 -03  -02 -03\n                -01 -02  -01 -03  -01 -04   00 -02\n                00 -02   01 -04   01 -03   01 -02   02 -03   03 -03   03 -02\n                02 -01   03 -01   04 -01   02  00\n                02  00   04  01   03  01   02  01   03  02   03  03   02  03\n                01  02   01  03   01  04   00  02  ;\n        // Axiality DISA:29BE\n        $ 233E    36  30   128 000  36  00   00  04  -01  06  -01  03  -01  03\n                -02  04  -03  05  -02  03  -02  02  -02  02  -03  02  -05  03\n                -04  02  -03  01  -03  01  -06  01  -04  00  -04  00  -06 -01\n                -03 -01  -03 -01  -04 -02  -05 -03  -03 -02  -02 -02  -02 -02\n                -02 -03  -03 -05  -02 -04  -01 -03  -01 -03  -01 -06   00 -04\n                00 -04   01 -06   01 -03   01 -03   02 -04   03 -05   02 -03\n                02 -02   02 -02   03 -02   05 -03   04 -02   03 -01   03 -01\n                06 -01   04  00   04  00   06  01   03  01   03  01   04  02\n                05  03   03  02   02  02   02  02   02  03   03  05   02  04\n                01  03   01  03   01  06   00  04  128  000 -20  00\n                00  02  -01  04  -01  03  -01  02  -02  03  -03  03  -03  02\n                -02  01  -03  01  -04  01  -02  00\n                -02  00  -04 -01  -03 -01  -02 -01  -03 -02  -03 -03  -02 -03\n                -01 -02  -01 -03  -01 -04   00 -02\n                00 -02   01 -04   01 -03   01 -02   02 -03   03 -03   03 -02\n                02 -01   03 -01   04 -01   02  00\n                02  00   04  01   03  01   02  01   03  02   03  03   02  03\n                01  02   01  03   01  04   00  02  ;\n        // Symmetry\n        $ 232F    06  06   48  00  128 000 -40 24 128 000 -26 00  42 00\n                42  00   128 000 -40 24  128 000 -26 00  48 00  ;\n        // Circular Runout DISA:2B67\n        $ 2197    12 -12   15  45   15  42  -18 -33   128 000  18  33  -06 -36 ;\n        // Total Runout\n        $ 2330   -12 -12   15  42   15  42  -18 -33  128  00   18  33  -06 -36\n                128 000 -24 -48   54  00   15  42   15  42  -18 -33  128  000\n                18  33  -06 -36  ;\n        // Projected tolerance zone\n        $ 24C5   -12  28   01 -06   02 -06   02 -05   04 -06   04 -05   05 -04\n                06 -04   05 -02   06 -02   06 -01   08  00   06  01   06  02\n                05  02   06  04   05  04   04  05   04  06   02  05   02  06\n                01  06   00  08  -01  06  -02  06  -02  05  -04  06  -04  05\n                -05  04  -06  04  -05  02  -06  02  -06  01  -08  00  -06 -01\n                -06 -02  -05 -02  -06 -04  -05 -04  -04 -05  -04 -06  -02 -05\n                -02 -06  -01 -06   00 -08  128 000   27  00\n                36  00   08  08   00  16  -08  08  -36  00   00 -60  ;\n        // maximum material requirement\n        $ 24C2   -12  25   01 -06   02 -06   02 -05   04 -06   04 -05   05 -04\n                06 -04   05 -02   06 -02   06 -01   08  00   06  01   06  02\n                05  02   06  04   05  04   04  05   04  06   02  05   02  06\n                01  06   00  08  -01  06  -02  06  -02  05  -04  06  -04  05\n                -05  04  -06  04  -05  02  -06  02  -06  01  -08  00  -06 -01\n                -06 -02  -05 -02  -06 -04  -05 -04  -04 -05  -04 -06  -02 -05\n                -02 -06  -01 -06   00 -08  128 000   22 -25\n                00  60   22 -36   22  36   00 -60  ;\n        // minimum material requirement\n        $ 24C1   -12  26   01 -06   02 -06   02 -05   04 -06   04 -05   05 -04\n                06 -04   05 -02   06 -02   06 -01   08  00   06  01   06  02\n                05  02   06  04   05  04   04  05   04  06   02  05   02  06\n                01  06   00  08  -01  06  -02  06  -02  05  -04  06  -04  05\n                -05  04  -06  04  -05  02  -06  02  -06  01  -08  00  -06 -01\n                -06 -02  -05 -02  -06 -04  -05 -04  -04 -05  -04 -06  -02 -05\n                -02 -06  -01 -06   00 -08  128 000   27  34\n                00 -60   44  00  ;\n        // Free state condition\n        $ 24BB   -12  25   01 -06   02 -06   02 -05   04 -06   04 -05   05 -04\n                06 -04   05 -02   06 -02   06 -01   08  00   06  01   06  02\n                05  02   06  04   05  04   04  05   04  06   02  05   02  06\n                01  06   00  08  -01  06  -02  06  -02  05  -04  06  -04  05\n                -05  04  -06  04  -05  02  -06  02  -06  01  -08  00  -06 -01\n                -06 -02  -05 -02  -06 -04  -05 -04  -04 -05  -04 -06  -02 -05\n                -02 -06  -01 -06   00 -08  128 000   20  11\n                32  00  128 000   12  24  -44  00   00 -60  ;\n        // envelope requirement\n        $ 24BA   -12  25   01 -06   02 -06   02 -05   04 -06   04 -05   05 -04\n                06 -04   05 -02   06 -02   06 -01   08  00   06  01   06  02\n                05  02   06  04   05  04   04  05   04  06   02  05   02  06\n                01  06   00  08  -01  06  -02  06  -02  05  -04  06  -04  05\n                -05  04  -06  04  -05  02  -06  02  -06  01  -08  00  -06 -01\n                -06 -02  -05 -02  -06 -04  -05 -04  -04 -05  -04 -06  -02 -05\n                -02 -06  -01 -06   00 -08  128 000   24  06\n                36  00  128 000   08  28  -44  00   00 -60   44  00  ;\n        // Reversible requirement\n        $ 24C7   -12  25   01 -06   02 -06   02 -05   04 -06   04 -05   05 -04\n                06 -04   05 -02   06 -02   06 -01   08  00   06  01   06  02\n                05  02   06  04   05  04   04  05   04  06   02  05   02  06\n                01  06   00  08  -01  06  -02  06  -02  05  -04  06  -04  05\n                -05  04  -06  04  -05  02  -06  02  -06  01  -08  00  -06 -01\n                -06 -02  -05 -02  -06 -04  -05 -04  -04 -05  -04 -06  -02 -05\n                -02 -06  -01 -06   00 -08  128 000\n                25 -26   00  60   36  00   08 -08   00 -16  -08 -08  -36  00\n                128 000   28  00   16 -28  ;\n                \n        /* Welding Symbol */\n        // 卷边焊缝 DISA:^11\n        $ F058    27  28  -1  -7  -2  -6  -2  -3  -3  -4  -4  -3  -6  -3\n                -3  -1  -7  -1  128  0  34  28  1   -7   2  -6   2  -3\n                3  -4   4  -3   6  -3   3  -1  7   -1 ;\n        // I形焊缝 DISA:^12\n        $ F03C    16   0    0  60  128   0   28   0    0 -60 ;\n        // V形焊缝 DISA:^13\n        $ F037   -18  48  48  -48   48  48 ;\n        // 单边V形焊缝 DISA:^144\n        $ F03D     6  48    0 -48   48  48 ;\n        // 带钝边V形焊缝 DISA:^15\n        $ F008    00  60   30 -30  128 000   00 -30   00  30   30  30  ;\n        // 带钝边单边V形焊缝 DISA:^16\n        $ F03B     6   0    0  60  128   0    0 -30   30  30 ;\n        // 带钝边U形焊缝 DISA:^17\n        $ F040     6  60    1  -7   2   -6    2  -3    3  -4    4  -3    6  -3\n                3  -1    7  -1   7    1    3   1    6   3    4   3    3   4\n                2   3    2   6   1    7  128   0  -28 -28    0 -32 ;\n        // 带钝边J形焊缝 DISA:^18\n        $ F041    16   0    0  60 128    0  0   -28    7   1    3    1   6   3\n                4   3    3   4    2   3    2   6    1   7 ;\n        // 封底焊缝 DISA:^19\n        $ F042    60   0    6   0  -36   0  -36   0    4   2    6   3    6   2\n                4   1    6   1   10   1   10  -1    6  -1    4  -1    6  -2\n                6  -3    4  -2 ;\n        // 角焊缝 DISA:^20\n        $ F035     6   0  48    0  -48  48    0 -48 ;\n        // 塞焊缝或槽焊缝 DISA:^21\n        $ FF0B     2   0   0  22  56   0   0 -22   ;\n        // 点焊缝 DISA:^22\n        $ F038    30   0    7   1    6   2    5   3    5   5    4   6    2   6\n                1   7   -1   7   -2   6   -4   6   -5   5   -5   3   -6   2\n                -7   1   -7  -1   -6  -2   -5  -3   -5  -5   -4  -6   -2  -6\n                -1  -7   1   -7    2  -6    4  -6    5  -5    5  -3    6  -2\n                7  -1 ;\n        // 缝焊缝 DISA:^23\n        $ F039    30   0    7   1    6   2    5   3    5   5    4   6    2   6\n                1   7   -1   7   -2   6   -4   6   -5   5   -5   3   -6   2\n                -7   1   -7  -1   -6  -2   -5  -3   -5  -5   -4  -6   -2  -6\n                -1  -7    1  -7    2  -6    4  -6    5  -5    5  -3    6  -2\n                7  -1  128   0  -44  16   44   0   44   0  128   0    0  28\n                -44   0  -44   0 ;\n        // 陡边V形焊缝 DISA:^24\n        $ F03E     2   0   40   0  128   0    0  60  -10 -60  128   0  -20   0\n                -10  60 ;\n        // 陡边单V形焊缝 DISA:25\n        $ F03F    12  60    0 -60   20   0  128   0  -10   0   10  60 ;\t\n        // 端焊缝 DISA:^26\n        $ F060    00  00   00  60   30  00   00 -60  128  00   30  00   00  60\n                -30 00 ;\n        // 堆焊缝 DISA:^27\n        $ F054    -8  0\n                1  5 2  4 3  3 4  2 5  1 5 -1 4 -2 3 -3 2 -4 1 -5\n                1  5 2  4 3  3 4  2 5  1 5 -1 4 -2 3 -3 2 -4 1 -5 ;\n        // 平面连接 DISA:^28\n        $ F13C    00  15   60  00  128 000\n                00  18  -60  00 ;\n        // 斜面连接 DISA:^29\n        $ F13D    00  00   60  35  128 000\n                00  23  -60 -35 ;\n        // 折叠连接 DISA:^30\n        $ F13E    60  00  -36  00\n                -05  00  -04  02  -04  02  -04  03  -03  04  -02  04  -02  04   00  05\n                00  05   02  04   02  04   03  04   04  03   04  02   04  02   05  00\n                18  00  128 000\n                -18 -18   12  00\n                05  00   04  02   04  02   04  03   03  04   02  04   02  04   00  05\n                00  05  -02  04  -02  04  -03  04  -04  03  -04  02  -04  02  -05  00\n                -36  00 ;\n        // 双面V形焊缝（X焊缝） DISA:^31\n        $ FF00    08  00   44  60  128 000  -44  00   44 -60  ; \n        // 双面单V形焊缝（K焊缝） DISA:^32\n        $ FF01    08  60   00 -60  128 000   00  30   30  30  128 000  -30 -30\n                30 -30  ;\n        // 带钝边的双面V形焊缝 DISA:^33\n        $ FF02    15  60   15 -15   15  15  128 000  -15 -15    0 -30  -15 -15  128 000\n                15  15   15 -15 ;\n        // 带钝边的双面单V形焊缝（ DISA:^34\n        $ FF03    15  60    0 -60  128 000    0  20   20 -20  128 000  -20  40   20  20 ;\n        // 双面U形焊缝 DISA:^35\n        $ FF04    10  60  \n                0  -4  1  -3  1 -3  2 -3  3 -3  3 -2  3 -1  3 -1  4 0  3  0  3  1  4  1  2  2  3  3  2  2  1  4  1  3 1  3 \n                128 00  0 -60\n                -1   3 -1   3 -1  4 -2  2 -3  3 -2  2 -4  1 -3  1 -3 1 -4 -1 -3 -1 -3 -1 -3 -2 -3 -3 -2 -2 -1 -4 -1 -3 0 -3 \n                128 00 20  20  0 20 ;\n        // 平面 DISA:^36\n        $ F043    -6   0   36   0   36   0 ;\n        // 凹面 DISA:^37\n        $ F045    -6  10    4  -2    6  -3    6  -2    4  -1    6  -1   10  -1\n                10   1    6   1    4   1    6   2    6   3    4   2 ;\n        // 凸面 DISA:^38\n        $ F044    -6   0    4   2    6   3    6   2    4   1    6   1   10   1\n                10  -1    6  -1    4  -1    6  -2    6  -3    4  -2 ;\n        // 圆滑过渡 DISA:^39\n        $ F053     0  15\n                1 -5 2 -4 3 -3 4 -2 5 -1 5 1 4 2 3 3 2 4 1 5 0 45 128 0 0 -45\n                1 -5 2 -4 3 -3 4 -2 5 -1 5 1 4 2 3 3 2 4 1 5 ;\n        // 永久衬垫 DISA:^40\n        $ FF05    10  0 0 40 80  0  0 -40 128 000\n                -50 10 0 20 7 -12  7  12   0 -20 ;\n        // 临时衬垫 DISA:^41\n        $ FF06   -10  0  0 40  80   0   0 -40 128 000\n                -60 10  0 20   7 -12   7  12   0 -20\n                03 00 00 20  12  00  03 -03  00 -5  -03 -03  -12  00;\n        // 三面焊缝 DISA:^42\n        $ FF07    60  60 -60  00  00 -60  60  00 ;\n        // 周围焊缝 DISA:^43\n        $ FF08    30   0    7   1    6   2    5   3    5   5    4   6    2   6\n                1   7   -1   7   -2   6   -4   6   -5   5   -5   3   -6   2\n                -7   1   -7  -1   -6  -2   -5  -3   -5  -5   -4  -6   -2  -6\n                -1  -7   1   -7    2  -6    4  -6    5  -5    5  -3    6  -2\n                7  -1 ;\n        // 现场焊缝 DISA:^44\n        $ FF09    00  00  00  60  40 -20 -40  00 ;\n        // 尾部 DISA:^45\n        $ FF0A    40  80 -40 -40  40 -40 ;\n        ",this.canvasWidth=0,this.canvasHeight=0,this.symbolMap=new Map,this.characterMap=new Map,this.parseSymbolMap()}var t=e.prototype;return t.parseSymbolMap=function(){if(this.symbolString){for(var e=this.symbolString.split("\n"),t=!1,r=null,i=0,n=e.length;i<n;++i){var a=(a=e[i]).trimStart();if(a&&0!==a.length&&"/"!==a[0]){var o=a.split(" ");if(t)if("#"===o[0])this.symbolMap.set(o[1],o[2]);else{a=0;"$"===o[0]&&(this.characterMap.set(o[1],[]),r=o[1],a=2);for(var s=a,l=o.length;s<l;++s)if(0!==o[s].length){if(-1!==o[s].indexOf(";"))break;this.characterMap.get(r).push(parseInt(o[s]))}}else 2===o.length&&(t=!0,this.canvasWidth=parseInt(o[0]),this.canvasHeight=parseInt(o[1]))}}this.symbolString=null}},t.getSymbolMap=function(){return this.symbolMap},t.getCharacterMap=function(){return this.characterMap},t.getCanvasDimension=function(){return[this.canvasWidth,this.canvasHeight]},e}());function da(e,t){return(da=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}function ca(s,l){var d=this;this.x=0,this.y=0,this.width=1,this.height=1,this.viewer=s,this.viewLayout=l,this.view=null,this.children=[],this.split=function(e,t){if(!(e<=1&&t<=1||0<d.children.length))for(var r=d.height/e,i=d.width/t,n=0;n<e;++n)for(var a=0;a<t;++a){var o=new ca(s,l);o.x=d.x+a*i,o.y=d.y+n*r,o.width=i,o.height=r,d.children.push(o)}},this.reset=function(){d.view=null;for(var e=0;e<d.children.length;++e)d.children[e].reset();d.children=[]},this.updateView=function(e,t,r){if(0===d.children.length)d.view||(d.view=new pa(r)),d.view.updateViewSize(e,t,d.x,d.y,d.width,d.height);else for(var i=0,n=0;n<d.children.length;++n)d.children[n].updateView(e,t,r),d.children[n].view.viewId=i,d.children[n].view.camera.viewId=i,i++},this.updateRenderStates=function(e){if(0===d.children.length)d.view.updateRenderStates(e);else{var t=d.viewLayout.getActiveView();t.updateRenderStates(e);for(var r=0;r<d.children.length;++r)t&&d.children[r].view.viewId==t.viewId||d.children[r].updateRenderStates(e)}},this.getCell=function(e,t){var r=d.x,i=r+d.width,n=d.y,a=n+d.height;if(r<e&&e<i&&n<t&&t<a){if(0===d.children.length)return d;for(var o=0;o<d.children.length;++o){var s=d.children[o].getCell(e,t);if(void 0!==s)return s}}},this.getView=function(e){if(0===d.children.length&&d.view)e[e.length]=d.view;else for(var t=0;t<d.children.length;++t)d.children[t].getView(e)},this.isClickInLayout=function(e,t){return ua&&(console.log("The clicked positionX / Y are: "+e+" "+t),console.log("The current view bBox: "+d.x+" "+d.y+" "+(d.x+d.width)+" "+(d.y+d.height))),e>d.x&&e<d.x+d.width&&t>d.y&&t<d.y+d.height}}var ha=function(t){function e(e,y){var l,d=t.call(this,e)||this,A=(d.viewer=e,d.name="DISAModelRequestor",d),n=[],M=new Map,E=[],w=new Map,c=new Map,h=new ta,x=(d.loadModel=function(e){c.clear(),d.addRequest(e,999999,"loadModelInfo")},d.addRequest=function(e,t,r,i){n.push({weight:t,uri:e,operate:r,params:i=void 0===i?{}:i}),void 0===i.ndsModel||c.has(e)||(c.set(e,i.ndsModel),delete i.ndsModel)},function(e){e=c.get(e);return e||(console.log("ndsModel未找到！"),null)}),i=function(){var e,v;return(v="."==De.DISARequestWorkerUrl.charAt(0)?new Worker(De.DISARequestWorkerUrl):(e=new Blob(['importScripts("'+De.DISARequestWorkerUrl+'")'],{type:"application/javascript"}),e=window.URL.createObjectURL(e),new Worker(e))).onmessage=function(e){if("loadModelInfo"===e.data.operate)A.viewer.__addModel(e.data.res);else if("getModelData"===e.data.operate)"successed"===e.data.res.state?M.set(e.data.url,e.data.res):"loading"===e.data.res.state?M.get(e.data.url).state="loading":M.get(e.data.url).state="failed";else if("getBrepData"===e.data.operate)"successed"===e.data.res.state?(M.set(e.data.url,e.data.res),(t=x(e.data.url))&&t.brepManager.tryMergeBrep()):"loading"===e.data.res.state?M.get(e.data.url).state="loading":M.get(e.data.url).state="failed";else if("loadTessChunk"===e.data.operate){if("successed"===e.data.state){for(var t=e.data.url,r=e.data.res,i=w.get(t),n=[],a=0,o=r.vertexDatas.length;a<o;++a){for(var s=new THREE.BufferGeometry,l=r.vertexDatas[a],d=0;d<l.attriDefs.length;++d){var c=l.attriDefs[d],h=l.attributes[d].data;1===c.type?s.addAttribute("position",new THREE.BufferAttribute(h,3,0,!1)):2===c.type?s.addAttribute("normal",new THREE.BufferAttribute(h,3,0,!1)):3===c.type?s.addAttribute("uv",new THREE.BufferAttribute(h,2,0,!1)):c.type}n.push(s)}for(var u=0,p=r.tessellations.length;u<p;++u){var f=r.tessellations[u],m=i.Tesellations[u].ndsGeom,g=n[f.vertexDataIndex];g.attributes.position&&(m.attributes.position=g.attributes.position),g.attributes.normal&&(m.attributes.normal=g.attributes.normal),g.attributes.color&&(m.attributes.color=g.attributes.color),g.attributes.lineDistance&&(m.attributes.lineDistance=g.attributes.lineDistance),f.hasIndex&&(m.setIndex(new THREE.BufferAttribute(f.indice,1)),m.drawRange.count=f.indice.length),m.loaded=!0,m.primitiveType=f.primitiveType,m.startBrepEntIndex=f.startBrepEntIndex,m.brepPrimitiveGroup=f.brepPrimitiveGroup}}w.delete(e.data.url);t=0===E.length&&0===w.size,e=(y.onBufferChunkCallback(t,!0),x(e.data.url));t&&e&&e.afterAllGeomLoaded(),b(e),v.terminate()}},v},u=function(e,t,r){for(var i=new la,n=0,a=e.length;n<a;++n)if(e[n].Symbols)for(var o=0,s=e[n].Symbols.length;o<s;++o)if(!(e[n].Symbols[o].GeomIds&&0<e[n].Symbols[o].GeomIds.length)){var l=e[n].Symbols[o].Position,d=e[n].Symbols[o].Height,c=e[n].Symbols[o].Content,h=e[n].Symbols[o].Rotation,u=new THREE.Color(e[n].Symbols[o].Color[0]/255,e[n].Symbols[o].Color[1]/255,e[n].Symbols[o].Color[2]/255),p=i.getCanvasDimension()[0],f=i.getCanvasDimension()[1],m=1;if(e[n].Symbols[o].Extensions)for(var g=0,v=e[n].Symbols[o].Extensions.length;g<v;++g){var y=e[n].Symbols[o].Extensions[g];-1!==y.indexOf("YMirror")&&(m=-1!==y.indexOf("true")?-1:1)}c=i.getSymbolMap().get(c);if(c){var A=i.getCharacterMap().get(c);if(A){for(var M=0,E=[],w=[],x=!1,b=[0,0],B=0,I=A.length;B<I&&!(I-1<=B);B+=2)128===A[B]&&0===A[B+1]?x=!0:(B<2?(E.push(d*A[B]/p),E.push(d*A[B+1]/f),w.push(M)):x?(E.push(d*(b[0]+A[B])/p),E.push(d*(b[1]+A[B+1])/f),x=!1,w.push(M)):(E.push(d*(b[0]+A[B])/p),E.push(d*(b[1]+A[B+1])/f)),M++,b[0]+=A[B],b[1]+=A[B+1]);for(var T=0,S=w.length;T<S;++T){var R=0,C=0,C=T===S-1?(R=2*w[T],E.length):(R=2*w[T],2*w[T+1]),D=r;if(r++,e[n].Symbols[o].GeomIds||(e[n].Symbols[o].GeomIds=[]),e[n].Symbols[o].GeomIds.push(D),C-R==4){for(var P=new Float32Array(4),H=R;H<C;H+=2)P[H-R]=l[0]+E[H]*Math.cos(h)-E[H+1]*Math.sin(h),P[H+1-R]=l[1]+(E[H]*Math.sin(h)+E[H+1]*Math.cos(h))*m+-5*d/f;t.set(D,{position:P,symbolColor:u}),e[n].Geometries.Lines.push(D)}else if(4<C-R){for(var _=new Float32Array(C-R),L=R;L<C;L+=2)_[L-R]=l[0]+E[L]*Math.cos(h)-E[L+1]*Math.sin(h),_[L+1-R]=l[1]+(E[L]*Math.sin(h)+E[L+1]*Math.cos(h))*m+-5*d/f;t.set(D,{position:_,close:!1,fill:!1,symbolColor:u}),e[n].Geometries.Polylines.push(D)}}}}}},p=function(e,t,r){for(var i=r.getMeshManager(),n=(i.setNumMeshes(e.meshId.length),[]),a=0,o=e.meshId.length;a<o;++a){for(var s=0;s<6;++s)n[s]=e.bbox[6*a+s];i.setMeshFromGeomUuid(e.meshId[a],n,e.geometries[a],0,e.materials[a],e.bodyId[a])}i.setNumLineSegments(t.lineId.length);for(var l=0,d=t.lineId.length;l<d;++l)i.setLineSegmentsFromGeomUuid(t.lineId[l],t.geometries[l],t.bodyId[l],t.materials[l])},b=function(e){0!==E.length&&(c.has(E[0].ChunkBufferUri)||c.set(E[0].ChunkBufferUri,e),i().postMessage({operate:"loadTessChunk",url:E[0].ChunkBufferUri}),w.set(E[0].ChunkBufferUri,E[0]),E.shift())};return d.request=function(){for(var e=0,t=n.length;e<t;++e){var r=n[0];n.shift(),(l=l||i()).postMessage({operate:r.operate,url:r})}},d.initRequest=function(){},d.tryMergeBrep=function(e){var t,r=M.get(e);return r&&"successed"===r.state?(t=h.parseBrep(r.brepData,1),M.delete(e),t):(r&&"loading"!==r.state||(l.postMessage({operate:"getBrepData",url:e}),M.set(e,{state:"asking"})),!1)},d.tryMergeNode=function(e,t){var r=M.get(e);if(c.has(e)||c.set(e,t),r&&"successed"===r.state){var i=function(e){e=e.split("/");return 1===e.length?"./":(e.pop(),e.join("/")+"/")}(e),i=function(e,t,r){d.viewer&&!d.viewer.materialsSetting&&(d.viewer.materialsSetting=new Mt(d.viewer));var i={};if(e.LengthUnit)switch(e.LengthUnit){case"cm":i.LengthUnit="centimeter";break;case"mm":i.LengthUnit="millimeter";break;default:i.LengthUnit=e.LengthUnit}var n,a,o=new ea(d.viewer._loadingManager,t.SDFMaker,d.viewer);return e.Materials&&(i.materials=o.parseMaterial(e.Materials)),e.Fonts&&(i.fonts=o.parseFonts(e.Fonts)),e.TesellationChunks&&(n=o.parseTessellationChunk(e.TesellationChunks,r),E=(i.tesellationChunks=n).chunks,0<e.TesellationChunks.length)&&(n=e.TesellationChunks[0].ChunkBufferUri,t.getGeomManager().bufferChunk[n]=i.tesellationChunks),e.ModelStructure&&(i.bodyNode=o.parseBodyNode(e.ModelStructure,null,e.Metadata,i.tesellationChunks.id2geom,i.materials,t),i.meshes=e.Metadata.meshes,i.lines=e.Metadata.lines),e.spatialIndex&&(i.indexNodes=h.parseSpatialIndex(e.spatialIndex,e.Metadata)),e.BrepDataUri&&t.needsBRep&&(t.brepManager=new jr(d.viewer,d,t),t.brepManager.type=2,t.brepManager.addBrepFileUrl(r+e.BrepDataUri)),e.PmiData&&e.PmiBinData&&t.needsPMI&&(a=(n=h.parsePmiBin(e.PmiBinData,e.Metadata.IdType)).nextPmiGeomIndex,n=n.geomMap,u(e.PmiData,n,a),i.pmiObject=o.parsePMINode(e.PmiData,n,i.fonts,i.materials,i.bodyNode)),e.attriDefineData&&(null!==d.viewer.propertyManager&&void 0!==d.viewer.propertyManager||(d.viewer.propertyManager=d.viewer.modelRequestor.createPropertyManager(d.viewer)),d.viewer.propertyManager.setDisaAttriDefine(e.attriDefineData)),e.AnimationData&&t.needsAnimation,d.viewer.getExtension("NDSAnimationEditExtension")&&1==d.viewer.ndsModel.models.length&&d.viewer.getExtension("NDSAnimationEditExtension").setModelSourceData(e.modelSourceData),1==d.viewer.ndsModel.models.length&&(e.animationFile&&t.needsAnimation?(d.viewer.animationParams={relativePath:r,jsonMain:e},e.animationFileData&&(a=d.viewer.getExtension("NDSAnimationExtension"),d.viewer.AnimationExtension=a)&&(a.animationData=e.animationFileData,a.relativePath=r,d.viewer.dispatchAsyncEvent({type:"AnimationLoaded",data:e.animationFileData}))):(d.viewer.animationParams=null,d.viewer.dispatchAsyncEvent({type:"NoAnimationLoaded"}))),e.Lights&&(i.Lights=o.parseLights(e.Lights)),e.Background&&(i.Background=o.parseBackground(e.Background,r)),e.Watermark&&(i.Watermark=o.parseWaterMark(e.Watermark)),i.params=e.Metadata,i}(r.jsonMain,t,i);if(i.Background&&1==d.viewer.ndsModel.models.length&&(1==i.Background.Type?(d.viewer.setBackGroundColor(i.Background.Color),d.viewer.containsModelBackGroundInfo=!0):2==i.Background.Type&&(d.viewer.containsModelBackGroundInfo=!0,d.viewer.setBackGroundImage(i.Background.Url))),i.Watermark&&i.Watermark.Content&&1==d.viewer.ndsModel.models.length){for(var n=i.Watermark.Content.slice(4),a="",o=0;o<n.length/4;o++){var s=n.slice(4*o,4*(o+1));a+=String.fromCharCode(parseInt(s,16))}d.viewer.watermark="Viewer版本过低，请升级"==a?null:i.Watermark.Content}M.delete(e);i=function(e,t){for(var r=t.getMeshManager(),i=(r.setMaterials(e.materials),r.setMaterialUuids(e.params.materialUuids),e.tesellationChunks.ndsGeometriesArray),n=0,a=i.length;n<a;++n)t.getGeomManager().addGeom(i[n]);p(e.params.meshes,e.params.lines,t),t.getMeshManager().setBodyUuids(e.params.bodyUuids),t.setRootBodyNode(e.bodyNode,e.params.mesh2geom,{}),(new THREE.Object3D).boundingBox=new THREE.Box3(new THREE.Vector3(e.indexNodes[0].bounding[0],e.indexNodes[0].bounding[1],e.indexNodes[0].bounding[2]),new THREE.Vector3(e.indexNodes[0].bounding[3],e.indexNodes[0].bounding[4],e.indexNodes[0].bounding[5])),e.pmiObject&&t.addPMIObject(e.pmiObject),d.viewer.dispatchEvent({type:"BVHInfoEvent",hasbvh:!0}),d.viewer.dispatchEvent({type:"PMIInfoEvent",PMI:!1}),d.viewer.modelUnit=e.LengthUnit||"millimeter";for(var o=0;o<7;++o)b(t);return!0}(i,t);return i&&l&&(l.terminate(),l=void 0),i}return r&&"loading"!==r.state||(l.postMessage({operate:"getModelData",url:e}),M.set(e,{state:"asking"})),!1},d.afterModelLoaded=function(e){},d.resetAllModelLoaded=function(){},d.releaseWorker=function(e,t){void 0===e&&(e=!0),void 0===t&&(t=!1)},d.createBrepManager=function(e,t,r){return new jr(e,t,r)},d.createPropertyManager=function(e){return new xn(e)},d}var r,i;return i=t,(r=e).prototype=Object.create(i.prototype),da(r.prototype.constructor=r,i),e}(Dt),ua=!1,pa=function(){function e(e,t){this.is2DView=!1,this.defaultViewDir="rightUpFront",this.resetToDefaultView=!0;var r=this,i=(this.viewPort={x:0,y:0,width:100,height:100},this.viewPortCanvasSize={x:0,y:0,width:100,height:100},this.viewer=e,this.camera=t||e.camera.clone(),this.defaultCameraInfo=void 0,this.viewBoxDiv=void 0,this.viewBox=void 0,this.renderStates=Object.assign({},e.renderStates),this.modelStates=new Map,this.bInit=!1,this.viewId=0,this.viewName="0",this.connectViewHandler=[],void 0),n=void 0,a=void 0,o=void 0;this.cameraMoveVerticalEventHandler=function(e){var t;r.viewId!==e.originalEventViewId&&("cameraPan"==e.eventType?(r.camera.position.set(r.camera.position.x,e.cameraInfo.position.y,r.camera.position.z),r.camera.target.set(r.camera.target.x,e.cameraInfo.target.y,r.camera.target.z)):"cameraZoom"==e.eventType&&(t=e.activeViewDir+"_"+r.defaultViewDir,void 0!==i&&void 0!==n||(i="right_front"==t||"front_right"==t?r.defaultCameraInfo.position.z-e.defaultCameraInfo.position.x:"left_front"==t||"front_left"==t?r.defaultCameraInfo.position.z+e.defaultCameraInfo.position.x:0,n=r.defaultCameraInfo.near-e.defaultCameraInfo.near),"right_front"==t?(r.camera.position.set(r.camera.position.x,e.cameraInfo.position.y,e.cameraInfo.position.x+i),r.camera.near=e.cameraInfo.near+n,r.camera.far=e.cameraInfo.far-n):"front_right"==t?(r.camera.position.set(e.cameraInfo.position.z-i,e.cameraInfo.position.y,r.camera.position.z),r.camera.near=e.cameraInfo.near+n,r.camera.far=e.cameraInfo.far-n):"left_front"==t?(r.camera.position.set(r.camera.position.x,e.cameraInfo.position.y,-e.cameraInfo.position.x+i),r.camera.near=e.cameraInfo.near+n,r.camera.far=e.cameraInfo.far-n):"front_left"==t&&(r.camera.position.set(-e.cameraInfo.position.z+i,e.cameraInfo.position.y,r.camera.position.z),r.camera.near=e.cameraInfo.near+n,r.camera.far=e.cameraInfo.far-n)),r.resetDefaultRenderStates())},this.cameraMoveHorizontalEventHandler=function(e){var t;r.viewId!==e.originalEventViewId&&("cameraPan"==e.eventType?(r.camera.position.set(e.cameraInfo.position.x,r.camera.position.y,r.camera.position.z),r.camera.target.set(e.cameraInfo.target.x,r.camera.target.y,r.camera.target.z)):"cameraZoom"==e.eventType&&(t=e.activeViewDir+"_"+r.defaultViewDir,void 0!==a&&void 0!==o||(a="front_top"==t?r.defaultCameraInfo.position.y-e.defaultCameraInfo.position.z:"top_front"==t?r.defaultCameraInfo.position.z-e.defaultCameraInfo.position.y:0,o=r.camera.near-e.cameraInfo.near),"front_top"==t?(r.camera.position.set(e.cameraInfo.position.x,e.cameraInfo.position.z+a,r.camera.position.z),r.camera.near=e.cameraInfo.near+o,r.camera.far=e.cameraInfo.far-o):"top_front"==t&&(r.camera.position.set(e.cameraInfo.position.x,r.camera.position.y,e.cameraInfo.position.y+a),r.camera.near=e.cameraInfo.near+o,r.camera.far=e.cameraInfo.far-o)),r.resetDefaultRenderStates())},this.cameraSyncEventHandler=function(e){r.viewId!=e.originalEventViewId&&(e=e.cameraInfo,r.camera.fov=e.fov,r.camera.near=e.near,r.camera.far=e.far,r.camera.position.set(e.position.x,e.position.y,e.position.z),r.camera.up.set(e.up.x,e.up.y,e.up.z),r.camera.setCameraTarget(new THREE.Vector3(e.target.x,e.target.y,e.target.z)),r.camera.isPerspective=e.isPerspective,r.camera.top=e.top,r.camera.bottom=e.bottom,r.camera.left=e.left,r.camera.right=e.right,r.resetDefaultRenderStates())}}var t=e.prototype;return t.getCameraInfo=function(){var e={},t=this.camera,r=(e.fov=t.fov,e.near=t.near,e.far=t.far,e.position={x:t.position.x,y:t.position.y,z:t.position.z},e.up={x:t.up.x,y:t.up.y,z:t.up.z},t.getCameraTarget());return e.target={x:r.x,y:r.y,z:r.z},e.isPerspective=t.isPerspective,e.top=t.top,e.bottom=t.bottom,e.left=t.left,e.right=t.right,e},t.hasInitialized=function(){return this.bInit},t.init=function(){var a=this;if(!this.bInit){this.bInit=!0;for(var e=function(){for(var i={meshSetVisualStates:[],instancedMeshDirtyFlags:[],instancedLineDirtyFlags:[],shouldRenderOutline:void 0},e=a.viewer.ndsModel.models[o],t=(i.shouldRenderOutline=null==a.viewer.selectionOutlinePass?void 0:a.viewer.selectionOutlinePass.shouldRenderOutline,e.getMeshSets()),r=0,n=t.length;r<n;++r)!function(r){i.meshSetVisualStates[r]=Object.assign({},t[r].visualStates),t[r].subscribeVisualStatesCallback&&t[r].subscribeVisualStatesCallback(function(e,t){i.meshSetVisualStates[t=void 0===t?r:t]=Object.assign({},e)})}(r);i.instancedMeshDirtyFlags=[].concat(e.meshManager.instancedMeshDirtyFlags),i.instancedLineDirtyFlags=[].concat(e.meshManager.instancedLineDirtyFlags),a.modelStates.set(e.id,i)},o=0,t=this.viewer.ndsModel.models.length;o<t;++o)e()}},t.setDefaultViewDir=function(e,t){this.defaultViewDir=e,this.viewName=t},t.needsRedraw=function(){return!!this.renderStates.forceClear||!(!this.modelNeedsRedraw()||2==this.viewer.getRenderMode())},t.updateRenderStates=function(e){this.renderStates.forceClear=e.forceClear,this.renderStates.remainTime=e.remainTime,this.renderStates.shouldRenderClipbox=e.shouldRenderClipbox,this.renderStates.shouldRenderClipScene=e.shouldRenderClipScene;for(var t=0,r=this.viewer.ndsModel.models.length;t<r;++t){var i=this.viewer.ndsModel.models[t],i=this.modelStates.get(i.id);void 0!==i&&(i.shouldRenderOutline=void 0===this.viewer.selectionOutlinePass?void 0:this.viewer.selectionOutlinePass.shouldRenderOutline)}},t.modelNeedsRedraw=function(){for(var e=0,t=this.viewer.ndsModel.models.length;e<t;++e){var r=this.viewer.ndsModel.models[e],i=this.modelStates.get(r.id);if(!(r.state<ee.StateType.PREPARED)&&i)for(var n=0,a=i.meshSetVisualStates.length;n<a;++n){var o=i.meshSetVisualStates[n];if(o.dirty&&o.visible)return!0;if(!this.viewer.useObjectEdgeLine&&!this.viewer.singlePartMode&&o.opaqueDrawCount<o.opaqueMeshCount&&8!=this.viewer.getRenderMode())return!0;if(!this.viewer.useObjectEdgeLine&&!this.viewer.singlePartMode&&o.transparentDrawCount<o.transparentMeshCount)return!0;if(5!=this.viewer.getRenderMode()&&8!=this.viewer.getRenderMode()&&o.lineDrawCount<o.lineSegmentCount)return!0}}return!1},t.resetDefaultRenderStates=function(){this.renderStates.forceClear=!0,this.renderStates.remainTime=150,this.renderStates.shouldRenderClipbox=!0,this.renderStates.shouldRenderClipScene=!0},t.updateViewSize=function(e,t,r,i,n,a){this.viewPort.x=e*r,this.viewPort.y=t*i,this.viewPort.width=e*n,this.viewPort.height=t*a;r=0==e?2*this.viewer.renderer.getPixelRatio():this.viewer.renderer.colorTarget.width/e;this.viewPortCanvasSize.x=this.viewPort.x*r,this.viewPortCanvasSize.y=this.viewPort.y*r,this.viewPortCanvasSize.width=this.viewPort.width*r,this.viewPortCanvasSize.height=this.viewPort.height*r},t.apply=function(){this.viewer.camera=this.camera,this.viewer.camera.aspect=this.viewPort.width/this.viewPort.height,this.viewer.camera.updateProjectionMatrix(),this.viewer.setCameraInfo(this.viewer.getCameraInfo()),this.viewer.selectionOutlinePass&&(this.viewer.selectionOutlinePass.renderCamera=this.camera),this.viewBox&&this.viewBoxDiv&&(this.viewer.viewBoxDiv=this.viewBoxDiv,this.viewer.viewBox=this.viewBox,this.viewer.cameraControl.setViewBox(this.viewBox));var e=new THREE.Vector4(this.viewPortCanvasSize.x,this.viewPortCanvasSize.y,this.viewPortCanvasSize.width,this.viewPortCanvasSize.height);this.viewer.renderer.colorTarget.scissorTest=!0,this.viewer.renderer.colorTarget.scissor.copy(e),this.viewer.renderer.colorTarget.viewport.copy(e),this.viewer.renderStates.forceClear=this.renderStates.forceClear,this.viewer.renderStates.remainTime=this.renderStates.remainTime,this.viewer.renderStates.shouldRenderClipbox=this.renderStates.shouldRenderClipbox,this.viewer.renderStates.shouldRenderClipScene=this.renderStates.shouldRenderClipScene,this.viewer.defaultStandardView=this.defaultViewDir;for(var t=0,r=this.viewer.ndsModel.models.length;t<r;++t){var i=this.viewer.ndsModel.models[t],n=this.modelStates.get(i.id);if(!(i.state<ee.StateType.PREPARED)&&n){for(var a=i.getMeshSets(),o=0,s=a.length;o<s;++o)a[o].visualStates=n.meshSetVisualStates[o];i.meshManager.instancedMeshDirtyFlags=n.instancedMeshDirtyFlags,i.meshManager.instancedLineDirtyFlags=n.instancedLineDirtyFlags,i.transparentBodiesDirty=n.transparentBodiesDirty,void 0!==n.shouldRenderOutline&&(this.viewer.selectionOutlinePass.shouldRenderOutline=n.shouldRenderOutline)}}this.resetToDefaultView&&(this.resetToDefaultView=!1,this.viewer.look({type:this.defaultViewDir,smoothTranslation:!1,useOrginal:!1}),this.defaultCameraInfo||(this.defaultCameraInfo=this.getCameraInfo()))},t.applyViewScissorToRenderer=function(){this.viewer.renderer.setViewport(this.viewPort.x,this.viewPort.y,this.viewPort.width,this.viewPort.height),this.viewer.renderer.setScissor(this.viewPort.x,this.viewPort.y,this.viewPort.width,this.viewPort.height),this.viewer.renderer.setScissorTest(!0)},t.revertViewScissorToRenderer=function(){var e=this.viewer.viewManager.getWindowSize();this.viewer.renderer.setViewport(0,0,e.wWidth,e.wHeight),this.viewer.renderer.setScissorTest(!1)},t.subscribeConnectViewEvent=function(e){this.connectViewHandler.push(e)},t.unsubscribeConnectViewEvent=function(t){this.connectViewHandler=this.connectViewHandler.filter(function(e){if(e!==t)return e})},t.clearConnectViewEvent=function(){this.connectViewHandler=[]},t.notifyConnectView=function(t){var r;0!=this.connectViewHandler.length&&(r=this).connectViewHandler.forEach(function(e){e.call(r,t)})},t.dispatchActiveViewChangeEvent=function(){this.viewer&&(this.viewer.dispatchEvent({type:"viewportChange",viewInfo:{viewName:this.viewName,viewSize:this.viewPort}}),De.enableBroadcast)&&De.broadcastMajor&&He.updateBroadcastInfo("ViewManager")},t.initViewBox=function(e,t){var r;this.viewer.hasViewBox&&(r="viewbox_view"+this.viewId,this.viewer.viewBoxMap.has(r)?(this.viewBoxDiv=this.viewer.viewBoxMap.get(r).viewBoxDiv,this.viewer.container.appendChild(this.viewBoxDiv),this.viewBox=this.viewer.viewBoxMap.get(r).viewBox,this.viewBox.updateCameraForView(this)):(this.viewBoxDiv=document.createElement("div"),this.viewBoxDiv.className="viewbox",this.viewBoxDiv.id=r,this.viewer.container.appendChild(this.viewBoxDiv),this.viewBox=new Ne(this.viewer,this.viewer.viewBoxSize,this),this.viewer.viewBoxMap.set(r,{viewBoxDiv:this.viewBoxDiv,viewBox:this.viewBox})),r=e(this.viewPort,t),this.viewBoxDiv.style.right=r.x+"px",this.viewBoxDiv.style.top=r.y+"px",this.displayViewBox(!0),this.enableViewBox(!1))},t.removeViewBox=function(){this.viewBoxDiv&&(this.viewer.container.removeChild(this.viewBoxDiv),this.viewBoxDiv=void 0,this.viewBox=void 0)},t.displayViewBox=function(e){this.viewBoxDiv&&(this.viewBoxDiv.style.visibility=e?"visible":"hidden")},t.refreshViewBox=function(e,t){this.viewBox&&this.viewBoxDiv&&(e=e(this.viewPort,t),this.viewBoxDiv.style.right=e.x+"px",this.viewBoxDiv.style.top=e.y+"px",this.viewBox.refreshCube())},t.enableViewBox=function(e){this.viewBox&&(e||this.viewBoxDiv.addEventListener("mousedown",this.viewer.controls.getOperator().onMouseDown,!1),this.viewBox.enableViewBox(e),e)&&this.viewBoxDiv.removeEventListener("mousedown",this.viewer.controls.getOperator().onMouseDown,!1)},e}(),fa=function(){function e(e){function v(e,t,r,i,n,a){n.strokeStyle=a,n.beginPath(),n.moveTo(e,t),n.lineTo(r,i),n.closePath(),n.stroke()}var y=this,c=(this.viewer=e,this.wWidth=1e3,this.wHeight=1e3,this.row=1,this.col=1,this.activeView=null,this.bConnectView=!1,this.loadBalancer=[],this.preselectViewCoord={x:-1,y:-1},new ca(e,this));this.indirectConnectViewMap=new Map,this.updateOperatorByViewState=function(){y.activeView&&("OpPan"!==y.viewer.controls.getOperator().type&&"OpOrbit"!==y.viewer.controls.getOperator().type?y.setConnectView(!1):y.activeView.is2DView?y.viewer.setOperatorByID("OpPan"):y.viewer.setOperatorByID("OpOrbit"))},this.setWindowSize=function(e,t){y.wWidth=e,y.wHeight=t},this.clear=function(){y.activeView=null,y.indirectConnectViewMap.clear(),c.reset()},this.setLayout=function(e,t){c.split(e,t),y.row=e,y.col=t},this.updateView=function(){c.updateView(y.wWidth,y.wHeight,y.viewer),y.updateDefaultViewState(!0)},this.updateRenderStates=function(e,t){t?(t=y.getActiveView())&&t.updateRenderStates(e):c.updateRenderStates(e)},this.getCell=function(e,t){return c.getCell(e,t)},this.getView=function(e){c.getView(e)},this.preselectActiveView=function(e,t){y.preselectViewCoord.x=e,y.preselectViewCoord.y=t},this.setActiveView=function(e,t){var r=e/y.wWidth,i=1-t/y.wHeight,n=y.preselectViewCoord.x/y.wWidth,a=1-y.preselectViewCoord.y/y.wHeight,e=-1;if(y.activeView&&(e=y.activeView.viewId),0===c.children.length)c.view||y.updateView(),c.isClickInLayout(r,i)&&c.isClickInLayout(n,a)&&y.setAndNotifyActiveViewChange(c.view);else for(var o=0;o<c.children.length;++o){var s=c.children[o],l=s.isClickInLayout(r,i),d=s.isClickInLayout(n,a);if(l){y.activeView&&y.activeView.viewId!==s.view.viewId&&d&&(y.activeView.resetDefaultRenderStates(),y.activeView.enableViewBox(!1),y.setAndNotifyActiveViewChange(s.view));break}}e!=y.activeView.viewId&&y.updateOperatorByViewState(),ua&&y.activeView&&(console.log("Current active view is: "+y.activeView.viewId),console.log("Current active view boundary: "+y.activeView.viewPort.x+" "+(y.activeView.viewPort.width+y.activeView.viewPort.x)+" "+(y.wHeight-y.activeView.viewPort.height-y.activeView.viewPort.y)+" "+(y.wHeight-y.activeView.viewPort.y)))},this.getActiveView=function(){return y.activeView},this.getActiveViewBoundary=function(){if(y.activeView)return{minX:y.activeView.viewPort.x,maxX:y.activeView.viewPort.width+y.activeView.viewPort.x,minY:y.wHeight-y.activeView.viewPort.height-y.activeView.viewPort.y,maxY:y.wHeight-y.activeView.viewPort.y}},this.getSplitLineCoords=function(){var e={horizontalSplit:[],verticalSplit:[]};if(1!=y.row&&1!=y.col){if(1<y.row)for(var t=y.wHeight/y.row,r=1;r<y.row;++r)e.horizontalSplit.push(0),e.horizontalSplit.push(t*r),e.horizontalSplit.push(y.wWidth),e.horizontalSplit.push(t*r);if(1<y.col)for(var i=y.wWidth/y.col,n=1;n<y.col;++n)e.verticalSplit.push(i*n),e.verticalSplit.push(0),e.verticalSplit.push(i*n),e.verticalSplit.push(y.wHeight)}return e},this.setConnectView=function(e){y.bConnectView!=e&&(y.bConnectView=e,y.viewer&&y.viewer.dispatchEvent({type:"viewportDisconnectView",viewInfo:{viewName:y.viewName,disconnectView:!y.bConnectView}}),y.updateDefaultViewState(e),e?y.viewer.renderAllViews():y.viewer.render())},this.getIndirectConnectedView=function(e){if(0!=y.indirectConnectViewMap.size&&y.indirectConnectViewMap.has(e.viewId))return y.indirectConnectViewMap.get(e.viewId)},this.resetCamera=function(){var e=[];y.getView(e);for(var t=0;t<e.length;++t)e[t].resetToDefaultView=!0;y.updateOperatorByViewState(),y.viewer.renderAllViews()},this.initViewBox=function(){var e=[];y.getView(e);for(var t=0;t<e.length;++t)e[t].initViewBox(y.calculateViewBoxPosition,y)},this.removeViewBoxesForAllViews=function(){var e=[];y.getView(e);for(var t=0;t<e.length;++t)e[t].removeViewBox()},this.displayViewBox=function(e){var t=[];y.getView(t);for(var r=0;r<t.length;++r)t[r].displayViewBox(e)},this.refreshViewBox=function(){var e=[];y.getView(e);for(var t=0;t<e.length;++t)e[t].refreshViewBox(y.calculateViewBoxPosition,y)};this.renderActiveViewOutline=function(){var e,t,r,i=y.viewer.renderer.getPixelRatio(),n=y.viewer.canvas2D.getContext("2d"),a=y.getActiveViewBoundary(),o=y.getSplitLineCoords();if(0<o.horizontalSplit.length)for(var s=0;s<o.horizontalSplit.length;s+=4){var l=o.horizontalSplit[s]*i,d=o.horizontalSplit[s+1]*i,c=o.horizontalSplit[s+2]*i,h=o.horizontalSplit[s+3]*i;v(l,d,c,h,n,"#9E9E9E")}if(0<o.verticalSplit.length)for(var u=0;u<o.verticalSplit.length;u+=4){var p=o.verticalSplit[u]*i,f=o.verticalSplit[u+1]*i,m=o.verticalSplit[u+2]*i,g=o.verticalSplit[u+3]*i;v(p,f,m,g,n,"#9E9E9E")}a&&(e=a.minX*i,t=a.maxX*i,r=a.minY*i,a=a.maxY*i,n.strokeStyle="#3C92DE",n.beginPath(),n.lineWidth=2,n.moveTo(e,r),n.lineTo(t,r),n.lineTo(t,a),n.lineTo(e,a),n.lineTo(e,r),n.closePath(),n.stroke(),n.lineWidth=1)}}var t=e.prototype;return t.calculateViewBoxPosition=function(e,t){var r={x:0,y:0};return 2==t.row&&2==t.col?(r.x=e.width-e.x,r.y=e.height-e.y):1==t.row&&2==t.col?r.x=e.width-e.x:2==t.row&&1==t.col&&(r.y=e.height-e.y),r},t.update2DViewState=function(e){if(e&&e.length)if(this.bConnectView)for(var t=0;t<e.length;++t)e[t].is2DView=!0,e[t].resetToDefaultView=!0;else for(var r=0;r<e.length;++r)e[r].is2DView=!1},t.setAndNotifyActiveViewChange=function(e){e&&(this.activeView=e,this.activeView.enableViewBox(!0),this.activeView.dispatchActiveViewChangeEvent())},t.updateConnectViewEvents=function(e,t){for(var r=0;r<t.length;++r)t[r].clearConnectViewEvent();this.indirectConnectViewMap.clear(),this.bConnectView&&("FourPort"==e?(t[0].subscribeConnectViewEvent(t[2].cameraMoveHorizontalEventHandler),t[2].subscribeConnectViewEvent(t[0].cameraMoveHorizontalEventHandler),t[2].subscribeConnectViewEvent(t[3].cameraMoveVerticalEventHandler),t[3].subscribeConnectViewEvent(t[2].cameraMoveVerticalEventHandler),this.indirectConnectViewMap.set(0,t[2]),this.indirectConnectViewMap.set(3,t[2])):"TwoPortVertical"==e?(t[0].subscribeConnectViewEvent(t[1].cameraMoveHorizontalEventHandler),t[1].subscribeConnectViewEvent(t[0].cameraMoveHorizontalEventHandler)):(t[0].subscribeConnectViewEvent(t[1].cameraMoveVerticalEventHandler),t[1].subscribeConnectViewEvent(t[0].cameraMoveVerticalEventHandler)))},t.updateDefaultViewState=function(e){var t,r;void 0===e&&(e=!0),this.row<=1&&this.col<=1||(this.getView(t=[]),r=this.row*this.col,this.loadBalancer.length=r,this.loadBalancer.fill(0),2==this.row&&2==this.col?(t[0].setDefaultViewDir("top","FourPortLfBottom"),t[1].setDefaultViewDir("rightUpFront","FourPortRtBottom"),t[2].setDefaultViewDir("front","FourPortLfTop"),t[3].setDefaultViewDir("left","FourPortRtTop"),this.update2DViewState(t),t[1].is2DView=!1,this.updateConnectViewEvents("FourPort",t),e&&this.setAndNotifyActiveViewChange(this.activeView||t[1])):2==this.row&&1==this.col?(t[0].setDefaultViewDir("front","TwoPortBottom"),t[1].setDefaultViewDir("top","TwoPortTop"),this.update2DViewState(t),this.updateConnectViewEvents("TwoPortVertical",t),e&&this.setAndNotifyActiveViewChange(this.activeView||t[0])):1==this.row&&2==this.col&&(t[0].setDefaultViewDir("front","TwoPortLeft"),t[1].setDefaultViewDir("right","TwoPortRight"),this.update2DViewState(t),this.updateConnectViewEvents("TwoPortHorizonal",t),e)&&this.setAndNotifyActiveViewChange(this.activeView||t[1]),this.updateOperatorByViewState())},e}(),ma=function(){function e(o){var a=this,i=(this.viewer=o,this.bInited=!1,this.bInitViewBox=!1,this.defaultMultiViewZoomSpeed=10,this.updateZoomEvent=void 0,40),n=-1,s=-1,e=void 0,t=new THREE.Color,l=this.createLayout(o),r=(this.isActiveViewInRender=function(){return s==a.getActiveView().viewId},this.update=function(){null!=a.updateZoomEvent&&a.isActiveViewInRender()&&("selectAndZoom"==a.updateZoomEvent.type?a.viewer.controls.getOperator().selectAndZoom(a.updateZoomEvent.x,a.updateZoomEvent.y,!1):"zoomExtents"==a.updateZoomEvent.type&&a.viewer.zoomExtents(!1),a.updateZoomEvent=void 0,a.notifyConnectCameraMove())},this.clearLayout=function(){l.clear()},this.setWindowSize=function(e,t){l.setWindowSize(e,t),a.updateLayout(),a.refreshViewBox()},this.getWindowSize=function(){return{wWidth:l.wWidth,wHeight:l.wHeight}},this.setLayout=function(e,t){l.setLayout(e,t),a.updateLayout()},this.updateLayout=function(){l.updateView()},this.updateViewRenderStates=function(e,t){l.updateRenderStates(e,t=void 0===t?!1:t)},[]),d=(this.getView=function(){return r.length=0,l.getView(r),r},this.getActiveView=function(){return l.getActiveView()},this.preselectActiveView=function(e,t){l.preselectActiveView(e,t)},this.setActiveView=function(e,t){l.setActiveView(e,t)},this.getActiveViewBoundary=function(){return l.getActiveViewBoundary()},this.remapViewCoordinateToFullView=function(e,t){var r,i=a.getActiveViewBoundary();return i?(r=(e-i.minX)*l.col,i=(t-i.minY)*l.row,ua&&(console.log("The current clicked view coordinate: "+e+" "+t),console.log("The current clicked view coordinate [Normalized]: "+r+" "+i)),[r,i]):[e,t]},this.remapViewCoordinateToViewPort=function(e,t){var r,i,n=a.getActiveViewBoundary();return n?(r=e/l.col+n.minX,i=t/l.row+n.minY,r=(r=r>n.maxX?n.maxX:r)<n.minX?n.minX:r,i=(i=i>n.maxY?n.maxY:i)<n.minY?n.minY:i,ua&&(console.log("The current clicked view coordinate: "+e+" "+t),console.log("The current clicked view coordinate [Normalized]: "+r+" "+i)),[r,i]):[e,t]},this.normalizeViewCoordinateToViewPort=function(e,t,r){var i=o.viewManager.getActiveViewBoundary(),n=0,a=0,a=i?(n=(e-r.left-i.minX)/r.width*l.col*2-1,(t-r.top-i.minY)/r.height*l.row*2-1):(n=(e-r.left)/r.width*2-1,(t-r.top)/r.height*2-1);return[n,a]},this.getPanScale=function(){return a.getActiveView().is2DView?{x:2,y:2}:{x:1,y:1}},this.getNextRenderedView=function(){if(a.bInited){var e=a.getActiveView();if(e&&!e.hasInitialized()&&e.init(),e&&e.needsRedraw()&&(l.loadBalancer[e.viewId]<1||a.shouldDisableLoadBalancer(e)))l.loadBalancer[e.viewId]++;else{1<=l.loadBalancer[e.viewId]&&(l.loadBalancer[e.viewId]=0);var t=a.getView();if(t&&1<t.length)for(var r=0;r<t.length;++r)if(t[r].hasInitialized()||t[r].init(),t[r].needsRedraw()&&t[r].viewId!=a.getActiveView().viewId&&t[r].viewId!=n){e=t[r],n=1<a.getActiveView().connectViewHandler.length?e.viewId:-1;break}}return n=-1,s=e.viewId,e}},this.getLayout=function(){return l},this.getLayoutRowCol=function(){return{row:l.row<1?1:l.row,col:l.col<1?1:l.col}},this.getActiveViewCanvasSizeForScreenCapture=function(){var e=a.getActiveView().viewPortCanvasSize,t={},r=a.getLayoutRowCol(),i=r.row>r.col?r.row:r.col;return t.x=e.x/i,t.y=(1==r.row?e.y:e.height-e.y)/i,t.width=e.width/i,t.height=e.height/i,2==r.row&&1==r.col?(t.width=t.width/r.row,t.x+=t.width/2):1==r.row&&2==r.col&&(t.height=t.height/r.col,t.y+=t.height/2),t},this.setConnectView=function(e){e&&a.toOrthographicCamera(),l.setConnectView(e)},this.updateViewConnectByOperator=function(e){a.getActiveView().is2DView&&"OpPan"!=e&&(l.bConnectView=!0,l.updateOperatorByViewState())},this.resetCamera=function(){l.resetCamera()},this.getOrginalCameraInfo=function(){return e},this.updateActiveViewCameraInfo=function(){a.setConnectView(!1),a.viewer.look({smoothTranslation:!1,useOrginal:!0})},this.init=function(){a.bInited=!0,e=a.viewer.camera.getOrginalCameraInfo(),a.viewer.renderer.getClearColor(t),a.viewer.ndsModel.models.forEach(function(e){e.isSketchModel&&(i=20)}),l.setConnectView(!0)},this.initViewBoxForAllViews=function(){a.bInitViewBox||(a.bInitViewBox=!0,l.initViewBox(),a.getActiveView().enableViewBox(!0))},this.removeViewBoxes=function(){var e=a.viewer.container,t=document.getElementById("viewboxMain");t&&e.removeChild(t),l.removeViewBoxesForAllViews(),a.bInitViewBox=!1},this.displayViewBox=function(e){l.displayViewBox(e)},this.refreshViewBox=function(){l.refreshViewBox()},void 0);this.notifyCameraMove=function(t){var e,r=a.getActiveView();r.defaultCameraInfo&&null==d&&(e=function(){r.notifyConnectView({originalEventViewId:r.viewId,eventType:t.eventType,activeViewDir:r.defaultViewDir,cameraInfo:r.getCameraInfo(),defaultCameraInfo:r.defaultCameraInfo});var e=l.getIndirectConnectedView(r);null!=e&&"cameraZoom"==t.eventType&&e.notifyConnectView({originalEventViewId:r.viewId,eventType:t.eventType,activeViewDir:e.defaultViewDir,cameraInfo:e.getCameraInfo(),defaultCameraInfo:e.defaultCameraInfo})},t.immediateUpdate?e():d=setInterval(function(){e(),clearInterval(d),d=void 0},i))},this.notifyConnectCameraMove=function(){l.bConnectView&&a.getActiveView().is2DView&&(a.notifyCameraMove({eventType:"cameraPan",immediateUpdate:!0}),a.notifyCameraMove({eventType:"cameraZoom",immediateUpdate:!0}))},this.toPerspectiveCamera=function(){var e=a.getActiveView();if(e&&!e.camera.IsPerspective()){l.setConnectView(!1);for(var t=a.getView(),r=0;r<t.length;++r)t[r].camera.toPerspective();a.resetCamera()}},this.toOrthographicCamera=function(){var e=a.getActiveView();if(e&&e.camera.IsPerspective()){for(var t=a.getView(),r=0;r<t.length;++r)t[r].camera.toOrthographic();a.viewer.renderAllViews()}},this.clear=function(){a.removeViewBoxes(),l.clear();for(var e=0,t=a.viewer.ndsModel.models.length;e<t;++e)for(var r=a.viewer.ndsModel.models[e].getMeshSets(),i=0,n=r.length;i<n;++i)r[i].clearVisualStatesCallback&&r[i].clearVisualStatesCallback()},this.renderActiveViewOutline=function(){l.renderActiveViewOutline()},this.resetToSingleView=function(){a.setConnectView(!1),a.getActiveView().apply(),a.clear(),a.viewer.initViewBox(),a.viewer.renderer.setClearColor(t,0),a.restoreRenderTargetToSingleView(),e&&a.viewer.camera.setOrginalCameraInfo({center:new THREE.Vector3(e.center.x,e.center.y,e.center.z),up:new THREE.Vector3(e.up.x,e.up.y,e.up.z),position:new THREE.Vector3(e.position.x,e.position.y,e.position.z)})},this.restoreRenderTargetToSingleView=function(){a.viewer.renderer.colorTarget.scissorTest=!1,a.viewer.renderer.colorTarget.scissor.set(0,0,a.viewer.renderer.colorTarget.width,a.viewer.renderer.colorTarget.height),a.viewer.renderer.colorTarget.viewport.set(0,0,a.viewer.renderer.colorTarget.width,a.viewer.renderer.colorTarget.height),a.viewer.renderer.colorTarget.viewport.set(0,0,a.viewer.renderer.colorTarget.width,a.viewer.renderer.colorTarget.height),a.viewer.camera.aspect=a.viewer.renderer.colorTarget.width/a.viewer.renderer.colorTarget.height,a.viewer.camera.updateProjectionMatrix()},this.applyActiveViewState=function(){var e=a.getActiveView();e&&e.apply()}}var t=e.prototype;return t.createLayout=function(e){return new fa(e)},t.shouldDisableLoadBalancer=function(e){return"OpDrag"==this.viewer.getCurrentOperatorID()||!e.is2DView},e}(),ga=function(){function e(){this.EVENT_TYPE={supportMeasureClip:0},this.__isPlaneClipEnabled=!1,this.__clipPlanes=[],this.__clipObjectPositions=[],this.__isBoxClipEnabled=!1,this.__partClipObjects=!1,this.__clippingObjectsUuids=[],this.__clippingObjectsUuidsSet=new Set,this.__unClippingObjectsUuids=[],this.__allowClipRender=!1,this.__showSupplementClip=!1,this.__clipExtensionCallback=void 0,this.__materials=[]}var t=e.prototype;return t.__clearData=function(){this.__clipPlanes=[],this.__clipObjectPositions=[],this.__clippingObjectsUuids=[],this.__clippingObjectsUuidsSet.clear(),this.__unClippingObjectsUuids=[]},t.enablePlaneClip=function(){this.__isPlaneClipEnabled=!0},t.disablePlaneClip=function(){this.__isPlaneClipEnabled=!1,this.__partClipObjects=!1,this.__clearData()},t.registerClipMaterial=function(e){this.__materials.push(e)},t.unregisterClipMaterial=function(e){e=this.__materials.indexOf(e);-1!==e&&this.__materials.splice(e,1)},t.updateClippingObjects=function(e){this.__clippingObjectsUuids=e,this.__clippingObjectsUuidsSet.clear();for(var t=0;t<this.__clippingObjectsUuids.length;++t)this.__clippingObjectsUuidsSet.add(this.__clippingObjectsUuids[t])},t.updatePartClip=function(e,t,r){this.__partClipObjects=e,this.updateClippingObjects(t),this.__unClippingObjectsUuids=r},t.needIncludePartClip=function(e){return!this.isSectionViewEnabled()||(e=e.uuid+"-"+e.ndsModel.id,this.__allowClipRender?this.__clippingObjectsUuidsSet.has(e):!this.__clippingObjectsUuidsSet.has(e))},t.isCurrentNodeClipped=function(e){e=e.uuid+"-"+e.ndsModel.id;return this.__clippingObjectsUuidsSet.has(e)},t.isSectionViewEnabled=function(){return this.__isPlaneClipEnabled},t.isPartClipEnabled=function(){return this.isSectionViewEnabled()&&this.__partClipObjects&&0<this.__clippingObjectsUuids.length},t.containsUnClippedObjects=function(){return 0<this.__unClippingObjectsUuids.length},t.enableClipDraw=function(e,t){if((t=void 0===t?!0:t)&&(this.__allowClipRender=!0),e=e.concat(this.__materials))for(var r=0;r<e.length;++r)this.addClipPlanesToMaterial(e[r]),this.__showSupplementClip!==e[r].clipIntersection&&(e[r].clipIntersection=this.__showSupplementClip)},t.disableClipDraw=function(e,t){if((t=void 0===t?!0:t)&&(this.__allowClipRender=!1),e=e.concat(this.__materials))for(var r=0;r<e.length;++r)e[r].clippingPlanes=[],e[r].clipIntersection=!1},t.showSupplementClip=function(e){this.__showSupplementClip=e},t.getClipPlaneInfo=function(){if(!this.isSectionViewEnabled())return null;for(var e={clipGlobalPlaneObjects:[],clippingPlanes:[]},t=0;t<this.__clipPlanes.length;++t){e.clippingPlanes.push(this.__clipPlanes[t].clone());var r={position:this.__clipObjectPositions[t].clone()};e.clipGlobalPlaneObjects.push(r)}return e},t.isPointBeoforeClipPlanes=function(e){var t=this.getClipPlaneInfo(),r=t.clipGlobalPlaneObjects,i=t.clippingPlanes,n=!1;if(this.__showSupplementClip){n=!0;for(var a=0;a<r.length;a++)var o=r[a].position,s=(s=i[a].normal.clone()).negate(),o=e.clone().sub(o),s=s.dot(o),n=n&&1e-4<s}else for(var l=0;l<r.length;l++){var d=r[l].position,c=i[l].normal.clone(),d=e.clone().sub(d),c=c.dot(d);n=n||c<=-1e-4}return n},t.enableBoxClip=function(){this.__isBoxClipEnabled=!0},t.disableBoxClip=function(){this.__isBoxClipEnabled=!1,this.__clearData()},t.isSectionBoxEnabled=function(){return this.__isBoxClipEnabled},t.setClipPlanes=function(e,t){this.__clipPlanes=e,this.__clipObjectPositions=t},t.getClipBoxInfo=function(){if(this.isSectionBoxEnabled()){for(var e={},t=new THREE.Vector3(-1e4,-1e4,-1e4),r=new THREE.Vector3(1e4,1e4,1e4),i=this.__clipPlanes,n=0;n<i.length;n++).001<Math.abs(i[n].normal.x)?(t.x=Math.max(t.x,-1*i[n].normal.x*i[n].constant),r.x=Math.min(r.x,-1*i[n].normal.x*i[n].constant)):.001<Math.abs(i[n].normal.y)?(t.y=Math.max(t.y,-1*i[n].normal.y*i[n].constant),r.y=Math.min(r.y,-1*i[n].normal.y*i[n].constant)):(t.z=Math.max(t.z,-1*i[n].normal.z*i[n].constant),r.z=Math.min(r.z,-1*i[n].normal.z*i[n].constant));return e.clipbox=new THREE.Box3(r,t),e}},t.addClipPlanesToMaterial=function(e){e&&(null==e.clippingPlanes&&(e.clippingPlanes=[]),e.clippingPlanes=this.__clipPlanes)},t.registerClipExtensionCallback=function(e){this.__clipExtensionCallback=e},t.clearClipPlaneUpdateEvent=function(){this.__clipExtensionCallback=void 0},t.executeClipExtensionCallback=function(e,t){if(this.__clipExtensionCallback)return this.__clipExtensionCallback(e,t)},t.supportMeasureClip=function(){var e=this.executeClipExtensionCallback(this.EVENT_TYPE.supportMeasureClip,void 0);return void 0!==e&&e},t.printDebugInfo=function(){console.log("Current Plane infomation: ======>"),console.log(this.__clipPlanes),console.log(this.__clipObjectPositions),console.log(this.__partClipObjects),console.log(this.__clippingObjectsUuids),console.log(this.__unClippingObjectsUuids)},e}();function va(e,t){return(va=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}THREE.UniformsLib.NdsBatchedNormal={bodyWorldMatrixOffset:{value:0},meshId:{value:new THREE.Vector2},meshId2BodyIdParam:{value:new THREE.Vector2},meshId2BodyIdMap:{value:null},bodyNodeWorldMatrixMap:{value:null},bodyNodeWorldMatrixMapSize:{value:1}},THREE.ShaderLib.NdsBatchedNormal={uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib.NdsBatchedNormal]),vertexShader:"\n    #define NORMAL\n\n  #ifdef BATCHED_MESH\n    int meshId = 0;\n    int color_opacity = 0;\n  #else\n  #ifdef INSTANCE_MESH\n    attribute int meshId;\n  #else\n    uniform ivec2 meshId;\n  #endif\n  #endif\n    //\n    varying vec3 vViewPosition;\n    \n    #include <common>\n    #include <normal_pars_vertex>\n    #include <clipping_planes_pars_vertex>\n    #include <mesh_modelMatrix_map_vertex>\n    \n    void main() {\n      #ifdef USE_BATCHED_MATRIX\n        mat4 modelMatrix = getModelMatrix();\n        mat4 modelViewMatrix = viewMatrix * modelMatrix;\n      #endif\n        mat3 normalMatrix = mat3(transpose(inverse(modelMatrix)));  \n        \n        #include <beginnormal_vertex>\n        //#include <defaultnormal_vertex>\n        vec3 transformedNormal = objectNormal;\n        transformedNormal = normalMatrix * transformedNormal;\n        #include <normal_vertex>\n    \n        #include <begin_vertex>\n        \n        vec4 mvPosition = vec4( transformed, 1.0 );\n        vViewPosition = -(modelMatrix * mvPosition).xyz; //虽然叫vViewPosition  但是不能包含视图矩阵\n        mvPosition = modelViewMatrix * mvPosition;\n\n        #include <clipping_planes_vertex>\n        \n        gl_Position = projectionMatrix * mvPosition;\n    }\n    ",fragmentShader:"\n    #define NORMAL\n\n    #include <packing>\n    #include <normal_pars_fragment>\n    #include <clipping_planes_pars_fragment>\n    varying vec3 vViewPosition;\n\n    void main() {\n        #include <clipping_planes_fragment>\n        #include <normal_fragment_begin>\n\n        gl_FragColor = vec4( packNormalToRGB( normal ), 1.0 );\n    }\n    "};var ya=function(t){function e(){var e=t.call(this,{type:"NdsBatchedNormalMaterial",uniforms:THREE.UniformsUtils.clone(THREE.ShaderLib.NdsBatchedNormal.uniforms),vertexShader:THREE.ShaderLib.NdsBatchedNormal.vertexShader,fragmentShader:THREE.ShaderLib.NdsBatchedNormal.fragmentShader,clipping:!0})||this;return e.isNdsBatchedNormalMaterial=!0,e.flatShading=!1,e.side=THREE.DoubleSide,e.polygonOffset=!0,e.polygonOffsetFactor=1,e.polygonOffsetUnits=1,e.uniformGroupNames=["drawId2MeshIdData","bodyWorldMatrixData"],e}var r,i;return i=t,(r=e).prototype=Object.create(i.prototype),va(r.prototype.constructor=r,i),e}(THREE.ShaderMaterial);function Aa(e,t){return(Aa=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}THREE.UniformsLib.NdsBatchedSurfaceID={bodyWorldMatrixOffset:{value:0},meshId:{value:new THREE.Vector2},meshId2BodyIdParam:{value:new THREE.Vector2},meshId2BodyIdMap:{value:null},bodyNodeWorldMatrixMap:{value:null},bodyNodeWorldMatrixMapSize:{value:1},maxSurfaceId:{value:1}},THREE.ShaderLib.NdsBatchedSurfaceID={uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib.NdsBatchedSurfaceID]),vertexShader:"\n    varying vec3 vColor;   \n    #ifdef BATCHED_MESH\n        int meshId = 0;\n        int color_opacity = 0;\n    #else\n    #ifdef INSTANCE_MESH\n        attribute int meshId;\n    #else\n        uniform ivec2 meshId;\n    #endif\n    #endif\n        \n        #include <common>\n        #include <clipping_planes_pars_vertex>\n        #include <mesh_modelMatrix_map_vertex>\n\n        void main() {\n            vColor = color;\n        #ifdef USE_BATCHED_MATRIX\n            mat4 modelViewMatrix = viewMatrix * getModelMatrix();\n        #endif\n        \n            #include <begin_vertex>\n            \n            vec4 mvPosition = vec4( transformed, 1.0 );\n            mvPosition = modelViewMatrix * mvPosition;\n            \n            #include <clipping_planes_vertex>\n\n            gl_Position = projectionMatrix * mvPosition;\n        }\n        ",fragmentShader:"\n        #include <clipping_planes_pars_fragment>\n        varying vec3 vColor;\n        uniform float maxSurfaceId;\n\n        void main() {\n            #include <clipping_planes_fragment>\n            // Normalize the surfaceId when writing to texture\n            // Surface ID needs rounding as precision can be lost in perspective correct interpolation \n            // - see https://github.com/OmarShehata/webgl-outlines/issues/9 for other solutions eg. flat interpolation.\n            float surfaceId = round(vColor.r) / maxSurfaceId;\n            gl_FragColor = vec4(surfaceId, 0.0, 0.0, 1.0);\n    }\n    ",debugFragmentShader:"\n    #include <clipping_planes_pars_fragment>\n    varying vec2 v_uv;\n    varying vec3 vColor;\n\n    void main() { \n        #include <clipping_planes_fragment>     \n        int surfaceId = int(round(vColor.r) * 100.0);\n        float R = float(surfaceId % 255) / 255.0;\n        float G = float((surfaceId + 50) % 255) / 255.0;\n        float B = float((surfaceId * 20) % 255) / 255.0;\n\n        gl_FragColor = vec4(R, G, B, 1.0);\n    }\n    "};var Ma=function(t){function e(e){return void 0===e&&(e=!1),(e=t.call(this,{type:"NdsBatchedSurfaceIDMaterial",uniforms:THREE.UniformsUtils.clone(THREE.ShaderLib.NdsBatchedSurfaceID.uniforms),vertexShader:THREE.ShaderLib.NdsBatchedSurfaceID.vertexShader,fragmentShader:e?THREE.ShaderLib.NdsBatchedSurfaceID.debugFragmentShader:THREE.ShaderLib.NdsBatchedSurfaceID.fragmentShader,clipping:!0})||this).vertexColors=!0,e.isNdsBatchedSurfaceIDMaterial=!0,e.flatShading=!1,e.uniformGroupNames=["drawId2MeshIdData","bodyWorldMatrixData"],e.polygonOffset=!0,e.polygonOffsetFactor=1,e.polygonOffsetUnits=1,e}var r,i;return i=t,(r=e).prototype=Object.create(i.prototype),Aa(r.prototype.constructor=r,i),e}(THREE.ShaderMaterial);function Ea(e,t){var r,i="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(i)return(i=i.call(e)).next.bind(i);if(Array.isArray(e)||(i=function(e,t){{var r;if(e)return"string"==typeof e?wa(e,t):"Map"===(r="Object"===(r={}.toString.call(e).slice(8,-1))&&e.constructor?e.constructor.name:r)||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?wa(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length)return i&&(e=i),r=0,function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}};throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function wa(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,i=Array(t);r<t;r++)i[r]=e[r];return i}var e=function(){function l(){this.surfaceId=0}var e=l.prototype;return e.getSurfaceIdAttributeByMesh=function(e){e=e.geometry;return this.getSurfaceIdAttributeByGeometry(e,!0)},e.getSurfaceIdAttributeByGeometry=function(e,t){void 0===t&&(t=!1);var r=e.attributes.position;if(l.colorMap.has(r))return t&&(this.surfaceId=l.surfaceIdMap.get(r)),l.colorMap.get(r);for(var i=r.count,n=this._generateSurfaceIds(e),a=[],o=0;o<i;o++){var s=n[o];a.push(s,0,0)}t=new Float32Array(a);return l.colorMap.set(r,t),l.surfaceIdMap.set(r,this.surfaceId),t},e._generateSurfaceIds=function(e){e.attributes.position.count;for(var t=e.index.count,r=e.index.array,l=(e.attributes.position.array,{}),i=0;i<t;i+=3){var n=r[i+0],a=r[i+1],o=r[i+2];s(n,a),s(n,o),s(a,o)}function s(e,t){null==l[e]&&(l[e]=[]),null==l[t]&&(l[t]=[]),-1==l[e].indexOf(t)&&l[e].push(t),-1==l[t].indexOf(e)&&l[t].push(e)}for(var d=Object.keys(l).map(function(e){return Number(e)}),c={},h={};0<d.length;){var u=d.pop();if(!c[u]){for(var u=function(e){var t=[e],r={},i=[];for(;0<t.length;){var n=t.pop();if(!r[n]){var a=l[n];i.push(n),r[n]=!0;for(var o=Ea(a);!(s=o()).done;){var s=s.value;r[s]||t.push(s)}}}return i}(u),p=Ea(u);!(f=p()).done;){var f=f.value;c[f]=!0,h[f]=this.surfaceId}this.surfaceId+=1}}return h},l}(),xa=(e.surfaceIdMap=new Map,e.colorMap=new Map,e);function ba(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,function(e){e=function(e,t){if("object"!=typeof e||!e)return e;var r=e[Symbol.toPrimitive];if(void 0===r)return("string"===t?String:Number)(e);r=r.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}(e,"string");return"symbol"==typeof e?e:e+""}(i.key),i)}}function Ba(e,t){return(Ba=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}function Ia(){this.m_box=new X,this.m_leftChild=-1,this.m_nPrims=0,this.m_startPrim=-1}function Ta(e,t){this.m_box=e,this.m_triangles=t}var Sa=function(n){function e(e,t,r){var i=n.call(this)||this,t=(i.viewer=e,i.renderScene=r,i.resolution=new THREE.Vector2(t.x,t.y),i.needsSwap=!0,i.clearColor=i.viewer.renderer.getClearColor(),i.isDebugSurfaceId=!1,i.isUsingSurfaceIds=!1,i.isUseDepthBuffer=!0,new THREE.DepthTexture),t=new THREE.WebGLRenderTarget(i.resolution.x,i.resolution.y,{depthTexture:t,depthBuffer:!0}),t=(i.surfaceIdOrNormalBuffer=t,i.isUsingSurfaceIds?(i.surfaceFinder=new xa,i.surfaceIdOverrideMaterial=i.getSurfaceIdMaterial(i.isDebugSurfaceId)):i.normalOverrideMaterial=i.getBatchNormalMaterial(),i.surfaceIdOrNormalRenderPass=new B(r,e,null,i.clearColor),new THREE.DepthTexture);i.edgeRenderTarget=new THREE.WebGLRenderTarget(i.resolution.x,i.resolution.y,{depthTexture:t,depthBuffer:!0}),i.simpleScene=new THREE.Scene,i.simpleCamera=new THREE.OrthographicCamera(-1,1,1,-1,0,1),i.fsQuadMaterial=i.getEdgeDetectMaterial(!i.isUsingSurfaceIds&&i.isUseDepthBuffer),i.fsQuad=new THREE.Mesh(new THREE.PlaneGeometry(2,2),null),i.fsQuad.frustumCulled=!1,i.simpleScene.add(i.fsQuad);return i.BlurDirectionX=new THREE.Vector2(1,0),i.BlurDirectionY=new THREE.Vector2(0,1),i.edgeThickness=1,i.separableBlurMaterial=i.getSeperableBlurMaterial(4),i.separableBlurMaterial.uniforms.texSize.value.set(i.resolution.x,i.resolution.y),i.separableBlurMaterial.uniforms.kernelRadius.value=i.edgeThickness,i.overlayMaterial=i.getOverlayMaterial(),i.precentValue=0,i}t=n,(i=e).prototype=Object.create(t.prototype),Ba(i.prototype.constructor=i,t);var t,r,i=e.prototype;return i.addSurfaceIdAttributeToMesh=function(e){this.surfaceFinder.surfaceId=0;var i=this;!function t(e){var r;e.isMesh&&(r=i.surfaceFinder.getSurfaceIdAttributeByMesh(e),e.geometry.isProcess||(e.geometry.setAttribute("color",new THREE.BufferAttribute(r,3)),i.viewer.renderer.renderContext.geometries.update(e.geometry),e.geometry.needsUpdate=!1),e.geometry.isProcess=!0),0<e.children.length&&e.children.forEach(function(e){t(e)})}(e),this.updateMaxSurfaceId(this.surfaceFinder.surfaceId+1)},i.dispose=function(){this.resolution.dispose(),this.surfaceIdOrNormalBuffer.dispose(),this.edgeRenderTarget.dispose(),this.fsQuad.dispose()},i.updateMaxSurfaceId=function(e){this.surfaceIdOverrideMaterial.uniforms.maxSurfaceId.value=e},i.setSize=function(e,t){this.surfaceIdOrNormalBuffer.setSize(e,t),this.edgeRenderTarget.setSize(e,t),this.resolution.set(e,t),this.fsQuadMaterial.uniforms.screenSize.value.set(this.resolution.x,this.resolution.y,1/this.resolution.x,1/this.resolution.y)},i.render=function(e,t,r,i,n,a){var o=this.renderScene.overrideMaterial,s=(this.isUsingSurfaceIds?this.surfaceIdOrNormalRenderPass.overrideMaterial=this.surfaceIdOverrideMaterial:this.surfaceIdOrNormalRenderPass.overrideMaterial=this.normalOverrideMaterial,this),l=(this.surfaceIdOrNormalRenderPass.overrideMaterial&&(this.renderScene.overrideMaterialCallBack=function(e,t){if(s.surfaceIdOrNormalRenderPass.overrideMaterial===t){var r=e.material;if(s.isUsingSurfaceIds?s.addSurfaceIdAttributeToMesh(e):t.flatShading=r.flatShading,!0===r.isNdsBatchedPhongMaterial||!0===r.isNdsBatchedPhysicalMaterial||!0===r.isNdsBatchedDepthMaterial){e=function(e,t){if(void 0!==t.USE_BATCHED_MATRIX&&Object.keys(e).length!==Object.keys(t).length-1||void 0===t.USE_BATCHED_MATRIX&&Object.keys(e).length!==Object.keys(t).length)return!1;for(var r in e)if(e[r]!==t[r])return!1;return!0}(r.defines,t.defines);if(e||(t.defines=Object.assign({},r.defines)),Object.assign(t.defines,{USE_BATCHED_MATRIX:""}),t.extensions=r.extensions,r.uniforms)for(var i in t.uniforms)null!==r.uniforms[i]&&void 0!==r.uniforms[i]&&(t.uniforms[i]=r.uniforms[i]);if(t.uniformsGroups.length=0,r.uniformsGroups&&t.uniformGroupNames)for(var n=0;n<t.uniformGroupNames.length;++n)for(var a=0;a<r.uniformsGroups.length;++a)r.uniformsGroups[a].name===t.uniformGroupNames[n]&&void 0===t.uniformsGroups[n]&&t.uniformsGroups.push(r.uniformsGroups[a]);t.uniformsNeedUpdate=!0,t.uniforms.needsUpdate=!0,t.needsUpdate=!e}else 0!==Object.keys(t.defines).length&&(t.defines={},t.extensions={},t.needsUpdate=!0,t.uniformsGroups=[])}}),this.renderScene.getObjectByName("rotateCenterHelper")),d=!0;l&&(d=l.visible,l.visible=!1);this.viewer.clipDataManager.isSectionViewEnabled()&&this.viewer.clipDataManager.registerClipMaterial(this.surfaceIdOrNormalRenderPass.overrideMaterial),this.surfaceIdOrNormalRenderPass.render(e,null,this.surfaceIdOrNormalBuffer,null,null,5e3,function(){var e=s.viewer.ndsModel.getMeshSets();if(e){for(var t=0,r=0,i=e.length;r<i;++r)e[r].visualStates.dirty&&e[r].visualStates.visible||(t+=1);s.precentValue=t/e.length}}),this.viewer.clipDataManager.isSectionViewEnabled()&&this.viewer.clipDataManager.unregisterClipMaterial(this.surfaceIdOrNormalRenderPass.overrideMaterial),this.renderScene.overrideMaterial=o,l&&(l.visible=d),this.fsQuad.material=this.fsQuadMaterial,!this.isUsingSurfaceIds&&this.isUseDepthBuffer&&(this.fsQuad.material.uniforms.depthBuffer.value=this.surfaceIdOrNormalBuffer.depthTexture),this.fsQuad.material.uniforms.surfaceIdOrNormalBuffer.value=this.surfaceIdOrNormalBuffer.texture,this.fsQuad.material.uniforms.clearColor.value.set(this.clearColor.r,this.clearColor.g,this.clearColor.b,1),this.fsQuad.material.uniforms.cameraNear.value=.1,this.fsQuad.material.uniforms.cameraFar.value=100,this.fsQuad.material.uniforms.screenSize.value.set(this.resolution.x,this.resolution.y,1/this.resolution.x,1/this.resolution.y),this.fsQuad.material.uniforms.outlineColor.value.set(2039583),this.fsQuad.material.uniforms.multiplierParameters.value.x=1,this.fsQuad.material.uniforms.multiplierParameters.value.y=1,this.fsQuad.material.uniforms.multiplierParameters.value.z=1,this.fsQuad.material.uniforms.multiplierParameters.value.w=1,this.fsQuad.material.uniforms.useSurfaceID.value=this.isUsingSurfaceIds?1:0,e.render(this.simpleScene,this.simpleCamera,this.edgeRenderTarget),this.fsQuad.material=this.separableBlurMaterial,this.fsQuad.material.uniforms.colorTexture.value=this.edgeRenderTarget.texture,this.fsQuad.material.uniforms.texSize.value.set(this.resolution.x,this.resolution.y),this.fsQuad.material.uniforms.direction.value=this.BlurDirectionX,e.render(this.simpleScene,this.simpleCamera,t),this.fsQuad.material.uniforms.colorTexture.value=t.texture,this.fsQuad.material.uniforms.direction.value=this.BlurDirectionY,e.render(this.simpleScene,this.simpleCamera,r),this.fsQuad.material=this.overlayMaterial,this.fsQuad.material.uniforms.maskTexture.value=this.edgeRenderTarget.depthTexture,this.fsQuad.material.uniforms.edgeTexture.value=r.texture,this.fsQuad.material.uniforms.edgeStrength.value=this.isUsingSurfaceIds?3:2,e.render(this.simpleScene,this.simpleCamera,t)},i.getEdgeDetectMaterial=function(e){return void 0===e&&(e=!1),new THREE.ShaderMaterial({uniforms:{useSurfaceID:{value:1},depthBuffer:{},surfaceIdOrNormalBuffer:{},outlineColor:{value:new THREE.Color(16777215)},multiplierParameters:{value:new THREE.Vector4(.9,20,1,1)},cameraNear:{value:this.viewer.camera.near},cameraFar:{value:this.viewer.camera.far},screenSize:{value:new THREE.Vector4(this.resolution.x,this.resolution.y,1/this.resolution.x,1/this.resolution.y)},clearColor:{value:new THREE.Vector4(1,1,1,1)}},defines:e?{USE_DEPTHBUFFER:""}:{},vertexShader:this.vertexShader,fragmentShader:this.fragmentShader,depthTest:!0,depthWrite:!0,depthFunc:THREE.AlwaysDepth,blending:THREE.NoBlending})},i.getSeperableBlurMaterial=function(e){return new THREE.ShaderMaterial({defines:{MAX_RADIUS:e},uniforms:{colorTexture:{value:null},texSize:{value:new THREE.Vector2(.5,.5)},direction:{value:new THREE.Vector2(.5,.5)},kernelRadius:{value:1}},vertexShader:"varying vec2 vUv;\n\n\t\t\t\tvoid main() {\n\t\t\t\t\tvUv = uv;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t}",fragmentShader:"#include <common>\n\t\t\t\tvarying vec2 vUv;\n\t\t\t\tuniform sampler2D colorTexture;\n\t\t\t\tuniform vec2 texSize;\n\t\t\t\tuniform vec2 direction;\n\t\t\t\tuniform float kernelRadius;\n\n\t\t\t\tfloat gaussianPdf(in float x, in float sigma) {\n\t\t\t\t\treturn 0.39894 * exp( -0.5 * x * x/( sigma * sigma))/sigma;\n\t\t\t\t}\n\n\t\t\t\tvoid main() {\n\t\t\t\t\tvec2 invSize = 1.0 / texSize;\n\t\t\t\t\tfloat sigma = kernelRadius/2.0;\n\t\t\t\t\tfloat weightSum = gaussianPdf(0.0, sigma);\n\t\t\t\t\tvec4 diffuseSum = texture2D( colorTexture, vUv) * weightSum;\n\t\t\t\t\tvec2 delta = direction * invSize * kernelRadius/float(MAX_RADIUS);\n\t\t\t\t\tvec2 uvOffset = delta;\n\t\t\t\t\tfor( int i = 1; i <= MAX_RADIUS; i ++ ) {\n\t\t\t\t\t\tfloat x = kernelRadius * float(i) / float(MAX_RADIUS);\n\t\t\t\t\t\tfloat w = gaussianPdf(x, sigma);\n\t\t\t\t\t\tvec4 sample1 = texture2D( colorTexture, vUv + uvOffset);\n\t\t\t\t\t\tvec4 sample2 = texture2D( colorTexture, vUv - uvOffset);\n\t\t\t\t\t\tdiffuseSum += ((sample1 + sample2) * w);\n\t\t\t\t\t\tweightSum += (2.0 * w);\n\t\t\t\t\t\tuvOffset += delta;\n\t\t\t\t\t}\n\t\t\t\t\tgl_FragColor = diffuseSum/weightSum;\n\t\t\t\t}",depthTest:!1,depthWrite:!1})},i.getSurfaceIdMaterial=function(e){return new Ma(e=void 0===e?!1:e)},i.getBatchNormalMaterial=function(){return new ya},i.getOverlayMaterial=function(){return new THREE.ShaderMaterial({uniforms:{maskTexture:{value:null},edgeTexture:{value:null},edgeStrength:{value:1}},vertexShader:"varying vec2 vUv;\n\t\t\t\tvoid main() {\n\t\t\t\t\tvUv = uv;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t}",fragmentShader:"varying vec2 vUv;\n\t\t\t\tuniform sampler2D maskTexture;\n\t\t\t\tuniform sampler2D edgeTexture;\n\t\t\t\tuniform float edgeStrength;\n\t\t\t\t\n\t\t\t\tvoid main() {\n\t\t\t\t\tvec4 edgeValue = texture2D(edgeTexture, vUv);\n\t\t\t\t\tvec4 maskColor = texture2D(maskTexture, vUv);\n\t\t\t\t\tfloat mixValue = 0.0;\n\t\t\t\t\tif(maskColor.r < 1.0){\n\t\t\t\t\t\tmixValue = 1.0;\n\t\t\t\t\t}\n\t\t\t\t\tvec4 finalColor = edgeStrength * mixValue * edgeValue;\n\t\t\t\t\tgl_FragColor = finalColor;\n\t\t\t\t}",blending:THREE.NoBlending,transparent:!0})},t=e,(i=[{key:"vertexShader",get:function(){return"\n\t\t\tvarying vec2 vUv;\n\t\t\tvoid main() {\n\t\t\t\tvUv = uv;\n\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n\t\t\t}"}},{key:"fragmentShader",get:function(){return'\n    \t#ifdef USE_DEPTHBUFFER\n\t\t\t#include <packing>\n\t\t\t// The above include imports "perspectiveDepthToViewZ"\n\t\t\t// and other GLSL functions from ThreeJS we need for reading depth.\n\t\t\tuniform sampler2D depthBuffer;\n    \t#endif\n\t\t\tuniform sampler2D surfaceIdOrNormalBuffer;\n\t\t\tuniform float cameraNear;\n\t\t\tuniform float cameraFar;\n\t\t\tuniform vec4 screenSize;\n\t\t\tuniform vec3 outlineColor;\n\t\t\tuniform vec4 multiplierParameters;\n\t\t\tuniform int useSurfaceID;\n      \t\tuniform vec4 clearColor;\n\n\t\t\tvarying vec2 vUv;\n    \t#ifdef USE_DEPTHBUFFER\n\t\t\t// Helper functions for reading from depth buffer.\n\t\t\tfloat readDepth (sampler2D depthSampler, vec2 coord) {\n\t\t\t\tfloat fragCoordZ = texture2D(depthSampler, coord).x;\n\t\t\t\tfloat viewZ = perspectiveDepthToViewZ( fragCoordZ, cameraNear, cameraFar );\n\t\t\t\treturn viewZToOrthographicDepth( viewZ, cameraNear, cameraFar );\n\t\t\t}\n\n\t\t\t// Helper functions for reading normals and depth of neighboring pixels.\n\t\t\tfloat getPixelDepth(int x, int y) {\n\t\t\t\t// screenSize.zw is pixel size \n\t\t\t\t// vUv is current position\n\t\t\t\treturn readDepth(depthBuffer, vUv + screenSize.zw * vec2(x, y));\n\t\t\t}\n    \t#endif\n\t\t\t// "surface value" is either the normal or the "surfaceID"\n\t\t\tvec3 getSurfaceIdOrNormalValue(int x, int y) {\n\t\t\t\tvec3 val = texture2D(surfaceIdOrNormalBuffer, vUv + screenSize.zw * vec2(x, y)).rgb;\n\t\t\t\treturn val;\n\t\t\t}\n\n\t\t\tfloat saturateValue(float num) {\n\t\t\t\treturn clamp(num, 0.0, 1.0);\n\t\t\t}\n\n\t\t\tfloat getSufaceIdOrNormalDiff(vec3 surfaceValue) {\n\t\t\t\tfloat surfaceIdDiff = 0.0;\n\t\t\t\tsurfaceIdDiff += distance(surfaceValue, getSurfaceIdOrNormalValue(1, 0));\n\t\t\t\tsurfaceIdDiff += distance(surfaceValue, getSurfaceIdOrNormalValue(0, 1));\n\t\t\t\tsurfaceIdDiff += distance(surfaceValue, getSurfaceIdOrNormalValue(-1, 0));\n\t\t\t\tsurfaceIdDiff += distance(surfaceValue, getSurfaceIdOrNormalValue(0, -1));\n\n\t\t\t\tsurfaceIdDiff += distance(surfaceValue, getSurfaceIdOrNormalValue(1, 1));\n\t\t\t\tsurfaceIdDiff += distance(surfaceValue, getSurfaceIdOrNormalValue(1, -1));\n\t\t\t\tsurfaceIdDiff += distance(surfaceValue, getSurfaceIdOrNormalValue(-1, 1));\n\t\t\t\tsurfaceIdDiff += distance(surfaceValue, getSurfaceIdOrNormalValue(-1, -1));\n\t\t\t\treturn surfaceIdDiff;\n\t\t\t}\n\n\t\t\tvoid main() {\n        \t\tfloat depthDiff = 0.0;\n      \t#ifdef USE_DEPTHBUFFER\n        \t\t// Apply multiplier & bias to each \n        \t\tfloat depthBias = multiplierParameters.x;\n\t\t\t\tfloat depthMultiplier = multiplierParameters.y;\n\n\t\t\t\tfloat depth = getPixelDepth(0, 0);\n        \t\t// Get the difference between depth of neighboring pixels and current.\n\t\t\t\tdepthDiff += abs(depth - getPixelDepth(1, 0));\n\t\t\t\tdepthDiff += abs(depth - getPixelDepth(-1, 0));\n\t\t\t\tdepthDiff += abs(depth - getPixelDepth(0, 1));\n\t\t\t\tdepthDiff += abs(depth - getPixelDepth(0, -1));\n        \t\tdepthDiff = depthDiff * depthMultiplier;\n\t\t\t\tdepthDiff = saturateValue(depthDiff);\n\t\t\t\tdepthDiff = pow(depthDiff, depthBias);\n      \t#endif\n\t\t\t\t// "surfaceValue" is either the normal or the surfaceId\n\t\t\t\tvec3 surfaceValue = getSurfaceIdOrNormalValue(0, 0);\n\n\t\t\t\t// Get the difference between surface values of neighboring pixels\n\t\t\t\t// and current\n\t\t\t\tfloat surfaceValueDiff = getSufaceIdOrNormalDiff(surfaceValue);\n\t\t\t\t\n\t\t\t\tif (useSurfaceID == 0) {\n        \t\t\t// Apply multiplier & bias to each \n          \t\t\tfloat normalBias = multiplierParameters.z;\n          \t\t\tfloat normalMultiplier = multiplierParameters.w;\n\t\t\t\n\t\t\t\t\t// Apply these params when using\n\t\t\t\t\t// normals instead of surfaceIds\n\t\t\t\t\tsurfaceValueDiff = surfaceValueDiff * normalMultiplier;\n\t\t\t\t\tsurfaceValueDiff = saturateValue(surfaceValueDiff);\n\t\t\t\t\tsurfaceValueDiff = pow(surfaceValueDiff, normalBias);\n\t\t\t\t} else {\n\t\t\t\t\tif (surfaceValueDiff != 0.0) surfaceValueDiff = 1.0;\n\t\t\t\t}\n\n        \t\tfloat outline = step(1.0, surfaceValueDiff + depthDiff);\n\n        \t\tgl_FragColor = vec4(mix(clearColor.xyz, outlineColor, outline).xyz, mix(0.0, 1.0, outline));\n        \t\tgl_FragDepth = mix(0.5, 1.0, 1.0 - outline);\n\t\t\t}'}}])&&ba(t.prototype,i),r&&ba(t,r),Object.defineProperty(t,"prototype",{writable:!1}),t}(u),Ra={name:"BlendShader",uniforms:{tDiffuseSrc:{value:null},tDiffuseDst:{value:null},blendMode:{value:1},uvOffsetScale:{value:new THREE.Vector4(0,0,1,1)}},vertexShader:"\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvUv = uv;\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}",fragmentShader:"\n\t\tuniform sampler2D tDiffuseSrc;\n\t\tuniform sampler2D tDiffuseDst;\n\t\tuniform int blendMode;\n\t\tuniform vec4 uvOffsetScale;\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvec4 srcColor = texture2D( tDiffuseSrc, vUv );\n\t\t\tvec4 dstColor = texture2D( tDiffuseDst, vUv * uvOffsetScale.zw + uvOffsetScale.xy);\n\t\t\tvec4 finalColor;\n\t\t\tif(blendMode == 1){\n\t\t\t\tfinalColor = srcColor * srcColor.a + dstColor * (1.0 - srcColor.a);\n\t\t\t}else if(blendMode == 2){\n\t\t\t\tfinalColor = srcColor * dstColor;\n\t\t\t}else{\n\t\t\t\tfinalColor = srcColor;\n\t\t\t}\n\t\t\tgl_FragColor = finalColor;\n\t\t}"},Ca={uniforms:{tDiffuse:{type:"t",value:null},opacity:{type:"f",value:1},tDepth:{type:"t",value:null}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float opacity;","uniform sampler2D tDiffuse;","uniform sampler2D tDepth;","varying vec2 vUv;","void main() {","vec4 texel = texture2D( tDiffuse, vUv );","gl_FragColor = opacity * texel;","gl_FragDepth = texture2D( tDepth, vUv ).r;","}"].join("\n")},Da=function(){function e(e,t,r){this.viewer=e,this.resolution=new THREE.Vector2(t.x,t.y);var i=new THREE.DepthTexture;this.renderTarget=new THREE.WebGLRenderTarget(this.resolution.x,this.resolution.y,{depthTexture:i,depthBuffer:!0}),this.composer=new Ve(this.viewer.renderer,this.renderTarget),this.customEdgeDetectLine=new Sa(e,t,r),this.composer.addPass(this.customEdgeDetectLine)}var t=e.prototype;return t.setSize=function(e,t){this.renderTarget.setSize(e,t),this.resolution.set(e,t),this.composer.setSize(e,t),this.customEdgeDetectLine.setSize(e,t)},t.dispose=function(){this.customEdgeDetectLine.dispose(),this.composer.dispose()},t.render=function(e,t){this.composer.render();var r=new Ur(Ra,"tDiffuseSrc"),i=(r.material.blending=THREE.NoBlending,r.material.uniforms.blendMode.value=THREE.NormalBlending,r.material.uniforms.tDiffuseSrc.value=this.composer.readBuffer.texture,r.material.uniforms.tDiffuseDst.value=e.texture,e.viewport.x/e.width),n=e.viewport.z/e.width,a=e.viewport.y/e.height,o=e.viewport.w/e.height;r.material.uniforms.uvOffsetScale.value.x=i,r.material.uniforms.uvOffsetScale.value.y=a,r.material.uniforms.uvOffsetScale.value.z=n,r.material.uniforms.uvOffsetScale.value.w=o,r.material.depthWrite=!1,r.material.depthTest=!1,r.clear=!0,r.render(this.viewer.renderer,this.composer.writeBuffer,this.composer.readBuffer.texture),(t?((i=new Ur(Ca)).material.blending=THREE.NoBlending,i.material.depthWrite=!0,i.material.depthTest=!0,i.clear=!0,i.material.depthFunc=THREE.AlwaysDepth,i.material.uniforms.tDepth.value=this.customEdgeDetectLine.surfaceIdOrNormalBuffer.depthTexture,i):((a=new Ur(je)).material.blending=THREE.NoBlending,a.material.depthWrite=!1,a.material.depthTest=!1,a.clear=!0,a)).render(this.viewer.renderer,e,this.composer.writeBuffer.texture)},e}(),Pa=function(){function e(e,t,r){this.m_value=[],this.m_value[0]=e||0,this.m_value[1]=t||0,this.m_value[2]=r||0}var t=e.prototype;return t.LargestCoordIndex=function(){var e=0;return this.m_value[1]>this.m_value[0]&&(e=1),e=this.m_value[2]>this.m_value[e]?2:e},t.DistanceToPoint=function(e){return Math.sqrt(Math.pow(this.m_value[0]-e.m_value[0],2)+Math.pow(this.m_value[1]-e.m_value[1],2)+Math.pow(this.m_value[2]-e.m_value[2],2))},t.GetValue=function(e){return this.m_value[e]},e}(),X=function(){function r(){this.m_value=[],this.m_value[0]=this.m_value[1]=this.m_value[2]=1/0,this.m_value[3]=this.m_value[4]=this.m_value[5]=-1/0}var e=r.prototype;return e.Init=function(){this.m_value[0]=this.m_value[1]=this.m_value[2]=1/0,this.m_value[3]=this.m_value[4]=this.m_value[5]=-1/0},e.GetCentriod=function(){return new Pa(.5*(this.m_value[0]+this.m_value[3]),.5*(this.m_value[1]+this.m_value[4]),.5*(this.m_value[2]+this.m_value[5]))},e.GetMinMaxPoint=function(e,t){new Pa(this.m_value[0],this.m_value[1],this.m_value[2]),new Pa(this.m_value[3],this.m_value[4],this.m_value[5])},e.SetMinMaxPoint=function(e,t){this.m_value[0]=e.m_value[0],this.m_value[1]=e.m_value[1],this.m_value[2]=e.m_value[2],this.m_value[3]=t.m_value[0],this.m_value[4]=t.m_value[1],this.m_value[5]=t.m_value[2]},e.SetMinMaxPointFromArray=function(e){this.m_value[0]=e[0],this.m_value[1]=e[1],this.m_value[2]=e[2],this.m_value[3]=e[3],this.m_value[4]=e[4],this.m_value[5]=e[5]},e.GetSize=function(){return new Pa(this.m_value[3]-this.m_value[0],this.m_value[4]-this.m_value[1],this.m_value[5]-this.m_value[2])},e.Area=function(){var e=this.m_value[3]-this.m_value[0],t=this.m_value[4]-this.m_value[1],r=this.m_value[5]-this.m_value[2];return e<0||t<0||r<0?0:2*(e*t+t*r+e*r)},e.DiagonalLength=function(){return Math.sqrt(Math.pow(this.m_value[0]-this.m_value[3],2)+Math.pow(this.m_value[1]-this.m_value[4],2)+Math.pow(this.m_value[2]-this.m_value[5],2))},e.AddPoint=function(e){e.m_value[0]<this.m_value[0]&&(this.m_value[0]=e.m_value[0]),e.m_value[0]>this.m_value[3]&&(this.m_value[3]=e.m_value[0]),e.m_value[1]<this.m_value[1]&&(this.m_value[1]=e.m_value[1]),e.m_value[1]>this.m_value[4]&&(this.m_value[4]=e.m_value[1]),e.m_value[2]<this.m_value[2]&&(this.m_value[2]=e.m_value[2]),e.m_value[2]>this.m_value[5]&&(this.m_value[5]=e.m_value[2])},e.AddVector=function(e){this.m_value[0]=Math.min(e.x,this.m_value[0]),this.m_value[1]=Math.min(e.y,this.m_value[1]),this.m_value[2]=Math.min(e.z,this.m_value[2]),this.m_value[3]=Math.max(e.x,this.m_value[3]),this.m_value[4]=Math.max(e.y,this.m_value[4]),this.m_value[5]=Math.max(e.z,this.m_value[5])},e.AddBox=function(e){e.m_value[0]<this.m_value[0]&&(this.m_value[0]=e.m_value[0]),e.m_value[3]>this.m_value[3]&&(this.m_value[3]=e.m_value[3]),e.m_value[1]<this.m_value[1]&&(this.m_value[1]=e.m_value[1]),e.m_value[4]>this.m_value[4]&&(this.m_value[4]=e.m_value[4]),e.m_value[2]<this.m_value[2]&&(this.m_value[2]=e.m_value[2]),e.m_value[5]>this.m_value[5]&&(this.m_value[5]=e.m_value[5])},e.IsIntersectBox=function(e){return!(e.m_value[3]<this.m_value[0]||e.m_value[0]>this.m_value[3]||e.m_value[4]<this.m_value[1]||e.m_value[1]>this.m_value[4]||e.m_value[5]<this.m_value[2]||e.m_value[2]>this.m_value[5])},e.GetValue=function(e){return this.m_value[e]},e.SetFromBox=function(e){this.m_value[0]=e.m_value[0],this.m_value[1]=e.m_value[1],this.m_value[2]=e.m_value[2],this.m_value[3]=e.m_value[3],this.m_value[4]=e.m_value[4],this.m_value[5]=e.m_value[5]},e.MultiplyMatrix=function(e){r.points[0].set(this.m_value[0],this.m_value[1],this.m_value[2]).applyMatrix4(e),r.points[1].set(this.m_value[3],this.m_value[1],this.m_value[2]).applyMatrix4(e),r.points[2].set(this.m_value[3],this.m_value[1],this.m_value[5]).applyMatrix4(e),r.points[3].set(this.m_value[0],this.m_value[1],this.m_value[5]).applyMatrix4(e),r.points[4].set(this.m_value[0],this.m_value[4],this.m_value[2]).applyMatrix4(e),r.points[5].set(this.m_value[3],this.m_value[4],this.m_value[2]).applyMatrix4(e),r.points[6].set(this.m_value[3],this.m_value[4],this.m_value[5]).applyMatrix4(e),r.points[7].set(this.m_value[0],this.m_value[4],this.m_value[5]).applyMatrix4(e),this.Init();for(var t=0;t<8;++t)this.AddVector(r.points[t])},e.toArray=function(){return this.m_value},r}(),Ha=(X.points=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3],function(){function e(){this.m_size=0,this.m_nodes=[],this.m_primIds=[]}var t=e.prototype;return t.Reset=function(){this.m_nodes=[],this.m_primIds=[],this.m_size=0},t.SetNumEstimateNodes=function(e){for(var t=0;t<e;++t){var r=new Ia;this.m_nodes[t]=r}this.m_size=0},t.GetNode=function(e){return this.m_nodes[e]},t.AllocNode=function(e){var t=this.m_nodes.length;if(this.m_size+e>t){var r=t/4;(r=r<16?16:r)<e&&(r=e);for(var i=0;i<r;++i){var n=new Ia;this.m_nodes.push(n)}}t=this.m_size;return this.m_size+=e,t},e}()),_a=function(){function e(e,t){this.m_maxLevel=11,this.m_widthTol=0,this.m_nodeManager=new Ha,this.jsonModel=e,this.bvh=t.bvh,this.MeshIndex=0,this.LineIndex=0,this.geometryToPri=[],this.matrixtem=new THREE.Matrix4;var r=new THREE.Matrix4;this.matrixs=[],r.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this.matrixs.push(r),this.m_boxes=[],this.m_primIds=[],this.m_nPrimTris=[],this.materials=[],e.materials&&(this.materials=e.materials.concat()),this.ndsModel=t,this.UuidToMaterialID={}}var t=e.prototype;return t.Reset=function(){this.m_boxes=[],this.m_primIds=[],this.m_nPrimTris=[]},t.Build=function(){var e=this.jsonModel.bufferchunks;if(null!=e){for(var t=0;t<e.length;++t)for(var r=0;r<e[t].geometries.length;++r){var i,n=e[t].geometries[r];n.triangles&&((i=new X).SetMinMaxPointFromArray(n.box),i=new Ta(i,n.triangles),this.geometryToPri[n.uuid]=i)}this.bvh.meshManager.setNumMeshes(this.jsonModel.object.meshNum),this.bvh.meshManager.setNumLineSegments(this.jsonModel.object.lineNum),this.deepTree(this.jsonModel.object),this.Create(this.m_primIds,this.m_nPrimTris,this.m_boxes,32,32e3),this.BVHconstruct()}},t.Create=function(e,t,r,i,n){var a=r.length;if(this.m_nodeManager.Reset(),a){for(var o=[],s=0;s<a;++s)o[s]=r[s].GetCentriod();for(var l=2*Math.ceil(a/i),d=1;(d*=2)<l;);this.m_nodeManager.SetNumEstimateNodes(d);for(var c=this.m_nodeManager.AllocNode(1),h=this.m_nodeManager.GetNode(c),u=new X,p=new X,f=0;f<a;++f)u.AddBox(r[f]),p.AddPoint(o[f]);for(var m=u.GetSize(),g=(this.m_widthTol=1e-5*m.m_value[m.LargestCoordIndex()],h.m_box=u,h.m_nPrims=a,h.m_startPrim=0,new Array(e.length)),v=0;v<e.length;++v)g[v]=v;this.Subdvide(c,p,r,o,g,t,i,n,0),this.m_nodeManager.m_primIds=g}},t.Subdvide=function(e,t,r,i,n,a,o,s,l){for(var d,c,h,u,p,f=t.GetSize(),m=f.LargestCoordIndex(),g=this.m_nodeManager.GetNode(e),v=0,y=0;y<g.m_nPrims;y++)v+=a[g.m_startPrim+y];g.m_nPrims<o&&v<s||1==g.m_nPrims||l>=this.m_maxLevel||f.m_value[m]<this.m_widthTol||(e=g.m_startPrim,f=g.m_startPrim+g.m_nPrims,u=0,p=new X,d=new X,c=new X,h=new X,u=this.Partition(t,m,r,i,n,e,f,p,d,c,h),t=this.m_nodeManager.AllocNode(2),g.m_leftChild=t,(m=this.m_nodeManager.GetNode(t)).m_box=p,m.m_nPrims=u-e,m.m_startPrim=e,(m=this.m_nodeManager.GetNode(p=t+1)).m_box=d,m.m_nPrims=f-u,m.m_startPrim=u,this.Subdvide(t,c,r,i,n,a,o,s,l+1),this.Subdvide(p,h,r,i,n,a,o,s,l+1))},t.Partition=function(e,t,O,r,i,n,a,F,U,N,V){for(var o=16,G=.99999*(o=a-n<o?a-n:o)/(e.m_value[3+t]-e.m_value[t]),s=[],l=[],d=new Int32Array(o),c=new Int32Array(a-n),h=0;h<o;++h){var k=new X,j=new X;s[h]=k,l[h]=j}for(var u=n;u<a;++u){var p=Math.floor(G*(r[i[u]].m_value[t]-e.m_value[t]));p<0?p=0:o<=p&&(p=o-1),++d[c[u-n]=p],s[p].AddBox(O[i[u]]),l[p].AddPoint(r[i[u]])}var f=[],m=[],g=[],v=[];f[0]=d[0],m[0]=s[0],g[0]=l[0],v[0]=m[0].Area();for(var y=1;y<o-1;++y){f[y]=f[y-1]+d[y];var A=new X,M=new X;A.SetFromBox(m[y-1]),m[y]=A,m[y].AddBox(s[y]),M.SetFromBox(g[y-1]),g[y]=M,g[y].AddBox(l[y]),v[y]=m[y].Area()}var E=[],w=[],x=[],b=[];E[o-1]=d[o-1],w[o-1]=s[o-1],x[o-1]=l[o-1],b[o-1]=w[o-1].Area();for(var B=o-2;0<B;--B){E[B]=E[B+1]+d[B];var I=new X,T=new X;I.SetFromBox(w[B+1]),w[B]=I,w[B].AddBox(s[B]),T.SetFromBox(x[B+1]),x[B]=T,x[B].AddBox(l[B]),b[B]=w[B].Area()}for(var S=f[0]*v[0]+E[1]*b[1],R=0,C=1;C<o-1;++C){var D=f[C]*v[C]+E[C+1]*b[C+1];D<S&&(S=D,R=C)}for(var P=i.slice(n,a),H=0,_=n;_<a;++_)c[_-n]<=R&&(i[n+H]=P[_-n],++H);for(var z=n+H,W=0,L=n;L<a;++L)c[L-n]>R&&(i[z+W]=P[L-n],++W);return F.SetFromBox(m[R]),U.SetFromBox(w[R+1]),N.SetFromBox(g[R]),V.SetFromBox(x[R+1]),z},t.getMatrixId=function(e){for(var t=0,r=this.matrixs.length;t<r;++t)if(e.equals(this.matrixs[t]))return t;return-1},t.ParesLeafNode=function(e,t,r){var i,n,a=e.geometry,r=null!=r?r:0,o=this.UuidToMaterialID[e.material];"Mesh"===e.type?(i=this.geometryToPri[e.geometry])?((n=new X).SetFromBox(i.m_box),n.MultiplyMatrix(t),this.m_boxes[this.MeshIndex]=n,this.m_nPrimTris[this.MeshIndex]=i.m_triangles,this.m_primIds[this.MeshIndex]=this.MeshIndex,this.bvh.meshManager.setMeshFromGeomUuid(this.MeshIndex++,n.toArray(),a,0,o,r)):(t=new X,this.m_boxes[this.MeshIndex]=t,this.m_nPrimTris[this.MeshIndex]=0,this.m_primIds[this.MeshIndex]=this.MeshIndex,this.bvh.meshManager.setMeshFromGeomUuid(this.MeshIndex++,t.toArray(),a,0,o,r)):"LinePieces"===e.type&&this.bvh.meshManager.setLineSegmentsFromGeomUuid(this.LineIndex++,a,r,o)},t.deepTree=function(e){for(var t,r=this.materials.length,i=[],n=0;n<r;++n)t=this.materials[n].uuid,this.UuidToMaterialID[t]=n,i.push(t);this.bvh.meshManager.setMaterialUuids(i);var a=new THREE.Matrix4,o=(a.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),[]);o.push({node:e,nodematrix:a,Parentuuid:null});for(var s=0;s<o.length;++s){var l=o[s];if(null!=l.node.geometry)this.ParesLeafNode(l.node,l.nodematrix,l.Parentuuid);else if(null!=l.node.children&&0<l.node.children.length){l.node.matrix&&(this.matrixtem.fromArray(l.node.matrix),l.nodematrix.multiply(this.matrixtem)),null!=l.node.children[0].geometry&&(l.node.worldMatrix=l.nodematrix);for(var d=0;d<l.node.children.length;++d){var c={node:l.node.children[d],nodematrix:l.nodematrix.clone(),Parentuuid:l.node.uuid};o.push(c)}}}},t.BVHconstruct=function(){for(var e,t,r,i=this.m_nodeManager.m_size,n=(this.bvh.setNumNodes(i),new Float32Array(6)),a=0;a<i;++a){for(var o=0;o<6;++o)n[o]=this.m_nodeManager.m_nodes[a].m_box.m_value[o];e=this.m_nodeManager.m_nodes[a].m_leftChild,t=this.m_nodeManager.m_nodes[a].m_nPrims,r=this.m_nodeManager.m_nodes[a].m_startPrim,this.bvh.setNode(a,n,e,t,r)}this.bvh.setMeshIds(this.m_nodeManager.m_primIds),this.ndsModel.buildMeshSets()},t.Reconstruct=function(e){this.jsonModel=e;for(var t=this.jsonModel.bufferchunks,r=0;r<t.length;++r)for(var i=0;i<t[r].geometries.length;++i){var n,a=t[r].geometries[i];a.triangles&&((n=new X).SetMinMaxPointFromArray(a.box),n=new Ta(n,a.triangles),this.geometryToPri[a.uuid]=n)}this.MeshIndex=this.bvh.meshManager.nMeshes,this.LineIndex=this.bvh.meshManager.nLineSegments,this.bvh.meshManager.expandMeshes(this.jsonModel.object.meshNum),this.bvh.meshManager.expandLineSegments(this.jsonModel.object.lineNum);for(var o=this.materials.length,s=!1,l=0;l<e.materials.length;l++){for(var s=!1,d=0;d<o;d++)if(this.materials[d].uuid==e.materials[l].uuid){s=!0;break}s||this.materials.push(e.materials[l])}this.deepTree(this.jsonModel.object),this.Create(this.m_primIds,this.m_nPrimTris,this.m_boxes,32,32e3),this.BVHconstruct()},t.delete=function(r,e){this.m_primIds=this.m_primIds.filter(function(e,t){if(-1==r.indexOf(t))return!0}),this.m_nPrimTris=this.m_nPrimTris.filter(function(e,t){if(-1==r.indexOf(t))return!0}),this.m_boxes=this.m_boxes.filter(function(e,t){if(-1==r.indexOf(t))return!0}),this.bvh.meshManager.deleteMeshes(r),this.bvh.meshManager.deleteLineSegments(e),this.Rebuild()},t.Rebuild=function(){this.Create(this.m_primIds,this.m_nPrimTris,this.m_boxes,32,32e3),this.BVHconstruct()},e}(),La=function(e){var i=e.viewer,n=e.objects,a=e.domElement,r=e.group,o=null,s=(new THREE.Plane,new THREE.Raycaster),l=new THREE.Vector2,d=new THREE.Vector2,c=(new THREE.Vector3,null),h=!1,u=!0,p=!1,f=!1,m=!(this._enabled=!0),g=1,v=this;function t(e,t){if(e)switch(e){case"translate":v.setTransformEnable();break;case"rotate":v.setRotateEnable();break;case"both":v.setTransRotEnable()}Pe.isMobileDevice()?(a.addEventListener("touchstart",A,!1),a.addEventListener("touchmove",M,!1),a.addEventListener("touchend",E,!1)):(a.addEventListener("mousemove",M,!1),a.addEventListener("mousedown",A,!1),a.addEventListener("mouseup",E,!1)),u?((o=new Ie(i,a,t)).setMode("translate"),o.setSpace("local"),r.add(o)):p?((o=new Ie(i,a,t)).setMode("rotate"),o.setSpace("local"),r.add(o)):f&&((o=new Ie(i,a,t)).setMode("both"),o.setSpace("local"),r.add(o)),v.setSize(g),m=!0}function y(){null!=o&&o.detach(o.object),Pe.isMobileDevice()?(a.removeEventListener("touchstart",A,!1),a.removeEventListener("touchmove",M,!1),a.removeEventListener("touchend",E,!1)):(a.removeEventListener("mousemove",M,!1),a.removeEventListener("mousedown",A,!1),a.removeEventListener("mouseup",E,!1))}function A(e){h=!1,e.preventDefault(),e.stopPropagation();var t=e,e=(Pe.isMobileDevice()&&0<e.changedTouches.length&&(t=e.changedTouches[0]),a.getBoundingClientRect()),r=(i.viewManager?(r=i.viewManager.normalizeViewCoordinateToViewPort(t.clientX,t.clientY,e),l.x=r[0],l.y=-r[1]):(l.x=(t.clientX-e.left)/e.width*2-1,l.y=2*-((t.clientY-e.top)/e.height)+1),d.x=t.clientX,d.y=t.clientY,i.camera instanceof Re?i.camera.setCastRay(s,l.x,l.y):s.setFromCamera(l,i.camera),s.intersectObjects(n,!1));0<r.length&&(c=r[0].object,a.style.cursor="move",v.dispatchEvent({type:"mousedown",object:c}))}function M(e){var t=e;Pe.isMobileDevice()&&0<e.changedTouches.length&&(t=e.changedTouches[0]),Math.abs(t.clientX-d.x)<1&&Math.abs(t.clientY-d.y)<1||(e.preventDefault(),e.stopPropagation(),h=!0)}function E(e){null!=e&&e.preventDefault(),h?v.dispatchEvent({type:"mouseup",object:c}):(o.detach(o.object),null!=c&&v.attachTo(c)),i.renderAllViews(),c=null,a.style.cursor="auto"}this.isActive=function(){return m},this.getCurrAttachObj=function(){if(o)return o.object},this.setSize=function(e){g=e,o&&o.setSize(e)},this.addEventListener=function(e,t){o&&o.addEventListener(e,t)},this.getCurrentControls=function(){return o},this.getObjByName=function(e){return n[e]},this.attachTo=function(e){o.detach(o.object),null!=e&&o&&o.attach(e),i.render()},this.detach=function(){o&&o.detach(o.object)},this.isSelected=function(){var e=!1;return e=o?o.isSelected():e},this.update=function(){o&&(o.update(),o.updateMatrixWorld(!0))},this.setTransformEnable=function(){f=p=!(u=!0)},this.setRotateEnable=function(){u=!(p=!0)},this.setTransRotEnable=function(){p=u=!(f=!0)},this.setEnabled=function(e){e?this._enabled||t():this._enabled&&y(),this._enabled=e},this.activate=t,this.deactivate=y,this.dispose=function(){y()}},Oa=(La.prototype=Object.create(THREE.EventDispatcher.prototype),La.prototype.constructor=La,["#if NUM_CLIPPING_PLANES > 0","#if ! defined( PHYSICAL ) && ! defined( PHONG )","vViewPosition = - mvPosition.xyz;","#endif","vec4 tempWorldPosition = modelMatrix * vec4( position, 1.0 );","vClippingWorldPosition = tempWorldPosition.xyz;","#endif"].join("\n"),["#if NUM_CLIPPING_PLANES > 0","#if ! defined( PHYSICAL ) && ! defined( PHONG )","varying vec3 vViewPosition;","#endif","varying vec3 vClippingWorldPosition;","#endif"].join("\n"),["#if NUM_CLIPPING_PLANES > 0  ","uniform vec4 clippingPlanes[ NUM_CLIPPING_PLANES ];","varying vec3 vClipPosition;","bvec2 checkClippingPlanes() {","bool isCut = false;","bool isCutEdge = false;","#if defined( STANDARD )","for (int i=0; i<NUM_CLIPPING_PLANES; i++) {","vec4 plane = clippingPlanes[ i ];","float dotPlane = dot(vec4(vViewPosition, -1.0), plane);","isCut = isCut || (dotPlane > 0.0 );","if (!isCut) {","isCutEdge = isCutEdge || (abs(dotPlane) < abs(0.0012 * length(vViewPosition)));","}","}","#else","vec4 plane;","#pragma unroll_loop_start","for (int i=0; i<NUM_CLIPPING_PLANES; i++) {","plane = clippingPlanes[ i ];","if ( dot( vClipPosition, plane.xyz ) > plane.w ) isCut = true;","}","#pragma unroll_loop_end","#endif","return bvec2(isCut,isCutEdge);","}","#endif"].join("\n")),Fa=["#if NUM_CLIPPING_PLANES > 0 && !defined( NOCLIPPING )","bvec2 clipRetVec2NDS = checkClippingPlanes();","if (clipRetVec2NDS.x) discard;","#endif"].join("\n"),ia=["#if NUM_CLIPPING_PLANES > 0","if(clipRetVec2NDS.y) gl_FragColor = vec4(0.8, 0.4, 0.298, 1.0);","#endif","}"].join("\n"),r=(Ua=THREE.ShaderChunk.meshphong_frag).lastIndexOf("}"),Ua=Ua.substr(0,r)+ia,r=(Na=THREE.ShaderChunk.meshphysical_frag).lastIndexOf("}"),Na=Na.substr(0,r)+ia,Va=(["#if NUM_CLIPPING_PLANES > 0","for ( int i = 0; i < NUM_CLIPPING_PLANES; ++ i ) {","vec4 plane = clippingPlanes[ i ];","if ( dot( vViewPosition, plane.xyz ) > plane.w ) discard;","}","if (!gl_FrontFacing) {","gl_FragColor = vec4(0.8, 0.4, 0.298, 1.0);","return;","}","#endif"].join("\n"),{defines:{NUM_CLIPPING_PLANES_NDS:1},uniforms:{clipping:{color:{type:"c",value:new THREE.Color(16711680)},clippingPlaneNDS:{type:"v4v",value:[0,0,-1,0]}},caps:{color:{type:"c",value:new THREE.Color(.8,.4,.298)}}},vertex:["void main() {","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),vertexClipping:["varying vec4 worldPosition;","varying vec3 camPosition;","void main() {","worldPosition = modelMatrix * vec4( position, 1.0 );","camPosition = cameraPosition;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragment:["uniform vec3 color;","void main( void ) {","gl_FragColor = vec4( color , 1.0 );","}"].join("\n"),fragmentClippingFront:["uniform vec3 color;","uniform vec4 clippingPlaneNDS[NUM_CLIPPING_PLANES_NDS];","varying vec4 worldPosition;","varying vec3 camPosition;","void main() {","#if NUM_CLIPPING_PLANES_NDS > 0","for ( int i = 0; i < NUM_CLIPPING_PLANES_NDS; ++ i ) {","vec4 plane = clippingPlaneNDS[i];","if ( -dot( worldPosition.xyz, plane.xyz ) > plane.w && -dot( camPosition, plane.xyz ) > plane.w) discard;","else {","gl_FragColor = vec4( color , 1.0 );","}","}","#endif","}"].join("\n")}),Ga={vertex:["void main() {","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragment:["uniform vec3 color;","uniform vec3 hatchLineColor;","uniform vec2 hatchParams;","uniform vec3 hatchTintColor;","uniform float hatchTintIntensity;","uniform float showLine;","uniform float showMesh;","vec4 calculateHatchPattern(vec2 hatchParams, vec2 coord, vec4 fragColor, vec3 hatchTintColor, float hatchTintIntensity ) {","float hatchSlope = hatchParams.x;","float hatchPeriod = hatchParams.y;","if (abs(hatchSlope) <= 1.0) {","float hatchPhase = coord.y - hatchSlope * coord.x;","float dist = abs(mod((hatchPhase), (hatchPeriod)));","if (showLine == 1.0) {","if (dist < 2.0) {","fragColor = vec4(hatchLineColor,1.0);","} else {","fragColor.xyz = mix(fragColor.xyz, hatchTintColor, hatchTintIntensity);","if (showMesh == 0.0) {","fragColor.w = 0.0;","}","}","} else {","fragColor.xyz = mix(fragColor.xyz, hatchTintColor, hatchTintIntensity);","if (showMesh == 0.0) {","fragColor.w = 0.0;","}","}","} else {","float hatchPhase = - coord.y / hatchSlope + coord.x;","float dist = abs(mod((hatchPhase), (hatchPeriod)));","if (showLine == 1.0) {","if (dist < 1.0) {","fragColor = vec4(hatchLineColor,1.0);","} else {","fragColor.xyz = mix(fragColor.xyz, hatchTintColor, hatchTintIntensity);","if (showMesh == 0.0) {","fragColor.w = 0.0;","}","}","} else {","fragColor.xyz = mix(fragColor.xyz, hatchTintColor, hatchTintIntensity);","if (showMesh == 0.0) {","fragColor.w = 0.0;","}","}","}","return fragColor;","}","void main( void ) {","gl_FragColor = vec4( color , 1.0 );","gl_FragColor = calculateHatchPattern(hatchParams, gl_FragCoord.xy, gl_FragColor, hatchTintColor, hatchTintIntensity);","}"].join("\n")},ka=0,ja=function(e){var n,M=e,a=null,o=null,s=null,l=!1,d=null,p=Number.MAX_VALUE,c=null,h=null;this.isSnapped=function(){return l},this.getSnappedType=function(){return d},this.getSnappedVertex=function(){return o},this.isEqualWithPrecision=function(e,t){return Math.abs(e-t)<=.001},this.isEqualVectorsWithPrecision=function(e,t){return Math.abs(e.x-t.x)<=.001&&Math.abs(e.y-t.y)<=.001&&Math.abs(e.z-t.z)<=.001},this.isInverseVectorsWithPrecision=function(e,t){return Math.abs(e.x+t.x)<=.001&&Math.abs(e.y+t.y)<=.001&&Math.abs(e.z+t.z)<=.001},this.trianglesSharedEdge=function(e,t,r,i,n,a){var o=!1,s=!1,l=!1;return(e.equals(i)||e.equals(n)||e.equals(a))&&(o=!0),(t.equals(i)||t.equals(n)||t.equals(a))&&(s=!0),(r.equals(i)||r.equals(n)||r.equals(a))&&(l=!0),!!(o&s||o&l||s&l)},this.getTrianglesOnSameFace=function(e,t,r,i){var n=!1,a=e.vertices.slice(),o=new THREE.Geometry,s=(o.vertices.push(t),o.vertices.push(r),o.vertices.push(i),o.faces.push(new THREE.Face3(0,1,2)),[]);do{for(var s=[],l=0;l<a.length;l+=3)if(a[l].equals(t)&&a[l+1].equals(r)&&a[l+2].equals(i))n=!0,s.push(l);else for(var d=0;d<o.vertices.length;d+=3)if(this.trianglesSharedEdge(a[l],a[l+1],a[l+2],o.vertices[d],o.vertices[d+1],o.vertices[d+2])){var c=o.vertices.length;o.vertices.push(a[l].clone()),o.vertices.push(a[l+1].clone()),o.vertices.push(a[l+2].clone()),o.faces.push(new THREE.Face3(c,c+1,c+2)),s.push(l);break}for(var h=s.length-1;0<=h;--h)a.splice(s[h],3)}while(0<s.length);return n?o:null},this.faceSnapping=function(e,t){var r=new THREE.Vector3,i=new THREE.Vector3,n=new THREE.Vector3,a=new THREE.Geometry;if(t instanceof THREE.Geometry){h=t.vertices[e.a].clone(),u=t.vertices[e.b].clone(),p=t.vertices[e.c].clone();for(var o=0;o<t.faces.length;o++){var s=t.faces[o],r=t.vertices[s.a].clone(),i=t.vertices[s.b].clone(),n=t.vertices[s.c].clone(),l=THREE.Triangle.normal(r,i,n);this.isEqualVectorsWithPrecision(l,e.normal)&&this.isEqualWithPrecision(l.dot(r),e.normal.dot(h))&&(A=a.vertices.length,a.vertices.push(r.clone()),a.vertices.push(i.clone()),a.vertices.push(n.clone()),a.faces.push(new THREE.Face3(A,A+1,A+2)))}}else if(M.ndsModel&&t instanceof le){var d=t.attributes.position,c=t.index.array,h=new THREE.Vector3,u=new THREE.Vector3,p=new THREE.Vector3;h.fromBufferAttribute(d,e.a),u.fromBufferAttribute(d,e.b),p.fromBufferAttribute(d,e.c);for(var o=t.drawRange.start,f=t.drawRange.start+t.drawRange.count;o<f;o+=3){var m=c[o],g=(r.fromBufferAttribute(d,m),c[o+1]),v=(i.fromBufferAttribute(d,g),c[o+2]),l=(n.fromBufferAttribute(d,v),THREE.Triangle.normal(r,i,n));this.isEqualVectorsWithPrecision(l,e.normal)&&this.isEqualWithPrecision(l.dot(r),e.normal.dot(h))&&(A=a.vertices.length,a.vertices.push(r.clone()),a.vertices.push(i.clone()),a.vertices.push(n.clone()),a.faces.push(new THREE.Face3(A,A+1,A+2)))}}else if(t instanceof THREE.BufferGeometry){var y=t.attributes.position.array,c=t.index.array;(h=new THREE.Vector3).set(y[3*e.a],y[3*e.a+1],y[3*e.a+2]),(u=new THREE.Vector3).set(y[3*e.b],y[3*e.b+1],y[3*e.b+2]),(p=new THREE.Vector3).set(y[3*e.c],y[3*e.c+1],y[3*e.c+2]);for(o=0;o<c.length;o+=3){var A,m=c[o],g=(r.set(y[3*m],y[3*m+1],y[3*m+2]),c[o+1]),v=(i.set(y[3*g],y[3*g+1],y[3*g+2]),c[o+2]),l=(n.set(y[3*v],y[3*v+1],y[3*v+2]),THREE.Triangle.normal(r,i,n));this.isEqualVectorsWithPrecision(l,e.normal)&&this.isEqualWithPrecision(l.dot(r),e.normal.dot(h))&&(A=a.vertices.length,a.vertices.push(r.clone()),a.vertices.push(i.clone()),a.vertices.push(n.clone()),a.faces.push(new THREE.Face3(A,A+1,A+2)))}}return 0<a.vertices.length&&a.vertices.length<5e3?this.getTrianglesOnSameFace(a,h,u,p):null},this.edgeSnapping=function(e,t){for(var r=new THREE.Geometry,i=!0,n=!0,a=!0,o=0;o<e.vertices.length;o+=3){for(var s=0;s<e.vertices.length;s+=3)o!==s&&((e.vertices[o].equals(e.vertices[s])||e.vertices[o].equals(e.vertices[s+1])||e.vertices[o].equals(e.vertices[s+2]))&&(e.vertices[o+1].equals(e.vertices[s])||e.vertices[o+1].equals(e.vertices[s+1])||e.vertices[o+1].equals(e.vertices[s+2]))&&(i=!1),(e.vertices[o].equals(e.vertices[s])||e.vertices[o].equals(e.vertices[s+1])||e.vertices[o].equals(e.vertices[s+2]))&&(e.vertices[o+2].equals(e.vertices[s])||e.vertices[o+2].equals(e.vertices[s+1])||e.vertices[o+2].equals(e.vertices[s+2]))&&(n=!1),e.vertices[o+1].equals(e.vertices[s])||e.vertices[o+1].equals(e.vertices[s+1])||e.vertices[o+1].equals(e.vertices[s+2]))&&(e.vertices[o+2].equals(e.vertices[s])||e.vertices[o+2].equals(e.vertices[s+1])||e.vertices[o+2].equals(e.vertices[s+2]))&&(a=!1);i&&(r.vertices.push(e.vertices[o].clone()),r.vertices.push(e.vertices[o+1].clone())),n&&(r.vertices.push(e.vertices[o].clone()),r.vertices.push(e.vertices[o+2].clone())),a&&(r.vertices.push(e.vertices[o+1].clone()),r.vertices.push(e.vertices[o+2].clone())),a=n=i=!0}for(var l,d=new THREE.Geometry,c=Number.MAX_VALUE,h=0;h<r.vertices.length;h+=2){var u=this.distancePointToLine(t,r.vertices[h],r.vertices[h+1]);u<c&&(c=u,l=h)}return d.vertices.push(r.vertices[l].clone()),d.vertices.push(r.vertices[l+1].clone()),d.vertices=this.getConnectedLineSegmentsOnSameLine(r,d.vertices),p=c,d},this.distancePointToLine=function(e,t,r){var i,n=new THREE.Vector3,a=new THREE.Vector3;return n.subVectors(t,e),a.subVectors(r,t),i=n.dot(a),n.subVectors(r,t),(i=-i/n.dot(n))<0?e.distanceTo(t):1<i?e.distanceTo(r):(n.subVectors(e,t),a.subVectors(e,r),n.cross(a),a.subVectors(r,t),Math.sqrt(n.dot(n))/Math.sqrt(a.dot(a)))},this.getConnectedLineSegmentsOnSameLine=function(e,t){var r=e.vertices.slice(),i=t[0],n=t[1],a=[];do{for(var a=[],o=0;o<r.length;o+=2)if(!r[o].equals(i)||!r[o+1].equals(n))for(var s=0;s<t.length;s+=2)if(r[o].equals(t[s])||r[o+1].equals(t[s])||r[o].equals(t[s+1])||r[o+1].equals(t[s+1])){var l=new THREE.Vector3,d=new THREE.Vector3;if(l.subVectors(t[s],t[s+1]),l.normalize(),d.subVectors(r[o],r[o+1]),d.normalize(),this.isEqualVectorsWithPrecision(l,d)||this.isInverseVectorsWithPrecision(l,d)){a.push(o);break}}for(var c=a.length-1;0<=c;--c)t.push(r[a[c]]),t.push(r[a[c]+1]),r.splice(a[c],2)}while(0<a.length);return t},this.vertexSnapping=function(e,t){for(var r=Number.MAX_VALUE,i=new THREE.Vector3,n=0;n<e.vertices.length;++n){var a=t.distanceTo(e.vertices[n]);a<r-.001&&(r=a,i=e.vertices[n].clone())}return c=r,i},this.setDetectRadius=function(e){var t=Pe.isMobileDevice()?25:10,r=M.camera.getCameraTarget(),i=M.camera.position,n=new THREE.Vector3,r=(n.subVectors(r,i),e.clone()),e=M.camera.isPerspective?r.sub(i).dot(n.normalize()):n.length(),r=M.camera.fov,i=2*e*Math.tan(THREE.Math.degToRad(.5*r)),n=M.renderer.domElement.height;return t*i*M.renderer.getPixelRatio()/n},this.doSnapping=function(e){l=!1,o=a=null;var t,r=e.face,i=(s=e.point,e.object);(i=M.ndsModel&&i instanceof _e&&-1<e.meshId?M.ndsModel.meshManager.getSingleMesh(e.meshId):i)instanceof THREE.Mesh&&i.hasOwnProperty("geometry")?(a=this.faceSnapping(r,i.geometry))&&(a.applyMatrix(i.matrixWorld),n=this.edgeSnapping(a,s),o=this.vertexSnapping(n,s),h=this.setDetectRadius(s),d=c<h?ka:p<h?1:2,l=!0):i instanceof THREE.LineSegments&&i.hasOwnProperty("geometry")&&(r=i.geometry)instanceof THREE.BufferGeometry&&(i=r.attributes.position.array,t=(r=r.index.array)[e=e.index],r=r[e+1],(e=new THREE.Vector3).set(i[3*t],i[3*t+1],i[3*t+2]),(t=new THREE.Vector3).set(i[3*r],i[3*r+1],i[3*r+2]),h=2*this.setDetectRadius(s),s.distanceTo(e)<h?(d=ka,o=e,l=!0):s.distanceTo(t)<h&&(d=ka,o=t,l=!0))}},i=function(e){this.viewer=e,this.snappingTool=new ja(this.viewer)};function za(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,function(e){e=function(e,t){if("object"!=typeof e||!e)return e;var r=e[Symbol.toPrimitive];if(void 0===r)return("string"===t?String:Number)(e);r=r.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}(e,"string");return"symbol"==typeof e?e:e+""}(i.key),i)}}function Wa(e,t){return(Wa=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}i.prototype.clientCoordToModelCoordOnPlane=function(e,t,r){e=[e,t,.99],t=this.viewer.clientCoordToModelCoord(e),t=new THREE.Vector3(t[0],t[1],t[2]),e[2]=-.99,e=this.viewer.clientCoordToModelCoord(e),e=new THREE.Vector3(e[0],e[1],e[2]);return this.intersectLine(t,e,r)},i.prototype.intersectLine=function(e,t,r){var i,n;return!(e&&t&&r)||(i=e.clone(),(e=(new THREE.Vector3).subVectors(t,e)).normalize(),n=e.dot(r.normal),Math.abs(n)<=1e-8)?null:(t=r.coplanarPoint(t.clone()),t=(new THREE.Vector3).subVectors(t,i).dot(r.normal)/n,i.add(e.multiplyScalar(t)))},i.prototype.getViewClientCoords=function(e){var t=e.offsetX||e.clientX-this.viewer.container.getBoundingClientRect().left,r=e.offsetY||e.clientY-this.viewer.container.getBoundingClientRect().top;return e.srcElement&&e.srcElement!==this.viewer.renderer.domElement&&(t=e.clientX-this.viewer.container.getBoundingClientRect().left,r=e.clientY-this.viewer.container.getBoundingClientRect().top),null==e.srcElement&&e.target&&e.target!==this.viewer.renderer.domElement&&(t=e.clientX-this.viewer.container.getBoundingClientRect().left,r=e.clientY-this.viewer.container.getBoundingClientRect().top),new THREE.Vector2(t,r)},i.prototype.doRaycasterPick=function(e,t,r){var i=this.viewer,n=i.renderer.domElement,a=i.renderer.getPixelRatio(),e=e*a/n.width*2-1,t=2*-(t*a/n.height)+1,a=new THREE.Raycaster;i.camera.setCastRay(a,e,t),r&&(a.linePrecision=this.getLinePrecision());return i.ndsModel?r?i.ndsModel.intersect(a.ray,a.linePrecision):i.ndsModel.intersect(a.ray):r?a.intersectObjects(i.selectionManager.getTargetIncludeLineList()):a.intersectObjects(i.selectionManager.getTargetList())},i.prototype.doRaycasterGeomPick=function(e,t){var r,i,n,a=this.viewer;return a.controls.staticDrawGeomOp&&a.controls.staticDrawGeomOp.needSelectGeom()?(i=(a=this.viewer).renderer.domElement,r=e*(e=a.renderer.getPixelRatio())/i.width*2-1,t=2*-(t*e/i.height)+1,(e=new THREE.Raycaster).linePrecision=1,i=a.clientCoordToModelCoord([0,0]),i=new THREE.Vector3(i[0],i[1],i[2]),n=a.clientCoordToModelCoord([4,0]),n=new THREE.Vector3(n[0],n[1],n[2]),e.linePrecision=.65*i.distanceTo(n),a.camera.setCastRay(e,r,t),e.intersectObjects(a.controls.staticDrawGeomOp.drawScene.children,!0)):[]},i.prototype.getLinePrecision=function(){var e=this.viewer.clientCoordToModelCoord([0,0]),e=new THREE.Vector3(e[0],e[1],e[2]),t=this.viewer.clientCoordToModelCoord([4,0]),t=new THREE.Vector3(t[0],t[1],t[2]);return e.distanceTo(t)},i.prototype.getSelectInfoFromIntersect=function(e){if(e&&this.viewer.hasBrepInfo()){var t,r,i,n,a=this.viewer.ndsModel?e.object:this.FindParentElement(e.object);if(a)return a=a.uuid,r=e.object.uuid,this.viewer.ndsModel&&(0<=e.meshId?(e.mesh=this.viewer.ndsModel.meshManager.getSingleMesh(e.meshId),e.mesh&&(i=e.faceIndex-e.mesh.geometry.drawRange.start/3,t="face")):0<=e.lineSegId&&(e.mesh=this.viewer.ndsModel.meshManager.getLineSegments(e.lineSegId),e.mesh)&&(i=.5*(e.index-e.mesh.geometry.drawRange.start),t="edge"),r=e.geomUuid),0<=i&&(n=this.viewer.ndsModel.activeModel.brepManager.GetBrepInfoByUUidAndTopolIndex(a,r,i,t))&&(n.parentObj=e.mesh,n.geometry=e.mesh.geometry,n.matrixWorld=e.mesh.matrixWorld.clone(),n.intersect=e.point.clone(),n.bodyId=e.bodyId,n.bodyUuid=e.bodyUuid,n.meshId=e.meshId,n.topolIndex=i,n.topolType=t,n.lineSegId=e.lineSegId,"face"==t&&(n.edgeInfos=this.viewer.ndsModel.activeModel.brepManager.GetEdgeInfoFromFace(a,n.edgeIDS)),n.normal&&null==n.worldNormal&&(r=new THREE.Vector3,i=new THREE.Quaternion,e=new THREE.Vector3,n.parentObj.matrixWorld.decompose(r,i,e),n.worldNormal=new THREE.Vector3(n.normal[0],n.normal[1],n.normal[2]),n.worldNormal.applyQuaternion(i)),n.origin)&&null==n.worldOrigin&&(n.worldOrigin=new THREE.Vector3(n.origin[0],n.origin[1],n.origin[2]),n.worldOrigin.applyMatrix4(n.matrixWorld)),n}},i.prototype.getLineStartEndPoints=function(e){if(("cylinder"==e.type||"cone"==e.type)&&e.origin&&e.axis){var t=e.geometry,r=e.indexRange.concat();if(this.viewer.ndsModel&&(r[0]+=t.drawRange.start/3,r[1]+=t.drawRange.start/3),t.isBufferGeometry){var i=t.index,n=t.attributes.position,a=new THREE.Vector3,o=new THREE.Vector3,s=(a.fromArray(e.origin),o.fromArray(e.axis),new THREE.Quaternion),l=new THREE.Vector3,d=new THREE.Vector3,c=(e.matrixWorld.decompose(l,s,d),o.applyQuaternion(s),o.normalize(),-1/0),h=1/0;a.applyMatrix4(e.matrixWorld);for(var u=r[0],p=r[1];u<=p;u++){var f=3*u,m=i.getX(f),g=i.getX(1+f),f=i.getX(2+f),v=new THREE.Vector3,y=new THREE.Vector3,A=new THREE.Vector3,m=(v.fromBufferAttribute(n,m),y.fromBufferAttribute(n,g),A.fromBufferAttribute(n,f),v.applyMatrix4(e.matrixWorld),y.applyMatrix4(e.matrixWorld),A.applyMatrix4(e.matrixWorld),v.clone().sub(a).dot(o));c<m&&(c=m),m<h&&(h=m),(m=y.clone().sub(a).dot(o))<h&&(h=m),(c=c<m?m:c)<(m=A.clone().sub(a).dot(o))&&(c=m),m<h&&(h=m),A=y=v=null}return 0==Math.abs(c-h)?null:(w=a.clone().add(o.clone().multiplyScalar(c)),{start:a.clone().add(o.clone().multiplyScalar(h)),end:w})}}if("circle"==e.type&&e.center){t=e.geometry,r=e.indexRange.concat();if(this.viewer.ndsModel&&(r[0]+=t.drawRange.start/2,r[1]+=t.drawRange.start/2),t.isBufferGeometry){var i=t.index,M=t.attributes.position.array;if(null!=i)return E=i.array,a=new THREE.Vector3,w=new THREE.Vector3,a.fromArray(M,3*E[2*r[0]]),w.fromArray(M,3*E[2*r[0]+1]),this.viewer.is2DModel&&a.z==w.z&&(e.center[2]=a.z),v=(l=new THREE.Vector3(e.center[0],e.center[1],e.center[2])).clone().sub(a).normalize(),y=w.clone().sub(a).normalize(),a.applyMatrix4(e.matrixWorld),w.applyMatrix4(e.matrixWorld),l.applyMatrix4(e.matrixWorld),a.sub(l),w.sub(l),(o=a.clone().cross(w)).normalize(),a.set(e.center[0],e.center[1],e.center[2]),a.applyMatrix4(e.matrixWorld),w=a.clone().add(o),{start:a,end:w}}}t=e.geometry,r=e.indexRange.concat();if(this.viewer.ndsModel&&(r[0]+=t.drawRange.start/2,r[1]+=t.drawRange.start/2),t.isBufferGeometry){var E,w,i=t.index,M=t.attributes.position.array;if(null!=i)return E=i.array,a=new THREE.Vector3,w=new THREE.Vector3,a.fromArray(M,3*E[2*r[0]]),w.fromArray(M,3*E[2*r[1]+1]),a.applyMatrix4(e.matrixWorld),w.applyMatrix4(e.matrixWorld),{start:a,end:w}}return null},i.prototype.FindParentElement=function(e){if(null==e)return null;if(e instanceof THREE.Object3D||e instanceof NdsBodyNode){var t=e.type.toLowerCase();if(this.viewer.isObjectTypeOfElement(e)){if("object"==t)for(var r=e.parent;null!=r;)"instanceobject"==r.type.toLowerCase()&&(e=r),r=r.parent;return e}}return this.FindParentElement(e.parent)},i.prototype.getFilterDistByBody=function(e){var t,r;return e?(e.boxDiagonalLength||(t=new THREE.Vector3,r=new THREE.Vector3,this.viewer.computeBoundingBox(e,t,r,{flag:!0}),e.boxDiagonalLength=r.distanceTo(t)),.015*e.boxDiagonalLength):.5},i.prototype.getSnappingPntEx=function(e,t){if(e){var r;if(this.viewer.hasBrepInfo()){var i=this.viewer.ndsModel?e.object:this.FindParentElement(e.object);if(!i)return;var n=i.uuid,a=(null!=t?this.viewer.ndsModel.models.find(function(e){return e.id==t}):this.viewer.ndsModel.activeModel).brepManager.GetEdgesExtremePointsByBodyUUID(n);if(!a||a.length<=0)return;for(var o,n=this.getFilterDistByBody(i),s=n*n,l=e.point.clone(),i=this.viewer.modelCoordToClientCoord([l.x,l.y,l.z]),d=new THREE.Vector3(i[0],i[1],0),c=new THREE.Vector3,h=64,u=0;u<a.length;u++)l.distanceToSquared(a[u])<s&&(o=this.viewer.modelCoordToClientCoord([a[u].x,a[u].y,a[u].z]),c.set(o[0],o[1],0),(o=d.distanceToSquared(c))<h)&&(r=a[u],h=o)}else De.inBIMContext||(this.snappingTool.doSnapping(e),this.snappingTool.isSnapped()&&this.snappingTool.getSnappedType()==SNAP_VERTEX&&(r=this.snappingTool.getSnappedVertex()));return r}},i.prototype.FindParentElement=function(e){if(null==e)return null;if(e instanceof THREE.Object3D||e instanceof NdsBodyNode){var t=e.type.toLowerCase();if(this.viewer.isObjectTypeOfElement(e)){if("object"==t)for(var r=e.parent;null!=r;)"instanceobject"==r.type.toLowerCase()&&(e=r),r=r.parent;return e}}return this.FindParentElement(e.parent)},i.prototype.setPointScale=function(e,t){t=this.getScale(e,t);e.scale.x=t,e.scale.y=t,e.scale.z=t,e.updateMatrixWorld(!0)},i.prototype.setCylinderScale=function(e,t){COMMON.isMobileDevice()&&(t*=1.5);t=this.getScale(e,t);e.scale.x=t,e.scale.y=t,e.scale.z=t,e.oldPosition&&e.offsetPos&&e.position.addVectors(e.oldPosition,e.offsetPos.clone().multiplyScalar(t)),e.updateMatrixWorld(!0)},i.prototype.getScale=function(e,t){var r=5,t=(null!=t&&(r=t),this.viewer.camera.getCameraTarget()),i=this.viewer.camera.position,n=new THREE.Vector3,t=(n.subVectors(t,i),e.position.clone()),e=this.viewer.camera.isPerspective?t.sub(i).dot(n.normalize()):n.length(),t=this.viewer.camera.fov,i=2*e*Math.tan(THREE.Math.degToRad(.5*t)),n=this.viewer.renderer.domElement.height;return r*i*this.viewer.renderer.getPixelRatio()/n},i.prototype.isTwoTopolInfoTheSame=function(e,t){return!(e&&!t||!e&&t||!e&&!t||this.viewer.ndsModel&&(e.bodyId!=t.bodyId||e.meshId!=t.meshId||e.lineSegId!=t.lineSegId)||e.parentObj!=t.parentObj||e.id!=t.id||e.indexRange[0]!==t.indexRange[0]||e.indexRange[1]!==t.indexRange[1])},i.prototype.createFace=function(e,t,r){if(void 0===r&&(r=0),e&&e.parentObj instanceof THREE.Mesh){var i,n=e.geometry,a=e.indexRange.concat();if(this.viewer.ndsModel&&(a[0]+=n.drawRange.start/3,a[1]+=n.drawRange.start/3),n.isBufferGeometry){for(var o=n.index,s=n.attributes.position,n=a[1]-a[0]+1,l=new Float32Array(9*n),d=0,c=new THREE.Vector3,h=a[0],u=a[1];h<=u;h++,d+=1){var p=3*h,f=o.getX(p),m=o.getX(1+p),p=o.getX(2+p),g=new THREE.Vector3,v=new THREE.Vector3,y=new THREE.Vector3,f=(g.fromBufferAttribute(s,f),v.fromBufferAttribute(s,m),y.fromBufferAttribute(s,p),(new THREE.Vector3).subVectors(v,g)),m=(new THREE.Vector3).subVectors(y,g);f.cross(m).normalize(),c.add(f),l[9*d]=g.x,l[9*d+1]=g.y,l[9*d+2]=g.z,l[9*d+3]=v.x,l[9*d+4]=v.y,l[9*d+5]=v.z,l[9*d+6]=y.x,l[9*d+7]=y.y,l[9*d+8]=y.z,y=v=g=null}n=new THREE.BufferGeometry,a=(n.addAttribute("position",new THREE.BufferAttribute(l,3)),(i=new THREE.Mesh(n,0==t?De.selectedFaceMaterial:De.preSelectedFaceMaterial)).objectType="Face",i.FaceInfo=[],this.viewer.ndsModel.models.find(function(e){return e.id==r})),n=a.geomManager.uuidToIdMap[e.geometry.uuid][0],a=(i.FaceInfo.push(a.bodyUuid2NodeMap[e.bodyUuid].id),i.FaceInfo.push(n),i.FaceInfo.push(e.topolIndex),i.FaceInfo.push(e.meshId),t?1:0);i.FaceInfo.push(a),i.applyMatrix(e.matrixWorld),i.matrixWorldNeedsUpdate=!0,c.normalize(),e.averagenormal=c}return i}},i.prototype.createLine=function(e,t,r,i){if(void 0===i&&(i=0),e&&e.parentObj instanceof THREE.Line){var n,a=e.geometry,o=e.indexRange.concat();if(this.viewer.ndsModel&&(o[0]+=a.drawRange.start/2,o[1]+=a.drawRange.start/2),a.isBufferGeometry){var s=o[1]-o[0]+1,l=a.index,d=a.attributes.position.array,c=new Float32Array(6*s);if(null!=l){for(var h=l.array,u=0,a=o[0],p=o[1],f=(Math.round(.5*(a+p)),0),m=a,g=p;m<=g;m++,u+=1){var v=h[2*m],y=h[2*m+1],A=new THREE.Vector3,M=new THREE.Vector3;A.fromArray(d,3*v),M.fromArray(d,3*y),c[6*u]=A.x,c[6*u+1]=A.y,c[6*u+2]=A.z,c[6*u+3]=M.x,c[6*u+4]=M.y,c[6*u+5]=M.z,f+=A.clone().distanceTo(M),M=A=null}for(var E=0,m=a;m<=p;m++){v=h[2*m],y=h[2*m+1],A=new THREE.Vector3,M=new THREE.Vector3,A.fromArray(d,3*v),M.fromArray(d,3*y);if(.5*f<(E+=A.clone().distanceTo(M))){M.clone().sub(A).normalize();break}}r=r||(0==t?De.SelectedEdgeMaterial1:De.preSelectedEdgeMaterial);s=new THREE.BufferGeometry,l=(s.addAttribute("position",new THREE.BufferAttribute(c,3)),(n=new THREE.LineSegments(s,r)).objectType="SelLine",n.LineInfo=[],this.viewer.ndsModel.models.find(function(e){return e.id==i})),o=(n.LineInfo.push(l.bodyUuid2NodeMap[e.bodyUuid].id),l.geomManager.uuidToIdMap[e.geometry.uuid][0]),a=(n.LineInfo.push(o),n.LineInfo.push(e.topolIndex),n.LineInfo.push(e.lineSegId),t?1:0);n.LineInfo.push(a),n.applyMatrix(e.matrixWorld),n.matrixWorldNeedsUpdate=!0}}return n}},i.prototype.createPointMesh=function(e,t,r){t=new THREE.Mesh(new THREE.SphereGeometry(1),t);return t.position.set(e.x,e.y,e.z),this.setPointScale(t,r),t.objectType="Point",t.Point=e.clone(),t},THREE.UniformsLib.line={worldUnits:{value:1},linewidth:{value:1},resolution:{value:new THREE.Vector2(1,1)},dashOffset:{value:0},dashScale:{value:1},dashSize:{value:1},gapSize:{value:1}},THREE.ShaderLib.line={uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib.common,THREE.UniformsLib.fog,THREE.UniformsLib.line]),vertexShader:"\n\t\t#include <common>\n\t\t#include <color_pars_vertex>\n\t\t#include <fog_pars_vertex>\n\t\t#include <logdepthbuf_pars_vertex>\n\t\t#include <clipping_planes_pars_vertex>\n\n\t\tuniform float linewidth;\n\t\tuniform vec2 resolution;\n\n\t\tattribute vec3 instanceStart;\n\t\tattribute vec3 instanceEnd;\n\n\t\tattribute vec3 instanceColorStart;\n\t\tattribute vec3 instanceColorEnd;\n\n\t\t#ifdef WORLD_UNITS\n\n\t\t\tvarying vec4 worldPos;\n\t\t\tvarying vec3 worldStart;\n\t\t\tvarying vec3 worldEnd;\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tvarying vec2 vUv;\n\n\t\t\t#endif\n\n\t\t#else\n\n\t\t\tvarying vec2 vUv;\n\n\t\t#endif\n\n\t\t#ifdef USE_DASH\n\n\t\t\tuniform float dashScale;\n\t\t\tattribute float instanceDistanceStart;\n\t\t\tattribute float instanceDistanceEnd;\n\t\t\tvarying float vLineDistance;\n\n\t\t#endif\n\n\t\tvoid trimSegment( const in vec4 start, inout vec4 end ) {\n\n\t\t\t// trim end segment so it terminates between the camera plane and the near plane\n\n\t\t\t// conservative estimate of the near plane\n\t\t\tfloat a = projectionMatrix[ 2 ][ 2 ]; // 3nd entry in 3th column\n\t\t\tfloat b = projectionMatrix[ 3 ][ 2 ]; // 3nd entry in 4th column\n\t\t\tfloat nearEstimate = - 0.5 * b / a;\n\n\t\t\tfloat alpha = ( nearEstimate - start.z ) / ( end.z - start.z );\n\n\t\t\tend.xyz = mix( start.xyz, end.xyz, alpha );\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\t#ifdef USE_COLOR\n\n\t\t\t\tvColor.xyz = ( position.y < 0.5 ) ? instanceColorStart : instanceColorEnd;\n\n\t\t\t#endif\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tvLineDistance = ( position.y < 0.5 ) ? dashScale * instanceDistanceStart : dashScale * instanceDistanceEnd;\n\t\t\t\tvUv = uv;\n\n\t\t\t#endif\n\n\t\t\tfloat aspect = resolution.x / resolution.y;\n\n\t\t\t#ifdef USE_MODELMATRIXATTRIB\n\t\t\t\tmat4 ndsModelViewMatrix = viewMatrix * modelMatrixAttrib;\n\t\t\t\t// camera space\n\t\t\t\tvec4 start = ndsModelViewMatrix * vec4( instanceStart, 1.0 );\n\t\t\t\tvec4 end = ndsModelViewMatrix * vec4( instanceEnd, 1.0 );\n\t\t\t#else\n\t\t\t\t// camera space\n\t\t\t\tvec4 start = modelViewMatrix * vec4( instanceStart, 1.0 );\n\t\t\t\tvec4 end = modelViewMatrix * vec4( instanceEnd, 1.0 );\n\t\t\t#endif\n\n\t\t\t#ifdef WORLD_UNITS\n\n\t\t\t\tworldStart = start.xyz;\n\t\t\t\tworldEnd = end.xyz;\n\n\t\t\t#else\n\n\t\t\t\tvUv = uv;\n\n\t\t\t#endif\n\n\t\t\t// special case for perspective projection, and segments that terminate either in, or behind, the camera plane\n\t\t\t// clearly the gpu firmware has a way of addressing this issue when projecting into ndc space\n\t\t\t// but we need to perform ndc-space calculations in the shader, so we must address this issue directly\n\t\t\t// perhaps there is a more elegant solution -- WestLangley\n\n\t\t\tbool perspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 ); // 4th entry in the 3rd column\n\n\t\t\tif ( perspective ) {\n\n\t\t\t\tif ( start.z < 0.0 && end.z >= 0.0 ) {\n\n\t\t\t\t\ttrimSegment( start, end );\n\n\t\t\t\t} else if ( end.z < 0.0 && start.z >= 0.0 ) {\n\n\t\t\t\t\ttrimSegment( end, start );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\t// clip space\n\t\t\tvec4 clipStart = projectionMatrix * start;\n\t\t\tvec4 clipEnd = projectionMatrix * end;\n\n\t\t\t// ndc space\n\t\t\tvec3 ndcStart = clipStart.xyz / clipStart.w;\n\t\t\tvec3 ndcEnd = clipEnd.xyz / clipEnd.w;\n\n\t\t\t// direction\n\t\t\tvec2 dir = ndcEnd.xy - ndcStart.xy;\n\n\t\t\t// account for clip-space aspect ratio\n\t\t\tdir.x *= aspect;\n\t\t\tdir = normalize( dir );\n\n\t\t\t#ifdef WORLD_UNITS\n\n\t\t\t\t// get the offset direction as perpendicular to the view vector\n\t\t\t\tvec3 worldDir = normalize( end.xyz - start.xyz );\n\t\t\t\tvec3 offset;\n\t\t\t\tif ( position.y < 0.5 ) {\n\n\t\t\t\t\toffset = normalize( cross( start.xyz, worldDir ) );\n\n\t\t\t\t} else {\n\n\t\t\t\t\toffset = normalize( cross( end.xyz, worldDir ) );\n\n\t\t\t\t}\n\n\t\t\t\t// sign flip\n\t\t\t\tif ( position.x < 0.0 ) offset *= - 1.0;\n\n\t\t\t\tfloat forwardOffset = dot( worldDir, vec3( 0.0, 0.0, 1.0 ) );\n\n\t\t\t\t// don't extend the line if we're rendering dashes because we\n\t\t\t\t// won't be rendering the endcaps\n\t\t\t\t#ifndef USE_DASH\n\n\t\t\t\t\t// extend the line bounds to encompass  endcaps\n\t\t\t\t\tstart.xyz += - worldDir * linewidth * 0.5;\n\t\t\t\t\tend.xyz += worldDir * linewidth * 0.5;\n\n\t\t\t\t\t// shift the position of the quad so it hugs the forward edge of the line\n\t\t\t\t\toffset.xy -= dir * forwardOffset;\n\t\t\t\t\toffset.z += 0.5;\n\n\t\t\t\t#endif\n\n\t\t\t\t// endcaps\n\t\t\t\tif ( position.y > 1.0 || position.y < 0.0 ) {\n\n\t\t\t\t\toffset.xy += dir * 2.0 * forwardOffset;\n\n\t\t\t\t}\n\n\t\t\t\t// adjust for linewidth\n\t\t\t\toffset *= linewidth * 0.5;\n\n\t\t\t\t// set the world position\n\t\t\t\tworldPos = ( position.y < 0.5 ) ? start : end;\n\t\t\t\tworldPos.xyz += offset;\n\n\t\t\t\t// project the worldpos\n\t\t\t\tvec4 clip = projectionMatrix * worldPos;\n\n\t\t\t\t// shift the depth of the projected points so the line\n\t\t\t\t// segments overlap neatly\n\t\t\t\tvec3 clipPose = ( position.y < 0.5 ) ? ndcStart : ndcEnd;\n\t\t\t\tclip.z = clipPose.z * clip.w;\n\n\t\t\t#else\n\n\t\t\t\tvec2 offset = vec2( dir.y, - dir.x );\n\t\t\t\t// undo aspect ratio adjustment\n\t\t\t\tdir.x /= aspect;\n\t\t\t\toffset.x /= aspect;\n\n\t\t\t\t// sign flip\n\t\t\t\tif ( position.x < 0.0 ) offset *= - 1.0;\n\n\t\t\t\t// endcaps\n\t\t\t\tif ( position.y < 0.0 ) {\n\n\t\t\t\t\toffset += - dir;\n\n\t\t\t\t} else if ( position.y > 1.0 ) {\n\n\t\t\t\t\toffset += dir;\n\n\t\t\t\t}\n\n\t\t\t\t// adjust for linewidth\n\t\t\t\toffset *= linewidth;\n\n\t\t\t\t// adjust for clip-space to screen-space conversion // maybe resolution should be based on viewport ...\n\t\t\t\toffset /= resolution.y;\n\n\t\t\t\t// select end\n\t\t\t\tvec4 clip = ( position.y < 0.5 ) ? clipStart : clipEnd;\n\n\t\t\t\t// back to clip space\n\t\t\t\toffset *= clip.w;\n\n\t\t\t\tclip.xy += offset;\n\n\t\t\t#endif\n\n\t\t\tgl_Position = clip;\n\n\t\t\tvec4 mvPosition = ( position.y < 0.5 ) ? start : end; // this is an approximation\n\n\t\t\t#include <logdepthbuf_vertex>\n\t\t\t#include <clipping_planes_vertex>\n\t\t\t#include <fog_vertex>\n\n\t\t}\n\t\t",fragmentShader:"\n\t\tuniform vec3 diffuse;\n\t\tuniform float opacity;\n\t\tuniform float linewidth;\n\n\t\t#ifdef USE_DASH\n\n\t\t\tuniform float dashOffset;\n\t\t\tuniform float dashSize;\n\t\t\tuniform float gapSize;\n\n\t\t#endif\n\n\t\tvarying float vLineDistance;\n\n\t\t#ifdef WORLD_UNITS\n\n\t\t\tvarying vec4 worldPos;\n\t\t\tvarying vec3 worldStart;\n\t\t\tvarying vec3 worldEnd;\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tvarying vec2 vUv;\n\n\t\t\t#endif\n\n\t\t#else\n\n\t\t\tvarying vec2 vUv;\n\n\t\t#endif\n\n\t\t#include <common>\n\t\t#include <color_pars_fragment>\n\t\t#include <fog_pars_fragment>\n\t\t#include <logdepthbuf_pars_fragment>\n\t\t#include <clipping_planes_pars_fragment>\n\n\t\tvec2 closestLineToLine(vec3 p1, vec3 p2, vec3 p3, vec3 p4) {\n\n\t\t\tfloat mua;\n\t\t\tfloat mub;\n\n\t\t\tvec3 p13 = p1 - p3;\n\t\t\tvec3 p43 = p4 - p3;\n\n\t\t\tvec3 p21 = p2 - p1;\n\n\t\t\tfloat d1343 = dot( p13, p43 );\n\t\t\tfloat d4321 = dot( p43, p21 );\n\t\t\tfloat d1321 = dot( p13, p21 );\n\t\t\tfloat d4343 = dot( p43, p43 );\n\t\t\tfloat d2121 = dot( p21, p21 );\n\n\t\t\tfloat denom = d2121 * d4343 - d4321 * d4321;\n\n\t\t\tfloat numer = d1343 * d4321 - d1321 * d4343;\n\n\t\t\tmua = numer / denom;\n\t\t\tmua = clamp( mua, 0.0, 1.0 );\n\t\t\tmub = ( d1343 + d4321 * ( mua ) ) / d4343;\n\t\t\tmub = clamp( mub, 0.0, 1.0 );\n\n\t\t\treturn vec2( mua, mub );\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\t#include <clipping_planes_fragment>\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tif ( vUv.y < - 1.0 || vUv.y > 1.0 ) discard; // discard endcaps\n\n\t\t\t\tif ( mod( vLineDistance + dashOffset, dashSize + gapSize ) > dashSize ) discard; // todo - FIX\n\n\t\t\t#endif\n\n\t\t\tfloat alpha = opacity;\n\n\t\t\t#ifdef WORLD_UNITS\n\n\t\t\t\t// Find the closest points on the view ray and the line segment\n\t\t\t\tvec3 rayEnd = normalize( worldPos.xyz ) * 1e5;\n\t\t\t\tvec3 lineDir = worldEnd - worldStart;\n\t\t\t\tvec2 params = closestLineToLine( worldStart, worldEnd, vec3( 0.0, 0.0, 0.0 ), rayEnd );\n\n\t\t\t\tvec3 p1 = worldStart + lineDir * params.x;\n\t\t\t\tvec3 p2 = rayEnd * params.y;\n\t\t\t\tvec3 delta = p1 - p2;\n\t\t\t\tfloat len = length( delta );\n\t\t\t\tfloat norm = len / linewidth;\n\n\t\t\t\t#ifndef USE_DASH\n\n\t\t\t\t\t#ifdef USE_ALPHA_TO_COVERAGE\n\n\t\t\t\t\t\tfloat dnorm = fwidth( norm );\n\t\t\t\t\t\talpha = 1.0 - smoothstep( 0.5 - dnorm, 0.5 + dnorm, norm );\n\n\t\t\t\t\t#else\n\n\t\t\t\t\t\tif ( norm > 0.5 ) {\n\n\t\t\t\t\t\t\tdiscard;\n\n\t\t\t\t\t\t}\n\n\t\t\t\t\t#endif\n\n\t\t\t\t#endif\n\n\t\t\t#else\n\n\t\t\t\t#ifdef USE_ALPHA_TO_COVERAGE\n\n\t\t\t\t\t// artifacts appear on some hardware if a derivative is taken within a conditional\n\t\t\t\t\tfloat a = vUv.x;\n\t\t\t\t\tfloat b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;\n\t\t\t\t\tfloat len2 = a * a + b * b;\n\t\t\t\t\tfloat dlen = fwidth( len2 );\n\n\t\t\t\t\tif ( abs( vUv.y ) > 1.0 ) {\n\n\t\t\t\t\t\talpha = 1.0 - smoothstep( 1.0 - dlen, 1.0 + dlen, len2 );\n\n\t\t\t\t\t}\n\n\t\t\t\t#else\n\n\t\t\t\t\tif ( abs( vUv.y ) > 1.0 ) {\n\n\t\t\t\t\t\tfloat a = vUv.x;\n\t\t\t\t\t\tfloat b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;\n\t\t\t\t\t\tfloat len2 = a * a + b * b;\n\n\t\t\t\t\t\tif ( len2 > 1.0 ) discard;\n\n\t\t\t\t\t}\n\n\t\t\t\t#endif\n\n\t\t\t#endif\n\n\t\t\tvec4 diffuseColor = vec4( diffuse, alpha );\n\n\t\t\t#include <logdepthbuf_fragment>\n\t\t\t#include <color_fragment>\n\n\t\t\tgl_FragColor = vec4( diffuseColor.rgb, alpha );\n\n\t\t\t#include <tonemapping_fragment>\n\t\t\t#include <encodings_fragment>\n\t\t\t#include <fog_fragment>\n\t\t\t#include <premultiplied_alpha_fragment>\n\n\t\t}\n\t\t"};var Xa=function(r){function e(e){var t=r.call(this,{type:"LineMaterialOrigin",uniforms:THREE.UniformsUtils.clone(THREE.ShaderLib.line.uniforms),vertexShader:THREE.ShaderLib.line.vertexShader,fragmentShader:THREE.ShaderLib.line.fragmentShader,clipping:!0})||this;return t.isLineMaterial=!0,t.setValues(e),t}var t,i,n;return i=r,(t=e).prototype=Object.create(i.prototype),Wa(t.prototype.constructor=t,i),t=e,(i=[{key:"color",get:function(){return this.uniforms.diffuse.value},set:function(e){this.uniforms.diffuse.value=e}},{key:"worldUnits",get:function(){return"WORLD_UNITS"in this.defines},set:function(e){!0===e?this.defines.WORLD_UNITS="":delete this.defines.WORLD_UNITS}},{key:"linewidth",get:function(){return this.uniforms.linewidth.value},set:function(e){this.uniforms.linewidth&&(this.uniforms.linewidth.value=e)}},{key:"dashed",get:function(){return"USE_DASH"in this.defines},set:function(e){!0===e!==this.dashed&&(this.needsUpdate=!0),!0===e?this.defines.USE_DASH="":delete this.defines.USE_DASH}},{key:"dashScale",get:function(){return this.uniforms.dashScale.value},set:function(e){this.uniforms.dashScale.value=e}},{key:"dashSize",get:function(){return this.uniforms.dashSize.value},set:function(e){this.uniforms.dashSize.value=e}},{key:"dashOffset",get:function(){return this.uniforms.dashOffset.value},set:function(e){this.uniforms.dashOffset.value=e}},{key:"gapSize",get:function(){return this.uniforms.gapSize.value},set:function(e){this.uniforms.gapSize.value=e}},{key:"opacity",get:function(){return this.uniforms.opacity.value},set:function(e){this.uniforms&&(this.uniforms.opacity.value=e)}},{key:"resolution",get:function(){return this.uniforms.resolution.value},set:function(e){this.uniforms.resolution.value.copy(e)}},{key:"alphaToCoverage",get:function(){return"USE_ALPHA_TO_COVERAGE"in this.defines},set:function(e){this.defines&&(!0===e!==this.alphaToCoverage&&(this.needsUpdate=!0),!0===e?(this.defines.USE_ALPHA_TO_COVERAGE="",this.extensions.derivatives=!0):(delete this.defines.USE_ALPHA_TO_COVERAGE,this.extensions.derivatives=!1))}}])&&za(t.prototype,i),n&&za(t,n),Object.defineProperty(t,"prototype",{writable:!1}),t}(THREE.ShaderMaterial);function qa(e,t){var r,i="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(i)return(i=i.call(e)).next.bind(i);if(Array.isArray(e)||(i=function(e,t){{var r;if(e)return"string"==typeof e?Ya(e,t):"Map"===(r="Object"===(r={}.toString.call(e).slice(8,-1))&&e.constructor?e.constructor.name:r)||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?Ya(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length)return i&&(e=i),r=0,function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}};throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function Ya(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,i=Array(t);r<t;r++)i[r]=e[r];return i}function Qa(){Qa=function(){return o};var l,o={},e=Object.prototype,d=e.hasOwnProperty,c=Object.defineProperty||function(e,t,r){e[t]=r.value},t="function"==typeof Symbol?Symbol:{},i=t.iterator||"@@iterator",r=t.asyncIterator||"@@asyncIterator",n=t.toStringTag||"@@toStringTag";function a(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{a({},"")}catch(l){a=function(e,t,r){return e[t]=r}}function s(e,t,r,i){var n,a,o,s,t=t&&t.prototype instanceof v?t:v,t=Object.create(t.prototype),i=new I(i||[]);return c(t,"_invoke",{value:(n=e,a=r,o=i,s=u,function(e,t){if(s===f)throw Error("Generator is already running");if(s===m){if("throw"===e)throw t;return{value:l,done:!0}}for(o.method=e,o.arg=t;;){var r=o.delegate;if(r){r=function e(t,r){var i=r.method,n=t.iterator[i];if(n===l)return r.delegate=null,"throw"===i&&t.iterator.return&&(r.method="return",r.arg=l,e(t,r),"throw"===r.method)||"return"!==i&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+i+"' method")),g;i=h(n,t.iterator,r.arg);if("throw"===i.type)return r.method="throw",r.arg=i.arg,r.delegate=null,g;n=i.arg;return n?n.done?(r[t.resultName]=n.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=l),r.delegate=null,g):n:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,g)}(r,o);if(r){if(r===g)continue;return r}}if("next"===o.method)o.sent=o._sent=o.arg;else if("throw"===o.method){if(s===u)throw s=m,o.arg;o.dispatchException(o.arg)}else"return"===o.method&&o.abrupt("return",o.arg);s=f;r=h(n,a,o);if("normal"===r.type){if(s=o.done?m:p,r.arg===g)continue;return{value:r.arg,done:o.done}}"throw"===r.type&&(s=m,o.method="throw",o.arg=r.arg)}})}),t}function h(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}o.wrap=s;var u="suspendedStart",p="suspendedYield",f="executing",m="completed",g={};function v(){}function y(){}function A(){}var t={},M=(a(t,i,function(){return this}),Object.getPrototypeOf),M=M&&M(M(T([]))),E=(M&&M!==e&&d.call(M,i)&&(t=M),A.prototype=v.prototype=Object.create(t));function w(e){["next","throw","return"].forEach(function(t){a(e,t,function(e){return this._invoke(t,e)})})}function x(o,s){var t;c(this,"_invoke",{value:function(r,i){function e(){return new s(function(e,t){!function t(e,r,i,n){var a,e=h(o[e],o,r);if("throw"!==e.type)return(r=(a=e.arg).value)&&"object"==typeof r&&d.call(r,"__await")?s.resolve(r.__await).then(function(e){t("next",e,i,n)},function(e){t("throw",e,i,n)}):s.resolve(r).then(function(e){a.value=e,i(a)},function(e){return t("throw",e,i,n)});n(e.arg)}(r,i,e,t)})}return t=t?t.then(e,e):e()}})}function b(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function B(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function I(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(b,this),this.reset(!0)}function T(t){if(t||""===t){var r,e=t[i];if(e)return e.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length))return r=-1,(e=function e(){for(;++r<t.length;)if(d.call(t,r))return e.value=t[r],e.done=!1,e;return e.value=l,e.done=!0,e}).next=e}throw new TypeError(typeof t+" is not iterable")}return c(E,"constructor",{value:y.prototype=A,configurable:!0}),c(A,"constructor",{value:y,configurable:!0}),y.displayName=a(A,n,"GeneratorFunction"),o.isGeneratorFunction=function(e){e="function"==typeof e&&e.constructor;return!!e&&(e===y||"GeneratorFunction"===(e.displayName||e.name))},o.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,A):(e.__proto__=A,a(e,n,"GeneratorFunction")),e.prototype=Object.create(E),e},o.awrap=function(e){return{__await:e}},w(x.prototype),a(x.prototype,r,function(){return this}),o.AsyncIterator=x,o.async=function(e,t,r,i,n){void 0===n&&(n=Promise);var a=new x(s(e,t,r,i),n);return o.isGeneratorFunction(t)?a:a.next().then(function(e){return e.done?e.value:a.next()})},w(E),a(E,n,"Generator"),a(E,i,function(){return this}),a(E,"toString",function(){return"[object Generator]"}),o.keys=function(e){var t,r=Object(e),i=[];for(t in r)i.push(t);return i.reverse(),function e(){for(;i.length;){var t=i.pop();if(t in r)return e.value=t,e.done=!1,e}return e.done=!0,e}},o.values=T,I.prototype={constructor:I,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=l,this.done=!1,this.delegate=null,this.method="next",this.arg=l,this.tryEntries.forEach(B),!e)for(var t in this)"t"===t.charAt(0)&&d.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=l)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(r){if(this.done)throw r;var i=this;function e(e,t){return a.type="throw",a.arg=r,i.next=e,t&&(i.method="next",i.arg=l),!!t}for(var t=this.tryEntries.length-1;0<=t;--t){var n=this.tryEntries[t],a=n.completion;if("root"===n.tryLoc)return e("end");if(n.tryLoc<=this.prev){var o=d.call(n,"catchLoc"),s=d.call(n,"finallyLoc");if(o&&s){if(this.prev<n.catchLoc)return e(n.catchLoc,!0);if(this.prev<n.finallyLoc)return e(n.finallyLoc)}else if(o){if(this.prev<n.catchLoc)return e(n.catchLoc,!0)}else{if(!s)throw Error("try statement without catch or finally");if(this.prev<n.finallyLoc)return e(n.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;0<=r;--r){var i=this.tryEntries[r];if(i.tryLoc<=this.prev&&d.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var n=i;break}}var a=(n=n&&("break"===e||"continue"===e)&&n.tryLoc<=t&&t<=n.finallyLoc?null:n)?n.completion:{};return a.type=e,a.arg=t,n?(this.method="next",this.next=n.finallyLoc,g):this.complete(a)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),g},finish:function(e){for(var t=this.tryEntries.length-1;0<=t;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),B(r),g}},catch:function(e){for(var t=this.tryEntries.length-1;0<=t;--t){var r,i,n=this.tryEntries[t];if(n.tryLoc===e)return"throw"===(r=n.completion).type&&(i=r.arg,B(n)),i}throw Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:T(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=l),g}},o}function Ka(e,t,r,i,n,a,o){try{var s=e[a](o),l=s.value}catch(e){return r(e)}s.done?t(l):Promise.resolve(l).then(i,n)}function Za(s){return function(){var e=this,o=arguments;return new Promise(function(t,r){var i=s.apply(e,o);function n(e){Ka(i,t,r,n,a,"next",e)}function a(e){Ka(i,t,r,n,a,"throw",e)}n(void 0)})}}function Ja(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,function(e){e=function(e,t){if("object"!=typeof e||!e)return e;var r=e[Symbol.toPrimitive];if(void 0===r)return("string"===t?String:Number)(e);r=r.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}(e,"string");return"symbol"==typeof e?e:e+""}(i.key),i)}}function $a(e,t){return($a=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}for(var eo=0,to=["ms","moz","webkit","o"],ro=0;ro<to.length&&!window.requestAnimationFrame;++ro)window.requestAnimationFrame=window[to[ro]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[to[ro]+"CancelAnimationFrame"]||window[to[ro]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(e,t){var r=(new Date).getTime(),i=Math.max(0,16-(r-eo)),n=window.setTimeout(function(){e(r+i)},i);return eo=r+i,n}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)}),Ce.StartRenderTime=Date.now();var io=function(Te){function Se(_){var E=Te.call(this)||this,L=(console.log("NDSViewer3D v5.10.2"),E);function f(){return m.apply(this,arguments)}function m(){return(m=Za(Qa().mark(function e(t,r,n){var a,o,s,l;return Qa().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if((a=He.getExtension(t))&&a.isLoad)return e.abrupt("return");e.next=3;break;case 3:e.next=5;var i=r;return new Promise(function(e,t){var r=new XMLHttpRequest;r.open("GET",i),r.onload=function(){200<=this.status&&this.status<300||0===this.status?e(r.responseText):t(Error(r.statusText))},r.onerror=function(){t(Error("Network response was not OK"))},r.crossOrigin="anonymous",r.responseType="text",r.send()});case 5:a=e.sent;try{new Function("token",a)(n),(o=He.getExtension(t))&&(o.load(L),"ClipExtension"==o.name&&(s=void 0===_.clipPlaneShaderVersion?1:_.clipPlaneShaderVersion,l=void 0!==_.showSectionPlane&&_.showSectionPlane,o.initClipExtension)&&o.initClipExtension(s,l),"MeasureExtension"!=o.name&&"Measure2DPCExtension"!=o.name&&"Measure2DAPPExtension"!=o.name||(L.__globalMeasureExtension=o))}catch(e){L.dispatchEvent({type:"PluginloadedError",name:t,message:e.message}),console.log("Extension "+t+" load failed;\n"+e.message)}case 7:case"end":return e.stop()}},e)}))).apply(this,arguments)}if(E.__globalMeasureExtension=void 0,E.modelRequestorManager=new Pt(E),E.currentRequestorName="",E.clipDataManager=new ga,_.CustomExtensions)for(var g=0;g<_.CustomExtensions.length;++g){var e=_.CustomExtensions[g];_.singleHTML||!0===e.imi&&f(e.name,e.url,e.token).then(function(){})}He.getExtension("SceneEditExtension")?He.getExtension("SceneEditExtension").load(E):(E.ScenarioEditorInfo={},E.ScenarioEditorInfo.folderArray=[],E.ScenarioEditorInfo.nodeMatrix={},E.ScenarioEditorInfo.EulerAngle=new THREE.Vector3),document.body.style.cssText="margin: 0; overflow: hidden",document.addEventListener("contextmenu",function(e){e.preventDefault()},!1),E.fontsManager=new qr(E);var w=[],O=(E.animationClock=new THREE.Clock,E.pmiObject=null,E.pmiVisible=!0,E.viewerPMIVisible=!0,E.brepMemory=0,E.Decimal=4,E.showHiddenMode=-1,E.PersistentId2uuid=new Map,E.mergeType=2,E.inWaitProcedure=!1,E.inWheel=!1,E.AssemblyPMIState=null,E.PartPMIState=null,E.exchangeBackImage=null,E.Rectangle=[],E.modelRequestor=null,E.redererSide=null,E.requestAnimationFrameId=[],E.maxFPS=120,E.minFPS=15,E.maxFrameTime=1e3/E.minFPS,E.viewManager=void 0,E.viewBoxMap=new Map,E.oldClearColor=new THREE.Color,E.emptyCenter=new THREE.Vector3,E.allLoaded=!1,E.ConfigNum=0,E.ConfigName="",E.addFrameListener=function(e){for(var t=0,r=w.length;t<r;t++)if(w[t]==e)return;w.push(e)},E.removeFrameListener=function(e){for(var t=0;t<w.length;t++)w[t]==e&&w.splice(t,1)},E.isIn3DViewer=function(){return!(L.is2DModel||L.is2DViewer||De.inBIMContext||De.ScenarioEditor||De.isARmodel||De.isVRmodel)},L.lights=[],L.lightControls=null,L.leafPMIObjects=[],L.PMINDSBodys=[],L.viewer2DInfo={center:new THREE.Vector3(0,0,0),normal:new THREE.Vector3(0,0,1),yDir:new THREE.Vector3(0,1,0),distance:100},new THREE.LoadingManager),z=(L.materialsSetting=void 0,L.propertyManager=null,L.containProperty=!1,null),x=(E.trueMapList=null,_.materialsSetting&&(z=_.materialsSetting,_.materialsSetting=void 0),void 0!==(_=_||{}).is2DViewer&&_.is2DViewer),t=(L.is2DViewer=x,L.loadbrepDefault=_.loadbrepDefault,L.testMode=void 0!==_.testMode&&_.testMode,L.is2DModel=void 0!==_.is2DModel&&_.is2DModel,L.renderMode=void 0===_.viewState?"shaded":_.viewState,L.defaultRenderMode=L.renderMode,L.viewerPMIVisible=void 0===_.pmiVisible||_.pmiVisible,L.pmiVisible=L.viewerPMIVisible,L.bBackGroundTransparent=void 0!==_.backGroundTransparent&&_.backGroundTransparent,L.bLinesVisibility=void 0===_.showLines||_.showLines,L.bShowToolTip=void 0===_.showToolTip||_.showToolTip,L.bToolBarAutoHide=void 0===_.toolBarAutoHide||_.toolBarAutoHide,L.bMouseWheelForwardEnlarge=void 0===_.mouseWheelForwardEnlarge||_.mouseWheelForwardEnlarge,L.bHasLoadingWaiter=void 0===_.hasLoadingWaiter||_.hasLoadingWaiter,L.bHasLoadingCoverer=void 0===_.hasLoadingCoverer||_.hasLoadingCoverer,L.bHasLoadingStater=void 0!==_.hasLoadingStater&&_.hasLoadingStater,L.limitEventArea=void 0===_.limitEventArea?void 0:_.limitEventArea,L.convertPhongToPBR=void 0!==_.convertPhongToPBR&&_.convertPhongToPBR,L.reflected=void 0!==_.reflected&&_.reflected,L.enableInternalRMB=void 0!==_.enableInternalRMB&&_.enableInternalRMB,L.hasViewBox=void 0===_.hasViewBox||_.hasViewBox,L.enableFlip=void 0===_.enableFlip||_.enableFlip,L.viewBoxSize=_.viewBoxSize,L.workerString=_.singleWorkerSource,L.prepareModelCallBack=_.prepareModelCallBack,L.measuringScale=void 0===_.measuringScale?1:_.measuringScale,_.angles&&0<_.angles.length?L.Euler=new THREE.Euler(THREE.Math.degToRad(_.angles[0]),THREE.Math.degToRad(_.angles[1]),THREE.Math.degToRad(_.angles[2])):L.Euler=null,L.gobalReqHeader=void 0===_.gobalReqHeader?null:_.gobalReqHeader,L.logOperatorTime=!1,L.logOperatorTimeInfo={},L.showLineWidth=!1,L.disratio=void 0===_.disratio?1:_.disratio,L.parameters=_,L.waterInfo=null===_.waterInfo||void 0===_.waterInfo?{}:_.waterInfo,L.waterInfo);t.text||t.imageSrc||console.log("请输入文字或者图片路径"),null==t.interval_v||"number"==typeof t.interval_v&&Number.isInteger(t.interval_v)||(t.interval_v=void 0,console.log("interval_v:参数应为整数类型")),null==t.interval_h||"number"==typeof t.interval_h&&Number.isInteger(t.interval_h)||(t.interval_h=void 0,console.log("interval_h:参数应为整数类")),null==t.xstart||"number"==typeof t.xstart&&Number.isInteger(t.xstart)||(t.xstart=void 0,console.log("xstart:参数应为数字类型")),null==t.ystart||"number"==typeof t.ystart&&Number.isInteger(t.ystart)||(t.ystart=void 0,console.log("ystart:参数应为数字类型")),null!=t.transparent&&"number"!=typeof t.transparent&&(t.transparent=void 0,console.log("transparent:参数应为数字类型")),null!=t.transparent&&(t.transparent<0||1<t.transparent)&&(t.transparent=void 0,console.log("transparent:取值应该在0 到 1 之间")),null!=t.fontSize&&"number"!=typeof t.fontSize&&(t.fontSize=void 0,console.log("fontSize:参数应为数字类型")),null!=t.fontSize&&t.fontSize<0&&(t.fontSize=void 0,console.log("fontSize取值应该大于0")),null!=t.angle&&"number"!=typeof t.angle&&(t.angle=void 0,console.log("angle:参数应为数字类型")),null!=t.angle&&(t.angle<0||180<t.angle)&&(t.angle=void 0,console.log("angle:取值应该在0 到 180 之间")),null!=t.repeat&&"boolean"!=typeof t.repeat&&(t.repeat=void 0,console.log("repeat:参数应为布尔类型")),null!=t.bold&&"boolean"!=typeof t.bold&&(t.bold=void 0,console.log("bold:参数应为布尔类型")),null!=t.font&&"string"!=typeof t.font&&(t.font=void 0,console.log("font:参数应为字符串类型")),null!=t.imageSize&&"number"!=typeof t.imageSize&&(t.imageSize=void 0,console.log("imageSize:参数应为数字类型")),null!=t.imageSrc&&"string"!=typeof t.imageSrc&&(t.imageSrc=void 0,console.log("imageSrc:参数应为字符串类型")),null==t.color||/^#([0-9a-fA-F]+|[0-9]+)$/.test(t.color)||(t.color=void 0,console.log("color:参数格式应为#00ff32")),t.text&&(t.text=t.text.replace(/\\/g,"\\\\"),t.text=t.text.replace(/\n/g,"\\n"),t.text=t.text.replace(/\r/g,"\\r"),t.text=t.text.replace(/\t/g,"\\t"),t.text=t.text.replace(/\f/g,"\\f"),t.text=t.text.replace(/\v/g,"\\v")),L.waterInfo.imageSrc&&(L.waterInfo.waterImg=document.createElement("img"),L.waterInfo.waterImg.crossOrigin="Anonymous",L.waterInfo.waterImg.src=L.waterInfo.imageSrc,L.waterInfo.waterImg.onload=function(){L.waterInfo.imgLoad=!0}),L.testMode&&console.log("Viewer初始化时间:",(new Date).getTime(),new Date),Pe.setMobileDevice(_.from),L.watermark=void 0===_.Arthur?null:_.Arthur,L.excalibur=!0;var b,B,I,T,S,H,W,R,X,t=function(e){for(var t=new String,r=new Array,i=new Array,n=e.length,a=0;a<n;a++)r[a]=e.charCodeAt(a),i[a]=e.charCodeAt(a+1);for(a=0;a<n;a+=2)t+=String.fromCharCode(r[a]-i[a]);return t},t=(L.watermark&&(L.watermark=t(L.watermark)),L.watermark&&4<L.watermark.length&&"9527"===L.watermark.substr(0,4)&&(L.excalibur=!1),L.turnoffAnimation=void 0!==_.turnoffAnimation&&_.turnoffAnimation,L.defaultStandardView=_.defaultStandardView,L.bDefaultOpRotate=void 0===_.defaultOpRotate||_.defaultOpRotate,void 0!==_.toolbarButtonClickedBkgColor&&(De.toolbarButtonClickedBkgColor=_.toolbarButtonClickedBkgColor),De.avoidCaching=void 0===_.avoidCaching||_.avoidCaching,De.lineColor=void 0===_.lineColor?void 0:_.lineColor,De.enableBroadcast=void 0!==_.enableBroadcast&&_.enableBroadcast,De.broadcastMajor=void 0!==_.broadcastMajor&&_.broadcastMajor,De.enableSelect=void 0!==_.enableSelect&&_.enableSelect,De.autoSwitchFirstPersonView=void 0!==_.autoSwitchFirstPersonView&&_.autoSwitchFirstPersonView,De.tangentEdgeVisible=void 0===_.tangentEdgeVisible||_.tangentEdgeVisible,De.enableArrowKeyOp=void 0===_.enableArrowKeyOp||_.enableArrowKeyOp,De.dynamicRotateCenter=void 0===_.dynamicRotateCenter||_.dynamicRotateCenter,De.enableOutlineEffect=void 0!==_.enableOutlineEffect&&_.enableOutlineEffect,De.enableBodyVolumeMeasure=void 0!==_.enableBodyVolumeMeasure&&_.enableBodyVolumeMeasure,De.enablePreSelectBrep=void 0!==_.enablePreSelectBrep&&_.enablePreSelectBrep,De.selectObjectWithPropertyOnly=void 0!==_.selectObjectWithPropertyOnly&&_.selectObjectWithPropertyOnly,De.enableDirectMove=void 0!==_.enableDirectMove&&_.enableDirectMove,De.enableDirectRotate=void 0!==_.enableDirectRotate&&_.enableDirectRotate,De.inAssemblyContext=void 0!==_.inAssemblyContext&&_.inAssemblyContext,De.inBIMContext=void 0!==_.inBIMContext&&_.inBIMContext,De.modelUpDirection=void 0===_.modelUpDirection?"posy":_.modelUpDirection,L.Euler&&(De.modelUpDirection="posy"),De.bodyOpacity=void 0===_.bodyOpacity?.4:_.bodyOpacity,De.lineOpacity=void 0===_.lineOpacity?.2:_.lineOpacity,De.ScenarioEditor=void 0!==_.ScenarioEditor&&_.ScenarioEditor,De.AnimationEdit=void 0!==_.AnimationEdit&&_.AnimationEdit,De.singleHTML=void 0!==_.singleHTML&&_.singleHTML,De.isVRmodel=void 0!==_.isVRmodel&&_.isVRmodel,De.isARmodel=void 0!==_.isARmodel&&_.isARmodel,De.supportAR=void 0!==_.supportAR&&_.supportAR,De.HideLeafBody=void 0!==_.structureHideBody&&_.structureHideBody,De.logarithmicDepthBuffer=void 0!==_.logarithmicDepthBuffer&&_.logarithmicDepthBuffer,Pe.getOSInfo()),v=(De.logarithmicDepthBuffer="macOS"===t.os||De.logarithmicDepthBuffer,L.bBackGroundTransparent=!!De.isARmodel||L.bBackGroundTransparent,L.hasViewBox=!De.isARmodel&&L.hasViewBox,De.ScenarioEditor||De.AnimationEdit||(L.CADViewer=!0),(_.inAssemblyContext||De.singleHTML)&&(L.excalibur=!1),void 0!==_.NdsLoadWorkerUrl&&(De.NdsLoadWorkerUrl=_.NdsLoadWorkerUrl),void 0!==_.DISARequestWorkerUrl&&(De.DISARequestWorkerUrl=_.DISARequestWorkerUrl),void 0!==_.NdsLoadClipExtension&&(De.NdsLoadClipExtension=_.NdsLoadClipExtension),void 0!==_.serverUrl&&(De.NdsLoadWorkerUrl=_.serverUrl+De.NdsLoadWorkerUrl,De.NdsLoadBooleanWorkerUrl=_.serverUrl+De.NdsLoadBooleanWorkerUrl,void 0!==De.DISARequestWorkerUrl&&(De.DISARequestWorkerUrl=_.serverUrl+De.DISARequestWorkerUrl),L.serverUrl=_.serverUrl,"./"==L.serverUrl&&(L.serverUrl=null),console.log(De.NdsLoadWorkerUrl)),E.broadcastManager=new zr(E),E.selectionManager=new In(E),E.propertyMap=new Map,!0),F=!0,y=-1,A=-1,M=-1,r=null,q=(void 0!==_.id&&(r=document.getElementById(_.id)),_.toolbar),t=(void 0===q&&(q=!0),L.toolbarInitialVisibility=void 0===_.toolbarInitialVisibility||_.toolbarInitialVisibility,null==r&&(r=new Ce.Element,r=document.body.appendChild(r.domElement)),new Ce.Element({className:"container"})),Y=(t.domElement.style.width=r.style.width,t.domElement.style.height=r.style.height,E.container=r.appendChild(t.domElement),E.container.id="t_container",0),U=0,N=0,t=(E._getWholeModelLoadedTime_=function(){return N},E.container.getBoundingClientRect()),Q=(E.isRunning=!1,E.enableProgressiveRender=!0,E.gpuPerformanceTest=!1,L.bBackGroundTransparent?E.renderer=new Gr({antialias:!0,alpha:!0,is2DModel:E.is2DModel,logarithmicDepthBuffer:De.logarithmicDepthBuffer}):E.renderer=new Gr({alpha:!0,antialias:!0,is2DModel:E.is2DModel,logarithmicDepthBuffer:De.logarithmicDepthBuffer}),Se.renderer=E.renderer,E.isiPhone=!1,E.deviceMemory=2,navigator&&-1!==navigator.userAgent.toLowerCase().indexOf("iphone")&&(E.isiPhone=!0,i=E.renderer.getContext().getExtension("WEBGL_debug_renderer_info"))&&(-1!==(i=E.renderer.getContext().getParameter(i.UNMASKED_RENDERER_WEBGL)).indexOf("A8")?E.deviceMemory=1:-1!==i.indexOf("A1")&&3<=window.devicePixelRatio&&(E.deviceMemory=3)),!!E.renderer.getContext().getContextAttributes().antialias),i=E.renderer.extensions,i=(De.OES_element_index_uint=!(!E.renderer.capabilities.isWebGL2&&!i.get("OES_element_index_uint")),E.renderer.setPixelRatio(window.devicePixelRatio),E.renderer.setSize(t.width,t.height),void 0===_.backGroundColor?16777215:_.backGroundColor),i=(L.bBackGroundTransparent?E.renderer.setClearColor(i,0):E.renderer.setClearColor(i,1),E.renderer.autoClear=!1,E.renderer.domElement),V=(i.className="canvas3DBIM",i.id="canvas3D_"+Date.now(),E.canvas3D=i,E.container.appendChild(i),_.has2DCover&&(E.canvas2D=document.createElement("canvas"),E.canvas2D.className="canvas2DBIM",E.canvas2D.id="canvas2D_"+Date.now(),E.container.appendChild(E.canvas2D),E.canvas2DLayer=document.createElement("canvas"),E.canvas2DLayer.className="canvas2DLayer",E.canvas2DLayer.id="canvas2DLayer_"+Date.now(),E.container.appendChild(E.canvas2DLayer)),E.progressBar=document.createElement("div"),E.progressBar.style.cssText="display: block; position: absolute; z-index: 2;left: 2px; bottom: 2px; height: 4px; width: 200px;background: rgba(0,0,0,1);visibility: hidden;",E.progressBarFrontground=document.createElement("div"),E.progressBarFrontground.style.cssText="height: 4px; width: 200px;background: #04d83a;",E.progressBar.appendChild(E.progressBarFrontground),E.container.appendChild(E.progressBar),E.progressBarWidth=200,E.scene=new THREE.Scene,E.scene.matrixWorldAutoUpdate=!1,E.meshLoadedUUIDs=void 0,E.modelRootObject=void 0,E.additionalObjectsScene=new THREE.Scene,void 0),G=0,C=null,n=E.scene,K=!1,n=(E.camera=new Re(t.width,t.height,E),_.cameraInfo&&E.camera.setOrginalCameraInfo({center:new THREE.Vector3(_.cameraInfo.target.x,_.cameraInfo.target.y,_.cameraInfo.target.z),up:new THREE.Vector3(_.cameraInfo.up.x,_.cameraInfo.up.y,_.cameraInfo.up.z),position:new THREE.Vector3(_.cameraInfo.position.x,_.cameraInfo.position.y,_.cameraInfo.position.z),fov:_.cameraInfo.fov,near:_.cameraInfo.near,far:_.cameraInfo.far,isPerspective:_.cameraInfo.isPerspective,width:_.cameraInfo.width,height:_.cameraInfo.height,modelScreenBBox:_.cameraInfo.modelScreenBBox}),(null!=_.projectionMode&&"Orthographic"==_.projectionMode||null!=_.cameraInfo&&0==_.cameraInfo.isPerspective)&&E.camera.toOrthographic(),E.cameraControl=new Ge(E),E.cameraControl.setAutoRotateSpeed(.5),x&&(a=new THREE.AmbientLight(16777215),n.add(a),x)&&(L.camera.near=.1,L.camera.far=6e3,L.camera.position.set(0,0,100),L.camera.lookAt(new THREE.Vector3(0,0,0))),.25),a=.45,Z=(null!=L.convertPhongToPBR&&1==L.convertPhongToPBR&&(n=.45,a=.2,L.reflected)&&(n=1,a=1.2),void 0===_.directionLightIntensity?n:_.directionLightIntensity),J=(void 0===_.directionLightColor||_.directionLightColor,void 0===_.hemiSphereLightIntensity?a:_.hemiSphereLightIntensity),$=(void 0===_.hemiSphereLightColor||_.hemiSphereLightColor,E.groundShadow=new $n(E,E.renderer),E.groundShadow.enabled=!De.isVRmodel&&!De.isARmodel,E.backGroundScene=void 0,E.backGroundCamera=void 0,E.backGroundMesh=void 0,E.envMapCamera=void 0,E.envMapScene=void 0,E.envMapTexture=void 0,(E.envMapMaterial=void 0)!==_.hideEnvMap&&_.hideEnvMap),k=void 0!==_.enableEnvMap&&_.enableEnvMap,d=(d=void 0===_.envMapMode?"reflection":_.envMapMode).toLowerCase(),D=(void 0===_.envMapReflectionRatio||_.envMapReflectionRatio,E.envMapBlurTargetH=void 0,E.envMapBlurTargetV=void 0,E.envMapBlurPassH=void 0,(E.envMapBlurPassV=void 0)!==_.enableEnvMapBlur&&_.enableEnvMapBlur),o=void 0===_.envMapBlurVersion?2:_.envMapBlurVersion,s=2,l=void 0===_.envMapBlurLevel?0:_.envMapBlurLevel,n=(0==l&&(D=!1,l=1),E.renderer.getPixelRatio()),t=(E.selectionOutlinePass=null,De.enableOutlineEffect?E.outlinePass=new Or(E,new THREE.Vector2(t.width*n,t.height*n),E.scene,E.camera):E.isIn3DViewer()&&(E.selectionOutlinePass=new Fr(E,new THREE.Vector2(t.width*n,t.height*n),E.scene,E.camera)),new ke(E)),ee=(x||!1===E.bDefaultOpRotate?t.setOperator(new pi(E)):t.setOperator(new ui(E)),E.controls=t,E.operators=new Map,E.cursors=new Map,E.originalMeshes=new Array,E.isolateMeshes=new Array,E.modelInfo=[],E.loadParams=new Map,E.modelUnit=null,E.userModelUnit=null,E.draggedObjects=void 0,new THREE.Vector2(-1,-1)),te=(new THREE.Vector3(1,1.5,1),new THREE.Vector3(0,2e3,0),!0),re=!1,ie=!1,P=void 0===_.enableGroundShadow||_.enableGroundShadow,j=!1,ne=!1,ae=void 0===_.enableSmoothTranslation||_.enableSmoothTranslation,oe=void 0===_.enableAutoRotation||_.enableAutoRotation,c=null==_.modelOperationMode?"normal":_.modelOperationMode,h=(E.originalModelOperationMode=c,void 0),se=(null!=_.modelOperationVerticalRotationRange&&Array.isArray(_.modelOperationVerticalRotationRange)&&2<=_.modelOperationVerticalRotationRange.length&&(h=new THREE.Vector2).fromArray(_.modelOperationVerticalRotationRange),E.commentManager=new Wr(E),E.ndsModel=null,E.ndsModelBvhLoaded=!1,E.ndsModelPMILoaded=!1,E.ndsModelObjectTreeLoaded=!1,E.nBufferChunks=0,E.nBufferChunksLoaded=0,E.windowResize=!0,new Ur(je)),le=(se.material.blending=THREE.NoBlending,se.material.depthWrite=!1,se.material.depthTest=!1,!(E.renderStates={forceClear:!0,remainTime:150,shouldRenderClipbox:!0,shouldRenderClipScene:!0}));function de(){var e;L.btnSelected?u(L.btnSelected.domElement.id):null!=L.prevCursor&&(null!=(e=L.renderer.domElement)&&(1==L.inWaitProcedure?e.oldCursor=L.prevCursor:e.style.cursor=L.prevCursor),null!=(e=L.canvas2D)&&(1==L.inWaitProcedure?e.oldCursor=L.prevCursor:e.style.cursor=L.prevCursor),null!=L.canvas2DLayer)&&(1==L.inWaitProcedure?L.canvas2DLayer.oldCursor=L.prevCursor:L.canvas2DLayer.style.cursor=L.prevCursor)}function ce(){L.prevCursor=L.renderer.domElement.style.cursor}function u(e){var t="",r=("coordinate"==L.getCurrentMeasureType()&&"MeasureType"!=e&&(e="coordinate"),De.singleHTML?L.cursors.has(e)&&(t=(r=L.cursors.get(e)).objectUrl||r.url):L.cursors.has(e)&&(t=L.cursors.get(e).url),L.renderer.domElement),e=(null!=r&&(1==L.inWaitProcedure?r.oldCursor=t:r.style.cursor=t),L.canvas2D);null!=e&&(1==L.inWaitProcedure?e.oldCursor=t:e.style.cursor=t),null!=L.canvas2DLayer&&(1==L.inWaitProcedure?L.canvas2DLayer.oldCursor=t:L.canvas2DLayer.style.cursor=t)}function he(e,t){for(var r=0,i=t.length;r<i;++r)if(e==t[r].key)return 1}E.composer=new Ve(L.renderer,void 0,L.renderer.colorTarget),E.getEnableSmoothTranslation=function(){return ae},E.getLoadingManager=function(){return O},E.getCommentsManager=function(){return L.commentManager},Object.defineProperties(E,{bGeoBufferChunkLoaded:{get:function(){return V},set:function(e){V=e}},loadingManager:{get:function(){return O}}}),E.drawCenterCross=function(){var e,t,r,i,n;L.canvas2D&&(e=L.canvas2D.getContext("2d"),t=Math.round(L.canvas2D.width/2),r=Math.round(L.canvas2D.height/2),e.clearRect(t-15,r-15,30,30),i=e.strokeStyle,n=e.lineWidth,e.strokeStyle="#FFFFFF",e.lineWidth=1,e.beginPath(),e.moveTo(t-15,r),e.lineTo(t+15,r),e.moveTo(t,r-15),e.lineTo(t,r+15),e.stroke(),e.strokeStyle=i,e.lineWidth=n)},E.clearCenterCross=function(){var e,t,r;L.canvas2D&&(e=L.canvas2D.getContext("2d"),t=Math.round(L.canvas2D.width/2),r=Math.round(L.canvas2D.height/2),e.clearRect(t-15,r-15,30,30))},E.addPMIObject=function(e){L.pmiObject||(L.pmiObject=new THREE.Object3D,L.pmiObject.name="pmiobject",L.pmiVisible&&L.scene.add(L.pmiObject)),L.newrootBodyNode=null,L.ndsModel.modelTree=new Map,this.pmiObject.add(e)},E.addToScene=function(e){L.scene.add(e),e instanceof THREE.Light||x&&L.selectionManager.addToTargetList(e)},E.displayViewBox=function(e){this.viewManager?this.viewManager.displayViewBox(e):this.viewBoxDiv?this.viewBoxDiv.style.visibility=e?"visible":"hidden":this.initViewBox()},E.initViewBox=function(){var e;this.is2DModel||this.GeomEmpty||!this.hasViewBox||(this.viewBoxMap.has(e="viewboxMain")?(this.viewBoxDiv=this.viewBoxMap.get(e).viewBoxDiv,this.container.appendChild(this.viewBoxDiv),this.viewBox=this.viewBoxMap.get(e).viewBox):(this.viewBoxDiv=document.createElement("div"),this.viewBoxDiv.id=e,this.viewBoxDiv.className="viewbox",this.container.appendChild(this.viewBoxDiv),this.viewBox=new Ne(this,L.viewBoxSize),this.viewBoxMap.set(e,{viewBoxDiv:this.viewBoxDiv,viewBox:this.viewBox})),this.cameraControl.setViewBox(this.viewBox))},E.loadScript=function(e,t,r){var i;_.NdsPluginFileList&&!_.NdsPluginFileList.includes("NDSDrag")&&_.NdsPluginFileList.push("NDSDrag"),!_.singleHTML&&_.NdsPluginFileList&&_.NdsPluginFileList.includes(t)&&(L.serverUrl&&(e=L.serverUrl+e),(i=document.createElement("script")).type="text/javascript",i.readyState?i.onreadystatechange=function(){"loaded"!=i.readyState&&"complete"!=i.readyState||(i.onreadystatechange=null,r())}:i.onload=function(){r()},i.src=e,document.getElementsByTagName("head")[0].appendChild(i)),console.log("Plugin script url",e)},E.render=function(e){var t=!!e&&!!e.forceRenderAll,r=!e||null==e.onlyUpdateActiveView||e.onlyUpdateActiveView,i=!e||!1!==e.needsClear;L.broadcastManager&&(e&&null!=e.needBroadcast&&null!=e.needBroadcast?L.broadcastManager.needBroadcast=e.needBroadcast:L.broadcastManager.needBroadcast=!0),L.ndsModel?(Ce.StartRenderTime=Date.now(),L.ndsModel.forceRenderAll=!!L.enableProgressiveRender&&t,L.renderStates.forceClear=i,L.renderStates.remainTime=150,L.viewManager&&L.viewManager.updateViewRenderStates(L.renderStates,r)):L.renderNew()},E.renderAllViews=function(e){this.viewManager?this.render({type:"render",onlyUpdateActiveView:!1}):this.render(e)},E.setMaxandMinFrame=function(e,t){void 0===t&&(t=25),this.maxFPS=e=void 0===e?60:e,this.minFPS=t,this.maxFrameTime=1e3/t},E.isNdsModelInWireframeMode=function(e){return 2==e||6==e||7==e},E.renderNew=(T=[],W=!(S=[]),X=R=H=I=B=b=0,function(e,t,r){if(void 0===e&&(e=performance.now()),void 0===t&&(t=!0),void 0===r&&(r=void 0),!L.loaderror){0===e?b=performance.now():e-b<1?(B=L.maxFPS/2,I=L.maxFPS/2):B=((I=1e3/(e-b))+B)/2,S.length<T.length&&(T[T.length-1]<=0?S.length=T.length=0:S.push(I)),He.getExtension("NDSAnimationExtension")?L.animationRun=He.getExtension("NDSAnimationExtension").isrunning():L.animationRun=!1;var i=E.maxFPS,n=E.minFPS;if(L.animationRun&&L.setMaxandMinFrame(35),B>=L.maxFPS+5)B=L.maxFPS;else{1<=e-b&&(b=e);var a=0===e?L.maxFrameTime:Math.min(L.maxFrameTime,B/L.minFPS*L.maxFrameTime);if(L.renderer.primitivesPerFrameLocked||!E.enableProgressiveRender||1e6===L.renderer.maxPrimitivesPerFrame?S.length=T.length=0:0<T.length&&(I<=5?(++R,X=0):(R=0,++X),2<=R?(console.log("FPS 过低 ！！！！"),L.renderer.maxPrimitivesPerFrame=I<.5?.25*T.at(-1):I<1?.5*T.at(-1):I<3?.7*T.at(-1):.8*T.at(-1),R=0,S.length=T.length=0,L.renderer.tryRenderAll=!1):3<=X&&L.renderer.tryRenderAll&&(L.renderer.tryRenderAll=!1,L.renderer.maxPrimitivesPerFrame=Math.max(L.renderer.maxPrimitivesPerFrame,T.at(-1)+2e6))),10<=T.length){L.renderer.tryRenderAll=!1;var o=0,s=0,l=0,d=0,c=0;S.push(S[S.length-1]);for(var h=0,u=T.length;h<u;++h)s=Math.max(s,S[h]),l=Math.min(l,S[h]),o+=S[h],d+=Math.abs(S[h]-S[h+1]),c=Math.max(T[h],c);d/=10,(o=(o-s)/9)<(d=Math.max(d,1))&&(o-=d-o),(!W||6<d)&&o<L.minFPS&&(d=Math.max(d,4),p=Math.max(Math.floor((L.minFPS/o-1)*d*1e6),2e6),L.renderer.maxPrimitivesPerFrame-=p,0<H&&(W=!0),console.log("maxPrimitivesPerFrame: "+L.renderer.maxPrimitivesPerFrame)),(l>=L.minFPS||o>=L.minFPS&&d<4&&L.renderer.maxPrimitivesPerFrame<c)&&(L.renderer.maxPrimitivesPerFrame+=Math.floor(2e6*(o/L.minFPS-1)),H++,console.log("maxPrimitivesPerFrame: "+L.renderer.maxPrimitivesPerFrame)),L.renderer.maxPrimitivesPerFrame=Math.max(L.renderer.maxPrimitivesPerFrame,4e6),S.length=T.length=0}L.animationRun&&L.setMaxandMinFrame(i,n);var p={timeStamp:e,fps:B,needsRedraw:!1,forceClear:L.renderStates.forceClear};if(E.ndsModel&&!E.ndsModel.isEmpty()&&E.ndsModel.update(p),E.modelRequestor&&E.modelRequestor.request(),He.update(p),t&&0!==L.renderer.colorTarget.width&&0!==L.renderer.colorTarget.height){if(E.enableProgressiveRender||(a=1e3),E.renderer.enableProgressiveRender=E.enableProgressiveRender,null!=w)for(var f=0,m=w.length;f<m;f++)w[f].run();L.additionalObjectsScene&&L.updateAdditionalObjectsScene(),L.envMapCamera&&j&&L.envMapCamera.rotation.copy(L.camera.rotation);var g=L.selectionManager.getSelectedMeshes();if(C&&(L.scene.remove(L.lightControls._scene),L.scene.traverse(function(e){e.hasOwnProperty("geometry")&&e.hasOwnProperty("material")&&(he(e,g)||(e.materialWhiteMold=e.material,e.material=C))}),L.scene.add(L.lightControls._scene)),re=!(te=!1),L.renderer.clear(),L.renderer.clearTarget(null,!0,!0,!1),L.preparedForRender){i=performance.now(),n=L.renderer.clippingPlanes;if(L.renderer.clippingPlanes=[],L.ndsModel&&(L.renderStates.forceClear&&(L.renderer.clearTarget(L.renderer.colorTarget,!0,!0,!1),L.ndsModel.setDirty()),void 0!==L.backGroundScene&&!x&&L.renderStates.forceClear&&L.renderer.render(L.backGroundScene,L.backGroundCamera,L.renderer.colorTarget),L.envMapScene&&!$&&L.renderStates.forceClear&&(D?(L.renderer.render(L.envMapScene,L.envMapCamera,L.envMapBlurTargetH),L.envMapBlurPassV.render(L.renderer,L.envMapBlurTargetV,L.envMapBlurTargetH),L.envMapBlurPassH.render(L.renderer,L.renderer.colorTarget,L.envMapBlurTargetV)):L.renderer.render(L.envMapScene,L.envMapCamera,L.renderer.colorTarget)),P&&L.groundShadow.needClear&&(L.groundShadow.clear(),L.groundShadow.needClear=!1),P&&!L.groundShadow.isValid()&&j&&(L.groundShadow.renderIntoShadow(L.scene),L.groundShadow.postprocess()),j||x)){L.renderer.clippingPlanes=n;var e=0,p=(E.useObjectEdgeLine=!1,L.ndsModel.SHADED_WITH_EDGES),v=(4===G?p=L.ndsModel.SHADED_WITH_EDGES:5===G?p=L.ndsModel.SHADED:2===G?(p=L.ndsModel.WIREFRAME,E.useObjectEdgeLine=!0):6===G?(p=L.ndsModel.HIDDEN_LINE_REMOVE,E.useObjectEdgeLine=!0):7===G?(p=L.ndsModel.HIDDEN_LINE_VISIBLE,E.useObjectEdgeLine=!0):8===G&&(p=L.ndsModel.TRANSPARENT),p!==L.ndsModel.SHADED_WITH_EDGES||L.bLinesVisibility||(p=L.ndsModel.SHADED),L.ndsModel.setDrawMode(p),(E.useObjectEdgeLine||E.singlePartMode)&&L.renderStates.forceClear?(void 0===E.objectEdgeLinePass&&(t=E.container.getBoundingClientRect(),y=E.renderer.getPixelRatio(),E.objectEdgeLinePass=new Da(E,new THREE.Vector2(t.width*y,t.height*y),E.scene),E.objectEdgeLinePass=new Da(E,new THREE.Vector2(t.width*y,t.height*y),E.scene)),t=!0,E.useObjectEdgeLine&&(t=p!==L.ndsModel.WIREFRAME,E.customEdgeDetectPassGlobal=!0),E.singlePartMode&&(E.customEdgeDetectPassBodyPart=!(t=!1)),E.objectEdgeLinePass.render(L.renderer.colorTarget,t),E.customEdgeDetectPassGlobal=!1,E.customEdgeDetectPassBodyPart=!1,L.ndsModel.setDirty(),L.ndsModel.setDrawMode(p),L.scene.children.push(L.ndsModel),L.renderer.render(L.scene,L.camera,L.renderer.colorTarget,!1,!1,!1,a)):E.useObjectEdgeLine||(L.scene.children.push(L.ndsModel),L.renderer.render(L.scene,L.camera,L.renderer.colorTarget,!1,!1,!1,a)),e+=L.renderer.info.render.triangles+L.renderer.info.render.lines,L.renderer.stopRenderingEarly?Ce.StartRenderTime=Date.now():L.renderer.primitivesPerFrameLocked&&(L.renderer.primitivesPerFrameLocked=!1,L.renderer.tryRenderAll=!0,L.renderer.maxPrimitivesPerFrame=6e7),De.enableOutlineEffect&&L.renderStates.forceClear?E.outlinePass.render(L.renderer,null,L.renderer.colorTarget):E.selectionOutlinePass&&(L.renderStates.forceClear&&(E.selectionOutlinePass.shouldRenderOutline=!0),L.selectionManager.shouldApplySelectedMaterial)&&!E.isNdsModelInWireframeMode(G)&&E.selectionOutlinePass.shouldRenderOutline&&!L.renderer.stopRenderingEarly&&(y=E.renderer.getClearColor(E.oldClearColor).clone(),t=E.renderer.getClearAlpha(),E.renderer.setClearColor(y,0),E.selectionOutlinePass.render(L.renderer,null,L.renderer.colorTarget),E.renderer.setClearColor(y,t)),L.pmiVisible&&L.pmiObject&&(L.scene.getObjectByName("pmiobject")||L.scene.add(L.pmiObject),L.renderer.render(L.scene,L.camera,L.renderer.colorTarget,!1,!1,!1,a),L.scene.remove(L.pmiObject)),L.renderer.clippingPlanes=[],L.renderer.colorTarget&&L.renderStates.forceClear&&P&&L.groundShadow.isValid()&&L.groundShadow.renderShadow(L.camera,L.renderer.colorTarget),He.onAfterAllNdsModelSetRender(L.renderStates.forceClear,L.renderer),L.renderStates.forceClear&&(L.selectionManager.renderSelectionScene(L.renderer.colorTarget),L.additionalObjectsScene)&&(L.renderer.render(L.additionalObjectsScene,L.camera,L.renderer.colorTarget),e+=L.renderer.info.render.triangles+L.renderer.info.render.lines),L.ndsModel.referenceEntityDirty&&0<L.ndsModel.wholeRefEntityNodes.length&&(L.scene.children.push(L.ndsModel),L.renderer.render(L.scene,L.camera,L.renderer.colorTarget,!1,!1,!0)),T.push(e),L.renderer.colorTarget&&(L.renderStates.forceClear||j)&&se.render(L.renderer,null,L.renderer.colorTarget.texture),L.renderStates.forceClear=!1,L.controls.staticDrawGeomOp&&L.controls.staticDrawGeomOp.renderGeomScene(),E.clearCanvas2D(),E.renderWaterMark(E.waterInfo),He.onAfterCopyPassRender(L.renderer),r&&r.applyViewScissorToRenderer(),L.isViewActive(r)&&L.__globalMeasureExtension&&L.__globalMeasureExtension.renderMeasureScene(),r&&r.revertViewScissorToRenderer(),L.ndsModel.getMeshSets());if(v){for(var y,A=0,M=0,m=v.length;M<m;++M)v[M].visualStates.dirty&&v[M].visualStates.visible||(A+=1);K&&(p=1,0<v.length&&(p=A/v.length),2!==G&&0!==v.length||(p=1),(E.useObjectEdgeLine||E.singlePartMode)&&E.objectEdgeLinePass&&(p=E.objectEdgeLinePass.customEdgeDetectLine.precentValue),L.dispatchEvent({type:"updateProgress",userData:{precent:p}}),L.controls.staticAnnotation)&&L.isViewActive(r)&&(y=!1,Math.abs(p-1)<1e-4&&(y=!0),L.controls.staticAnnotation.renderAnnotation(y))}L.controls.getOperator().renderModel(),L.lightControls.renderLight()}L.GeomEmpty&&(void 0===L.backGroundScene||x||L.renderer.render(L.backGroundScene,L.backGroundCamera),L.controls.staticAnnotation)&&L.isViewActive(r)&&(L.clearCanvas2D(),L.renderWaterMark(L.waterInfo),L.controls.staticAnnotation.renderAnnotation()),C&&(L.scene.remove(L.lightControls._scene),L.scene.traverse(function(e){e.hasOwnProperty("geometry")&&e.hasOwnProperty("material")&&(he(e,g)||(e.material=e.materialWhiteMold,e.materialWhiteMold=void 0))}),L.scene.add(L.lightControls._scene)),L.renderer.clippingPlanes=n,De.enableBroadcast&&De.broadcastMajor&&L.broadcastManager.needBroadcast&&L.ndsModel,null!=L.commentManager&&L.commentManager.renderComments(),E.logOperatorTime&&E.logOperatorTimeShow(null,null,!0);t=performance.now(),a=Math.max(a-t+i,0);L.renderStates.remainTime=a,L.renderStates.forceClear=!1,r&&(r.updateRenderStates(L.renderStates),L.viewManager.update())}}else R=S.length=T.length=0}}}),E.prepareModelForRendering=function(){L.preparedForRender||(L.preparedForRender=!0,L.is2DModel&&(L.renderMode="shadedWithEdges"),L.setRenderMode(L.renderMode,!1),L.addLights())},E.getExtension=function(e){return He.getExtension(e)},E.setGridHelperVisible=function(e){var t=L.scene.getObjectByName("GridHelper");t&&(t.visible=e),L.render()},E.getGridHelperVisible=function(){var e=L.scene.getObjectByName("GridHelper");if(e)return e.visible},E.getBackgroundstate=function(){var e={};return L.envmapUrls?(e.backgroundtype="envmap",e.index=L.envmapUrlsindex):L.backGroundImage?(e.backgroundtype="Image",e.index=L.backGroundImageindex):(e.backgroundtype="Color",e.clearColor=L.clearColor),e},E.BloadreleaseModel=function(){return!!L.loadrelease},E.onResize=function(e){L.windowResize&&setTimeout(function(){L.dispatchEvent({type:"windowResize"})},300)},E.enableWindowResize=function(e){L.windowResize=e},E.onWindowResize=function(e,t,r){L.viewBox&&L.viewBox.refreshCube();var i=L.container.getBoundingClientRect(),n=i.width,i=i.height,a=(null!=L.container.clientWidth&&null!=L.container.clientHeight&&(10<Math.abs(n-L.container.clientWidth)&&(n=L.container.clientWidth),10<Math.abs(i-L.container.clientHeight))&&(i=L.container.clientHeight),L.renderer.setSize(n=null!=t?t:n,i=null!=r?r:i),L.viewManager&&L.viewManager.setWindowSize(n,i),q&&L.tlbOperator.onResize(n,i),L.renderer.getPixelRatio());n*=a,i*=a,L.canvas2D&&(L.canvas2D.width=n,L.canvas2D.height=i,L.canvas2D.style.width=n/a+"px",L.canvas2D.style.height=i/a+"px"),L.canvas2DLayer&&(L.canvas2DLayer.width=n,L.canvas2DLayer.height=i,L.canvas2DLayer.style.width=n/a+"px",L.canvas2DLayer.style.height=i/a+"px"),L.cameraControl.setCameraSize(n,i),L.envMapCamera&&(L.envMapCamera.aspect=n/i,L.envMapCamera.updateProjectionMatrix()),D&&L.envMapBlurTargetH&&(t=.5*n,r=.5*i,L.envMapBlurTargetH.dispose(),L.envMapBlurTargetH=new THREE.WebGLRenderTarget(t,r,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBFormat,stencilBuffer:!1}),L.envMapBlurTargetH.texture.generateMipmaps=!1,L.envMapBlurTargetV&&L.envMapBlurTargetV.dispose(),L.envMapBlurTargetV=new THREE.WebGLRenderTarget(t,r,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBFormat,stencilBuffer:!1}),L.envMapBlurTargetV.texture.generateMipmaps=!1,1==o||2==o||3<o)&&(L.envMapBlurPassH&&(L.envMapBlurPassH.material.defines.RESOLUTION=(s/t).toFixed(4),L.envMapBlurPassH.material.needsUpdate=!0),L.envMapBlurPassV)&&(L.envMapBlurPassV.material.defines.RESOLUTION=(s/r).toFixed(4),L.envMapBlurPassV.material.needsUpdate=!0),L.backGroundMesh&&L.backGroundMesh.material&&L.updateBackGroudImageRatio(L.backGroundMesh.material),L.ssaoComposer&&(L.renderTarget&&L.renderTarget.dispose(),L.renderTarget=new THREE.WebGLRenderTarget(n,i,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat}),L.ssaoComposer.reset(L.renderTarget),L.fxaaPass.uniforms.resolution.value.set(1/n,1/i),L.positionTarget&&L.positionTarget.dispose(),L.positionTarget=new THREE.WebGLRenderTarget(n,i,{minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat,type:THREE.FloatType}),L.ssaoPass.uniforms.tPosition.value=L.positionTarget,L.normalTarget&&L.normalTarget.dispose(),L.normalTarget=new THREE.WebGLRenderTarget(n,i,{minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat,type:THREE.FloatType}),L.ssaoPass.uniforms.tNormal.value=L.normalTarget,t=Math.sqrt(n*n+i*i),L.ssaoPass.uniforms.fRadiusNear.value=Math.max(.01*t,2),L.ssaoPass.uniforms.fRadiusFar.value=Math.max(.01*t,2),L.normalRenderTarget&&L.normalRenderTarget.dispose(),L.normalRenderTarget=new THREE.WebGLRenderTarget(n,i,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat}),L.ssaoFilterPass.uniforms.tSSAOMap.value=L.renderTarget,L.ssaoFilterPass.uniforms.tDiffuseOrginal.value=L.normalRenderTarget,L.ssaoFilterPass.uniforms.vSize.value.set(n,i)),Q||(L.effectRenderTarget&&L.effectRenderTarget.dispose(),L.effectRenderTarget=new THREE.WebGLRenderTarget(n,i,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat}),L.effectFXAA.uniforms.resolution.value.set(1/n,1/i)),this.outlinePass?this.outlinePass.setSize(n,i):this.selectionOutlinePass&&this.selectionOutlinePass.setSize(n,i),this.objectEdgeLinePass&&this.objectEdgeLinePass.setSize(n,i),L.pmiVisible&&L.pmiObject&&L.pmiObject.traverse(function(e){var t,r;e.visible&&e.material&&"LineMaterial"==e.material.type&&(t=L.renderer.domElement.width/a,r=L.renderer.domElement.height/a,e.material.resolution.set(t,r))}),L.renderAllViews(),L.ndsModel&&L.renderNew(),He.onAfterWindowsResize(e,n,i)},E.onMouseDown=function(e){De.enableBroadcast&&!De.broadcastMajor||(ee.set(e.clientX,e.clientY),De.enableSelect&&L.enableInternalRMB&&L.showViewMenu(!1),te&&(ie=!(te=!1)),le&&4!==G&&5!==G&&8!==G&&(ie=!(le=!1)),re=!1,L.toggleAutoRotation(!1))},E.onMouseUp=function(e){De.enableBroadcast&&!De.broadcastMajor||(2===e.button&&(e=new THREE.Vector2(e.clientX,e.clientY)).equals(ee)&&0<L.modelInfo.length&&"js"===L.modelInfo[0].type&&De.enableSelect&&L.enableInternalRMB&&L.showViewMenu(!0,e.x,e.y),le=!(te=!0),re&&ie&&(L.render(),ie=!1))},E.showModelBroserMenu=function(e,t,r){e?(L.menuView.getChildElement("itemIsolate").setDisplay(!0),L.menuView.getChildElement("itemHide").setDisplay(!0),L.menuView.getChildElement("itemShowAll").setDisplay(!0),L.menuView.getChildElement("itemProperty").setDisplay(!0),L.menuView.setPos(t,r),L.menuView.setVisibility(!0)):L.menuView.setVisibility(!1)},E.showprompt=function(e,t,r,i){void 0===r&&(r=0),void 0===i&&(i=0),this.promptshow=e,this.promptstring=t,!this.prompt&&this.promptshow&&(this.prompt=document.createElement("div"),this.prompt.className="pc-alert",this.container.appendChild(this.prompt)),this.prompt&&!this.promptshow&&(this.container.removeChild(this.prompt),this.prompt=null),this.prompt&&(this.prompt.clientoffsetX=r,this.prompt.clientoffsetY=i)},E.getSelectedBodyVolumeAndArea=function(){var e,t=L.selectionManager.getSelectedBodyVolumeAndArea();return t?((e=t[0]).modelUnit=t[1],e):null},E.showViewMenu=function(e,t,r){e?(0<(e=L.selectionManager.getSelectedObjects()).length?(L.menuView.getChildElement("itemIsolate").setDisplay(!0),L.menuView.getChildElement("itemHide").setDisplay(!0),L.menuView.getChildElement("itemShowAll").setDisplay(!0),1==e.length?L.menuView.getChildElement("itemProperty").setDisplay(!0):L.menuView.getChildElement("itemProperty").setDisplay(!1)):(L.menuView.getChildElement("itemIsolate").setDisplay(!1),L.menuView.getChildElement("itemHide").setDisplay(!1),L.menuView.getChildElement("itemShowAll").setDisplay(!0),L.menuView.getChildElement("itemProperty").setDisplay(!1)),L.menuView.setPos(t,r),L.menuView.setVisibility(!0)):L.menuView.setVisibility(!1)},E.showSvgMenu=function(e,t,r){e?(L.menuView.getChildElement("itemIsolate").setDisplay(!1),L.menuView.getChildElement("itemSelectObject").setDisplay(!1),L.menuView.setPos(t,r),L.menuView.setVisibility(!0)):L.menuView.setVisibility(!1)},E.onControlsEvent=function(e){if(!(L.controls instanceof Ue)){var t,r,i,n,e=e.event;if("select"==e.subType)t=e.uuid,r=e.userData,i=e.linkID,n=e.linkInstanceID,L.dispatchEvent({type:"selectEvent",uuid:t,userData:r,linkID:i,linkInstanceID:n});else{var a,o=e.event;switch(o.type){case"mousedown":var s=o.button;switch(ce(),s){case 1:case 2:u("btnPan")}break;case"mouseup":de();break;case"mousewheel":0==o.buttons&&(clearTimeout(a),0==L.inWheel&&(L.inWheel=!0,ce()),u("btnZoom"),a=setTimeout(function(){de(),L.inWheel=!1},200))}}}},E.registCursor=function(e,t,r){this.cursors.set(e,{objectUrl:r,url:t})},E.startWaitProcedure=function(){L.inWaitProcedure=!0,L.restoreToolbarCursor(),L.setToolbarCursor("wait")},E.onChangeCursor=function(e){u(e)},E.exitWaitProcedure=function(){L.inWaitProcedure=!1,L.backToolbarCursor()},E.restoreToolbarCursor=function(){if(L.tlbOperator){L.tlbOperator.oldCursor=L.tlbOperator.domElement.style.cursor;for(var e=0;e<L.tlbOperator.childElements.length;e++){var t=L.tlbOperator.childElements[e];t.value.oldCursor=t.value.domElement.style.cursor}}var r=L.renderer.domElement,r=(null!=r&&(r.oldCursor=r.style.cursor),L.canvas2D);null!=r&&(r.oldCursor=r.style.cursor),null!=L.canvas2DLayer&&(L.canvas2DLayer.oldCursor=L.canvas2DLayer.style.cursor)},E.setToolbarCursor=function(e){if(L.tlbOperator){L.tlbOperator.setCursor(e);for(var t=0;t<L.tlbOperator.childElements.length;t++)L.tlbOperator.childElements[t].value.setCursor(e)}var r=L.renderer.domElement,r=(null!=r&&(r.style.cursor=e),L.canvas2D);null!=r&&(r.style.cursor=e),null!=L.canvas2DLayer&&(L.canvas2DLayer.style.cursor=e)},E.backToolbarCursor=function(){if(L.tlbOperator){L.tlbOperator.setCursor(L.tlbOperator.oldCursor);for(var e=0;e<L.tlbOperator.childElements.length;e++){var t=L.tlbOperator.childElements[e];t.value.setCursor(t.value.oldCursor)}}var r=L.renderer.domElement,r=(null!=r&&(r.style.cursor=r.oldCursor),L.canvas2D);null!=r&&(r.style.cursor=r.oldCursor),null!=L.canvas2DLayer&&(L.canvas2DLayer.style.cursor=L.canvas2DLayer.oldCursor)},E.onOpChanged=function(e){var t,r=null!=e?e.target:null;null!=r?(null!=(t=L.btnSelected)&&(t.setBorder(""),t.setBgColor("")),r.setBorder("1px solid rgba(150,150,150,0.8)"),r.setBgColor(De.toolbarButtonClickedBkgColor),u((L.btnSelected=r).domElement.id)):null!=e&&null!=e.id&&u(e.id),L.Optoolbar&&L.Optoolbar.onOpChanged(e)},E.onShowTooltip=function(e){var t=e.event.type,r=e.target.subElements.tooltip;switch(t){case"mouseenter":r.setVisibility(!0);break;case"mouseleave":r.setVisibility(!1)}},E.computeMeshesBoundingBox=function(e,t,r,i,n){void 0===n&&(n=!1);for(var a=0,o=e.length;a<o;++a)L.computeBoundingBox(e[a].key,t,r,i,n)},E.computeVisibleBoundingBox=function(e,t,r,i,n){var a,o,s;if(null!=e)if(this.ndsModel)e===this.scene?(this.ndsModel instanceof NDSWebViewer.NdsModelSet&&!(s=this.ndsModel.getTotalBodyBoundingBox(void 0,n)).isEmpty()||(s=this.modelRootObject.boundingBox.clone()),this.modelRootObject.boundingBox.copy(s),De.inBIMContext&&0<this.ndsModel.ModelUpMatrix4.length&&((a=new THREE.Matrix4).fromArray(this.ndsModel.ModelUpMatrix4),s.applyMatrix4(a)),this.is2DModel&&(s.max.z=s.min.z)):s=this.ndsModel.getVisibleBodyBoundingBox(e,n),s&&(t.copy(s.min),r.copy(s.max));else if(e instanceof THREE.Object3D&&(!n||e.visible)&&!(e instanceof THREE.Light||"lightctrls"==e.name)&&(e.hasOwnProperty("geometry")&&(a=!1,(s=e.geometry)instanceof THREE.Geometry?a=null!=s.vertices&&0!=s.vertices.count:s instanceof THREE.BufferGeometry&&(a=null!=e.geometry.attributes.position),a||s.boundingBox)&&(null==s.boundingBox&&s.computeBoundingBox(),isFinite(s.boundingBox.min.x))&&((a=new THREE.Vector3).copy(s.boundingBox.min),(o=new THREE.Vector3).copy(s.boundingBox.max),(s=new THREE.Box3(a,o)).applyMatrix4(e.matrixWorld),1==i.flag?(t.copy(s.min),r.copy(s.max),i.flag=!1):(t.x=Math.min(t.x,s.min.x),t.y=Math.min(t.y,s.min.y),t.z=Math.min(t.z,s.min.z),r.x=Math.max(r.x,s.max.x),r.y=Math.max(r.y,s.max.y),r.z=Math.max(r.z,s.max.z))),null!=e.children))for(var l=0,d=e.children.length;l<d;++l)L.computeBoundingBox(e.children[l],t,r,i,n)},E.computeBoundingBox=function(e,t,r,i,n){var a,o,s;if(void 0===n&&(n=!1),null!=e)if(this.ndsModel)e===this.scene?(!L.is2DModel&&this.ndsModel instanceof NDSWebViewer.NdsModelSet&&!(s=this.ndsModel.getTotalBodyBoundingBox(null,n)).isEmpty()||(s=this.modelRootObject.boundingBox.clone()),this.modelRootObject.boundingBox.copy(s),De.inBIMContext&&0<this.ndsModel.ModelUpMatrix4.length&&((a=new THREE.Matrix4).fromArray(this.ndsModel.ModelUpMatrix4),s.applyMatrix4(a)),this.is2DModel&&(s.max.z=s.min.z)):s=this.ndsModel.getBodyBoundingBox(e,!1),s&&(t.copy(s.min),r.copy(s.max));else if(e instanceof THREE.Object3D&&!(e instanceof THREE.Light||"lightctrls"==e.name)&&(e.hasOwnProperty("geometry")&&(a=!1,(s=e.geometry)instanceof THREE.Geometry?a=null!=s.vertices&&0!=s.vertices.count:s instanceof THREE.BufferGeometry&&(a=null!=e.geometry.attributes.position),a||s.boundingBox)&&(null==s.boundingBox&&s.computeBoundingBox(),isFinite(s.boundingBox.min.x))&&((a=new THREE.Vector3).copy(s.boundingBox.min),(o=new THREE.Vector3).copy(s.boundingBox.max),(s=new THREE.Box3(a,o)).applyMatrix4(e.matrixWorld),1==i.flag?(t.copy(s.min),r.copy(s.max),i.flag=!1):(t.x=Math.min(t.x,s.min.x),t.y=Math.min(t.y,s.min.y),t.z=Math.min(t.z,s.min.z),r.x=Math.max(r.x,s.max.x),r.y=Math.max(r.y,s.max.y),r.z=Math.max(r.z,s.max.z))),null!=e.children))for(var l=0,d=e.children.length;l<d;++l)L.computeBoundingBox(e.children[l],t,r,i,n)},E.calculatePMIBoundingBox=function(){var n,e=this.pmiObject;return e?e.box3||(n=new THREE.Box3,e.traverse(function(e){var t,r,i;e.hasOwnProperty("geometry")&&(t=!1,(i=e.geometry)instanceof THREE.Geometry?t=null!=i.vertices&&0!=i.vertices.count:i instanceof THREE.BufferGeometry&&(t=null!=e.geometry.attributes.position),t||i.boundingBox)&&(null==i.boundingBox&&i.computeBoundingBox(),isFinite(i.boundingBox.min.x))&&((t=new THREE.Vector3).copy(i.boundingBox.min),(r=new THREE.Vector3).copy(i.boundingBox.max),(i=new THREE.Box3(t,r)).applyMatrix4(e.matrixWorld),n.expandByPoint(i.min),n.expandByPoint(i.max))}),isFinite(n.min.x)?e.box3=n:null):null},E.switchRotateCenterBySelection=function(e){void 0===e&&(e=!1);var t=L.selectionManager.getSelectedObjects();if(0<t.length&&e){for(var r=new THREE.Box3,i=0;i<t.length;++i){var n=t[i],n=L.ndsModel.getBodyBoundingBox(n);n&&(r.expandByPoint(n.max),r.expandByPoint(n.min))}e=r.getCenter();L.cameraControl.setRotateCenter(e)}else{L.emptyCenter.set(0,0,0);e=L.controls.getBoundingBox().getCenter(L.emptyCenter);L.cameraControl.setRotateCenter(e)}e=L.controls.getOperator();e&&e.updateRotateCenterHelper()},E.zoomExtents=function(e,t,r){this.cameraControl.zoomExtents(e,t,r)},E.zoomToObject=function(e,t){this.cameraControl.zoomToObject(e,t)},E.setCameraFromEulerDis=function(e,t){if(e){if(Math.abs(L.ScenarioEditorInfo.EulerAngle.x-THREE.Math.degToRad(e.x))<.01&&Math.abs(L.ScenarioEditorInfo.EulerAngle.y-THREE.Math.degToRad(e.y))<.01&&Math.abs(L.ScenarioEditorInfo.EulerAngle.z-THREE.Math.degToRad(e.z))<.01)return;var r=L.camera.position.clone().sub(L.cameraControl.center()).length(),i={smoothTranslation:!1,useOrginal:!0},i=(L.defaultStandardView="",i.type="",L.look(i),this.getCameraInfo()),n=new THREE.Euler(THREE.Math.degToRad(e.x),THREE.Math.degToRad(e.y),0),a=new THREE.Euler(0,0,THREE.Math.degToRad(e.z)),o={smoothTranslation:!1},s=new THREE.Vector3(0,0,1),s=(s.applyEuler(n).applyEuler(a).normalize(),o.from=s.toArray(),new THREE.Vector3(0,1,0)),n=(s.applyEuler(n).applyEuler(a).normalize(),o.up=s.toArray(),L.resetCamera(o),L.getCameraInfo()),a=new THREE.Vector3(n.target.x,n.target.y,n.target.z),s=new THREE.Vector3(n.position.x,n.position.y,n.position.z).sub(a).normalize().multiplyScalar(r);L.camera.position.copy(s.add(a)),(o=L.cameraControl.calFarthestDistToCamera())>L.camera.far&&(L.camera.far=o),L.viewBox&&L.cameraControl.updateViewBoxCamDir(),L.camera.updateProjectionMatrix(),L.camera.updateMatrixWorld(!0),L.ScenarioEditorInfo.EulerAngle.set(THREE.Math.degToRad(e.x),THREE.Math.degToRad(e.y),THREE.Math.degToRad(e.z))}t&&(i=L.camera.getOrginalCameraInfo(),r=new THREE.Vector3(i.position.x-i.center.x,i.position.y-i.center.y,i.position.z-i.center.z).length(),n=L.getCameraInfo(),a=new THREE.Vector3(n.target.x,n.target.y,n.target.z),s=new THREE.Vector3(n.position.x,n.position.y,n.position.z).sub(a).normalize().multiplyScalar(r/20*t),L.camera.position.copy(s.add(a)),(o=L.cameraControl.calFarthestDistToCamera())>L.camera.far&&(L.camera.far=o),L.camera.updateProjectionMatrix(),L.camera.updateMatrixWorld(!0)),L.groundShadowChange(),L.render()},E.getDwgScale=function(){return this.dwgScale},E.getScreenCapture=function(e,t,r){return this.getScreenCapture2(e,!1,!1,t,r),"111"},E.getScreenCapture2=function(s,l,e,d,c,t,h,r,u){var p,f,m,g,v;function y(e,t,r,i){t&&t(e),r&&L.dispatchEvent({type:"snapEvent",cameraInfo:L.getCameraInfo(),imgData:e}),i&&(t="<div align='center'><img src='"+e+"'></img></div>",(r=window.open()).document.open(),r.document.write(t),r.document.close())}function A(e){var t,r,i,n,a,o;e.userData.precent<.99&&!L.renderer.stopRenderingEarly||(t=document.createElement("canvas"),r=t.getContext("2d"),e=L.renderer.domElement.toDataURL(),i=L.canvas2D.toDataURL(),t.width=L.renderer.domElement.width,t.height=L.renderer.domElement.height,r.fillStyle=L.container.style.backgroundColor,r.fillRect(0,0,t.width,t.height),n=new Image,u&&L.viewManager?(a=document.getElementById("t_container"),(o=L.viewManager.getActiveView()).displayViewBox(!1),html2canvas(a,{useCORS:!0,allowTaint:!0,ignoreMouse:!0,ignoreAnimation:!0}).then(function(e){e=e.toDataURL();n.onload=function(){var e=L.viewManager.getActiveViewCanvasSizeForScreenCapture();r.drawImage(n,e.x,e.y,e.width,e.height,0,0,t.width,t.height),y(t.toDataURL(),s,l,d)},n.src=e}),o.displayViewBox(!0)):(n.onload=function(){var e;r.globalAlpha=1,r.drawImage(n,0,0),f||p?((e=new Image).onload=function(){h||r.drawImage(e,0,0),y(t.toDataURL(),s,l,d)},e.src=i):y(t.toDataURL(),s,l,d)},n.src=e),L.removeEventListener("updateProgress",A),He.onAfterScreenCapture(),g&&L.__globalMeasureExtension&&L.__globalMeasureExtension.setMeasureVisible(!0,!1),null!=c&&c||m&&L.lightControls.setVisible(!0),null!=v?(L.viewManager=v,L.renderAllViews()):L.render())}void 0===h&&(h=!1),void 0===r&&(r=!1),void 0===u&&(u=!1),L.GeomEmpty||(p=!0===t,f=e&&(L.watermark||L.waterInfo.text||L.waterInfo.imageSrc)&&L.excalibur,L.lightControls.getVisible()&&(m=!0),null!=c&&c||m&&L.lightControls.setVisible(!1),g=!1,v=void 0,He.onBeforeScreenCapture({bFullScreenCapture:h,bShowClipPlane:r,bCreateNewView:u}),!h&&L.__globalMeasureExtension&&(!p&&L.__globalMeasureExtension.getMeasureVisible()&&(L.__globalMeasureExtension.setMeasureVisible(!1,!1),g=!0),L.__globalMeasureExtension.endMeasure()),this.is2DModel||!this.viewManager||h||u||(this.viewManager.restoreRenderTargetToSingleView(),v=this.viewManager,this.viewManager=void 0,this.render()),L.render(),L.addEventListener("updateProgress",A,!1))},E.getImagePortion=function(e,t,r,i,n,a){var o=document.createElement("canvas"),s=o.getContext("2d"),l=(o.width=t,o.height=r,document.createElement("canvas")),d=l.getContext("2d");return l.width=e.width,l.height=e.height,d.drawImage(e,0,0),s.drawImage(l,i,n,a,a,0,0,t,r),o.toDataURL()},E.getScreenCapturethumbnailByData=function(o,e){var s,l=1280,d=768,c=(e&&(l=e.width||l,d=e.height||d,s=e.backgroundColor,t=e.opacity,f=e.cameraPosition,m=e.cameraTarget),this.getBackgroundstate()),h=(c.alpha=this.renderer.getClearAlpha(),c.alpha),e=(void 0!==s&&s&&("envmap"==c.backgroundtype?(c.envmapUrls=this.envmapUrls,c.envmapUrlsindex=this.envmapUrlsindex,c.envMapCamera=this.envMapCamera,c.envMapScene=this.envMapScene,this.envMapTexture&&(c.envMapTexture=this.envMapTexture.clone()),this.envMapMaterial&&(c.envMapMaterial=this.envMapMaterial.clone()),c.exchangeBackImage=this.exchangeBackImage):"Image"==c.backgroundtype&&(c.backGroundScene=this.backGroundScene,c.backGroundCamera=this.backGroundCamera,c.backGroundMesh=this.backGroundMesh,this.backGroundMesh)&&this.backGroundMesh.material&&this.backGroundMesh.material.map&&(c.backGroundMesh.material.map=this.backGroundMesh.material.map.clone()),(e=new THREE.Color).set(s),this.setBackGroundColor(e.getHex())),void 0!==t&&(h=t,this.bBackGroundTransparent?this.renderer.setClearAlpha(0):this.renderer.setClearAlpha(t)),this.onWindowResize(null,2*l,2*d),new THREE.Vector3),t=new THREE.Vector3,r={flag:!0},i=(this.is2DModel?(p=this.modelRootObject.boundingBox.clone(),this.computeVisibleBoundingBox(this.scene,e,t,r,void 0,!0),i=p.max.x-p.min.x,a=p.max.y-p.min.y,n=this.modelRootObject.boundingBox.max.x-this.modelRootObject.boundingBox.min.x,u=this.modelRootObject.boundingBox.max.y-this.modelRootObject.boundingBox.min.y,(i<n||a<u)&&this.modelRootObject.boundingBox.copy(p)):this.computeVisibleBoundingBox(this.scene,e,t,r,void 0,!0),e=this.modelRootObject.boundingBox.min,t=this.modelRootObject.boundingBox.max,new THREE.Vector3),n=(i.x=.5*(t.x+e.x),i.y=.5*(t.y+e.y),i.z=.5*(t.z+e.z),new THREE.Vector3);(n=n.subVectors(t,e)).length()<1e-6&&n.set(1,1,1);var a=.5*n.length()/Math.sin(Math.PI/180*this.camera.fov*.5),u=(this.camera.IsPerspective()&&this.camera.aspect<1&&(a/=this.camera.aspect),this.camera.far=5*(a=0==a?1e-4:a),this.camera.setZoomToFitRatio(5),this.camera.far<1e3&&(this.camera.setZoomToFitRatio(1e3/a),this.camera.far=1e3),2e3<this.camera.far/this.camera.near&&(this.camera.near=this.camera.far/2e3),this.camera.near>.25*n.length()&&(this.camera.near=.25*n.length()),this.camera.perpNear>.25*n.length()&&(this.camera.perpNear=.25*n.length()),new THREE.Vector3(0,0,0).sub(new THREE.Vector3(1,1,1))),t=(this.camera.getOrginalCameraInfo()&&(p=new THREE.Vector3,r=new THREE.Vector3,p.copy(this.camera.getOrginalCameraInfo().center),r.copy(this.camera.getOrginalCameraInfo().position),p.sub(r),p.normalize(),u.copy(p)),u.normalize(),u.multiplyScalar(a),i.clone().sub(u)),e=(this.groundShadow.updateGroundTransform(this.camera,this.modelRootObject.boundingBox),this.camera.setOrthoNear(this.modelRootObject.boundingBox),f?this.camera.position.set(f.x,f.y,f.z):this.camera.position.copy(t),m?this.camera.setCameraTarget(new THREE.Vector3(m.x,m.y,m.z)):this.camera.setCameraTarget(i),this.camera.updateProjectionMatrix(),this.camera.updateMatrixWorld(!0),this.render(),this.modelRootObject.boundingBox),n=[],r=(n[0]=e.max.x,n[1]=e.max.y,n[2]=e.max.z,this.modelCoordToClientCoord(n)),p=((n=[])[0]=e.min.x,n[1]=e.max.y,n[2]=e.min.z,this.modelCoordToClientCoord(n)),a=((n=[])[0]=e.min.x,n[1]=e.max.y,n[2]=e.max.z,this.modelCoordToClientCoord(n)),u=((n=[])[0]=e.max.x,n[1]=e.max.y,n[2]=e.min.z,this.modelCoordToClientCoord(n)),f=((n=[])[0]=e.min.x,n[1]=e.min.y,n[2]=e.min.z,this.modelCoordToClientCoord(n)),t=((n=[])[0]=e.min.x,n[1]=e.min.y,n[2]=e.max.z,this.modelCoordToClientCoord(n)),m=((n=[])[0]=e.max.x,n[1]=e.min.y,n[2]=e.min.z,this.modelCoordToClientCoord(n)),i=((n=[])[0]=e.max.x,n[1]=e.min.y,n[2]=e.max.z,this.modelCoordToClientCoord(n)),e=Math.max(r[0],p[0],a[0],u[0],f[0],t[0],m[0],i[0]),n=Math.min(r[0],p[0],a[0],u[0],f[0],t[0],m[0],i[0]),g=Math.max(r[1],p[1],a[1],u[1],f[1],t[1],m[1],i[1]),r=Math.min(r[1],p[1],a[1],u[1],f[1],t[1],m[1],i[1]),v=(e*=this.renderer.getPixelRatio(),n*=this.renderer.getPixelRatio(),g*=this.renderer.getPixelRatio(),r*=this.renderer.getPixelRatio(),e-n),y=g-r,A=0,M=0,E=(d<y*(.9*l/v)?A=v*((M=.9*d)/y):M=y*((A=.9*l)/v),M=M||1,A=A||1,(e+n)/2-v/2),w=(g+r)/2-y/2,x=this;this.getScreenCapture(function(e){var a=new Image;a.src=e,a.onload=function(){var e="rgb("+(255*(e=void 0===x.initialBackgroundColor||s?x.renderer.getClearColor():x.initialBackgroundColor).r|0)+","+(255*e.g|0)+","+(255*e.b|0)+")",t=(x.bBackGroundTransparent||(new THREE.Color).setStyle(e),document.createElement("canvas")),r=t.getContext("2d"),i=(t.width=l,t.height=d,document.createElement("canvas")),n=i.getContext("2d"),n=(i.width=A,i.height=M,n.fillStyle=e,n.drawImage(a,E,w,v,y,0,0,A,M),r.fillStyle=e,x.bBackGroundTransparent&&(r.globalAlpha=h),r.fillRect(0,0,l,d),r.globalAlpha=1,r.drawImage(i,0,0,A,M,(l-A)/2,(d-M)/2,A,M),t.toDataURL());o&&o(n),x.onWindowResize();x.look({smoothTranslation:!1,useOrginal:!0}),void 0!==s&&s&&("envmap"==c.backgroundtype?(x.envmapUrls=c.envmapUrls,x.envmapUrlsindex=c.envmapUrlsindex,x.envMapCamera=c.envMapCamera,x.envMapScene=c.envMapScene,c.envMapTexture&&(x.envMapTexture=c.envMapTexture),c.envMapMaterial&&(x.envMapMaterial=c.envMapMaterial),x.exchangeBackImage=c.exchangeBackImage):"Image"==c.backgroundtype?(x.backGroundScene=c.backGroundScene,x.backGroundCamera=c.backGroundCamera,x.backGroundMesh=c.backGroundMesh,x.setBackGroundImage(c.backGroundImage)):"Color"==c.backgroundtype&&x.setBackGroundColor(c.clearColor),x.renderer.setClearAlpha(c.alpha),x.renderNew())}},null,null)},E.getBackgroundstate=function(){var e={};return L.envmapUrls?(e.backgroundtype="envmap",e.index=L.envmapUrlsindex):L.backGroundImage?(e.backgroundtype="Image",e.backGroundImage=L.backGroundImage):(e.backgroundtype="Color",e.clearColor=L.clearColor),e},E.getScreenCapturethumbnail=function(i,e){var n=400,a=400,e=(e&&(n=e.width||n,a=e.height||a),this.modelRootObject.boundingBox),t=[],r=(t[0]=e.max.x,t[1]=e.max.y,t[2]=e.max.z,this.modelCoordToClientCoord(t)),o=((t=[])[0]=e.min.x,t[1]=e.max.y,t[2]=e.min.z,this.modelCoordToClientCoord(t)),s=((t=[])[0]=e.min.x,t[1]=e.max.y,t[2]=e.max.z,this.modelCoordToClientCoord(t)),l=((t=[])[0]=e.max.x,t[1]=e.max.y,t[2]=e.min.z,this.modelCoordToClientCoord(t)),d=((t=[])[0]=e.min.x,t[1]=e.min.y,t[2]=e.min.z,this.modelCoordToClientCoord(t)),c=((t=[])[0]=e.min.x,t[1]=e.min.y,t[2]=e.max.z,this.modelCoordToClientCoord(t)),h=((t=[])[0]=e.max.x,t[1]=e.min.y,t[2]=e.min.z,this.modelCoordToClientCoord(t)),e=((t=[])[0]=e.max.x,t[1]=e.min.y,t[2]=e.max.z,this.modelCoordToClientCoord(t)),t=Math.max(r[0],o[0],s[0],l[0],d[0],c[0],h[0],e[0]),u=Math.min(r[0],o[0],s[0],l[0],d[0],c[0],h[0],e[0]),p=Math.max(r[1],o[1],s[1],l[1],d[1],c[1],h[1],e[1]),r=Math.min(r[1],o[1],s[1],l[1],d[1],c[1],h[1],e[1]);t*=this.renderer.getPixelRatio(),u*=this.renderer.getPixelRatio(),p*=this.renderer.getPixelRatio(),r*=this.renderer.getPixelRatio();var f=Math.max(t-u,p-r),m=(t+u)/2-(f+=10)/2,g=(p+r)/2-f/2;this.getScreenCapture(function(e){var t=new Image,r=(t.src=e,L);t.onload=function(){var e=r.getImagePortion(t,n,a,m,g,f);i&&i(e)}},null,null)},E.getScreenCaptureByParams=function(e,t,r,i,n){var a,o=L.container.getBoundingClientRect(),s=o.width,o=o.height,l=(L.lightControls.getVisible()&&(a=!0),null!=n&&n||a&&L.lightControls.setVisible(!1),s!=e||o!=t?L.onWindowResize(null,e,t):L.render(),L.renderer.domElement.toDataURL());return s==e&&o==t||L.onWindowResize(null,s,o),r&&r(l),i&&window.open(l),null!=n&&n||a&&L.lightControls.setVisible(!0),l},E.getCameraInfo=function(){return this.cameraControl.getCameraInfo()},E.getlightInfo=function(){for(var e=[],t=L.lightControls.getLightsCount(),r=0;r<t;r++){var i=L.lightControls.getLight(r),n={};switch(i.type){case"DirectionalLight":n=L.lightControls.getDirLightParam(i);break;case"PointLight":n=L.lightControls.getPointLightParam(i);break;case"HemisphereLight":n=L.lightControls.getHemiLightParam(i);break;case"SpotLight":n=L.lightControls.getSpotLightParam(i);break;case"None":n=L.lightControls.getDirLightParam(i)}n.type=i.type,e.push(n)}return e},E.resetSvgViewBox=function(){L.svgViewer.resetSvgViewBox()},E.resetCamera=function(e){x?(L.cameraControl.set2DViewerInfo(L.viewer2DInfo),L.render()):(e.type=L.defaultStandardView,L.viewManager?L.viewManager.resetCamera():L.look(e)),De.autoSwitchFirstPersonView&&"FirstPerson"==c&&(c=this.originalModelOperationMode)},E.look=function(e){var t=e.type;e.callback=function(){var e=L.getCameraInfo(),e=new THREE.Vector3(e.position.x-e.target.x,e.position.y-e.target.y,e.position.z-e.target.z),e=(new THREE.Quaternion).setFromUnitVectors(new THREE.Vector3(0,0,1).normalize(),e.normalize()),e=(new THREE.Euler).setFromQuaternion(e);L.ScenarioEditorInfo.EulerAngle.set(e.x,e.y,e.z),t?(L.dispatchEvent({type:"Eulerchangedir",x:180*e.x/Math.PI,y:180*e.y/Math.PI,z:180*e.z/Math.PI}),L.dispatchEvent({type:"dischangedir",distance:20})):(L.dispatchEvent({type:"Eulerchange",x:180*e.x/Math.PI,y:180*e.y/Math.PI,z:180*e.z/Math.PI}),L.dispatchEvent({type:"dischange",distance:20}))},e.sphericalTransition=!L.CADViewer,this.cameraControl.look(e)},E.getSvgScreenCapture=function(r){var i=L.svgViewer.svgCanvas,e=L.svgViewer.svgObj.style.width,t=L.svgViewer.svgObj.style.height,n=(i.domElement.width=e,i.domElement.height=t,L.svgViewer.getSvgElement());n.getAttribute("width")&&n.setAttribute("width",e);n.getAttribute("height")&&n.setAttribute("height",t);var e=n.outerHTML,a=(void 0===e&&(e=(new XMLSerializer).serializeToString(n)),window.URL||window.webkitURL||window),o=new Image,t=(o.crossOrigin="Anonymous",new Blob([e],{type:"image/svg+xml;charset=utf-8"})),s=a.createObjectURL(t);o.onload=function(){var e=i.domElement.getContext("2d"),t=(e.drawImage(o,0,0),a.revokeObjectURL(s),i.domElement.toDataURL());r&&r(t),window.open(t),e.clearRect(0,0,i.domElement.width,i.domElement.height)},o.src=s},E.getSvgViewportInfo=function(){return{type:"SvgCamera",width:L.svgViewer.svgObj.style.width,height:L.svgViewer.svgObj.style.height,viewBox:L.svgViewer.getSvgElement().getAttribute("viewBox")}},E.showWaiterCoverStater=function(e,t,r){L.showWaiter(e=null==e||e),L.showCoverer(t=null!=t?t:e),L.showStater(r=null!=r?r:e)},E.showWaiter=function(e){L.bHasLoadingWaiter&&(e?(L.waiter||new fn(L,_.loadingWaiterColor),L.waiter.setVisibility(e)):L.waiter&&(L.container.removeChild(L.waiter.domElement),L.waiter=null))},E.showCoverer=function(e){L.bHasLoadingCoverer&&(e?(L.coverer||new Xr(L,_.loadingCovererColor),L.coverer.setVisibility(e)):L.coverer&&(L.container.removeChild(L.coverer.domElement),L.coverer=null))},E.showStater=function(e){L.bHasLoadingStater&&L.stater.show(e)},E.addButton=function(e,t){this.Optoolbar&&this.Optoolbar.addButton(e,t)},E.setPmiVisible=function(e){null!=e&&L.pmiVisible!=e&&null!=L.pmiObject&&(L.pmiVisible=e,L.renderAllViews())},E.setPmiVisible2=function(e){var t,r,i,n;null!=e&&L.pmiVisible!=e&&null!=L.pmiObject&&((L.pmiVisible=e)&&(t=this.controls.getBoundingBox().clone(),r=this.calculatePMIBoundingBox())&&!t.containsBox(r)&&(t.union(r),r=new THREE.Vector3,t.getCenter(r),t=t.min.distanceTo(t.max),i=this.camera.position.clone(),r=Math.abs(r.distanceTo(i))+1.2*t,this.camera.adjustNearFar(r,r)),1==(i=L.pmiObject.children[0]).version?L.setPMIObjectVisible(i,e):2==i.version&&(n=He.getExtension("NDSSketchPMIExtension"))&&e&&this.PMINDSBodys.forEach(function(e){"PMI"!=e.type&&L.getPMIObjectByuuid(e.uuid,e.ndsModel.id).visible&&n.showSketchObjectByPMIuuid(e.uuid,e.ndsModel.id)}),L.renderAllViews())},E.isPmiVisible=function(){return L.pmiVisible},E.loadModel=function(e,t,r,i,n,a,o,s,l){if(null==e||null==t)return!1;function d(e){var t=/\/model\.js$/;return t.test(e)?e.replace(t,""):e}if(L.ndsModel&&L.newrootBodyNode&&(L.ndsModel.modelTree=new Map),L.newrootBodyNode&&(L.newrootBodyNode=null),He.getExtension("ClipExtension")&&He.getExtension("ClipExtension").clear(),Array.isArray(t)){y=M=A=t.length;for(var c=0;c<t.length;c++){var h=t[c];t[c]=d(h),l.modelInfos[c].url=d(l.modelInfos[c].url)}}else{var u,p=t.split(",");1===p.length?-1!==(t=p[0]).indexOf("json")?L.isDisaModel=!0:L.isDisaModel=!1:(u=p[p.length-1],p[p.length-1]=u.substr(0,u.lastIndexOf("/")),t=p),l.NoChangeDispathcNum||(y=M=A=1)}switch(L.ndsModel||(L.ndsModel=new er(L)),L.ndsModel&&!L.ndsModel.isEmpty()&&0<L.ndsModel.meshManager.nMeshes?(F=l.resetCamera||!1,l.resetCamera&&(L.camera.setOrginalCameraInfo(void 0),L.controls.SetBoundingBoxUpdated(!1))):(F=!0,L.ndsModel&&L.camera.setOrginalCameraInfo(void 0)),this.currentRequestorName=(l=l||{}).CurrentRequestorName,L.initViewer(),L.ConfigNum=void 0===l.configNum?L.ConfigNum:l.configNum,L.ConfigName=void 0===l.configName?L.ConfigName:l.configName,L.useUnvisibleList=void 0!==l.useUnvisibleList&&l.useUnvisibleList,L.useTransparentList=void 0!==l.useTransparentList&&l.useTransparentList,l.rootName&&(L.rootBodyNodeName=l.rootName),L.unvisibleList=l.unvisibleList,L.transparentList=l.transparentList,L.checkVisibleList=l.checkVisibleList,L.clipPlaneInfo=l.clipPlaneInfo,L.clipBoxInfo=l.clipBoxInfo,L.pmiVisible=void 0===l.pmiVisible?L.viewerPMIVisible:l.pmiVisible,L.measuringScale=void 0===l.measuringScale?1:l.measuringScale,L.trueMapList=s,void 0!==l.viewState&&(L.renderMode=l.viewState),-1!=De.ScenarioEditorid||Array.isArray(t)||((u=t.split("/")).pop(),u.pop(),this.folderPath=u.join("/")+"/"),n){case"js":case"obj":case"obj_json":L.load3D(t,r,i,a,n,o,l);break;case"svg":L.svgViewer.loadSvg(Pe.encodeURL(t),a)}L.modelInfo.push({id:e,type:n,url:t}),L.isRunning||L.run()},E.loadFlateDate=function(e,i){this.initViewer(!0);e=Sn()(e);(new JSZip).loadAsync(e,{base64:!1}).then(function(t){L.ZIPData=t,L.zipMutiModel=!0;var r="Configurations.json";i&&(i.endsWith("/")||(i+="/"),r=i+r),Object.keys(t.files).forEach(function(e){e=t.files[e];r==e.name&&t.file(e.name).async("string").then(function(e){L.dispatchEvent({type:"Configurations",userData:e})})})}).catch(function(e){console.error("解压失败：",e)})},E.loadModelFlate=function(e,t,r){L.ConfigNum=void 0===t.configNum?0:t.configNum,L.ConfigName=void 0===t.configName?"":t.configName,L.useUnvisibleList=void 0!==t.useUnvisiblelist&&t.useUnvisiblelist,L.unvisibleList=t.unvisiblelist,y=M=A=1,L.modelInfo.push({id:0,type:"Flate",url:e}),L.ndsModel||(L.ndsModel=new er(L)),L.loadParams.has(e)||L.loadParams.set(e,[]),L.loadParams.get(e).push(t);var i=e.split("/");i.pop(),i.pop(),this.folderPath=i.join("/")+"/",L.initViewer(),L.load3D(e,null,null,null,L.zipMutiModel?"js_zip":"zip",r,t)},E.allowshow=function(e,s){var e=Pe.encodeURL(e),t=new Rt;t.setCrossOrigin(this.crossOrigin),t.load(L.gobalReqHeader,e,function(e){var t=null,r=1;if((t=JSON.parse(e)).fileID||t.Watermark){for(var i="",n=(t.fileID?i=t.fileID.slice(4):t.Watermark&&t.Watermark.Mark&&(i=t.Watermark.Mark.slice(4)),""),a=0;a<i.length/4;a++){var o=i.slice(4*a,4*(a+1));n+=String.fromCharCode(parseInt(o,16))}"Viewer版本过低，请升级"==n&&(r=2)}s(r)},function(){},function(){s(3)})},E.allowRenderModel=function(e,t){var r=new JSEncrypt,r=(r.setPrivateKey("MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQCxl/XzEMiiYrLq prR5BxAY+IPkPdOtiEt7fP3jtxac0m5S1FAT/3jiQb+bTmqeffsl5gw7LaMMOkAj 5h+HzH/TbTmxYn4dIUkGFvvZHAiwMuDA+7fORjhTaz1hmQi1gUNX9Qu985ys2jFb eXAg5XV2orovM+qY3regbNkWwVk3iJ1Kk3rk2ZBw26AVvs+ujVvAE8cGP/LgAAOe CvNDTiA//agCTajQo1xSkAIcLSNKdUfn5OdTlx0sifXcw5NUmBZKbQ7Q7tC0Xpa1 RanG+5riOzLcw6zOKwHn62Hp3Twosc/hLATaOmz/ru5rnNe+bDBndp3iRo/zCiL8 8iwmg+s7AgMBAAECggEBAJnBWusKSOpuUUDe+7kc6E72OhpNfQrsyY0sdhPE3AsC FQoZTwtBT8Nz8RPhHGYD5IC3XzeNF3DqrcVm4z2LS9Ac7Koq/8zwmGxxUbJylwMV yYjLZiNsoC941Te+as/aDhgEzBm05Jyye7Eavn18q+n+kPt1E1Mu4ARAuOL+muN8 LNqNFOMSYzocXRJqnKSXnnIQQa6FvA6UiM8DaJcXJ83V24tF0vaLfCOOFvfNQwGN gNapppvJGSqE1QjrNwllO8O8cBmiC0PIW0lff2qeXH6bfhzUiaMa70sDEEHcZlW5 WmoJABjYwEH5xvjCqieK5SOGKwQkwFj0gcqBKGWZPYECgYEA6xAV4UqvvIlRvlMI eKAlJJwS10M9avScyq9W+fJk0KVqstGGdIDklRy4pd1SALDwKU4C58I/5Gsky+S+ iPwUaZySWjwgdBl4icv3cbUdu61gUUdHfDh+d+hZcnRKa9EzQEPReOkcVpSlfxnJ oaS7psozL3nUfJrTH+QlflesQXECgYEAwWl1dpcCJkmuacUhzCsZ29BljREjlPK6 6qnjUEY/IWqddH2ZWrJBB+6ZSNYSniNqpsjnFPccQdEfk2kxWLjeCCNb42Lukm6F rrJt7Kit7KW0VDyN7+etkzGRfM0QQl9mhX4wUxWyCKdgq7+Ut/nwlYhZi7TN86n7 qRBN1HPlIWsCgYEA0Q43R20TKoy+RJS4Xf+fyRV9tDE6+Fqg76pNonIvs1jKskqi WA8iPHOUzP8vJSo4DaQx9UjPZijcSvIfetkmll8H0nTTMC5PA86BPYGk9ftWRDMu oo3j/GSK2L4QSh9+g1NNg0lfSKlfHtEigD5wHgCK0Vh64G8aAaz4o4r5yiECgYBH G93K5wQsTYSpcIfXh7UvIvRjI/0AAyoDoshnOBx3zbnsHU1nkgfkwa1roQEhUQYi IdUL2TpzXE6OpOs2omlHdrCO7k2mWqodq45Mp0uiqN2e5tCMdpJTfrLtvnsO3AJW bCmaMmzNT7R0ELC930+7unCps6TQxBs5cjwbMyz31wKBgF1wlS2cWsuOQ76t8LPn jXC6nsU2eisWN5KFbxhNphCnqxgYBJth5Vk3OIby2nmvNGqO12p1bUZpbVEBttyj JcXR+iuasOWWev0SuUFZvp3bYEiX/sCjWZbB9mBjg/s6QW5z4ZW9rF6UdOr7ISQ8 6g9cU4ontroPvD52Jcffyr3f"),r.decrypt(e));return r?(e=JSON.parse(r),t?!0===e.visit?(L.excalibur=!0,2):!1===e.visit?1:3:(console.log("公司信息比对"),void 0===e.company?3:1)):3};function ue(){console.log("do not invoke onLoadCallback anymore")}var pe=function(e){e&&e.render&&(void 0!==e.render.showLines&&L.setLinesVisibility(e.render.showLines,!1),void 0!==e.render.enableAutoRotation&&(oe=e.render.enableAutoRotation),void 0!==e.render.enableGroundShadow&&(P=e.render.enableGroundShadow),void 0!==e.render.enableSmoothTranslation&&(ae=e.render.enableSmoothTranslation),void 0!==e.render.enableEnvMap&&(k=e.render.enableEnvMap),void 0!==e.render.envMapReflectionRatio&&e.render.envMapReflectionRatio,void 0!==e.render.envMapTextures?L.setEnvMapTextures(e.render.envMapTextures):void 0!==e.render.backGroundImage&&L.setBackGroundImage(e.render.backGroundImage),void 0!==e.render.envMapBlurLevel&&(l=e.render.envMapBlurLevel),void 0!==e.render.enableEnvMapBlur&&L.setEnvMapBlurEnabled(e.render.enableEnvMapBlur),void 0!==e.render.renderMode&&L.setRenderMode(e.render.renderMode,!1),void 0!==e.render.modelUpDirection)&&L.initModelUpDirection(e.render.modelUpDirection)},fe=(E.loadRemainExtension=function(){if(this.parameters.CustomExtensions)for(var e=0;e<this.parameters.CustomExtensions.length;++e){var t=this.parameters.CustomExtensions[e];this.parameters.singleHTML||t.imi||f(t.name,t.url,t.token).then(function(){})}},E.LoadExtension=function(e,t,r){f(e,t,r).then(function(){})},E.removeExtension=function(e){He.removeExtension(e)},function(){var r=Za(Qa().mark(function e(n,a){var o,s,l,d,c,h,u,p,f,m,g,v,y,A,M,E,w,x,b,B,I,T,S,R,C,D,P,H;return Qa().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(a&&L.ndsModel){e.next=2;break}return e.abrupt("return");case 2:if(n&&L.ndsModel&&!L.ndsModel.rootBodyNode)return e.abrupt("return");e.next=4;break;case 4:if(Ce.StartRenderTime=Date.now(),L.nBufferChunksLoaded+=1,L.ndsModel&&L.nBufferChunksLoaded%10==0&&L.renderAllViews({needsClear:!1}),L.ndsModel&&5<L.nBufferChunksLoaded&&(o=L.nBufferChunksLoaded/L.nBufferChunks,L.dispatchEvent({type:"updateProgress",userData:{precent:o}})),j=V=!0,ne||(O.onLoad(),F&&L.resetCamera({useOrginal:!0,smoothTranslation:!1})),ne=!0,L.groundShadow.needClear=!0,De.enableBroadcast&&L.render(),n){L.ndsModel instanceof NDSWebViewer.NdsModel&&((o=new er(L)).addModel(L.ndsModel),L.ndsModel=o,De.ScenarioEditorid=0),L.allLoaded=!0,8==L.getRenderMode()&&L.setRenderMode("transparent"),L.animationsManager&&L.animationsManager.hasAnimations()?De.enableBroadcast||0!=L.turnoffAnimation||L.startAnimationByUUID(_.animationUUID,!0):O.onSmoothTranslationDone=function(){O.onSmoothTranslationDone=void 0,(!L.ndsModel||L.ndsModel.geomManager.bufferChunksToLoad&&0==L.ndsModel.geomManager.bufferChunksToLoad.length)&&L.toggleAutoRotation(!0)},F&&(s={useOrginal:!0,smoothTranslation:!!L.CADViewer},L.Euler&&((l=new THREE.Vector3(0,0,1)).applyEuler(L.Euler),s.from=l.toArray(),(d=new THREE.Vector3(0,1,0)).applyEuler(L.Euler),s.up=d.toArray()),L.resetCamera(s)),!L.backGroundScene&&L.is2DModel&&(c="0x"+L.renderer.getClearColor(this.oldClearColor).getHexString(),L.clearColor=null,L.setBackGroundColor(c)),c=L.ndsModel?L.ndsModel.getGeometriesCount():ge(L.scene),console.log("Mesh  count : "+c.Mesh.count+"   triangles : "+c.Mesh.triangles+"   points : "+c.Mesh.points),console.log("Line  count : "+c.Line.count+"   points : "+c.Line.points),De.enableBroadcast&&De.broadcastMajor&&(document.addEventListener("mousemove",L.broadcastManager.onBroadcastMouseMove,!1),document.addEventListener("touchmove",L.broadcastManager.onTouchMove,!1)),B=(performance||Date).now(),N=(B-Y)/1e3,console.log("All load time : "+N.toFixed(2)),L.testMode&&console.log("模型加载完成时间:",(new Date).getTime(),new Date),L.loadRemainExtension(),i=t=r=void 0,z&&L.updateAllMateriaslInfo(z,G),L.viewManager&&L.viewManager.init(),L.hasViewBox&&null==L.viewBox&&!L.viewManager&&L.initViewBox();var t,r={useOrginal:!0,smoothTranslation:!!L.CADViewer};if(L.Euler&&((t=new THREE.Vector3(0,0,1)).applyEuler(L.Euler),r.from=t.toArray(),(t=new THREE.Vector3(0,1,0)).applyEuler(L.Euler),r.up=t.toArray()),F&&L.resetCamera(r),De.enableBroadcast=L.oldenableBroadcast,L.ndsModel&&L.ndsModel.pureLineBody&&0<L.ndsModel.pureLineBody.length){for(var i=0;i<L.ndsModel.pureLineBody.length;i++)!L.ndsModel.pureLineBody[i].leafBodyAttri||6==L.ndsModel.pureLineBody[i].leafBodyAttri.bodyBbox.length&&Number.isFinite(L.ndsModel.pureLineBody[i].leafBodyAttri.bodyBbox[0])||L.ndsModel.pureLineBody[i].updateBoundingBox();L.ndsModel.pureLineBody=[]}L.ndsModel&&L.ndsModel.models.forEach(function(e,t){for(var r=0;r<e.wholeLeafBodyNodes.length;r++){var i=e.wholeLeafBodyNodes[r];i&&t==L.ndsModel.models.length-1&&(i.defaultVisible=i.visible)}}),L.dispatchEvent({type:"updateProgress",userData:{precent:1}}),L.ndsModel&&!L.hasBrepFile()&&L.ndsModel.meshManager.mergeLineSegments(),L.hasBrepFile()||L.dispatchEvent({type:"BrepInfoEvent",faceArea:!1,bodyVolume:!1,totalVolume:!1,bodyArea:!1,totalArea:!1,boundingbox:!1,facePerimeter:!1}),K=!0,L.sceneInfo||L.dispatchModelEvent({type:"geometryAllLoadedEvent",modelLoadedTime:U,wholeModelLoadedTime:N,modelInfo:c}),!L.sceneInfo||L.sceneInfo.folderArray||L.sceneInfo.WasmMerge||L.dispatchModelEvent({type:"geometryAllLoadedEvent",modelLoadedTime:U,wholeModelLoadedTime:N,modelInfo:c}),h=L.sceneInfo,(0==De.ScenarioEditorid||L.sceneInfo&&L.sceneInfo.setScene)&&L.lightControls.loadTextures(function(){if(L.lightControls.resetPosition(),h&&h.setScene){L.lightControls.getLightList().forEach(function(e){L.lightControls.removeLight(e)});for(var e=h.lightInfo.length,t=0;t<e;t++)L.lightControls.addLight("None");h.maxLightDistance&&L.lightControls.setMaxdistance(h.maxLightDistance),h.lightInfo.forEach(function(e,t){L.lightControls.switchLight(t,e.type);var r=L.lightControls.getLight(t);switch(e.type){case"DirectionalLight":L.lightControls.setDirLightParam(r,e);break;case"PointLight":L.lightControls.setPointLightParam(r,e);break;case"HemisphereLight":L.lightControls.setHemiLightParam(r,e);break;case"SpotLight":L.lightControls.setSpotLightParam(r,e)}}),L.lightControls.setVisible(!0),L.lightControls.setVisible(!1),h=null,L.dispatchEvent({type:"lightLoadEnd"})}}),De.inBIMContext&&(B=/neg/g.test(De.modelUpDirection)?De.modelUpDirection.replace("neg","pos"):De.modelUpDirection.replace("pos","neg"),g=De.modelUpDirection,L.initModelUpDirection(B),L.initModelUpDirection(g)),"posy"!=De.modelUpDirection&&!De.inBIMContext&&L.enableFlip&&(L.OriginalRootMatrix&&(L.ndsModel.rootBodyNode.matrix=L.OriginalRootMatrix,L.OriginalRootMatrix=null),L.setModelUpDirection(De.modelUpDirection,!0),s={useOrginal:!0,smoothTranslation:!!L.CADViewer},L.Euler&&((l=new THREE.Vector3(0,0,1)).applyEuler(L.Euler),s.from=l.toArray(),(d=new THREE.Vector3(0,1,0)).applyEuler(L.Euler),s.up=d.toArray()),L.resetCamera(s)),L.is2DModel||!L.sceneInfo&&L.CADViewer||De.AnimationEdit||(u=L.ndsModel.rootBodyNode,L.camera.setOrginalCameraInfo(void 0),p=new THREE.Vector3,f=new THREE.Vector3,m={flag:!0},L.computeBoundingBox(L.scene,p,f,m),L.controls.setBoundingBox(p,f),L.selectionManager.clearSelection(),L.switchRotateCenterBySelection(),s={smoothTranslation:!1},F&&L.resetCamera(s),B=L.getCameraInfo(),L.camera.setOrginalCameraInfo({center:new THREE.Vector3(B.target.x,B.target.y,B.target.z),up:new THREE.Vector3(B.up.x,B.up.y,B.up.z),position:new THREE.Vector3(B.position.x,B.position.y,B.position.z)}),L.startMove(),L.groundShadowChange(),L.controls.SetBoundingBoxUpdated(!1),g=(new THREE.Quaternion).setFromUnitVectors(new THREE.Vector3(0,0,1).normalize(),new THREE.Vector3(1,1,1).normalize()),B=(new THREE.Euler).setFromQuaternion(g),L.ScenarioEditorInfo.EulerAngle.set(B.x,B.y,B.z),L.dispatchEvent({type:"Eulerchange",x:180*B.x/Math.PI,y:180*B.y/Math.PI,z:180*B.z/Math.PI}),L.dispatchEvent({type:"dischange",distance:20}),L.renderAllViews()),L.CADViewer||De.AnimationEdit||(B=L.scene.getObjectByName("GridHelper"))||(B=new En(null,null,L),L.scene.add(B)),0<De.ScenarioEditorid?(v="",e.t0=0,e.next=0===e.t0?48:1===e.t0?50:2===e.t0?52:3===e.t0?54:4===e.t0?56:5===e.t0?58:6===e.t0?60:7===e.t0?62:8===e.t0?64:66):e.next=70}else e.next=174;break;case 48:return v="lighting",e.abrupt("break",68);case 50:return v="primarycolor",e.abrupt("break",68);case 52:return v="wireframe",e.abrupt("break",68);case 54:return v="whitemold",e.abrupt("break",68);case 56:return v="shadedWithEdges",e.abrupt("break",68);case 58:return v="shaded",e.abrupt("break",68);case 60:return v="hiddenLineRemove",e.abrupt("break",68);case 62:return v="hiddenLineVisible",e.abrupt("break",68);case 64:return v="transparent",e.abrupt("break",68);case 66:return v="shaded",e.abrupt("break",68);case 68:if(L.setRenderMode(v,!0),De.ScenarioEditor&&L.ndsModel.rootBodyNode.fileUnit!=L.modelUnit){for(y=L.getUnitTransfrom(L.modelUnit,L.ndsModel.rootBodyNode.fileUnit),L.ndsModel.rootBodyNode.matrix||(L.ndsModel.rootBodyNode.matrix=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),L.ndsModel.rootBodyNode.matrix[0]*=y,L.ndsModel.rootBodyNode.matrix[1]*=y,L.ndsModel.rootBodyNode.matrix[2]*=y,L.ndsModel.rootBodyNode.matrix[4]*=y,L.ndsModel.rootBodyNode.matrix[5]*=y,L.ndsModel.rootBodyNode.matrix[6]*=y,L.ndsModel.rootBodyNode.matrix[8]*=y,L.ndsModel.rootBodyNode.matrix[9]*=y,L.ndsModel.rootBodyNode.matrix[10]*=y,L.ndsModel.updateNodeMatrix(L.ndsModel.rootBodyNode.uuid,L.ndsModel.rootBodyNode.matrix,L.ndsModel.rootBodyNode.getModel().id),A=new THREE.Box3,M=[L.ndsModel.sptIndex.root],E=0,w=M.length;E<w;++E)x=M[E],A.copy(x.boundingBox),b=new THREE.Matrix4,A.applyMatrix4(b.makeScale(y,y,y)),x.boundingBox.copy(A),0<x.children.length&&x.children.forEach(function(e){M.push(e)});p=new THREE.Vector3,f=new THREE.Vector3,m={flag:!0},L.computeBoundingBox(L.scene,p,f,m),L.controls.setBoundingBox(p,f),L.selectionManager.clearSelection(),L.switchRotateCenterBySelection(),s={smoothTranslation:!1},L.resetCamera(s),B=L.getCameraInfo(),L.camera.setOrginalCameraInfo({center:new THREE.Vector3(B.target.x,B.target.y,B.target.z),up:new THREE.Vector3(B.up.x,B.up.y,B.up.z),position:new THREE.Vector3(B.position.x,B.position.y,B.position.z)}),L.cameraControl.adjustNearAndFar()}case 70:if(!L.sceneInfo){e.next=171;break}if(I=De.ScenarioEditorid+1,!L.sceneInfo.folderArray){e.next=83;break}case 73:if(I<L.sceneInfo.folderArray.length){if(0<L.sceneInfo.folderArray[I])return setTimeout(function(){var e=L.folderPath+I+"/model.js";L.loadModel(L.parameter.id,e,L.parameter.binUrl,L.parameter.contentFileUrl,L.parameter.type,L.parameter.cameraInfo,L.parameter.loadCallBack,L.parameter.trueTextureFileList,L.parameter.params,L.parameter.bodyNodeUUidToMaterial)},300),e.abrupt("break",83);e.next=79}else e.next=83;break;case 79:I++,De.ScenarioEditorid++;case 81:e.next=73;break;case 83:if(!(L.sceneInfo.WasmMerge||L.sceneInfo.folderArray.length<=De.ScenarioEditorid-L.sceneInfo.ScenarioEditorid)){e.next=169;break}e.t1=Qa().keys(L.sceneInfo.nodeMatrix);case 85:if((e.t2=e.t1()).done){e.next=94;break}if(T=e.t2.value,u=L.ndsModel.getBodyNodeFromUuid(T)){e.next=90;break}return e.abrupt("continue",85);case 90:R=L.sceneInfo.nodeMatrix[T],L.ndsModel.updateNodeMatrix(u.uuid,R,u.getModel().id),e.next=85;break;case 94:L.sceneInfo.setScene?(S=function(){var t=Za(Qa().mark(function e(t){var r;return Qa().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.map(function(){var t=Za(Qa().mark(function e(t){var r,i;return Qa().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=L.ZIPData.file(t)){e.next=3;break}return e.abrupt("return",null);case 3:return e.next=5,r.async("blob");case 5:return i=e.sent,e.abrupt("return",window.URL.createObjectURL(i));case 7:case"end":return e.stop()}},e)}));return function(e){return t.apply(this,arguments)}}()),e.next=3,Promise.all(r);case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}},e)}));return function(e){return t.apply(this,arguments)}}(),R={center:new THREE.Vector3(L.sceneInfo.cameraInfo.target.x,L.sceneInfo.cameraInfo.target.y,L.sceneInfo.cameraInfo.target.z),up:new THREE.Vector3(L.sceneInfo.cameraInfo.up.x,L.sceneInfo.cameraInfo.up.y,L.sceneInfo.cameraInfo.up.z),position:new THREE.Vector3(L.sceneInfo.cameraInfo.position.x,L.sceneInfo.cameraInfo.position.y,L.sceneInfo.cameraInfo.position.z)},L.sceneInfo.cameraInfo.isPerspective?L.camera.toPerspective():L.camera.toOrthographic(),L.CADViewer||De.AnimationEdit?(p=new THREE.Vector3,f=new THREE.Vector3,m={flag:!0},L.computeBoundingBox(L.scene,p,f,m),L.controls.setBoundingBox(p,f),L.selectionManager.clearSelection(),L.switchRotateCenterBySelection(),L.camera.setOrginalCameraInfo(R),s={smoothTranslation:!1,useOrginal:!0},L.resetCamera(s)):(C=L.sceneInfo.EulerAngle,H={center:new THREE.Vector3(L.sceneInfo.originalcameraInfo.center.x,L.sceneInfo.originalcameraInfo.center.y,L.sceneInfo.originalcameraInfo.center.z),up:new THREE.Vector3(L.sceneInfo.originalcameraInfo.up.x,L.sceneInfo.originalcameraInfo.up.y,L.sceneInfo.originalcameraInfo.up.z),position:new THREE.Vector3(L.sceneInfo.originalcameraInfo.position.x,L.sceneInfo.originalcameraInfo.position.y,L.sceneInfo.originalcameraInfo.position.z)},L.camera.setOrginalCameraInfo(H),L.startSmoothTranslation(R,function(){L.dispatchEvent({type:"Eulerchange",x:180*C.x/Math.PI,y:180*C.y/Math.PI,z:180*C.z/Math.PI});var e=L.camera.getOrginalCameraInfo(),e=20/new THREE.Vector3(e.position.x-e.center.x,e.position.y-e.center.y,e.position.z-e.center.z).length()*L.camera.position.clone().sub(L.cameraControl.center()).length(),e=(L.dispatchEvent({type:"dischange",distance:e=(e=100<e?100:e)<.1?.1:e}),new THREE.Vector3),t=new THREE.Vector3;L.computeBoundingBox(L.scene,e,t,{flag:!0}),L.controls.setBoundingBox(e,t),L.selectionManager.clearSelection(),L.switchRotateCenterBySelection()})),v="",e.t3=L.sceneInfo.renderMode,e.next=0===e.t3?103:1===e.t3?105:2===e.t3?107:3===e.t3?109:4===e.t3?111:5===e.t3?113:6===e.t3?115:7===e.t3?117:8===e.t3?119:121):e.next=160;break;case 103:return v="lighting",e.abrupt("break",123);case 105:return v="primarycolor",e.abrupt("break",123);case 107:return v="wireframe",e.abrupt("break",123);case 109:return v="whitemold",e.abrupt("break",123);case 111:return v="shadedWithEdges",e.abrupt("break",123);case 113:return v="shaded",e.abrupt("break",123);case 115:return v="hiddenLineRemove",e.abrupt("break",123);case 117:return v="hiddenLineVisible",e.abrupt("break",123);case 119:return v="transparent",e.abrupt("break",123);case 121:return v="shaded",e.abrupt("break",123);case 123:if(L.setRenderMode(v),L.setGridHelperVisible(L.sceneInfo.GridHelper),L.CADViewer?L.setGroundShadowVisibility(!1):L.setGroundShadowVisibility(L.sceneInfo.enableGroundShadow),L.setBackGroundColor(L.sceneInfo.clearColor),L.sceneInfo.backGroundImage){if(D=L.folderPath+"backGroundImage.jpeg",De.singleHTML)return e.next=132,S([L.folderPath+"backGroundImage.jpeg"]);e.next=134}else e.next=136;break;case 132:D=(D=e.sent)[0];case 134:L.setBackGroundImage(D),L.backGroundImageindex=L.sceneInfo.backGroundImageindex;case 136:if(L.sceneInfo.envmapUrls){if(P=[],De.singleHTML)return P.push(L.folderPath+"0.jpeg"),P.push(L.folderPath+"1.jpeg"),P.push(L.folderPath+"2.jpeg"),P.push(L.folderPath+"3.jpeg"),P.push(L.folderPath+"4.jpeg"),P.push(L.folderPath+"5.jpeg"),e.next=147,S(P);e.next=150}else e.next=159;break;case 147:P=e.sent,e.next=156;break;case 150:P.push(L.folderPath+"0.jpeg"),P.push(L.folderPath+"1.jpeg"),P.push(L.folderPath+"2.jpeg"),P.push(L.folderPath+"3.jpeg"),P.push(L.folderPath+"4.jpeg"),P.push(L.folderPath+"5.jpeg");case 156:k=!0,L.setEnvMapTextures(P),L.envmapUrlsindex=L.sceneInfo.envmapUrlsindex;case 159:L.setEnvMapBlurEnabled(L.sceneInfo.bEnableEnvMapBlur);case 160:L.dispatchModelEvent({type:"geometryAllLoadedEvent",modelLoadedTime:U,wholeModelLoadedTime:N,modelInfo:c}),L.selectionManager.clearSelection(),L.lightControls.setVisible(!0),L.lightControls.setVisible(!1),L.rootBodyNodeName=L.sceneInfo.rootName,L.loadrelease=!0,L.loadMergeRelease=!0===L.sceneInfo.WasmMerge,L.loadreleasecount=L.ndsModel.models.length,L.sceneInfo=null;case 169:e.next=172;break;case 171:L.lightControls.computeMaxdistance();case 172:De.ScenarioEditor||L.sceneInfo||!L.hasPbrMaterial||L.setDefaultEnvMap(),De.ScenarioEditor&&(H=He.getExtension("SceneEditExtension"))&&H.reApplyTransparentMaterial();case 174:case"end":return e.stop()}},e,this)}));return function(e,t){return r.apply(this,arguments)}}()),me=function(e,t){L.showWaiterCoverStater(!1),t?console.log("loadError"):(L.loaderror=!0,L.dispatchAsyncEvent({type:"loadError",errorInfo:e||"objectloader error"}))};function ge(e){var t={Mesh:{count:0,triangles:0,points:0},Line:{count:0,points:0}};if(void 0!==e&&(e.hasOwnProperty("geometry")&&(e.geometry instanceof THREE.Geometry?(t.Mesh.count+=1,t.Mesh.points+=e.geometry.vertices.length,t.Mesh.triangles+=e.geometry.faces.length):e.geometry instanceof THREE.BufferGeometry&&(e instanceof THREE.Mesh?(t.Mesh.count+=1,e.geometry.attributes.position&&(t.Mesh.points+=e.geometry.attributes.position.count),e.geometry.index&&(t.Mesh.triangles+=e.geometry.index.count/3)):(e instanceof THREE.Line||e instanceof THREE.LineSegments)&&(t.Line.count+=1,e.geometry.attributes.position)&&(t.Line.points+=e.geometry.attributes.position.count))),void 0!==e.children))for(var r=0,i=e.children.length;r<i;++r){var n=ge(e.children[r]);t.Mesh.triangles+=n.Mesh.triangles,t.Mesh.points+=n.Mesh.points,t.Mesh.count+=n.Mesh.count,t.Line.points+=n.Line.points,t.Line.count+=n.Line.count}return t}Object.defineProperties(E,{renderSettingCallback:{get:function(){return pe},set:function(e){pe=e}},bufferChunkCallback:{get:function(){return fe},set:function(e){fe=e}},loadErrorCallback:{get:function(){return me},set:function(e){me=e}}}),Ce.TextureLoadingManager=new THREE.LoadingManager,Ce.TextureLoadingManager.onProgress=function(e,t,r){j&&L.renderAllViews()},Ce.TextureLoadingManager.onError=function(){Ce.TextureLoadingManager.itemEnd(),j&&L.renderAllViews()},E.loadSingleModel=function(e,t){"./"!==(e=e.trim()).substr(0,2)&&-1===e.indexOf(":/")&&"../"!==e.substr(0,3)&&"/"!==e.substr(0,1)&&-1===e.indexOf(":\\")&&(e="./"+e);e=Pe.encodeURL(e);L.loadParams.has(e)||L.loadParams.set(e,[]),L.loadParams.get(e).push(t),L.modelRequestor.loadModel(e)},E.loadMultiModel=function(e,t){for(var r=0;r<e.length;++r){var i=e[r];"./"!==(i=i.trim()).substr(0,2)&&-1===i.indexOf(":/")&&"../"!==i.substr(0,3)&&"/"!==i.substr(0,1)&&-1===i.indexOf(":\\")&&(i="./"+i),e[r]=Pe.encodeURL(i)}t.proxyName=t.proxyName||"proxy";var n=t.isSketchModel?t.parentModelUrl:t.proxyName;"proxy"===n&&L.loadParams.has(n)&&L.loadParams.delete(n),L.loadParams.has(n)||L.loadParams.set(n,t),E.__addModel({url:n,isSketchModel:!!t.isSketchModel,parentModelId:t.parentModelId,isProxy:!0,urls:e,proxyName:t.proxyName,multipleModel:!0})},E.__addModel=function(e){var t,r=this.loadParams.get(e.url);if(Array.isArray(r))for(var i=0;i<r.length;++i){if(void 0===r[i].modelId){r=r[i];break}i==r.length-1&&(r=r[i])}if(e.isDisaModel)t=new dn(L,e.url,{nodeRequestor:L.modelRequestor,keepSourceFile:!!De.ScenarioEditor,needsPMI:!1!==r.needsPMI,needsAnimation:!1!==r.needsAnimation,needsSketchModel:!1,needsProperty:!1,position:r.position,matrix:r.matrix,resetCamera:!!r.resetCamera,needsBRep:!1!==r.needsBRep,hasRefModel:!1,modelId:r.modelId,filter:r.filter,visible:r.visible,insetModel:!1});else if(e.is2DModel)t=new $i(L,e.url,{nodeRequestor:L.modelRequestor,keepSourceFile:!1,needsPMI:!1,needsAnimation:!1,needsSketchModel:!1,needsProperty:!1,position:r.position,matrix:r.matrix,needsBRep:!1!==r.needsBRep});else if(e.isMCAD3DModel)t=new zi(L,e.url,{nodeRequestor:L.modelRequestor,keepSourceFile:!!De.ScenarioEditor,needsPMI:!1!==r.needsPMI,needsAnimation:!1!==r.needsAnimation,needsSketchModel:!1!==r.needsSketchModel,needsProperty:!1!==r.needsProperty,position:r.position,matrix:r.matrix,resetCamera:!!r.resetCamera,needsBRep:!1!==r.needsBRep,hasRefModel:!!e.hasRefModel,modelId:r.modelId,filter:r.filter,visible:r.visible,insetModel:r.insetModel});else if(e.isECAD3DModel)t=new sn(L,e.url,{nodeRequestor:L.modelRequestor,keepSourceFile:!!De.ScenarioEditor,needsPMI:!1,needsAnimation:!1,needsSketchModel:!1,needsProperty:!1!==r.needsProperty,position:r.position,matrix:r.matrix,resetCamera:!!r.resetCamera,needsBRep:!1!==r.needsBRep,hasRefModel:!!e.hasRefModel});else if(e.isECAD2DModel)t=new nn(L,e.url,{nodeRequestor:L.modelRequestor,keepSourceFile:!!De.ScenarioEditor,needsPMI:!1,needsAnimation:!1,needsSketchModel:!1,needsProperty:!1!==r.needsProperty,position:r.position,matrix:r.matrix,resetCamera:!!r.resetCamera,needsBRep:!1!==r.needsBRep,hasRefModel:!!e.hasRefModel});else if(e.isProxy)if(e.isSketchModel)t=new hn(L,e.urls,{proxyName:e.proxyName,parentModel:L.ndsModel.getModelById(e.parentModelId),nodeRequestor:L.modelRequestor,keepSourceFile:!!De.ScenarioEditor,needsPMI:!1!==r.needsPMI,needsAnimation:!1!==r.needsAnimation,needsSketchModel:!1,needsProperty:!1!==r.needsProperty,position:r.position,matrix:r.matrix,needsBRep:!1!==r.needsBRep,hasRefModel:!0});else{if(e.multipleModel){this.prepareLoadModels=[];for(var n=0;n<e.urls.length;n++){e.urls[n];var a,o=this.loadParams.get("proxy").modelInfos[n],s=o.url+"/model.js";o.insetModel=!0,o.resetCamera=!0,0==n?(L.loadParams.has(s)||L.loadParams.set(s,[]),L.loadParams.get(s).push(o),t=new zi(L,s,((a={nodeRequestor:L.modelRequestor,keepSourceFile:!!De.ScenarioEditor,needsPMI:!1!==r.needsPMI,needsAnimation:!1,needsSketchModel:!1!==r.needsSketchModel,needsProperty:!1!==r.needsProperty,position:o.position,matrix:o.matrix,rotate:o.rotate,scale:o.scale,resetCamera:!!r.resetCamera,needsBRep:!1!==r.needsBRep,hasRefModel:!!e.hasRefModel,modelId:o.modelId,visible:o.visible,insetModel:!0}).resetCamera=!0,a)),r&&(r.modelId=t.id),o.modelId=t.id,L.ndsModel.addModel(t)):this.prepareLoadModels.push({url:s,id:"idv",params:o,unload:!0})}return}t=new Wi(L,e.urls,{proxyName:e.proxyName,nodeRequestor:L.modelRequestor,keepSourceFile:!!De.ScenarioEditor,needsPMI:!1!==r.needsPMI,needsAnimation:!1!==r.needsAnimation,needsSketchModel:!1!==r.needsSketchModel,needsProperty:!1!==r.needsProperty,position:r.position,matrix:r.matrix,needsBRep:!1!==r.needsBRep,hasRefModel:!0})}else e.isExternalModel&&(t=He.getExtension(e.extensionName).createModel(L,e.url,{nodeRequestor:L.modelRequestor,needsPMI:!1!==r.needsPMI,needsAnimation:!1!==r.needsAnimation,needsSketchModel:!1!==r.needsSketchModel,needsProperty:!1!==r.needsProperty,position:r.position,matrix:r.matrix,resetCamera:!!r.resetCamera,needsBRep:!1!==r.needsBRep,hasRefModel:!!e.hasRefModel,modelId:r.modelId,filter:r.filter,visible:r.visible,modelType:e.modelType}));t&&(r&&!t.isSketchModel&&(r.modelId=t.id),L.ndsModel.addModel(t))},E.load3D=function(e,t,r,l,i,d,n){L.showWaiterCoverStater(!0),L.controls.SetBoundingBoxUpdated(!1),Y=(performance||Date).now(),Ce.StartRenderTime=Date.now(),ne=!1,V=void 0,L.meshLoadedUUIDs=[];try{var a,o,s,c,h;O.onProgress=function(e,t,r){},O.onError=function(){O.itemEnd()},O.onLoadCallback=function(){var e;d&&(e=-1,0<L.ndsModel.models.length&&(e=L.ndsModel.models[L.ndsModel.models.length-1].id),d(e))},O.onLoad=function(){if(!1!==V){if(L.ndsModel.activeModel=L.ndsModel.models[L.ndsModel.models.length-1],L.ndsModel.activeModel=L.ndsModel.getActiveModel(),L.dispatchEvent({type:"loadBegin"}),L.showWaiterCoverStater(!1),L.initModelUpDirection(_.modelUpDirection),"posy"!==De.modelUpDirection&&!De.inBIMContext&&L.enableFlip&&(!L.CADViewer||!L.ndsModel.getActiveModel().ndsSketchModel)){L.OriginalRootMatrix=L.ndsModel.rootBodyNode.matrix?L.ndsModel.rootBodyNode.matrix.slice(0):[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];for(var e=L.initModelUpDirection(De.modelUpDirection,!0),t=new THREE.Matrix4,r=0;r<16;++r)t.elements[r]=e[r];L.ndsModel.meshManager.globalTransform=t,L.ndsModel.rootBodyNode.matrix=e.slice(0),L.ndsModel.rootBodyNode.updateMatrixWorld(!0,!1)}L.scene.updateMatrixWorld(!0),L.getLinesVisibility()||L.showLineObjects(L.scene,!1),j=void 0===V||V,L.selectionManager.computeTargetList(L.scene),k&&L.updateEnvMap(L.envMapTexture),null==l?F&&(i={smoothTranslation:!1},L.camera.getOrginalCameraInfo()&&(i.useOrginal=!0),L.cameraInfoFile&&L.is2DModel&&!L.cameraInfoFile.hasSet&&(i.up=L.cameraInfoFile.up,L.cameraInfoFile.hasSet=!0),L.Euler&&((n=new THREE.Vector3(0,0,1)).applyEuler(L.Euler),i.from=n.toArray(),(n=new THREE.Vector3(0,1,0)).applyEuler(L.Euler),i.up=n.toArray()),L.resetCamera(i)):(l.smoothTranslation=!1,L.setCameraInfo(l)),L.recordOriginalMeshes(),L.isolateMeshes.length=0;var i,n=(performance||Date).now();if(U=(n-Y)/1e3,console.log("Load time : "+U.toFixed(2)),L.testMode&&console.log("模型开始加载时间:",(new Date).getTime(),new Date),L.dispatchAsyncEvent({type:"geometryLoadedEvent"}),void 0===V&&(L.setRenderMode(L.renderMode,!1),i=ge(L.scene),console.log("Mesh  count : "+i.Mesh.count+"   triangles : "+i.Mesh.triangles+"   points : "+i.Mesh.points),console.log("Line  count : "+i.Line.count+"   points : "+i.Line.points),L.animationsManager&&L.animationsManager.hasAnimations()?De.enableBroadcast||0!=L.turnoffAnimation||L.startAnimationByUUID(_.animationUUID,!0):L.toggleAutoRotation(!0),De.enableBroadcast)&&(L.renderAllViews(),De.broadcastMajor)&&document.addEventListener("mousemove",L.broadcastManager.onBroadcastMouseMove,!1),d&&(n=-1,0<L.ndsModel.models.length&&(n=L.ndsModel.models[L.ndsModel.models.length-1].id),d(n)),L.useTransparentList&&L.transparentList){for(var a=[],o=0;o<L.transparentList.length;++o){var s=(s=L.ndsModel.meshManager.bodyUuids[L.transparentList[o]])||L.ndsModel.objectidTouuid[L.transparentList[o]];L.ndsModel.bodyUuid2NodeMap[s]&&a.push(L.ndsModel.bodyUuid2NodeMap[s])}8===G?(L.ndsModel.isolateBodiesOnly([L.ndsModel.rootBodyNode]),L.ndsModel.transparentModeBodiesMap.clear(),L.ndsModel.transparentizeBodiesOnly(a),L.ndsModel.transparentModeBodiesMap.clear()):0<a.length&&L.ndsModel.transparentizeBodies(a)}}},"js"===i||null==i?Array.isArray(e)?L.loadMultiModel(e,n):L.loadSingleModel(e,n):"obj"===i?(c=new Vr(O),a=e.lastIndexOf("|"),s=o=null,0<a?(o=e.substr(0,a),s=e.substr(a+1,e.length)):o=e,O.itemStart(),c.load(o,s,function(e){L.clearScene(L.scene),L.scene.add(e),L.modelRootObject=e,L.addLights(L.scene),O.itemEnd()},function(){},function(){O.itemEnd()})):"obj_json"===i?(c=new THREE.JSONLoader(O),O.itemStart(),c.load(e,function(e,t){e=new THREE.Mesh(e,new THREE.MeshFaceMaterial(t));L.clearScene(L.scene),L.scene.add(e),L.modelRootObject=e,L.addLights(L.scene),O.itemEnd()})):"zip"!==i&&"js_zip"!==i||(h=this.is2DModel?new $i(L,e,{nodeRequestor:L.modelRequestor,keepSourceFile:!1,type:i}):new zi(L,e,{nodeRequestor:L.modelRequestor,keepSourceFile:!1,type:i,needsPMI:!1!==n.needsPMI,needsAnimation:!1!==n.needsAnimation,needsSketchModel:!1!==n.needsSketchModel,needsProperty:!1!==n.needsProperty,position:n.position,matrix:n.matrix,resetCamera:!!n.resetCamera,needsBRep:!1!==n.needsBRep,modelId:n.modelId}),L.ndsModel.addModel(h),L.run())}catch(e){L.showWaiterCoverStater(!1),L.dispatchAsyncEvent({type:"loadError",errorInfo:"load3d error"})}},E.run=function(e,t){var r,i;De.isVRmodel||De.isARmodel&&De.supportAR||requestAnimationFrame(L.run),L.gpuPerformanceTest?((r=L.viewManager?L.viewManager.getNextRenderedView():void 0)&&r.apply(),i=Date.now()-Ce.StartRenderTime,L.renderNew(e,!!(De.isVRmodel||De.isARmodel&&De.supportAR)||i<15e3,r),L.viewManager&&L.viewManager.renderActiveViewOutline(),L.isRunning=!0):(L.gpuPerformanceTest=!0,L.renderer.maxPrimitivesPerFrame=1e7,L.renderer.primitivesPerFrameLocked=!0,console.log("maxPrimitivesPerFrame: "+L.renderer.maxPrimitivesPerFrame))},E.resetForReload=function(){if(this.ndsModel&&L.inited){if(L.clearScene(L.scene),He.clear(),0<L.requestAnimationFrameId.length)for(var e=0;e<L.requestAnimationFrameId.length;++e)cancelAnimationFrame(L.requestAnimationFrameId[e]);L.bDefaultOpRotate?L.setOperatorByID("OpOrbit"):L.setOperatorByID("OpPan"),L.selectionManager.clearSelection(),L.controls.staticAnnotation&&(L.controls.staticAnnotation.release(),L.controls.staticAnnotation=null),L.controls.update(),L.requestAnimationFrameId=[],L.ndsModel&&(L.ndsModel.setGlobalModelId(0),L.ndsModel.release(),St.numObject=0),L.viewManager&&(L.viewManager=void 0),L.ndsModel=new er(L),L.modelRootObject=null,L.GeomEmpty=!1,L.showHiddenMode=-1,L.leafPMIObjects=[],L.PMINDSBodys=[],L.loadParams=new Map,L.isRunning=!1,L.ConfigName="",L.ConfigNum=0,L.modelInfo.length=0,De.ScenarioEditorid=-1,L.camera.setOrginalCameraInfo(void 0),L.originalMeshes.length=0,L.pmiObject=null,L.ndsModelObjectTreeLoaded=!1,L.additionalObjectsScene.children.length=0,L.ndsModelPMILoaded=!1,L.ndsModelBvhLoaded=!1,j=!1;var t=De.enableSelect;De.enableSelect=t,L.modelRequestor&&(De.singleHTML||L.modelRequestor.releaseWorker(!0,!0),L.modelRequestor.initRequest()),L.renderAllViews(),L.loaderror=!1,L.enableFlip=void 0===_.enableFlip||_.enableFlip,L.inited=!1}},E.clearScene=function(e){for(var t=0;t<e.children.length;t++)"lightctrls"===e.children[t].name||e.children[t]instanceof THREE.Light||(e.remove(e.children[t]),t--);L.controls.update(),L.renderAllViews()},E.showLineObjects=function(e,t){for(var r=e.children,i=0;i<r.length;i++)r[i]instanceof THREE.Line||r[i]instanceof THREE.LineSegments?(!L.materialsSetting||L.materialsSetting&&L.materialsSetting.getMaterialsMarkersMat()!=r[i].material)&&(r[i].visible=t,null!=r[i].tangentEdgeObject)&&0==De.tangentEdgeVisible&&(r[i].visible=!1):0<r[i].children.length&&"lightctrls"!=r[i].name&&this.showLineObjects(r[i],t)},E.renderHiddenLinesVisible=function(){L.modelRootObject&&(L.modelRootObject.traverse(function(e){e.hasOwnProperty("geometry")&&e.hasOwnProperty("material")&&(e instanceof THREE.Line||e instanceof THREE.LineSegments)&&void 0!==e.material.oldOpacity&&(e.material.opacity=e.material.oldOpacity,e.material.depthFunc=e.material.oldDepthFunc,e.material.transparent=e.material.oldTransparent,e.material.needsUpdate=!0)}),L.renderer.render(L.scene,L.camera),L.modelRootObject.traverse(function(e){e.hasOwnProperty("geometry")&&e.hasOwnProperty("material")&&(e instanceof THREE.Line||e instanceof THREE.LineSegments)&&(void 0===e.material.oldOpacity&&(e.material.oldOpacity=e.material.opacity,e.material.oldDepthFunc=e.material.depthFunc,e.material.oldTransparent=e.material.transparent),e.material.opacity=.2,e.material.depthFunc=THREE.GreaterDepth,e.material.transparent=!0,e.material.needsUpdate=!0)}),L.renderer.render(L.scene,L.camera),L.modelRootObject.traverse(function(e){e.hasOwnProperty("geometry")&&e.hasOwnProperty("material")&&(e instanceof THREE.Line||e instanceof THREE.LineSegments)&&void 0!==e.material.oldOpacity&&(e.material.opacity=e.material.oldOpacity,e.material.depthFunc=e.material.oldDepthFunc,e.material.transparent=e.material.oldTransparent,e.material.needsUpdate=!0)}))},E.getLightControls=function(){return L.lightControls},E.addLights=function(){var e,t,r;L.lightControls||(He.onInitLights(L.lights),0===L.lights.length&&(e=new THREE.AmbientLight(16777215,.4),(t=new THREE.HemisphereLight(16777215,5592405,J)).position.set(0,5,0),(r=new THREE.DirectionalLight(16777215,Z)).position.set(1,2,0),r._followCamera=!0,r._followCamera&&(De.ScenarioEditorid=0),De.ScenarioEditor||(L.lights.push(e),L.lights.push(t)),L.lights.push(r)),L.lightControls=new Fe(this))},E.changeLights=function(e){if(void 0!==e)switch(e){case"0":L.hemiSphereLight.intensity=.12;break;case"1":L.hemiSphereLight.intensity=.28;break;case"2":L.hemiSphereLight.intensity=.58;break;case"3":L.hemiSphereLight.intensity=.8;break;default:L.hemiSphereLight.intensity=.12}},E.showObjectAtObjectLevel=function(e,t){if(L.ndsModel&&e===L.scene&&t)return L.showAllModel();L.ndsModel?t?L.ndsModel.showBody(e):L.ndsModel.hideBody(e):e instanceof THREE.Light||(e.visible=t,L.selectionManager.computeTargetList(L.modelRootObject))},E.showObject=function(e,t,r,i){if(void 0===i&&(i=!0),L.ndsModel&&e===L.scene&&t)return L.showAllModel();if("parentNode"===e.type)t?L.showAllModel():L.ndsModel.hideAllBodies();else{if(L.ndsModel)e=this.getObjectByUUID(e.uuid,e.ndsModel.id),t?L.ndsModel.showBody(e):(L.ndsModel.hideBody(e),i&&L.selectionManager.deselectObject(e,r)),L.groundShadowChange();else{if(e instanceof THREE.Light)return;t&&(e.visible=t);var n=e.children;if(null==n||n.length<=0||e instanceof THREE.SkinnedMesh)return void(e instanceof THREE.Line||e instanceof THREE.LineSegments?L.bLinesVisibility&&(!L.materialsSetting||L.materialsSetting&&L.materialsSetting.getMaterialsMarkersMat()!=e.material)&&(e.visible=t,null!=e.tangentEdgeObject)&&0==De.tangentEdgeVisible&&(e.visible=!1):e.visible=t);for(var a=0,o=n.length;a<o;++a)L.showObject(n[a],t)}De.enableBroadcast&&De.broadcastMajor&&He.updateBroadcastInfo("ModelState"),L.startMove(),L.drawTraceUpdate()}L.renderAllViews()},E.showObjectList=function(e,t){if(L.showObject(L.scene,!t),e&&0<e.length)for(var r=0;r<e.length;++r){var i=L.ndsModel.getBodyNodeFromUuid(e[r]);L.showObject(i,t)}L.zoomExtents()},E.showObjectReversed=function(e){if(L.ndsModel&&e===L.scene)return L.ndsModel.reverseBodyVisibility();if(L.ndsModel)L.ndsModel.showBodyReversed(e);else if(!(e instanceof THREE.Light||"lightctrls"==e.name)){var t=e.children;if(null==t||t.length<=0||e instanceof THREE.SkinnedMesh)e instanceof THREE.Line||e instanceof THREE.LineSegments?L.bLinesVisibility&&(!L.materialsSetting||L.materialsSetting&&L.materialsSetting.getMaterialsMarkersMat()!=e.material)&&(e.visible=!e.visible,null!=e.tangentEdgeObject)&&0==De.tangentEdgeVisible&&(e.visible=!1):e.visible=!e.visible;else for(var r=0,i=t.length;r<i;++r)L.showObjectReversed(t[r])}},E.fixObjectByUUID=function(e,t){L.ndsModel&&(L.ndsModel.getBodyNodeFromUuid(e).fixed=t)},E.setRefPlaneVisibilityByComponent=function(e,t){L.ndsModel&&(e=L.ndsModel.getBodyNodeFromUuid(e))&&(e.setComponentRefPlaneVisibility(t),L.renderAllViews())},E.setRefAxisVisibilityByComponent=function(e,t){L.ndsModel&&(e=L.ndsModel.getBodyNodeFromUuid(e))&&(e.setComponentRefAxisVisibility(t),L.renderAllViews())},E.setCoordinateSysVisibilityByComponent=function(e,t){L.ndsModel&&(e=L.ndsModel.getBodyNodeFromUuid(e))&&(e.setComponentCoordinateSysVisibility(t),L.renderAllViews())},E.setBodyVisibilityByComponent=function(e,t){L.ndsModel&&(e=L.ndsModel.getBodyNodeFromUuid(e))&&(e.setComponentBodyVisibility(t),L.renderAllViews())},E.setObjectOpacity=function(e,t){if(L.ndsModel)t<.98?L.ndsModel.transparentBody(e,t):L.ndsModel.opaqueBody(e);else if(!(e instanceof THREE.Light)){var r=e.children;if((null==r||r.length<=0)&&e.material)e.material.opacity=t,e.material.transparent=1!=e.material.opacity;else for(var i=0,n=r.length;i<n;++i)L.setObjectOpacity(r[i],t)}},E.setObjectOpacityOnly=function(e,t,r){var i,n=this;void 0===r&&(r=!1),Number.isNaN(t)||Array.isArray(e)&&e.length&&(e.forEach(function(e){n.ndsModel.changeBodyOpactiy(e,t)}),r||(i=[],e.map(function(e){e=n.ndsModel.getLeafBodies(e);i.push.apply(i,e)}),this.dispatchEvent({type:"opacityChange",objects:i})),this.renderAllViews())},E.getObjectOpacityOnly=function(e){var t,i,r,n,a,o;return e instanceof _e?(t=e.getUserMaterial())?t.opacities?(i=!0,n=t.opacities.map(function(e,t,r){return i&&r[0].value!=e.value&&(i=!1),e.value}),i?n.slice(0,1):n):[t.opacity]:e&&e.leafBodyAttri?(r=[],n=e.leafBodyAttri.bodyMeshIds,a=!0,o=null,n.forEach(function(e,t){e=L.ndsModel.meshManager.materialId[e],e=L.ndsModel.meshManager.mats[e];e&&(r.push(e.opacity),0==t&&(o=e.opacity),a)&&o!=e.opacity&&(a=!1)}),a?r.slice(0,1):r):null:null},E.transparentRenderMode=function(e){if(1==e){var t=L.ndsModel.getTransparentizedBodies().slice();L.ndsModel.models.forEach(function(e){if(e.isSketchModel)return!0;e.transparentizeBodiesOnly([e.rootBodyNode])}),L.renderAllViews(),L.ndsModel.transparentModeBodiesMap.clear();for(var r=0;r<t.length;r++)L.ndsModel.transparentModeBodiesMap.set(t[r].uuid,!1)}else if(0==e){var i=new Map;L.ndsModel.transparentModeBodiesMap.forEach(function(e,t){i.set(t,e)}),L.ndsModel.models.forEach(function(e){if(e.isSketchModel)return!0;e.transparentizeBodiesOnly([e.rootBodyNode])}),L.renderAllViews(),L.ndsModel.transparentModeBodiesMap=i}else if(-1==e){var n=L.ndsModel.getTransparentizedBodies();if(n){for(var a=[],o=0;o<n.length;o++)L.ndsModel.transparentModeBodiesMap.has(n[o].uuid)||a.push(n[o]);L.ndsModel.isolateBodiesOnly(a),L.ndsModel.transparentModeBodiesMap.clear(),L.renderAllViews()}}},E.setObjectOpacityIsolate=function(e,t,r){if(!(e instanceof THREE.Light||"lightctrls"==e.name)){var i=e.children;if((null==i||i.length<=0||e instanceof THREE.SkinnedMesh)&&e.material)return he(e,r)?void 0:(e.material.opacity=t,e.material.transparent=1!=e.material.opacity,void(e.material.needsUpdate=!0));for(var n=0,a=i.length;n<a;++n)L.setObjectOpacityIsolate(i[n],t,r)}},E.getObjectColor=function(e){if(L.ndsModel){e=L.ndsModel.getBodyNodeFromUuid(e);if(e&&e.getUserMaterial()){e=e.getUserMaterial().color.getHex();if(e)return e}}return null},E.getObjectColorHexString=function(e){if(L.ndsModel){var i,r,t,n,a,e=L.ndsModel.getBodyNodeFromUuid(e),o=e.getUserMaterial();if(e&&o)return i=!0,o.colors?(t=o.colors.map(function(e,t,r){return i&&!r[0].value.equals(e.value)&&(i=!1),e.value.getHexString()}),i?t.slice(0,1):t):[o.color.getHexString()];if(e&&e.leafBodyAttri)return r=[],t=e.leafBodyAttri.bodyMeshIds,n=!0,a=null,t.forEach(function(e,t){var e=L.ndsModel.meshManager.materialId[e],e=L.ndsModel.meshManager.mats[e];e&&(e=e.color.getHexString(),r.push(e),0==t&&(a=e),n)&&a!=e&&(n=!1)}),n?r.slice(0,1):r}return null},E.getObjectColorRGB=function(e){if(L.ndsModel){var t,e=L.ndsModel.getBodyNodeFromUuid(e),r=e.getUserMaterial();if(e&&r)return r.colors?r.colors.map(function(e){return e.value}):r.color;if(e&&e.leafBodyAttri)return r=e.leafBodyAttri.bodyMeshIds,t=[],r.forEach(function(e){var e=L.ndsModel.meshManager.materialId[e],e=L.ndsModel.meshManager.mats[e];e&&(e=e.color,t.push(e))}),t}return null},E.getBodyNodeFromUuid=function(e,t){return L.ndsModel.getBodyNodeFromUuid(e,t=void 0===t?0:t)},E.recordOriginalMeshes=function(){L.originalMeshes.length=0,function e(t,r){if(t instanceof THREE.Light||"lightctrls"==t.name)return;var i=t.children;if((null==i||i.length<=0||t instanceof THREE.SkinnedMesh)&&t.material)return void r.push(new Pe.map(t,{opacity:t.material.opacity,transparent:t.material.transparent,oriMat:t.material}));for(var n=0,a=i.length;n<a;++n)e(i[n],r)}(L.scene,L.originalMeshes)},E.restoreOriginalMeshes1=function(){for(var e=0,t=L.originalMeshes.length;e<t;++e){var r=L.originalMeshes[e].key,i=L.originalMeshes[e].value;r.material!=De.selectedMaterial&&(r.material.opacity=i.opacity,r.material.transparent=i.transparent)}},E.restoreOriginalMeshes=function(){for(var e=0,t=L.originalMeshes.length;e<t;++e){var r=L.originalMeshes[e].key,i=L.originalMeshes[e].value;r.material!=De.selectedMaterial&&(r.material=i.oriMat,r.material.opacity=i.opacity,r.material.transparent=i.transparent)}},E.restoreObjectOpacity=function(e){var t=function(e,t){for(var r=0,i=t.length;r<i;++r)if(e==t[r].key)return t[r].value}(e,L.originalMeshes);t&&(e.material.opacity=t.opacity,e.material.transparent=t.transparent)},E.isLeaf=function(e){var t=e.children.length;if(t<=0)return!0;var r=!1;if(L.ndsModel){for(var i=0;i<t;i++)if("mesh"==(n=e.children[i]).type.toLowerCase()||"line"==n.type.toLowerCase()||"linepieces"==n.type.toLowerCase())return!0}else for(var n,i=0;i<t;i++)if((n=e.children[i])instanceof THREE.Mesh||n instanceof THREE.Line||n instanceof THREE.LineSegments||n instanceof THREE.SkinnedMesh){r=!0;break}return r},E.getAllLoadModel=function(){var t=[];return L.ndsModel.models.forEach(function(e){t.push(e)}),t},E.groundShadowChange=function(){var e,t;L.groundShadow&&P&&(L.groundShadow.clear(),e=new THREE.Vector3,t=new THREE.Vector3,L.computeBoundingBox(L.scene,e,t,{flag:!0}),L.groundShadow.updateGroundTransform(L.camera,new THREE.Box3(e,t),L.camera.worldup))},E.unloadModelById=function(e){var t=this.ndsModel.getModelById(e);t.isSketchModel||(L.selectionManager.clearSelection(),L.ndsModel.unloadModelById(e),t.ndsSketchModel&&L.ndsModel.unloadModelById(t.ndsSketchModel.id),0==L.ndsModel.getAllNoSketchModel().length&&(L.enableFlip=void 0===_.enableFlip||_.enableFlip),He.getExtension("ClipExtension")&&He.getExtension("ClipExtension").clear(),L.newrootBodyNode=null,L.ndsModel.modelTree=new Map,L.camera.setOrginalCameraInfo(void 0),L.controls.SetBoundingBoxUpdated(!1),L.resetCamera({smoothTranslation:!1}),L.renderAllViews())},E.getModelCount=function(){return L.ndsModel.models.length},E.getModelTree=function(e,t,r){if(void 0===t&&(t=-1),void 0===r&&(r=!1),L.ndsModel.modelTree||(L.ndsModel.modelTree=new Map),L.ndsModel.modelTree.has(t)&&!De.ScenarioEditor)return L.ndsModel.modelTree.get(t);var i,n,a,o=null;if(-1!=t)return this.loadrelease&&-1!=t&&0==r&&(t+=this.loadreleasecount-1),L.ndsModel&&(L.ndsModel instanceof er&&L.ndsModel.setActiveModel(t),o=De.ScenarioEditor||De.AnimationEdit?L.ndsModel.rootBodyNode:L.ndsModel.rootBodyNode.clone()),o?(i=function e(t,r){var i=L.ndsModel.getModelById(t.ndsModel?t.ndsModel.id:0);if(i.bodyUuid2ClonedNodeMap[t.uuid]=t,i.bodyUuid2ClonedNodeMap.isEmpty=!1,t.persistentId&&L.PersistentId2uuid.set(t.persistentId,t.uuid),t.fullpath=""!=r?r+"/"+t.name:t.name,0<t.children.length)for(var n=0;n<t.children.length;++n)"PMI"==t.children[n].type||"views"==t.children[n].type||"captures"==t.children[n].type?(t.remove(t.children[n]),n--):e(t.children[n],t.fullpath)},r=function e(t){var r;return 1<t.children.length||1!=t.children.length||null!=t.type&&("model"==t.type.toLowerCase()||"part"==t.type.toLowerCase()||"assembly"==t.type.toLowerCase())||(r=t.children[0])instanceof THREE.Mesh||r instanceof THREE.Line||r instanceof THREE.LineSegments||r instanceof THREE.SkinnedMesh?(i(t,""),t):null==r.type||"model"!=r.type.toLowerCase()&&"object3d"!=r.type.toLowerCase()?e(t.children[0]):(i(r,""),r)},n=function e(t){if(!0===t.unload)return null;if(t.children.length)for(var r=t.children.length-1;0<=r;r--)!0===t.children[r].unload?t.children.splice(r,1):e(t.children[r]);return t},e?(a=r(o),L.ndsModel.modelTree.set(t,n(a))):L.ndsModel.modelTree.set(t,r(o)),L.ndsModel.modelTree.get(t)):void 0;if(this.loadrelease&&!this.loadMergeRelease||1<L.ndsModel.getAllNoSketchModel().length||L.rootBodyNodeName){var s=new _e;s.uuid=function(){for(var e=[],t="0123456789abcdef",r=0;r<36;r++){var i=Math.floor(16*Math.random());e[r]=t.substring(i,i+1)}e[14]="4";var n=3&e[19]|8;return e[19]=t.substring(n,1+n),e[8]=e[13]=e[18]=e[23]="-",e.join("")}();for(var l=0;l<L.ndsModel.models.length;l++){var d=this.getModelTree(e,l,!0);d.ndsModel.isSketchModel||(0==l&&(L.rootBodyNodeName?s.name=L.rootBodyNodeName:(s.name=d.name+"1.asm",L.rootBodyNodeName=s.name),this.ndsModel.models[0].bodyUuid2NodeMap[s.uuid]=s),(d.parent=s).children.push(d))}return s.ndsModel=L.ndsModel.models[0],s.type="parentNode",s}return this.getModelTree(e,0)},E.getModelTreeById=function(e,t){if(null!=t){var n=L.ndsModel.getModelById(t);if(n&&n.id===t){var i,r,t=n.rootBodyNode;if(t)return i=function e(t,r){if(n.bodyUuid2ClonedNodeMap[t.uuid]=t,n.bodyUuid2ClonedNodeMap.isEmpty=!1,t.fullpath=""!=r?r+"/"+t.name:t.name,0<t.children.length)for(var i=0;i<t.children.length;++i)"PMI"==t.children[i].type||"views"==t.children[i].type||"captures"==t.children[i].type?(t.remove(t.children[i]),i--):e(t.children[i],t.fullpath)},r=function e(t){var r;return 1<t.children.length||1!=t.children.length||null!=t.type&&("model"==t.type.toLowerCase()||"part"==t.type.toLowerCase()||"assembly"==t.type.toLowerCase())||(r=t.children[0])instanceof THREE.Mesh||r instanceof THREE.Line||r instanceof THREE.LineSegments||r instanceof THREE.SkinnedMesh?(i(t,""),t):null==r.type||"model"!=r.type.toLowerCase()&&"object3d"!=r.type.toLowerCase()?e(t.children[0]):(i(r,""),r)},e?function e(t){if(!0===t.unload)return null;if(t.children.length)for(var r=t.children.length-1;0<=r;r--)!0===t.children[r].unload?t.children.splice(r,1):e(t.children[r]);return t}(r(t)):r(t)}}},E.getModelTotalTree=function(){if(0==this.ndsModel.models.length)return null;if(L.newrootBodyNode)return L.newrootBodyNode;this.PMINDSBodys=[];var e,t=new THREE.Vector3,r=new THREE.Vector3,M=(L.computeBoundingBox(L.scene,t,r,{flag:!0}),new THREE.Box3),E=(M.expandByPoint(r),M.expandByPoint(t),new THREE.Plane),w=new THREE.Matrix4,i={};if(L.pmiObject&&1!=L.pmiObject.children[0].version){if(i=this.getModelTree(!0)){!function e(t){if(t.pmiuuid&&0<t.pmiuuid.length){var r,i,n=new _e;n.name="PMI",n.type="PMI",n.parent=t,n.ndsModel=t.ndsModel,t.children.unshift(n),t.worldMatrix=L.ndsModel.calculateNodeWorldMatrix(t),w.extractRotation(t.worldMatrix),L.PMINDSBodys.push(n);for(var a=0;a<t.pmiuuid.length;++a){var o,s=t.pmiuuid[a];(o=t.ndsModel.PMIUUIDtoPMIObject[s])&&((s=new _e).parent=n,s.uuid=o.uuid,s.name=o.name,s.type=o.type,s.ndsModel=t.ndsModel,o.NdsBodyNode=s,n.children.push(s),L.PMINDSBodys.push(s))}if(o&&o.parent&&o.parent.views){(r=new _e).name=Pe.translateString("PMI_VIEW"),r.type="views",r.parent=t,r.ndsModel=t.ndsModel;for(var l=0;l<o.parent.views.length;l++){var d=o.parent.views[l],c=new _e,h=(c.parent=r,c.ndsModel=t.ndsModel,c.name=d.name,c.type="view",c.matrix=d.matrix,c.pmiuuids=d.pmiuuid,null),u=(d.clip&&(h=new THREE.Vector3(d.clipPlane[3],d.clipPlane[4],d.clipPlane[5]).applyMatrix4(w)),new THREE.Vector3(d.matrix[0],d.matrix[1],d.matrix[2]).applyMatrix4(w)),p=new THREE.Vector3(d.matrix[4],d.matrix[5],d.matrix[6]).applyMatrix4(w),f=new THREE.Vector3(d.matrix[8],d.matrix[9],d.matrix[10]).applyMatrix4(w),m=new THREE.Vector3(d.matrix[12],d.matrix[13],d.matrix[14]).applyMatrix4(t.worldMatrix);d.matrix[0]=u.x,d.matrix[1]=u.y,d.matrix[2]=u.z,d.matrix[4]=p.x,d.matrix[5]=p.y,d.matrix[6]=p.z,d.matrix[8]=f.x,d.matrix[9]=f.y,d.matrix[10]=f.z,d.matrix[12]=m.x,d.matrix[13]=m.y,d.matrix[14]=m.z,d.clip&&h?(1e-8<h.dot(f)&&h.negate(),E.setFromNormalAndCoplanarPoint(h.normalize(),m),E.intersectsBox(M)?c.hasSection=!0:c.hasSection=!1,c.normal=h.clone()):(E.setFromNormalAndCoplanarPoint(f.normalize().negate(),m),E.intersectsBox(M)?c.hasSection=!0:c.hasSection=!1,c.normal=f.clone()),r.children.push(c)}t.children.unshift(r)}if(o&&o.parent&&o.parent.captures){(i=new _e).name=Pe.translateString("PMI_Capture"),i.type="captures",i.parent=t,i.ndsModel=t.ndsModel;for(var g=0;g<o.parent.captures.length;g++){var v=o.parent.captures[g],y=new _e,h=(y.ndsModel=t.ndsModel,y.parent=i,y.name=v.name,y.type="capture",y.matrix=v.matrix,y.pmiuuids=v.pmiuuid,null),u=(v.clip&&(h=new THREE.Vector3(v.clipPlane[3],v.clipPlane[4],v.clipPlane[5]).applyMatrix4(w)),new THREE.Vector3(v.matrix[0],v.matrix[1],v.matrix[2]).applyMatrix4(w)),p=new THREE.Vector3(v.matrix[4],v.matrix[5],v.matrix[6]).applyMatrix4(w),f=new THREE.Vector3(v.matrix[8],v.matrix[9],v.matrix[10]).applyMatrix4(w),m=new THREE.Vector3(v.matrix[12],v.matrix[13],v.matrix[14]).applyMatrix4(t.worldMatrix);v.matrix[0]=u.x,v.matrix[1]=u.y,v.matrix[2]=u.z,v.matrix[4]=p.x,v.matrix[5]=p.y,v.matrix[6]=p.z,v.matrix[8]=f.x,v.matrix[9]=f.y,v.matrix[10]=f.z,v.matrix[12]=m.x,v.matrix[13]=m.y,v.matrix[14]=m.z,v.clip&&h?(1e-8<h.dot(f)&&h.negate(),E.setFromNormalAndCoplanarPoint(h.normalize(),m),E.intersectsBox(M)?y.hasSection=!0:y.hasSection=!1,y.normal=h.clone()):(E.setFromNormalAndCoplanarPoint(f.normalize().negate(),m),E.intersectsBox(M)?y.hasSection=!0:y.hasSection=!1,y.normal=f.clone()),i.children.push(y)}t.children.unshift(i)}}for(var A=0;A<t.children.length;A++)e(t.children[A])}(i);for(var n=0;n<i.children.length;n++){var a=i.children[n];if("PMI"==a.type){e=a;break}}for(var o=0;o<L.pmiObject.children.length;o++){var s=L.pmiObject.children[o];L.setPMIObjectVisible(s,!1)}e&&(L.setPMIObjectVisible(e,!0),L.AuxiliaryLineVisible||L.setAuxiliaryLineVisible(!1)),L.newrootBodyNode=i,setTimeout(function(){L.zoomExtents(!0)},500)}}else(i=L.getModelTree(!0))&&(L.newrootBodyNode=i);return i},E.NodeChange=function(e,t,r){return 0==t?this.getObjectByUUID(e.uuid,r):1==t?this.ndsModel.getModelById(r).bodyUuid2ClonedNodeMap[e.uuid]:void 0},E.MoveFromTextValue=function(e){("OpBall"==L.controls.getOperator().type||"OpDrag"==L.controls.getOperator().type)&&L.controls.getOperator().MoveFromTextValue(e)},E.MoveFromTextValueByDelta=function(e){"OpBall"==L.controls.getOperator().type&&L.controls.getOperator().MoveFromTextValueByDelta(e)},E.copyMeshes=function(e,t){for(var r=e.length=0,i=t.length;r<i;++r)e.push(new Pe.map(t[r].key,t[r].value.clone()))},E.getObjectByUUID=function(e,t){void 0===t&&(t=-1);return L.ndsModel?L.ndsModel.getBodyNodeFromUuid(e,t):L.modelRootObject.getObjectByProperty("uuid",e)},E.isolateObjectsByUUID=function(e){for(var t=[],r=0;r<e.length;r++){var i=null;(i=L.ndsModel?L.ndsModel.getBodyNodeFromUuid(e[r]):L.modelRootObject.getObjectByProperty("uuid",e[r]))&&t.push(i)}0<t.length&&L.isolateObjects(t)},E.SetShowHiddenMode=function(e){this.showHiddenMode=e},E.isolateObjects=function(e){for(var t=[],r=0;r<e.length;r++){var i=e[r];0==i.children.length&&!i.leafBodyAttri||t.push(i)}if(0!=t.length)if(L.ndsModel)L.ndsModel.inIsolate()&&L.exitIsolate(),L.ndsModel.isolateBodies(t,De.bodyOpacity,De.lineOpacity),L.selectionManager.clearSelection(),L.renderAllViews();else{for(var n=[],a=0,o=t.length;a<o;a++)t[a].traverse(function(e){var t;(null==e.children||e.children.length<=0||e instanceof THREE.SkinnedMesh||e.material)&&(n.push(new Pe.map(e,e.material)),t=e.material.clone(),e.material=t)});n.length<=0||(L.copyMeshes(L.isolateMeshes,n),L.selectionManager.clearSelection(),L.setObjectOpacityIsolate(L.modelRootObject,De.bodyOpacity,L.isolateMeshes),L.renderAllViews())}},E.getIsolateMeshes=function(){for(var e=[],t=0,r=L.isolateMeshes.length;t<r;t++)e.push(L.isolateMeshes[t].key);return e},E.setShouldApplySelectionMaterialState=function(e){void 0===e&&(e=!0),L.selectionManager&&L.isIn3DViewer()&&(L.selectionManager.shouldApplySelectedMaterial=e)},E.isAllwhiteforline=function(){for(var e in L.ndsModel.meshManager.materials)if(!L.ndsModel.meshManager.materials[e].mat.color.equals(new THREE.Color(1,1,1)))return!1;return!0},E.isolateObject=function(e){e=[e];L.hasObjectIsolated()?(L.dispatchEvent({type:"isolateSelectedObjects",objects:e}),e.length<=0||(L.ndsModel.isolateBodiesOnly(e),L.selectionManager.clearSelection(),L.renderAllViews())):(L.dispatchEvent({type:"isolateSelectedObjects",objects:e}),e.length<=0||(L.ndsModel.isolateBodies(e,De.bodyOpacity,De.lineOpacity),L.selectionManager.clearSelection(),L.renderAllViews()))},E.isolateSelectedObjects=function(){var e=L.selectionManager.getSelectedObjects();if(L.hasObjectIsolated()){if(L.dispatchEvent({type:"isolateSelectedObjects",objects:e}),e.length<=0)return;L.ndsModel.isolateBodiesOnly(e)}else{if(L.dispatchEvent({type:"isolateSelectedObjects",objects:e}),e.length<=0)return;L.ndsModel.isolateBodies(e,De.bodyOpacity,De.lineOpacity)}L.selectionManager.clearSelection(),L.renderAllViews(),De.enableBroadcast&&De.broadcastMajor&&He.updateBroadcastInfo("ModelState")},E.exitIsolate=function(){if(L.ndsModel){if(!L.ndsModel.inIsolate())return;L.ndsModel.exitIsolate()}else{if(L.isolateMeshes.length<=0)return;L.restoreOriginalMeshes(),L.isolateMeshes.length=0}L.renderAllViews(),L.dispatchEvent({type:"exitIsolate"})},E.transparentSelectedObjects=function(){this.setSelectedObjectRenderMode("");L.selectionManager.getSelectedObjects();for(var e,t=[],r=0;r<L.selectionManager.getSelectedObjects().length;r++){var i=L.selectionManager.getSelectedObjects()[r];0==i.children.length&&!i.leafBodyAttri||t.push(i)}0!=t.length&&(e=t,L.ndsModel.inIsolate()?(L.dispatchEvent({type:"transparentSelectedObjects",objects:e}),e.length<=0||(L.ndsModel.transparentizeBodiesOnly(e),L.selectionManager.clearSelection(),L.renderAllViews())):(L.dispatchEvent({type:"transparentSelectedObjects",objects:e}),e.length<=0||(L.ndsModel.transparentizeBodies(e),L.selectionManager.clearSelection(),L.renderAllViews())))},E.transparentObject=function(e){e=[e];L.ndsModel.inIsolate()?(L.dispatchEvent({type:"transparentSelectedObjects",objects:e}),e.length<=0||(L.ndsModel.transparentizeBodiesOnly(e),L.selectionManager.clearSelection(),L.renderAllViews())):(L.dispatchEvent({type:"transparentSelectedObjects",objects:e}),e.length<=0||(L.ndsModel.transparentizeBodies(e),L.selectionManager.clearSelection(),L.renderAllViews()))},E.transparentOrisolateSelectObjects=function(){if(L.ndsModel){for(var e=-1<this.showHiddenMode?L.selectionManager.getTempSelectedObjects():L.selectionManager.getSelectedObjects(),t=[],r=0;r<e.length;r++)var i=e[r],i=this.ndsModel.getLeafBodies(i),t=t.concat(i);t.length<=0||(t[0].isTransparent()?(L.dispatchEvent({type:"isolateSelectedObjects",objects:t}),L.ndsModel.isolateBodiesOnly(t)):(L.dispatchEvent({type:"transparentSelectedObjects",objects:t}),L.ndsModel.transparentizeBodiesOnly(t)),L.selectionManager.clearSelection(),L.renderAllViews())}},E.getSelectedObjectsstatus=function(){if(L.ndsModel){for(var e=L.ndsModel.getSelectedBodies(),t=0,r=0;r<e.length;++r)t+=e[r].isTransparent();return 0==t?{num:e.length,status:"show"}:t==e.length?{num:e.length,status:"transparent"}:{num:e.length,status:"other"}}},E.opaqueSelectedObjects=function(){for(var e=L.selectionManager.getSelectedObjects(),t=0,r=e.length;t<r;++t)L.ndsModel.opaqueBody(e[t])},E.hideSelectedObjects=function(){for(var e=-1<this.showHiddenMode?L.selectionManager.getTempSelectedObjects():L.selectionManager.getSelectedObjects(),t=[],r=0;r<e.length;r++){var i=e[r];0==i.children.length&&!i.leafBodyAttri||t.push(i)}if(0!=t.length){for(var n=0,a=(e=t).length;n<a;++n)L.ndsModel.hideBody(e[n]),L.modelBrowserDlg&&L.modelBrowserDlg.hideTreeNodeByObject(e[n]);L.selectionManager.clearSelection(),L.renderAllViews()}},E.showSelectedObjects=function(){L.selectionManager.getSelectedObjects();for(var e=[],t=0;t<L.selectionManager.getSelectedObjects().length;t++){var r=L.selectionManager.getSelectedObjects()[t];0==r.children.length&&!r.leafBodyAttri||e.push(r)}if(0!=e.length){for(var i,n=0,a=(i=e).length;n<a;++n)L.ndsModel.showBody(i[n]);L.renderAllViews()}},E.resetModelViewToDefault=function(){this.switchViewport("Normal",!1),this.showAllModel(),this.ndsModel.models.forEach(function(e){if(e.isSketchModel)return!0;e.getMeshSets().forEach(function(e){e.renderMode=0});for(var t=0;t<e.wholeLeafBodyNodes.length;t++){var r=e.wholeLeafBodyNodes[t];r.renderMode=0,r&&!r.defaultVisible&&(r.hide(),e.hasHiddenBodies=!0,e.hideBodies.push(r))}});for(var e=L.ndsModel.getActiveModel(),t=(e.removeAllLineMaterials(),e.removeAllFaceMaterials(),this.selectionManager.clearSelection(),this.exitIsolate(),He.getExtensionWithFlags(0)),r=0,i=t.length;r<i;++r)t[r].resetToDefault();this.cameraControl.isViewLockedBySingleBody=!1;e=L.controls.getOperator();e&&e.updateViewCenterByVisibleBody(),this.setRenderMode(L.defaultRenderMode,!1),L.cameraControl.isViewLockedBySingleBody=!1,this.resetCamera({useOrginal:!0}),L.renderAllViews()},E.reverseBodyVisibility=function(){this.ndsModel.models.forEach(function(e){e.isSketchModel&&e.reverseBodyVisibility()}),L.ndsModel.reverseBodyVisibility(),L.renderAllViews(),L.dispatchEvent({type:"reverseBodyVisibility"}),He.updateBroadcastInfo("ModelState")},E.setSelectedObjectDisplayResert=function(){var e=this.selectionManager.getSelectedleafObjects(),t=(this.setSelectedObjectRenderMode(""),L.selectionManager.getSelectedObjects());0<t.length&&(L.ndsModel.isolateBodiesOnly(t),L.selectionManager.clearSelection()),this.showSelectedObjects();for(var r=0;r<e.length;++r){var i=e[r];i.defaultVisible?i.show():i.hide()}};var ve,ye,Ae,Me,Ee,we=new Set;function xe(){L.dispatchEvent({type:"fullScreenEvent",isFullScreen:L.isFullScreen()})}if(E.setSelectedObjectRenderMode=function(e){void 0===e&&(e="");var t=L.selectionManager.getSelectedleafObjects();""!==e&&L.ndsModel.isolateBodiesOnly(t);for(var r=0;r<t.length;++r){var i=t[r];if(void 0!==i.leafBodyAttri)for(var n=i.ndsModel.getMeshSets(),a=0;a<n.length;++a){var o=n[a];void 0!==o.bodyNodes&&o.containsBodyNode(i)&&(o.updateMeshSetRenderMode(i,e),""!==e?(this.singlePartMode=!0,we.add(i)):we.delete(i))}}De.enableBroadcast&&De.broadcastMajor&&He.updateBroadcastInfo("ModelState"),0===we.length&&(this.singlePartMode=!1),L.renderAllViews()},E.hideObject=function(e){for(var t=[e],r=0,i=t.length;r<i;++r)L.ndsModel.hideBody(t[r]),L.selectionManager.deselectObject(t[r]),L.modelBrowserDlg&&L.modelBrowserDlg.hideTreeNodeByObject(t[r]);L.renderAllViews()},E.hideUnloadbodies=function(e){if(L.ndsModel)if(e.unload)L.ndsModel.hideBody(e);else if(e.children)for(var t=0;t<e.children.length;t++){var r=e.children[t];L.hideUnloadbodies(r)}},E.hideOtherObjects=function(){var e=-1<this.showHiddenMode?L.selectionManager.getTempSelectedObjects():L.selectionManager.getSelectedObjects();if(0!=e.length){for(var t=[],r=0;r<e.length;r++){var i=e[r];0==(i=L.getBodyNodeFromUuid(i.uuid,i.ndsModel.id)).children.length&&!i.leafBodyAttri||t.push(i)}if(0!=t.length){if(L.ndsModel){L.ndsModel.models.forEach(function(e){e.isSketchModel&&(e.outCall=!0)}),L.ndsModel.hideAllBodies();for(var n=e,a=0,o=n.length;a<o;++a)L.ndsModel.showBody(n[a]),L.hideUnloadbodies(n[a]);var s=L.controls.getOperator();s&&s.updateViewCenterByVisibleBody()}L.selectionManager.clearSelection(),L.renderAllViews()}}},E.SelectOtherObjects=function(){if(0==L.selectionManager.getSelectedObjects().length)for(var e=0;e<this.ndsModel.models.length;e++)this.ndsModel.models[e].isSketchModel||L.selectionManager.selectObject(this.ndsModel.models[e].rootBodyNode);else{for(var t=L.selectionManager.getSelectedObjects().concat(),r=0;r<this.ndsModel.models.length;r++)this.ndsModel.models[r].isSketchModel||L.selectionManager.selectObject(this.ndsModel.models[r].rootBodyNode);for(var i=0;i<t.length;i++){var n=t[i];L.selectionManager.deselectObject(n)}"OpDrag"==L.controls.getOperator().type&&L.controls.getOperator().InitBall(),L.renderAllViews()}},E.hideOtherObjectsfrombody=function(e){if(L.ndsModel){L.ndsModel.hideAllBodies();for(var t=[e],r=0,i=t.length;r<i;++r)L.ndsModel.showBody(t[r]),L.hideUnloadbodies(t[r]);e=L.controls.getOperator();e&&e.updateViewCenterByVisibleBody()}L.renderAllViews()},E.enableTransparent=function(e){if(this.ndsModel)for(var t=qa(this.ndsModel.models);!(r=t()).done;){var r=r.value;r.meshVisibleNeedsUpdate=!0,r.meshManager.enableTransparent=e}this.renderAllViews()},E.getModelFormat=function(){return this.ModelFormat},E.showAllModel=function(){if(L.exitIsolate(),L.ndsModel)for(var e=0;e<L.ndsModel.models.length;e++){var t=L.ndsModel.models[e];if(!t.isSketchModel)for(var r in t.showAllBodies(),t.bodyUuid2NodeMap)t.bodyUuid2NodeMap[r].unload&&t.hideBody(t.bodyUuid2NodeMap[r])}else L.showObject(L.scene,!0);L.modelBrowserDlg&&L.modelBrowserDlg.showAllTreeNode(),L.renderAllViews(),L.dispatchEvent({type:"showAllModel"}),De.enableBroadcast&&De.broadcastMajor&&He.updateBroadcastInfo("ModelState")},E.getSelectedObjectProperty=function(e){var t=L.selectionManager.getSelectedObjects();if(t.length<=0)return null;null!==L.propertyManager&&void 0!==L.propertyManager||(L.propertyManager=L.modelRequestor.createPropertyManager(L));var r=null;if(L.ndsModel){for(var i=[],n=[],a=0;a<t.length;++a){var o=L.ndsModel.getBodyNodeFromUuid(t[a].uuid);n.push(o)}for(var s=0,a=0;a<n.length;++a){if(0<=n[a].id&&!n[a].isHidden())-1==i.indexOf(n[a])&&i.push(n[a]);else for(var l=0,d=n[a].children.length;l<d;++l)n.push(n[a].children[l]);0<n[a].children.length&&"Body"==n[a].children[0].type&&!this.ndsModel.isBodyAllChildHidden(n[a])&&s++}var r={area:0,volume:0,boundingbox:new THREE.Vector3,meshNum:s,bodyNum:0,unit:L.modelUnit,boundingboxVolume:0},c=new THREE.Box3;if(L.ndsModel.activeModel.brepManager)for(l=0;l<i.length;++l){var h,u=i[l],p=L.ndsModel.activeModel.brepManager.GetBodyVolumeAndArea(u.uuid),f=L.ndsModel.getBodyBoundingBox(u),m=u.isHidden();p?m||(r.area+=p.area,r.volume+=p.volume,f&&(c.expandByPoint(f.max),c.expandByPoint(f.min))):(p={area:u.area,volume:u.volume},(h=L.getBodyNodeFileUnit(u))&&L.modelUnit&&(h=L.getUnitTransfrom(L.modelUnit,h),p.area*=h*h,p.volume*=h*h*h),f&&(c.expandByPoint(f.max),c.expandByPoint(f.min)),p&&!m&&(r.area+=p.area,r.volume+=p.volume))}else for(l=0;l<i.length;++l){var p={area:(u=i[l]).area,volume:u.volume},g=L.getBodyNodeFileUnit(u);g&&L.modelUnit&&(g=L.getUnitTransfrom(L.modelUnit,g),p.area*=g*g,p.volume*=g*g*g);m=((f=this.ndsModel.getBodyBoundingBox(u))&&(c.expandByPoint(f.max),c.expandByPoint(f.min)),u.isHidden());p&&!m&&(r.area+=p.area,r.volume+=p.volume)}r.boundingboxVolume=Math.abs(c.max.x-c.min.x)*Math.abs(c.max.y-c.min.y)*Math.abs(c.max.z-c.min.z),r.boundingbox.x=Math.abs(c.max.x-c.min.x),r.boundingbox.y=Math.abs(c.max.y-c.min.y),r.boundingbox.z=Math.abs(c.max.z-c.min.z);var v=L.getDispalyModelUnit(r.volume,r.area);v&&(r.volume=r.volume*v.scale*v.scale*v.scale,r.area=r.area*v.scale*v.scale,r.boundingbox.x*=v.scale,r.boundingbox.y*=v.scale,r.boundingbox.z*=v.scale,r.boundingboxVolume=r.boundingboxVolume*v.scale*v.scale*v.scale,r.unit=v.unit)}return L.propertyManager.getObjectProperty(t[0],e,r),r},E.getBrepMemory=function(){return(this.productData?this.productData.datas[0]:this).brepMemory},E.getPmiNum=function(){return(this.productData&&this.productData.datas[0].pmiNum?this.productData.datas[0]:this.ndsModel.activeModel).pmiNum},E.getObjectProperty=function(e,t,r,i){if(void 0===i&&(i=-1),"parentNode"===e.type){var n={area:0,volume:0,boundingbox:new THREE.Vector3,meshNum:0,bodyNum:0,unit:this.modelUnit,boundingboxVolume:0,pmiNum:0},a=this.modelRootObject.boundingBox;n.boundingboxVolume=Math.abs(a.max.x-a.min.x)*Math.abs(a.max.y-a.min.y)*Math.abs(a.max.z-a.min.z),n.boundingbox.x=Math.abs(a.max.x-a.min.x),n.boundingbox.y=Math.abs(a.max.y-a.min.y),n.boundingbox.z=Math.abs(a.max.z-a.min.z),(g=L.getDispalyModelUnit(n.volume,n.area))&&(n.boundingbox.x*=g.scale,n.boundingbox.y*=g.scale,n.boundingbox.z*=g.scale,n.boundingboxVolume=n.boundingboxVolume*g.scale*g.scale*g.scale,n.unit=g.unit);for(var o=0;o<this.ndsModel.models.length;o++){var s=this.getObjectProperty(this.ndsModel.models[o].rootBodyNode,null,r,i);n.area+=s.area,n.volume+=s.volume,n.meshNum+=s.meshNum,n.bodyNum+=s.bodyNum,n.pmiNum+=s.pmiNum}return t&&t(null,n),n}null!==L.propertyManager&&void 0!==L.propertyManager||(L.propertyManager=L.modelRequestor.createPropertyManager(L)),e=this.getObjectByUUID(e.uuid,e.ndsModel.id),r=r||!1;for(var l,d=!1,c=(L.ndsModel.setActiveModelByModelId(e.ndsModel.id),e.uuid!=L.ndsModel.rootBodyNode.uuid||e.RootArea||0!=L.getObjectOrSomeChildVisibleStatus(e)||(d=!0),[]),h=[e],u=0,p=0;p<h.length;++p){if(l=h[p].type.toLowerCase(),h[p].unload||!(0<=h[p].id)||h[p].isReferenceEntity()||h[p].isCoordinate()||h[p].isHidden()&&!d)for(var f=0,m=h[p].children.length;f<m;++f)h.push(h[p].children[f]);else c.push(h[p]);0<h[p].children.length&&"part"==l&&"Body"==h[p].children[0].type&&!this.ndsModel.isBodyAllChildHidden(h[p])&&u++}var g,v={area:0,volume:0,boundingbox:new THREE.Vector3,meshNum:u,bodyNum:De.HideLeafBody?u:c.length,unit:L.modelUnit,boundingboxVolume:0},a=new THREE.Box3;if(L.ndsModel.activeModel.brepManager)for(f=0;f<c.length;++f){var y,A=c[f],M=L.ndsModel.activeModel.brepManager.GetBodyVolumeAndArea(A.uuid),E=L.ndsModel.getBodyBoundingBox(A),w=A.isHidden();M?A._leafBodyAttri&&(w?d&&(v.area+=M.area,v.volume+=M.volume):(v.area+=M.area,v.volume+=M.volume,E&&!isNaN(E.max.x)&&(a.expandByPoint(E.max),a.expandByPoint(E.min)))):(M={area:(A=c[f]).area,volume:A.volume},(y=L.getBodyNodeFileUnit(A))&&L.modelUnit&&(y=L.getUnitTransfrom(L.modelUnit,y),M.area*=y*y,M.volume*=y*y*y),!E||isNaN(E.max.x)||w||(a.expandByPoint(E.max),a.expandByPoint(E.min)),!M||w&&!d||(v.area+=M.area,v.volume+=M.volume))}else for(var x=0;x<c.length;++x){var M={area:(A=c[x]).area,volume:A.volume},b=L.getBodyNodeFileUnit(A),E=(b&&L.modelUnit&&(b=L.getUnitTransfrom(L.modelUnit,b),M.area*=b*b,M.volume*=b*b*b),this.ndsModel.getBodyBoundingBox(A)),w=A.isHidden();!E||isNaN(E.max.x)||w||(a.expandByPoint(E.max),a.expandByPoint(E.min)),!M||w&&!d||(v.area+=M.area,v.volume+=M.volume)}return e.uuid!=L.ndsModel.rootBodyNode.uuid&&!r||this.ndsModel.isBodyOrSomeChildHidden(e)?e.uuid!=L.ndsModel.rootBodyNode.uuid&&(v.pmiNum=e.pmiuuid?e.pmiuuid.length:0):(v.pmiNum=this.getPmiNum(),a=this.modelRootObject.boundingBox),0==v.area&&0==v.volume&&0!=e.area&&(v.area=e.area,v.volume=e.volume),d&&0==e.area&&(e.area=v.area,e.volume=v.volume,e.RootArea=!0),v.boundingboxVolume=Math.abs(a.max.x-a.min.x)*Math.abs(a.max.y-a.min.y)*Math.abs(a.max.z-a.min.z),v.boundingbox.x=Math.abs(a.max.x-a.min.x),v.boundingbox.y=Math.abs(a.max.y-a.min.y),v.boundingbox.z=Math.abs(a.max.z-a.min.z),(g=L.getDispalyModelUnit(v.volume,v.area))&&(v.volume=v.volume*g.scale*g.scale*g.scale,v.area=v.area*g.scale*g.scale,v.boundingbox.x*=g.scale,v.boundingbox.y*=g.scale,v.boundingbox.z*=g.scale,v.boundingboxVolume=v.boundingboxVolume*g.scale*g.scale*g.scale,v.unit=g.unit),L.propertyManager.getObjectProperty(e,t,v),v},E.getfileProperty=function(e,t){var r=!1;for(e.uuid==L.ndsModel.rootBodyNode.uuid&&(r=!0),"Model"!=(e=this.getObjectByUUID(e.uuid,e.ndsModel.id)).type||1!=e.children.length||"Part"!=e.children[0].type||null!=e.parent||e.children[0].fileguid||(e=e.children[0]);(null==e.propertyfile||null==e.propertyfile)&&e.parent;)e=e.parent;this.getObjectProperty(e,t,r)},E.getStaticProperty=function(){return{meshNum:ge(L.scene).Mesh.count,bodyNum:this.ndsModel.wholeLeafBodyNodes.length,box:this.modelRootObject.boundingBox,pmiNum:this.productData.datas[0].pmiNum}},E.getUnvisibleList=function(e){if(L.ndsModel){for(var t=L.ndsModel.hideBodies,r=[],i=0;i<t.length;++i){var n=t[i];if(n&&!n.unload)for(e?-1==r.indexOf(n.uuid)&&r.push(n.uuid):L.ndsModel.objectidTouuid?-1==r.indexOf(n.objectid)&&r.push(n.objectid):(a=this.ndsModel.meshManager.bodyUuid2IdMap[n.uuid],-1==r.indexOf(a)&&r.push(a));n.parent;){if(e){if(-1!=r.indexOf(n.parent.uuid))break}else if(L.ndsModel.objectidTouuid){if(-1!=r.indexOf(n.parent.objectid))break}else if(null!=(a=this.ndsModel.meshManager.bodyUuid2IdMap[n.parent.uuid])&&-1!=r.indexOf(a))break;if(!L.ndsModel.isBodyAllChildHidden(n.parent))break;e?r.push(n.parent.uuid):L.ndsModel.objectidTouuid?r.push(n.parent.objectid):null!=(a=this.ndsModel.meshManager.bodyUuid2IdMap[n.parent.uuid])&&r.push(a),n=n.parent}}for(var a,t=L.ndsModel.UnloadNodes,i=0;i<t.length;++i)(n=t[i])&&(e?-1==r.indexOf(n.uuid)&&r.push(n.uuid):L.ndsModel.objectidTouuid?-1==r.indexOf(n.objectid)&&r.push(n.objectid):(a=this.ndsModel.meshManager.bodyUuid2IdMap[n.uuid],-1==r.indexOf(a)&&r.push(a)));return r}},E.hasObjectHidden=function(){if(L.ndsModel)return L.ndsModel.hasHiddenBodies},E.hasObjectIsolated=function(){if(L.ndsModel)return 0<L.getTransparentList().length},E.getTransparentList=function(){if(L.ndsModel){for(var e=L.ndsModel.getTransparentizedBodies(),t=[],r=0;r<e.length;++r){var i=e[r];i&&-1!=i.id&&(L.ndsModel.objectidTouuid?t.push(i.objectid):t.push(i.id))}return t}},E.HasBodyTransparent=function(){return this.hasTransparentBody},E.hasObjectHiddenOrIsolated=function(){var e;return L.ndsModel?!(!L.ndsModel.hasHiddenBodies&&!L.hasObjectIsolated()):0<L.isolateMeshes.length||((e=new Object).hidden=!1,0<L.scene.children.length&&function e(t,r){var i=t.children;if(null==i||i.length<=0||t instanceof THREE.SkinnedMesh){if(t instanceof THREE.Line||t instanceof THREE.LineSegments){if(L.bLinesVisibility)if(null!=t.tangentEdgeObject){if(1==De.tangentEdgeVisible&&0==t.visible)return void(r.hidden=!0)}else if(0==t.visible)return void(r.hidden=!0)}else if(0==t.visible)return void(r.hidden=!0)}else if(0==t.visible)return void(r.hidden=!0);if(i)for(var n=0,a=i.length;n<a;++n){if(r.hidden)return;e(i[n],r)}}(L.scene.children[0],e),!!e.hidden)},E.isAllHidden=function(){var e;return 0<this.scene.children.length&&((e=new Object).visible=!1,function e(t,r){if(0!=t.visible){var i=t.children;if((null==i||i.length<=0||t instanceof THREE.SkinnedMesh)&&t.visible)r.visible=!0;else for(var n=0,a=i.length;n<a;++n){if(r.visible)return;e(i[n],r)}}}(this.scene.children[0],e),!e.visible)},E.isObjectOrSomeChildHidden=function(e){var t=this.getObjectByUUID(e.uuid,e.ndsModel.id);if((t=t||e)instanceof _e&&L.ndsModel)return 0!=t.children.length||t.leafBodyAttri||"Body"==t.type?L.ndsModel.isBodyOrSomeChildHidden(t):!t.visible},E.getSelectedObjectsAllHidden=function(){if(L.ndsModel){for(var e=L.ndsModel.getSelectedBodies(),t=0;t<e.length;++t)if(e[t]&&!e[t].isHidden())return!1;for(t=0;t<e.length;++t)if(e[t]&&!L.ndsModel.isBodyAllChildHidden(e[t]))return!1}return!0},E.getObjectOrSomeChildVisibleStatus=function(e){var t;return e&&e.uuid?(t=(t=this.getObjectByUUID(e.uuid,e.ndsModel.id))||e)instanceof _e&&L.ndsModel?0!=t.children.length||t.leafBodyAttri||"Body"==t.type?L.ndsModel.getBodyOrSomeChildVisibleStatus(t):t.visible?1:0:void 0:0},E.isBodyAllChildTransparent=function(e){if(e instanceof _e&&L.ndsModel)return L.ndsModel.isBodyAllChildTransparent(e)},E.isEmptyNode=function(e){var t=this.getObjectByUUID(e.uuid,e.ndsModel.id);if((t=t||e).isOtherNode()||t.parent&&t.parent.isOtherNode())return!1;if(t instanceof _e&&L.ndsModel){if("Body"!=t.type||0!=t.children.length||t.leafBodyAttri){if(0<t.children.length){for(var r=0;r<t.children.length;++r){var i=t.children[r];if(!this.isEmptyNode(i))return!1}return!0}return!1}return!0}},E.getModelCenter=function(){var e=new THREE.Vector3,t=new THREE.Vector3,r=(L.computeBoundingBox(L.scene,e,t,{flag:!0}),new THREE.Vector3);return r.x=.5*(t.x+e.x),r.y=.5*(t.y+e.y),r.z=.5*(t.z+e.z),r},E.stopReadingModel=function(e){L.fileUpload&&(L.fileUpload.stopReadingModel(),L.showWaiterCoverStater(!1))},E.setLinesVisibility=function(e,t){L.bLinesVisibility=void 0===e||e,L.showLineObjects(L.modelRootObject,L.bLinesVisibility),!1!==t&&L.renderAllViews()},E.getLinesVisibility=function(e){return L.bLinesVisibility},E.setZoomSpeed=function(e){L.cameraControl.setZoomSpeed(e)},E.setRotateSpeed=function(e){L.cameraControl.setRotateSpeed(e)},E.getShowToolTipFlag=function(e){return e&&L.bShowToolTip&&(L.isFullScreen()?e.domElement.innerHTML=Pe.translateString("IDS_EXITFULLSCREEN"):e.domElement.innerHTML=Pe.translateString("IDS_FULLSCREEN")),L.bShowToolTip},E.getToolBarAutoHideFlag=function(){return L.bToolBarAutoHide},E.getMouseWheelForwardEnlargeFlag=function(){return L.bMouseWheelForwardEnlarge},E.isObjectTypeOfElement=function(e){return null!=e&&("element"==(e=e.type.toLowerCase())||"revitelement"==e||"body"==e||"object"==e||"instanceobject"==e||"acdblayertablerecord"==e)},E.isFullScreen=function(){return!!(document.fullscreenEnabled||document.mozFullScreenElement||document.webkitIsFullScreen||document.msFullscreenElement)},E.executeFullScreen=function(){var e,t;L.isFullScreen()?document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen&&document.msExitFullscreen():(e=r).requestFullscreen?e.requestFullscreen(t):e.mozRequestFullScreen?e.mozRequestFullScreen(t):e.webkitRequestFullscreen?e.webkitRequestFullscreen(t):e.msRequestFullscreen&&e.msRequestFullscreen(t)},E.startSmoothTranslation=function(e,t){this.cameraControl.startSmoothTranslation(e,t)},E.isSmoothTranslationDone=function(){return this.cameraControl.isSmoothTranslationDone()},E.smoothTranslation=function(e,t){this.cameraControl.smoothTranslation(e,t)},E.updateBackGroudImageRatio=function(e){var t,r,i,n,a,o;null!=e&&null!=e.map&&(e.map.imageOriginal instanceof HTMLImageElement||e.map.imageOriginal instanceof HTMLCanvasElement)&&(i=+L.renderer.domElement.width/L.renderer.domElement.height,o=+(t=e.map.imageOriginal.width)/(r=e.map.imageOriginal.height),n=t,a=r,.25<Math.abs(o-i)&&(i<o?(a=r,n=Math.floor(i*a)):(n=t,a=Math.floor(n/i))),t<n&&(n=t),r<a&&(a=r),10<Math.abs(n-e.map.image.width)||10<Math.abs(a-e.map.image.height))&&((o=document.createElement("canvas")).width=n,o.height=a,o.getContext("2d").drawImage(e.map.imageOriginal,Math.floor(.5*(t-n)),Math.floor(.5*(r-a)),n,a,0,0,o.width,o.height),e.map.image=o,e.map.needsUpdate=!0)},E.setBackGroundImage=function(e,t,r,i){if(void 0===i&&(i=-1),this.backGroundImage=e,this.backGroundImageindex=i,e){if(this.setEnvMapTextures(null),this.backGroundScene||(this.backGroundScene=new THREE.Scene,this.backGroundScene.matrixWorldAutoUpdate=!1,this.backGroundCamera=new THREE.OrthographicCamera(-1,1,1,-1,0,1),this.backGroundMesh=new THREE.Mesh(new THREE.PlaneGeometry(2,2),new THREE.MeshBasicMaterial),this.backGroundMesh.material.depthTest=!1,this.backGroundMesh.material.depthWrite=!1,this.backGroundScene.add(this.backGroundCamera),this.backGroundScene.add(this.backGroundMesh),this.backGroundScene.updateMatrixWorld(!0)),t&&t(.2),this.exchangeBackImage){i=!1;if(this.exchangeBackImage.value!==e&&(this.exchangeBackImage={type:"EnvMap",value:e},i=!0),!i)return}this.exchangeBackImage={type:"Image",value:e},De.avoidCaching,De.avoidCaching&&!De.singleHTML&&(e=e+"?time="+Date.now());var i=new THREE.TextureLoader,n=(i.crossOrigin="anonymous",i.load(e,function(){n.imageOriginal=n.image,L.backGroundMesh.material.map&&L.backGroundMesh.material.map.dispose(),L.backGroundMesh.material.map=n,L.backGroundMesh.material.needsUpdate=!0,L.updateBackGroudImageRatio(L.backGroundMesh.material),t&&t(1),L.renderAllViews(),L.dispatchEvent({type:"backGroundImageLoaded"})},void 0,function(e){r&&r(e),L.dispatchEvent({type:"backGroundImageLoaded"}),L.dispatchEvent({type:"backgroundloadError",errorInfo:"background image error"})}));De.enableBroadcast&&De.broadcastMajor&&He.updateBroadcastInfo("generalInfo")}else this.backGroundScene=void 0,this.backGroundCamera=void 0,this.backGroundMesh&&this.backGroundMesh.material&&this.backGroundMesh.material.map&&this.backGroundMesh.material.map.dispose(),this.backGroundMesh=void 0,this.renderAllViews()},E.setGroundShadowVisibility=function(e){P=e,L.groundShadowChange(),this.renderAllViews()},E.getGroundShadowVisibility=function(){return P},E.setSmoothTranslationEnabled=function(e){ae=e},E.setAutoRotationEnabled=function(e){oe=e,this.cameraControl.setAutoRotationEnabled(e)},E.toggleAutoRotation=function(e){oe&&this.cameraControl.toggleAutoRotation(e)},E.autoRotation=function(){this.cameraControl.autoRotation()},E.setCameraInfo=function(e,t){this.cameraControl.setCameraInfo(e,t)},E.toPerspectiveCamera=function(){this.GeomEmpty||(this.viewManager?this.viewManager.toPerspectiveCamera():(this.camera.toPerspective(),this.render()),De.enableBroadcast&&De.broadcastMajor&&He.updateBroadcastInfo("generalInfo"))},E.toOrthographicCamera=function(){this.viewManager?this.viewManager.toOrthographicCamera():(this.camera.toOrthographic(),this.render()),De.enableBroadcast&&De.broadcastMajor&&He.updateBroadcastInfo("generalInfo")},E.switchViewport=function(e,t){function r(e,t,r){n.viewManager||(n.viewManager=new ma(n),n.viewManager.setWindowSize(n.renderer.getSize().width,n.renderer.getSize().height),n.viewManager.init()),n.viewManager.clear(),n.viewManager.setLayout(e,t),n.viewManager.setConnectView(r),n.viewManager.initViewBoxForAllViews(),n.renderAllViews()}var i,n=this;this.cameraControl.isViewLockedBySingleBody||(i=L.controls.getOperator())&&i.updateViewCenterByVisibleBody();"Normal"==e?this.viewManager&&(this.viewManager.resetToSingleView(),this.viewManager=void 0,this.render()):"TwoPortVertical"==e?r(2,1,t):"TwoPortHorizontal"==e?r(1,2,t):"FourPort"==e&&r(2,2,t),De.enableBroadcast&&De.broadcastMajor&&He.updateBroadcastInfo("ViewManager")},E.opViewportConnect=function(e){this.viewManager&&this.viewManager.setConnectView(e)},E.isViewActive=function(e){return!e||!this.viewManager||this.viewManager.getActiveView().viewId==e.viewId},E.isInMultipleViewport=function(){return!!this.viewManager},E.setViewBoxDir=function(e){var t={smoothTranslation:!0,useOrginal:!1};null!=(L.defaultStandardView=e)&&""!=e||(t.useOrginal=!0),x||(t.type=e,L.look(t))},E.hideEnvMapTextures=function(e,t){$!=e&&($=e,0!=t)&&this.renderAllViews()},E.setEnvMapTextures=function(e,i,n,t){if(void 0===t&&(t=-1),this.envmapUrls=e,this.envmapUrlsindex=t,e){if(this.exchangeBackImage){for(var r=!1,a=0;a<e.length;a++)if(this.exchangeBackImage.value[a]!==e[a]){this.exchangeBackImage={type:"EnvMap",value:e},r=!0;break}if(!r)return}this.exchangeBackImage={type:"EnvMap",value:e},this.envMapScene||(t=this.container.getBoundingClientRect(),this.envMapCamera=new THREE.PerspectiveCamera(60,t.width/t.height,1,1e5),this.envMapScene=new THREE.Scene,this.envMapScene.matrixWorldAutoUpdate=!1,t=THREE.ShaderLib.cube,this.envMapMaterial=new THREE.ShaderMaterial({fragmentShader:t.fragmentShader,vertexShader:t.vertexShader,uniforms:t.uniforms,depthWrite:!1,depthTest:!1,blending:THREE.NoBlending,side:THREE.BackSide}),this.envMapMaterial.requireModelMatrix=!0,this.envMapMaterial.uniforms.tCube.value=this.envMapTexture,t=new THREE.Mesh(new THREE.BoxGeometry(100,100,100),this.envMapMaterial),this.envMapScene.add(t)),i&&i(.2);var o=[];if(De.avoidCaching&&!De.singleHTML)for(var s=0;s<e.length;++s)o.push(e[s]+"?time="+Date.now());else o=e;Pe.isMobileDevice()?Pe.resizeTextures(o,800,800).then(function(e){l(e)}).catch(function(e){console.error("Error resizing texture:",e)}):l(o),De.enableBroadcast&&De.broadcastMajor&&He.updateBroadcastInfo("generalInfo")}else this.updateEnvMap(null),this.envMapCamera=void 0,this.envMapScene=void 0,this.envMapTexture&&this.envMapTexture.dispose(),this.envMapTexture=void 0,this.envMapMaterial&&this.envMapMaterial.dispose(),this.envMapMaterial=void 0,this.exchangeBackImage=null,this.renderAllViews();function l(e){var t=new THREE.CubeTextureLoader,r=(t.crossOrigin="anonymous",t.load(e,function(){L.envMapTexture&&L.envMapTexture.dispose(),L.envMapTexture=r,L.envMapTexture.format=THREE.RGBFormat,L.envMapTexture.minFilter=THREE.LinearFilter,L.envMapTexture.magFilter=THREE.LinearFilter,L.envMapTexture.mapping="reflection"==d?THREE.CubeReflectionMapping:THREE.CubeRefractionMapping,L.envMapMaterial&&(L.envMapMaterial.uniforms.tCube.value=L.envMapTexture,L.envMapMaterial.needsUpdate=!0,k&&L.updateEnvMap(r),i&&i(1),setTimeout(function(){L.renderAllViews()},100),L.dispatchEvent({type:"envMapTexturesLoaded"}),e.forEach(function(e){return e.startsWith("blob:")&&URL.revokeObjectURL(e)}))},void 0,function(e){n&&n(e),L.dispatchEvent({type:"envMapTexturesLoaded"}),L.dispatchEvent({type:"loadError",errorInfo:"envMap error"})}))}},E.updateEnvMap=function(e){this.scene.environment!=e&&(this.scene.environment=this.hasPbrMaterial&&!e?this.defaultEnvMapTexture:e,this.renderAllViews())},E.setEnvMapEnabled=function(e){k!=(k=e)&&(k?this.updateEnvMap(this.envMapTexture):this.updateEnvMap(),this.renderAllViews())},E.setEnvMapMode=function(e){"reflection"!=(e=e.toLowerCase())&&"refraction"!=e||d!=(d=e)&&this.envMapTexture&&(this.envMapTexture.mapping="reflection"==d?THREE.CubeReflectionMapping:THREE.CubeRefractionMapping,k&&this.updateEnvMap(this.envMapTexture),this.renderAllViews())},E.updateEnvMapBlur=function(){if(D){var e=L.container.getBoundingClientRect(),t=e.width,e=e.height,r=L.renderer.getPixelRatio(),t=t*r*.5,e=e*r*.5;if(this.envMapBlurTargetH&&this.envMapBlurTargetH.dispose(),this.envMapBlurTargetH=new THREE.WebGLRenderTarget(t,e,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBFormat,stencilBuffer:!1}),this.envMapBlurTargetH.texture.generateMipmaps=!1,this.envMapBlurTargetV&&this.envMapBlurTargetV.dispose(),this.envMapBlurTargetV=new THREE.WebGLRenderTarget(t,e,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBFormat,stencilBuffer:!1}),this.envMapBlurTargetV.texture.generateMipmaps=!1,1==o||3<o){this.envMapBlurPassH&&this.envMapBlurPassH.dispose(),this.envMapBlurPassV&&this.envMapBlurPassV.dispose(),this.envMapBlurPassH=new Ur(ze,"tDiffuse"),this.envMapBlurPassV=new Ur(ze,"tDiffuse");var i=this.envMapBlurPassH.material.defines.HORIZONTAL=1;switch(l){case 1:i=2,s=1;break;case 2:i=3.5,s=1.5;break;case 3:i=6.5,s=2}this.envMapBlurPassH.material.defines.RESOLUTION=(s/t).toFixed(4),this.envMapBlurPassV.material.defines.RESOLUTION=(s/e).toFixed(4),this.envMapBlurPassH.material.defines.SIGMA=this.envMapBlurPassV.material.defines.SIGMA=i.toFixed(3)}else if(2==o){switch(l){case 1:s=1;break;case 2:s=1.5;break;case 3:s=2}this.envMapBlurPassH&&this.envMapBlurPassH.dispose(),this.envMapBlurPassV&&this.envMapBlurPassV.dispose(),this.envMapBlurPassH=new Ur(We,"tDiffuse"),this.envMapBlurPassV=new Ur(We,"tDiffuse"),this.envMapBlurPassH.material.defines.BLUR_LEVEL=this.envMapBlurPassV.material.defines.BLUR_LEVEL=l,this.envMapBlurPassH.material.defines.HORIZONTAL=1,this.envMapBlurPassH.material.defines.RESOLUTION=(s/t).toFixed(4),this.envMapBlurPassV.material.defines.RESOLUTION=(s/e).toFixed(4)}else if(3==o){this.envMapBlurPassH&&this.envMapBlurPassH.dispose(),this.envMapBlurPassV&&this.envMapBlurPassV.dispose(),this.envMapBlurPassH=new Ur(We,"tDiffuse"),this.envMapBlurPassV=new Ur(We,"tDiffuse");var n=.02;switch(l){case 1:n=.01;break;case 2:n=.03;break;case 3:n=.1}this.envMapBlurPassH.material.defines.BLUR_AMOUNT=this.envMapBlurPassV.material.defines.BLUR_AMOUNT=n.toFixed(4)}this.envMapBlurPassH.material.blending=this.envMapBlurPassV.material.blending=THREE.NoBlending,this.envMapBlurPassH.material.depthWrite=this.envMapBlurPassV.material.depthWrite=!1,this.envMapBlurPassH.material.depthTest=this.envMapBlurPassV.material.depthTest=!1}else this.envMapBlurTargetH&&this.envMapBlurTargetH.dispose(),this.envMapBlurTargetH=void 0,this.envMapBlurTargetV&&this.envMapBlurTargetV.dispose(),this.envMapBlurTargetV=void 0,this.envMapBlurPassH&&this.envMapBlurPassH.dispose(),this.envMapBlurPassH=void 0,this.envMapBlurPassV&&this.envMapBlurPassV.dispose(),this.envMapBlurPassV=void 0;this.renderAllViews()},E.setEnvMapBlurLevel=function(e){if(l=e,D){if(1==o||3<o){var t=1;switch(l){case 1:t=2,s=1;break;case 2:t=3.5,s=1.5;break;case 3:t=6.5,s=2}this.envMapBlurPassH.material.defines.RESOLUTION=(s/this.envMapBlurTargetH.width).toFixed(4),this.envMapBlurPassV.material.defines.RESOLUTION=(s/this.envMapBlurTargetH.height).toFixed(4),this.envMapBlurPassH.material.defines.SIGMA=this.envMapBlurPassV.material.defines.SIGMA=t.toFixed(3)}else if(2==o){switch(l){case 1:s=1;break;case 2:s=1.5;break;case 3:s=2}this.envMapBlurPassH.material.defines.RESOLUTION=(s/this.envMapBlurTargetH.width).toFixed(4),this.envMapBlurPassV.material.defines.RESOLUTION=(s/this.envMapBlurTargetH.height).toFixed(4),this.envMapBlurPassH.material.defines.BLUR_LEVEL=this.envMapBlurPassV.material.defines.BLUR_LEVEL=l}else if(3==o){var r=.02;switch(l){case 1:r=.01;break;case 2:r=.03;break;case 3:r=.1}this.envMapBlurPassH.material.defines.BLUR_AMOUNT=this.envMapBlurPassV.material.defines.BLUR_AMOUNT=r.toFixed(4)}this.envMapBlurPassH.material.needsUpdate=this.envMapBlurPassV.material.needsUpdate=!0,this.renderAllViews()}},E.setEnvMapBlurEnabled=function(e){D!=(D=e)&&this.updateEnvMapBlur()},E.getEnvMapBlurEnabled=function(){return D},E.setHemisphereLightIntensity=function(e){for(var t=0;t<this.lights.length;t++)this.lights[t]instanceof THREE.HemisphereLight&&(this.lights[t].intensity=e);J=e,this.renderAllViews()},E.setHemisphereLightColorHex=function(e){this.hemiSphereLight&&(this.hemiSphereLight.color.setHex(e),this.hemiSphereLight.groundColor.setHex(e),this.renderAllViews())},E.setHemisphereLightColorRGB=function(e,t,r){this.hemiSphereLight&&(this.hemiSphereLight.color.setRGB(e,t,r),this.hemiSphereLight.groundColor.setRGB(e,t,r),this.hemiSphereLight.color.getHex(),this.renderAllViews())},E.setDirectionalLightIntensity=function(e){for(var t=0;t<this.lights.length;t++)this.lights[t]instanceof THREE.DirectionalLight&&(this.lights[t].intensity=e);Z=e,this.renderAllViews()},E.setDirectionalLightColorHex=function(e){this.drectionalLight&&(this.drectionalLight.color.setHex(e),this.renderAllViews())},E.setDirectionalLightColorRGB=function(e,t,r){this.drectionalLight&&(this.drectionalLight.color.setRGB(e,t,r),this.drectionalLight.color.getHex(),this.renderAllViews())},E.getBodyUuids=function(){return Object.keys(L.ndsModel.bodyUuid2NodeMap)},E.initModelUpDirection=function(e,t){if(void 0===t&&(t=!1),void 0!==e){De.modelUpDirection=e;var r=new THREE.Matrix4,i=new THREE.Matrix4,n=new THREE.Matrix4,a=new THREE.Matrix4,o=(this.ndsModel.rootBodyNode.matrix&&r.fromArray(this.ndsModel.rootBodyNode.matrix),this.modelRootObject.boundingBox.getCenter());switch(n.makeTranslation(-o.x,-o.y,-o.z),r.premultiply(n),i.premultiply(n),e){case"posx":n.makeRotationAxis(new THREE.Vector3(0,0,1),.5*Math.PI);break;case"negx":n.makeRotationAxis(new THREE.Vector3(0,0,1),.5*-Math.PI);break;case"posy":break;case"negy":n.makeRotationAxis(new THREE.Vector3(1,0,0),Math.PI);break;case"posz":n.makeRotationAxis(new THREE.Vector3(1,0,0),.5*-Math.PI);break;case"posz1":n.makeRotationAxis(new THREE.Vector3(1,0,0),.5*-Math.PI),a.makeRotationAxis(new THREE.Vector3(0,1,0),.5*-Math.PI),n.premultiply(a);break;case"negz":n.makeRotationAxis(new THREE.Vector3(1,0,0),.5*Math.PI);break;case"negz1":n.makeRotationAxis(new THREE.Vector3(0,1,0),.5*Math.PI),a.makeRotationAxis(new THREE.Vector3(1,0,0),.5*Math.PI),n.premultiply(a)}if(r.premultiply(n),i.premultiply(n),n.makeTranslation(o.x,o.y,o.z),r.premultiply(n),i.premultiply(n),this.ndsModel.ModelUpMatrix4=i.toArray(),t)return r.toArray();this.ndsModel.updateNodeMatrix(this.ndsModel.rootBodyNode.uuid,r.toArray())}},E.setModelUpDirection=function(e,t){this.cameraControl.setModelUpDirection(e,t)},E.cancelModelUpDirection=function(){var e=/neg/g.test(De.modelUpDirection)?De.modelUpDirection.replace("neg","pos"):De.modelUpDirection.replace("pos","neg");"posy"==e&&(e="negy"),this.ndsModel.setActiveModel(0),this.setModelUpDirection(e,!0),this.ndsModel.getActiveModel().ModelUpMatrix4=[]},E.hasLineGeometry=function(){var e=this.selectionManager.getTargetLineList();return e&&0<e.length},E.getviewState=function(){return this.renderMode},E.getfileguid=function(e,t){function r(e){return e.parent&&e.parent.fileguid?e.parent.fileguid:e.parent?r(e.parent):null}e=L.ndsModel.getBodyNodeFromUuid(e,t);return e?e.fileguid||r(e):null},E.getHasAuxiliaryLine=function(){var t=!1;return this.ndsModel.models.forEach(function(e){t=t||!!e.isSketchModel}),t},E.setAuxiliaryLineVisible=function(t){this.ndsModel.models.forEach(function(e){e.isSketchModel&&e.rootBodyNode&&(t?L.ndsModel.showBody(e.rootBodyNode):L.ndsModel.hideBody(e.rootBodyNode))}),this.AuxiliaryLineVisible=t,L.renderAllViews()},E.getAuxiliaryLineVisible=function(){return this.AuxiliaryLineVisible},E.setRenderMode=function(e,t){if(this.ndsModel){for(var r=0,i=0;i<this.ndsModel.models.length;i++)for(var n=this.ndsModel.models[i].getMeshSets(),a=0;a<n.length;a++)r+=n[a].getNumMeshes();0==r&&(e="shadedWithEdges")}if(void 0!==e){this.renderMode=e;var o=G;switch(e){case"lighting":o=0;break;case"primarycolor":o=1;break;case"wireframe":o=2;break;case"whitemold":o=3;break;case"shadedWithEdges":o=4;break;case"shaded":o=5;break;case"hiddenLineRemove":o=6;break;case"hiddenLineVisible":o=7;break;case"transparent":o=8;break;default:o=this.is2DModel?(this.renderMode="shadedWithEdges",4):(this.renderMode="shaded",5)}if(o!=G){if(this.modelRootObject){switch(G){case 0:break;case 1:this.modelRootObject.traverse(function(e){e instanceof THREE.Line||e instanceof THREE.LineSegments||!e.hasOwnProperty("geometry")||!e.hasOwnProperty("material")||void 0!==e.material.orginalSpecular&&(e.material.specular.copy(e.material.orginalSpecular),e.material.orginalSpecular=void 0,e.material.needsUpdate=!0)});break;case 2:var s=this.hasLineGeometry();this.modelRootObject.traverse(function(e){e.hasOwnProperty("geometry")&&e.hasOwnProperty("material")&&(e instanceof THREE.Line||e instanceof THREE.LineSegments||(s?e.visible=!0:void 0!==e.material.wireframe&&(e.material.wireframe=!1,e.material.needsUpdate=!0)))});break;case 3:C=null;break;case 4:case 5:break;case 6:this.modelRootObject.traverse(function(e){e.hasOwnProperty("geometry")&&e.hasOwnProperty("material")&&(e instanceof THREE.Line||e instanceof THREE.LineSegments?e.renderOrder=0:(e.material.depthTest=!0,e.material.depthWrite=!0,void(e.renderOrder=0)!==e.material.colorWrite&&(e.material.colorWrite=!0,e.material.needsUpdate=!0)))});break;case 7:this.modelRootObject.traverse(function(e){e.hasOwnProperty("geometry")&&e.hasOwnProperty("material")&&(e instanceof THREE.Line||e instanceof THREE.LineSegments?(e.renderOrder=0,null!=e.material.oldOpacity&&(e.material.opacity=e.material.oldOpacity,e.material.depthFunc=e.material.oldDepthFunc,e.material.transparent=e.material.oldTransparent,e.material.needsUpdate=!0)):(e.material.depthTest=!0,e.material.depthWrite=!0,void(e.renderOrder=0)!==e.material.colorWrite&&(e.material.colorWrite=!0,e.material.needsUpdate=!0)))});break;case 8:this.transparentRenderMode(-1)}switch(o){case 0:break;case 1:this.scene.traverse(function(e){e instanceof THREE.Line||e instanceof THREE.LineSegments||!e.hasOwnProperty("geometry")||!e.hasOwnProperty("material")||void 0!==e.material.specular&&(e.material.orginalSpecular=e.material.specular.clone(),e.material.specular.setRGB(0,0,0),e.material.needsUpdate=!0)});break;case 2:s=this.hasLineGeometry();this.modelRootObject.traverse(function(e){e.hasOwnProperty("geometry")&&e.hasOwnProperty("material")&&(e instanceof THREE.Line||e instanceof THREE.LineSegments?(e.visible=!0,null!=e.tangentEdgeObject&&0==De.tangentEdgeVisible&&(e.visible=!1)):s?e.visible=!1:void 0!==e.material.wireframe&&(e.material.wireframe=!0,e.material.needsUpdate=!0))});break;case 3:(C=new THREE.MeshPhongMaterial).side=THREE.DoubleSide,C.skinning=!0,C.color.setRGB(.65,.65,.65),C.specular.setRGB(.4,.4,.4),C.shininess=60;break;case 4:this.modelRootObject.traverse(function(e){e.hasOwnProperty("geometry")&&e.hasOwnProperty("material")&&(e.visible=!0,e instanceof THREE.Line||e instanceof THREE.LineSegments)&&null!=e.tangentEdgeObject&&0==De.tangentEdgeVisible&&(e.visible=!1)});break;case 5:this.modelRootObject.traverse(function(e){e.hasOwnProperty("geometry")&&e.hasOwnProperty("material")&&(e instanceof THREE.Line||e instanceof THREE.LineSegments?e.visible=!1:e.visible=!0)});break;case 6:this.modelRootObject.traverse(function(e){e.hasOwnProperty("geometry")&&e.hasOwnProperty("material")&&(e instanceof THREE.Line||e instanceof THREE.LineSegments?(e.visible=!0,e.renderOrder=1e4,0==e.material.colorWrite&&(e.material=e.material.clone(),e.material.colorWrite=!0),null!=e.tangentEdgeObject&&0==De.tangentEdgeVisible&&(e.visible=!1)):(e.visible=!0,e.material.depthTest=!0,e.material.depthWrite=!0,void(e.renderOrder=0)!==e.material.colorWrite&&(e.material.colorWrite=!1,e.material.needsUpdate=!0)))});break;case 7:L.modelRootObject.traverse(function(e){e.hasOwnProperty("geometry")&&e.hasOwnProperty("material")&&(e instanceof THREE.Line||e instanceof THREE.LineSegments?(0==e.material.colorWrite&&(e.material=e.material.clone(),e.material.colorWrite=!0),e.material.oldOpacity=e.material.opacity,e.material.oldDepthFunc=e.material.depthFunc,e.material.oldTransparent=e.material.transparent,e.material.needsUpdate=!0,e.renderOrder=1e4,e.visible=!0,null!=e.tangentEdgeObject&&0==De.tangentEdgeVisible&&(e.visible=!1)):(e.visible=!0,e.material.depthTest=!0,e.material.depthWrite=!0,void(e.renderOrder=0)!==e.material.colorWrite&&(e.material.colorWrite=!1,e.material.needsUpdate=!0)))});break;case 8:this.transparentRenderMode(1)}}null!=this.modelSceneOrgin&&this.modelSceneOrgin!=this.scene&&(this.modelSceneOrgin.overrideMaterial=this.scene.overrideMaterial),G=o}else switch(o){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:break;case 8:this.transparentRenderMode(0)}!1!==t&&this.renderAllViews(),this.isIn3DViewer()&&(De.selectedColor=4===G?new THREE.Color(16776960):new THREE.Color(16233729),L.selectionManager.overrideMeshSelectionMaterialIn3DViewer()),De.enableBroadcast&&De.broadcastMajor&&He.updateBroadcastInfo("generalInfo")}},E.setDefaultEnvMap=function(){var e=document.createElement("canvas"),t=(e.width=256,e.height=256,e.getContext("2d")),t=(t.fillStyle="rgb(225,225,225)",t.fillRect(0,0,256,256),e.toDataURL()),r=(k=!0,this),e=new THREE.CubeTextureLoader;this.defaultEnvMapTexture=e.load([t,t,t,t,t,t],function(){r.defaultEnvMapTexture.format=THREE.RGBFormat,r.defaultEnvMapTexture.minFilter=THREE.LinearFilter,r.defaultEnvMapTexture.magFilter=THREE.LinearFilter,r.defaultEnvMapTexture.needsUpdate=!0,L.updateEnvMap(r.defaultEnvMapTexture,!0),L.dispatchEvent({type:"envMapTexturesLoaded"})})},E.setBackGroundColor=function(e){if(this.setBackGroundImage(null),this.setEnvMapTextures(null),this.exchangeBackImage={type:"Color",value:e},null==this.clearColor||this.clearColor!==e){He.onBeforeChangeBackGroundColor(e),this.clearColor=e;var t=(new THREE.Color).setHex(parseInt(e));if(this.renderer.setClearColor(parseInt(e),0),this.ndsModel&&this.is2DModel)if(2<=this.modelContentVersion){var r=new THREE.Color(1,1,1),i=new THREE.Color(0,0,0);if(t.equals(i)){for(var n in L.ndsModel.meshManager.materials){var a=L.ndsModel.meshManager.materials[n].mat;"ShaderMaterial"!=a.type&&a.color.equals(i)?a.color.copy(r):"ShaderMaterial"==a.type&&a.uniforms.diffuse.value.equals(i)&&(a.color&&a.color.copy(r),a.uniforms.diffuse.value.copy(r))}for(var o=0,s=L.ndsModel.meshManager.mats.length;o<s;++o){var l=L.ndsModel.meshManager.mats[o];l&&("ShaderMaterial"!=l.type&&l.color.equals(i)?l.color.copy(r):"ShaderMaterial"==l.type&&l.uniforms.diffuse.value.equals(i)&&(l.color&&l.color.copy(r),l.uniforms.diffuse.value.copy(r)))}}else{for(var n in L.ndsModel.meshManager.materials){var d=L.ndsModel.meshManager.materials[n].mat;"ShaderMaterial"!=d.type&&d.color.equals(r)?d.color.copy(i):"ShaderMaterial"==d.type&&d.uniforms.diffuse.value.equals(r)&&(d.color&&d.color.copy(i),d.uniforms.diffuse.value.copy(i))}for(var c=0,h=L.ndsModel.meshManager.mats.length;c<h;++c){var u=L.ndsModel.meshManager.mats[c];u&&("ShaderMaterial"!=u.type&&u.color.equals(r)?u.color.copy(i):"ShaderMaterial"==u.type&&u.uniforms.diffuse.value.equals(r)&&(u.color&&u.color.copy(i),u.uniforms.diffuse.value.copy(i)))}}this.ndsModel.activeModel.lineTypes&&this.ndsModel.activeModel.lineTypes.setBackGroundColor(t.equals(i)?t:r),this.ndsModel.activeModel.rootBodyNode&&this.ndsModel.activeModel.refreshMeshState(this.ndsModel.activeModel.rootBodyNode)}else{if(this.renderer.getClearColor(this.oldClearColor).equals(new THREE.Color(0,0,0))){for(var n in L.ndsModel.meshManager.materials)L.ndsModel.meshManager.materials[n].mat.color.equals(new THREE.Color(0,0,0))&&("ShaderMaterial"!=L.ndsModel.meshManager.materials[n].mat.type?L.ndsModel.meshManager.materials[n].mat.color.setRGB(1,1,1):"ShaderMaterial"==L.ndsModel.meshManager.materials[n].mat.type&&(L.ndsModel.meshManager.materials[n].mat.color.setRGB(1,1,1),L.ndsModel.meshManager.materials[n].mat.uniforms.diffuse.value.setRGB(1,1,1)));if(L.pmiObject){if(g=this.pmiObject.getObjectByName("TextGroup"))for(var p=0;p<g.children.length;++p){for(var f=g.children[p].geometry.attributes.position.data,m=0;m<f.count;++m)0==f.array[m*f.stride+3]&&0==f.array[m*f.stride+4]&&0==f.array[m*f.stride+5]&&(f.array[m*f.stride+3]=1,f.array[m*f.stride+4]=1,f.array[m*f.stride+5]=1);f.needsUpdate=!0,f.updateRange.count=f.count*f.stride}this.pmiObject.traverse(function(e){"LineSegments"==e.type&&e.material.color.equals(new THREE.Color(0,0,0))&&e.material.color.setRGB(1,1,1)})}}else{for(var n in L.ndsModel.meshManager.materials)L.ndsModel.meshManager.materials[n].mat.color.equals(new THREE.Color(1,1,1))&&("ShaderMaterial"!=L.ndsModel.meshManager.materials[n].mat.type?L.ndsModel.meshManager.materials[n].mat.color.setRGB(0,0,0):"ShaderMaterial"==L.ndsModel.meshManager.materials[n].mat.type&&(L.ndsModel.meshManager.materials[n].mat.color.setRGB(0,0,0),L.ndsModel.meshManager.materials[n].mat.uniforms.diffuse.value.setRGB(0,0,0)));if(this.pmiObject){for(var g=this.pmiObject.getObjectByName("TextGroup"),p=0;p<g.children.length;++p){for(f=g.children[p].geometry.attributes.position.data,m=0;m<f.count;++m)1==f.array[m*f.stride+3]&&1==f.array[m*f.stride+4]&&1==f.array[m*f.stride+5]&&(f.array[m*f.stride+3]=0,f.array[m*f.stride+4]=0,f.array[m*f.stride+5]=0);f.needsUpdate=!0,f.updateRange.count=f.count*f.stride}this.pmiObject.traverse(function(e){"LineSegments"==e.type&&e.material.color.equals(new THREE.Color(1,1,1))&&e.material.color.setRGB(0,0,0)})}}L.ndsModel.activeModel.lineTypes&&L.ndsModel.activeModel.lineTypes.setBackGroundColor(t)}e="#"+L.renderer.getClearColor(this.oldClearColor).getHexString(),""===this.container.style.backgroundColor&&(this.initialBackgroundColor=L.renderer.getClearColor()),this.container.style.backgroundColor=e,this.renderAllViews(),He.onAfterChangeBackGroundColor(e)}De.enableBroadcast&&De.broadcastMajor&&He.updateBroadcastInfo("generalInfo")},E.getMaterialsInfo=function(){if(L.materialsSetting)return L.materialsSetting.getMaterialsInfo()},E.getRenderMode=function(){return G},E.getMapList=function(){if(L.materialsSetting)return L.materialsSetting.getMapList()},E.removeMap=function(e,t){if(L.materialsSetting)return L.materialsSetting.removeMap(e,t,G)},E.isMapWorking=function(e){if(L.materialsSetting)return L.materialsSetting.isMapWorking(e)},E.removeObjectMaterial=function(e){L.materialsSetting.removeObjectMaterial(e)},E.getObjectMaterialInfo=function(e){return L.materialsSetting.getObjectMaterialInfo(e)},E.updateMaterialInfo=function(e,t){L.materialsSetting&&null!=e&&(L.materialsSetting.updateMaterialInfo(e,G,t),this.render())},E.updateAllMateriaslInfo=function(e,t){L.materialsSetting&&L.materialsSetting.updateAllMateriaslInfo(e,G,t)},E.autoSetBodyNodeMaterial=function(e){L.materialsSetting&&L.materialsSetting.autoSetBodyNodeMaterial(e||L.ndsModel.rootBodyNode.uuid)},E.getBodyNodeMaterialsInfo=function(){return L.ndsModel.getBodyNodeUUidToMaterial()},E.setBodyNodeMaterialsInfo=function(e){if(e){for(var t in L.bodyNodeUUidToMaterial){var r=L.bodyNodeUUidToMaterial[t],r=L.materialsSetting.jsonToMaterial(r);r&&(L.bodyNodeUUidToMaterial[t]=r)}L.ndsModel.setBodyNodeMaterials(L.bodyNodeUUidToMaterial)}},E.convertMaterialInfo=function(e,t){if(L.materialsSetting){var r=L.materialsSetting.convertMaterialInfo(e,t,G);if(r.matJson&&r.matObj){if(this.traverseAndReplaceMaterialMeshes(this.scene,r.matObj),this.animationsManager){var i=this.animationsManager.getAllAnimationScenes();if(i)for(var n=0;n<i.length;++n)this.traverseAndReplaceMaterialMeshes(i[n],r.matObj);this.animationsManager.setMaterialsUpdated(!0)}return this.modelSceneOrgin&&this.scene!=this.modelSceneOrgin&&this.traverseAndReplaceMaterialMeshes(this.modelSceneOrgin,r.matObj),this.render(),r.matJson}}},E.convertAllMaterialsInfo=function(e,t){if(L.materialsSetting){for(var r={materials:[]},i=!1,n=0,a=e.materials.length;n<a;++n){var o=L.materialsSetting.convertMaterialInfo(e.materials[n],t,G);if(o.matJson&&o.matObj){if(i=!0,r.materials.push(o.matJson),this.traverseAndReplaceMaterialMeshes(this.scene,o.matObj),this.animationsManager){var s=this.animationsManager.getAllAnimationScenes();if(s)for(var l=0;l<s.length;++l)this.traverseAndReplaceMaterialMeshes(s[l],o.matObj);this.animationsManager.setMaterialsUpdated(!0)}this.modelSceneOrgin&&this.scene!=this.modelSceneOrgin&&this.traverseAndReplaceMaterialMeshes(this.modelSceneOrgin,o.matObj)}else r.materials.push(e.materials[n])}return i&&(this.scene.overrideMaterial&&(this.scene.overrideMaterial.needsUpdate=!0),C&&(C.needsUpdate=!0),this.render()),r}},E.traverseAndReplaceMaterialMeshes=function(e,t){if(null!=e&&e instanceof THREE.Object3D&&!(e instanceof THREE.Light)&&(e.hasOwnProperty("geometry")&&e.material&&e.material.uuid==t.uuid&&(e.material=t,e.geometry instanceof THREE.BufferGeometry)&&null!=e.geometry.attributes.color&&(e.material.vertexColors=!0),null!=e.children))for(var r=e.children,i=0,n=r.length;i<n;++i)this.traverseAndReplaceMaterialMeshes(r[i],t)},E.traverseMaterialMeshes=function(e,t,r,i){var n,a,o,s,l;if(null!=e&&(e instanceof THREE.Object3D&&!(e instanceof THREE.Light)))if(e.hasOwnProperty("geometry"))e.material&&e.material.uuid==i.uuid&&(n=!1,(s=e.geometry)instanceof THREE.Geometry?n=null!=s.vertices&&0!=s.vertices.count:s instanceof THREE.BufferGeometry&&(n=null!=e.geometry.attributes.position),n||s.boundingBox)&&(null==s.boundingBox&&s.computeBoundingBox(),isFinite(s.boundingBox.min.x))&&(n=new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]),a=new Float32Array(24),(o=new THREE.BufferGeometry).setIndex(new THREE.BufferAttribute(n,1)),o.addAttribute("position",new THREE.BufferAttribute(a,3)),n=new THREE.LineSegments(o,r),a=s.boundingBox.min,o=s.boundingBox.max,(l=(s=n.geometry.attributes.position).array)[0]=o.x,l[1]=o.y,l[2]=o.z,l[3]=a.x,l[4]=o.y,l[5]=o.z,l[6]=a.x,l[7]=a.y,l[8]=o.z,l[9]=o.x,l[10]=a.y,l[11]=o.z,l[12]=o.x,l[13]=o.y,l[14]=a.z,l[15]=a.x,l[16]=o.y,l[17]=a.z,l[18]=a.x,l[19]=a.y,l[20]=a.z,l[21]=o.x,l[22]=a.y,l[23]=a.z,s.needsUpdate=!0,n.geometry.computeBoundingSphere(),e.add(n),n.updateMatrixWorld(!0),t.push({parent:e,marker:n}));else if(null!=e.children)for(var d=e.children,c=0,h=d.length;c<h;++c)this.traverseMaterialMeshes(d[c],t,r,i)},E.showMaterialMarkers=function(e,t,r){var i;L.materialsSetting&&null!=e&&(L.materialsSetting.cleanMaterialsMarkers(),"LineBasicMaterial"!=e.type&&(i=new THREE.LineBasicMaterial({color:16776960}),t&&i.color.setHex(t),r&&(i.lineWidth=r),this.traverseMaterialMeshes(this.scene,t=[],i,e),L.materialsSetting.setMaterialsMarkers(t),L.materialsSetting.setMaterialsMarkersMat(i)),this.render())},E.cleanMaterialMarkers=function(){L.materialsSetting&&(L.materialsSetting.cleanMaterialsMarkers(),this.render())},E.setLineWidth=function(e){L.showLineWidth=e,this.renderAllViews(),De.enableBroadcast&&De.broadcastMajor&&He.updateBroadcastInfo("generalInfo")},E.getObjectWorldMatrixByIds=function(e){for(var t={},r=0;r<e.length;r++){var i,n=L.ndsModel.objectidTouuid[e[r]],n=L.getBodyNodeFromUuid(n),n=L.ndsModel.calculateNodeWorldMatrix4D(n);0<this.ndsModel.ModelUpMatrix4.length&&((i=new THREE.Matrix4D).fromArray(this.ndsModel.ModelUpMatrix4),i.invert(),n.premultiply(i)),t[e[r]]=n.toArray()}return t},E.getBodyNodeFileUnit=function(e){for(;e&&!e.fileUnit;)e=e.parent;return e?e.fileUnit:null},E.getUnitScale=function(e){var t=1;return"millimeter"==e||"mm"==e?"centimeter"==this.modelUnit?t=10:"meter"==this.modelUnit?t=1e3:"inch"==this.modelUnit?t=25.4:"feet"==this.modelUnit?t=304.8:"micrometer"!=this.modelUnit&&"um"!=this.modelUnit||(t=.001):"centimeter"==e||"cm"==e?"millimeter"==this.modelUnit?t=.1:"meter"==this.modelUnit?t=100:"inch"==this.modelUnit?t=2.54:"feet"==this.modelUnit?t=30.48:"micrometer"!=this.modelUnit&&"um"!=this.modelUnit||(t=1e5):"meter"==e||"m"==e?"millimeter"==this.modelUnit?t=.001:"centimeter"==this.modelUnit?t=.01:"inch"==this.modelUnit?t=.0254:"feet"==this.modelUnit?t=.3048:"micrometer"!=this.modelUnit&&"um"!=this.modelUnit||(t=1e5):"inch"==e||"in"==e?"millimeter"==this.modelUnit?t=1/25.4:"centimeter"==this.modelUnit?t=10/25.4:"meter"==this.modelUnit?t=1e3/25.4:"feet"==this.modelUnit?t=12:"micrometer"!=this.modelUnit&&"um"!=this.modelUnit||(t=1/25400):"feet"==e||"ft"==e?"millimeter"==this.modelUnit?t=1/304.8:"centimeter"==this.modelUnit?t=10/304.8:"meter"==this.modelUnit?t=1e3/304.8:"inch"==this.modelUnit?t=1/12:"micrometer"!=this.modelUnit&&"um"!=this.modelUnit||(t=1/304800):"micrometer"!=e&&"um"!=e||("millimeter"==this.modelUnit||"mm"==this.modelUnit?t=1e3:"meter"==this.modelUnit||"m"==this.modelUnit?t=1e5:"centimeter"==this.modelUnit||"cm"==this.modelUnit?t=1e4:"inch"==this.modelUnit||"in"==this.modelUnit?t=25400:"feet"!=this.modelUnit&&"ft"!=this.modelUnit||(t=304800)),t},E.getUnitTransfrom=function(e,t){var r=1;return"millimeter"==e||"mm"==e?"centimeter"==t||"cm"==t?r=10:"micrometer"==t||"um"==t?r=.001:"meter"==t||"m"==t?r=1e3:"inch"==t||"in"==t?r=25.4:"feet"!=t&&"ft"!=t||(r=304.8):"centimeter"==e||"cm"==e?"millimeter"==t||"mm"==t?r=.1:"micrometer"==t||"um"==t?r=1e5:"meter"==t||"m"==t?r=100:"inch"==t||"in"==t?r=2.54:"feet"!=t&&"ft"!=t||(r=30.48):"meter"==e||"m"==e?"millimeter"==t||"mm"==t?r=.001:"micrometer"==t||"um"==t?r=1e-6:"centimeter"==t||"cm"==t?r=.01:"inch"==t||"in"==t?r=.0254:"feet"!=t&&"ft"!=t||(r=.3048):"inch"==e||"in"==e?"millimeter"==t||"mm"==t?r=1/25.4:"micrometer"==t||"um"==t?r=1/25400:"centimeter"==t||"cm"==t?r=10/25.4:"meter"==t||"m"==t?r=1e3/25.4:"feet"!=t&&"ft"!=t||(r=12):"feet"==e||"ft"==e?"millimeter"==t||"mm"==t?r=1/304.8:"micrometer"==t||"um"==t?r=1/304800:"centimeter"==t||"cm"==t?r=10/304.8:"meter"==t||"m"==t?r=1e3/304.8:"inch"!=t&&"in"!=t||(r=1/12):"micrometer"!=e&&"um"!=e||("millimeter"==t||"mm"==t?r=1e3:"meter"==t||"m"==t?r=1e5:"centimeter"==t||"cm"==t?r=1e4:"inch"==t||"in"==t?r=25400:"feet"!=t&&"ft"!=t||(r=304800)),r},E.getDispalyModelUnit=function(e,t){var r={unit:this.userModelUnit||this.modelUnit,scale:this.getUnitScale(this.userModelUnit||this.modelUnit)};return this.userModelUnit||(e<1||t&&t<1?"meter"==this.modelUnit?(r.unit="millimeter",r.scale=1e3):"feet"==this.modelUnit&&(r.unit="inch",r.scale=12):"centimeter"==this.modelUnit&&10<e&&De.inBIMContext?(r.unit="meter",r.scale=.01):"millimeter"==this.modelUnit&&100<e&&De.inBIMContext&&(r.unit="meter",r.scale=.001)),r},E.getModelUnit=function(){return this.modelUnit},E.setDispalyModelUnit=function(e,t){void 0===t&&(t=!0),this.userModelUnit="millimeter"==e||"mm"==e?"millimeter":"centimeter"==e||"cm"==e?"centimeter":"meter"==e||"m"==e?"meter":"inch"==e||"in"==e?"inch":"feet"==e||"ft"==e?"feet":"micrometer"==e||"um"==e?"um":null,this.__globalMeasureExtension&&this.__globalMeasureExtension.setMeasureDisplayUnit(),t&&(L.dispatchEvent({type:"measureChangeEvent",measureType:"update"}),(e=L.selectionManager.getSelectedBodyVolumeAndArea())?L.dispatchAsyncEvent({type:"BodySelectionChangeEvent",volumeAreaInfo:e[0],modelUnit:e[1]}):L.dispatchAsyncEvent({type:"BodySelectionChangeEvent",volumeAreaInfo:null,modelUnit:null})),De.enableBroadcast&&De.broadcastMajor&&He.updateBroadcastInfo("generalInfo")},E.setOperator=function(e){e&&(L.controls.setOperator(e),L.controls.addEventListener("change",L.render),L.onOpChanged({id:e.type}),L.viewManager)&&L.viewManager.updateViewConnectByOperator(e.type)},E.registOperator=function(e,t){this.operators.set(e,t)},E.setOperatorByID=function(e){this.operators.has(e)&&(L.controls.setOperator(this.operators.get(e)(L)),L.controls.addEventListener("change",L.render),L.onOpChanged({id:e})),L.viewManager&&L.viewManager.updateViewConnectByOperator(e),De.enableBroadcast&&De.broadcastMajor&&He.updateBroadcastInfo("generalInfo")},E.startMove=function(){"OpBall"==L.controls.getOperator().type&&L.controls.getOperator().startMove()},E.getCurrentOperatorID=function(){return L.controls.getOperator().type},E.getCurrentOperatorState=function(){return L.controls.getOperator().state},E.getCurrentMeasureType=function(){return L.__globalMeasureExtension?L.__globalMeasureExtension.getCurrentMeasureType():null},E.onFitToView=function(){L.zoomExtents()},E.onResetCamera=function(){L.resetCamera({useOrginal:!0})},E.onFullScreen=function(){L.executeFullScreen()},E.onLineVisibility=function(e){L.setLinesVisibility(e)},E.isLightEditControlSelected=function(){return!(null==L.lightControls||!L.lightControls.getVisible())&&L.lightControls.isLightEditControlSelected()},E.onLightEditor=function(){null==L.lightControls||L.lightControls.getVisible()?null!=L.lightControls&&L.lightControls.getVisible()&&L.lightControls.setVisible(!1):L.lightControls.setVisible(!0)},E.onModelBrowser=function(){this.modelBrowserDlg||(this.modelBrowserDlg=new ModelBrowserDialog(this)),this.modelBrowserDlg.show("模型结构")},E.setLogOperatorTime=function(e){this.logOperatorTime=e},E.logOperatorTimeShow=function(e,t,r){if(1==r){var i,n=Date.now();for(i in this.logOperatorTimeInfo){var a=this.logOperatorTimeInfo[i];console.log(i+"["+a+"-"+n+"]",n-a+"ms")}this.logOperatorTimeInfo={}}else this.logOperatorTimeInfo[e]=t},E.onCloseViewSection=function(){return L.clipPlaneManager&&L.clipPlaneManager.onCloseViewSection()},E.onSelectAndMoveModel=function(e){"OpDrag"==L.controls.getOperator().type&&(e?L.controls.getOperator().setMoveMode():L.controls.getOperator().setDefaultMode())},E.isModelMoved=function(){var t=!1;return L.scene.traverse(function(e){e.hasOwnProperty("geometry")&&"lightctrls"!=e.name&&null!=e.matrixWorldTransOrginalDrag&&(t=!0)}),t},E.onSelectAndRestoreModel=function(e){"OpDrag"==L.controls.getOperator().type&&(e?L.controls.getOperator().setRestoreMode():L.controls.getOperator().setDefaultMode())},E.onHideModel=function(){"OpDrag"==L.controls.getOperator().type&&L.controls.getOperator().hideSelectedModel()},E.onReverseVisibleAndHidingModel=function(){"OpDrag"==L.controls.getOperator().type&&L.controls.getOperator().reverseVisibleAndHidingModel()},E.onShowAllModel=function(){"OpDrag"==L.controls.getOperator().type&&L.controls.getOperator().showAllModel()},E.setSelectBodyByRect=function(e){var t=L.controls.getOperator();t&&t.setSelectBodyByRect(e),L.controls.staticAnnotation&&L.controls.staticAnnotation.setSelectBodyByRect(e),L.__globalMeasureExtension&&L.__globalMeasureExtension.setSelectBodyByRect(e)},E.drawTraceUpdate=function(){"OpDrawTrace"==L.controls.getOperator().type&&L.controls.getOperator().update()},E.onMoveForward=function(){var e=L.controls.getOperator();null!=e&&e.moveForwardBack(!0,!0)},E.onMoveBack=function(){var e=L.controls.getOperator();null!=e&&e.moveForwardBack(!1,!0)},E.onMoveLeft=function(){var e=L.controls.getOperator();null!=e&&e.pan(new THREE.Vector3(-20,0,0),!0)},E.onMoveRight=function(){var e=L.controls.getOperator();null!=e&&e.pan(new THREE.Vector3(20,0,0),!0)},E.setModelOperationModeInternal=function(e){c=e,L.clearCenterCross()},E.setModelOperationMode=function(e,t){c!=(c=e)&&"hall"==c&&j&&(this.scene.updateMatrixWorld(!0),this.controls.SetBoundingBoxUpdated(!1),this.scene.traverse(function(e){e.hasOwnProperty("geometry")&&"lightctrls"!=e.name&&(e.matrixWorldTransOrginal&&(e.matrixWorldTransOrginal=void 0),e.matrixWorldTransOrginalDrag)&&(e.matrixWorldTransOrginalDrag=void 0)}),null!=L.modelSceneOrgin&&L.modelSceneOrgin!=this.scene&&(L.modelSceneOrgin.updateMatrixWorld(!0),L.modelSceneOrgin.traverse(function(e){e.hasOwnProperty("geometry")&&(e.matrixWorldTransOrginal&&(e.matrixWorldTransOrginal=void 0),e.matrixWorldTransOrginalDrag)&&(e.matrixWorldTransOrginalDrag=void 0)})),this.cameraControl.onOperationModeChange(t)),L.clearCenterCross(),"FirstPerson"==c&&L.drawCenterCross()},E.getModelOperationMode=function(e){return c},E.setModelOperationVerticalRotationRange=function(e,t){null!=t&&null!=e&&(null!=h?h.set(e,t):h=new THREE.Vector2(e,t),"hall"==c)&&j&&(e=this.camera.position.clone().sub(this.camera.getCameraTarget()).angleTo(THREE.Object3D.DefaultUp),t=.5*Math.PI-e>=Math.abs(h.y)*Math.PI/180,e=0<e-.5*Math.PI&&e-.5*Math.PI>=Math.abs(h.x)*Math.PI/180,t||e)&&(this.scene.updateMatrixWorld(!0),this.controls.SetBoundingBoxUpdated(!1),this.scene.traverse(function(e){e.hasOwnProperty("geometry")&&"lightctrls"!=e.name&&(e.matrixWorldTransOrginal&&(e.matrixWorldTransOrginal=void 0),e.matrixWorldTransOrginalDrag)&&(e.matrixWorldTransOrginalDrag=void 0)}),null!=L.modelSceneOrgin&&L.modelSceneOrgin!=this.scene&&(L.modelSceneOrgin.updateMatrixWorld(!0),L.modelSceneOrgin.traverse(function(e){e.hasOwnProperty("geometry")&&"lightctrls"!=e.name&&(e.matrixWorldTransOrginal&&(e.matrixWorldTransOrginal=void 0),e.matrixWorldTransOrginalDrag)&&(e.matrixWorldTransOrginalDrag=void 0)})),this.camera.setOrginalCameraInfo(void 0),this.camera.up.set(0,1,0),t=new THREE.Matrix4,Math.abs(h.y)<4.5?t.lookAt(new THREE.Vector3(1,0,1),new THREE.Vector3,this.camera.up):t.lookAt(new THREE.Vector3(1,.1,1),new THREE.Vector3,this.camera.up),this.camera.quaternion.setFromRotationMatrix(t),this.resetCamera({useOrginal:!0}))},E.getModelOperationVerticalRotationRange=function(){return h},E.isLineExisted=function(){var t=!1;return this.scene.traverse(function(e){(e instanceof THREE.Line||e instanceof THREE.LineSegments)&&e.hasOwnProperty("geometry")&&e.hasOwnProperty("material")&&(L.materialsSetting&&L.materialsSetting.getMaterialsMarkersMat()==e.material||(t=!0))}),t},E.getBroadcastInfo=function(){return L.broadcastManager.getBroadcastInfo()},E.setToolbarVisibility=function(e){L.Optoolbar&&L.Optoolbar.setVisibility(e)},E.getToolbarVisibility=function(){return!!L.Optoolbar&&L.Optoolbar.getVisibility()},E.startBroadcast=function(e){L.broadcastManager.startBroadcast(e)},E.exitBroadcast=function(){L.broadcastManager.exitBroadcast()},E.setBroadcastInfo=function(e){L.broadcastManager.setBroadcastInfo(e)},E.getIntersectionPtByScreenPt=function(e,t){L.rayCaster||(L.rayCaster=new pn(this));var r,i=null;return L.ndsModel?(r=L.selectionManager.getPickIntersects(e[0],e[1]))&&0<r.length&&(i={coords:[r[0].point.x,r[0].point.y,r[0].point.z],locationObjectUUID:r[0].bodyNode.uuid,locationObject:r[0].bodyNode}):i=L.rayCaster.convertPointScreen(e,t),i},E.stopPMIOcclusion=function(e){De.StopPMIOcclusion=e;for(var t=0;t<this.ndsModel.models.length;t++){var r,i=this.ndsModel.models[t];for(r in i.PMIUUIDtoPMIObject){var n=i.PMIUUIDtoPMIObject[r];n.material&&(n.material.depthTest=!e)}}this.renderAllViews()},E.clientCoordToModelCoord=function(e){var t,r=L.renderer.getPixelRatio(),i=L.renderer.domElement,n=(3==e.length?t=e[2]:(n=new THREE.Vector3,L.controls.getBoundingBox().getCenter(n),n.project(L.camera),(t=n.z)<-1&&(t=-.99)),new THREE.Vector3),e=(n.set(e[0]*r/i.width*2-1,2*-(e[1]*r/i.height)+1,t),n.unproject(L.camera),[]);return e[0]=n.x,e[1]=n.y,e[2]=n.z,e},E.modelCoordToClientCoord=function(e){var t=L.renderer.getPixelRatio(),r=L.renderer.domElement,i=r.width/2,r=r.height/2,e=new THREE.Vector3(e[0],e[1],e[2]),i=(e.project(L.camera),(e.x*i+i)/t),r=(-e.y*r+r)/t,t=[];return t[0]=Math.round(i),t[1]=Math.round(r),t[2]=e.z,t},E.computeModelScreenBBox=function(){for(var e=L.controls.getBoundingBox(),t=e.min,e=e.max,r=[],i=t.clone(),n=(r.push(i),(i=t.clone()).set(e.x,t.y,t.z),r.push(i),(i=t.clone()).set(e.x,e.y,t.z),r.push(i),(i=t.clone()).set(t.x,e.y,t.z),r.push(i),(i=t.clone()).set(t.x,t.y,e.z),r.push(i),(i=t.clone()).set(e.x,t.y,e.z),r.push(i),(i=t.clone()).set(e.x,e.y,e.z),r.push(i),(i=t.clone()).set(t.x,e.y,e.z),r.push(i),new THREE.Vector2),a=new THREE.Vector2,o=0;o<r.length;o++){var s=[],s=(s[0]=r[o].x,s[1]=r[o].y,s[2]=r[o].z,L.modelCoordToClientCoord(s));0==o?(n.x=s[0],n.y=s[1],a.x=s[0],a.y=s[1]):(n.x=Math.min(n.x,s[0]),n.y=Math.min(n.y,s[1]),a.x=Math.max(a.x,s[0]),a.y=Math.max(a.y,s[1]))}return{min:n,max:a}},E.createScaledSphere=function(e,t){var r=new THREE.Mesh(new THREE.SphereBufferGeometry(1,24,24),new THREE.MeshBasicMaterial({color:16776960}));return r.cameraScale=.005,t&&(null!=t.color&&r.material.color.setHex(t.color),null!=t.scale)&&(r.cameraScale=t.scale),r.name="scaledSphere",r.position.set(e[0],e[1],e[2]),this.additionalObjectsScene&&this.additionalObjectsScene.add(r),this.renderAllViews(),{uuid:r.uuid}},E.updateAdditionalObjectsScene=function(){this.additionalObjectsScene&&this.additionalObjectsScene.traverse(function(e){var t;"scaledSphere"==e.name&&(t=e.position.distanceTo(L.camera.position)*e.cameraScale,e.scale.set(t,t,t))})},E.setObjectVisibilityByUuid=function(e,t){this.additionalObjectsScene&&(e=this.additionalObjectsScene.getObjectByProperty("uuid",e))&&(e.visible=t,this.renderAllViews())},E.removeObjectByUuid=function(e){var t,r=!1;if(L.additionalObjectsScene&&(t=L.additionalObjectsScene.getObjectByProperty("uuid",e))&&(t.parent.remove(t),r=!0,L.renderAllViews()),!r)if(L.ndsModel){var i=L.ndsModel.getBodyNodeFromUuid(e);i&&(L.selectionManager.isObjectSelected(i)&&L.selectionManager.deselectObject(i),L.ndsModel.delete(i),L.renderAllViews())}else if(t=L.scene.getObjectByProperty("uuid",e)){t.parent.remove(t),r=!0,t==L.modelRootObject&&(L.modelRootObject=null),L.selectionManager.computeTargetList(L.scene);var n=[];if(!function e(t,r){var i=t.children;if((null==i||i.length<=0||t instanceof THREE.SkinnedMesh)&&t.material)r.push(t);else for(var n=0,a=i.length;n<a;++n)e(i[n],r)}(t,n),0<n.length)for(var a=0;a<n.length;a++)for(var o=0;o<L.originalMeshes.length;o++)if(L.originalMeshes[o].key==n[a]){L.originalMeshes[o]=null,L.originalMeshes.splice(o,1);break}L.renderAllViews()}r&&L.controls.SetBoundingBoxUpdated(!1)},E.createPlaneByWorldPoints=function(e,t,r,i){if(!t){if(null==i)return null;if(i.length<9)return null}var n,a=L.controls.getBoundingBox().min,a=L.controls.getBoundingBox().max.distanceTo(a),o=new THREE.Plane,s=new THREE.Vector3(i[0],i[1],i[2]),l=new THREE.Vector3(i[3],i[4],i[5]),i=new THREE.Vector3(i[6],i[7],i[8]),i=(o.setFromCoplanarPoints(s,l,i),t?n=new THREE.Vector3(0,0,0):(s=L.controls.getBoundingBox().getCenter(),l=o.distanceToPoint(s),(n=s.clone()).sub(o.normal.clone().multiplyScalar(l))),{uuid:"",normal:[o.normal.x,o.normal.y,o.normal.z],point:[n.x,n.y,n.z]});if("square"==e){var t=new THREE.PlaneGeometry(a,a,1,1),s=new THREE.Mesh(t,new THREE.MeshBasicMaterial({color:16776960,side:THREE.DoubleSide,opacity:.4})),d=(i.uuid=s.uuid,new THREE.BufferGeometry),c=((u=new Float32Array(15))[0]=-.5*a,u[1]=-.5*a,u[3]=.5*a,u[4]=-.5*a,u[6]=.5*a,u[7]=.5*a,u[9]=-.5*a,u[10]=.5*a,u[12]=-.5*a,u[13]=-.5*a,d.addAttribute("position",new THREE.BufferAttribute(u,3)),new THREE.Line(d,new THREE.LineBasicMaterial({color:0})));s.add(c),r&&(null!=r.planeColor&&s.material.color.setHex(r.planeColor),null!=r.lineColor&&c.material.color.setHex(r.lineColor),null!=r.opacity)&&(s.material.opacity=r.opacity),s.position.copy(n),s.material.transparent=!0,(f=new THREE.Quaternion).setFromUnitVectors(new THREE.Vector3(0,0,1),o.normal),s.quaternion.copy(f),this.additionalObjectsScene&&this.additionalObjectsScene.add(s)}else if("circle"==e){for(var h=new THREE.CircleBufferGeometry(.5*a,32),l=new THREE.Mesh(h,new THREE.MeshBasicMaterial({color:16776960,side:THREE.DoubleSide,opacity:.4})),d=(i.uuid=l.uuid,new THREE.BufferGeometry),u=new Float32Array(99),p=0;p<33;p++)u[3*p]=h.attributes.position.array[3*(p+1)],u[3*p+1]=h.attributes.position.array[3*(p+1)+1],u[3*p+2]=h.attributes.position.array[3*(p+1)+2];d.addAttribute("position",new THREE.BufferAttribute(u,3));var f,c=new THREE.Line(d,new THREE.LineBasicMaterial({color:0}));l.add(c),r&&(null!=r.planeColor&&l.material.color.setHex(r.planeColor),null!=r.lineColor&&c.material.color.setHex(r.lineColor),null!=r.opacity)&&(l.material.opacity=r.opacity),l.material.transparent=!0,l.position.copy(n),(f=new THREE.Quaternion).setFromUnitVectors(new THREE.Vector3(0,0,1),o.normal),l.quaternion.copy(f),this.additionalObjectsScene&&this.additionalObjectsScene.add(l)}return this.renderAllViews(),i},E.createPlaneByScreenPoints=function(e,t,r){var i,n,a,o,s;return null==t||t.length<4?null:((i=new THREE.Matrix4).multiplyMatrices(this.camera.matrixWorld,i.getInverse(this.camera.projectionMatrix)),n=this.renderer.getPixelRatio(),a=this.renderer.domElement,o=[],(s=new THREE.Vector3).set(t[0]*n/a.width*2-1,2*-(t[1]*n/a.height)+1,0),s.applyMatrix4(i),o.push(s.x),o.push(s.y),o.push(s.z),s.set(t[2]*n/a.width*2-1,2*-(t[3]*n/a.height)+1,0),s.applyMatrix4(i),o.push(s.x),o.push(s.y),o.push(s.z),s.set(t[0]*n/a.width*2-1,2*-(t[1]*n/a.height)+1,.1),s.applyMatrix4(i),o.push(s.x),o.push(s.y),o.push(s.z),this.createPlaneByWorldPoints(e,o,r))},E.setMeshVertexColorByUuid=function(e,t,r){if(e&&t){var i=this.scene.getObjectByProperty("uuid",e);if(i&&i.geometry&&i.geometry instanceof THREE.BufferGeometry&&null!=i.geometry.attributes.position){var n=i.geometry.attributes.position.count;if(i.material&&i.material.color){for(var a=new Float32Array(3*n),o=0;o<n;++o)a[3*o+0]=i.material.color.r,a[3*o+1]=i.material.color.g,a[3*o+2]=i.material.color.b;for(var s=new THREE.Color,o=0,l=t.length;o<l;++o){var d=t[o].index;d<n&&(s.setHex(t[o].color),a[3*d+0]=s.r,a[3*d+1]=s.g,a[3*d+2]=s.b)}i.geometry.addAttribute("color",new THREE.BufferAttribute(a,3)),i.material=i.material.clone(),i.material.vertexColors=!0,i.material.needsUpdate=!0,0!=r&&this.renderAllViews()}}}},E.getReleaseInfo=function(e,t,r){var i;He.getExtension("SceneEditExtension")&&(i=He.getExtension("SceneEditExtension"),L._enableGroundShadow=P,L._bEnableEnvMapBlur=D,i.getReleaseInfo(e,t,r))},E.removeMeshVertexColorByUuid=function(e,t){e=this.scene.getObjectByProperty("uuid",e);e&&e.geometry&&e.geometry instanceof THREE.BufferGeometry&&null!=e.geometry.attributes.color&&(e.geometry.removeAttribute("color"),e.material&&(e.material.vertexColors=!1,e.material.needsUpdate=!0),0!=t)&&this.renderAllViews()},E.clear=function(){this.ndsModel&&(this.ndsModel.dispose(),this.scene.remove(this.ndsModel),this.ndsModel=null),this.pmiObject&&(this.pmiObject.traverse(function(e){e.geometry&&e.geometry.dispose()}),this.scene.remove(this.pmiObject),this.pmiObject=null),this.animationsManager=new AnimationsManager(this),this.pmiObject=null,this.PersistentId2uuid=new Map,this.ndsModel.activeModel.brepManager=null,this.inWaitProcedure=!1,this.inWheel=!1,this.viewer2DInfo={center:new THREE.Vector3(0,0,0),normal:new THREE.Vector3(0,0,1),yDir:new THREE.Vector3(0,1,0),distance:100},this.materialsSetting=void 0,this.propertyManager=void 0,this.containProperty=!1,this.trueMapList=null,this.commentManager.clear(),this.ndsModel=null,this.ndsModelBvhLoaded=!1,this.ndsModelPMILoaded=!1,this.ndsModelObjectTreeLoaded=!1,this.nBufferChunks=0,this.nBufferChunksLoaded=0},E.onUpdateProgress=function(e){e=e.userData.precent;.99<=e?L.progressBar.style.visibility="hidden":(L.progressBarFrontground.style.width=L.progressBarWidth*e+"px",L.progressBar.style.visibility="visible")},E.loadBrepInfo=function(t){this.ndsModel.activeModel.brepManager||(this.ndsModel.activeModel.brepManager=this.modelRequestor.createBrepManager(this,this.modelRequestor,this.ndsModel.activeModel)),this.ndsModel.models.forEach(function(e){e.brepManager.loadBreps(t)})},E.clearBrepEdgesPoints=function(){this.ndsModel.models.forEach(function(e){e.brepManager&&e.brepManager.clearBrepEdgesPoints()})},E.dispatchBrepEvent=function(){var e=!!(this.ndsModel&&this.modelRootObject&&this.modelRootObject.boundingBox);this.dispatchEvent({type:"BrepInfoEvent",faceArea:this.brepInfo.BfaceArea,bodyVolume:this.brepInfo.BbodyVolume,totalVolume:this.brepInfo.BbodyVolume,bodyArea:this.brepInfo.BbodyArea,totalArea:this.brepInfo.BtotalArea,boundingbox:!(!this.brepInfo.BfaceArea||!e),facePerimeter:this.brepInfo.BfacePerimeter})},E.dispatchModelEvent=function(e){"PMIInfoEvent"==e.type&&0==--A&&(this.pmiObject?this.dispatchEvent({type:"PMIInfoEvent",PMI:!0}):this.dispatchEvent({type:"PMIInfoEvent",PMI:!1})),"BVHInfoEvent"==e.type&&0==--M&&this.dispatchEvent({type:"BVHInfoEvent"}),"geometryAllLoadedEvent"==e.type&&0==--y&&this.dispatchEvent(e)},E.hasBrepInfo=function(){return!(!this.ndsModel||0===this.ndsModel.models.length||!this.ndsModel.activeModel.brepManager)&&this.ndsModel.activeModel.brepManager.hasBrepInfo()},E.hasBrepFile=function(){return!(!this.ndsModel||0===this.ndsModel.models.length||!this.ndsModel.activeModel.brepManager)&&this.ndsModel.activeModel.brepManager.hasBrepFile()},E.enableRotation=function(e){v=e,L.viewBox&&L.viewBox.enableViewBox(e)},E.isRotationEnable=function(){return v},E.enablePreSelection=function(e){0==(De.enablePreSelectBrep=e)&&this.selectionManager.clearPreSelection()},E.enableDirectMoveAndRotate=function(e){De.enableDirectMove=e,De.enableDirectRotate=e},E.enableDirectMove=function(e){De.enableDirectMove=e},E.enableDirectRotate=function(e){De.enableDirectRotate=e},E.getSelectList=function(){var e=L.ndsModel.getSelectedBodies(),t=[],i=(e.forEach(function(e){return t.push(e.objectid)}),[]);return e.forEach(function(e){for(var t=e.objectid,r=L.getObjectByUUID(e.ndsModel.objectidTouuid[t],e.ndsModel.id);r.parent&&e.ndsModel.isBodyAllChildSelected(r.parent)&&-1==i.indexOf(r.parent.objectid);)i.push(r.parent.objectid),r=r.parent}),De.HideLeafBody?i:t.concat(i)},E.showObjectbyId=function(e,t,r,i){void 0===i&&(i=[]);for(var n=0;n<e.length;n++){var a,o=this.ndsModel.getModelById(i[n]);(o=o||this.ndsModel.activeModel)&&(a=o.objectidTouuid[e[n]],L.showObject(o.getBodyNodeFromUuid(a),t,r&&n==e.length-1))}},E.ObjectIdTouuid=function(e,t){t=this.ndsModel.getModelById(t=void 0===t?0:t);if(t)return t.objectidTouuid[e]},E.ObjectuuidToId=function(e){return L.getBodyNodeFromUuid(e).objectid},E.addSelectList=function(e,t,r,i){if(void 0===i&&(i=[]),t)L.selectionManager.selectObjectByList(e,r,i);else{for(var n=[],a=0;a<e.length;a++){var o=e[a],o=(this.ndsModel.getModelById(i[a])||this.ndsModel.activeModel).objectidTouuid[o],o=L.getObjectByUUID(o,i[a]);o&&(!0===r?n.push(o):L.selectionManager.deselectObject(o))}if(!0===r)for(var s=0;s<n.length;s++)L.selectionManager.deselectObject(n[s],s==n.length-1)}L.renderAllViews()},E.setTransparentState=function(e,t){var r=[];e.forEach(function(e){return r.push(L.getBodyNodeFromUuid(L.ndsModel.objectidTouuid[e]))}),r.length<=0||(t?(L.ndsModel.inIsolate()?L.ndsModel.transparentizeBodiesOnly(r):L.ndsModel.transparentizeBodies(r),L.renderAllViews()):L.hasObjectIsolated()&&(L.ndsModel.isolateBodiesOnly(r),L.renderAllViews()))},E.zoomToObjectById=function(e,t){var r=this.ndsModel.getModelById(t=void 0===t?0:t);r&&(r=r.objectidTouuid[e],e=L.getBodyNodeFromUuid(r,t),L.zoomToObject(e,!0))},E.dispatchAsyncEvent=function(e){setTimeout(function(){L.dispatchEvent(e)},.5)},E.addIconToContainer=function(e,t,r){this.container.appendChild(e)},E.removeIconFromContainer=function(e,t){this.container.removeChild(e)},E.syncSendMsg=function(e){e.UnitState=this.userModelUnit;var t=this.getExtension("ColorChangeExtension");this.AssemblyPMIState&&(e.AssemblyPMIState=this.AssemblyPMIState,this.AssemblyPMIState=null),this.PartPMIState&&(e.PartPMIState=this.PartPMIState,this.PartPMIState=null),this.PartPMIState||this.AssemblyPMIState||(e.pmiVisible=this.pmiVisible),this.exchangeBackImage&&(e.exchangeBackImage=this.exchangeBackImage),t&&null!=t.oneKeyColor.isActive&&!0===t.oneKeyColor.isActive?(e.useRandomColor=!0,e.randColor=t.oneKeyColor.color,t.oneKeyColor.isActive=!0):t&&null!=t.oneKeyColor.isActive&&!1===t.oneKeyColor.isActive&&(e.useRandomColor=!1,e.randColor=null,t.oneKeyColor.isActive=null),t&&0<t.exchangeNodeColor.length&&(e.exchangeNodeColor=t.exchangeNodeColor)},E.syncGetMsg=function(e){e.ClearColor!=L.renderer.getClearColor(this.oldClearColor).getHex()&&this.setBackGroundColor(e.ClearColor),e.UnitState!=this.userModelUnit&&this.setDispalyModelUnit(e.UnitState);var t=!1;if(e.AssemblyPMIState&&null!=e.AssemblyPMIState.visible&&(t=!0,this.setAssemblyPMIVisible(e.AssemblyPMIState.visible)),e.PartPMIState&&null!=e.PartPMIState.visible&&(t=!0,this.setPartPMIVisible(e.PartPMIState.visible)),t||this.setPmiVisible(e.pmiVisible),e.exchangeBackImage&&("Image"===e.exchangeBackImage.type?(this.setEnvMapTextures(null),this.setBackGroundImage(e.exchangeBackImage.value)):"EnvMap"===e.exchangeBackImage.type?this.setEnvMapTextures(e.exchangeBackImage.value):"Color"===e.exchangeBackImage.type&&(this.setEnvMapTextures(null),this.setBackGroundImage(null),this.setBackGroundColor(e.exchangeBackImage.value))),null!=e.useRandomColor&&!0===e.useRandomColor?(t=this.getExtension("ColorChangeExtension"))&&t.autoChangeObjectColor(!0,e.randColor):null!=e.useRandomColor&&!1===e.useRandomColor&&((t=this.getExtension("ColorChangeExtension"))&&t.autoChangeObjectColor(!1,null),e.useRandomColor=null),e.exchangeNodeColor)for(var r=0;r<e.exchangeNodeColor.length;r++)colorChangeExtension&&colorChangeExtension.changeObjectColor(e.exchangeNodeColor[r].objectUUID,e.exchangeNodeColor[r].color)},E.Countermand=function(){this.countermandarray=[],this.countermandflag=-1},E.CountermandRecode=function(){for(var e=[],t=[],r=[],i=[],n={},a=0,o=L.ndsModel.wholeLeafBodyNodes.length;a<o;++a){var s=L.ndsModel.wholeLeafBodyNodes[a];s.leafBodyAttri&&(s.isHidden()?L.ndsModel.objectidTouuid?t.push(s.objectid):t.push(s.id):L.ndsModel.objectidTouuid?e.push(s.objectid):e.push(s.id),L.ndsModel.inIsolate())&&(!s.isIsolated()&&s.isTransparent()?L.ndsModel.objectidTouuid?r.push(s.objectid):r.push(s.id):L.ndsModel.objectidTouuid?i.push(s.objectid):i.push(s.id))}if(0==t.length?n.meshInvisible=[]:0==e.length&&0<t.length?n.meshVisible=[]:t.length<=e.length?n.meshInvisible=t:n.meshVisible=e,r.length<=i.length?n.meshTrans=r:n.meshNoTrans=i,this.countermandflag==this.countermandarray.length-1)if(this.countermandarray.length<11)this.countermandarray.push(n);else{for(a=0;a<10;++a)this.countermandarray[a]=this.countermandarray[a+1];this.countermandarray[10]=n}else{this.countermandarray[this.countermandflag+1]=n;for(var l=this.countermandarray.length-this.countermandflag-2;0<l;)this.countermandarray.pop(),l--}this.countermandflag=this.countermandarray.length-1},E.CountermandStep=function(e){if(!(e&&this.countermandflag>this.countermandarray.length-2||!e&&this.countermandflag<1||this.countermandarray.length<2)){e?this.countermandflag++:this.countermandflag--;var t=this.countermandarray[this.countermandflag];if(t.meshVisible&&L.ndsModel){L.ndsModel.hideBody(L.ndsModel.rootBodyNode);for(var r=0;r<t.meshVisible.length;++r)n=this.ndsModel.objectidTouuid?(a=L.ndsModel.objectidTouuid[t.meshVisible[r]],L.ndsModel.getBodyNodeFromUuid(a)):L.ndsModel.getBodyNode(t.meshVisible[r]),L.ndsModel.hasHiddenBodies=!0,n.show()}if(t.meshInvisible&&L.ndsModel){L.ndsModel.showBody(L.ndsModel.rootBodyNode);for(r=0;r<t.meshInvisible.length;++r)n=this.ndsModel.objectidTouuid?(a=L.ndsModel.objectidTouuid[t.meshInvisible[r]],L.ndsModel.getBodyNodeFromUuid(a)):L.ndsModel.getBodyNode(t.meshInvisible[r]),L.ndsModel.hasHiddenBodies=!0,n.hide()}if(L.ndsModel&&L.ndsModel.inIsolate()&&L.ndsModel.exitIsolate(),t.meshTrans&&0<t.meshTrans.length&&L.ndsModel){for(var i=[],r=0;r<t.meshTrans.length;++r)n=this.ndsModel.objectidTouuid?(a=L.ndsModel.objectidTouuid[t.meshTrans[r]],L.ndsModel.getBodyNodeFromUuid(a)):L.ndsModel.getBodyNode(t.meshTrans[r]),i.push(n);L.ndsModel.transparentizeBodies(i)}if(t.meshNoTrans)if(0<t.meshNoTrans.length){for(var n,a,i=[],r=0;r<t.meshNoTrans.length;++r)n=this.ndsModel.objectidTouuid?(a=L.ndsModel.objectidTouuid[t.meshNoTrans[r]],L.ndsModel.getBodyNodeFromUuid(a)):L.ndsModel.getBodyNode(t.meshNoTrans[r]),i.push(n);L.ndsModel.isolateBodies(i,De.bodyOpacity,De.lineOpacity)}else 0==t.meshNoTrans.length&&((e=[]).push(L.ndsModel.rootBodyNode),L.ndsModel.transparentizeBodies(e));L.renderAllViews()}},E.CountermandTest=function(e){return!(e&&this.countermandflag>this.countermandarray.length-2||!e&&this.countermandflag<1||this.countermandarray.length<2)},E.getObjectProByName=function(e,a,t){var r,o=new Array(a.length),t=("string"!=typeof e&&(e=e.toString()),this.ndsModel.getModelById(t));return t&&t.bodyUuid2ClonedNodeMap[e]&&t.bodyUuid2ClonedNodeMap[e].propertyfile&&t.bodyUuid2ClonedNodeMap[e].propertyList?(t.bodyUuid2ClonedNodeMap[e].propertyList.forEach(function(e){for(var t in e)for(var r=e[t],i=0;i<r.length;i+=2){var n=r[i],n=a.indexOf(n);-1!=n&&(o[n]=r[i+1])}}),r=[],o.forEach(function(e){e&&r.push(e)}),r):[]},E.getPMIInfo=function(){for(var o=this,s=[],e=0;e<this.ndsModel.models.length;e++){var l,d=this.ndsModel.models[e];for(l in d.PMIUUIDtoPMIObject)!function(){var t,r,e,i,n,a=d.PMIUUIDtoPMIObject[l];a.children&&0<a.children.length&&a.NdsBodyNode&&("Mesh"==a.children[0].type||"Line"==a.children[0].type||"Line2"==a.children[0].type||"LineSegments"==a.children[0].type||"LineSegments2"==a.children[0].type||"Note"==a.children[0].type)&&(t=[],r=[],a.NdsBodyNode.parent.parent.children.forEach(function(e){"captures"===e.type&&e.children.forEach(function(e){e.pmiuuids&&-1!=e.pmiuuids.indexOf(a.uuid)&&t.push(e)}),"views"===e.type&&e.children.forEach(function(e){e.pmiuuids&&-1!=e.pmiuuids.indexOf(a.uuid)&&r.push(e)})}),e=[],(n=He.getExtension("NDSSketchPMIExtension"))&&(e=n.getSketchListByPMIuuid(a.uuid,a.NdsBodyNode.ndsModel.id)),n=o.getObjectByUUID(a.NdsBodyNode.parent.parent.uuid,a.NdsBodyNode.parent.parent.ndsModel.id),i=[],n)&&(n.children.forEach(function(e){e.bodyPmiuuid&&-1!=e.bodyPmiuuid.indexOf(a.uuid)&&i.push(e.objectid)}),n={id:a.uuid,name:a.name,type:a.type,captures:t,views:r,bodyList:i,bodyNodeName:a.NdsBodyNode.parent.parent.name,bodyNodeID:a.NdsBodyNode.parent.parent.objectid,semanticPMI:a.semanticPMI,sketchList:e},s.push(n))}()}return s},E.getPMIObject=function(){return L.pmiObject||null},E.selectPMIObject=function(e,t){if(null==t&&(t=!0),e instanceof _e){if("PMI"==e.name&&"PMI"==e.type){for(var r=0;r<e.children.length;r++){var i=e.children[r];this.selectPMIObject(i,t)}return}e=this.ndsModel.getModelById(e.ndsModel.id).PMIUUIDtoPMIObject[e.uuid]}this.ndsModel.selectPMIObject(e,t)},E.getPMIObjectByuuid=function(e,t){return this.ndsModel.getModelById(t=void 0===t?0:t).PMIUUIDtoPMIObject[e]},E.selectPMIObjectByuuids=function(e,t,r){null==t&&(t=!0);for(var i=0;i<e.length;i++){var n=e[i],n=this.ndsModel.getModelById(r[i]).PMIUUIDtoPMIObject[n];this.ndsModel.selectPMIObject(n,!1)}t&&this.dispatchEvent({type:"selPMI",object:null,fromProxy:!0})},E.deselectPMIObject=function(e,t){if(null==t&&(t=!0),e instanceof _e){if("PMI"==e.name&&"PMI"==e.type){for(var r=0;r<e.children.length;r++){var i=e.children[r];this.deselectPMIObject(i,t)}return}e=this.ndsModel.getModelById(e.ndsModel.id).PMIUUIDtoPMIObject[e.uuid]}this.ndsModel.deselectPMIObject(e,t)},E.setCaptureView=function(t,e){void 0===e&&(e=!1);for(var r=0;r<L.pmiObject.children.length;r++){var i=L.pmiObject.children[r];this.setPMIObjectVisible(i,!1)}for(var n=0;n<L.pmiObject.children.length;n++){var a=L.pmiObject.children[n];this.deselectPMIObject(a,!0)}L.dispatchAsyncEvent({type:"deselPMI",object:L.pmiObject}),t.pmiuuids&&0<t.pmiuuids.length&&t.pmiuuids.forEach(function(e){e=L.ndsModel.getModelById(t.ndsModel.id).PMIUUIDtoPMIObject[e];e&&L.setPMIObjectVisible(e,!0)});var o,s,l=new THREE.Vector3(t.matrix[8],t.matrix[9],t.matrix[10]),d=(l.normalize(),new THREE.Vector3(t.matrix[4],t.matrix[5],t.matrix[6])),c=(d.normalize(),{}),h=(e&&(c.clipGlobalPlaneObjects=[],o=new THREE.Plane(new THREE.Vector3(0,0,-1),0),s=new THREE.Vector3(t.matrix[12],t.matrix[13],t.matrix[14]),o.setFromNormalAndCoplanarPoint(t.normal.clone(),s),(h=new THREE.Quaternion).setFromUnitVectors(new THREE.Vector3(0,0,-1),o.normal),s={position:s,quaternion:new THREE.Quaternion,meshquaternion:h},c.clipGlobalPlaneObjects.push(s),c.planeNameToId={},c.planeNameToId.YZ=-1,c.planeNameToId.XY=0,c.planeNameToId.XZ=-1,c.clippingPlanes=[o],c.clipActiveId=0,c.planeVisible=!1,c.clipModeState="both",c.fromView=!0),He.onSetCaptureView(e,c),{smoothTranslation:!0});h.from=l.toArray(),h.up=d.toArray(),h.viewCapture=!0,void 0!==this.viewManager&&(this.viewManager.getActiveView().is2DView&&this.opViewportConnect(!1),h.smoothTranslation=!1),L.look(h)},E.isPMIObjectOrSomeChildHidden=function(e){if(e instanceof _e){if("PMI"==e.name&&"PMI"==e.type){for(var t=0;t<e.children.length;t++){var r=e.children[t];if(this.isPMIObjectOrSomeChildHidden(r))return!0}return!1}e=this.ndsModel.getModelById(e.ndsModel.id).PMIUUIDtoPMIObject[e.uuid]}var i=!0;return e.traverse(function(e){0!=e.visible&&!e.SelectVisible||(i=!1)}),!i},E.getPMIObjectOrSomeChildVisibleStatus=function(e){var t=0,r=0;if(e instanceof _e){if("PMI"==e.name&&"PMI"==e.type){for(var i=0;i<e.children.length;i++){var n=e.children[i];t++,this.isPMIObjectOrSomeChildHidden(n)||r++}if(r<t&&0!=r)return 2}e=this.ndsModel.getModelById(e.ndsModel.id).PMIUUIDtoPMIObject[e.uuid]}return e&&e.traverse&&e.traverse(function(e){e.visible&&!e.SelectVisible&&r++,t++}),0==t?0:r==t?1:0!=r&&r<t?2:0},E.isPMIObjectSelect=function(e){if(e instanceof _e){if("PMI"==e.name&&"PMI"==e.type){for(var t=0;t<e.children.length;t++){var r=e.children[t];this.isPMIObjectSelect(r)}return}e=this.ndsModel.getModelById(e.ndsModel.id).PMIUUIDtoPMIObject[e.uuid]}var i=!0;return e.traverse(function(e){e.select||"Mesh"!=e.type&&"Line"!=e.type&&"LineSegments"!=e.type&&"Line2"!=e.type&&"LineSegments2"!=e.type||(i=!1)}),i},E.getPMISelectList=function(){var t;if(L.pmiObject)return t=[],L.pmiObject.traverse(function(e){e.select&&0<e.children.length&&("Mesh"==e.children[0].type||"Line"==e.children[0].type||"LineSegments"==e.children[0].type||"Line2"==e.children[0].type||"LineSegments2"==e.children[0].type)&&t.push(e)}),t},E.getPMINDSBodySelectList=function(){var t;if(L.pmiObject)return t=[],L.PMINDSBodys.forEach(function(e){L.isPMIObjectSelect(e)&&t.push(e)}),t},E.setPMIObjectVisible=function(e,t){if(e instanceof _e){if("PMI"==e.name&&"PMI"==e.type){for(var r=0;r<e.children.length;r++){var i=e.children[r];this.setPMIObjectVisible(i,t)}return}e=this.ndsModel.getModelById(e.ndsModel.id).PMIUUIDtoPMIObject[e.uuid]}var n=this.pmiObject,a=(0==n.visible&&(n.visible=!0),He.getExtension("NDSSketchPMIExtension"));if(!t&&e.select&&e.visible)e.SelectVisible=!0,e.traverse(function(e){e.SelectVisible=!0});else{n.uuid!=e.uuid&&((e.visible=t)&&a&&a.showSketchObjectByPMIuuid(e.uuid,e.ndsModel.id),t)&&e.SelectVisible&&(e.SelectVisible=!1),e.traverse(function(e){(e.visible=t)&&a&&a.showSketchObjectByPMIuuid(e.uuid,e.ndsModel.id),t&&e.SelectVisible&&(e.SelectVisible=!1)});for(var o=e;o&&o.parent;)t&&(o.parent.visible=t),o=o.parent;De.enableBroadcast&&De.broadcastMajor&&He.updateBroadcastInfo("PMIState"),this.renderAllViews()}},E.shwoFollowCameraPmi=function(){L.pmiObject.traverse(function(e){e.followCamera&&L.setPMIObjectVisible(e,!0)})},E.clearCanvas2D=function(){var e=this.renderer.getPixelRatio();this.canvas2D.getContext("2d").clearRect(0,0,window.innerWidth*e,window.innerHeight*e)},E.renderWaterMark=function(e){var t=this.renderer.getPixelRatio(),r=e.text||this.watermark;if((!e.imageSrc||e.imgLoad)&&(r=e.imageSrc?" ":r)&&this.excalibur)if(Pe.isMobileDevice()){r=r.substr(0,20);var i=Math.cos(45*Math.PI/180),n=Math.sin(45*Math.PI/180),a=(f=this.canvas2D.width/2)*i-(p=this.canvas2D.height/2)*n,n=f*n+p*i,o=r.length+1;(w=this.canvas2D.getContext("2d")).rotate(-45*Math.PI/180),w.font="bold 48px Arial",w.textAlign="center",w.fillStyle="#137FE2",w.globalAlpha=.2,w.fillText(r,a,n),w.rotate(45*Math.PI/180),w.globalAlpha=1}else{var r=e.text?r.substr(0,30):r.substr(0,20),s=void 0===e.interval_v||null===e.interval_v?100:e.interval_v,l=void 0===e.interval_h||null===e.interval_h?150:e.interval_h,d=void 0===e.xstart||null===e.xstart?16:e.xstart,c=void 0===e.ystart||null===e.ystart?this.canvas2D.height-85:this.canvas2D.height-e.ystart,h=0,u=0,i=void 0===e.angle||null===e.angle?25:e.angle,p=(e.imageSrc&&(u=0<e.imageSize?(a=e.waterImg.height/e.waterImg.width,h=e.imageSize*a,e.imageSize):(h=e.waterImg.height,e.waterImg.width),c-=h,i=void 0===e.angle||null===e.angle?0:e.angle),0),f=0,m=c,g=void 0===e.transparent||null===e.transparent?.1:e.transparent,v=e.font||"Arial",y=e.bold?"bold":"",A=e.color||"#000000",M=e.fontSize||18,E=(M*=t,void 0===e.repeat||null===e.repeat||e.repeat),w=this.canvas2D.getContext("2d"),o=(.1<i&&(c=-c,f=d*Math.cos(-i*Math.PI/180)-c*Math.sin(-i*Math.PI/180),c=d*Math.sin(-i*Math.PI/180)+c*Math.cos(-i*Math.PI/180),d=f,m=-c),r.length+1);if(E&&(e.imageSrc?(d+=20*-(l+u),m+=40*(s+h)):(d+=20*-(l+o*M),m+=40*(s+M))),.1<i&&w.rotate(-i*Math.PI/180),e.imageSrc)for(f=0;d<this.canvas2D.width&&(c=m,E||0==f);d=d+u+l,f++)for(p=0;10*-(s+h)<c&&(E||0==p);c=c-s-h,p++)w.globalAlpha=g,w.drawImage(e.waterImg,d,c,u,h),w.globalAlpha=1;else for(f=0;d<this.canvas2D.width&&(c=m,E||0==f);d+=l,f++){for(p=0;10*-(s+M)<c&&(E||0==p);c=c-s-M,p++)w.font=y+" "+M+"px "+v,w.textAlign="left",w.fillStyle=A,w.globalAlpha=g,w.fillText(r,d,c),w.globalAlpha=1;d+=o*M}.1<i&&w.rotate(i*Math.PI/180)}},E.setOrthographicCameraInfo=function(e){this.camera.setOrthographicCameraInfo(e),this.cameraControl.updateViewBoxCamDir(),this.renderAllViews()},E.setPerspectiveCameraInfo=function(e){this.camera.setPerspectiveCameraInfo(e),this.cameraControl.updateViewBoxCamDir(),this.renderAllViews()},E.getObjectWorldMatrixAndMatrixByIds=(ve=new THREE.Matrix4D,function(e,t){void 0===t&&(t=[]);for(var r={},i=0;i<e.length;i++){var n=this.ndsModel.getModelById(void 0!==t[i]?t[i]:0),a=n.objectidTouuid[e[i]],a=n.getBodyNodeFromUuid(a),o=n.calculateNodeWorldMatrix4D(a);0<n.ModelUpMatrix4.length&&(ve.fromArray(n.ModelUpMatrix4),ve.invert(),o.premultiply(ve));n={matrix:a.matrix||[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],worldMatrix:o.toArray()};r[e[i]]=n}return r}),E.setObjectWorldMatrixById=(ye=new THREE.Matrix4D,Ae=new THREE.Matrix4D,Me=new THREE.Matrix4D,Ee=new THREE.Matrix4D,function(e,t,r){var r=this.ndsModel.getModelById(r=void 0===r?0:r),e=r.objectidTouuid[e],e=L.getBodyNodeFromUuid(e),i=e.parent?r.calculateNodeWorldMatrix(e.parent):new THREE.Matrix4D;ye.getInverse(i),Ae.fromArray(t),0<this.ndsModel.ModelUpMatrix4.length&&(Ee.fromArray(this.ndsModel.ModelUpMatrix4),Ae.premultiply(Ee)),Me=Ae.premultiply(ye),r.updateNodeMatrix(e.uuid,Me.toArray()),De.MatrixChange=!0,this.renderAllViews()}),E.setObjectMatrixById=function(e,t,r){r=this.ndsModel.getModelById(r=void 0===r?0:r);r&&(e=r.objectidTouuid[e],r.updateNodeMatrix(e,t),De.MatrixChange=!0,this.renderAllViews())},E.hasModelPersistID=function(){return!!this.HasPersistentId},E.selectChangeHoleByID=function(e,t){var r,i;if(L.hasBrepFile()&&!L.hasBrepInfo())r=function(){L.removeEventListener("BrepInfoEvent",i)},i=function(){r(),L.selectChangeHoleByID(e,t),L.render()},L.loadBrepInfo(!1),L.addEventListener("BrepInfoEvent",i);else{for(var n,a,o=0;o<e.length;o++)n=e[o],a=t,L.hasBrepInfo()&&L.createLineAndFaceFrombrep(n,a,!1);L.renderAllViews()}},E.selectChangeObjectByPersistID=function(e,t){var r,i;if(L.hasBrepFile()&&!L.hasBrepInfo())r=function(){L.removeEventListener("BrepInfoEvent",i)},i=function(){r(),L.selectChangeObjectByPersistID(e,t),L.render()},L.loadBrepInfo(!1),L.addEventListener("BrepInfoEvent",i);else{for(var n,a,o,s=0;s<e.length;s++)n=e[s],a=t,o=void 0,(o=L.PersistentId2uuid.get(n))?(o=L.getBodyNodeFromUuid(o),a?L.selectionManager.selectObject(o,!1,!0):L.selectionManager.deselectObject(o,!0),L.renderAllViews()):L.hasBrepInfo()&&L.createLineAndFaceFrombrep(n,a);L.renderAllViews()}},E.createLineAndFaceFrombrep=function(n,e){for(var a,o=null,s=-1,t=(new THREE.Matrix4D,0);t<this.ndsModel.activeModel.brepManager.brepInfos.edgeGroups.length;t++){var r=this.ndsModel.activeModel.brepManager.brepInfos.edgeGroups[t];Object.entries(r).forEach(function(e){var t=e[0],r=e[1];if(!o&&("geomUUID"==t&&(a=r),r.persist)&&0<r.persist.length)for(var i=0;i<r.persist.length;i++)if(r.persist[i]==n){s=i,o=r;break}})}if(o){var i=this.additionalObjectsScene.getObjectByProperty("uuid",n);if(i)!e&&this.additionalObjectsScene&&this.additionalObjectsScene.remove(i);else if(e){var i=[0,1],l=(i[0]=o.indexRanges[2*s],i[1]=o.indexRanges[2*s+1],function(e,t){var r,e=L.ndsModel.geomManager.getGeomFromUuid(e,0),t=t.concat();if(t[0]+=e.drawRange.start/2,t[1]+=e.drawRange.start/2,e.isBufferGeometry){var i=t[1]-t[0]+1,n=e.index,a=e.attributes.position.array,o=new Float32Array(6*i),e=t[0],i=t[1];if(null!=n){for(var s=n.array,l=0,d=e,c=i;d<=c;d++,l+=1){var h=s[2*d],u=s[2*d+1],p=new THREE.Vector3,f=new THREE.Vector3;p.fromArray(a,3*h),f.fromArray(a,3*u),o[6*l]=p.x,o[6*l+1]=p.y,o[6*l+2]=p.z,o[6*l+3]=f.x,o[6*l+4]=f.y,o[6*l+5]=f.z,f=p=null}t=De.SelectedEdgeMaterial1,n=new Xe,e=(n.setPositions(o),new qe({linewidth:t.linewidth,opacity:t.opacity,color:t.color,depthTest:!1,depthWrite:!1})),i=L.renderer.getPixelRatio(),t=L.renderer.domElement.width/i,i=L.renderer.domElement.height/i;e.resolution.set(t,i),r=new Ke(n,e)}}return r}(a,i));if(l){var d=[];this.ndsModel.meshManager.lineSegGeomUuid.forEach(function(e,t){e==a&&d.push(t)}),(g=new THREE.Group).uuid=n,g.name="persist";for(var c=0;c<d.length;c++){var h=l.clone(),u=this.ndsModel.meshManager.lineSegBodyNodes[d[c]];h.applyMatrix(u.worldMatrix),h.updateMatrixWorld(!0),g.add(h)}this.additionalObjectsScene&&this.additionalObjectsScene.add(g)}}}else{for(var p=0;p<this.ndsModel.activeModel.brepManager.brepInfos.faceGroups.length;p++){var f=this.ndsModel.activeModel.brepManager.brepInfos.faceGroups[p];Object.entries(f).forEach(function(e){var t=e[0],r=e[1];if(!o&&("geomUUID"==t&&(a=r),r.persist)&&0<r.persist.length)for(var i=0;i<r.persist.length;i++)if(r.persist[i]==n){s=i,o=r;break}})}if(o){i=this.additionalObjectsScene.getObjectByProperty("uuid",n);if(i)!e&&this.additionalObjectsScene&&this.additionalObjectsScene.remove(i);else if(e){var i=[0,1],m=(i[0]=o.triIndexRanges[2*s],i[1]=o.triIndexRanges[2*s+1],function(e,t){e=L.ndsModel.geomManager.getGeomFromUuid(e,0),t=t.concat();if(t[0]+=e.drawRange.start/3,t[1]+=e.drawRange.start/3,e.isBufferGeometry){for(var r=e.index,i=e.attributes.position,e=t[1]-t[0]+1,n=new Float32Array(9*e),a=0,o=t[0],s=t[1];o<=s;o++,a+=1){var l=3*o,d=r.getX(l),c=r.getX(1+l),l=r.getX(2+l),h=new THREE.Vector3,u=new THREE.Vector3,p=new THREE.Vector3;h.fromBufferAttribute(i,d),u.fromBufferAttribute(i,c),p.fromBufferAttribute(i,l),n[9*a]=h.x,n[9*a+1]=h.y,n[9*a+2]=h.z,n[9*a+3]=u.x,n[9*a+4]=u.y,n[9*a+5]=u.z,n[9*a+6]=p.x,n[9*a+7]=p.y,n[9*a+8]=p.z,p=u=h=null}var e=new THREE.BufferGeometry,t=(e.addAttribute("position",new THREE.BufferAttribute(n,3)),new THREE.MeshBasicMaterial({opacity:.8,color:979390,side:THREE.DoubleSide,transparent:!0,depthTest:!1,depthWrite:!1})),f=new THREE.Mesh(e,t)}return f}(a,i));if(m){var g,v=[];this.ndsModel.meshManager.geomUuid.forEach(function(e,t){e==a&&v.push(t)}),(g=new THREE.Group).uuid=n,g.name="persist";for(var y=0;y<v.length;y++){var A=m.clone(),M=this.ndsModel.meshManager.bodyNodes[v[y]];A.applyMatrix(M.worldMatrix),A.updateMatrixWorld(!0),g.add(A)}this.additionalObjectsScene&&this.additionalObjectsScene.add(g)}}}}},E.zoomCameraByDelta=function(e){var t=this.container.getBoundingClientRect(),t={offsetX:t.width/2,offsetY:t.height/2,clientX:t.width/2+t.left,clientY:t.height/2+t.height},r=this.controls.getOperator();this.cameraControl.zoomByMouse(r,new THREE.Vector3(0,0,30/e),t,!0)},E.panCamera=function(e,t){this.controls.getOperator().pan(new THREE.Vector3(e,t,0),!0)},E.rotateCam=function(e,t){var r=this.controls.getBoundingBox().getCenter(),i=new THREE.Vector3,n=(i.subVectors(this.camera.position,r),null);"x"==e.toLowerCase()?n=new THREE.Vector3(1,0,0):"z"==e.toLowerCase()?n=new THREE.Vector3(0,0,1):"y"==e.toLowerCase()&&(n=new THREE.Vector3(0,1,0)),n&&((e=new THREE.Quaternion).setFromAxisAngle(n,t*Math.PI/180),i.applyQuaternion(e),(n=new THREE.Vector3).subVectors(this.camera.getCameraTarget(),r),n.applyQuaternion(e),this.camera.getCameraTarget().addVectors(r,n),this.camera.up.applyQuaternion(e),this.camera.position.addVectors(r,i),this.camera.setCameraTarget(this.camera.getCameraTarget()),this.render(),this.viewBox)&&L.cameraControl.updateViewBoxCamQuaternion(e)},_.language?Pe.setLanguage(_.language,E.serverUrl,E.is2DModel):Pe.setLanguage(navigator.language,E.serverUrl,E.is2DModel),q&&(E.Optoolbar=new OpToolbar(E,_)),new fn(E,_.loadingWaiterColor),new Xr(E,_.loadingCovererColor),De.enableSelect&&E.enableInternalRMB&&new ViewMenu(E),L.bHasLoadingStater&&(E.stater=new Stater(E),E.stater.addEventListener("cancel",E.stopReadingModel)),t.addEventListener("render",E.render),t.addEventListener("event",E.onControlsEvent),window.addEventListener("keydown",function(e){De.enableBroadcast&&!De.broadcastMajor||32==e.keyCode&&L.toggleAutoRotation()},!1),E.canvas2D?(E.canvas2D.addEventListener("contextmenu",function(e){e.preventDefault()},!1),Pe.isMobileDevice()?(E.canvas2D.addEventListener("touchstart",E.onMouseDown,!1),E.canvas2D.addEventListener("touchend",E.onMouseUp,!1)):(E.canvas2D.addEventListener("mousedown",E.onMouseDown,!1),E.canvas2D.addEventListener("mouseup",E.onMouseUp,!1))):(i.addEventListener("contextmenu",function(e){e.preventDefault()},!1),Pe.isMobileDevice()?(i.addEventListener("touchstart",E.onMouseDown,!1),i.addEventListener("touchend",E.onMouseUp,!1)):(i.addEventListener("mousedown",E.onMouseDown,!1),i.addEventListener("mouseup",E.onMouseUp,!1))),window.addEventListener("resize",E.onResize,!1),E.onWindowResize(),de(),document.addEventListener("fullscreenchange",xe),document.addEventListener("webkitfullscreenchange",xe),document.addEventListener("mozfullscreenchange",xe),document.addEventListener("MSFullscreenChange",xe),void 0!==_.envMapTextures&&(E.setEnvMapTextures(_.envMapTextures),E.updateEnvMapBlur()),void 0!==_.backGroundImage&&E.setBackGroundImage(_.backGroundImage),E.addEventListener("updateProgress",E.onUpdateProgress,!1),E.addEventListener("windowResize",E.onWindowResize,!1),De.isVRmodel&&(n=He.getExtension("WebVRExtension"))&&n.load(E),De.isARmodel&&(t=He.getExtension("WebARExtension"))&&t.load(E,De.supportAR),E.initViewer=function(e){void 0===e&&(e=!1),E.inited&&!e||(E.oldenableBroadcast=De.enableBroadcast,De.enableBroadcast=!1,E.SDFMaker&&E.SDFMaker.clear(),E.inited=!0,E.modelneedLoad=!0,E.ndsModelObjectTreeLoaded=!1,E.ndsModelBvhLoaded=!1,E.ndsModelPMILoaded=!1,E.allLoaded=!1,De.ScenarioEditorid=-1,E.operators.set("OpOrbit",function(e){return new ui(e)}),E.operators.set("OpPan",function(e){return new pi(e)}),E.operators.set("OpZoom",function(e){return new fi(e)}),E.operators.set("OpZoomWindow",function(e){return new mi(e)}),E.operators.set("OpSelectWindow",function(e){return new gi(e)}),E.operators.set("OpSelectLasso",function(e){return new Le(e)}),E.operators.set("OpBall",function(e){return new Oe(e)}),e="",L.serverUrl&&(e=L.serverUrl),E.cursors.set("OpOrbit",{objectUrl:"url('data:image/vnd.microsoft.icon;base64,AAACAAEAGBgAAAAAAACICQAAFgAAACgAAAAYAAAAMAAAAAEAIAAAAAAAYAkAABMLAAATCwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABIAAAAsQAAAEgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABYRERH/sbGx/wAAALEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEQcHB/9/f3///////wAAAP8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAdCAgI/3p6ev///////////wAAAP8AAADWAAAAqAAAAHwAAABKAAAAEgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHQAAAHQEBAT/AAAABAAAABQUFBT/hoaG/////////////////+Hh4f/W1tb/qKio/3x8fP9KSkr/EhIS/wAAAHQAAAAdAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABEHR0d/3R0dP9nZ2f/AAAAdgAAABQUFBT/sbGx//////////////////z8/P//////////////////////x8fH/3R0dP8dHR3/AAAARAAAAAAAAAAAAAAAAAAAADQ0NDT/ra2t///////f39//VFRU/wQEBP8BAQH/MDAw/7q6uv///////////4iIiP9mZmb/g4OD/7W1tf/t7e3///////////+tra3/NDQ0/wAAADQAAAAAAAAAAAAAAJ2dnZ3//////+Li4v+Li4v/MTEx/wAAADEAAAABAAAAUScnJ/+5ubn//////wAAAP8AAABmAAAAgwAAALU4ODj/i4uL/+Li4v//////nZ2d/wAAAJ0AAAAAAAAAAAAAAO/v7+///////2JiYv8AAACLAAAAOAAAAAEAAAAJAAAAAAAAAFAsLCz/uLi4/wAAALgAAAAAAAAAAAAAAAAAAAA4AAAAi2JiYv//////7+/v/wAAAO8AAAAAAAAAAAAAAJ2dnZ3//////+Li4v+Li4v/ODg4/wEBAf8JCQn/AAAAVwAAADMAAABPCwsL/wAAAE8AAABXAAAAgwAAALU4ODj/i4uL/+Li4v//////nZ2d/wAAAJ0AAAAAAAAAAAAAADQ0NDT/ra2t////////////7e3t/7W1tf+Dg4P/V1dX/zMzM/8YGBj/FxcX/zMzM/9XV1f/g4OD/7W1tf/t7e3///////////+tra3/NDQ0/wAAADQAAAAAAAAAAAAAAAAAAABEHR0d/3R0dP/Hx8f/////////////////////////////////////////////////////////////////x8fH/3R0dP8dHR3/AAAARAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHQAAAHQSEhL/SkpK/3x8fP+oqKj/zMzM/+jo6P/5+fn/+fn5/+jo6P/MzMz/qKio/3x8fP9KSkr/EhIS/wAAAHQAAAAdAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAASAAAASgAAAHwAAACoAAAAzAAAAOgAAAD5AAAA+QAAAOgAAADMAAAAqAAAAHwAAABKAAAAEgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACNAAAA9gAAAI0AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD29vb2/0hISP8AAACQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD///////n5+f9OTk7/AAAAkAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD////////////5+fn/Tk5O/wAAAJAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/////////////////+fn5/wAAAPkAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACWAAAA/wAAAP8AAAD/AAAA+QAAAJAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD///8x////O////1D/8f9y/+H/Rv/B/3P9gA9k8AADXOAAAVzAAABnwAAAIMAhwGXAAAB4wAAAXOAAAWPwAANt/AAPVP///3Qf//87D///cAf//28D//9cA///XAP//2c='), wait",url:"url('"+e+"img/cursorOrbit.ico'), wait"}),E.cursors.set("btnOrbit",E.cursors.get("OpOrbit")),E.cursors.set("OpPan",{objectUrl:"url('data:image/vnd.microsoft.icon;base64,AAACAAEAGBgAAAAAAACICQAAFgAAACgAAAAYAAAAMAAAAAEAIAAAAAAAYAkAABMLAAATCwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA0NDUsNDA2zMjEy31lZWfNQUFDrKysrwwkJCZAMDAxgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAPDw8ZDQ0NoVxcXfbLy8v/4ODh//b29//y8fL/3Nzc/8nJyf98e3z/FRUWuQ0NDSYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAkJCT0mJSbSlpaW//7+/v//////////////////////////////////////uLe4/zc2N+MNDQ00AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUFBQFCgoJcD4+P/HMzM3//////////////////////////////////////////////////////8/Pz/8kJCTCEREREwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA8PD0oTExOPcXFy//Ly8v//////8/Pz//v7+/////////////////////////////////////////////////+AgID/BAQEQQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwcHLpNTU36+vr6/+fn5/99e33/Ly8v83d3eP3///////////////////////////////////////////////+bm5v/CQkJXQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABISElIbGxuaZGRk/zIyMusODg6GCQkJXVFRUvj8/Pz///////////////////////////////////////////+dnZ3/DAwMaAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUFBQKBwcHPA8PDykAAAAADg4OUnBvcP7///////////////////////////////////////////////+BgYH/BAQEQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFhYWqcPDw////////////////////////////////////////////+Xl5f8tLS2+Dw8PDgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQEBA4Pz8/6/////+7u7z/1dXW///////4+Pj//////////////////////6Ojo/8HBwdwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABUVFQELCwuTsLCw//39/v+Dg4T/19fX/+Li4v+ZmJr//////9vb2/+6urv//////zMzM94SEhIUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAwMDCc7Ozzx8fDx/8zMzf+SkZP//////5qam/+np6f//////5mYm//Hx8j/ubm5/xEREZAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAkJCWqSkpL//////5iXmf/P0ND/8/Pz/3h3ef/o6Oj/7e3u/3Fxc///////Tk5O+woKChwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADg4OBy0tLeri4eL/9/f3/29tcP//////qqqr/5qZmv//////mZma/8zMzf/Kysr/HR0engAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEBAQByMjI8+mpqb/mZiZ/8LCw//6+vr/fn6A/9LS0v/8/P3/a2pu//////92dnb4BAQEOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQUFBwHBweAGhoa5f/////Kysr/i4qM//////+vr7D/MC8x/3x8fP8mJiawERERCAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFhYWok5OTvY0NDT1Pj4++aGhof86OjvNCQkJTAgICGATExMnAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACNAAAA9gAAAI0AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFRUVCAoKCg8NDQ0KEBEQKxQUFH4SEhIpAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD29vb2/0hISP8AAACQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD///////n5+f9OTk7/AAAAkAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD////////////5+fn/Tk5O/wAAAJAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/////////////////+fn5/wAAAPkAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACWAAAA/wAAAP8AAAD/AAAA+QAAAJAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD///8x/+AfO/+AB1D/AANy/AABRvgAAXP4AAFk+AABXPxAAVz/wAFn/4ADIP8AA2X/AAd4/wAHXP4AD2P+AA9t/wAPVP/AH3QfwP87D///cAf//28D//9cA///XAP//2c='), wait",url:"url('"+e+"img/cursorPan.ico'), wait"}),E.cursors.set("btnPan",E.cursors.get("OpPan")),E.cursors.set("OpZoom",{objectUrl:"url('data:image/vnd.microsoft.icon;base64,AAACAAEAGBgAAAAAAACICQAAFgAAACgAAAAYAAAAMAAAAAEAIAAAAAAAYAkAABMLAAATCwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAANQAAAJ4AAACeAAAANQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA5CQkJ/56env+enp7/CQkJ/wAAADkAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD8JCQn/oqKi////////////oqKi/wkJCf8AAAA/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAATQsLC/+oqKj//////////////////////6ioqP8LCwv/AAAATQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABYDg4O/7a2tv////////////////////////////////+2trb/Dg4O/wAAAFgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGQMDAz/wcHB////////////////////////////////////////////wcHB/wwMDP8AAABkAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAYxoaGv/Nzc3//////////////////////////////////////////////////////83Nzf8aGhr/AAAAYwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAoKCgo/8zMzP/////////////////////////////////////////////////////////////////MzMz/KCgo/wAAACgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA7Ozs7/2lpaf9qamr/gICA/76+vv////////////////////////////////++vr7/gICA/2pqav9paWn/Ozs7/wAAADsAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOwAAAGkAAABqAAAAgE5OTv////////////////////////////////9OTk7/AAAAgAAAAGoAAABpAAAAOwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAJCQkJP////////////////////////////////8kJCT/AAAAJAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgICAv/29vb///////////////////////b29v8CAgL/AAAAAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMzMzMz//////////////////////8zMzP8AAADMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAJ2dnZ3//////////////////////52dnf8AAACdAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGhoaGj//////////////////////2hoaP8AAABoAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABgAAADs7Ozv//////////////////////zs7O/8AAAA7AAAABgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGBgYG/wAAAGQAAAD7+/v7////////////+/v7/wAAAPsAAABkBgYG/wAAAAYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAQEBA/2RkZP9RUVH/8vLy////////////8vLy/1FRUf9kZGT/QEBA/wAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACNAAAA9gAAAI0AAAAAAAAAEQAAAAAAAAAmJiYm/6mpqf////////////////////////////////+pqan/JiYm/wAAACYAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD29vb2/0hISP8AAACQAAAAAAAAABEAAAAAAAAAQAAAAKlZWVn/6enp////////////6enp/1lZWf8AAACpAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD///////n5+f9OTk7/AAAAkAAAAAAAAAADAAAAAAAAAAAAAACAJycn/729vf+9vb3/Jycn/wAAAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD////////////5+fn/Tk5O/wAAAJAAAAAAAAAAAAAAAAAAAAAAAAAAVAAAAL0AAAC9AAAAVAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/////////////////+fn5/wAAAPkAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACWAAAA/wAAAP8AAAD/AAAA+QAAAJAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD///8x////O8A8A1CAGAFyAAAARgAAAHMPAPBkDwDwXA8A8FwPAPBnAAAAIAAAAGWAAAF4gAABXMAAA2PAAANt4AAHVOAAB3QQAA87CBgPcAQ8H28D//9cA///XAP//2c='), wait",url:"url('"+e+"img/cursorZoom.ico'), wait"}),E.cursors.set("btnZoom",E.cursors.get("OpZoom")),E.cursors.set("OpSelectWindow",{objectUrl:"url('data:image/vnd.microsoft.icon;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAABHNCSVQICAgIfAhkiAAAASlJREFUSIntkjFLA0EQhb/JBoRkoyCkFCwEm0CEU+tr/SuCYsjF2loPjP9Af4DY2ca0XoQ0AQvB/2AuiUhu1yJgcRzmFhIQzOve8HbezLyFFeZAXMSV82jXGnkF6cah5+sg8kE6WRzMRRwePC1lagAd9CxAweVR9Xigy63nvXxq6TobjMtfO2JVO482Dj3f2UBNTYy1/TzaWR5LxK8Z6CCq6SCqpesLy0AoXBrLVrr+JzMouhh8XHtvwFk+tXQAcTJYbww2jZrcWzGN0dVhXzd7bYR6FsfOMnDbYKM01vH4ZGTX3gGUJDcJhXImD+s+gOhW7wGLl+pVRRhi+fxZGMww3N92GQigmCTmNF1USt3ZZHprZndcPCrBy2OpGR0topfTN/2fBivMxTcQ8oGCNKbXHQAAAABJRU5ErkJggg==') 6 16, wait",url:"url('"+e+"img/zoomWindow.ico') 6 16, wait"}),E.cursors.set("OpZoomWindow",E.cursors.get("OpSelectWindow")),E.cursors.set("coordinate",{url:"url('img/cursorCross.ico'), crosshair"}),E.cursors.set("OpDrawGeom",{url:"url('"+e+"img/drawGeom.ico') 4 4, wait"}),E.cursors.set("OpDrawGeomPlane",{url:"url('"+e+"img/drawGeomPlane.ico') 1 1, wait"}),E.cursors.set("OpSelectLasso",{objectUrl:"url('data:image/x-icon;base64,iVBORw0KGgoAAAANSUhEUgAAABkAAAAWCAYAAAA1vze2AAAAAXNSR0IArs4c6QAAAARzQklUCAgICHwIZIgAAAFZSURBVEiJvZTNcYMwEIXfalxIcAUpQDOITtIAnnQAbgGayQ0xQx3gMnLy8wGJyMQCkpi8o37227faFXQ9FLoeDHaUAmlANroeiv0gXmSpq557wBRE7N3KDjAFoH2480SYWj3xBJgAgK56ztZtUMYWALo8sYhI14NZ2veQBoAZV6Ts8uS8lJmuBwOymO4Adun+YR5gFVD1DUhA5NzlSfYggUJXPSGSeXfK0a3PYhUgYrvTMYuVp8uTM0Qy5xRfkLHudsmFrocCIotnApB1dwwQlms+L/cAA7LsTkdZA8zipQDsISBHIQDStVIuaX1OvEjzo8jk1GXfuiuiFkDpHx5AG3v4qb0D51udpEJcqOTisnw4/Q7QzBtksxMKjBCvIN9cwAKjw9SV0oC04Xx4be6W6e+68h2CTyr5kCtfwu8nVsLtLXkP9GWJDmWo7d31B/0OMroot7j4N90ABODAfc3bpdIAAAAASUVORK5CYII='), wait",url:"url('"+e+"img/selectLasso.ico') 6 16, wait"}),L.leafPMIObjects=[],L.PMINDSBodys=[]),E.modelRequestor&&E.modelRequestor.name==E.currentRequestorName||(e={loadingManager:O,onLoadCallback:ue,onRenderSettingCallback:pe,onBufferChunkCallback:fe,onLoadErrorCallback:me},E.modelRequestor=E.modelRequestorManager.createModelRequestor(E.currentRequestorName,e),E.modelRequestor)||(E.isDisaModel?E.modelRequestor=new ha(E,e):E.modelRequestor=new Ft(E,e),E.modelRequestorManager.registerModelRequestor(E.modelRequestor))},_.CustomExtensions)for(var be=0;be<_.CustomExtensions.length;++be){var Be,Ie,p=_.CustomExtensions[be];_.singleHTML&&(p=He.getExtension(p.name))&&(p.load(L),"ClipExtension"==p.name&&(Be=void 0===_.clipPlaneShaderVersion?1:_.clipPlaneShaderVersion,Ie=void 0!==_.showSectionPlane&&_.showSectionPlane,p.initClipExtension)&&p.initClipExtension(Be,Ie),"MeasureExtension"!=p.name&&"Measure2DPCExtension"!=p.name&&"Measure2DAPPExtension"!=p.name||(L.__globalMeasureExtension=p))}return E}var e,t,r;return t=Te,(e=Se).prototype=Object.create(t.prototype),$a(e.prototype.constructor=e,t),e=Se,(t=[{key:"brepInfo",get:function(){return this.ndsModel.activeModel.brepManager.brepInfo}}])&&Ja(e.prototype,t),r&&Ja(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}(THREE.EventDispatcher)}],i={},n.m=r,n.c=i,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)n.d(r,i,function(e){return t[e]}.bind(null,i));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=20);function n(e){var t;return(i[e]||(t=i[e]={i:e,l:!1,exports:{}},r[e].call(t.exports,t,t.exports,n),t.l=!0,t)).exports}var r,i});