!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.NDSTextEx=t():e.NDSTextEx=t()}(window,function(){return r=[function(e,t,r){r.r(t);console.log("NDS ExtensionFramework V0.1");let n={FLAG_ENABLE_NODE_TRANSFORM:NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM,FLAG_ENABLE_NODE_STOREVIEW:NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM<<1,FLAG_ENABLE_NODE_CAMERA2D:NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM<<2,FLAG_ENABLE_NODE_BLOCK:NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM<<3,FLAG_ENABLE_NODE_TEXT:NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM<<4,FLAG_ENABLE_NODE_BROADCAST:NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM<<5};class i extends NDSWebViewer.Extension{constructor(){super()}onLoad(e){}onInitLights(){}update(e){}setFlags(e){super.setFlags(e)}onNdsModelPrepareForRendering(e){}onBeforeNdsModelUpdate(e,t){}onAfterNdsModelUpdate(e,t){}onBeforeNdsModelSetRender(e,t){}onAfterNdsModelSetRender(e,t){}onBeforeNdsMeshRender(e,t){}onBeforeScreenCapture(e){}onAfterScreenCapture(){}onBeforeChangeBackGroundColor(e){}onAfterChangeBackGroundColor(e){}onAfterWindowResize(e,t,r){}onSetCaptureView(e,t){}getExtensionWithFlags(e){return NDSWebViewer.ExtensionManager.getExtensionWithFlags(e)}resetToDefault(){}needDisableInputEvent(){}getStoreInfo(e){throw this.name+" Extesion did not implement method 'getStoreInfo' "}setStoreInfo(e){throw this.name+" Extesion did not implement method 'setStoreInfo' "}getBodyTransform(e){return new THREE.Matrix4}getBodyNodeTranslate(e){return new THREE.Vector3(0,0,0)}onAfterSetBroadcastInfo(e){}onAfterGetBroadcastInfo(e){}}class L{static getModel(e){return e.ndsModel}static getModelId(e){return e.ndsModel.id}static getUUID(e){return e.uuid}static getObjectId(e){return e.objectid}static getId(e){return e.id}static getBodyNodeMaterial(e){var t=e.getMaterialBodyNodeUUid();return t&&e.useBodyNodeMaterial?e.ndsModel.bodyNodeUUidToMaterial[t]:null}static setBodyNodeMaterial(e,t){e.ndsModel.bodyNodeUUidToMaterial[e.uuid]=t,e.useBodyNodeMaterial=!!t}static getUserMaterial(e){return e.getUserMaterial()}static setUserMaterial(e,t){e.setUserMaterial(t)}static getBoundingBox(e){var t=new THREE.Box3;return e.getBoundingBox(t,!0)}static isLeafBodyNode(e){return!!e.leafBodyAttri}static isPartBodyNode(e){return"Part"===e.type}static getLeafBodyNodes(e){return e.ndsModel.getLeafBodies(e)}static getMeshesInLeafBodyNode(e){return e.leafBodyAttri?e.leafBodyAttri.bodyMeshIds:[]}static getLinesInLeafBodyNode(e){return e.leafBodyAttri?e.leafBodyAttri.bodyLineSegIds:[]}static getTextsInLeafBodyNode(e){return e.leafBodyAttri?e.leafBodyAttri.bodyTextIds:[]}static getMatrixLocal(e){return e.matrix}static getMatrixWorld(e){return e.worldMatrix}static setMatrixWorld(e,t){e.setMatrixWorld(t)}static applyTransform(e,t=null){e.applyTransform(t)}static updateMatrixWorld(e,t=!1){e.updateMatrixWorld(t,!0)}static hide(e){e.hide(e)}static show(e){e.show()}static isPreSelected(e){return e.isPreSelected()}static isSelected(e){return e.isSelected()}static isTransparent(e){return e.isTransparent()}static isHidden(e){return e.isHidden()}static isIsolated(e){return e.isIsolated()}static getRenderMode(e){switch(e.renderMode){case 3:return"wireframe";case 4:return"hiddenLineRemove";case 5:return"hiddenLineVisible"}return""}static getBodyNodeTranslate(e,r){var i=new THREE.Vector3(0,0,0),o=e.getExtensionWithFlags(n.FLAG_ENABLE_NODE_TRANSFORM);for(let e=0,t=o.length;e<t;++e)i.add(o[e].getBodyNodeTranslate(r));return i}static updateNodeMatrix(e,t){e.ndsModel.updateNodeMatrix(e.uuid,t,e.getModel().id)}static hideBody(e){e.ndsModel.hideBody(e)}static showBody(e){e.ndsModel.showBody(e)}}class j{static getGeomBBox(e){return e.boundingBox}static getGeomText(e){return e.text}static getGeomTextPosition(e){return e.position}static getGeomTextQuaternion(e){return e.quaternion}static getGeomTextNormalMatrix(e){return e.normalMatrix}static getGeomTextIndex(e){return e.textIndex}static getGeomTextSubInd(e){return e.subInd}static getGeomTextMirrorX(e){return e.mirrorX}static getGeomTextMirrorY(e){return e.mirrorY}static getGeomTextCharsWH(e){return e.characterBoxs}static getGeomTextViewBox(e){var t;return e.viewBox?(t=new THREE.Vector3(e.viewBox.min2.x,e.viewBox.min2.y,0),e=new THREE.Vector3(e.viewBox.max2.x,e.viewBox.max2.y,0),new THREE.Box3(t,e)):null}}class o{constructor(e){this.__coreView__=e}addEventListener(e,t){this.__coreView__.addEventListener(e,t)}hasEventListener(e,t){return this.__coreView__.hasEventListener(e,t)}removeEventListener(e,t){this.__coreView__.removeEventListener(e,t)}dispatchEvent(e){this.__coreView__.dispatchEvent(e)}getPixelRatio(){return this.__coreView__.renderer.getPixelRatio()}switchRotateCenterBySelection(){this.__coreView__.switchRotateCenterBySelection()}setDefaultEnvMap(e){e&&(this.__coreView__.hasPbrMaterial=!0,this.__coreView__.setDefaultEnvMap=()=>{this.__coreView__.setEnvMapEnabled(!0),this.__coreView__.defaultEnvMapTexture=e,this.__coreView__.updateEnvMap(this.__coreView__.defaultEnvMapTexture)},this.__coreView__.setDefaultEnvMap())}getBackgroundState(){return this.__coreView__.exchangeBackImage?{type:this.__coreView__.exchangeBackImage.type,value:this.__coreView__.exchangeBackImage.value}:void 0}setBackgroundState(e,t){"Image"===e?(this.__coreView__.setEnvMapTextures(null),this.__coreView__.setBackGroundImage(t)):"EnvMap"===e?this.__coreView__.setEnvMapTextures(t):"Color"===e&&(this.__coreView__.setEnvMapTextures(null),this.__coreView__.setBackGroundImage(null),this.__coreView__.setBackGroundColor(t))}removeAllLights(){this.__coreView__.lights.length=0}getLight(e){return this.__coreView__.lights[e]}setLight(e,t){this.__coreView__.lights[e]=t}getViewBox(){return this.__coreView__.viewBox}toggleAutoRotation(e){this.__coreView__.toggleAutoRotation(e)}randColor(){return this.__coreView__.materialsSetting.randColor()}getBoundingBox(e=!1){e=this.__coreView__.ndsModel.getTotalBodyBoundingBox(null,e);return e.isEmpty()?this.__coreView__.modelRootObject.boundingBox:e}getModelTree(){return this.__coreView__.getModelTree()}getModelTotalTree(){return this.__coreView__.getModelTotalTree()}getModelCount(){return this.__coreView__.ndsModel.models.length}setActiveModel(e){this.__coreView__.ndsModel.setActiveModel(e)}setActiveModelByModelId(t){let r=-1;for(let e=0;e<this.__coreView__.ndsModel.models.length;++e)if(this.__coreView__.ndsModel.models[e].id===t){r=e;break}this.setActiveModel(r)}getActiveModel(){return this.__coreView__.ndsModel.getActiveModel()}getModelById(e){return this.__coreView__.ndsModel.getModelById(e)}getModelIndexByModelId(t){var r=this.__coreView__.ndsModel;for(let e=0;e<r.models.length;++e)if(r.models[e].id===t)return e}getModelByIndex(e){return this.__coreView__.ndsModel.models[e]}registOperator(e,t){this.__coreView__.registOperator(e,t)}setOperatorByID(e){this.__coreView__.setOperatorByID(e)}getCurrentOperator(){return this.__coreView__.controls.getOperator()}getCurrentOperatorID(){return this.__coreView__.getCurrentOperatorID()}setOperator(e){this.__coreView__.setOperator(e)}registCursor(e,t,r){this.__coreView__.registCursor(e,t,r)}hideSelectedObjects(){this.__coreView__.hideSelectedObjects()}getViewControlBoundingBox(){return this.__coreView__.controls.getBoundingBox()}setViewControlBoundingBox(e,t){this.__coreView__.controls.setBoundingBox(e,t)}setViewBoxDir(e){this.__coreView__.look({smoothTranslation:!1,useOrginal:!1,type:e})}getCamera(){return this.__coreView__.camera}setCameraControlBoundingBoxCenter(e){this.__coreView__.cameraControl.setBoundingBoxCenter(e)}setCameraControlBounding(e,t){this.__coreView__.cameraControl.setBoundingBox(e,t)}getRotateCenter(){return this.__coreView__.cameraControl.getRotateCenter()}setRotateCenter(e){this.__coreView__.cameraControl.setRotateCenter(e)}rotateToPlane(e){this.__coreView__.cameraControl.rotateToPlane(e)}getViewLockedState(){return this.__coreView__.cameraControl.isViewLockedBySingleBody}setViewLockedState(e){this.__coreView__.cameraControl.isViewLockedBySingleBody=e}getCameraInfo(){return this.__coreView__.cameraControl.getCameraInfo()}adjustNearAndFar(){this.__coreView__.cameraControl.adjustNearAndFar()}updateViewBoxCamDir(){this.__coreView__.cameraControl.updateViewBoxCamDir()}startSmoothTranslation(e){this.__coreView__.cameraControl.startSmoothTranslation(e)}zoomExtents(e,t,r){this.__coreView__.cameraControl.zoomExtents(e,t,r)}setCameraInfo(e,t){this.__coreView__.cameraControl.setCameraInfo(e,t)}getOrginalCameraInfo(){return(this.__coreView__.viewManager||this.__coreView__.camera).getOrginalCameraInfo()}setOrginalCameraInfo(e,t,r){this.__coreView__.camera.setOrginalCameraInfo({center:e,up:t,position:r})}toPerspectiveCamera(){this.__coreView__.toPerspectiveCamera()}toOrthographicCamera(){this.__coreView__.toOrthographicCamera()}updateGroundTransform(e,t,r){return this.__coreView__.groundShadow.updateGroundTransform(e,t,r)}isRendererContainsClipPlanes(){return 0<this.__coreView__.renderer.clippingPlanes.length}getCanvas2D(){return this.__coreView__.canvas2D}getCanvas3D(){return this.__coreView__.canvas3D}getContainer(){return this.__coreView__.container}getRenderDomElement(){return this.__coreView__.renderer.domElement}getAdditionalObjectsScene(){return this.__coreView__.additionalObjectsScene}getDispalyModelUnit(e,t){return this.__coreView__.getDispalyModelUnit(e,t)}modelCoordToClientCoord(e){return this.__coreView__.modelCoordToClientCoord(e)}clientCoordToModelCoord(e){return this.__coreView__.clientCoordToModelCoord(e)}showObject(e,t,r,i=!0){this.__coreView__.showObject(e,t,r,i)}showObjectReversed(e){this.__coreView__.showObjectReversed(e)}renderAllViews(){this.__coreView__.renderAllViews()}render(e){this.__coreView__.render(e)}setRenderMode(e,t){this.__coreView__.setRenderMode(e,t)}getRenderMode(){let e=void 0;switch(this.__coreView__.getRenderMode()){case 0:e="lighting";break;case 1:e="primarycolor";break;case 2:e="wireframe";break;case 3:e="whitemold";break;case 4:e="shadedWithEdges";break;case 5:e="shaded";break;case 6:e="hiddenLineRemove";break;case 7:e="hiddenLineVisible";break;case 8:e="transparent"}return e}getAssemblyPMIState(){return this.__coreView__.AssemblyPMIState}setAssemblyPMIState(e){this.__coreView__.AssemblyPMIState=e}getPartPMIState(){return this.__coreView__.PartPMIState}setPartPMIState(e){this.__coreView__.PartPMIState=e}getPmiVisible(){return this.__coreView__.pmiVisible}setPmiVisible(e){this.__coreView__.pmiVisible=e}setPMIObjectVisible(e,t){this.__coreView__.setPMIObjectVisible(e,t)}isPMIOccludeByModel(){return!NDSWebViewer.SETTING.StopPMIOcclusion}enablePMIOccludeByModel(e){this.__coreView__.stopPMIOcclusion(!e)}getPmiList(){return this.__coreView__.PMINDSBodys}getPMIObjectByUUID(e,t=-1){return this.__coreView__.getPMIObjectByuuid(e,t)}isPMIObjectOrSomeChildHidden(e){return this.__coreView__.isPMIObjectOrSomeChildHidden(e)}getPmiObjectTree(){return this.__coreView__.pmiObject}getSelectedPmiList(){return this.__coreView__.getPMINDSBodySelectList()}selectPMIObject(e,t=!0){this.__coreView__.selectPMIObject(e,t)}deselectPMIObject(e,t=!0){this.__coreView__.deselectPMIObject(e,t)}unmergeBodyNode(){this.__coreView__.ndsModel.unmergeNode()}mergeBodyNode(){this.__coreView__.ndsModel.mergeNode()}getAllTransparentBodies(e){return this.__coreView__.ndsModel.getAllTransparentBodies(e)}isolateBodiesOnly(e){this.__coreView__.ndsModel.isolateBodiesOnly(e)}clearTransparentModeBodiesMap(){this.__coreView__.ndsModel.transparentModeBodiesMap.clear()}unloadModelById(e){this.__coreView__.ndsModel.unloadModelById(e)}unloadModelByModelId(e){this.__coreView__.unloadModelById(e)}startLoadAnimationModel(e){var t=e.url,r=e.id,i={needsPMI:!1,needsAnimation:!1,needsSketchModel:!1,needsBRep:e.needsBRep,position:e.position,pmiVisible:this.__coreView__.pmiVisible,modelId:e.modelId};this.__coreView__.ndsModel.setGlobalObjectId&&this.__coreView__.ndsModel.setGlobalObjectId(0),e.singleHTML?this.__coreView__.loadModelFlate(t,i):this.__coreView__.loadModel(r,t,null,null,"js",null,null,null,i)}getBodyNodeFromUuid(t,e=-1){var r=null;return 0<=e?(e=this.getModelById(e))&&(e=e.getBodyNodeFromUuid(t))&&(r=e):this.__coreView__.ndsModel.models.forEach(e=>{e=e.getBodyNodeFromUuid(t);e&&(r=e)}),r}loadBrepInfo(e){this.__coreView__.loadBrepInfo(e)}clearBrepEdgesPoints(){this.__coreView__.clearBrepEdgesPoints()}enableTransparent(e){this.__coreView__.enableTransparent(e)}selectObjectByIds(e,t,r=[]){this.__coreView__.addSelectList(e,t,!1,r)}getObjectWorldMatrixAndMatrixByIds(t,r=[]){if(0===r.length)for(let e=0;e<t.length;e++)r.push(0);return this.__coreView__.getObjectWorldMatrixAndMatrixByIds(t,r)}setObjectWorldMatrixById(e,t,r=0){this.__coreView__.setObjectWorldMatrixById(e,t,r)}loadModel(e,t){this.__coreView__.loadModel("idv",e,null,null,"js",null,null,null,t)}getScreenCapture(e){this.__coreView__.getScreenCapturethumbnail(e)}computeBoundingBox(e,t,r,i){this.__coreView__.computeBoundingBox(e,t,r,i)}setGlobalModelId(e){this.__coreView__.ndsModel.setGlobalModelId(e)}isBodyAllChildHidden(e){return this.__coreView__.ndsModel.isBodyAllChildHidden(e)}enableRotation(e){this.__coreView__.enableRotation(e)}getBodyTranslate(e){return this.__coreView__.ndsModel.getBodyTranslate(e)}getBodyBoundingBox(e){return this.__coreView__.ndsModel.getBodyBoundingBox(e)}updateNodeMatrix(e,t,r){this.__coreView__.ndsModel.updateNodeMatrix(e,t,r)}}class s{constructor(e){this.__meshstate__=e}getMeshMaterial(e){return this.__meshstate__.getMeshMaterial(e)}setMeshMaterial(e,t){this.__meshstate__.setMeshMaterial(e,t)}setMeshMaterialTemporary(e,t){var r,e=this.__meshstate__.meshMtls.get(e);e&&(r=e.material,e.material=t,this.__meshstate__.__updateMeshMtlBuffer(e.meshMtlIndex,e),this.__meshstate__.meshMtlTexture.needsUpdate=!0,e.material=r,e.meshSet.needsUpdate=!0,e.meshSet.prepareForBatchDraw())}setMeshMaterialTemporaryUpdate(e,t){var r,e=this.__meshstate__.meshMtls.get(e);e&&(r=e.material,e.material=t,this.__meshstate__.__updateMeshMtlBuffer(e.meshMtlIndex,e),this.__meshstate__.meshMtlTexture.needsUpdate=!0,e.material=r,e.meshSet.needsUpdate=!0)}meshSetUpdate(e){e.prepareForBatchDraw()}getLineMaterial(e){this.__meshstate__.getLineMaterial(e)}setLineMaterial(e,t,r){this.__meshstate__.setLineMaterial(e,t,r)}setLineMaterialTemporary(e,t,r){var e=this.__meshstate__.lineMtls.get(e);e&&(e=2*e.lineMtlIndex,this.__meshstate__.lineMtlBuffer[e]=t,this.__meshstate__.lineMtlBuffer[1+e]=Math.round(1e3*r),this.__meshstate__.lineMtlTexture.needsUpdate=!0)}}class a{constructor(e){this.__brepManager__=e}get brepInfos(){return this.__brepManager__.brepInfos}hasBrepInfo(){return this.__brepManager__.hasBrepInfo()}hasBrepFile(){return this.__brepManager__.hasBrepFile()}}class d{constructor(e){(this.__ndsModel__=e).meshState&&(this.__meshState__=new s(e.meshState)),e.brepManager&&(this.__brepManager__=new a(e.brepManager))}get isMCAD3DModel(){return this.__ndsModel__.isMCAD3DModel}get isMCAD2DModel(){return this.__ndsModel__.isMCAD2DModel}get typeName(){return this.__ndsModel__.typeName}get ndsModelId(){return this.__ndsModel__.id}get numMesh(){}getMeshState(){return this.__meshState__}getBrepManager(){return this.__brepManager__}getPMIObject(){return this.__ndsModel__.pmiObject}getRootBodyNode(){return this.__ndsModel__.rootBodyNode}getBodyNode(e){return this.__ndsModel__.getBodyNode(e)}getLeafBodies(e){return this.__ndsModel__.getLeafBodies(e)}isSketchModel(){return!!this.__ndsModel__.isSketchModel}getLeafBodyNodes(){return this.__ndsModel__.wholeLeafBodyNodes}transparentizeBodies(e){this.__ndsModel__.transparentizeBodies(e)}isolateBodies(e){this.__ndsModel__.isolateBodies(e,NDSWebViewer.SETTING.bodyOpacity,NDSWebViewer.SETTING.lineOpacity)}clearTransparentBodies(){this.__ndsModel__.exitIsolate()}getMeshSets(){return this.__ndsModel__.getMeshSets()}changeObjectidTouuid(e){return this.__ndsModel__.objectidTouuid[e]}getMeshMaterial(e){return this.__ndsModel__?(e=this.__ndsModel__.meshManager.materialId[e],e=this.__ndsModel__.meshManager.materialUuids[e],this.__ndsModel__.meshManager.materials[e].mat):null}setMeshMaterial(e,t){if(!this.__ndsModel__)return!1;var r=this.__ndsModel__;let i=0;if(r.meshManager.materials[t.uuid]){for(let e=0;e<r.meshManager.materialUuids.length;e++)if(r.meshManager.materialUuids[e]===t.uuid){i=e;break}}else r.meshManager.materials[t.uuid]={mat:t,refCount:0},i=r.meshManager.materialUuids.length,r.meshManager.materialUuids.push(t.uuid);var o=r.meshManager.materialId[e],o=r.meshManager.materialUuids[o];return r.meshManager.materials[o].refCount--,r.meshManager.materials[t.uuid].refCount++,r.meshManager.materialId[e]=i,r.meshManager.materialIdOriginal[e]=i,!0}removeAllBodyNodeMaterials(){this.__ndsModel__.removeAllBodyNodeMaterials()}removeBodyNodeMaterial(e){this.__ndsModel__.removeBodyNodeMaterial(e)}refreshBodyWorldMatrixUniforms(){this.__ndsModel__.refreshBodyWorldMatrixUniforms()}refreshMeshState(e=void 0){this.__ndsModel__.refreshMeshState(e||this.__ndsModel__.rootBodyNode)}getMeshGeometryById(e){var t=ndsModel.meshManager;return t.geomManager.getGeomFromId(t.geomId[e])}getMeshWorldMatrixById(e){var t=new THREE.Matrix4,r=ndsModel.meshManager;return t.fromArray(r.matrixes,16*r.matrixId[e]),t}getLineGeometryById(e){var t=this.__ndsModel__.meshManager;return t.geomManager.getGeomFromId(t.lineSegGeomId[e])}getLineWorldMatrixById(e){var t=new THREE.Matrix4,r=this.__ndsModel__.meshManager;return t.fromArray(r.matrixes,16*r.lineSegMatrixId[e]),t}getTextGeometryById(e){var t=this.__ndsModel__.meshManager;return t.geomManager.getGeomFromId(t.textGeomId[e])}getTextWorldMatrixById(e){var t=new THREE.Matrix4,r=this.__ndsModel__.meshManager;return t.fromArray(r.matrixes,16*r.textMatrixId[e]),t}}let l={c:null,u:[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3],e:[]},h={c:null,u:[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3],e:[]},c=[[],[],[]],_=[[],[],[]],u=[],x=new THREE.Vector3,g=new THREE.Vector3,m=new THREE.Vector3,M=new THREE.Vector3;class p{constructor(e=new THREE.Vector3,t=new THREE.Vector3,r=new THREE.Matrix3){this.center=e,this.halfSize=t,this.rotation=r}set(e,t,r){return this.center=e,this.halfSize=t,this.rotation=r,this}copy(e){return this.center.copy(e.center),this.halfSize.copy(e.halfSize),this.rotation.copy(e.rotation),this}clone(){return(new this.constructor).copy(this)}getSize(e){return e.copy(this.halfSize).multiplyScalar(2)}containsPoint(e){return M.subVectors(e,this.center),this.rotation.extractBasis(x,g,m),Math.abs(M.dot(x))<=this.halfSize.x&&Math.abs(M.dot(g))<=this.halfSize.y&&Math.abs(M.dot(m))<=this.halfSize.z}containsBox(e){var t=[new THREE.Vector3(e.min.x,e.min.y,0),new THREE.Vector3(e.min.x,e.max.y,0),new THREE.Vector3(e.max.x,e.max.y,0),new THREE.Vector3(e.max.x,e.min.y,0)];for(let e=0;e<t.length;e++)if(!this.containsPoint(t[e]))return!1;return!0}intersectsBox(e){return this.intersectsOBB(w.fromBox3(e))}intersectsOBB(e,r=Number.EPSILON){l.c=this.center,l.e[0]=this.halfSize.x,l.e[1]=this.halfSize.y,l.e[2]=this.halfSize.z,this.rotation.extractBasis(l.u[0],l.u[1],l.u[2]),h.c=e.center,h.e[0]=e.halfSize.x,h.e[1]=e.halfSize.y,h.e[2]=e.halfSize.z,e.rotation.extractBasis(h.u[0],h.u[1],h.u[2]);for(let t=0;t<3;t++)for(let e=0;e<3;e++)c[t][e]=l.u[t].dot(h.u[e]);M.subVectors(h.c,l.c),u[0]=M.dot(l.u[0]),u[1]=M.dot(l.u[1]),u[2]=M.dot(l.u[2]);for(let t=0;t<3;t++)for(let e=0;e<3;e++)_[t][e]=Math.abs(c[t][e])+r;let t,i;for(let e=0;e<3;e++)if(t=l.e[e],i=h.e[0]*_[e][0]+h.e[1]*_[e][1]+h.e[2]*_[e][2],Math.abs(u[e])>t+i)return!1;for(let e=0;e<3;e++)if(t=l.e[0]*_[0][e]+l.e[1]*_[1][e]+l.e[2]*_[2][e],i=h.e[e],Math.abs(u[0]*c[0][e]+u[1]*c[1][e]+u[2]*c[2][e])>t+i)return!1;return t=l.e[1]*_[2][0]+l.e[2]*_[1][0],i=h.e[1]*_[0][2]+h.e[2]*_[0][1],!(Math.abs(u[2]*c[1][0]-u[1]*c[2][0])>t+i||(t=l.e[1]*_[2][1]+l.e[2]*_[1][1],i=h.e[0]*_[0][2]+h.e[2]*_[0][0],Math.abs(u[2]*c[1][1]-u[1]*c[2][1])>t+i)||(t=l.e[1]*_[2][2]+l.e[2]*_[1][2],i=h.e[0]*_[0][1]+h.e[1]*_[0][0],Math.abs(u[2]*c[1][2]-u[1]*c[2][2])>t+i)||(t=l.e[0]*_[2][0]+l.e[2]*_[0][0],i=h.e[1]*_[1][2]+h.e[2]*_[1][1],Math.abs(u[0]*c[2][0]-u[2]*c[0][0])>t+i)||(t=l.e[0]*_[2][1]+l.e[2]*_[0][1],i=h.e[0]*_[1][2]+h.e[2]*_[1][0],Math.abs(u[0]*c[2][1]-u[2]*c[0][1])>t+i)||(t=l.e[0]*_[2][2]+l.e[2]*_[0][2],i=h.e[0]*_[1][1]+h.e[1]*_[1][0],Math.abs(u[0]*c[2][2]-u[2]*c[0][2])>t+i)||(t=l.e[0]*_[1][0]+l.e[1]*_[0][0],i=h.e[1]*_[2][2]+h.e[2]*_[2][1],Math.abs(u[1]*c[0][0]-u[0]*c[1][0])>t+i)||(t=l.e[0]*_[1][1]+l.e[1]*_[0][1],i=h.e[0]*_[2][2]+h.e[2]*_[2][0],Math.abs(u[1]*c[0][1]-u[0]*c[1][1])>t+i)||(t=l.e[0]*_[1][2]+l.e[1]*_[0][2],i=h.e[0]*_[2][1]+h.e[1]*_[2][0],Math.abs(u[1]*c[0][2]-u[0]*c[1][2])>t+i))}fromBox3(e){return e.getCenter(this.center),e.getSize(this.halfSize).multiplyScalar(.5),this.rotation.identity(),this}}let w=new p;class f{constructor(e){this.viewer=e,this.sceneWraper=new o(this.viewer),this.modelWraper=null,this.loadTextInfos=!1,this.textInfos=[],this.lineTextInfos=[],this.results=[]}initTextInfo(){var e=this.sceneWraper.getModelByIndex(0);!1!==this.loadTextInfos&&null!==this.modelWraper&&this.modelWraper.ndsModelId==e.id||(this.loadTextInfos=!0,this.modelWraper=new d(this.sceneWraper.getActiveModel()),e=performance.now(),this.updateTextInfos(),e=((performance.now()-e)/1e3).toFixed(2),console.log("NDSText load texts ",e))}updateTextInfos(){this.textInfos=[],this.lineTextInfos=[];var t=new Map,r=this.modelWraper,i=r.getLeafBodyNodes();for(let e=0;e<i.length;e++){var o=i[e],n=L.getTextsInLeafBodyNode(o);for(let e=0;e<n.length;e++){var s=n[e],a=r.getTextGeometryById(s),d={text:j.getGeomText(a),textId:s,geomUUid:a.uuid,bodyNodeId:o.uuid},l=j.getGeomTextIndex(a);l?(d.subInd=j.getGeomTextSubInd(a),a=this.viewer.ndsModel.activeModel.meshManager.textMatrixId[s]+"_"+l,t.has(a)?t.get(a).push(d):t.set(a,[d])):this.textInfos.push(d)}}this.textInfos.sort(function(e,t){return e.geomUUid-t.geomUUid});let h=this;t.forEach(function(e,t){if(1===e.length)h.textInfos.push(e[0]);else{e.sort(function(e,t){return e.subInd-t.subInd});let t="";e.forEach(function(e){t+=e.text}),h.textInfos.push({text:t,texts:e,geomUUid:e[0].geomUUid,bodyNodeId:e[0].bodyNodeId,isMText:!0})}}),t.clear()}getTextPos(e,t,r,i,o){var n=j.getGeomTextCharsWH(e);if(!n||i<r||4*i>n.length)return null;var s=j.getGeomTextViewBox(e),a=j.getGeomTextPosition(e),d=j.getGeomTextQuaternion(e),e=j.getGeomTextNormalMatrix(e),l=new THREE.Matrix4,h=(l.compose(a,d,new THREE.Vector3(1,1,1)),l.multiply(e),l.premultiply(t),new THREE.Box3),c=new THREE.Vector3,_=new THREE.Vector3,u=new THREE.Vector3;let x=0,g=0;for(let e=r;e<i;e++){c.set(n[4*e+0],n[4*e+1],0),_.set(n[4*e+2],n[4*e+3],0);var m=_.x-c.x,m=(m>x&&(x=m),_.y-c.y);if(m>g&&(g=m),h.expandByPoint(c),h.expandByPoint(_),s||o){if(c.applyMatrix4(l),_.applyMatrix4(l),u.set((c.x+_.x)/2,(c.y+_.y)/2,0),s&&(!s.containsPoint(u)||!s.containsPoint(c)&&!s.containsPoint(_)))return null;if(o&&!(o.containsPoint(u)&&o.containsPoint(c)&&o.containsPoint(_)))return null}}r=new THREE.Matrix4,r.compose(a,d,new THREE.Vector3(1,1,1)),r.multiply(e),r.premultiply(t),d=(new THREE.Matrix4).makeTranslation(-a.x,-a.y,-a.z);return r.multiply(d),this.scaleBox(h,x,g),h.translate(a),{box:h,matrixWorld:r}}getBoxPos(e){return[new THREE.Vector3(e.min.x,e.min.y,0),new THREE.Vector3(e.min.x,e.max.y,0),new THREE.Vector3(e.max.x,e.max.y,0),new THREE.Vector3(e.max.x,e.min.y,0)]}getSelecPoints(e,t){var r=Math.min(e.x,t.x),i=Math.max(e.x,t.x),o=Math.min(e.y,t.y),e=Math.max(e.y,t.y),t=this.sceneWraper.clientCoordToModelCoord([r,o]),r=this.sceneWraper.clientCoordToModelCoord([r,e]),e=this.sceneWraper.clientCoordToModelCoord([i,e]),i=this.sceneWraper.clientCoordToModelCoord([i,o]);return[new THREE.Vector3(t[0],t[1],0),new THREE.Vector3(r[0],r[1],0),new THREE.Vector3(e[0],e[1],0),new THREE.Vector3(i[0],i[1],0)]}getSelectOBB(e,t){var r,i,o;return e&&t?(r=(new THREE.Vector3).subVectors(t,e),e=new THREE.Vector3((e.x+t.x)/2,(e.y+t.y)/2,0),t=this.viewer.camera.up.clone(),i=new THREE.Vector3(0,0,1),o=(new THREE.Vector3).crossVectors(t,i).normalize(),i=(new THREE.Matrix4).makeBasis(o,t,i),o=new THREE.Vector3(Math.abs(r.dot(o))/2,Math.abs(r.dot(t))/2,0),new p(e,o,(new THREE.Matrix3).setFromMatrix4(i))):null}getTextVisible(e,t){}getResults(){return this.results}clearResults(){this.results=[]}scaleBox(e,t,r){r*=.1,t*=.05;e.min.y-=r,e.max.y+=r,e.min.x-=t,e.max.x+=t}findStr(t,e,r){this.results=[];var o=this.getSelectOBB(e,r),i=new Map,n=this.modelWraper,s=this.sceneWraper;for(let e=0;e<this.textInfos.length;e++){var a=this.textInfos[e],d=i.get(a.geomUUid);if(!d||!0!==d){d=s.getBodyNodeFromUuid(a.bodyNodeId);if(!L.isHidden(d)){d=a.text.indexOf(t);if(-1<d){i.set(a.geomUUid,!1);var l=d,h=d+t.length;if(a.isMText){let t=!1,r=0;var c=new THREE.Box3;let i=null;for(let e=0;e<a.texts.length;e++){var _=a.texts[e].text.length,u=Math.max(l-r,0),P=Math.min(h-r,_);if(h<r)break;if(!(l>=(r+=_))){var _=n.getTextGeometryById(a.texts[e].textId),x=n.getTextWorldMatrixById(a.texts[e].textId);if(o){var g=j.getGeomBBox(_).clone().applyMatrix4(x);if(g.min.z=0,g.max.z=0,!o.containsBox(g)){t=!1;break}}g=this.getTextPos(_,x,u,P,o);if(!g){t=!1;break}null==i&&(i=g.matrixWorld),c.union(g.box),t=!0}}t&&this.results.push({content:a.text,points:this.getBoxPos(c),matrixWorld:i})}else{var d=n.getTextGeometryById(a.textId),m=n.getTextWorldMatrixById(a.textId);if(o){var M=j.getGeomBBox(d).clone().applyMatrix4(m);if(M.min.z=0,M.max.z=0,!o.containsBox(M))continue}M=this.getTextPos(d,m,l,h,o);M&&this.results.push({content:a.text,points:this.getBoxPos(M.box),matrixWorld:M.matrixWorld})}}else i.set(a.geomUUid,!0)}}}var p=this.viewer.ndsModel.activeModel,w=n.getMeshSets();for(let e=0;e<w.length;e++){var f=w[e];for(let e=0;e<f.ltMeshs.length;e++){var T=f.ltMeshs[e],E=f.drawingLines[T.drawingIndex];if(!E.bodyNode.isHidden()&&p.meshManager.lineTypeUuid2ParamsMap&&p.lineTypes){var B=new THREE.Matrix4,E=(f.getLineWorldMatrix(E.localIndex,B),p.lineTypes.lineTypeStyle[T.material.lineTypeId].uuid),y=p.meshManager.lineTypeUuid2ParamsMap.get(E);if(y){T=y.text.indexOf(t);if(-1<T){var F=T,C=T+t.length,V=y.characterWidthHeight,G=y.text,v=y.vD;for(let e=0;e<v.length;e++){var I=new THREE.Vector3(v[e].x,v[e].y,v[e].z),b=new THREE.Box3;let t=y.rectBearingX;var R=y.rectBearingY;if(o){var S=new THREE.Box3;for(let e=0;e<G.length;e++){var H=V[2*e+0],N=V[2*e+1],U=new THREE.Vector3(t,R,0).add(I),N=new THREE.Vector3(t+H,R+N,0).add(I);t+=H,S.expandByPoint(U),S.expandByPoint(N)}if(S.applyMatrix4(B),!o.containsBox(S))continue}t=y.rectBearingX;let r=0,i=0;for(let e=0;e<C;e++){var A=V[2*e+0],O=V[2*e+1],W=new THREE.Vector3(t,R,0).add(I),O=new THREE.Vector3(t+A,R+O,0).add(I);t+=A,e>=F&&((A=O.x-W.x)>r&&(r=A),(A=O.y-W.y)>i&&(i=A),b.expandByPoint(W),b.expandByPoint(O))}this.scaleBox(b,r,i),this.results.push({content:y.text,points:this.getBoxPos(b),matrixWorld:B.clone()})}}}}}}}debugText(t){var r=this.modelWraper,i=r.getLeafBodyNodes();for(let e=0;e<i.length;e++){var o=i[e];if(!L.isHidden(o)){var n=L.getTextsInLeafBodyNode(o);for(let e=0;e<n.length;e++){var s=n[e],a=r.getTextGeometryById(s),s=r.getTextWorldMatrixById(s),s=j.getGeomBBox(a).clone().applyMatrix4(s),a=(s.min.z=0,s.max.z=0,j.getGeomTextViewBox(a)),a=(a&&s.intersect(a),new THREE.Box3Helper(s,16711680));a.updateMatrixWorld(!0),t.add(a)}}}}}r=new class extends i{constructor(){super(),this.setFlags(n.FLAG_ENABLE_NODE_TEXT|n.FLAG_ENABLE_NODE_BROADCAST),this.name="NDSTextExtension",console.log("NDSTextExtension version 1.1.0"),this.viewer=null;let e=this;function z(t,r){var i=e.viewer.ndsModel.meshManager.oriGeomUuid2MeshPosMap;let o=[],n=0;for(let e=0;e<t.length;e++){var{start:s,uuid:a}=t[e];s<=r&&o.push(a)}for(let e=0;e<o.length;e++){if(e+1>=o.length)return n;var d=i.get(o[e]),l=i.get(o[e+1]);n+=l[0].x-d[1].x}return n}function _(t,r,i){for(let e=0;e<r.length;e++){var o=r[e];if(t>=o.start&&t<=o.end&&o.start!=o.end)return i.end=o.end,1}}function u(t){var r=[];let i=null,o=null;for(let e=0;e<t.length;e++)o=(null===i?i=t[e].subInd:t[e].subInd!==o+1&&(r.push({start:i,end:o}),i=t[e].subInd),t[e].subInd);return null!==i&&r.push({start:i,end:o}),r}this.loadTextInfo=!1,this.geomUUid2GeomsIndex=new Map,this.points=[],this.ndsFindText=null,this.rootObject=new THREE.Group,this.rootObject.name="textFindGroup",this.rootObject.visible=!1,this.findTextValue="",this.findTextid=null,this.isSelectedArea=!1,this._transMt2=function(e,t,r){let i=new THREE.Vector3(t.x,t.y,t.z),o=new THREE.Quaternion;return o.setFromRotationMatrix(r),e.map(e=>{e=new THREE.Vector3(e.x,e.y,e.z);return e.sub(i),e.applyQuaternion(o),e.add(i),{x:e.x,y:e.y,z:e.z}})},this._filterTextByShowHide=function(){if(this.loadTextInfo){var t=this.viewer.ndsModel.getMeshManager().geomManager.geoms,e=this.viewer.ndsModel.getMeshManager().lineTypeUuid2ParamsMap;let a=[];var r,i,o=new Map;for(let e=0;e<t.length;e++){var n=t[e];n&&n.text&&(this.geomUUid2GeomsIndex.set(n.uuid,e),n.textIndex?(o.has(n.textIndex)||o.set(n.textIndex,[]),o.get(n.textIndex).push(n)):a.push({uuid:n.uuid,text:n.text,characterWidthHeight:n.characterWidthHeight,rectBearingY:n.rectBearingY||0,rectBearingX:n.rectBearingX||0,mirrorX:n.mirrorX,mirrorY:n.mirrorY,rectWidth:n.rectWidth,rectHeight:n.rectHeight}))}o.forEach(function(e,t){if(e.length){e.sort((e,t)=>e.subInd-t.subInd);let t=u(e),r="",i="",o=[],n={},s=[];e.forEach(e=>{_(e.subInd,t,n)?(r=r?r+"-"+e.uuid:e.uuid,s.push({start:i.length,uuid:e.uuid}),i+=e.text,o=o.concat(e.characterWidthHeight),n.end==e.subInd&&(a.push({uuid:r,text:i,characterWidthHeight:o,geomStartEnd:s,rectBearingY:e.rectBearingY||0,rectBearingX:e.rectBearingX||0,mirrorX:e.mirrorX,mirrorY:e.mirrorY,rectWidth:e.rectWidth,rectHeight:e.rectHeight}),r="",i="",o=[])):a.push({uuid:e.uuid,text:e.text,characterWidthHeight:e.characterWidthHeight,rectBearingY:e.rectBearingY||0,rectBearingX:e.rectBearingX||0,mirrorX:e.mirrorX,mirrorY:e.mirrorY,rectWidth:e.rectWidth,rectHeight:e.rectHeight})})}});for([r,i]of e)a.push({uuid:r,text:i.text,characterWidthHeight:i.characterWidthHeight,rectBearingY:i.rectBearingY||0,rectBearingX:i.rectBearingX||0,rectWidth:i.rectWidth,rectHeight:i.rectHeight,isLTText:!0});this.viewer.ndsModel.getMeshManager().spliceTextRow=a}},this._drawTextRect=function(e,t,r="selectArea",i){e=new THREE.LineBasicMaterial({color:e}),t=(new THREE.BufferGeometry).setFromPoints(t),t=new THREE.LineLoop(t,e);i&&(t.matrixWorld.copy(i),t.matrixWorldNeedsUpdate=!0),t.name=r,this.rootObject.add(t),this.viewer.render()},this._isInnerRect=function(i,e,t){if(!i.length||!e.length)return!1;var r=this.viewer.ndsModel.meshManager.geomUuid2IndexMap,o=e[0].x,n=e[0].y,s=e[1].x,a=e[1].y,d=e[2].x,l=e[2].y,h=e[3].x,e=e[3].y,c=t.split("-"),_=this.getGeomsViewport(c),u=Math.min(o,s,d,h),x=Math.max(o,s,d,h),g=Math.min(n,a,l,e),m=Math.max(n,a,l,e),M=[];for(let r=0;r<i.length;r+=4){let t=null;for(let e=0;e<4;e++){var p=i[r+e],w=p.x,p=p.y;if(_.isViewprot){var f=new THREE.Vector3(w,p,0);if(!_.containsPoint(f))continue}if(!(u<=w&&w<=x&&g<=p&&p<=m)){t=!1;break}t=!0}1==t&&M.push(r/4)}return t&&M.length&&r.set(t,M),!!M.length},this.getGeomsViewport=function(t){var r=new THREE.Box3,i=(r.isViewprot=!1,this.viewer.ndsModel.meshManager);for(let e=0;e<t.length;e++){var o,n=i.geomManager.getGeomFromUuid(t[e],0);n&&n.viewBox&&(o=new THREE.Vector3(n.viewBox.max2.x,n.viewBox.max2.y,0),n=new THREE.Vector3(n.viewBox.min2.x,n.viewBox.min2.y,0),r.expandByPoint(o),r.expandByPoint(n),r.isViewprot=!0)}return r},this._creatFindTextMesh=function(e){this.exitTextFind(!0),this.rootObject.visible||(this.rootObject.visible=!0,this.viewer.scene.add(this.rootObject));var t=new THREE.MeshBasicMaterial({color:"#FF0000"}),r=new THREE.CircleGeometry(2,32),r=new THREE.InstancedMesh(r,t,e.length),i=(r.name="circle",new THREE.PlaneGeometry(.5,6)),i=new THREE.InstancedMesh(i,t,e.length),t=(i.name="plane",new THREE.Group);t.name="textGroup",t.posArr=e,t.add(r),t.add(i),t.visible=!1,this.rootObject.add(t),this.viewer.render()},this.findTextIconUpdate=function(){if(this.rootObject.visible){var t=this.rootObject.children.findIndex(e=>"textGroup"==e.name);if(-1!=t){let d=new THREE.Object3D,e=this.rootObject.children[t];e.visible=!0;t=this.viewer.controls.getBoundingBox();if(t){t=t.getCenter(new THREE.Vector3);if(t){var t=t.clone(),r=this.viewer.camera.getCameraTarget(),l=this.viewer.camera.position,h=new THREE.Vector3,r=(h.subVectors(r,l),t.clone()),t=this.viewer.camera.isPerspective?r.sub(l).dot(h.normalize()):1.2*h.length(),r=this.viewer.camera.fov,l=2*t*Math.tan(THREE.Math.degToRad(.5*r)),h=this.viewer.renderer.domElement.height;let i=5*l*this.viewer.renderer.getPixelRatio()/h;i<1e-5&&(i=1e-5);t=this.viewer.camera.up.clone().normalize();let o=new THREE.Quaternion,n=(o.setFromUnitVectors(new THREE.Vector3(0,1,0),t),new THREE.Matrix4),s=(n.makeRotationFromQuaternion(o),new THREE.Matrix4),a=new THREE.Matrix4;e.children.forEach(r=>{e.posArr.forEach((e,t)=>{s.makeTranslation(-e.x,-e.y,-e.z),a.makeTranslation(e.x,e.y,e.z),d.position.set(e.x,e.y,e.z),d.quaternion.copy(o),d.scale.set(i,i,i),d.updateMatrix(),"circle"==r.name&&(d.matrix.elements[13]=d.matrix.elements[13]+3*i,d.matrix.premultiply(s),d.matrix.premultiply(n),d.matrix.premultiply(a)),r.setMatrixAt(t,d.matrix)}),r.instanceMatrix.needsUpdate=!0,r.computeBoundingSphere()})}}}}},this._init2dTextFind=function(){let r=new THREE.Object3D;var i=this.viewer.ndsModel.meshManager,t=i.textGeomId;for(let e=0;e<t.length;e++){var o=t[e],o=i.geomManager.getGeomFromId(o);if(o){if(r.position.copy(o.position),r.quaternion.copy(o.quaternion),r.updateMatrix(),o.normalMatrix&&r.matrix.multiply(o.normalMatrix),i.matrixes)for(var n=0;n<16;++n)r.matrixWorld.elements[n]=i.matrixes[16*i.textMatrixId[e]+n];var s=r.matrixWorld.clone().multiply(r.matrix),s={x:s.elements[12],y:s.elements[13],z:s.elements[14]},a={worldMatrix:[r.matrixWorld.clone()],matrix:r.matrix.clone(),oriPoint:[s],position:o.position},d=(i.geomUuid2MeshMtMap.has(o.uuid)?(d=(l=i.geomUuid2MeshMtMap.get(o.uuid)).worldMatrix.concat(a.worldMatrix),l.worldMatrix=d,d=l.oriPoint.concat(a.oriPoint),l.oriPoint=d,i.geomUuid2MeshMtMap.set(o.uuid,l)):i.geomUuid2MeshMtMap.set(o.uuid,a),[]);let t=[];var l={x:r.position.x+o.rectBearingX,y:r.position.y+o.rectBearingY,z:r.position.z},a={x:r.position.x+o.rectBearingX+o.rectWidth,y:r.position.y+o.rectBearingY,z:r.position.z},h={x:r.position.x+o.rectBearingX+o.rectWidth,y:r.position.y+o.rectHeight,z:r.position.z},c={x:r.position.x+o.rectBearingX,y:r.position.y+o.rectHeight,z:r.position.z},a=(d.push(l,a,h,c),i.oriGeomUuid2MeshPosMap.has(o.uuid)||i.oriGeomUuid2MeshPosMap.set(o.uuid,d),d.forEach(e=>{r.matrix.elements[12]=e.x,r.matrix.elements[13]=e.y,r.matrix.elements[14]=e.z;e=r.matrixWorld.clone().multiply(r.matrix);t.push({x:e.elements[12],y:e.elements[13],z:e.elements[14]})}),this._transMt2(t,s,r.matrix));i.geomUuid2MeshPosMap.has(o.uuid)?(h=i.geomUuid2MeshPosMap.get(o.uuid).concat(a),i.geomUuid2MeshPosMap.set(o.uuid,h)):i.geomUuid2MeshPosMap.set(o.uuid,a)}}},this.findText=function(i,x=!1){if(this.ndsFindText){let[e,t]=this.V2FindText(i,x);return t.length&&this._creatFindTextMesh(t),0==e.length&&this.exitTextFind(!0),e}this.textId2FlagRect&&this.textId2FlagRect.clear();var o=this.viewer.ndsModel.meshManager;let g=o.oriGeomUuid2MeshPosMap;var n=o.geomUuid2MeshMtMap,s=o.geomUuid2IndexMap,a=o.lineStyleGeomUuid2MeshPosMap,m=this.viewer.ndsModel.getMeshManager().lineTypeUuid2ParamsMap;let M=new THREE.Matrix4,p=new THREE.Matrix4,w=[],f=0,T=[],t;t=x?this.viewer.ndsModel.getMeshManager().spliceTextRowSelectArea:this.viewer.ndsModel.getMeshManager().spliceTextRow;for(let e=0;e<t.length;e++){var E=t[e];if(E.text){let u=!1,e=0;do{u=!1;var B=E.text.indexOf(i,e);if(!(-1<B)){u=!1;break}{e=B+1,this.textId2FlagRect||(this.textId2FlagRect=new Map);var y=E.uuid.split("-"),V=y[0],v=s.get(V),I=n.get(V),b=E.geomStartEnd?z(E.geomStartEnd,B+i.length-1):0,R=E.geomStartEnd?z(E.geomStartEnd,B):0;if(!x)if(E.isLTText){if(!1===m.get(V).visible)continue}else{var S=this.geomUUid2GeomsIndex.get(V);if(!1===o.geomManager.geoms[S]._visible)continue}let t=0,d=0,l,h,c,_,r=0;for(let e=0;e<i.length+B;e++)e==B&&(d=t),t+=E.characterWidthHeight[2*e],e>=B&&(r=r>E.characterWidthHeight[2*e+1]?r:E.characterWidthHeight[2*e+1]);if(E.mirrorX&&"number"==typeof E.rectWidth&&(S=d,d=E.rectWidth-t,t=E.rectWidth-S),g.has(V)){var H=[],N={},A={};let r=1/0,i=1/0,o=1/0,n=1/0,s=-1/0,a=1/0;y.forEach(e=>{var t=g.get(e)[0],t=(r=Math.min(t.x,r),i=Math.min(t.y,i),o=Math.min(t.z,o),g.get(e)[3]);n=Math.min(t.x,n),s=Math.max(t.y,s),a=Math.min(t.z,a)}),N.x=r,N.y=i,N.z=o,A.x=n,A.y=s,A.z=a;var O=this.getGeomsViewport(y);if(l={x:N.x+d+R,y:N.y,z:0},_={x:A.x+d+R,y:A.y,z:0},h={x:N.x+t+b,y:N.y,z:0},c={x:A.x+t+b,y:A.y,z:0},H.push(l,h,c,_),I.worldMatrix&&I.worldMatrix.length)for(let e=0;e<I.worldMatrix.length;e++)if(!x||v&&v.includes(e)){var W={};M.copy(I.matrix),p.copy(I.worldMatrix[e]);let t=[];H.forEach(e=>{M.elements[12]=e.x,M.elements[13]=e.y,M.elements[14]=e.z;e=p.clone().multiply(M);t.push({x:e.elements[12],y:e.elements[13],z:e.elements[14]})});var P=this._transMt2(t,I.oriPoint[e],M),F=this._transMt2(H,I.position,M);if(O.isViewprot){let r=!0;var C=new THREE.Vector3((F[0].x+F[2].x)/2,(F[0].y+F[2].y)/2,0);if(O.containsPoint(C)){let t=0;for(let e=0;e<4;e++){var G=new THREE.Vector3(F[e].x,F[e].y,0);if(O.containsPoint(G)&&2<=++t){r=!1;break}}}if(r){u=!0;continue}}f++,W.flag=P[3],W.points=F,W.matrixWorld=I.worldMatrix[e],W.flagPos=P,T.push(P[3]),w.push({index:f,content:E.text}),this.textId2FlagRect.set(f,W),u=!1}}else if(a.has(V)){var U,L,j,D=a.get(V);for(let e=0;e<D.length;e+=4)(!x||v&&v.includes(e/4))&&(U=D[e],L=D[e+3],j=[],l={x:U.x+d+R,y:U.y,z:0},_={x:L.x+d+R,y:L.y,z:0},h={x:U.x+t+b,y:U.y,z:0},c={x:L.x+t+b,y:L.y,z:0},j.push(l,h,c,_),L={},f++,j=this._transMt2(j,U,I),L.flag=j[3],L.flagPos=j,L.points=j,T.push(j[3]),w.push({index:f,content:E.text}),this.textId2FlagRect.set(f,L),u=!1)}}}while(u&&e<=E.text.length)}}return T.length&&this._creatFindTextMesh(T),0==w.length&&this.exitTextFind(!0),NDSWebViewer.SETTING.enableBroadcast&&NDSWebViewer.SETTING.broadcastMajor&&(NDSWebViewer.ExtensionManager.updateBroadcastInfo(this.name),NDSWebViewer.ExtensionManager.updateBroadcastInfo("generalInfo")),this.findTextValue=i,this.isSelectedArea=x,w},this.selectArea=function(o,n){if(o&&n&&o.x&&o.y&&n.x&&n.y)if(this.clearSelectArea(),this.rootObject.visible||(this.rootObject.visible=!0,this.viewer.scene.add(this.rootObject)),this.ndsFindText)this.V2SelectArea(o,n);else{this.viewer.ndsModel.meshManager.geomUuid2IndexMap.clear();let e=o.x,t=n.x,r=o.y,i=n.y;var o=this.viewer.renderer.domElement,n=this.viewer.renderer.getPixelRatio(),s=(e>t&&([e,t]=[t,e]),r>i&&([r,i]=[i,r]),e*n/o.width*2-1),a=t*n/o.width*2-1,d=2*-(r*n/o.height)+1,n=2*-(i*n/o.height)+1,o=new THREE.Vector3(0,0,0),l=(o.copy(this.viewer.camera.target),o.project(this.viewer.camera),new THREE.Vector3(s,d,o.z)),d=new THREE.Vector3(a,d,o.z),a=new THREE.Vector3(a,n,o.z),s=new THREE.Vector3(s,n,o.z),n=[];n.push(l.unproject(this.viewer.camera)),n.push(d.unproject(this.viewer.camera)),n.push(a.unproject(this.viewer.camera)),n.push(s.unproject(this.viewer.camera)),this._drawTextRect("#1880E3",n,"selectArea"),this.selectAreaFromPoints(n),this.points=n}},this.selectAreaFromPoints=function(o){var t=this.viewer.ndsModel.getMeshManager().geomManager.geoms;let n=this.viewer.ndsModel.meshManager.geomUuid2MeshPosMap;var e=this.viewer.ndsModel.getMeshManager().lineTypeUuid2ParamsMap;let d=[];var r,i,s=new Map;for(let e=0;e<t.length;e++){var a,l=t[e];l&&l.text&&0!=l._visible&&(l.textIndex?(s.has(l.textIndex)||s.set(l.textIndex,[]),s.get(l.textIndex).push(l)):(a=n.get(l.uuid))&&this._isInnerRect(a,o,l.uuid)&&d.push({uuid:l.uuid,text:l.text,characterWidthHeight:l.characterWidthHeight,rectBearingY:l.rectBearingY||0,rectBearingX:l.rectBearingX||0,mirrorX:l.mirrorX,mirrorY:l.mirrorY,rectWidth:l.rectWidth,rectHeight:l.rectHeight}))}let h=this;s.forEach(function(e,t){var a=e;let r=!0;for(let e=0;e<a.length;e++){var i=n.get(a[e].uuid);if(!h._isInnerRect(i,o,a[e].uuid)){r=!1;break}}if(r&&0<a.length){a.sort((e,t)=>e.subInd-t.subInd);let t=u(a),r="",i="",o=[],n={},s=[];a.forEach(e=>{_(e.subInd,t,n)?(r=r?r+"-"+e.uuid:e.uuid,s.push({start:i.length,uuid:e.uuid}),i+=e.text,o=o.concat(e.characterWidthHeight),n.end==e.subInd&&(d.push({uuid:r,text:i,characterWidthHeight:o,geomStartEnd:s,rectBearingY:e.rectBearingY||0,rectBearingX:e.rectBearingX||0,mirrorX:e.mirrorX,mirrorY:e.mirrorY,rectWidth:e.rectWidth,rectHeight:e.rectHeight}),r="",i="",o=[])):d.push({uuid:e.uuid,text:e.text,characterWidthHeight:e.characterWidthHeight,rectBearingY:e.rectBearingY||0,rectBearingX:e.rectBearingX||0,mirrorX:e.mirrorX,mirrorY:e.mirrorY,rectWidth:e.rectWidth,rectHeight:e.rectHeight})})}});for([r,i]of e){var c=n.get(r);c&&this._isInnerRect(c,o,r)&&i.visible&&d.push({uuid:r,text:i.text,characterWidthHeight:i.characterWidthHeight,rectBearingY:i.rectBearingY||0,rectBearingX:i.rectBearingX||0,mirrorX:i.mirrorX,mirrorY:i.mirrorY,rectWidth:i.rectWidth,rectHeight:i.rectHeight})}this.viewer.ndsModel.getMeshManager().spliceTextRowSelectArea=d},this.textLocation=function(e){var t,r;this.ndsFindText?(this.clearSelectFindArea(),this.V2TextLocation(e)):this.textId2FlagRect&&this.textId2FlagRect.has(e)&&(this.clearSelectFindArea(),r=this.textId2FlagRect.get(e),this.findTextid=e,this._drawTextRect("#E66C1C",r.points,"selectFindArea",r.matrixWorld),e=Math.abs(r.flagPos[0].y-r.flagPos[3].y),t=Math.abs(r.flagPos[0].y-r.flagPos[1].y),e=(.001<e?e:t)/Math.tan(Math.PI/180*this.viewer.camera.fov*.5)*4,(t=new THREE.Vector3).set(r.flag.x+e/7,r.flag.y-e/8,r.flag.z),(r=this.viewer.camera.target.clone().sub(this.viewer.camera.position).normalize()).multiplyScalar(e),e=t.clone().sub(r),this.viewer.camera.position.set(e.x,e.y,e.z),this.viewer.camera.setCameraTarget(t),this.viewer.camera.updateProjectionMatrix(),this.viewer.camera.updateMatrixWorld(!0),this.findTextIconUpdate(),this.viewer.render(),NDSWebViewer.SETTING.enableBroadcast)&&NDSWebViewer.SETTING.broadcastMajor&&(NDSWebViewer.ExtensionManager.updateBroadcastInfo(this.name),NDSWebViewer.ExtensionManager.updateBroadcastInfo("generalInfo"))},this.clearSelectFindArea=function(){var e=this.rootObject.children.findIndex(e=>"selectFindArea"==e.name);-1<e&&(this.rootObject.children.splice(e,1),this.viewer.render())},this.clearSelectArea=function(){this.viewer.ndsModel.meshManager.geomUuid2IndexMap.clear();var e=this.rootObject.children.findIndex(e=>"selectArea"==e.name);-1<e&&(this.rootObject.children.splice(e,1),this.viewer.render())},this.exitTextFind=function(e){var t=this.rootObject.children.findIndex(e=>"textGroup"==e.name);-1<t&&(this.rootObject.children.splice(t,1),this.viewer.render()),this.clearSelectFindArea(),void 0===e&&this.rootObject.visible&&(this.rootObject.visible=!1,this.viewer.scene.remove(this.rootObject)),this.findTextValue="",this.isSelectedArea=!1,this.findTextid=null,NDSWebViewer.SETTING.enableBroadcast&&NDSWebViewer.SETTING.broadcastMajor&&(NDSWebViewer.ExtensionManager.updateBroadcastInfo(this.name),NDSWebViewer.ExtensionManager.updateBroadcastInfo("generalInfo"))},this.init2dTextFind=function(){3<this.viewer.modelContentVersion&&this.V2init2dTextFind()}}onLoad(e){this.viewer=e}clear(){this.ndsFindText=null,this.loadTextInfo=!1,this.geomUUid2GeomsIndex.clear(),this.findTextValue="",this.isSelectedArea=!1,this.findTextid=null}onBeforeNdsModelSetRender(){0<this.rootObject.children.length&&this.findTextIconUpdate()}onAfterNdsModelUpdate(e){if(!1===this.loadTextInfo&&e.state>=NDSWebViewer.NdsModel.StateType.PREPARED){this.loadTextInfo=!0;let r=this;setTimeout(()=>{var e,t=performance.now();3<r.viewer.modelContentVersion?r.ndsFindText=new f(r.viewer):(r._init2dTextFind(),r._filterTextByShowHide(),e="Create TextInfo:",t=t,t=((performance.now()-t)/1e3).toFixed(2),console.log(e," ",t))},100)}}onAfterGetBroadcastInfo(e){e.textFindInfo={},e.textFindInfo.findTextValue=this.findTextValue,e.textFindInfo.isSelectedArea=this.isSelectedArea,e.textFindInfo.findTextid=this.findTextid,e.textFindInfo.isSelectedArea&&(e.textFindInfo.points=this.points)}onAfterSetBroadcastInfo(e){e.textFindInfo&&(""!=e.textFindInfo.findTextValue&&null!=e.textFindInfo.findTextValue&&(e.textFindInfo.isSelectedArea&&this.selectAreaFromPoints(e.textFindInfo.points),this.findText(e.textFindInfo.findTextValue,e.textFindInfo.isSelectedArea)),e.textFindInfo.findTextid&&this.textLocation(e.textFindInfo.findTextid),""!==e.textFindInfo.findTextValue&&null!=e.textFindInfo.findTextValue||this.exitTextFind())}V2init2dTextFind(){this.ndsFindText.initTextInfo()}V2AddRenderObj(){this.rootObject.visible||(this.rootObject.visible=!0,this.viewer.scene.add(this.rootObject))}V2SelectArea(e,t){e&&t&&e.x&&e.y&&t.x&&t.y&&(this.ndsFindText.clearResults(),e=this.ndsFindText.getSelecPoints(e,t),this.points=[],this.points.push(e[0]),this.points.push(e[2]),this._drawTextRect("#1880E3",e,"selectArea"))}V2FindText(e,t=!1){t?this.ndsFindText.findStr(e,this.points[0],this.points[1]):this.ndsFindText.findStr(e);var r=this.ndsFindText.getResults(),i=[],o=[];for(let e=0;e<r.length;e++){i.push({index:e+1,content:r[e].content});var n=(new THREE.Vector3).copy(r[e].points[1]);n.applyMatrix4(r[e].matrixWorld),o.push(n)}return[i,o]}V2TextLocation(e){var t=this.ndsFindText.getResults();0<e&&e<=t.length&&(t=t[e-1])&&(this._drawTextRect("#E66C1C",t.points,"selectFindArea",t.matrixWorld),this.V2AddRenderObj(),this.V2ChangeCameraTo(t.points,t.matrixWorld))}V2ChangeCameraTo(e,t){var r=new THREE.Vector3((e[0].x+e[2].x)/2,(e[0].y+e[2].y)/2,(e[0].z+e[2].z)/2),i=(r.applyMatrix4(t),(new THREE.Vector3).copy(e[0]).applyMatrix4(t)),o=(new THREE.Vector3).copy(e[1]).applyMatrix4(t),e=(new THREE.Vector3).copy(e[2]).applyMatrix4(t),t=20*Math.min(i.distanceTo(o),e.distanceTo(o)),i=new THREE.Vector3,e=(i.set(r.x,r.y,r.z),this.viewer.camera.target.clone().sub(this.viewer.camera.position).normalize()),o=(e.multiplyScalar(t),i.clone().sub(e));this.viewer.camera.far<o.z&&(this.viewer.camera.far=o.z+1),this.viewer.camera.near>i.z&&(this.viewer.camera.near=i.z-1),this.viewer.camera.position.set(o.x,o.y,o.z),this.viewer.camera.setCameraTarget(i),this.viewer.camera.updateProjectionMatrix(),this.viewer.camera.updateMatrixWorld(!0),this.findTextIconUpdate(),this.viewer.render()}V2Debug(){this.ndsFindText&&this.ndsFindText.loadTextInfos&&this.ndsFindText.debugText(this.viewer.scene)}};NDSWebViewer.ExtensionManager.addExtension(r)}],i={},o.m=r,o.c=i,o.d=function(e,t,r){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(o.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)o.d(r,i,function(e){return t[e]}.bind(null,i));return r},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o(o.s=0);function o(e){var t;return(i[e]||(t=i[e]={i:e,l:!1,exports:{}},r[e].call(t.exports,t,t.exports,o),t.l=!0,t)).exports}var r,i});