!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.NDSExtractTextEx=t():e.NDSExtractTextEx=t()}(window,function(){return r=[function(e,t,r){r.r(t),r.d(t,"NDSExtractTextExtension",function(){return f});console.log("NDS ExtensionFramework V0.1");let i={FLAG_ENABLE_NODE_TRANSFORM:NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM,FLAG_ENABLE_NODE_STOREVIEW:NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM<<1,FLAG_ENABLE_NODE_CAMERA2D:NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM<<2,FLAG_ENABLE_NODE_BLOCK:NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM<<3,FLAG_ENABLE_NODE_TEXT:NDSWebViewer.Extension.FLAG_ENABLE_NODE_TRANSFORM<<4};class o extends NDSWebViewer.Extension{constructor(){super()}onLoad(e){}onInitLights(){}update(e){}setFlags(e){super.setFlags(e)}onNdsModelPrepareForRendering(e){}onBeforeNdsModelUpdate(e,t){}onAfterNdsModelUpdate(e,t){}onBeforeNdsModelSetRender(e,t){}onAfterNdsModelSetRender(e,t){}onBeforeNdsMeshRender(e,t){}onBeforeScreenCapture(e){}onAfterScreenCapture(){}onBeforeChangeBackGroundColor(e){}onAfterChangeBackGroundColor(e){}onAfterWindowResize(e,t,r){}onSetCaptureView(e,t){}getExtensionWithFlags(e){return NDSWebViewer.ExtensionManager.getExtensionWithFlags(e)}resetToDefault(){}needDisableInputEvent(){}getStoreInfo(e){throw this.name+" Extesion did not implement method 'getStoreInfo' "}setStoreInfo(e){throw this.name+" Extesion did not implement method 'setStoreInfo' "}getBodyTransform(e){return new THREE.Matrix4}getBodyNodeTranslate(e){return new THREE.Vector3(0,0,0)}onAfterSetBroadcastInfo(e){}onAfterGetBroadcastInfo(e){}}class s{constructor(e){this.__coreView__=e}addEventListener(e,t){this.__coreView__.addEventListener(e,t)}hasEventListener(e,t){return this.__coreView__.hasEventListener(e,t)}removeEventListener(e,t){this.__coreView__.removeEventListener(e,t)}dispatchEvent(e){this.__coreView__.dispatchEvent(e)}getPixelRatio(){return this.__coreView__.renderer.getPixelRatio()}switchRotateCenterBySelection(){this.__coreView__.switchRotateCenterBySelection()}setDefaultEnvMap(e){e&&(this.__coreView__.hasPbrMaterial=!0,this.__coreView__.setDefaultEnvMap=()=>{this.__coreView__.setEnvMapEnabled(!0),this.__coreView__.defaultEnvMapTexture=e,this.__coreView__.updateEnvMap(this.__coreView__.defaultEnvMapTexture)},this.__coreView__.setDefaultEnvMap())}getBackgroundState(){return this.__coreView__.exchangeBackImage?{type:this.__coreView__.exchangeBackImage.type,value:this.__coreView__.exchangeBackImage.value}:void 0}setBackgroundState(e,t){"Image"===e?(this.__coreView__.setEnvMapTextures(null),this.__coreView__.setBackGroundImage(t)):"EnvMap"===e?this.__coreView__.setEnvMapTextures(t):"Color"===e&&(this.__coreView__.setEnvMapTextures(null),this.__coreView__.setBackGroundImage(null),this.__coreView__.setBackGroundColor(t))}removeAllLights(){this.__coreView__.lights.length=0}getLight(e){return this.__coreView__.lights[e]}setLight(e,t){this.__coreView__.lights[e]=t}getViewBox(){return this.__coreView__.viewBox}toggleAutoRotation(e){this.__coreView__.toggleAutoRotation(e)}randColor(){return this.__coreView__.materialsSetting.randColor()}getBoundingBox(e=!1){e=this.__coreView__.ndsModel.getTotalBodyBoundingBox(null,e);return e.isEmpty()?this.__coreView__.modelRootObject.boundingBox:e}getModelTree(){return this.__coreView__.getModelTree()}getModelTotalTree(){return this.__coreView__.getModelTotalTree()}getModelCount(){return this.__coreView__.ndsModel.models.length}setActiveModel(e){this.__coreView__.ndsModel.setActiveModel(e)}setActiveModelByModelId(t){let r=-1;for(let e=0;e<this.__coreView__.ndsModel.models.length;++e)if(this.__coreView__.ndsModel.models[e].id===t){r=e;break}this.setActiveModel(r)}getActiveModel(){return this.__coreView__.ndsModel.getActiveModel()}getModelById(e){return this.__coreView__.ndsModel.getModelById(e)}getModelIndexByModelId(t){var r=this.__coreView__.ndsModel;for(let e=0;e<r.models.length;++e)if(r.models[e].id===t)return e}getModelByIndex(e){return this.__coreView__.ndsModel.models[e]}registOperator(e,t){this.__coreView__.registOperator(e,t)}setOperatorByID(e){this.__coreView__.setOperatorByID(e)}getCurrentOperator(){return this.__coreView__.controls.getOperator()}getCurrentOperatorID(){return this.__coreView__.getCurrentOperatorID()}setOperator(e){this.__coreView__.setOperator(e)}registCursor(e,t,r){this.__coreView__.registCursor(e,t,r)}hideSelectedObjects(){this.__coreView__.hideSelectedObjects()}getViewControlBoundingBox(){return this.__coreView__.controls.getBoundingBox()}setViewControlBoundingBox(e,t){this.__coreView__.controls.setBoundingBox(e,t)}setViewBoxDir(e){this.__coreView__.look({smoothTranslation:!1,useOrginal:!1,type:e})}getCamera(){return this.__coreView__.camera}setCameraControlBoundingBoxCenter(e){this.__coreView__.cameraControl.setBoundingBoxCenter(e)}setCameraControlBounding(e,t){this.__coreView__.cameraControl.setBoundingBox(e,t)}getRotateCenter(){return this.__coreView__.cameraControl.getRotateCenter()}setRotateCenter(e){this.__coreView__.cameraControl.setRotateCenter(e)}rotateToPlane(e){this.__coreView__.cameraControl.rotateToPlane(e)}getViewLockedState(){return this.__coreView__.cameraControl.isViewLockedBySingleBody}setViewLockedState(e){this.__coreView__.cameraControl.isViewLockedBySingleBody=e}getCameraInfo(){return this.__coreView__.cameraControl.getCameraInfo()}adjustNearAndFar(){this.__coreView__.cameraControl.adjustNearAndFar()}updateViewBoxCamDir(){this.__coreView__.cameraControl.updateViewBoxCamDir()}startSmoothTranslation(e){this.__coreView__.cameraControl.startSmoothTranslation(e)}zoomExtents(e,t,r){this.__coreView__.cameraControl.zoomExtents(e,t,r)}setCameraInfo(e,t){this.__coreView__.cameraControl.setCameraInfo(e,t)}getOrginalCameraInfo(){return(this.__coreView__.viewManager||this.__coreView__.camera).getOrginalCameraInfo()}setOrginalCameraInfo(e,t,r){this.__coreView__.camera.setOrginalCameraInfo({center:e,up:t,position:r})}toPerspectiveCamera(){this.__coreView__.toPerspectiveCamera()}toOrthographicCamera(){this.__coreView__.toOrthographicCamera()}updateGroundTransform(e,t,r){return this.__coreView__.groundShadow.updateGroundTransform(e,t,r)}isRendererContainsClipPlanes(){return 0<this.__coreView__.renderer.clippingPlanes.length}getCanvas2D(){return this.__coreView__.canvas2D}getCanvas3D(){return this.__coreView__.canvas3D}getContainer(){return this.__coreView__.container}getRenderDomElement(){return this.__coreView__.renderer.domElement}getAdditionalObjectsScene(){return this.__coreView__.additionalObjectsScene}getDispalyModelUnit(e,t){return this.__coreView__.getDispalyModelUnit(e,t)}modelCoordToClientCoord(e){return this.__coreView__.modelCoordToClientCoord(e)}clientCoordToModelCoord(e){return this.__coreView__.clientCoordToModelCoord(e)}showObject(e,t,r,o=!0){this.__coreView__.showObject(e,t,r,o)}showObjectReversed(e){this.__coreView__.showObjectReversed(e)}renderAllViews(){this.__coreView__.renderAllViews()}render(e){this.__coreView__.render(e)}setRenderMode(e,t){this.__coreView__.setRenderMode(e,t)}getRenderMode(){let e=void 0;switch(this.__coreView__.getRenderMode()){case 0:e="lighting";break;case 1:e="primarycolor";break;case 2:e="wireframe";break;case 3:e="whitemold";break;case 4:e="shadedWithEdges";break;case 5:e="shaded";break;case 6:e="hiddenLineRemove";break;case 7:e="hiddenLineVisible";break;case 8:e="transparent"}return e}getAssemblyPMIState(){return this.__coreView__.AssemblyPMIState}setAssemblyPMIState(e){this.__coreView__.AssemblyPMIState=e}getPartPMIState(){return this.__coreView__.PartPMIState}setPartPMIState(e){this.__coreView__.PartPMIState=e}getPmiVisible(){return this.__coreView__.pmiVisible}setPmiVisible(e){this.__coreView__.pmiVisible=e}setPMIObjectVisible(e,t){this.__coreView__.setPMIObjectVisible(e,t)}isPMIOccludeByModel(){return!NDSWebViewer.SETTING.StopPMIOcclusion}enablePMIOccludeByModel(e){this.__coreView__.stopPMIOcclusion(!e)}getPmiList(){return this.__coreView__.PMINDSBodys}getPMIObjectByUUID(e,t=-1){return this.__coreView__.getPMIObjectByuuid(e,t)}isPMIObjectOrSomeChildHidden(e){return this.__coreView__.isPMIObjectOrSomeChildHidden(e)}getPmiObjectTree(){return this.__coreView__.pmiObject}getSelectedPmiList(){return this.__coreView__.getPMINDSBodySelectList()}selectPMIObject(e,t=!0){this.__coreView__.selectPMIObject(e,t)}deselectPMIObject(e,t=!0){this.__coreView__.deselectPMIObject(e,t)}unmergeBodyNode(){this.__coreView__.ndsModel.unmergeNode()}mergeBodyNode(){this.__coreView__.ndsModel.mergeNode()}getAllTransparentBodies(e){return this.__coreView__.ndsModel.getAllTransparentBodies(e)}isolateBodiesOnly(e){this.__coreView__.ndsModel.isolateBodiesOnly(e)}clearTransparentModeBodiesMap(){this.__coreView__.ndsModel.transparentModeBodiesMap.clear()}unloadModelById(e){this.__coreView__.ndsModel.unloadModelById(e)}unloadModelByModelId(e){this.__coreView__.unloadModelById(e)}startLoadAnimationModel(e){var t=e.url,r=e.id,o={needsPMI:!1,needsAnimation:!1,needsSketchModel:!1,needsBRep:e.needsBRep,position:e.position,pmiVisible:this.__coreView__.pmiVisible,modelId:e.modelId};this.__coreView__.ndsModel.setGlobalObjectId&&this.__coreView__.ndsModel.setGlobalObjectId(0),e.singleHTML?this.__coreView__.loadModelFlate(t,o):this.__coreView__.loadModel(r,t,null,null,"js",null,null,null,o)}getBodyNodeFromUuid(t,e=-1){var r=null;return 0<=e?(e=this.getModelById(e))&&(e=e.getBodyNodeFromUuid(t))&&(r=e):this.__coreView__.ndsModel.models.forEach(e=>{e=e.getBodyNodeFromUuid(t);e&&(r=e)}),r}loadBrepInfo(e){this.__coreView__.loadBrepInfo(e)}clearBrepEdgesPoints(){this.__coreView__.clearBrepEdgesPoints()}enableTransparent(e){this.__coreView__.enableTransparent(e)}selectObjectByIds(e,t,r=[]){this.__coreView__.addSelectList(e,t,!1,r)}getObjectWorldMatrixAndMatrixByIds(t,r=[]){if(0===r.length)for(let e=0;e<t.length;e++)r.push(0);return this.__coreView__.getObjectWorldMatrixAndMatrixByIds(t,r)}setObjectWorldMatrixById(e,t,r=0){this.__coreView__.setObjectWorldMatrixById(e,t,r)}loadModel(e,t){this.__coreView__.loadModel("idv",e,null,null,"js",null,null,null,t)}getScreenCapture(e){this.__coreView__.getScreenCapturethumbnail(e)}computeBoundingBox(e,t,r,o){this.__coreView__.computeBoundingBox(e,t,r,o)}setGlobalModelId(e){this.__coreView__.ndsModel.setGlobalModelId(e)}isBodyAllChildHidden(e){return this.__coreView__.ndsModel.isBodyAllChildHidden(e)}enableRotation(e){this.__coreView__.enableRotation(e)}getBodyTranslate(e){return this.__coreView__.ndsModel.getBodyTranslate(e)}getBodyBoundingBox(e){return this.__coreView__.ndsModel.getBodyBoundingBox(e)}updateNodeMatrix(e,t,r){this.__coreView__.ndsModel.updateNodeMatrix(e,t,r)}}class n{constructor(e){this.__selectionManager__=e.selectionManager}getSelectedObjects(){return this.__selectionManager__.getSelectedObjects()}getSelectedleafObjects(){return this.__selectionManager__.getSelectedleafObjects()}getSelectedMeshes(){return this.__selectionManager__.getSelectedMeshes()}clearSelection(){this.__selectionManager__.clearSelection()}setSelectType(e){this.__selectionManager__.setSelectType(e)}selectByClick(e,t,r){this.__selectionManager__.selectByClick(e,t,r)}selectObject(e,t,r){this.__selectionManager__.selectObject(e,t,r)}deselectObject(e,t){this.__selectionManager__.deselectObject(e,t)}}class a extends NDSWebViewer.OpBase{constructor(e){super(e)}setFrameListener(e){this.__frameListener__&&this.viewer.removeFrameListener(this.__frameListener__),(this.__frameListener__=e)&&this.viewer.addFrameListener(e)}render(e=!1,t=!0){super.render(e,t)}init(){super.init()}release(){super.release()}update(){super.update()}selectByClick(e,t,r){super.selectByClick(e,t,r)}mouseEvent(e){super.mouseEvent(e)}onTouchSingleStart(e){super.onTouchSingleStart(e)}onTouchSingleMove(e){super.onTouchSingleMove(e)}onTouchSingleEnd(e){super.onTouchSingleEnd(e)}onTouchDoubleStart(e){super.onTouchDoubleStart(e)}onTouchDoubleMove(e){super.onTouchDoubleMove(e)}onTouchDoubleEnd(e){super.onTouchDoubleEnd(e)}onLMouseDbClick(e){super.onLMouseDbClick(e)}onLMouseClick(e){super.onLMouseClick(e)}onMMouseClick(e){super.onMMouseClick(e)}onRMouseClick(e){super.onRMouseClick(e)}onLMouseDown(e){super.onLMouseDown(e)}onMMouseDown(e){super.onMMouseDown(e)}onRMouseDown(e){super.onRMouseDown(e)}onLMouseMove(e){super.onLMouseMove(e)}onMMouseMove(e){super.onMMouseMove(e)}onRMouseMove(e){super.onRMouseMove(e)}onNMouseMove(e){super.onNMouseMove(e)}onLMouseUp(e){super.onLMouseUp(e)}onMMouseUp(e){super.onMMouseUp(e)}onRMouseUp(e){super.onRMouseUp(e)}}class l{constructor(e){this.__meshstate__=e}getMeshMaterial(e){return this.__meshstate__.getMeshMaterial(e)}setMeshMaterial(e,t){this.__meshstate__.setMeshMaterial(e,t)}setMeshMaterialTemporary(e,t){var r,e=this.__meshstate__.meshMtls.get(e);e&&(r=e.material,e.material=t,this.__meshstate__.__updateMeshMtlBuffer(e.meshMtlIndex,e),this.__meshstate__.meshMtlTexture.needsUpdate=!0,e.material=r,e.meshSet.needsUpdate=!0,e.meshSet.prepareForBatchDraw())}setMeshMaterialTemporaryUpdate(e,t){var r,e=this.__meshstate__.meshMtls.get(e);e&&(r=e.material,e.material=t,this.__meshstate__.__updateMeshMtlBuffer(e.meshMtlIndex,e),this.__meshstate__.meshMtlTexture.needsUpdate=!0,e.material=r,e.meshSet.needsUpdate=!0)}meshSetUpdate(e){e.prepareForBatchDraw()}getLineMaterial(e){this.__meshstate__.getLineMaterial(e)}setLineMaterial(e,t,r){this.__meshstate__.setLineMaterial(e,t,r)}setLineMaterialTemporary(e,t,r){var e=this.__meshstate__.lineMtls.get(e);e&&(e=2*e.lineMtlIndex,this.__meshstate__.lineMtlBuffer[e]=t,this.__meshstate__.lineMtlBuffer[1+e]=Math.round(1e3*r),this.__meshstate__.lineMtlTexture.needsUpdate=!0)}}class _{constructor(e){this.__brepManager__=e}get brepInfos(){return this.__brepManager__.brepInfos}hasBrepInfo(){return this.__brepManager__.hasBrepInfo()}hasBrepFile(){return this.__brepManager__.hasBrepFile()}}class d{constructor(e){(this.__ndsModel__=e).meshState&&(this.__meshState__=new l(e.meshState)),e.brepManager&&(this.__brepManager__=new _(e.brepManager))}get isMCAD3DModel(){return this.__ndsModel__.isMCAD3DModel}get isMCAD2DModel(){return this.__ndsModel__.isMCAD2DModel}get typeName(){return this.__ndsModel__.typeName}get ndsModelId(){return this.__ndsModel__.id}get numMesh(){}getMeshState(){return this.__meshState__}getBrepManager(){return this.__brepManager__}getPMIObject(){return this.__ndsModel__.pmiObject}getRootBodyNode(){return this.__ndsModel__.rootBodyNode}getBodyNode(e){return this.__ndsModel__.getBodyNode(e)}getLeafBodies(e){return this.__ndsModel__.getLeafBodies(e)}isSketchModel(){return!!this.__ndsModel__.isSketchModel}getLeafBodyNodes(){return this.__ndsModel__.wholeLeafBodyNodes}transparentizeBodies(e){this.__ndsModel__.transparentizeBodies(e)}isolateBodies(e){this.__ndsModel__.isolateBodies(e,NDSWebViewer.SETTING.bodyOpacity,NDSWebViewer.SETTING.lineOpacity)}clearTransparentBodies(){this.__ndsModel__.exitIsolate()}getMeshSets(){return this.__ndsModel__.getMeshSets()}changeObjectidTouuid(e){return this.__ndsModel__.objectidTouuid[e]}getMeshMaterial(e){return this.__ndsModel__?(e=this.__ndsModel__.meshManager.materialId[e],e=this.__ndsModel__.meshManager.materialUuids[e],this.__ndsModel__.meshManager.materials[e].mat):null}setMeshMaterial(e,t){if(!this.__ndsModel__)return!1;var r=this.__ndsModel__;let o=0;if(r.meshManager.materials[t.uuid]){for(let e=0;e<r.meshManager.materialUuids.length;e++)if(r.meshManager.materialUuids[e]===t.uuid){o=e;break}}else r.meshManager.materials[t.uuid]={mat:t,refCount:0},o=r.meshManager.materialUuids.length,r.meshManager.materialUuids.push(t.uuid);var s=r.meshManager.materialId[e],s=r.meshManager.materialUuids[s];return r.meshManager.materials[s].refCount--,r.meshManager.materials[t.uuid].refCount++,r.meshManager.materialId[e]=o,r.meshManager.materialIdOriginal[e]=o,!0}removeAllBodyNodeMaterials(){this.__ndsModel__.removeAllBodyNodeMaterials()}removeBodyNodeMaterial(e){this.__ndsModel__.removeBodyNodeMaterial(e)}refreshBodyWorldMatrixUniforms(){this.__ndsModel__.refreshBodyWorldMatrixUniforms()}refreshMeshState(e=void 0){this.__ndsModel__.refreshMeshState(e||this.__ndsModel__.rootBodyNode)}getMeshGeometryById(e){var t=ndsModel.meshManager;return t.geomManager.getGeomFromId(t.geomId[e])}getMeshWorldMatrixById(e){var t=new THREE.Matrix4,r=ndsModel.meshManager;return t.fromArray(r.matrixes,16*r.matrixId[e]),t}getLineGeometryById(e){var t=this.__ndsModel__.meshManager;return t.geomManager.getGeomFromId(t.lineSegGeomId[e])}getLineWorldMatrixById(e){var t=new THREE.Matrix4,r=this.__ndsModel__.meshManager;return t.fromArray(r.matrixes,16*r.lineSegMatrixId[e]),t}getTextGeometryById(e){var t=this.__ndsModel__.meshManager;return t.geomManager.getGeomFromId(t.textGeomId[e])}getTextWorldMatrixById(e){var t=new THREE.Matrix4,r=this.__ndsModel__.meshManager;return t.fromArray(r.matrixes,16*r.textMatrixId[e]),t}}class L{static getModel(e){return e.ndsModel}static getModelId(e){return e.ndsModel.id}static getUUID(e){return e.uuid}static getObjectId(e){return e.objectid}static getId(e){return e.id}static getBodyNodeMaterial(e){var t=e.getMaterialBodyNodeUUid();return t&&e.useBodyNodeMaterial?e.ndsModel.bodyNodeUUidToMaterial[t]:null}static setBodyNodeMaterial(e,t){e.ndsModel.bodyNodeUUidToMaterial[e.uuid]=t,e.useBodyNodeMaterial=!!t}static getUserMaterial(e){return e.getUserMaterial()}static setUserMaterial(e,t){e.setUserMaterial(t)}static getBoundingBox(e){var t=new THREE.Box3;return e.getBoundingBox(t,!0)}static isLeafBodyNode(e){return!!e.leafBodyAttri}static isPartBodyNode(e){return"Part"===e.type}static getLeafBodyNodes(e){return e.ndsModel.getLeafBodies(e)}static getMeshesInLeafBodyNode(e){return e.leafBodyAttri?e.leafBodyAttri.bodyMeshIds:[]}static getLinesInLeafBodyNode(e){return e.leafBodyAttri?e.leafBodyAttri.bodyLineSegIds:[]}static getTextsInLeafBodyNode(e){return e.leafBodyAttri?e.leafBodyAttri.bodyTextIds:[]}static getMatrixLocal(e){return e.matrix}static getMatrixWorld(e){return e.worldMatrix}static setMatrixWorld(e,t){e.setMatrixWorld(t)}static applyTransform(e,t=null){e.applyTransform(t)}static updateMatrixWorld(e,t=!1){e.updateMatrixWorld(t,!0)}static hide(e){e.hide(e)}static show(e){e.show()}static isPreSelected(e){return e.isPreSelected()}static isSelected(e){return e.isSelected()}static isTransparent(e){return e.isTransparent()}static isHidden(e){return e.isHidden()}static isIsolated(e){return e.isIsolated()}static getRenderMode(e){switch(e.renderMode){case 3:return"wireframe";case 4:return"hiddenLineRemove";case 5:return"hiddenLineVisible"}return""}static getBodyNodeTranslate(e,r){var o=new THREE.Vector3(0,0,0),s=e.getExtensionWithFlags(i.FLAG_ENABLE_NODE_TRANSFORM);for(let e=0,t=s.length;e<t;++e)o.add(s[e].getBodyNodeTranslate(r));return o}static updateNodeMatrix(e,t){e.ndsModel.updateNodeMatrix(e.uuid,t,e.getModel().id)}static hideBody(e){e.ndsModel.hideBody(e)}static showBody(e){e.ndsModel.showBody(e)}}class P{static getGeomBBox(e){return e.boundingBox}static getGeomText(e){return e.text}static getGeomTextPosition(e){return e.position}static getGeomTextQuaternion(e){return e.quaternion}static getGeomTextNormalMatrix(e){return e.normalMatrix}static getGeomTextIndex(e){return e.textIndex}static getGeomTextSubInd(e){return e.subInd}static getGeomTextMirrorX(e){return e.mirrorX}static getGeomTextMirrorY(e){return e.mirrorY}static getGeomTextCharsWH(e){return e.characterBoxs}static getGeomTextViewBox(e){var t;return e.viewBox?(t=new THREE.Vector3(e.viewBox.min2.x,e.viewBox.min2.y,0),e=new THREE.Vector3(e.viewBox.max2.x,e.viewBox.max2.y,0),new THREE.Box3(t,e)):null}}let c={c:null,u:[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3],e:[]},h={c:null,u:[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3],e:[]},u=[[],[],[]],M=[[],[],[]],g=[],p=new THREE.Vector3,m=new THREE.Vector3,x=new THREE.Vector3,w=new THREE.Vector3;class W{constructor(e=new THREE.Vector3,t=new THREE.Vector3,r=new THREE.Matrix3){this.center=e,this.halfSize=t,this.rotation=r}set(e,t,r){return this.center=e,this.halfSize=t,this.rotation=r,this}copy(e){return this.center.copy(e.center),this.halfSize.copy(e.halfSize),this.rotation.copy(e.rotation),this}clone(){return(new this.constructor).copy(this)}getSize(e){return e.copy(this.halfSize).multiplyScalar(2)}containsPoint(e){return w.subVectors(e,this.center),this.rotation.extractBasis(p,m,x),Math.abs(w.dot(p))<=this.halfSize.x&&Math.abs(w.dot(m))<=this.halfSize.y&&Math.abs(w.dot(x))<=this.halfSize.z}containsBox(e){var t=[new THREE.Vector3(e.min.x,e.min.y,0),new THREE.Vector3(e.min.x,e.max.y,0),new THREE.Vector3(e.max.x,e.max.y,0),new THREE.Vector3(e.max.x,e.min.y,0)];for(let e=0;e<t.length;e++)if(!this.containsPoint(t[e]))return!1;return!0}intersectsBox(e){return this.intersectsOBB(y.fromBox3(e))}intersectsOBB(e,r=Number.EPSILON){c.c=this.center,c.e[0]=this.halfSize.x,c.e[1]=this.halfSize.y,c.e[2]=this.halfSize.z,this.rotation.extractBasis(c.u[0],c.u[1],c.u[2]),h.c=e.center,h.e[0]=e.halfSize.x,h.e[1]=e.halfSize.y,h.e[2]=e.halfSize.z,e.rotation.extractBasis(h.u[0],h.u[1],h.u[2]);for(let t=0;t<3;t++)for(let e=0;e<3;e++)u[t][e]=c.u[t].dot(h.u[e]);w.subVectors(h.c,c.c),g[0]=w.dot(c.u[0]),g[1]=w.dot(c.u[1]),g[2]=w.dot(c.u[2]);for(let t=0;t<3;t++)for(let e=0;e<3;e++)M[t][e]=Math.abs(u[t][e])+r;let t,o;for(let e=0;e<3;e++)if(t=c.e[e],o=h.e[0]*M[e][0]+h.e[1]*M[e][1]+h.e[2]*M[e][2],Math.abs(g[e])>t+o)return!1;for(let e=0;e<3;e++)if(t=c.e[0]*M[0][e]+c.e[1]*M[1][e]+c.e[2]*M[2][e],o=h.e[e],Math.abs(g[0]*u[0][e]+g[1]*u[1][e]+g[2]*u[2][e])>t+o)return!1;return t=c.e[1]*M[2][0]+c.e[2]*M[1][0],o=h.e[1]*M[0][2]+h.e[2]*M[0][1],!(Math.abs(g[2]*u[1][0]-g[1]*u[2][0])>t+o||(t=c.e[1]*M[2][1]+c.e[2]*M[1][1],o=h.e[0]*M[0][2]+h.e[2]*M[0][0],Math.abs(g[2]*u[1][1]-g[1]*u[2][1])>t+o)||(t=c.e[1]*M[2][2]+c.e[2]*M[1][2],o=h.e[0]*M[0][1]+h.e[1]*M[0][0],Math.abs(g[2]*u[1][2]-g[1]*u[2][2])>t+o)||(t=c.e[0]*M[2][0]+c.e[2]*M[0][0],o=h.e[1]*M[1][2]+h.e[2]*M[1][1],Math.abs(g[0]*u[2][0]-g[2]*u[0][0])>t+o)||(t=c.e[0]*M[2][1]+c.e[2]*M[0][1],o=h.e[0]*M[1][2]+h.e[2]*M[1][0],Math.abs(g[0]*u[2][1]-g[2]*u[0][1])>t+o)||(t=c.e[0]*M[2][2]+c.e[2]*M[0][2],o=h.e[0]*M[1][1]+h.e[1]*M[1][0],Math.abs(g[0]*u[2][2]-g[2]*u[0][2])>t+o)||(t=c.e[0]*M[1][0]+c.e[1]*M[0][0],o=h.e[1]*M[2][2]+h.e[2]*M[2][1],Math.abs(g[1]*u[0][0]-g[0]*u[1][0])>t+o)||(t=c.e[0]*M[1][1]+c.e[1]*M[0][1],o=h.e[0]*M[2][2]+h.e[2]*M[2][0],Math.abs(g[1]*u[0][1]-g[0]*u[1][1])>t+o)||(t=c.e[0]*M[1][2]+c.e[1]*M[0][2],o=h.e[0]*M[2][1]+h.e[1]*M[2][0],Math.abs(g[1]*u[0][2]-g[0]*u[1][2])>t+o))}fromBox3(e){return e.getCenter(this.center),e.getSize(this.halfSize).multiplyScalar(.5),this.rotation.identity(),this}}let y=new W;class B extends a{constructor(e,t){super(e),this.extension=t,this.type=t.OperatorName,this.modelWraper=new d(this.extension.sceneWraper.getActiveModel()),NDSWebViewer.COMMON.isMobileDevice()?this.prompt=null:(this.prompt=document.getElementById("extract_prompt"),this.prompt||(this.prompt=document.createElement("div"),this.prompt.id="extract_prompt",this.prompt.className="pc-alert",this.prompt.style.display="none",this.extension.sceneWraper.getContainer().appendChild(this.prompt))),this.opMode=0,this.Rectangle=[],this.result=[],this.hasResult=!1,this.selectStep=NDSWebViewer.COMMON.isMobileDevice()?16:5,this.getDrawRectangle=function(t){var r=[];if(4===this.Rectangle.length){var e=this.extension.sceneWraper.modelCoordToClientCoord([this.Rectangle[0],this.Rectangle[1],0]),o=this.extension.sceneWraper.modelCoordToClientCoord([this.Rectangle[2],this.Rectangle[3],0]);if(e[0]>o[0]?(r.push(o[0]),r.push(e[0])):(r.push(e[0]),r.push(o[0])),e[1]>o[1]?(r.push(o[1]),r.push(e[1])):(r.push(e[1]),r.push(o[1])),t)for(let e=0;e<r.length;e++)r[e]=r[e]*t}return r},this.getSelectPos=function(r,o){let s=-1;if(4==this.Rectangle.length){var[i,n,a,l]=this.getDrawRectangle(),_=(i+n)/2,d=(a+l)/2;let e=-1,t=-1;var c=this.selectStep;Math.abs(r-i)<c?e=0:Math.abs(r-_)<c?e=1:Math.abs(r-n)<c&&(e=2),Math.abs(o-a)<c?t=0:Math.abs(o-d)<c?t=1:Math.abs(o-l)<c&&(t=2),0==e&&0==t?s=0:1==e&&0==t?s=1:2==e&&0==t?s=2:2==e&&1==t?s=3:2==e&&2==t?s=4:1==e&&2==t?s=5:0==e&&2==t?s=6:0==e&&1==t&&(s=7)}return s},this.updateRectangle=function(s,i,n){if(4==this.Rectangle.length){var a=2*(this.selectStep+2);let[e,t,r,o]=this.getDrawRectangle();switch(n){case 0:s+a<t&&(e=s),i+a<o&&(r=i);break;case 1:i+a<o&&(r=i);break;case 2:s-a>e&&(t=s),i+a<o&&(r=i);break;case 3:s-a>e&&(t=s);break;case 4:s-a>e&&(t=s),i-a>r&&(o=i);break;case 5:i-a>r&&(o=i);break;case 6:s+a<t&&(e=s),i-a>r&&(o=i);break;case 7:s+a<t&&(e=s)}var n=this.extension.sceneWraper.clientCoordToModelCoord([e,r]),l=this.extension.sceneWraper.clientCoordToModelCoord([t,o]);this.Rectangle[0]=n[0],this.Rectangle[1]=n[1],this.Rectangle[2]=l[0],this.Rectangle[3]=l[1]}},this.initMode()}release(){this.Rectangle=[],this.extension.sceneWraper.render(),this.postInfo(0),this.prompt&&(this.extension.sceneWraper.getContainer().removeChild(this.prompt),this.prompt=null),super.release()}initMode(){this.opMode=0,this.Rectangle=[],this.result=[],this.hasResult=!1,this.postInfo(1)}clipText(e,t,r,o){var s=P.getGeomTextCharsWH(e);if(!s)return null;var i=P.getGeomTextPosition(e),n=P.getGeomTextQuaternion(e),a=P.getGeomTextNormalMatrix(e),l=(new THREE.Matrix4).compose(i,n,new THREE.Vector3(1,1,1)),_=(l.multiply(a),P.getGeomText(e)),d=new THREE.Vector3;let c=-1,h=-1;for(let e=0;e<_.length;e++){var u=new THREE.Box3(new THREE.Vector3(s[4*e+0],s[4*e+1],0),new THREE.Vector3(s[4*e+2],s[4*e+3],0));u.applyMatrix4(l),u.applyMatrix4(t),u.getCenter(d),r.intersectsBox(u)&&r.containsPoint(d)&&o.intersectsBox(u)&&o.containsPoint(d)&&(-1===c&&(c=e),h=e+1)}return-1!==c?(-1===h&&(h=_.length),_.substring(c,h)):null}extract(){if(4===this.Rectangle.length){var o=new THREE.Vector3(this.Rectangle[0],this.Rectangle[1],0),s=new THREE.Vector3(this.Rectangle[2],this.Rectangle[3],0),n=(new THREE.Vector3).subVectors(s,o);let e=new THREE.Vector3((o.x+s.x)/2,(o.y+s.y)/2,0);var o=this.viewer.camera.up.clone(),s=new THREE.Vector3(0,0,1),a=(new THREE.Vector3).crossVectors(o,s).normalize(),s=(new THREE.Matrix4).makeBasis(a,o,s),a=new THREE.Vector3(Math.abs(n.dot(a))/2,Math.abs(n.dot(o))/2,0),l=new W(e,a,(new THREE.Matrix3).setFromMatrix4(s));this.postInfo(0),this.result=[],this.hasResult=!1;let i=[];var _=new Map,d=this.modelWraper,c=d.getLeafBodyNodes();for(let e=0;e<c.length;e++){var h=c[e];if(!L.isHidden(h)){var u=L.getTextsInLeafBodyNode(h);for(let e=0;e<u.length;e++){var M=u[e],g=d.getTextGeometryById(M),p=d.getTextWorldMatrixById(M),m=P.getGeomBBox(g).clone().applyMatrix4(p),x=(m.min.z=0,m.max.z=0,P.getGeomTextViewBox(g));if(x&&m.intersect(x),!m.isEmpty()&&l.intersectsBox(m)){var w=P.getGeomTextPosition(g).clone().applyMatrix4(p),w={text:P.getGeomText(g),x:w.x,y:w.y};if(!l.containsBox(m)||x&&!l.containsBox(x)){x=this.clipText(g,p,m,l);if(!x)continue;w.text=x}p=P.getGeomTextIndex(g);if(p){w.subInd=P.getGeomTextSubInd(g);let e=this.viewer.ndsModel.activeModel;m=e.meshManager.textMatrixId[M]+"_"+p;_.has(m)?_.get(m).push(w):_.set(m,[w])}else i.push(w)}}}}let t=this.viewer.ndsModel.activeModel;var y=d.getMeshSets();for(let e=0;e<y.length;e++){var B=y[e];for(let e=0;e<B.ltMeshs.length;e++){var f=B.ltMeshs[e],E=B.drawingLines[f.drawingIndex];if(!E.bodyNode.isHidden()&&t.meshManager.lineTypeUuid2ParamsMap&&t.lineTypes){var T=new THREE.Matrix4,E=(B.getLineWorldMatrix(E.localIndex,T),t.lineTypes.lineTypeStyle[f.material.lineTypeId].uuid),V=t.meshManager.lineTypeUuid2ParamsMap.get(E);if(V){let s=new THREE.Vector3;var b=V.characterWidthHeight,v=V.vD,S=V.text;for(let e=0;e<v.length;e++){var R=new THREE.Vector3(v[e].x,v[e].y,v[e].z),I=new THREE.Box3;let t=V.rectBearingX;var C=V.rectBearingY;let r=-1,o=-1;for(let e=0;e<S.length;e++){var N=b[2*e+0],O=b[2*e+1],D=new THREE.Vector3(t,C,0).add(R),O=new THREE.Vector3(t+N,C+O,0).add(R);t+=N,I.set(D,O),I.applyMatrix4(T),I.max.z=0,I.min.z=0,I.getCenter(s),l.intersectsBox(I)&&l.containsPoint(s)&&(-1===r&&(r=e),o=e+1)}-1!==r&&(-1===o&&(o=S.length),i.push({text:S.substring(r,o),x:I.min.x,y:I.min.y}))}}}}}_.forEach(function(e,t){e.sort(function(e,t){return e.subInd-t.subInd});let r="";e.forEach(function(e){r+=e.text}),i.push({text:r,x:e[0].x,y:e[0].y})});let r=this.extension.sceneWraper;i.forEach(function(e){var t=r.modelCoordToClientCoord([e.x,e.y,0]);e.x=t[0],e.y=-t[1]}),i.sort(function(e,t){return e.y===t.y?e.x-t.x:t.y-e.y});for(let e=0;e<i.length;e++)this.result.push(i[e].text)}}getResult(){return this.hasResult=!0,this.result}postInfo(t){if(this.prompt&&!NDSWebViewer.COMMON.isMobileDevice())if(t){this.InfoType=t;let e="";if(NDSWebViewer.COMMON.isMobileDevice(),1==t&&(e=NDSWebViewer.COMMON.translateString("ExtractText_SelectTableArea")),this.prompt.innerHTML=e,this.prompt.style.display="block",NDSWebViewer.COMMON.isMobileDevice()){let e=this;this.Popup=setTimeout(function(){e.prompt&&(e.prompt.style.display="none")},3e3)}}else this.InfoType=0,this.prompt.style.display="none",this.prompt.innerHTML=""}movePostInfo(e){this.prompt&&!NDSWebViewer.COMMON.isMobileDevice()&&(0<this.InfoType?this.prompt.style.display="block":this.prompt.style.display="none",this.prompt.style.left=e.clientX+16+"px",this.prompt.style.top=e.clientY+18+"px")}renderModel(){if(4==this.Rectangle.length){let t=this.extension.sceneWraper.getPixelRatio();var[e,o,s,i]=this.getDrawRectangle(t);let r=this.extension.sceneWraper.getCanvas2D().getContext("2d");r.strokeStyle="#1880E3",r.fillStyle="#F2F2F2",r.beginPath(),r.lineWidth=2*t,r.moveTo(e,s),r.lineTo(o,s),r.lineTo(o,i),r.lineTo(e,i),r.lineTo(e,s),r.closePath(),r.stroke(),[{x:e,y:s},{x:(e+o)/2,y:s},{x:o,y:s},{x:e,y:(s+i)/2},{x:o,y:(s+i)/2},{x:e,y:i},{x:(e+o)/2,y:i},{x:o,y:i}].forEach(function(e){r.beginPath(),r.arc(e.x,e.y,5*t,0,2*Math.PI),r.fill(),r.stroke()}),r.lineWidth=1}}onLMouseDown(e){e.preventDefault(),super.onLMouseDown(e),this.selectPos=this.getSelectPos(this.MouseDown.x,this.MouseDown.y),-1!=this.selectPos?this.opMode=2:4==this.Rectangle.length&&(this.opMode=1)}onLMouseMove(e){var t;e.preventDefault(),this.movePostInfo(e),1==this.opMode||this.hasResult||2==this.opMode&&-1===this.selectPos?super.onRMouseMove(e):(e=this.extension.sceneWraper.clientCoordToModelCoord([this.pointer.x,this.pointer.y]),0==this.Rectangle.length?(t=this.extension.sceneWraper.clientCoordToModelCoord([this.MouseDown.x,this.MouseDown.y]),this.Rectangle[0]=t[0],this.Rectangle[1]=t[1],this.Rectangle[2]=e[0],this.Rectangle[3]=e[1]):2===this.opMode&&-1!=this.selectPos?(this.updateRectangle(this.pointer.x,this.pointer.y,this.selectPos),this.extension.sceneWraper.render()):0===this.opMode&&(this.Rectangle[2]=e[0],this.Rectangle[3]=e[1],this.extension.sceneWraper.render()))}onRMouseMove(e){this.movePostInfo(e),super.onRMouseMove(e)}onNMouseMove(e){this.movePostInfo(e)}onLMouseUp(e){this.postInfo(0),2!=this.opMode&&4==this.Rectangle.length&&(this.opMode=1,this.hasResult||this.extension.sceneWraper.dispatchEvent({type:"ExtractTextDraw"})),super.onLMouseUp(e)}onTouchSingleStart(e){super.onTouchSingleStart(e),this.selectPos=this.getSelectPos(this.singleTouchStartPos.x,this.singleTouchStartPos.y),-1!=this.selectPos?this.opMode=2:4==this.Rectangle.length&&(this.opMode=1)}onTouchSingleMove(e){var t,r;this.hasResult||1==this.opMode||2==this.opMode&&-1===this.selectPos||(t=this.extension.sceneWraper.clientCoordToModelCoord([this.pointer.x,this.pointer.y]),0==this.Rectangle.length?(r=this.extension.sceneWraper.clientCoordToModelCoord([this.singleTouchStartPos.x,this.singleTouchStartPos.y]),this.Rectangle[0]=r[0],this.Rectangle[1]=r[1],this.Rectangle[2]=t[0],this.Rectangle[3]=t[1]):2===this.opMode&&-1!=this.selectPos?this.updateRectangle(this.pointer.x,this.pointer.y,this.selectPos):0===this.opMode&&(this.Rectangle[2]=t[0],this.Rectangle[3]=t[1]))}onTouchSingleEnd(e){2!=this.opMode&&4==this.Rectangle.length&&(this.opMode=1,this.hasResult||this.extension.sceneWraper.dispatchEvent({type:"ExtractTextDraw"})),super.onTouchSingleEnd(e)}drawText(){var t=this.modelWraper,r=t.getLeafBodyNodes();for(let e=0;e<r.length;e++){var o=r[e];if(!L.isHidden(o)){var s=L.getTextsInLeafBodyNode(o);for(let e=0;e<s.length;e++){var i=s[e],n=t.getTextGeometryById(i),i=t.getTextWorldMatrixById(i),i=P.getGeomBBox(n).clone().applyMatrix4(i),n=(i.min.z=0,i.max.z=0,P.getGeomTextViewBox(n)),n=(n&&i.intersect(n),new THREE.Box3Helper(i,16711680));n.updateMatrixWorld(!0),this.viewer.scene.add(n)}}}}}class f extends o{constructor(){super(),this.name="NDSExtractTextExtension",console.log("NDSExtractTextExtension version 1.1.9"),this.viewer=null,this.sceneWraper=null,this.OperatorName="OpExtractText"}onLoad(e){this.viewer=e,this.selectWrapper=new n(this.viewer),this.sceneWraper=new s(this.viewer);let t=this;this.sceneWraper.registOperator(this.OperatorName,function(e){return new B(e,t)})}initText(){this.selectWrapper.clearSelection(),this.sceneWraper.getCurrentOperatorID()!==this.OperatorName&&this.sceneWraper.setOperatorByID(this.OperatorName),this.sceneWraper.render()}deInitText(){this.sceneWraper.render()}clearRect(){var e=this.sceneWraper.getCurrentOperator();e&&e.type===this.OperatorName&&(e.initMode(),this.sceneWraper.render())}extract(){this.sceneWraper.dispatchEvent({type:"ExtractTextBegin"});let t=this;setTimeout(function(){var e=t.sceneWraper.getCurrentOperator();if(e&&e.type===t.OperatorName)try{e.extract()}catch(e){console.log("extract text failed: ",e)}t.sceneWraper.dispatchEvent({type:"ExtractTextEnd"})},100)}getResult(){var e=this.sceneWraper.getCurrentOperator();return e&&e.type===this.OperatorName?e.getResult():[]}showExtractText(){return 4<=this.viewer.modelContentVersion}drawText(){var e=this.sceneWraper.getCurrentOperator();if(e&&e.type===this.OperatorName)return e.drawText()}}r=new f;NDSWebViewer.ExtensionManager.addExtension(r)}],o={},s.m=r,s.c=o,s.d=function(e,t,r){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(s.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)s.d(r,o,function(e){return t[e]}.bind(null,o));return r},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=0);function s(e){var t;return(o[e]||(t=o[e]={i:e,l:!1,exports:{}},r[e].call(t.exports,t,t.exports,s),t.l=!0,t)).exports}var r,o});